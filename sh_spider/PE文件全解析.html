<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <title>PE文件全解析 - 嘶吼 RoarTalk &#8211; 回归最本质的信息安全,互联网安全新媒体,4hou.com</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="renderer" content="webkit">
    <meta property="wb:webmaster" content="4517e8fe39b18975" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,Chrome=1" />
    <meta name="description" content="什么是PE文件？PE是Windows下的可执行文件的格式。这是微软基于UNIX平台的COFF(Common Object File Format，通用文件格式)制成的。微软原本的意思是提高程序的移植型。但是想法是好的，但是实际上只用于Windows系列…" />
    <meta name="keywords" content="" />
        <link href="http://img.4hou.com/wp-content/themes/4houv2/images/favicon.ico" rel="shortcut icon">
    <link href="http://img.4hou.com/wp-content/themes/4houv2/images/favicon_114.png" rel="apple-touch-icon">
    <link href="http://img.4hou.com/wp-content/themes/4houv2/images/favicon_76.png" sizes="76x76" rel="apple-touch-icon">
    <link href="http://img.4hou.com/wp-content/themes/4houv2/images/favicon_120.png" sizes="120x120" rel="apple-touch-icon">
    <link href="http://img.4hou.com/wp-content/themes/4houv2/images/favicon_152.png" sizes="152x152" rel="apple-touch-icon">

    <!-- 引入 lib -->
    <script src="http://www.4hou.com/wp-content/themes/4houv2/lib/jquery.min.js"></script>
    <script src="http://www.4hou.com/wp-content/themes/4houv2/lib/swiper.jquery.min.js"></script>
    <link rel="stylesheet" href="http://www.4hou.com/wp-content/themes/4houv2/lib/swiper.min.css">
    <link rel="stylesheet" href="http://www.4hou.com/wp-content/themes/4houv2/lib/allmin.css">
    <!--[if lt IE 11]>
    <script src="http://www.4hou.com/wp-content/themes/4houv2/lib/html5shiv.min.js"></script>
    <script src="http://www.4hou.com/wp-content/themes/4houv2/lib/respond.js"></script>
    <![endif]-->
    <!-- 引入 css js -->
    <link rel="stylesheet" href="http://www.4hou.com/wp-content/themes/4houv2/css/style.css">
    <link rel="stylesheet" href="http://www.4hou.com/wp-content/themes/4houv2/lib/allmin.css">
    <script src="http://www.4hou.com/wp-content/themes/4houv2/js/public.js"></script>
    <script src="http://www.4hou.com/wp-content/themes/4houv2/js/main.js"></script>
    <script src="http://www.4hou.com/wp-content/themes/4houv2/js/index-more.js"></script>
    </head>
<body>
<style type="text/css">
.memberlistanimate{width: 122px}
.memberlistanimateleave{width: 122px}
.nameheader{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;width: 78px;display: block;}
</style>

<header class="header">
            <article class="header_center">
                <div class="logowrap">
            <a href="http://www.4hou.com"><div class="logo icons"></div></a>
            <h1>回归最本质的信息安全</h1>
        </div>
        <div class="login">
            <form action="/" class="navbar-form inSearch " name="searchform" onsubmit="return checksubmit()">
                <div class="br">
                    <span class="in-btn icons"></span>
                    <input type="text" name="s" id="search" class="animated">
                    <div class="clear icons"></div>
                </div>
                <div id="submitBtnplace" class="icons animated" value=""></div>
                <!--<input type="submit" id="submitBtn" class="icons animated" value="">-->
            </form>
                            <!--登录注册按钮-->
                 <div id="register">
                     <a href="http://www.4hou.com/register" data-event-category="Referral to Signup" data-event-action="click" data-event-label="Signup Menu button / Header">注册</a>
                 </div>
                 <div id="sing">
                      <a href="http://www.4hou.com/login" class="pzh_login">登录</a>
                 </div>

                 <div class="burger2 menu" id="burger">
                  <div class="icon"></div>
                 </div>

            
           <!-- <div id="register">注册</div>
            <div id="sing">登录</div>
            <div class="burger2 menu" id="burger">
                <div class="icon"></div>
            </div>-->
        </div>
    </article>
</header>
<nav class="navbox animated">
    <section class="navbox_cen">
        <article class="navboxleft">
            <ul class="nav navbar-nav index-nav" id="inNav">
					<li>
							<li class="cat-item cat-item-18"><a href="http://www.4hou.com/category/info" >资讯</a>
</li>
	<li class="cat-item cat-item-19"><a href="http://www.4hou.com/category/technology" >技术</a>
</li>
	<li class="cat-item cat-item-20"><a href="http://www.4hou.com/category/xactivity" >活动</a>
</li>
	<li class="cat-item cat-item-29"><a href="http://www.4hou.com/category/vulnerable" >漏洞</a>
</li>
					</li>
                    <li class="cat-item cat-item-29"><a href="http://www.4hou.com/piao" >嘶票</a>
                    </li>
            </ul>
        </article>
        <article class="navboxright">
            <div class="contrib"> <a href="http://www.4hou.com/contribute" class="tougao" data-event-category="Referral to Signup" data-event-action="click" data-event-label="Signup Menu button / Header">投稿</a></div>
        </article>
    </section>
</nav>
<div id="modelbg"></div>
    <style>


    ::selection {
    background:#fea283;
    color:#fff;
}
::-moz-selection {
    background:#fea283;
    color:#fff;
}
::-webkit-selection {
    background:#fea283;
    color:#fff;
}


        .article_cen p img{height: auto !important;}
        .commentlist .children{width: 90%; padding-right: 15px; border-color: transparent ;}
        .commentname,.commenteml{width: 60%; margin-left:5% ;margin-bottom: 30px;border-bottom: 1px solid #dbdbdb;}
        .article_cen ol li{list-style-type: decimal;}
         .article_cen ol li p{overflow: inherit;}
        .commentname label{font-size: 16px;color: #666; margin-right: 10px;line-height: 32px;}
        .commentname input{width: 50%;border: none; outline: none;}
        .commenteml label{font-size: 16px;color: #666; margin-right: 10px;line-height: 32px;}
        .commenteml input{width: 50%;border: none; outline: none;}
        #zooming{display: none;width: 100%;height: 100%; position: fixed;z-index: 999;left: 0px; top: 0px; background-color: rgba(0,0,0,.6);}
        .zoomaniatae{display: block !important;}
        .imgcon{}
        #imgcon{position: absolute;left: 50%; top: 20%;max-width: 80%}
        .article_cen img{cursor: pointer;}
        #zooming{cursor: pointer;}
        .imgconadimate{animation:imgcon 0.5s 1 forwards;
        -webkit-animation:imgcon 0.5s 1 forwards;}
        .article_authorbox{    width: 222px;min-height: 214px;
        padding-bottom: 20px;
        float: right;
        position: relative;}
        .interested{position: relative;}
        .interested>h1{font-size: 18px; font-weight: 900; position: absolute; top: -36px;color: #5e5e5e}
       .user-comment span{font-size: 13px; position: relative; top: 2px;}
        .article_authoradd{position: fixed;}
        .stratend{background:url(http://www.4hou.com/wp-content/themes/4houv2/img/starend.png); !important;background-size: contain !important;}
        .wpfp-span{opacity: 0;width:100%; height: 100%;display: block; left: 0px; top: 0px; }
        .wpfp-link{width:100%; height: 100%;display: block; left: 0px; top: 0px; }
        .wpfp-span img{display: none;}
        .interested{width: 222px;padding-bottom: 20px;background-color: #fff;margin-top: 70px; padding-bottom: 10px; padding-top: 10px;border: 1px solid #f5c2b1}
        .interested li{width: 100%;position: relative;padding-top: 8px; padding-bottom: 8px;  line-height: 24px; padding-left: 20px;padding-right: 14px}
        .interested li i{width: 6px;height: 6px;border-radius: 50%; background-color: #f63;position: absolute; left: 8px; top: 18px;}
        .interested li a{color: #666;font-size: 14px; line-height: 18px;}
        .interested li:hover{background-color: #f9e7e3;-moz-transition: all 0.4s ease-in-out;
        .footer{position: relative;z-index: 99}   
        .article_authorbox_top{position: relative;} 
        

        -o-transition: all 0.4s ease-in-out; -webkit-transition: all 0.4s ease-in-out; transition: all 0.4s ease-in-out;}
    
        @-webkit-keyframes imgcon{
            0%{ opacity:0; -webkit-transform:scale3d(.3, .3, .3); transform:scale3d(.3, .3, .3) }
            50%{ opacity:1 }
        }
        @keyframes imgcon{
            0%{ opacity:0; -webkit-transform:scale3d(.3, .3, .3); transform:scale3d(.3, .3, .3) }
            50%{ opacity:1 }
        }
        .asideanimate{animation:asideanimate 1s 1 forwards;
        -webkit-animation:asideanimate 1s 1 forwards; position: fixed;}
        @-webkit-keyframes asideanimate{
            0%{ opacity:0; -webkit-transform:translate3d(0,-20%, 0); transform:translate3d(0, -20%, 0) }
            50%{ opacity:1 }
        }
        @keyframes asideanimate{
            0%{ opacity:0; -webkit-transform:translate3d(0,-20%, 0); transform:translate3d(0, -20%, 0) }
            50%{ opacity:1 }
        }
        .asideanimateleave{animation:asideanimateleave 1s 1 forwards;
        -webkit-animation:asideanimateleave 1s 1 forwards;}
        @-webkit-keyframes asideanimateleave{
            0%{ opacity:1; -webkit-transform:translate3d(0,0, 0); transform:translate3d(0, 0, 0) }
            50%{ opacity:0;-webkit-transform:translate3d(0,-20%, 0); transform:translate3d(0, -20%, 0) }
        }
        @keyframes asideanimateleave{
            0%{ opacity:1; -webkit-transform:translate3d(0,0, 0); transform:translate3d(0, 0, 0) }
            50%{ opacity:0;-webkit-transform:translate3d(0,-20%, 0); transform:translate3d(0, -20%, 0) }
        }
        @media screen and (max-width:650px) {
            .member_list{right: -30px !important;top: 34px !important;}
            .article_authorbox{display: none;}
            .nameheader{display: none;}
            .shang_box{width: 90%; margin-left:-45% }
            #imgcon{width: 90% !important; margin-left: -45% !important;max-width: inherit !important}
            .dy{padding: 12px 15px!important;font-size: 14px !important; line-height: 22px !important;}
        }
        .article_author{float:none !important;padding-top: 1px;}
        .article_cen pre{color: #666 !important; line-height: 26px; background-color: #f1f1f1}
        .articlecontent blockquote>p{ color: #666; font-size: 16px; }
    </style>
    <section class="articlewrap">
        <article class="articlecontent">
            <div class="article_top">
                <h1 class="art_title">PE文件全解析</h1>
                <p class="art_time">2017年9月24日发布</p>
                <div class="art_nav">
                    <!--<a href="">翻译文章</a>
                    <span>／</span>
                    <a href="">新闻</a>
                    <span>／</span>
                    <a href="">原创</a>-->
                                        <a href="http://www.4hou.com">首页 </a></a>
                    <span>／</span>
                    <a href="http://www.4hou.com/category/system">系统安全</a>
                    <span>／</span>
                    <a href="">正文</a>

                    </ul>
                </div>
                <div class="art_type">
                    <div class="newtype">
                        <div class="read ">
                            <i class="icons"></i>
                            <span>7,059</span>
                        </div>
                        <div class="comment ">
                            <i class="icons"></i>
                            <span>1</span>
                        </div>
                        <div class="Praise">
                            <i class="icons"></i>
                            <span>0</span>
                        </div>
                    </div>
                </div>
            </div>
             <p class="dy" style="padding: 24px 60px;font-size: 16px;line-height: 30px;color: #808080;background-color: #f6f6f6;"><span style="font-weight: bold;">导语：</span>PE是Windows下的可执行文件的格式。这是微软基于UNIX平台的COFF(Common Object File Format，通用文件格式)制成的。微软原本的意思是提高程序的移植型。但是想法是好的，但是实际上只用于Windows系列的操作系统下。</p>

            <div class="article_cen">
                <!--文章摘要-->
               
                <p><p><span style="font-size: 20px;"><strong>什么是PE文件？<br /></strong></span></p>
<p cid="n3" mdtype="paragraph" style="text-align: left;">PE是Windows下的可执行文件的格式。这是微软基于UNIX平台的COFF(Common Object File Format，通用文件格式)制成的。微软原本的意思是提高程序的移植型。但是想法是好的，但是实际上只用于Windows系列的操作系统下。</p>
<p cid="n5" mdtype="paragraph" style="text-align: left;">PE文件是指32位的可执行文件,也称PE32。注意:64位的可执行文件称为PE+或PE32+，是PE32的一种扩展，不叫PE64。</p>
<p cid="n5" mdtype="paragraph" style="text-align: left;"><span style="font-size: 20px;"><strong>PE文件的格式</strong></span></p>
<p cid="n8" mdtype="paragraph" style="text-align: left;">使用notepad.exe为例。从DOS头到(DOS header)到节区头(Section header)是PE头的部分，剩下的部分都叫PE体。文件中实用偏移offset，内存中实用VA(Virtual Address， 虚拟地址)来表示位置。文件加载到内存中时，情况就会发生变数(节区的大小，位置等等)。文件一般可分为代码.text,数据.data,资源.rsrc，分别保存。不同的编译工具节区的名称大小，个数，内容都是不同的。采用不同的编译选项所编译出来的可执行文件也是不同的。</p>
<p cid="n8" mdtype="paragraph" style="text-align: center;"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506047631888224.png" title="1506047631888224.png" alt="1.png"/><noscript><img src="/uploads/20170922/1506047631888224.png" title="1506047631888224.png" alt="1.png"/></noscript></p>
<p cid="n8" mdtype="paragraph" style="text-align: left;"><span style="font-size: 20px;"><strong>RV&amp;RVA的转换</strong></span></p>
<p cid="n15" mdtype="paragraph" style="text-align: left;">· VA是指进程虚拟内存的绝对相对地址.</p>
<p cid="n18" mdtype="paragraph" style="text-align: left;">· RVA(相对虚拟地址),是指从某个基准位置(Image Base)开始的相对地址。</p>
<p cid="n20" mdtype="paragraph" style="text-align: left;">转换关系如下:</p>
<pre class="brush:html;toolbar:false">&lt;center&gt;RVA+Image&nbsp;Base&nbsp;=&nbsp;VA&lt;/center&gt;</pre>
<p cid="n25" mdtype="paragraph" style="text-align: left;">PE头内部信息大多以RVA的形式存在。因为PE文件加载到进程虚拟内存的特定位置，但是，这个位置可能已加载了其他的PE文件（DLL）。因此必须重定向到其他的空白位置。若PE头信息使用的是VA,则无法正常访问。所以，使用RVA来定位信息，即使发生了重定位，只要基准地址没有发生变化，就可以正常访问到指定的信息</p>
<p cid="n25" mdtype="paragraph" style="text-align: left;"><span style="font-size: 20px;"><strong>PE头</strong></span></p>
<p cid="n28" mdtype="paragraph" style="text-align: left;">PE头中邮许多许多结构体组成的。而且基本都是结构体中嵌套结构体，嵌套好多层。很复杂。要想学好逆向就必须了解每一个结构体中的内容，所代表的含义。</p>
<p cid="n28" mdtype="paragraph" style="text-align: left;"><strong>1.DOS头</strong></p>
<p cid="n31" mdtype="paragraph" style="text-align: left;">微软在创建PE 文件格式时，人们正在广泛使用DOS 文件，所以微软为了考虑兼容性的问题，所以在PE 头的最前边还添加了一个 IMAGE_DOS_HEADER 结构体，用来扩展已有的DOS EXE。他的结构如下</p>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506047702127815.jpg" title="1506047702127815.jpg" alt="2.jpg"/><noscript><img src="/uploads/20170922/1506047702127815.jpg" title="1506047702127815.jpg" alt="2.jpg"/></noscript></p>
<p cid="n31" mdtype="paragraph" style="text-align: left;">Dos结构体的大小为40个字节，这里面有两个重要的成员变量</p>
<p cid="n37" mdtype="paragraph" style="text-align: left;">· e_magic:DOS签名，这个属性的值基本都是4D5A=&gt;ASCII值&quot;MZ&quot;</p>
<p cid="n41" mdtype="paragraph" style="text-align: left;">· e_lfanew:指示NT头的偏移量(根据不同的文件拥有的值就是不一样的)使用16进制编辑器打开windows自带的笔记本。来查看他的结构体。</p>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506047737982443.png" title="1506047737982443.png" alt="3.png"/><noscript><img src="/uploads/20170922/1506047737982443.png" title="1506047737982443.png" alt="3.png"/></noscript></p>
<p><strong><span style="text-align: left;">2.DOS存根</span></strong></p>
<p cid="n45" mdtype="paragraph" style="text-align: left;">DOS头后并不是PE头，他后面跟的是DOS存根，这是个可选项，而且大小不固定，他的大小为NT头的偏移量减去DOS头的40个字节，这一个区域中东西就是DOS存根。即使没有DOS存根，程序也可以正常执行。这里存的数据是由数据混合而成的。</p>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506047751723809.png" title="1506047751723809.png" alt="4.png"/><noscript><img src="/uploads/20170922/1506047751723809.png" title="1506047751723809.png" alt="4.png"/></noscript></p>
<p cid="n48" mdtype="paragraph" style="text-align: left;">可以再xp下实用debug查看这DOS存根中的代码。在命令行中输入:</p>
<p cid="n52" mdtype="paragraph" style="text-align: left;">debug C:Windowsnotepad.exe之后在按u,就会出现16位的汇编指令。</p>
<p cid="n52" mdtype="paragraph" style="text-align: left;"><strong>3.NT头</strong></p>
<p cid="n56" mdtype="paragraph" style="text-align: left;">紧接在后面的就是NT头，这个头的地址也就是刚刚在上面提到的e_lfanew的值，来看下这个文件的结构体</p>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506047789580188.jpg" title="1506047789580188.jpg" alt="5.jpg"/><noscript><img src="/uploads/20170922/1506047789580188.jpg" title="1506047789580188.jpg" alt="5.jpg"/></noscript></p>
<p cid="n60" mdtype="paragraph" style="text-align: left;">IMAGE_NT_HEADERS结构体由3个成员组成，第一个成员为签名(Signature)结构体，其值为50450000h,另外两个成员为文件头(File Header)和可选头(Optional Header)结构体。用16进制编辑器打开记事本，查看IMAGE_NT_HEADERS的内同</p>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506047802915522.png" title="1506047802915522.png" alt="6.png"/><noscript><img src="/uploads/20170922/1506047802915522.png" title="1506047802915522.png" alt="6.png"/></noscript></p>
<p cid="n64" mdtype="paragraph" style="text-align: left;">（所选区域为结构体内容）IMAGE_NT_HEADERS结构体的大小位F8,很大。</p>
<p cid="n64" mdtype="paragraph" style="text-align: left;"><strong>3.1 NT头:文件头</strong></p>
<p cid="n68" mdtype="paragraph" style="text-align: left;">文件头是表现的是IMAGE_FILE_HEADER结构体</p>
<pre contenteditable="false" cid="n69" mdtype="fences" class="brush:html;toolbar:false;">typedef&nbsp;struct&nbsp;_IMAGE_FILE_HEADER&nbsp;{&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WORD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Machine;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//运行平台
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WORD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NumberOfSections;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//块(section)数目&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TimeDateStamp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//时间日期标记&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PointerToSymbolTable;&nbsp;&nbsp;&nbsp;&nbsp;//COFF符号指针，这是程序调试信息&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NumberOfSymbols;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//符号数&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WORD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SizeOfOptionalHeader;&nbsp;&nbsp;&nbsp;&nbsp;//可选部首长度，是IMAGE_OPTIONAL_HEADER的长度&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WORD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Characteristics;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//文件属性
}</pre>
<p cid="n71" mdtype="paragraph" style="text-align: left;">来看看几个成员变量中所代表的意思是什么首先是Machine，这个值表示运行程序需要的平台</p>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506047841313000.png" title="1506047841313000.png" alt="7.png"/><noscript><img src="/uploads/20170922/1506047841313000.png" title="1506047841313000.png" alt="7.png"/></noscript></p>
<p cid="n76" mdtype="paragraph" style="text-align: left;">可以看到这个值是014c,下面是一个列表，代表各种平台对应的值</p>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506048036593818.png" title="1506048036593818.png" alt="8.png"/><noscript><img src="/uploads/20170922/1506048036593818.png" title="1506048036593818.png" alt="8.png"/></noscript></p>
<p cid="n80" mdtype="paragraph" style="text-align: left;">第二个成员变量是NumberOfSections,表示节区数量，而且，当定义的节区与实际节区不同时，就会发生运行错误</p>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506048048397175.png" title="1506048048397175.png" alt="9.png"/><noscript><img src="/uploads/20170922/1506048048397175.png" title="1506048048397175.png" alt="9.png"/></noscript></p>
<p cid="n84" mdtype="paragraph" style="text-align: left;">可以看到是3个字节。</p>
<p cid="n86" mdtype="paragraph" style="text-align: left;">第三个成员变量是TimeDateStamp,表示编辑器创建文件的时间。该成员的值不影响文件运行。</p>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506048064157347.png" title="1506048064157347.png" alt="10.png"/><noscript><img src="/uploads/20170922/1506048064157347.png" title="1506048064157347.png" alt="10.png"/></noscript></p>
<p cid="n90" mdtype="paragraph" style="text-align: left;">之后看第6个成员变量SizeOfOptionalHeader，IMAGE_NT_HEADERS结构体的最后一个成员为IMAGE_OPTIONAL_HEADER32的结构体。SizeOfOptionalHeader成员用来指出IMAGE_OPTIONAL_HEADER32结构体的长度。IMAGE_OPTIONAL_HEADER32是由c语言编写的，所以，大小已经确定。WINDOWS的PE装载器需要查看IMAGE_FILE_HEADER中的SizeOfOptionalHeader来确定IMAGE_OPTIONAL_HEADER32的大小。00E0的十进制为224，也就是OptionalHeader的大小。PE32+格式的文件中实用的是IMAGE_OPTIONAL_HEADER64结构体，而不是IMAGE_OPTIONAL_HEADER32结构体。2个结构体的尺寸是不用的，所以需要SizeOfOptionalHeader成员明确的指出结构体的大小来看他的值</p>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506048107609850.png" title="1506048107609850.png" alt="11.png"/><noscript><img src="/uploads/20170922/1506048107609850.png" title="1506048107609850.png" alt="11.png"/></noscript></p>
<p cid="n97" mdtype="paragraph" style="text-align: left;">第7个成员变量Characteristics表示文件属性,他的每一个bit都代表了某种含义</p>
<pre contenteditable="false" cid="n98" mdtype="fences" class="brush:html;toolbar:false;">Bit&nbsp;0&nbsp;：置1表示文件中没有重定向信息。每个段都有它们自己的重定向信息。
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;这个标志在可执行文件中没有使用，在可执行文件中是用一个叫做基址重定向目录表来表示重定向信息的，这将在下面介绍。
Bit&nbsp;1&nbsp;：置1表示该文件是可执行文件（也就是说不是一个目标文件或库文件）。
Bit&nbsp;2&nbsp;：置1表示没有行数信息；在可执行文件中没有使用。
Bit&nbsp;3&nbsp;：置1表示没有局部符号信息；在可执行文件中没有使用。
Bit&nbsp;4&nbsp;：
Bit&nbsp;7
Bit&nbsp;8&nbsp;：表示希望机器为32位机。这个值永远为1。
Bit&nbsp;9&nbsp;：表示没有调试信息，在可执行文件中没有使用。
Bit&nbsp;10：置1表示该程序不能运行于可移动介质中（如软驱或CD-ROM）。在这&nbsp;&nbsp;&nbsp;&nbsp;种情况下，OS必须把文件拷贝到交换文件中执行。
Bit&nbsp;11：置1表示程序不能在网上运行。在这种情况下，OS必须把文件拷贝到交换文件中执行。
Bit&nbsp;12：置1表示文件是一个系统文件例如驱动程序。在可执行文件中没有使用。
Bit&nbsp;13：置1表示文件是一个动态链接库（DLL）。
Bit&nbsp;14：表示文件被设计成不能运行于多处理器系统中。
Bit&nbsp;15：表示文件的字节顺序如果不是机器所期望的，那么在读出之前要进行
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;交换。在可执行文件中它们是不可信的（操作系统期望按正确的字节顺序执行程序）。</pre>
<p cid="n100" mdtype="paragraph" style="text-align: left;">他的值如下</p>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506048175868744.png" title="1506048175868744.png" alt="12.png"/><noscript><img src="/uploads/20170922/1506048175868744.png" title="1506048175868744.png" alt="12.png"/></noscript></p>
<p cid="n100" mdtype="paragraph" style="text-align: left;">把010F这个值变为二进制就是0000000100001111再来看一个更详细的图片</p>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506048219586667.png" title="1506048219586667.png" alt="13.png"/><noscript><img src="/uploads/20170922/1506048219586667.png" title="1506048219586667.png" alt="13.png"/></noscript></p>
<p cid="n100" mdtype="paragraph" style="text-align: left;">需要记住的两个值为0002h(EXE文件)和2000h(DLL文件)</p>
<p cid="n100" mdtype="paragraph" style="text-align: left;"><strong>3.2 NT头:可选头</strong></p>
<p cid="n108" mdtype="paragraph" style="text-align: left;">紧接着IMAGE_FILE_HEADER的结构体就是IMAGE_OPTIONAL_HEADER32,这个结构体是整个PE头结构中最大的一个结构体。</p>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506048251561072.png" title="1506048251561072.png" alt="14.png"/><noscript><img src="/uploads/20170922/1506048251561072.png" title="1506048251561072.png" alt="14.png"/></noscript></p>
<p cid="n112" mdtype="paragraph" style="text-align: left;">打蓝标的区域为可选头的内容，找不到内同的可以计算一下。找到NT头开头的地方，一个DWORD类型的Signature,4个字节，之后跟了一个20字节大小的文件头之后就是可选头所开始的地址了。</p>
<p cid="n114" mdtype="paragraph" style="text-align: left;">接着来看看这个结构体的结构:</p>
<pre contenteditable="false" cid="n116" mdtype="fences" class="brush:html;toolbar:false;">typedef&nbsp;struct&nbsp;_IMAGE_OPTIONAL_HEADER&nbsp;{
&nbsp;&nbsp;WORD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Magic;
&nbsp;&nbsp;BYTE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MajorLinkerVersion;
&nbsp;&nbsp;BYTE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MinorLinkerVersion;
&nbsp;&nbsp;DWORD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SizeOfCode;
&nbsp;&nbsp;DWORD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SizeOfInitializedData;
&nbsp;&nbsp;DWORD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SizeOfUninitializedData;
&nbsp;&nbsp;DWORD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AddressOfEntryPoint;
&nbsp;&nbsp;DWORD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BaseOfCode;
&nbsp;&nbsp;DWORD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BaseOfData;
&nbsp;&nbsp;DWORD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ImageBase;
&nbsp;&nbsp;DWORD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SectionAlignment;
&nbsp;&nbsp;DWORD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FileAlignment;
&nbsp;&nbsp;WORD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MajorOperatingSystemVersion;
&nbsp;&nbsp;WORD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MinorOperatingSystemVersion;
&nbsp;&nbsp;WORD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MajorImageVersion;
&nbsp;&nbsp;WORD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MinorImageVersion;
&nbsp;&nbsp;WORD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MajorSubsystemVersion;
&nbsp;&nbsp;WORD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MinorSubsystemVersion;
&nbsp;&nbsp;DWORD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Win32VersionValue;
&nbsp;&nbsp;DWORD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SizeOfImage;
&nbsp;&nbsp;DWORD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SizeOfHeaders;
&nbsp;&nbsp;DWORD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CheckSum;
&nbsp;&nbsp;WORD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Subsystem;
&nbsp;&nbsp;WORD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DllCharacteristics;
&nbsp;&nbsp;DWORD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SizeOfStackReserve;
&nbsp;&nbsp;DWORD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SizeOfStackCommit;
&nbsp;&nbsp;DWORD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SizeOfHeapReserve;
&nbsp;&nbsp;DWORD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SizeOfHeapCommit;
&nbsp;&nbsp;DWORD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LoaderFlags;
&nbsp;&nbsp;DWORD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;NumberOfRvaAndSizes;
&nbsp;&nbsp;IMAGE_DATA_DIRECTORY&nbsp;DataDirectory[IMAGE_NUMBEROF_DIRECTORY_ENTRIES];
}&nbsp;IMAGE_OPTIONAL_HEADER,&nbsp;*PIMAGE_OPTIONAL_HEADER;</pre>
<p cid="n117" mdtype="paragraph" style="text-align: left;">继续看每一个成员变量的值：</p>
<p cid="n119" mdtype="paragraph" style="text-align: left;">第一个成员变量:Magic 这个值代表的是 文件的格式</p>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506048282593476.png" title="1506048282593476.png" alt="15.png"/><noscript><img src="/uploads/20170922/1506048282593476.png" title="1506048282593476.png" alt="15.png"/></noscript></p>
<p cid="n123" mdtype="paragraph" style="text-align: left;">看看微软官方的说法</p>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506048296158096.png" title="1506048296158096.png" alt="1506048296158096.png" width="700" height="391" border="0" vspace="0" style="width: 700px; height: 391px;"/><noscript><img src="/uploads/20170922/1506048296158096.png" title="1506048296158096.png" alt="1506048296158096.png" width="700" height="391" border="0" vspace="0" style="width: 700px; height: 391px;"/></noscript></p>
<p cid="n127" mdtype="paragraph" style="text-align: left;">IMAGE_OPTIONAL_HEADER32和IMAGE_OPTIONAL_HEADER64分别表示32位和64位的应用程序。这里的值010B可以判断出实用的是32位应用程序。看官方文档还有一个值是0x107这个值代表的是系统的ROM文件。</p>
<p cid="n129" mdtype="paragraph" style="text-align: left;">紧接着的几个成员变量都无关紧要。</p>
<p cid="n131" mdtype="paragraph" style="text-align: left;">直接看第7个值:AddressOfEntryPoint，这个成员变量保存着EP的RVA。也就是最先执行代码起始地址。</p>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506048325683366.png" title="1506048325683366.png" alt="17.png"/><noscript><img src="/uploads/20170922/1506048325683366.png" title="1506048325683366.png" alt="17.png"/></noscript></p>
<p cid="n135" mdtype="paragraph" style="text-align: left;">第8个成员变量为:BaseOfCode,表示代码段起始RVA先看他的值，是1000,剩下的等说到ImgaeBase再说。？？</p>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506048338630300.png" title="1506048338630300.png" alt="18.png"/><noscript><img src="/uploads/20170922/1506048338630300.png" title="1506048338630300.png" alt="18.png"/></noscript></p>
<p cid="n139" mdtype="paragraph" style="text-align: left;">第9个成员变量为:BaseOfData,表示数据段的起始RVA,值位9000,跟上面一样，等下再多说。？？</p>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506048353708445.png" title="1506048353708445.png" alt="19.png"/><noscript><img src="/uploads/20170922/1506048353708445.png" title="1506048353708445.png" alt="19.png"/></noscript></p>
<p cid="n143" mdtype="paragraph" style="text-align: left;">第10个成员变量:ImageBase,进程虚拟内存的的范围是0~FFFFFFFF(32位)。PE文件被加入内存中，ImageBase指出文件的优先装入地址。EXE,DLL文件被装载到用户内存的0~7FFFFFFF中，SYS文件被加载到80000000~FFFFFFFF中。DLL文件的ImageBase值位10000000(可以修改)。执行PE文件的时候。PE装载器先创建进程，再将文件载入内存，然后把EIP寄存器的值设置为Image+AddressOfEntryPoint,他的值如下。</p>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506048366824620.png" title="1506048366824620.png" alt="20.png"/><noscript><img src="/uploads/20170922/1506048366824620.png" title="1506048366824620.png" alt="20.png"/></noscript></p>
<pre class="brush:html;toolbar:false">ImageBase+AddressOfEmtryPoint=10000000+739D=0100739D</pre>
<p cid="n150" mdtype="paragraph" style="text-align: left;">计算得出最先执行的代码起始地址，之后使用OD打开，看地址，就是刚刚计算得出的地址</p>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506048387627365.png" title="1506048387627365.png" alt="21.png"/><noscript><img src="/uploads/20170922/1506048387627365.png" title="1506048387627365.png" alt="21.png"/></noscript></p>
<p cid="n154" mdtype="paragraph" style="text-align: left;">接着来说上面的BaseOfCode，一个道理BaseofCode + ImageBase可以得到代码段的起始地址。</p>
<pre class="brush:html;toolbar:false">BaseofCode&nbsp;+&nbsp;ImageBase&nbsp;=&nbsp;1000+10000000&nbsp;=&nbsp;1001000</pre>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506048412145151.png" title="1506048412145151.png" alt="22.png"/><noscript><img src="/uploads/20170922/1506048412145151.png" title="1506048412145151.png" alt="22.png"/></noscript></p>
<p cid="n161" mdtype="paragraph" style="text-align: left;">同理BaseOfData + ImageBase可以得到段的起始地址</p>
<pre class="brush:html;toolbar:false">BaseOfData&nbsp;+&nbsp;ImageBase&nbsp;=&nbsp;9000&nbsp;+&nbsp;10000000&nbsp;=1009000</pre>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506048434176256.png" title="1506048434176256.png" alt="23.png"/><noscript><img src="/uploads/20170922/1506048434176256.png" title="1506048434176256.png" alt="23.png"/></noscript></p>
<p cid="n168" mdtype="paragraph" style="text-align: left;">这是一些题外话，我们继续来说_IMAGE_OPTIONAL_HEADER的成员变量</p>
<p cid="n170" mdtype="paragraph" style="text-align: left;">第11个成员变量SectionAlignment，表示节区在内存中的最下单位，这些节存储着不同类型的数据。</p>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506048448621657.png" title="1506048448621657.png" alt="24.png"/><noscript><img src="/uploads/20170922/1506048448621657.png" title="1506048448621657.png" alt="24.png"/></noscript></p>
<p cid="n174" mdtype="paragraph" style="text-align: left;">第12个成员变量FileAlignment,他指定了节区在磁盘中的最小单位，对于同一个文件FileAlignment和SectionAlignment的值可能相同，也可能不同，但内存的节区大小或磁盘文件中的最小单位必定为SectionAlignment和FileAlignment。在网上看资料的时候说,SectionAlignment一定要大于或等于FileAlignment,这句话是不对的。。别问我为什么，看图</p>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506048463575417.png" title="1506048463575417.png" alt="25.png"/><noscript><img src="/uploads/20170922/1506048463575417.png" title="1506048463575417.png" alt="25.png"/></noscript></p>
<p cid="n178" mdtype="paragraph" style="text-align: left;">第20个成员变量SizeOflmage,这个值表示加载PE文件到内存中时，SizeOflmag指定了PE Image在内存中所占的大小。一般来说，文件的大小与加载到内存中的大小是不同的(街区中定义了各字节装载的位置与所占有内存的大小。后面说)</p>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506048477770365.png" title="1506048477770365.png" alt="26.png"/><noscript><img src="/uploads/20170922/1506048477770365.png" title="1506048477770365.png" alt="26.png"/></noscript></p>
<p cid="n182" mdtype="paragraph" style="text-align: left;">第21个成员变量SizeOfHeaders，这个变量用来指出整个PE头的大小。这个值必须是FileAlingment的整数倍。第一节区所在位置和SizeOfHeaders距文件开始偏移的量相同。（不明白往上看，上面的那个PE文件加载到内存中的图）</p>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506048491236513.png" title="1506048491236513.png" alt="27.png"/><noscript><img src="/uploads/20170922/1506048491236513.png" title="1506048491236513.png" alt="27.png"/></noscript></p>
<p cid="n186" mdtype="paragraph" style="text-align: left;">第23个成员变量Subsystem，这个值用来区分系统驱动文件(*.sys)与普通文件(*.exe,*.dll)。Subsystem成员可拥有的值。看表格(官方给的太多了。)<a href="https://msdn.microsoft.com/zh-cn/library/ms680339(v=vs.85).aspx" target="_blank" textvalue="官网传送门">官网传送门</a></p>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506048510813436.png" title="1506048510813436.png" alt="28.png"/><noscript><img src="/uploads/20170922/1506048510813436.png" title="1506048510813436.png" alt="28.png"/></noscript></p>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506048574143950.png" title="1506048574143950.png" alt="2.png"/><noscript><img src="/uploads/20170922/1506048574143950.png" title="1506048574143950.png" alt="2.png"/></noscript></p>
<p cid="n207" mdtype="paragraph" style="text-align: left;">第30个成员变量NumberOfRvaAndSizes,该成员变量记录着DataDirectory(第31个成员变量)数组的个数。</p>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506048612728123.png" title="1506048612728123.png" alt="29.png"/><noscript><img src="/uploads/20170922/1506048612728123.png" title="1506048612728123.png" alt="29.png"/></noscript></p>
<p cid="n211" mdtype="paragraph" style="text-align: left;">第31个成员变量DataDirectory.</p>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506048630215500.png" title="1506048630215500.png" alt="30.png"/><noscript><img src="/uploads/20170922/1506048630215500.png" title="1506048630215500.png" alt="30.png"/></noscript></p>
<p cid="n215" mdtype="paragraph" style="text-align: left;">DataDirectory是由IMAGE_DATA_DIRECTORY结构体，</p>
<p cid="n217" mdtype="paragraph" style="text-align: left;">结构体类型:</p>
<pre contenteditable="false" cid="n219" mdtype="fences" class="brush:html;toolbar:false;">typedef&nbsp;struct&nbsp;_IMAGE_DATA_DIRECTORY&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;VirtualAddress;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;Size;
}&nbsp;IMAGE_DATA_DIRECTORY,&nbsp;*PIMAGE_DATA_DIRECTORY;</pre>
<p cid="n222" mdtype="paragraph" style="text-align: left;">每一项都有被定义的成员变量</p>
<pre contenteditable="false" cid="n224" mdtype="fences" class="brush:html;toolbar:false;">DataDirectory[0]&nbsp;=&nbsp;EXPORT&nbsp;Directory
DataDirectory[1]&nbsp;=&nbsp;IMPORT&nbsp;Directory
DataDirectory[2]&nbsp;=&nbsp;RESOURCE&nbsp;Directory
DataDirectory[3]&nbsp;=&nbsp;EXCEPTION&nbsp;Directory
DataDirectory[4]&nbsp;=&nbsp;SECURITY&nbsp;Directory
DataDirectory[5]&nbsp;=&nbsp;BASERELOC&nbsp;Directory
DataDirectory[6]&nbsp;=&nbsp;DEBUG&nbsp;Directory
DataDirectory[7]&nbsp;=&nbsp;COPYRIGHT&nbsp;Directory
DataDirectory[8]&nbsp;=&nbsp;GLOBALPTR&nbsp;Directory
DataDirectory[9]&nbsp;=&nbsp;TLS&nbsp;Directory
DataDirectory[A]&nbsp;=&nbsp;LOAD_CONFIG&nbsp;Directory
DataDirectory[B]&nbsp;=&nbsp;BOUND_IMPORT&nbsp;Directory
DataDirectory[C]&nbsp;=&nbsp;IAT&nbsp;Directory
DataDirectory[D]&nbsp;=&nbsp;DELAY_IMPORT&nbsp;Directory
DataDirectory[E]&nbsp;=&nbsp;COM_DESCRIPTOR&nbsp;Directory
DataDirectory[F]&nbsp;=&nbsp;Reserved&nbsp;Directory</pre>
<p cid="n227" mdtype="paragraph" style="text-align: left;">看第一个EXPORT Directory导出表</p>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506048757927656.png" title="1506048757927656.png" alt="22.png"/><noscript><img src="/uploads/20170922/1506048757927656.png" title="1506048757927656.png" alt="22.png"/></noscript></p>
<p cid="n231" mdtype="paragraph" style="text-align: left;">因为没有导出表，所以正常，全部为0</p>
<p cid="n233" mdtype="paragraph" style="text-align: left;">第二个为导入表IMPORT Directory导入表</p>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506048768392950.png" title="1506048768392950.png" alt="222.png"/><noscript><img src="/uploads/20170922/1506048768392950.png" title="1506048768392950.png" alt="222.png"/></noscript></p>
<p cid="n237" mdtype="paragraph" style="text-align: left;">这里就说这两个，因为后面要用到</p>
<p cid="n237" mdtype="paragraph" style="text-align: left;"><strong>4 节区头</strong></p>
<p cid="n240" mdtype="paragraph" style="text-align: left;">节区头中定义了各节区的属性。PE文件中的code(代码),data(数据),resource(资源)等都按照分类存储在不同的节区中。把PE文件创建成多个节区结构的好处是，这样可以保证安全性。起始完全可以把code和resource放在一个字节中纠缠，但是容易引发安全问题，比如，向data段中写数据，写的数据如果超过缓冲区大小的时候，那么下边的code就被覆盖了，应用程序崩溃。所以，PE文件格式的设计者就把相似的数据统一保存在一个被称为节区地方，之后把需要的属性记录在节区头中(内存大小啊，访问权限等等的)。也就是说各个节区分别设置了特性，权限等。</p>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506048856511113.png" title="1506048856511113.png" alt="2222.png"/><noscript><img src="/uploads/20170922/1506048856511113.png" title="1506048856511113.png" alt="2222.png"/></noscript></p>
<p cid="n255" mdtype="paragraph" style="text-align: left;">接下来看存放节区头的结构体IMAGE_SECTION_HEADER。每个结构体对应一个节区</p>
<pre contenteditable="false" cid="n257" mdtype="fences" class="brush:html;toolbar:false;">typedef&nbsp;struct&nbsp;_IMAGE_SECTION_HEADER&nbsp;{
&nbsp;&nbsp;BYTE&nbsp;&nbsp;Name[IMAGE_SIZEOF_SHORT_NAME];
&nbsp;&nbsp;union&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;PhysicalAddress;
&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;VirtualSize;
&nbsp;&nbsp;}&nbsp;Misc;
&nbsp;&nbsp;DWORD&nbsp;VirtualAddress;
&nbsp;&nbsp;DWORD&nbsp;SizeOfRawData;
&nbsp;&nbsp;DWORD&nbsp;PointerToRawData;
&nbsp;&nbsp;DWORD&nbsp;PointerToRelocations;
&nbsp;&nbsp;DWORD&nbsp;PointerToLinenumbers;
&nbsp;&nbsp;WORD&nbsp;&nbsp;NumberOfRelocations;
&nbsp;&nbsp;WORD&nbsp;&nbsp;NumberOfLinenumbers;
&nbsp;&nbsp;DWORD&nbsp;Characteristics;
}&nbsp;IMAGE_SECTION_HEADER,&nbsp;*PIMAGE_SECTION_HEADER;</pre>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506048914455570.png" title="1506048914455570.png" alt="3.png"/><noscript><img src="/uploads/20170922/1506048914455570.png" title="1506048914455570.png" alt="3.png"/></noscript></p>
<p cid="n279" mdtype="paragraph" style="text-align: left;">·VirtualAddress,SizeOfRawData是没有值的，他们的值都是由IMAGE_OPTIONAL_HEADER32中的SectionAlignment和FileAgnment</p>
<p cid="n282" mdtype="paragraph" style="text-align: left;">·VirtualSize,SizeOfRawData的值一般是不同的,程序一般在内存中跟在磁盘中的大小是不同的</p>
<p cid="n284" mdtype="paragraph" style="text-align: left;">因为是相同的结构体，所以只找一个作为演示</p>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506048941859237.png" title="1506048941859237.png" alt="31.png"/><noscript><img src="/uploads/20170922/1506048941859237.png" title="1506048941859237.png" alt="31.png"/></noscript></p>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506048998857390.png" title="1506048998857390.png" alt="33.png"/><noscript><img src="/uploads/20170922/1506048998857390.png" title="1506048998857390.png" alt="33.png"/></noscript></p>
<p cid="n337" mdtype="paragraph" style="text-align: left;">ps：其实看到他的那个NAME的值的时候我是蒙蔽的，不是说好的小端续排列么。(问了个大牛，他只对数有意义，对字符没有这种说法的)</p>
<p cid="n339" mdtype="paragraph" style="text-align: left;">实用PEid来看下工具找到的值跟手动找到的一样不一样</p>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506049030558084.png" title="1506049030558084.png" alt="32.png"/><noscript><img src="/uploads/20170922/1506049030558084.png" title="1506049030558084.png" alt="32.png"/></noscript></p>
<p cid="n343" mdtype="paragraph" style="text-align: left;">完美，一毛一样。</p>
<p cid="n343" mdtype="paragraph" style="text-align: left;"><strong>5. RVA to RAW</strong></p>
<p cid="n346" mdtype="paragraph" style="text-align: left;">PE文件加载到内存时，每个节区都要能准确完成内存地址与文件转移的映射。这种映射就叫 RVA to RAW,</p>
<p cid="n348" mdtype="paragraph" style="text-align: left;">方法如下:</p>
<p cid="n352" mdtype="paragraph" style="text-align: left;">· 查找RVA所在节区</p>
<p cid="n355" mdtype="paragraph" style="text-align: left;">· 实用简单的公式计算文件偏移RAW</p>
<pre class="brush:html;toolbar:false">RAW&nbsp;-&nbsp;PointerToRawData&nbsp;=&nbsp;RVA&nbsp;-&nbsp;VirtualAddress
&nbsp;RAW=&nbsp;RVA&nbsp;-&nbsp;VirtualAddress&nbsp;+&nbsp;PointerToRawData</pre>
<p cid="n364" mdtype="paragraph" style="text-align: left;">演示一个计算:</p>
<pre contenteditable="false" cid="n366" mdtype="fences" class="brush:html;toolbar:false;">RVA&nbsp;=&nbsp;8888,&nbsp;FILE&nbsp;Offset=?
&nbsp;看上面的图，首先查找RVA的值所在区域在第一节区`.text`,刚刚的`ImageBase`是1000000
&nbsp;计算就是：
&nbsp;RAW&nbsp;=&nbsp;8888(RVA)-1000(VitualAddress)+400(PointerToRawData)&nbsp;=&nbsp;7C88</pre>
<p><strong>6. IAT</strong></p>
<p cid="n370" mdtype="paragraph" style="text-align: left;">最最最恶心的部分IAT(import Address Table),导入地址表，IAT保存的内容与Windows操作系统核心的进程，内存，DLL结构等有关的，也就是说，IAT就是Windows的根基。在说简单点，IAT就是一张表，记录了程序正在使用那些库中的那些函数</p>
<p cid="n372" mdtype="paragraph" style="text-align: left;">不过在学之前，我们得先看DLL文件，我不知到英文怎么写的，但是中文就叫动态链接库。</p>
<p cid="n374" mdtype="paragraph" style="text-align: left;">DLL文件有两种加载方式:</p>
<p cid="n378" mdtype="paragraph" style="text-align: left;">· 显式加载:程序使用DLL文件的时候加载,使用完成释放</p>
<p cid="n381" mdtype="paragraph" style="text-align: left;">· 隐式加载:程序在启动的时候加载DLL文件，程序结束的时候释放DLL</p>
<p cid="n383" mdtype="paragraph" style="text-align: left;">IAT提供的机制与隐式加载有关</p>
<p cid="n385" mdtype="paragraph" style="text-align: left;">看一个例子：</p>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506049135199709.png" title="1506049135199709.png" alt="33.png"/><noscript><img src="/uploads/20170922/1506049135199709.png" title="1506049135199709.png" alt="33.png"/></noscript></p>
<p cid="n389" mdtype="paragraph" style="text-align: left;">这是notepad.exe被导入od,调用CreateFileW()函数的代码,这个函数位于kernel32.dll中，</p>
<p cid="n391" mdtype="paragraph" style="text-align: left;">调用CreateFilew()函数并不是直接调用，而是通过01001104处的地址处的值来实现的(所有API地址都是通过这种方法调用的)，地址01001104是notepad.exe中.text节区的内存区域（更确切的说是 IAT的地址）01001104地址的值位7C8107F0,而7C8107F0地址即是加载到notepad.exe进程内存中的CreateFileW()。</p>
<p cid="n393" mdtype="paragraph" style="text-align: left;">之后那么问题来了。为什么不直接调用Call 7C8107F0？微软在想什么。。</p>
<p cid="n395" mdtype="paragraph" style="text-align: left;">Kernel32.dll版本在不同的操作系统肯定是不同的，对应的CreateFileW 函数也不同，为了兼容各种环境，编译器准备了CreateFileW函数的实际地址，然后记下DWORD PTR DS：[xxxxxx]这样的指令，执行文件时候，PE 装载器将CreateFileW函数地址写到这个位置。</p>
<p cid="n397" mdtype="paragraph" style="text-align: left;">而且,存在重定向的问题，如果两个DLL文件有想用的ImageBase,那装载的时候，一个装上去了，另一个肯定不能继续放在这个位置上了。</p>
<p cid="n397" mdtype="paragraph" style="text-align: left;"><strong>6.1 IMAGE_IMPORT_DESCRIPTOR</strong></p>
<pre contenteditable="false" cid="n400" mdtype="fences" class="brush:html;toolbar:false;">typedef&nbsp;struct&nbsp;_IMAGE_IMPORT_DESCRIPTOR&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;union&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;&nbsp;&nbsp;Characteristics;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;0&nbsp;for&nbsp;terminating&nbsp;null&nbsp;import&nbsp;descriptor
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;&nbsp;&nbsp;OriginalFirstThunk;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;RVA&nbsp;to&nbsp;original&nbsp;unbound&nbsp;IAT&nbsp;(PIMAGE_THUNK_DATA)
&nbsp;&nbsp;&nbsp;&nbsp;};
&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;&nbsp;&nbsp;TimeDateStamp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;0&nbsp;if&nbsp;not&nbsp;bound,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;-1&nbsp;if&nbsp;bound,&nbsp;and&nbsp;real&nbsp;datetime&nbsp;stamp
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in&nbsp;IMAGE_DIRECTORY_ENTRY_BOUND_IMPORT&nbsp;(new&nbsp;BIND)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;O.W.&nbsp;date/time&nbsp;stamp&nbsp;of&nbsp;DLL&nbsp;bound&nbsp;to&nbsp;(Old&nbsp;BIND)
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;&nbsp;&nbsp;ForwarderChain;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;-1&nbsp;if&nbsp;no&nbsp;forwarders
&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;&nbsp;&nbsp;Name;
&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;&nbsp;&nbsp;FirstThunk;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;RVA&nbsp;to&nbsp;IAT&nbsp;(if&nbsp;bound&nbsp;this&nbsp;IAT&nbsp;has&nbsp;actual&nbsp;addresses)
}&nbsp;IMAGE_IMPORT_DESCRIPTOR;
#如果你看到了这段代码这里，暂时不要理会，下面会说的
typedef&nbsp;struct&nbsp;_IMAGE_IMPORT_BY_NAME&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;WORD&nbsp;&nbsp;&nbsp;&nbsp;Hint;
&nbsp;&nbsp;&nbsp;&nbsp;BYTE&nbsp;&nbsp;&nbsp;&nbsp;Name[1];
}&nbsp;IMAGE_IMPORT_BY_NAME,&nbsp;*PIMAGE_IMPORT_BY_NAME;</pre>
<p cid="n401" mdtype="paragraph" style="text-align: left;">对一般人来说，导入多少个库，就会存在多少的这样的结构体，这样的结构体组成了数组，而且结构体是以NULL结束的。</p>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506049199116576.png" title="1506049199116576.png" alt="333.png"/><noscript><img src="/uploads/20170922/1506049199116576.png" title="1506049199116576.png" alt="333.png"/></noscript></p>
<p cid="n416" mdtype="paragraph" style="text-align: left;">INT元素的各个值就是上面的_IMAGE_IMPORT_BY_NAME结构体的指针</p>
<p cid="n418" mdtype="paragraph" style="text-align: left;">INT和IAT的大小应该是相同的</p>
<p cid="n420" mdtype="paragraph" style="text-align: left;">下面这张图描述了一个exe程序加载dll的IMAGE_IMPORT_DESCRIPTOR(感觉这是最直观的一张图)</p>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506049226526485.jpg" title="1506049226526485.jpg" alt="34.jpg"/><noscript><img src="/uploads/20170922/1506049226526485.jpg" title="1506049226526485.jpg" alt="34.jpg"/></noscript></p>
<p cid="n424" mdtype="paragraph" style="text-align: left;">接着来看下完整的加载过程</p>
<pre contenteditable="false" cid="n426" mdtype="fences" class="brush:html;toolbar:false;">1.读取NAME&nbsp;成员，获取扩名称字符串
2.装载相应库：&nbsp;LoadLibrary(&quot;kernel32.dll&quot;)
3.读取OriginalFirstThunk成员，获取INT&nbsp;地址
4.读取INT&nbsp;数组中的值，获取相应的&nbsp;IMAGE_IMPORT_BY_NAME地址，是RVA地址
5.使用IMAGE_IMPORT_BY_NAME&nbsp;的Hint&nbsp;或者是name&nbsp;项，获取相应函数的起始位置&nbsp;GetProcAddress(&quot;GetCurrentThreadId&quot;)
6.读取FistrThunk&nbsp;成员，获得IAT&nbsp;地址。
7.将上面获得的函数地址输入相应IAT&nbsp;数组值。
8.重复4-7&nbsp;到INT&nbsp;结束。</pre>
<p cid="n427" mdtype="paragraph" style="text-align: left;">那么现在问题来了。</p>
<p cid="n429" mdtype="paragraph" style="text-align: left;">OriginalFirstThunk 和 First Thunk 都指向的是函数,为什么要这么做？</p>
<p cid="n432" mdtype="paragraph" style="text-align: left;">OriginalFirstThunk 和 First Thunk 他们两个兄弟都是类型为IMAGE_THUNK_DATA的数组，而这个IMAGE_THUNK_DATA又是一个指针大小联合类型。</p>
<p cid="n434" mdtype="paragraph" style="text-align: left;">每一个IMAGE_THUNK_DATA的结构体没有能导入一个名为IMAGE_IMPORT_BY_NAME的东西(就是上面那个让你忽略的，一样，先放着，等会再说这个结构体)</p>
<p cid="n436" mdtype="paragraph" style="text-align: left;">然后，数组最后一个内同0的IMAGE_THUNK_DATA作为结束标识符。赶紧补上结构体，看蒙蔽了估计都</p>
<pre contenteditable="false" cid="n438" mdtype="fences" class="brush:html;toolbar:false;">typedef&nbsp;struct&nbsp;_IMAGE_THUNK_DATA32&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;union&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;ForwarderString;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;PBYTE&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;Function;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;PDWORD
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;Ordinal;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;AddressOfData;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;PIMAGE_IMPORT_BY_NAME
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;u1;
}&nbsp;IMAGE_THUNK_DATA32;</pre>
<p cid="n439" mdtype="paragraph" style="text-align: left;">对于IMAGE_THUNK_DATA，如果最高位为1，则表示函数以序号的方式从DLL中导出引用，低31位表示序号；如果最高位为0，则表示名字导出，此时32位表示一个RVA，这个RVA指向一个结构为IMAGE_IMPORT_BY_NAME的元素。</p>
<p cid="n441" mdtype="paragraph" style="text-align: left;">现在，再说我们一直提到的那个结构体IMAGE_IMPORT_BY_NAME</p>
<pre contenteditable="false" cid="n443" mdtype="fences" class="brush:html;toolbar:false;">typedef&nbsp;struct&nbsp;_IMAGE_IMPORT_BY_NAME&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;WORD&nbsp;&nbsp;&nbsp;&nbsp;Hint;
&nbsp;&nbsp;&nbsp;&nbsp;BYTE&nbsp;&nbsp;&nbsp;&nbsp;Name[1];
}&nbsp;IMAGE_IMPORT_BY_NAME,&nbsp;*PIMAGE_IMPORT_BY_NAME;</pre>
<p cid="n444" mdtype="paragraph" style="text-align: left;">Hint表示字段也表示函数的序号，不过，这个值可有可无，有些编辑器一直把这个字段设置成0</p>
<p cid="n446" mdtype="paragraph" style="text-align: left;">Name字段定义了导入函数的名称字符串，这是一个以0结尾的字符串</p>
<p cid="n446" mdtype="paragraph" style="text-align: left;"><strong>&#8211;x.重中之重</strong></p>
<p cid="n449" mdtype="paragraph" style="text-align: left;">第一个数组(OriginalFirstThunk所指向)是单独的一项，而且不能被改下，就是前面被称为INT的家伙。</p>
<p cid="n451" mdtype="paragraph" style="text-align: left;">第二个数组(FirstThunk所指向)事实上是由PE装载器从重写的</p>
<p cid="n453" mdtype="paragraph" style="text-align: left;">更详细的说一下</p>
<p cid="n455" mdtype="paragraph" style="text-align: left;">PE装载器首先搜索OriginalFirstThunk,找到之后加载程序迭代搜索数组中的每个指针，找到每个IMAGE_IMPORT_BY_NAME所指向的输入函数入口地址,然后加载器用真正的入口函数代替FirstThunk数组中的入口，所以叫做输入地址表，在偷一张图</p>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506049285535540.jpg" title="1506049285535540.jpg" alt="35.jpg"/><noscript><img src="/uploads/20170922/1506049285535540.jpg" title="1506049285535540.jpg" alt="35.jpg"/></noscript></p>
<p cid="n459" mdtype="paragraph" style="text-align: left;">来打开notepad.exe看一下</p>
<p cid="n461" mdtype="paragraph" style="text-align: left;">这个值值究竟在哪里了，他算PE文件的那个部分？他是PE体重的内容，但是想要知道他的位置信息，可以网上看，看IMAGE_OPTIONAL_HEADER32.DATADirectory[1].VirtualAddress中的值就能找到他的地址信息。</p>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506049308907933.png" title="1506049308907933.png" alt="36.png"/><noscript><img src="/uploads/20170922/1506049308907933.png" title="1506049308907933.png" alt="36.png"/></noscript></p>
<p cid="n465" mdtype="paragraph" style="text-align: left;">不相信手工找的也可以用工具来查看一下</p>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506049321615060.png" title="1506049321615060.png" alt="37.png"/><noscript><img src="/uploads/20170922/1506049321615060.png" title="1506049321615060.png" alt="37.png"/></noscript></p>
<p cid="n469" mdtype="paragraph" style="text-align: left;">后面的C8为他的大小,既然拿到了RVA地址，我们来计算一下(忘记公式的，网上看)</p>
<pre class="brush:html;toolbar:false">RAW&nbsp;=&nbsp;7604&nbsp;-&nbsp;1000&nbsp;+&nbsp;400&nbsp;=&nbsp;6A04
6404&nbsp;+&nbsp;C8&nbsp;=&nbsp;6acc&nbsp;&nbsp;这也是结构体的结束</pre>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506049424900504.png" title="1506049424900504.png" alt="3333.png"/><noscript><img src="/uploads/20170922/1506049424900504.png" title="1506049424900504.png" alt="3333.png"/></noscript></p>
<p cid="n479" mdtype="paragraph" style="text-align: left;">红框框中的就是结构体第一个元素:</p>
<p cid="n512" mdtype="paragraph" style="text-align: left;"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506049461575437.png" title="1506049461575437.png" alt="4.png"/><noscript><img src="/uploads/20170922/1506049461575437.png" title="1506049461575437.png" alt="4.png"/></noscript></p>
<p cid="n512" mdtype="paragraph" style="text-align: left;">换算出地址之后，看一下他的NAME字符串的指针，他导入了函数所属库文件名称</p>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506049479906149.png" title="1506049479906149.png" alt="41.png"/><noscript><img src="/uploads/20170922/1506049479906149.png" title="1506049479906149.png" alt="41.png"/></noscript></p>
<p cid="n516" mdtype="paragraph" style="text-align: left;">可以看到字符串的名称为comdlg32.dll</p>
<p cid="n518" mdtype="paragraph" style="text-align: left;">之后我们来看OriginalFirstThunk这个东西。INT是一个包含导入函数信息的结构体数组。只有获取了这些信息，才能准确请求相应函数的起始地址。等会再扯(EAT)</p>
<p cid="n520" mdtype="paragraph" style="text-align: left;">查看6D90</p>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506049495895115.png" title="1506049495895115.png" alt="42.png"/><noscript><img src="/uploads/20170922/1506049495895115.png" title="1506049495895115.png" alt="42.png"/></noscript></p>
<p cid="n524" mdtype="paragraph" style="text-align: left;">跟踪第一个数组(7A7A)，就能看到导入函数API的名称</p>
<pre class="brush:html;toolbar:false">7A7A(RVA)&nbsp;-&nbsp;1000&nbsp;+&nbsp;400&nbsp;=&nbsp;6E7A(RAW)</pre>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506049515423833.png" title="1506049515423833.png" alt="43.png"/><noscript><img src="/uploads/20170922/1506049515423833.png" title="1506049515423833.png" alt="43.png"/></noscript></p>
<p cid="n531" mdtype="paragraph" style="text-align: left;">已经看到了PageSetupDlgW这个字符串,这是一个_IMAGE_IMPORT_BY_NAME的结构体，000F表示函数的序号，不知道有什么用没。后面的字符串以结尾，跟c语言一毛毛一样</p>
<p cid="n533" mdtype="paragraph" style="text-align: left;">这时候来看IAT这个东西，RAW的值为6C4</p>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506049554510889.png" title="1506049554510889.png" alt="44.png"/><noscript><img src="/uploads/20170922/1506049554510889.png" title="1506049554510889.png" alt="44.png"/></noscript></p>
<p cid="n537" mdtype="paragraph" style="text-align: left;">6C4~6EB区域存放的就是IAT的数组区域，对应的comdlg32.dll，他跟INT类似，由结构体指针组成，也是以NULL结尾。第一个被硬编码位76344906,没有什么实际意义，因为在程序加载的时候，这个地址会被准确的地址覆盖掉</p>
<p cid="n539" mdtype="paragraph" style="text-align: left;">用od打开看一下notepad.exe的IAT地址</p>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506049568191549.png" title="1506049568191549.png" alt="45.png"/><noscript><img src="/uploads/20170922/1506049568191549.png" title="1506049568191549.png" alt="45.png"/></noscript></p>
<p cid="n543" mdtype="paragraph" style="text-align: left;">可以看到这块地址就是PageSetupDlgw方法的入口地址</p>
<p cid="n543" mdtype="paragraph" style="text-align: left;"><strong>7. EAT</strong></p>
<p cid="n546" mdtype="paragraph" style="text-align: left;">Windows中库是为了更方便调用其他程序调用耳机中包含的相关文件的函数的文件</p>
<p cid="n548" mdtype="paragraph" style="text-align: left;">EAT是一种核心机制，它使不同的应用程序可以调用库文件中提供的函数,也就是说，只有通过EAT才能从相应库中导出函数的起始地址。也就是说IMAGE_EXPORT_DIRECTORY中保存着导出信息，而且PE文件仅有一个用来说明库EA的IMAGE_EXPORT_DIRECTORY结构体（有木有头觉得比IAT友好许多，恩，肯定了，导入可以导入多个文件啊，兄弟）</p>
<p cid="n550" mdtype="paragraph" style="text-align: left;">使用Kernel32.dll这个文件来看看</p>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506049600828475.png" title="1506049600828475.png" alt="46.png"/><noscript><img src="/uploads/20170922/1506049600828475.png" title="1506049600828475.png" alt="46.png"/></noscript></p>
<p cid="n554" mdtype="paragraph" style="text-align: left;">RVA为0000262C，大小为00006D19.我们先计算出文件的偏移，虽然现在不用，但是等下会用</p>
<pre class="brush:html;toolbar:false">262C-1000+400&nbsp;=&nbsp;1A2C(RAW)</pre>
<p cid="n559" mdtype="paragraph" style="text-align: left;">在看他的文件之前，先来分析下他的结构体</p>
<pre contenteditable="false" cid="n561" mdtype="fences" class="brush:html;toolbar:false;">typedef&nbsp;struct&nbsp;_IMAGE_EXPORT_DIRECTORY&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;&nbsp;&nbsp;Characteristics;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;未使用，总为0&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;&nbsp;&nbsp;TimeDateStamp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;文件创建时间戳
&nbsp;&nbsp;&nbsp;&nbsp;WORD&nbsp;&nbsp;&nbsp;&nbsp;MajorVersion;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;未使用，总为0&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;WORD&nbsp;&nbsp;&nbsp;&nbsp;MinorVersion;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;未使用，总为0
&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;&nbsp;&nbsp;Name;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;指向一个代表此&nbsp;DLL名字的&nbsp;ASCII字符串的&nbsp;RVA
&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;&nbsp;&nbsp;Base;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;函数的起始序号
&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;&nbsp;&nbsp;NumberOfFunctions;&nbsp;&nbsp;//&nbsp;导出函数的总数
&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;&nbsp;&nbsp;NumberOfNames;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;以名称方式导出的函数的总数
&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;&nbsp;&nbsp;AddressOfFunctions;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Export函数地址数组(数组元素的个数=NumberOfFunctions)
&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;&nbsp;&nbsp;AddressOfNames;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;指向输出函数名字的RVA&nbsp;&nbsp;函数名称地址数组(数组元素的个数=NumberOfNames)
&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;&nbsp;&nbsp;AddressOfNameOrdinals;&nbsp;&nbsp;//&nbsp;指向输出函数序号的RVA&nbsp;&nbsp;Ordinal地址数组(数组元素个数=NumberOfNames)
}&nbsp;IMAGE_EXPORT_DIRECTORY,&nbsp;*PIMAGE_EXPORT_DIRECTORY;</pre>
<p cid="n562" mdtype="paragraph" style="text-align: left;">附一张说明的图片</p>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506049640706811.jpg" title="1506049640706811.jpg" alt="47.jpg"/><noscript><img src="/uploads/20170922/1506049640706811.jpg" title="1506049640706811.jpg" alt="47.jpg"/></noscript></p>
<p cid="n566" mdtype="paragraph" style="text-align: left;">加载器加载过程:</p>
<p cid="n570" mdtype="paragraph" style="text-align: left;">1. 根据名称查找函数地址</p>
<pre contenteditable="false" cid="n572" mdtype="fences" class="brush:html;toolbar:false;">（1）定位导出模块的IMAGE_EXPORT_DESCRIPTOR
（2)以NumberOfNames(已知的明明函数总数)为循环次数，循环比较AddressOfNames指向的地址项所对应的函数名字符串，如果没找到匹配的名称字符串，则找不到所对应的函数。
（3）如果找到匹配的函数名字符串，则以此为索引号，取出AddressOfNameOrdinal所指向的序号。
（4）取出的序号-nBase=函数地址索引号
（5）以此为索引号，取出AddressOfFunctions指向的函数地址。</pre>
<p cid="n575" mdtype="paragraph" style="text-align: left;">2. 根据序号查找函数地址</p>
<pre contenteditable="false" cid="n577" mdtype="fences" class="brush:html;toolbar:false;">（1）定位导出模块的IMAGE_EXPORT_DESCRIPTOR
（2）序号-nBase=函数地址索引号
（3）以此为索引号，取出AddressOfFunctions指向的函数地址。</pre>
<p cid="n578" mdtype="paragraph" style="text-align: left;">最后,使用Kernel32.dll掌握下他的结构体</p>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506049710204876.png" title="1506049710204876.png" alt="48.png"/><noscript><img src="/uploads/20170922/1506049710204876.png" title="1506049710204876.png" alt="48.png"/></noscript></p>
<p cid="n582" mdtype="paragraph" style="text-align: left;">只看重要的值</p>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506049808512766.png" title="1506049808512766.png" alt="5.png"/><noscript><img src="/uploads/20170922/1506049808512766.png" title="1506049808512766.png" alt="5.png"/></noscript></p>
<p cid="n625" mdtype="paragraph" style="text-align: left;">先看函数名称数组RAW=293C</p>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506049722357582.png" title="1506049722357582.png" alt="49.png"/><noscript><img src="/uploads/20170922/1506049722357582.png" title="1506049722357582.png" alt="49.png"/></noscript></p>
<p cid="n629" mdtype="paragraph" style="text-align: left;">可以发现，这一串都是有规律的字符串，不一定是我标记的地方，再往下也是，我们随便找一个，比如说选择数组中的第3个元素00004BBD,那他的RAW就是3FBD我们查看此处的值</p>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506049839556112.png" title="1506049839556112.png" alt="50.png"/><noscript><img src="/uploads/20170922/1506049839556112.png" title="1506049839556112.png" alt="50.png"/></noscript></p>
<p cid="n633" mdtype="paragraph" style="text-align: left;">就能查看到函数的名称，接下来，就用这个函数查找该函数Ordinal的值</p>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506049851168959.png" title="1506049851168959.png" alt="51.png"/><noscript><img src="/uploads/20170922/1506049851168959.png" title="1506049851168959.png" alt="51.png"/></noscript></p>
<p cid="n637" mdtype="paragraph" style="text-align: left;">可以看到该区域由多个2字节的Ordinal组成的数组(Ordinal数组中的个元素大小位2字节)，将2中求得的index(2)应用到Ordinal数组就能求得Ordinal(2).</p>
<p cid="n640" mdtype="paragraph" style="text-align: left;">AddressOfNameOrdinals[index] = ordinal(index=2,ordinal=2)</p>
<p cid="n642" mdtype="paragraph" style="text-align: left;">最后查看他的实际函数地址，进入到1A54地址处</p>
<p style="text-align:center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170922/1506049867860771.png" title="1506049867860771.png" alt="52.png"/><noscript><img src="/uploads/20170922/1506049867860771.png" title="1506049867860771.png" alt="52.png"/></noscript></p>
<p cid="n646" mdtype="paragraph" style="text-align: left;">找到了326F1</p>
<p cid="n648" mdtype="paragraph" style="text-align: left;">打开od导入文件进去，用它的ImageBase+326f1 &nbsp;你就可以在od中找到他了。我就不找了，写的头疼。。</p>
<p cid="n656" mdtype="paragraph" style="text-align: left;">如果你看完了，辛苦你了= =！</p>
                <div class="foot_description" style="background-color: #fff;">
                    本文为smileTT原创稿件，授权嘶吼独家发布，未经许可禁止转载，如若转载，请联系嘶吼编辑：                        <a href="http://www.4hou.com/system/7782.html" target=_blank>http://www.4hou.com/system/7782.html</a>
                                    </div>


                 </p>
            </div>
            <div class="article_con">
                <!--文章内容-->
            </div>
            <div class="post-like">
                <a href="javascript:;" data-action="ding" target=_blank data-id="7782" class="favorite">
                <div class="zanbox">
                    <dd class="zanbefor"></dd>
                    <dd class="zanafter"></dd>
                </div>
                <span class="zantext">点赞</span>
                <span class="count">
            0</span>
                </a>
            </div>
            <div class="active_bottom">
                <ul>
                    <a class="Sina" href="http://service.weibo.com/share/share.php?url=http://www.4hou.com/system/7782.html" title="分享到新浪微博" target="_blank"><li class="sinahover"></li></a>
                    <a onclick="window.open('http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url='+encodeURIComponent(document.location.href));return false;" title="分享到QQ空间" class="WeChat" href="javascript:void(0)" target="_blank"><li class="kj"></li></a>
                    <a onclick="dashangToggle()" class="friend" title="分享到微信、朋友圈等" target="_blank"><li class="wx"></li></a>

                </ul>
                <div class="strat icons"><span class='wpfp-span'><img src='http://img.4hou.com/wp-content/plugins/wp-favorite-posts/img/star.png' alt='Favorite' title='Favorite' class='wpfp-img' /><a class='wpfp-link' href='?wpfpaction=add&amp;postid=7782' title='收藏' rel='nofollow'>收藏</a></span></div>
                <div class="hide_box"></div>
                <div class="shang_box">
                    <a class="shang_close" href="javascript:void(0)" onClick="dashangToggle()" title="关闭"><img src="http://img.4hou.com/wp-content/themes/4houv2/images/close.jpg" alt="取消" /></a>
                    <img class="shang_logo" width="120px" src="http://img.4hou.com/wp-content/themes/4houv2/images/logo.png" alt="嘶吼" />
                    <div class="shang_tit">
                        <p>感谢您的支持，我会继续努力的!</p>
                    </div>
                    <div class="shang_payimg">
                        <img src="http://www.4hou.com/wp-content/themes/4houv2/qrcode.php?url=http%3A%2F%2Fwww.4hou.com%2Fsystem%2F7782.html" alt="扫码支持" title="扫一扫" />
                    </div>

                    <div class="shang_info">
                        <p>打开<span id="shang_pay_txt">微信</span>扫一扫后点击右上角即可分享哟</p>
                    </div>
                </div>
            </div>
            
            <div class="avatarbottomwrap">
                 <div class="avatarboxleft">
                        <div class="avatarbottom">
                           
                            <a class="upload-img"><img alt='smileTT' src='http://img.4hou.com/wp-content/uploads/2017/06/a794afc106c3bbc614f5-96x96.jpg' class='avatar avatar-96 photo' height='96' width='96' /></a>
                        </div>
                        <h1 class="authornamebottom"><a href="http://www.4hou.com/member?Author=smileTT" class="upload-img" target=_blank>
                                smileTT                             </a></h1>
                        <p class="authorzybottom">QQ群：617086434</p>

                        <div class="authorbottombox">
                            <!--<div class="gzbtn">关注</div>
                            <div class="sxbtn">私信</div>-->
                                                            <span class="gzbtn"  style="cursor: pointer;" onclick="location.href='/mybox?action=reply&to_user=smileTT&type=send'">发私信</span>
                                                    </div>
                 </div>
                <div class="authorother">
                 <a class="morearticle" href="http://www.4hou.com/member?Author=smileTT" class="upload-img" target=_blank>
                            <span class="swiper-pagination-bullet swiper-pagination-bullet-active"></span>
                            <span class="swiper-pagination-bullet swiper-pagination-bullet-active"></span>
                            <span class="swiper-pagination-bullet swiper-pagination-bullet-active"></span>
                             </a>
                    <div class="swiper-container">

                                                    <div class="swiper-wrapper">
                               
                                <div class="swiper-slide">
                                                                        <div><a href="http://www.4hou.com/system/7782.html" target=_blank>
                                            <img data-original="http://img.4hou.com/wp-content/uploads/2017/09/05710fa9158c472a893f.jpg?imageView2/1/w/140/h/104/format/png"  class="wp-post-image"width="140" height="104"  />                                        </a></div>
                                                                        <div><a href="http://www.4hou.com/technology/5962.html" target=_blank>
                                            <img data-original="http://img.4hou.com/wp-content/uploads/2017/07/9597781bc08ac2387d87.jpg?imageView2/1/w/140/h/104/format/png"  class="wp-post-image"width="140" height="104"  />                                        </a></div>
                                                                        <div><a href="http://www.4hou.com/reverse/5643.html" target=_blank>
                                            <img data-original="http://img.4hou.com/wp-content/uploads/2017/06/50aa2a72c22d111cb7fe.jpg?imageView2/1/w/140/h/104/format/png"  class="wp-post-image"width="140" height="104"  />                                        </a></div>
                                                                        <div><a href="http://www.4hou.com/technology/5449.html" target=_blank>
                                            <img data-original="http://img.4hou.com/wp-content/uploads/2017/06/83b764a33cd87f5901e4.png?imageView2/1/w/140/h/104/format/png"  class="wp-post-image"width="140" height="104"  />                                        </a></div>
                                                                    </div>
                            </div>
                                        </div>
                </div>
                <script type="text/javascript">
                    function dashangToggle(){
                        $(".hide_box").fadeToggle();
                        $(".shang_box").fadeToggle();
                    }
                </script>
                <script> 
                    var mySwiper = new Swiper('.swiper-container', {
                        direction : 'vertical',
                        pagination : '.swiper-pagination',
                        paginationClickable :true,
                        spaceBetween : 20
                    })
                </script>
            </div>
                            <div class="review" style="margin-bottom:80px;">
    <h3 id="reply-title" class="comment-reply-title">发表评论 <small></h3>
    <form action="http://www.4hou.com/wp-comments-post.php" method="post" id="commentform">
        <p class="commentname"><label for="author">昵称</label>
            <input type="text" name="author" id="author" value="" size="14" tabindex="1" aria-required='true' placeholder = "请输入昵称" required />
        </p>
        <p class="commenteml">
            <label for="email">邮箱</label>
            <input type="text" name="email" id="email" value="" size="25" tabindex="2" aria-required='true' placeholder = "请输入邮箱地址" required />
        </p>
        <p class="comment-form-comment">
           <label for="comment">评论</label>
           <textarea id="comment" name="comment" cols="45" rows="8" maxlength="65525" aria-required="true" required="required"></textarea>
        </p>

        <p class="form-submit"><input name="submit" type="submit" id="submit" class="submit" value="发表评论" />
        <input type='hidden' name='comment_post_ID' value="7782" id='comment_post_ID' />
            <input type='hidden' name='comment_parent' id='comment_parent' value='0' />
        </p>
    </form>
					
<div class="new-review">
   <ol class="commentlist">
   <div class="comment-box" id="li-comment-1843">
    <div class="avatar fl"><img alt='' src='http://cn.gravatar.com/avatar/aa2c92ae1c0753adc66c4fdb01f25200?s=120&#038;d=mm&#038;r=g' srcset='http://cn.gravatar.com/avatar/aa2c92ae1c0753adc66c4fdb01f25200?s=240&amp;d=mm&amp;r=g 2x' class='avatar avatar-120 photo' height='120' width='120' /></div>
    <!--评论列表-->
    <div class="user-comment">
    <!--评论人-->
  <a id="c-man" href="http://www.4hou.com/member?Author=YP" class="nick">YP</a>
  <!--评论时间-->
  <span>2017-09-24 19:46</span>
  <!--评论内容-->
<p>文章中不少错误，还望仔细校对</p>
  <!--回复按钮-->
  <div class="reply clearfix">
<a rel='nofollow' class='comment-reply-link' href='http://www.4hou.com/system/7782.html?replytocom=1843#respond' onclick='return addComment.moveForm( "comment-1843", "1843", "respond", "7782" )' aria-label='回复给YP'>回复</a>  </div>
  </div>
<script>
  $("#replybtn").click(function(){
     $("#ta").text("");
     $("#comment").focus();
  })
</script>
  <!--评论审核提示-->
  <div class="comment_text">
  </div>
</div>
</li><!-- #comment-## -->
   </ol>
   <div class="hr clearfix">&nbsp;</div>
</div>
</div>             
        </article>

        <!--作者其他文章-->
        <aside class="article_authorbox">
          <div class="article_authorbox_top">
                <div class="article_author">
            <div class="article_author_avatar">
                 <a class="upload-img"><img alt='smileTT' src='http://img.4hou.com/wp-content/uploads/2017/06/a794afc106c3bbc614f5-96x96.jpg' class='avatar avatar-96 photo' height='96' width='96' /></a>
            </div>
            <h1 class="article_author_name"><a href="http://www.4hou.com/member?Author=smileTT" class="upload-img" target=_blank>
                    smileTT                </a></h1>
            <p class="article_author_type">QQ群：617086434 </p>
            <div class="article_author_bottom">
                                        <span class="send-info" onclick="location.href='/mybox?action=reply&to_user=smileTT&type=send'">发私信</span>
                         
            </div>
          </div>  
            <div class="interested">
                <h1>可能喜欢</h1>
                                                    <li>
                    <i></i>
                    <a href="http://www.4hou.com/info/news/7807.html" target="_blank">第二届SSC安全峰会，做西北安全的风向标</a> 
                </li> 
                                <li>
                    <i></i>
                    <a href="http://www.4hou.com/technology/7586.html" target="_blank">CSS in JS攻击面综合分析</a> 
                </li> 
                                <li>
                    <i></i>
                    <a href="http://www.4hou.com/technology/7711.html" target="_blank">以扑克游戏网站为例，实战Flash应用程序渗透测试</a> 
                </li> 
                                <li>
                    <i></i>
                    <a href="http://www.4hou.com/info/news/7800.html" target="_blank">下一站极棒黑客大赛，人“攻”智能</a> 
                </li> 
                                <li>
                    <i></i>
                    <a href="http://www.4hou.com/info/news/7797.html" target="_blank">Google又造出一款挖洞神器，在5大主流浏览器上找到31个漏洞</a> 
                </li> 
                                                </div>
       </div>

          
        </aside>
    </section>
    <div id="zooming">
        <img src="" id="imgcon">
    </div>
    <script>
        $(document).ready(function() {
            $.fn.postLike = function() {
                if ($(this).hasClass('done')) {
                    return false;
                } else {
                    $(this).addClass('done');
                    var id = $(this).data("id"),
                        action = $(this).data('action'),
                        rateHolder = $(this).children('.count');
                    var ajax_data = {
                        action: "bigfa_like",
                        um_id: id,
                        um_action: action
                    };
                    $.post("/wp-admin/admin-ajax.php", ajax_data,
                        function(data) {
                            $(rateHolder).html(data);
                        });
                    return false;
                }
            };
            $(document).on("click", ".favorite",
                function() {
                    $(this).postLike();
                });


            $("img").attr("title","");
            var altcon=$(".art_title").text();
            $("img").attr("alt",altcon);
            // 图片放大
            $(".article_cen").find('img').on("click",function(){
                var imgsrc=$(this).attr("src");
                var winthimg=$(this).width();
                var zooming=winthimg*1.2;
                $("#imgcon").css({width:zooming});
                $("#imgcon").css({marginLeft:-zooming/2});
                $("#imgcon").attr("src",imgsrc);
                $("#zooming").addClass("zoomaniatae");
                $("#imgcon").addClass("imgconadimate");
            });
            $("#zooming").on("click",function(){
                $("#imgcon").removeClass("imgconadimate");
                $("#zooming").removeClass("zoomaniatae");

            });

            $(window).scroll(function(){
                var scrtop=$(window).scrollTop();
                if(scrtop>450){
                    $(".article_authorbox_top").removeClass("asideanimateleave").addClass('asideanimate')
                    // $(".interested").hide()
                }
                else if(scrtop<450&&scrtop>350){
                     $(".article_authorbox_top").addClass("asideanimateleave").removeClass('asideanimate')
                     $(".interested").show()

                }
            });
            var start=$(".strat .wpfp-span .wpfp-link").text()
            if(start=="已收藏"){
                $(".strat").addClass("stratend")
            }else{
                $(".strat").removeClass("stratend")
            }

            $(".avatar-96").width(72);
            $(".avatar-96").height(72);
            $(".avatar-120").width(50);
            $(".avatar-120").height(50);

        });
    </script>
<style type="text/css">
.footer{height:auto; background-color: #282828}
.footer_about{width: 1200px;height: 50px;padding-top: 26px; margin: 0 auto;border-bottom-color: transparent !important; position: relative;}
.footer_about>a{font-size: 16px;height: 16px !important;line-height: 16px !important; float: left; padding-right: 18px; border-right:1px solid #ccc;}
.last-child-a{border:none !important}
.footer_bottom_cen p{ margin-top: 5px; margin-right: 25px;text-align: left; margin-bottom: 6px;float: left;}
.footer_bottom_cen>div{width: 450px;float: left;margin-right: 8px}
.footer_bottom{height: 74px}
.footerlogos{width: 130px; height: 24px; position: absolute;right: 10%; top:24px;}
.footerlogos dd{float: left; margin-right: 20px;cursor: pointer;}
.footerlogos dd a{display: block;width: 100%; height: 100%}
.wechartlogo{width: 20px; height: 20px; background-position:-227px 0px;}
.weibologo{width: 20px; height: 20px; background-position:-269px 0px;}
.zhihulogo{width: 20px; height: 20px; background-position:-361px 0px;}
.wechartlogo i{width: 80px;height: 78px;background-size: contain !important; right: 137px;display: none;opacity: 1;background: url(http://www.4hou.com/wp-content/themes/4houv2/img/wechatqr.png) no-repeat;position: absolute;top: -28px;}
.wechartlogo:hover i{display: block;}
.footer_bottom{width: 1200px; background-color: #282828; margin:0 auto } 
.footer_bottom_cen>div img{float: left; margin-right: 4px;margin-top: 4px; margin-left: 4px;width: 66px;}
.footer_bottom_cen{width: 100%}
.cloudserver{float: right !important; margin: 0 auto !important;width: 385px !important; margin-top: -31px}
.cloudserver img{float: left;}
.cloudserver dd{float: left;}
@media screen and (max-width:1260px) {
    .footer{width: 100%; padding: 0px 20px;}
    .footer_about{width: 100%}
    .footer_bottom{width: 100%}
    .footer_bottom div{width: 100%;display: none;}
}
@media screen and (max-width:660px) {
    .footer_about{padding-top: 14px; margin-bottom: 22px;}
    .footerlogos{display: none;}
    .footer_bottom{height: 44px;}

}
</style>
<footer class="footer">
    <div class="footer_about">
        <a href="/about" target=_blank>关于我们</a>
        <!--<a href="">加入我们</a>-->
        <a href="/submit" target=_blank>我要投稿</a>
        <a href="/service" target=_blank>广告及服务</a>
        <a href="/partner" target=_blank class="last-child-a">友情链接</a>
        <div class="footerlogos">
                <dd class="wechartlogo icons">
                  <i></i>
                </dd>
                <dd class="weibologo icons">
                 <a href="http://weibo.com/u/6069423878" target=_blank></a>
                </dd>
                <dd class="zhihulogo icons">
                    <a href="https://zhuanlan.zhihu.com/roartalk" target=_blank></a>
                    
                </dd>
        </div>
    </div>

    <section class="footer_bottom">
        <article class="footer_bottom_cen">
            <p>©2017 北京嘶吼文化传媒有限公司&nbsp;&nbsp;&nbsp;京ICP备16063439号</p>
            <p class="mobilefooter">©2017 北京嘶吼文化传媒有限公司&nbsp;&nbsp;|&nbsp;&nbsp;京ICP备16063439号</p>
            <div class="cloudserver">
                <span>本站由</span>
                <img src="http://img.4hou.com/wp-content/themes/4houv2/img/bdcloud.png">
                <img src="http://img.4hou.com/wp-content/themes/4houv2/img/bdcloud1.png">
                <img src="http://img.4hou.com/wp-content/themes/4houv2/img/ucloud.png">
                <span>提供云计算服务</span>
            </div>
        </article>
    </section>
    <section class="footer_top" style="display:none">
        <article class="footer_top_cen">
            <div class="homeqrcode">
                <dd class="icons"></dd>
                <div class="wb">
                    <a href="http://weibo.com/u/6069423878" target=_blank>
                    <i class="icons"></i>
                    <p>关注嘶吼传媒</p>
                    </a>
                </div>

                <div class="sh">
                    <a href="https://zhuanlan.zhihu.com/roartalk" target=_blank>
                    <i class="icons"></i>
                    <p>关注嘶吼</p>
                    </a>
                </div>
            </div>
            
            <h1>合作伙伴</h1>
            <div class="footer_friend">
                <a href="http://www.xinhuanet.com/talking/chinasafety/" target=_blank>新华网安全中国</a>
                <a href="http://jaq.alibaba.com/" target=_blank>阿里聚安全</a>
                <a href="http://www.seclover.com/" target=_blank>四叶草安全</a>
                <a href="https://sec.vip.com/" target=_blank>唯品会安全应急响应中心</a>
                <a href="https://www.duoyinsu.com/" target=_blank>安识科技</a>
                <a href="http://xianzhi.aliyun.com" target=_blank>云盾先知</a>
                <a href="http://www.ardsec.com/" target=_blank>兴华永恒</a>
                <a href="https://www.sobug.com/" target=_blank>SOBUG</a>
            </div>
        </article>
    </section>
    
</footer>
<aside class="side" >
    <div class="side_top icons "></div>
    <div class="iconbox">
        <div class="side_wechart icons iconhover">微信
            <dd></dd>
        </div>
        <a href="http://weibo.com/u/6069423878" target=_blank><div class="side_webo icons iconhover">微博</div></a>
        <a href="http://www.4hou.com/feed/" target=_blank><div class="side_rss icons iconhover">RSS</div></a>
        <a href="https://zhuanlan.zhihu.com/roartalk" target=_blank><div class="side_zh icons iconhover">知乎</div></a>
    </div>
    <div class="side_bottom icons"></div>
    
</aside>

<script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?ac201c14c3d2a4747423252be421e1bc";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>

<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-91554508-1', 'auto');
    ga('send', 'pageview');

</script>
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
<script type="text/javascript"  src="//idm-su.baidu.com/su.js"></script>
</body>
</html>