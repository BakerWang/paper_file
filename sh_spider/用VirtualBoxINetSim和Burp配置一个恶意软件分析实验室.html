<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <title>用VirtualBox、INetSim和Burp配置一个恶意软件分析实验室 - 嘶吼 RoarTalk &#8211; 回归最本质的信息安全,互联网安全新媒体,4hou.com</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="renderer" content="webkit">
    <meta property="wb:webmaster" content="4517e8fe39b18975" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,Chrome=1" />
    <meta name="description" content="在这篇文章中，我们将创建一个与主机操作系统和互联网隔离的隔离虚拟网络，我们将在其中设置两个受害虚拟机（Ubuntu和Windows 7）以及分析服务器，以模拟常见的Internet服务，如HTTP或DNS。然后，我们将能够记录和…" />
    <meta name="keywords" content="" />
        <link href="http://img.4hou.com/wp-content/themes/4houv2/images/favicon.ico" rel="shortcut icon">
    <link href="http://img.4hou.com/wp-content/themes/4houv2/images/favicon_114.png" rel="apple-touch-icon">
    <link href="http://img.4hou.com/wp-content/themes/4houv2/images/favicon_76.png" sizes="76x76" rel="apple-touch-icon">
    <link href="http://img.4hou.com/wp-content/themes/4houv2/images/favicon_120.png" sizes="120x120" rel="apple-touch-icon">
    <link href="http://img.4hou.com/wp-content/themes/4houv2/images/favicon_152.png" sizes="152x152" rel="apple-touch-icon">

    <!-- 引入 lib -->
    <script src="http://www.4hou.com/wp-content/themes/4houv2/lib/jquery.min.js"></script>
    <script src="http://www.4hou.com/wp-content/themes/4houv2/lib/swiper.jquery.min.js"></script>
    <link rel="stylesheet" href="http://www.4hou.com/wp-content/themes/4houv2/lib/swiper.min.css">
    <link rel="stylesheet" href="http://www.4hou.com/wp-content/themes/4houv2/lib/allmin.css">
    <!--[if lt IE 11]>
    <script src="http://www.4hou.com/wp-content/themes/4houv2/lib/html5shiv.min.js"></script>
    <script src="http://www.4hou.com/wp-content/themes/4houv2/lib/respond.js"></script>
    <![endif]-->
    <!-- 引入 css js -->
    <link rel="stylesheet" href="http://www.4hou.com/wp-content/themes/4houv2/css/style.css">
    <link rel="stylesheet" href="http://www.4hou.com/wp-content/themes/4houv2/lib/allmin.css">
    <script src="http://www.4hou.com/wp-content/themes/4houv2/js/public.js"></script>
    <script src="http://www.4hou.com/wp-content/themes/4houv2/js/main.js"></script>
    <script src="http://www.4hou.com/wp-content/themes/4houv2/js/index-more.js"></script>
    </head>
<body>
<style type="text/css">
.memberlistanimate{width: 122px}
.memberlistanimateleave{width: 122px}
.nameheader{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;width: 78px;display: block;}
</style>

<header class="header">
            <article class="header_center">
                <div class="logowrap">
            <a href="http://www.4hou.com"><div class="logo icons"></div></a>
            <h1>回归最本质的信息安全</h1>
        </div>
        <div class="login">
            <form action="/" class="navbar-form inSearch " name="searchform" onsubmit="return checksubmit()">
                <div class="br">
                    <span class="in-btn icons"></span>
                    <input type="text" name="s" id="search" class="animated">
                    <div class="clear icons"></div>
                </div>
                <div id="submitBtnplace" class="icons animated" value=""></div>
                <!--<input type="submit" id="submitBtn" class="icons animated" value="">-->
            </form>
                            <!--登录注册按钮-->
                 <div id="register">
                     <a href="http://www.4hou.com/register" data-event-category="Referral to Signup" data-event-action="click" data-event-label="Signup Menu button / Header">注册</a>
                 </div>
                 <div id="sing">
                      <a href="http://www.4hou.com/login" class="pzh_login">登录</a>
                 </div>

                 <div class="burger2 menu" id="burger">
                  <div class="icon"></div>
                 </div>

            
           <!-- <div id="register">注册</div>
            <div id="sing">登录</div>
            <div class="burger2 menu" id="burger">
                <div class="icon"></div>
            </div>-->
        </div>
    </article>
</header>
<nav class="navbox animated">
    <section class="navbox_cen">
        <article class="navboxleft">
            <ul class="nav navbar-nav index-nav" id="inNav">
					<li>
							<li class="cat-item cat-item-18"><a href="http://www.4hou.com/category/info" >资讯</a>
</li>
	<li class="cat-item cat-item-19"><a href="http://www.4hou.com/category/technology" >技术</a>
</li>
	<li class="cat-item cat-item-20"><a href="http://www.4hou.com/category/xactivity" >活动</a>
</li>
	<li class="cat-item cat-item-29"><a href="http://www.4hou.com/category/vulnerable" >漏洞</a>
</li>
					</li>
                    <li class="cat-item cat-item-29"><a href="http://www.4hou.com/piao" >嘶票</a>
                    </li>
            </ul>
        </article>
        <article class="navboxright">
            <div class="contrib"> <a href="http://www.4hou.com/contribute" class="tougao" data-event-category="Referral to Signup" data-event-action="click" data-event-label="Signup Menu button / Header">投稿</a></div>
        </article>
    </section>
</nav>
<div id="modelbg"></div>
    <style>


    ::selection {
    background:#fea283;
    color:#fff;
}
::-moz-selection {
    background:#fea283;
    color:#fff;
}
::-webkit-selection {
    background:#fea283;
    color:#fff;
}


        .article_cen p img{height: auto !important;}
        .commentlist .children{width: 90%; padding-right: 15px; border-color: transparent ;}
        .commentname,.commenteml{width: 60%; margin-left:5% ;margin-bottom: 30px;border-bottom: 1px solid #dbdbdb;}
        .article_cen ol li{list-style-type: decimal;}
         .article_cen ol li p{overflow: inherit;}
        .commentname label{font-size: 16px;color: #666; margin-right: 10px;line-height: 32px;}
        .commentname input{width: 50%;border: none; outline: none;}
        .commenteml label{font-size: 16px;color: #666; margin-right: 10px;line-height: 32px;}
        .commenteml input{width: 50%;border: none; outline: none;}
        #zooming{display: none;width: 100%;height: 100%; position: fixed;z-index: 999;left: 0px; top: 0px; background-color: rgba(0,0,0,.6);}
        .zoomaniatae{display: block !important;}
        .imgcon{}
        #imgcon{position: absolute;left: 50%; top: 20%;max-width: 80%}
        .article_cen img{cursor: pointer;}
        #zooming{cursor: pointer;}
        .imgconadimate{animation:imgcon 0.5s 1 forwards;
        -webkit-animation:imgcon 0.5s 1 forwards;}
        .article_authorbox{    width: 222px;min-height: 214px;
        padding-bottom: 20px;
        float: right;
        position: relative;}
        .interested{position: relative;}
        .interested>h1{font-size: 18px; font-weight: 900; position: absolute; top: -36px;color: #5e5e5e}
       .user-comment span{font-size: 13px; position: relative; top: 2px;}
        .article_authoradd{position: fixed;}
        .stratend{background:url(http://www.4hou.com/wp-content/themes/4houv2/img/starend.png); !important;background-size: contain !important;}
        .wpfp-span{opacity: 0;width:100%; height: 100%;display: block; left: 0px; top: 0px; }
        .wpfp-link{width:100%; height: 100%;display: block; left: 0px; top: 0px; }
        .wpfp-span img{display: none;}
        .interested{width: 222px;padding-bottom: 20px;background-color: #fff;margin-top: 70px; padding-bottom: 10px; padding-top: 10px;border: 1px solid #f5c2b1}
        .interested li{width: 100%;position: relative;padding-top: 8px; padding-bottom: 8px;  line-height: 24px; padding-left: 20px;padding-right: 14px}
        .interested li i{width: 6px;height: 6px;border-radius: 50%; background-color: #f63;position: absolute; left: 8px; top: 18px;}
        .interested li a{color: #666;font-size: 14px; line-height: 18px;}
        .interested li:hover{background-color: #f9e7e3;-moz-transition: all 0.4s ease-in-out;
        .footer{position: relative;z-index: 99}   
        .article_authorbox_top{position: relative;} 
        

        -o-transition: all 0.4s ease-in-out; -webkit-transition: all 0.4s ease-in-out; transition: all 0.4s ease-in-out;}
    
        @-webkit-keyframes imgcon{
            0%{ opacity:0; -webkit-transform:scale3d(.3, .3, .3); transform:scale3d(.3, .3, .3) }
            50%{ opacity:1 }
        }
        @keyframes imgcon{
            0%{ opacity:0; -webkit-transform:scale3d(.3, .3, .3); transform:scale3d(.3, .3, .3) }
            50%{ opacity:1 }
        }
        .asideanimate{animation:asideanimate 1s 1 forwards;
        -webkit-animation:asideanimate 1s 1 forwards; position: fixed;}
        @-webkit-keyframes asideanimate{
            0%{ opacity:0; -webkit-transform:translate3d(0,-20%, 0); transform:translate3d(0, -20%, 0) }
            50%{ opacity:1 }
        }
        @keyframes asideanimate{
            0%{ opacity:0; -webkit-transform:translate3d(0,-20%, 0); transform:translate3d(0, -20%, 0) }
            50%{ opacity:1 }
        }
        .asideanimateleave{animation:asideanimateleave 1s 1 forwards;
        -webkit-animation:asideanimateleave 1s 1 forwards;}
        @-webkit-keyframes asideanimateleave{
            0%{ opacity:1; -webkit-transform:translate3d(0,0, 0); transform:translate3d(0, 0, 0) }
            50%{ opacity:0;-webkit-transform:translate3d(0,-20%, 0); transform:translate3d(0, -20%, 0) }
        }
        @keyframes asideanimateleave{
            0%{ opacity:1; -webkit-transform:translate3d(0,0, 0); transform:translate3d(0, 0, 0) }
            50%{ opacity:0;-webkit-transform:translate3d(0,-20%, 0); transform:translate3d(0, -20%, 0) }
        }
        @media screen and (max-width:650px) {
            .member_list{right: -30px !important;top: 34px !important;}
            .article_authorbox{display: none;}
            .nameheader{display: none;}
            .shang_box{width: 90%; margin-left:-45% }
            #imgcon{width: 90% !important; margin-left: -45% !important;max-width: inherit !important}
            .dy{padding: 12px 15px!important;font-size: 14px !important; line-height: 22px !important;}
        }
        .article_author{float:none !important;padding-top: 1px;}
        .article_cen pre{color: #666 !important; line-height: 26px; background-color: #f1f1f1}
        .articlecontent blockquote>p{ color: #666; font-size: 16px; }
    </style>
    <section class="articlewrap">
        <article class="articlecontent">
            <div class="article_top">
                <h1 class="art_title">用VirtualBox、INetSim和Burp配置一个恶意软件分析实验室</h1>
                <p class="art_time">2017年7月18日发布</p>
                <div class="art_nav">
                    <!--<a href="">翻译文章</a>
                    <span>／</span>
                    <a href="">新闻</a>
                    <span>／</span>
                    <a href="">原创</a>-->
                                        <a href="http://www.4hou.com">首页 </a></a>
                    <span>／</span>
                    <a href="http://www.4hou.com/category/technology">技术</a>
                    <span>／</span>
                    <a href="">正文</a>

                    </ul>
                </div>
                <div class="art_type">
                    <div class="newtype">
                        <div class="read ">
                            <i class="icons"></i>
                            <span>18,542</span>
                        </div>
                        <div class="comment ">
                            <i class="icons"></i>
                            <span>0</span>
                        </div>
                        <div class="Praise">
                            <i class="icons"></i>
                            <span>0</span>
                        </div>
                    </div>
                </div>
            </div>
             <p class="dy" style="padding: 24px 60px;font-size: 16px;line-height: 30px;color: #808080;background-color: #f6f6f6;"><span style="font-weight: bold;">导语：</span>我们将创建一个与主机操作系统和互联网隔离的隔离虚拟网络，我们将在其中设置两个受害虚拟机（Ubuntu和Windows 7）以及分析服务器，以模拟常见的Internet服务，如HTTP或DNS。</p>

            <div class="article_cen">
                <!--文章摘要-->
               
                <p><p>在这篇文章中，我们将创建一个与主机操作系统和互联网隔离的隔离虚拟网络，我们将在其中设置两个受害虚拟机（Ubuntu和Windows 7）以及分析服务器，以模拟常见的Internet服务，如HTTP或DNS。然后，我们将能够记录和分析任何Linux或Windows恶意软件的网络通信，不知不觉中连接到我们的服务器而不是Internet。我们分析了臭名<a href="https://en.wikipedia.org/wiki/TeslaCrypt" target="_blank" textvalue="昭着的TeslaCrypt ransomware">昭着的TeslaCrypt ransomware</a>的流量，ransomware从2015年到2016年中感染了大量的系统。</p>
<div>
<p style="text-align:center"><img width="700" height="279" title="" class="aligncenter size-full wp-image-5675" style="width: 700px; height: 279px;" alt="" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="http://img.4hou.com/wp-content/uploads/2017/06/cde04dc727ea9fbe75ed-1.png" border="0" vspace="0"/><noscript><img width="700" height="279" title="" class="aligncenter size-full wp-image-5675" style="width: 700px; height: 279px;" alt="" src="http://img.4hou.com/wp-content/uploads/2017/06/cde04dc727ea9fbe75ed-1.png" border="0" vspace="0"/></noscript></p>
</div>
<p><span style="font-size: 20px;"><strong>1.创建虚拟机</strong></span></p>
<p>这里有两个链接可用于下载Ubuntu和Windows 7虚拟机镜像。</p>
<p>Ubuntu（受害机1和分析机）：从OsBoxes （直接链接）下载Ubuntu 16.10 64位</p>
<div>Windows 7（受害者机器2）：从Microsoft开发人员网站下载 （选择 &nbsp;Win 7（x86）上的IE 11和 &nbsp;VirtualBox）</div>
<p>Ubuntu机器</p>
<p>OsBoxes为我们提供了一个即用的虚拟磁盘，我们可以简单地插入虚拟机并立即开始使用。首先提取你刚才下载的档案。</p>
<pre class="brush:html;toolbar:false">$7za&nbsp;e&nbsp;Ubuntu_16.10_Yakkety-VB-64bit.7z</pre>
<p>您将获得一个代表机器的虚拟磁盘的VDI文件。我们将从设置基本的Ubuntu镜像开始，然后克隆我们的两个Ubuntu虚拟机。</p>
<p>在VirtualBox中，创建一个新的机器（新建按钮），并称之为Ubuntu &nbsp;分析。然后，选择要给它多少RAM。此时，VirtualBox会询问您是否要创建新的虚拟硬盘或使用已经退出的虚拟硬盘。选择 &nbsp;使用现有的虚拟硬盘文件，单击下拉列表右侧的目录图标，然后选择VDI文件。然后您可以启动机器。默认密码是 &nbsp;osboxes.org。</p>
<p><span style="font-size: 16px;"><strong>基本设置</strong></span></p>
<p>默认键盘使用QWERTY布局。如果像我一样，你不熟悉它，首先改变它（设置&gt;文本输入）。</p>
<p>或者，您也可以使用以下方式更改默认密码：</p>
<div>
<pre class="brush:html;toolbar:false">$&nbsp;passwd&nbsp;osboxes</pre>
<p>选择设备&gt;在虚拟机运行的窗口的菜单中插入客户添加CD映像。然后会询问您是否要运行安装程序; 回答是，并输入默认密码（默认为 &nbsp;osboxes.org）。安装完成后，关闭虚拟机电源。</p>
</div>
<p><span style="font-size: 16px;"><strong>克隆</strong></span></p>
<p>现在你有一个基本的Ubuntu VM准备好了，克隆它（在VirtualBox主界面&gt; 克隆中右键点击它）。命名克隆Ubuntu的受害者， 并选中该复选框以重新初始化其MAC地址。选择克隆类型的完整克隆。</p>
<p><strong>Windows 7机器</strong></p>
<p>之前提供的下载链接指向包含OVA文件的ZIP存档。与VDI文件不同，它不仅是虚拟磁盘，而且是对虚拟机（包括其虚拟磁盘）的完整描述，因此，您从中创建虚拟机所需的唯一工作就是选择“文件”&gt;“导入设备”VirtualBox的主窗口。如果你负担得起，最好给它至少1024 MB的RAM。</p>
<p>&nbsp;导入过程完成后（可能需要几分钟），重命名VM Windows 7受害者并启动它。</p>
<p><span style="font-size: 20px;"><strong>2.设置分析机：INetSim，Burp</strong></span></p>
<p><strong>INetSim</strong></p>
<p><a href="http://www.inetsim.org/index.html" target="_blank" textvalue="INetSim">INetSim</a>是一个非常方便和强大的实用程序，允许在机器上模拟一堆标准Internet服务。默认情况下，它将模拟一个可以轻松调整的DNS，HTTP和SMTP。由于我们稍后将受害者机器配置为没有Internet访问，因此我们将需要INetSim进行模拟。</p>
<pre class="brush:html;toolbar:false">$&nbsp;sudo&nbsp;su
$&nbsp;echo&nbsp;&quot;deb&nbsp;
http://www.inetsim.org/debian/&nbsp;binary/&quot;&nbsp;&gt;&nbsp;/etc/apt/sources.list.d/inetsim.list
$&nbsp;wget&nbsp;-O&nbsp;-&nbsp;http://www.inetsim.org/inetsim-archive-signing-key.asc&nbsp;|&nbsp;apt-key&nbsp;add&nbsp;-
$&nbsp;apt&nbsp;update
$&nbsp;apt&nbsp;install&nbsp;inetsim</pre>
<p>为了能够在分析计算机中复制粘贴这些命令，请选择设备&gt;共享剪贴板&gt;双向。</p>
<p>稍后我们将介绍如何使用INetSim。</p>
<p><strong>Burpsuite</strong></p>
<p>INetSim对SSL支持相当有限：它提供了一个单一主机（inetsim.org）的证书，并且不支持即时生成SSL证书。这是一个问题，因为大多数恶意软件现在通过SSL加密他们的通信。我们将使用Burp作为透明的SSL代理，这将代表受害机器和INetSim进行SSL连接。如果您现在不需要拦截SSL流量，则不一定需要Burp</p>
<p>Burp支持为任何我们的受害者机器生成即时SSL证书，将连接到。它还创建单个根CA证书，我们稍后将在我们的受害者计算机中导入。这样我们就可以拦截恶意软件发送的加密通讯。</p>
<p>您可以从<a href="https://portswigger.net/burp/freedownload/" target="_blank" textvalue="官方网站">官方网站</a>下载Burpsuite。下载是一个bash安装脚本，运行它来安装Burp：</p>
<div>
<pre class="brush:html;toolbar:false">$&nbsp;bash〜/&nbsp;Downloads&nbsp;/&nbsp;burpsuite_free_linux_v1_7_23.sh</pre>
<p>默认情况下，Burp可执行文件将为 &nbsp;〜/ BurpSuiteFree / BurpSuiteFree。</p>
</div>
<p><span style="font-size: 20px;"><strong>3.建立隔离的虚拟网络</strong></span></p>
<p>作为提醒，我们希望建立一个包含三个虚拟机的隔离网络。该网络将无法访问Internet。此外，我们希望分析机器充当到受害机器的网络网关，以便轻松地拦截网络流量并模拟各种服务，如DNS或HTTP。</p>
<p>为了实现这一点，我们将使用VirtualBox内部网络。对于熟悉VirtualBox的用户，内部网络与主机网络不同，内部网络根本无法访问主机。</p>
<p>对于每个三个虚拟机，请执行以下操作：</p>
<p><strong>打开其设置</strong></p>
<p>· 转到网络部分</p>
<p>· 将“附加到”字段更改为“内部网络”</p>
<p>· 输入恶意软件分析网络作为网络名称</p>
<div style="text-align: center;"><img width="420" height="215" class="aligncenter size-full wp-image-5677" alt="" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="http://img.4hou.com/wp-content/uploads/2017/06/a5e59b7c3ad47096c548-1.png"/><noscript><img width="420" height="215" class="aligncenter size-full wp-image-5677" alt="" src="http://img.4hou.com/wp-content/uploads/2017/06/a5e59b7c3ad47096c548-1.png"/></noscript></div>
<p><strong>分析机</strong></p>
<p>打开分析计算机，打开终端并运行ifconfig命令。你应该有一个名为enp0s3的界面。如果名称不同，请按照说明进行调整。</p>
<p>以root身份打开/etc/network/nterfaces文件，最后添加以下内容：</p>
<div>
<pre class="brush:html;toolbar:false">auto&nbsp;enp0s3
&nbsp;iface&nbsp;enp0s3&nbsp;inet&nbsp;static
&nbsp;address&nbsp;10.0.0.1
&nbsp;netmask&nbsp;255.255.255.0</pre>
<p>这将在我们的虚拟网络上为机器分配静态IP10.0.0.1。现在我们已经配置了网络接口，我们需要启动它：</p>
</div>
<div>
<pre class="brush:html;toolbar:false">&nbsp;sudo&nbsp;ifup&nbsp;enp0s3</pre>
<p><strong>Ubuntu的受害机器</strong></p>
</div>
<p>该过程在这里非常相似，除了我们将它分配给静态IP10.0.0.2，并指示它使用10.0.0.1作为网关和DNS服务器。在文件/etc/network/interfaces的末尾附加以下内容：</p>
<div>
<pre class="brush:html;toolbar:false">auto&nbsp;enp0s3&nbsp;
&nbsp;iface&nbsp;enp0s3&nbsp;inet&nbsp;static&nbsp;
&nbsp;address&nbsp;10.0.0.2&nbsp;
&nbsp;gateway&nbsp;10.0.0.1&nbsp;
&nbsp;netmask&nbsp;255.255.255.0&nbsp;
&nbsp;dns-nameservers&nbsp;10.0.0.1</pre>
<p>并运行：</p>
</div>
<div>
<pre class="brush:html;toolbar:false">$&nbsp;sudo&nbsp;ifup&nbsp;enp0s3
&nbsp;&nbsp;$&nbsp;sudo&nbsp;service&nbsp;networking&nbsp;restart</pre>
<p>您现在应该可以ping分析机：</p>
</div>
<div>
<pre class="brush:html;toolbar:false">$&nbsp;ping&nbsp;10.0.0.1
PING&nbsp;10.0.0.1&nbsp;(10.0.0.1)&nbsp;56(84)&nbsp;bytes&nbsp;of&nbsp;data.
64&nbsp;bytes&nbsp;from&nbsp;10.0.0.1:&nbsp;icmp_seq=1&nbsp;ttl=64&nbsp;time=0.480&nbsp;ms
64&nbsp;bytes&nbsp;from&nbsp;10.0.0.1:&nbsp;icmp_seq=2&nbsp;ttl=64&nbsp;time=0.526&nbsp;ms</pre>
<p><strong>Windows 7受害机器</strong></p>
</div>
<p>右键单击任务栏中的网络图标（或转到开始菜单&gt;控制面板&gt;网络和Internet&gt;网络和共享中心），单击本地连接2&gt;属性，在Internet协议版本4上选择，然后单击属性按钮。</p>
<p>&nbsp;我们将静态IP10.0.0.3分配给机器，其他的配置跟ubnutu受害机类似。</p>
<div style="text-align: center;"><img width="411" height="457" class="aligncenter size-full wp-image-5679" alt="" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="http://img.4hou.com/wp-content/uploads/2017/06/ceb6b3ae2ecdcb15f6da-1.png"/><noscript><img width="411" height="457" class="aligncenter size-full wp-image-5679" alt="" src="http://img.4hou.com/wp-content/uploads/2017/06/ceb6b3ae2ecdcb15f6da-1.png"/></noscript></div>
<p>确保验证设置（单击 &nbsp;确定，应用等，直到所有设置窗口都消失）。您现在应该可以ping分析机：</p>
<div>
<pre class="brush:html;toolbar:false">ping&nbsp;10.0.0.1
&nbsp;&nbsp;&nbsp;Pinging&nbsp;10.0.0.1&nbsp;with&nbsp;32&nbsp;bytes&nbsp;of&nbsp;data:
&nbsp;&nbsp;&nbsp;Reply&nbsp;from&nbsp;10.0.0.1:&nbsp;bytes=32&nbsp;time&lt;1ms&nbsp;TTL=64
&nbsp;&nbsp;&nbsp;Reply&nbsp;from&nbsp;10.0.0.1:&nbsp;bytes=32&nbsp;time&lt;1ms&nbsp;TTL=64</pre>
<p>完成设置</p>
</div>
<p><span style="font-size: 20px;"><strong>4.创建和恢复快照</strong></span></p>
<p>现在我们的受害者虚拟机已正确配置并处于干净状态（即未被任何恶意软件感染），我们将对其当前状态进行快照。这样，我们就可以在任何时候轻松地将它们重置到这个干净的状态。</p>
<p>VirtualBox非常简单：在虚拟机运行的窗口中，只需选择“ 机器”&gt;“拍摄快照”。 您可以将快照命名为 &nbsp;Clean状态。 确保做到这一点的都你的Ubuntu和Windows 7受感染计算机。分析机器也不会伤害它。</p>
<p>当您想要将机器重置为干净状态时，只需将其关闭，并选中复选“ &nbsp;当前快照”清除状态。</p>
<div style="text-align: center;"><img width="386" height="226" class="aligncenter size-full wp-image-5681" alt="" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="http://img.4hou.com/wp-content/uploads/2017/06/954975bcf75087073de6.png"/><noscript><img width="386" height="226" class="aligncenter size-full wp-image-5681" alt="" src="http://img.4hou.com/wp-content/uploads/2017/06/954975bcf75087073de6.png"/></noscript></div>
<p><strong style="font-size: 20px;">5.在分析机上使用INetSim和Burp分析网络流量</strong></p>
<p><strong>INetSim</strong></p>
<p>如前所述，INetSim使我们能够提供范围广泛的标准互联网服务，包括DNS，HTTP（S），SMTP等。它有一个默认的配置文件 &nbsp;/etc/inetsim/inetsim.conf，这是非常有说明力的。它还附带一个包含各种默认文件的数据目录（/ var / lib / inetsim）。</p>
<p>由于您每次进行新的分析时可能需要一个不同的INetSim配置，因此建议您创建一个目录 &quot;analysis &quot;，该&quot;analysis &quot;将包含每个分析的子目录。</p>
<div>
<pre class="brush:html;toolbar:false">$&nbsp;mkdir&nbsp;analysis</pre>
<p>为了举例，我们已经创建了一个子目录，并在其中复制默认的INetSim配置文件和数据文件夹。</p>
</div>
<div>
<pre class="brush:html;toolbar:false">$&nbsp;mkdir&nbsp;analysis/test-analysis
$&nbsp;cp&nbsp;/etc/inetsim/inetsim.conf&nbsp;analysis/test-analysis
$&nbsp;sudo&nbsp;cp&nbsp;-r&nbsp;/var/lib/inetsim&nbsp;analysis/test-analysis/data
$&nbsp;sudo&nbsp;chmod&nbsp;-R&nbsp;777&nbsp;data
$&nbsp;cd&nbsp;analysis/test-analysis</pre>
</div>
<p>缺省情况下，INetSim只侦听本地接口。要用于虚拟网络的所有计算机，请替换刚刚复制的配置文件中的以下行：</p>
<div>
<pre class="brush:html;toolbar:false">#service_bind_address&nbsp;10.0.0.1</pre>
<p>通过：</p>
</div>
<div>
<pre class="brush:html;toolbar:false">service_bind_address&nbsp;0.0.0.0</pre>
<p>现在，我们需要禁用systemd-resolved，这是一个本地DNS服务器，默认情况下随Ubuntu一起提供，并且会与INetSim的DNS服务器冲突。</p>
</div>
<div>
<pre class="brush:html;toolbar:false">$&nbsp;sudo&nbsp;systemctl&nbsp;disable&nbsp;systemd-resolved.service&nbsp;
$&nbsp;sudo&nbsp;service&nbsp;systemd-resolved.service&nbsp;stop</pre>
<p>默认情况下，INetSim的DNS服务器将所有域名解析为127.0.0.1。我们希望任何域名解析为10.0.0.1（分析机器IP）; 取消注释以下行：</p>
</div>
<div>
<pre class="brush:html;toolbar:false">#dns_default_ip&nbsp;10.0.0.1</pre>
<p>我之前提到，INetSim的SSL支持不是最佳的，因为它只有单个主机名（inetsim.org）的单一证书，并且不允许即时生成每个主机证书。为了克服这个问题，我们将在端口443上运行Burp作为INetSim前面的透明代理。因此，我们需要将INetSim的HTTPS服务器绑定到其他端口，例如端口8443.替换以下行：</p>
</div>
<div>
<pre class="brush:html;toolbar:false">#https_bind_port&nbsp;443</pre>
<p>通过：</p>
</div>
<div>
<pre class="brush:html;toolbar:false">https_bind_port&nbsp;8443</pre>
<p>现在，我们来运行INetSim！</p>
</div>
<div>
<pre class="brush:html;toolbar:false">$&nbsp;sudo&nbsp;inetsim&nbsp;--data&nbsp;data&nbsp;--conf&nbsp;inetsim.confINetSim&nbsp;1.2.6&nbsp;(2016-08-29)&nbsp;by&nbsp;Matthias&nbsp;Eckert&nbsp;&amp;&nbsp;Thomas&nbsp;Hungenberg
[...]
===&nbsp;INetSim&nbsp;main&nbsp;process&nbsp;started&nbsp;(PID&nbsp;3605)&nbsp;===
Session&nbsp;ID:&nbsp;3605
Listening&nbsp;on:&nbsp;0.0.0.0
Real&nbsp;Date/Time:&nbsp;2017-06-04&nbsp;12:58:07
Fake&nbsp;Date/Time:&nbsp;2017-06-04&nbsp;12:58:07&nbsp;(Delta:&nbsp;0&nbsp;seconds)
&nbsp;Forking&nbsp;services...
&nbsp;*&nbsp;dns_53_tcp_udp&nbsp;-&nbsp;started&nbsp;(PID&nbsp;3621)
&nbsp;*&nbsp;irc_6667_tcp&nbsp;-&nbsp;started&nbsp;(PID&nbsp;3631)
&nbsp;*&nbsp;daytime_13_tcp&nbsp;-&nbsp;started&nbsp;(PID&nbsp;3638)
&nbsp;*&nbsp;discard_9_tcp&nbsp;-&nbsp;started&nbsp;(PID&nbsp;3642)
&nbsp;*&nbsp;discard_9_udp&nbsp;-&nbsp;started&nbsp;(PID&nbsp;3643)
&nbsp;*&nbsp;ident_113_tcp&nbsp;-&nbsp;started&nbsp;(PID&nbsp;3634)
&nbsp;*&nbsp;syslog_514_udp&nbsp;-&nbsp;started&nbsp;(PID&nbsp;3635)
[...]</pre>
<p>如您所见，INetSim已经推出了一系列网络服务。这些都是可配置的，可以在配置文件中禁用。这个配置文件有很好的记录，并解释了INetSim的所有选项; 我建议你花几分钟阅读。</p>
</div>
<p>现在，您的受害者VM打开电源，打开Web浏览器，并浏览到任何地址（例如github.com）。您应该看到以下内容：</p>
<div>
<p style="text-align:center"><img width="700" height="559" title="" class="aligncenter size-full wp-image-5684" style="width: 700px; height: 559px;" alt="" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="http://img.4hou.com/wp-content/uploads/2017/06/7cc44fea6e3d13bb601f-1.png" border="0" vspace="0"/><noscript><img width="700" height="559" title="" class="aligncenter size-full wp-image-5684" style="width: 700px; height: 559px;" alt="" src="http://img.4hou.com/wp-content/uploads/2017/06/7cc44fea6e3d13bb601f-1.png" border="0" vspace="0"/></noscript></p>
</div>
<p>（请注意，此默认文件对应于HTML文件数据/ http / fakefiles / sample.html。）</p>
<p>回到分析机上，关闭INetSim（CTRL + C）。</p>
<div>
<pre class="brush:html;toolbar:false">*&nbsp;dns_53_tcp_udp&nbsp;-&nbsp;stopped&nbsp;(PID&nbsp;3621)
*&nbsp;irc_6667_tcp&nbsp;-&nbsp;stopped&nbsp;(PID&nbsp;3631)
*&nbsp;daytime_13_tcp&nbsp;-&nbsp;stopped&nbsp;(PID&nbsp;3638)
[...]
Simulation&nbsp;stopped.
&nbsp;Report&nbsp;written&nbsp;to&nbsp;&#39;/var/log/inetsim/report/report.3877.txt&#39;&nbsp;(24&nbsp;lines)</pre>
<p>如您所见，INetSim已经为我们创建了一个总结报告。它包含我们受害机器与INetSim服务的所有互动。</p>
</div>
<div>
<pre class="brush:html;toolbar:false">===&nbsp;Report&nbsp;for&nbsp;session&nbsp;&#39;3877&#39;&nbsp;===
Real&nbsp;start&nbsp;date&nbsp;:&nbsp;2017-06-04&nbsp;13:18:27
Simulated&nbsp;start&nbsp;date&nbsp;:&nbsp;2017-06-04&nbsp;13:18:27
Time&nbsp;difference&nbsp;on&nbsp;startup&nbsp;:&nbsp;none
2017-06-04&nbsp;13:18:38&nbsp;First&nbsp;simulated&nbsp;date&nbsp;in&nbsp;log&nbsp;file
2017-06-04&nbsp;13:18:40&nbsp;DNS&nbsp;connection,&nbsp;type:&nbsp;A,&nbsp;class:&nbsp;IN,&nbsp;requested&nbsp;name:&nbsp;github.com
2017-06-04&nbsp;13:18:40&nbsp;HTTP&nbsp;connection,&nbsp;method:&nbsp;GET,&nbsp;URL:&nbsp;http://github.com/,&nbsp;file&nbsp;name:&nbsp;data/http/fakefiles/sample.html
2017-06-04&nbsp;13:18:40&nbsp;HTTP&nbsp;connection,&nbsp;method:&nbsp;GET,&nbsp;URL:&nbsp;http://github.com/favicon.ico,&nbsp;file&nbsp;name:&nbsp;data/http/fakefiles/sample.html
2017-06-04&nbsp;13:18:40&nbsp;Last&nbsp;simulated&nbsp;date&nbsp;in&nbsp;log&nbsp;file</pre>
<p><strong>窃取SSL拦截</strong></p>
</div>
<p>为了能够分析SSL流量，我们还需要运行Burp。我们将作为INetSim前面的透明代理运行它。当受害者机器将启动SSL连接时，它将首先进入Burp，然后将其委托给INetSim。此部分不是强制性的：如果您现在不需要拦截SSL流量，请跳到下一部分。</p>
<p>以下是Burp在中间的样子：</p>
<div style="text-align: center;"><img width="711" height="281" class="aligncenter size-full wp-image-5686" alt="" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="http://img.4hou.com/wp-content/uploads/2017/06/c89d1650b32b8a7afd35-1.png"/><noscript><img width="711" height="281" class="aligncenter size-full wp-image-5686" alt="" src="http://img.4hou.com/wp-content/uploads/2017/06/c89d1650b32b8a7afd35-1.png"/></noscript></div>
<p>以root身份启动Burp：</p>
<div>
<pre class="brush:html;toolbar:false">$&nbsp;sudo&nbsp;/home/osboxes/BurpSuiteFree/BurpSuiteFree</pre>
<p>（我们需要以root身份运行，否则将无法绑定端口443，这是一个特权端口，还有其他方法可以做到这一点，但是我们不用在这里）</p>
</div>
<p>创建一个临时项目（您还没有任何其他选项与免费版本），然后转到 &nbsp;代理选项卡，然后到 &nbsp;选项子选项卡。您将看到Burp的默认侦听器侦听端口8080。</p>
<p>单击与默认侦听器相对应的行，然后编辑它（编辑）按钮。配置如下：</p>
<p><strong>· </strong>绑定选项卡</p>
<p>绑定到港口：443</p>
<p>绑定地址：所有接口</p>
<p><strong>· </strong>请求处理选项卡：</p>
<p>重定向到主机：localhost</p>
<p>重定向到端口：8443</p>
<p>检查 支持隐形代理</p>
<p>验证设置，你应该得到一个类似于：</p>
<div style="text-align: center;"><img width="549" height="148" class="aligncenter size-full wp-image-5688" alt="" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="http://img.4hou.com/wp-content/uploads/2017/06/92aba3ee89c084c80b88-1.png"/><noscript><img width="549" height="148" class="aligncenter size-full wp-image-5688" alt="" src="http://img.4hou.com/wp-content/uploads/2017/06/92aba3ee89c084c80b88-1.png"/></noscript></div>
<p>默认情况下，Burp拦截传入的请求，并等待您明确地让它们通过。为了避免这种情况，请转到“截取”选项卡，然后单击“截取”按钮以禁用它。</p>
<p>由于Burp Free不允许您保存项目，因此您可以导出我们刚刚创建的设置，以便在下次启动Burp时导入它们。为此，请使用Burp&gt; Project选项&gt;保存项目选项。</p>
<p>让我们确保我们的设置正确工作。启动INetSim，并运行：</p>
<div>
<pre class="brush:html;toolbar:false">$&nbsp;curl&nbsp;--insecure&nbsp;https//localhost</pre>
<p>你应该得到：</p>
</div>
<div>
<pre class="brush:html;toolbar:false">&lt;html&gt;
&nbsp;&lt;head&gt;
&nbsp;&lt;title&gt;INetSim&nbsp;default&nbsp;HTML&nbsp;page&lt;/title&gt;
&nbsp;&lt;/head&gt;
&nbsp;&lt;body&gt;
&nbsp;&lt;p&gt;&lt;/p&gt;
&nbsp;&lt;p&nbsp;align=&quot;center&quot;&gt;This&nbsp;is&nbsp;the&nbsp;default&nbsp;HTML&nbsp;page&nbsp;for&nbsp;INetSim&nbsp;HTTP&nbsp;server&nbsp;fake&nbsp;mode.&lt;/p&gt;
&nbsp;&lt;p&nbsp;align=&quot;center&quot;&gt;This&nbsp;file&nbsp;is&nbsp;an&nbsp;HTML&nbsp;document.&lt;/p&gt;
&nbsp;&lt;/body&gt;
&lt;/html&gt;</pre>
<p>在我们的受害者机器上导入Burp的CA证书</p>
</div>
<p>打开Windows 7受影响的计算机电源，并尝试浏览到HTTPS URL（例如<a href="https://github.com），您会看到类似于以下内容的警告：" _src="https://github.com），您会看到类似于以下内容的警告：">https://github.com），您会看到类似于以下内容的警告：</a></p>
<div style="text-align: center;"><img width="764" height="230" class="aligncenter size-full wp-image-5689" alt="" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="http://img.4hou.com/wp-content/uploads/2017/06/f54f1e328238ecfd376e.png"/><noscript><img width="764" height="230" class="aligncenter size-full wp-image-5689" alt="" src="http://img.4hou.com/wp-content/uploads/2017/06/f54f1e328238ecfd376e.png"/></noscript></div>
<p>这是因为Burp生成由其自己的CA证书签署的SSL证书，我们的受害者机器现在不信任。</p>
<p>在Burp中，在端口8080上添加新的代理监听器，监听所有接口（选项卡 &nbsp;代理&gt;选项&gt;按钮 &nbsp;添加）：</p>
<div style="text-align: center;"><img width="488" height="215" class="aligncenter size-full wp-image-5690" alt="" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="http://img.4hou.com/wp-content/uploads/2017/06/6885c2881e969cf8869f.png"/><noscript><img width="488" height="215" class="aligncenter size-full wp-image-5690" alt="" src="http://img.4hou.com/wp-content/uploads/2017/06/6885c2881e969cf8869f.png"/></noscript></div>
<p>然后，从受害机器，浏览到 &nbsp;<a href="http://10.0.0.1:8080。" _src="http://10.0.0.1:8080。">http://10.0.0.1:8080。</a></p>
<div>
<p style="text-align:center"><img width="700" height="142" title="" class="aligncenter size-full wp-image-5691" style="width: 700px; height: 142px;" alt="" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="http://img.4hou.com/wp-content/uploads/2017/06/97c4d2ffcf88e08f2899.png" border="0" vspace="0"/><noscript><img width="700" height="142" title="" class="aligncenter size-full wp-image-5691" style="width: 700px; height: 142px;" alt="" src="http://img.4hou.com/wp-content/uploads/2017/06/97c4d2ffcf88e08f2899.png" border="0" vspace="0"/></noscript></p>
</div>
<p>点击CA证书的右上角下载打嗝的CA证书。</p>
<p>在Windows 7受影响的计算机上：打开文件，单击 &nbsp;安装证书&gt; 下一步&gt;将所有证书放在以下存储中：受信任的根证书颁发机构 &gt;下一步</p>
<p>在Ubuntu的受害机器上：</p>
<p>将证书转换为适当的格式（.crt）</p>
<div>
<pre class="brush:html;toolbar:false">&nbsp;$&nbsp;openssl&nbsp;x509&nbsp;-in〜/&nbsp;Downloads&nbsp;/&nbsp;cacert.der&nbsp;-inform&nbsp;DER&nbsp;-out&nbsp;burp.cr</pre>
</div>
<p>复制到/ usr / local / share / ca-certificates</p>
<div></div>
<div>
<pre class="brush:html;toolbar:false">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$&nbsp;sudo&nbsp;cp&nbsp;burp.crt&nbsp;/&nbsp;usr&nbsp;/&nbsp;local&nbsp;/&nbsp;share&nbsp;/&nbsp;ca-certificates&nbsp;/
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$&nbsp;sudo&nbsp;update-ca-certificates</pre>
<p>默认情况下，Firefox不使用系统的证书存储。如果您希望SSL连接在Firefox中正常工作，请将Firefox设置转到“ 高级”&gt;“证书”&gt;“导入”。选择 burp.crt，检查 信任此CA以识别网站</p>
</div>
<p>可以了，好了！</p>
<div>
<p style="text-align:center"><img width="700" height="195" title="" class="aligncenter size-full wp-image-5692" style="width: 700px; height: 195px;" alt="" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="http://img.4hou.com/wp-content/uploads/2017/06/97c4d2ffcf88e08f2899-1.png" border="0" vspace="0"/><noscript><img width="700" height="195" title="" class="aligncenter size-full wp-image-5692" style="width: 700px; height: 195px;" alt="" src="http://img.4hou.com/wp-content/uploads/2017/06/97c4d2ffcf88e08f2899-1.png" border="0" vspace="0"/></noscript></p>
</div>
<p>在受影响的计算机中导入Burp的CA证书后，请确保创建新的快照（例如，安装了Burp的CA证书的Clean状态）。</p>
<p><span style="font-size: 20px;"><strong>6.在分析计算机和主机操作系统之间设置共享文件夹</strong></span></p>
<p>在某些时候，您显然会将一些文件传输到分析机器或受害机器之一; 我们将设置一个文件共享来实现它。</p>
<p>在运行分析计算机的VirtualBox中，转到 &nbsp;设备&gt;共享文件夹&gt;共享文件夹设置。创建一个新的共享文件夹，选择要映射到的主机操作系统的本地文件夹，然后选择一个名称。选中该复选框以使其成为永久性。</p>
<div style="text-align: center;"><img width="488" height="267" class="aligncenter size-full wp-image-5693" alt="" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="http://img.4hou.com/wp-content/uploads/2017/06/691f036a95e3a50bd336.png"/><noscript><img width="488" height="267" class="aligncenter size-full wp-image-5693" alt="" src="http://img.4hou.com/wp-content/uploads/2017/06/691f036a95e3a50bd336.png"/></noscript></div>
<p>现在在分析机上安装共享文件夹：</p>
<div>
<pre class="brush:html;toolbar:false">&nbsp;$&nbsp;mkdir〜/&nbsp;malware-analysis-share
&nbsp;$&nbsp;sudo&nbsp;mount&nbsp;-t&nbsp;vboxsf&nbsp;-o&nbsp;uid&nbsp;=&nbsp;$&nbsp;UID，gid&nbsp;=&nbsp;$（id&nbsp;-g）malware-analysis-share〜/&nbsp;malware-analysis-share</pre>
</div>
<p>你很好去在我的情况下，位于/home/christophetd/malware-analysis-share中的我的主机的所有文件也将在分析机器中的〜/ malware-analysis-share中结束。</p>
<p><strong>将文件传输到受害计算机</strong></p>
<p>在某些时候，您最有可能需要将一些文件（例如恶意软件样本）传输到其中一个受害机器。为他们设置文件共享是一个坏主意，因为它意味着受害者机器（并且在一定程度上，您运行的恶意软件样本）可以访问它。</p>
<p>实现文件传输到Ubuntu受害者机器的最简单的方法是使用netcat。这是一个简单的例子。</p>
<div>
<pre class="brush:html;toolbar:false">#&nbsp;Receiving&nbsp;machine&nbsp;having&nbsp;IP&nbsp;10.0.0.2
$&nbsp;nc&nbsp;-lvp&nbsp;4444&nbsp;&gt;&nbsp;file.exe
#&nbsp;Analysis&nbsp;machine&nbsp;(sender)
$&nbsp;cat&nbsp;file_to_transfer.exe&nbsp;|&nbsp;nc&nbsp;10.0.0.2&nbsp;4444</pre>
<p>对于Window的受害者，我们遗憾的是没有netcat可用。可能存在替代方案，但是默认情况下它们可能不会运送。一个选择是使用INetSim将文件提供给受害机器。</p>
</div>
<div>
<pre class="brush:html;toolbar:false">#&nbsp;inetsim.conf
#&nbsp;Remove&nbsp;the&nbsp;default&nbsp;line:&nbsp;http_fakefile&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exe&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sample_gui.exe&nbsp;&nbsp;x-msdos-program
#&nbsp;Replace&nbsp;it&nbsp;by
http_fakefile&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exe&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;file_to_transfer.exe&nbsp;&nbsp;x-msdos-program
#&nbsp;And&nbsp;put&nbsp;file_to_transfer.exe&nbsp;in&nbsp;./data/http/fakefiles</pre>
<p>使用此配置，只需浏览以“.exe”结尾的任何URL（例如<a href="http://github.com/file.exe）。" _src="http://github.com/file.exe）。">http://github.com/file.exe）。</a></p>
</div>
<div>
<p style="text-align:center"><img width="700" height="40" title="" class="aligncenter size-full wp-image-5694" style="width: 700px; height: 40px;" alt="" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="http://img.4hou.com/wp-content/uploads/2017/06/764959cc81afda1d2249.png" border="0" vspace="0"/><noscript><img width="700" height="40" title="" class="aligncenter size-full wp-image-5694" style="width: 700px; height: 40px;" alt="" src="http://img.4hou.com/wp-content/uploads/2017/06/764959cc81afda1d2249.png" border="0" vspace="0"/></noscript></p>
</div>
<p><strong style="font-size: 20px;">7.演示时间：TeslaCrypt ransomware</strong></p>
<p>时间快速演示！我下载了勒索软件样本<a href="https://en.wikipedia.org/wiki/TeslaCrypt">TeslaCrypt</a>，它传递给我们的Windows 7受害机器，并执行它。几秒钟后，虚拟机的所有文件都已加密，弹出如下窗口。</p>
<p style="text-align: center;"><img width="700" height="559" title="" class="aligncenter size-full wp-image-5697" style="text-align: center; width: 700px; height: 559px;" alt="" src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="http://img.4hou.com/wp-content/uploads/2017/06/c15f016b9913f08cf138.png" border="0" vspace="0"/><noscript><img width="700" height="559" title="" class="aligncenter size-full wp-image-5697" style="text-align: center; width: 700px; height: 559px;" alt="" src="http://img.4hou.com/wp-content/uploads/2017/06/c15f016b9913f08cf138.png" border="0" vspace="0"/></noscript></p>
<p>检查INetSim的日志后，我们可以看到ransomware进行了以下DNS查找：</p>
<ul class=" list-paddingleft-2">
<li>
<p>7tno4hib47vlep5o.tor2web.org</p>
</li>
<li>
<p>7tno4hib47vlep5o.tor2web.blutmagie.de</p>
</li>
<li>
<p>7tno4hib47vlep5o.tor2web.fi</p>
</li>
<li>
<p>bitcoin.toshi.io</p>
</li>
</ul>
<p>并向这些域发送了多个HTTP请求。</p>
<div>
<pre class="brush:html;toolbar:false">HTTPS&nbsp;connection,&nbsp;method:&nbsp;GET,&nbsp;URL:&nbsp;https://7tno4hib47vlep5o.tor2web.org/state.php?U3ViamVjdD1QaW5nJmtleT0xNUIzOEIxOEFGMjBDMERCMkE3Qzc3MUUwMTQzNjNGMkNCODc4MUIxNTZENTE5Q0M1RjIyMDMzNUQ0NzE0QUEzJmFkZHI9MUxOVUYzQnFMM29iMUNUMmFWcDNjVzROYjh6a2tWaVZ3VCZmaWxlcz0wJnNpemU9MCZ2ZXJzaW9uPTAuMi42YSZkYXRlPTE0OTY2NDg2NzUmT1M9NzYwMSZJRD0xNiZzdWJpZD0wJmdhdGU9RzA=
HTTPS&nbsp;connection,&nbsp;method:&nbsp;GET,&nbsp;URL:&nbsp;https://7tno4hib47vlep5o.tor2web.blutmagie.de/state.php?U3ViamVjdD1QaW5nJmtleT0xNUIzOEIxOEFGMjBDMERCMkE3Qzc3MUUwMTQzNjNGMkNCODc4MUIxNTZENTE5Q0M1RjIyMDMzNUQ0NzE0QUEzJmFkZHI9MUxOVUYzQnFMM29iMUNUMmFWcDNjVzROYjh6a2tWaVZ3VCZmaWxlcz0wJnNpemU9MCZ2ZXJzaW9uPTAuMi42YSZkYXRlPTE0OTY2NDg2NzUmT1M9NzYwMSZJRD0xNiZzdWJpZD0wJmdhdGU9RzE=
HTTPS&nbsp;connection,&nbsp;method:&nbsp;GET,&nbsp;URL:&nbsp;https://7tno4hib47vlep5o.tor2web.fi/state.php?U3ViamVjdD1QaW5nJmtleT0xNUIzOEIxOEFGMjBDMERCMkE3Qzc3MUUwMTQzNjNGMkNCODc4MUIxNTZENTE5Q0M1RjIyMDMzNUQ0NzE0QUEzJmFkZHI9MUxOVUYzQnFMM29iMUNUMmFWcDNjVzROYjh6a2tWaVZ3VCZmaWxlcz0wJnNpemU9MCZ2ZXJzaW9uPTAuMi42YSZkYXRlPTE0OTY2NDg2NzUmT1M9NzYwMSZJRD0xNiZzdWJpZD0wJmdhdGU9RzI=
HTTPS&nbsp;connection,&nbsp;method:&nbsp;GET,&nbsp;URL:&nbsp;
https://bitcoin.toshi.io/api/v0/addresses/1LNUF3BqL3ob1CT2aVp3cW4Nb8zkkViVwT</pre>
<p>我们看到类似的请求是tor2web.org ，tor2web.blutmagie.de和tor2web.fi。这些服务允许访问Tor网络，而无需安装Tor浏览器或类似的工具。</p>
</div>
<p>恶意软件联系到Tor隐藏服务 &nbsp;7tno4hib47vlep5o.onion，这可能是某种<a href="https://en.wikipedia.org/wiki/Command_and_control_(malware)">C＆C服务器</a>。请求的有效内容是一个base64编码的字符串，解码为：</p>
<div>
<pre class="brush:html;toolbar:false">Subject=Ping
&amp;key=15B38B18AF20C0DB2A7C771E014363F2CB8781B156D519CC5F220335D4714AA3
&amp;addr=1LNUF3BqL3ob1CT2aVp3cW4Nb8zkkViVwT
&amp;files=0
&amp;size=0
&amp;version=0.2.6a
&amp;date=1496648675
&amp;OS=7601
&amp;ID=16
&amp;subid=0
&amp;gate=G1</pre>
<p>它也对bitcoin.toshio.io（不再存在）进行API调用 &nbsp;，最有可能检查赎金是否已经支付给比特币地址 1LNUF3BqL3ob1CT2aVp3cW4Nb8zkkViVwT。似乎恶意软件为每个受感染的计算机生成唯一的比特币地址，因为地址<a href="https://blockchain.info/address/1LNUF3BqL3ob1CT2aVp3cW4Nb8zkkViVwT" target="_blank" textvalue="没有收到或发送">没有收到或发送</a>任何钱。</p>
</div>
<p><span style="font-size: 20px;"><strong>结论</strong></span></p>
<p>希望本指南将有所帮助。有有一些恶意软件会检测虚拟机行为(例如什么都不做)。<a href="https://blog.malwarebytes.com/threat-analysis/2014/02/a-look-at-malware-with-virtual-machine-detection/" target="_blank" textvalue="这是MalwareBytes关于这个问题的一篇文章">这是MalwareBytes关于这个问题的一篇文章</a>。</p>
<p>另外，请记住，分析恶意软件的网络流量可能非常有用，只是一种动态分析。其他包括监控注册表，系统调用，打开/创建的文件等。Open Security Training提供<a href="http://opensecuritytraining.info/MalwareDynamicAnalysis.html" target="_blank" textvalue="了一个关于该主题的完整实践课程">了一个关于该主题的完整实践课程</a>，免费。</p>
                <div class="foot_description" style="background-color: #fff;">
                    如若转载，请注明原文地址：                        <a href="http://www.4hou.com/technology/5655.html" target=_blank>http://www.4hou.com/technology/5655.html</a>
                                    </div>


                 </p>
            </div>
            <div class="article_con">
                <!--文章内容-->
            </div>
            <div class="post-like">
                <a href="javascript:;" data-action="ding" target=_blank data-id="5655" class="favorite">
                <div class="zanbox">
                    <dd class="zanbefor"></dd>
                    <dd class="zanafter"></dd>
                </div>
                <span class="zantext">点赞</span>
                <span class="count">
            0</span>
                </a>
            </div>
            <div class="active_bottom">
                <ul>
                    <a class="Sina" href="http://service.weibo.com/share/share.php?url=http://www.4hou.com/technology/5655.html" title="分享到新浪微博" target="_blank"><li class="sinahover"></li></a>
                    <a onclick="window.open('http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url='+encodeURIComponent(document.location.href));return false;" title="分享到QQ空间" class="WeChat" href="javascript:void(0)" target="_blank"><li class="kj"></li></a>
                    <a onclick="dashangToggle()" class="friend" title="分享到微信、朋友圈等" target="_blank"><li class="wx"></li></a>

                </ul>
                <div class="strat icons"><span class='wpfp-span'><img src='http://img.4hou.com/wp-content/plugins/wp-favorite-posts/img/star.png' alt='Favorite' title='Favorite' class='wpfp-img' /><a class='wpfp-link' href='?wpfpaction=add&amp;postid=5655' title='收藏' rel='nofollow'>收藏</a></span></div>
                <div class="hide_box"></div>
                <div class="shang_box">
                    <a class="shang_close" href="javascript:void(0)" onClick="dashangToggle()" title="关闭"><img src="http://img.4hou.com/wp-content/themes/4houv2/images/close.jpg" alt="取消" /></a>
                    <img class="shang_logo" width="120px" src="http://img.4hou.com/wp-content/themes/4houv2/images/logo.png" alt="嘶吼" />
                    <div class="shang_tit">
                        <p>感谢您的支持，我会继续努力的!</p>
                    </div>
                    <div class="shang_payimg">
                        <img src="http://www.4hou.com/wp-content/themes/4houv2/qrcode.php?url=http%3A%2F%2Fwww.4hou.com%2Ftechnology%2F5655.html" alt="扫码支持" title="扫一扫" />
                    </div>

                    <div class="shang_info">
                        <p>打开<span id="shang_pay_txt">微信</span>扫一扫后点击右上角即可分享哟</p>
                    </div>
                </div>
            </div>
            
            <div class="avatarbottomwrap">
                 <div class="avatarboxleft">
                        <div class="avatarbottom">
                           
                            <a class="upload-img"><img alt='愣娃' src='http://img.4hou.com/wp-content/uploads/2017/06/5a19597ef5094d619012-96x96.jpg' class='avatar avatar-96 photo' height='96' width='96' /></a>
                        </div>
                        <h1 class="authornamebottom"><a href="http://www.4hou.com/member?Author=愣娃" class="upload-img" target=_blank>
                                愣娃                             </a></h1>
                        <p class="authorzybottom">这个人很懒，什么也没留下</p>

                        <div class="authorbottombox">
                            <!--<div class="gzbtn">关注</div>
                            <div class="sxbtn">私信</div>-->
                                                            <span class="gzbtn"  style="cursor: pointer;" onclick="location.href='/mybox?action=reply&to_user=愣娃&type=send'">发私信</span>
                                                    </div>
                 </div>
                <div class="authorother">
                 <a class="morearticle" href="http://www.4hou.com/member?Author=愣娃" class="upload-img" target=_blank>
                            <span class="swiper-pagination-bullet swiper-pagination-bullet-active"></span>
                            <span class="swiper-pagination-bullet swiper-pagination-bullet-active"></span>
                            <span class="swiper-pagination-bullet swiper-pagination-bullet-active"></span>
                             </a>
                    <div class="swiper-container">

                                                    <div class="swiper-wrapper">
                               
                                <div class="swiper-slide">
                                                                        <div><a href="http://www.4hou.com/penetration/7571.html" target=_blank>
                                            <img data-original="http://img.4hou.com/wp-content/uploads/2017/09/57f0c1f1f1169832651b.jpg?imageView2/1/w/140/h/104/format/png"  class="wp-post-image"width="140" height="104"  />                                        </a></div>
                                                                        <div><a href="http://www.4hou.com/technology/7329.html" target=_blank>
                                            <img data-original="http://img.4hou.com/wp-content/uploads/2017/09/2f2d6b46ff3769fa4117.jpg?imageView2/1/w/140/h/104/format/png"  class="wp-post-image"width="140" height="104"  />                                        </a></div>
                                                                        <div><a href="http://www.4hou.com/web/7465.html" target=_blank>
                                            <img data-original="http://img.4hou.com/wp-content/uploads/2017/08/020e2b378c1e7a3ce89c.jpg?imageView2/1/w/140/h/104/format/png"  class="wp-post-image"width="140" height="104"  />                                        </a></div>
                                                                        <div><a href="http://www.4hou.com/vulnerable/7315.html" target=_blank>
                                            <img data-original="http://img.4hou.com/wp-content/uploads/2017/08/3c044b1599611b690c4d.jpg?imageView2/1/w/140/h/104/format/png"  class="wp-post-image"width="140" height="104"  />                                        </a></div>
                                                                    </div>
                            </div>
                                        </div>
                </div>
                <script type="text/javascript">
                    function dashangToggle(){
                        $(".hide_box").fadeToggle();
                        $(".shang_box").fadeToggle();
                    }
                </script>
                <script> 
                    var mySwiper = new Swiper('.swiper-container', {
                        direction : 'vertical',
                        pagination : '.swiper-pagination',
                        paginationClickable :true,
                        spaceBetween : 20
                    })
                </script>
            </div>
                            <div class="review" style="margin-bottom:80px;">
    <h3 id="reply-title" class="comment-reply-title">发表评论 <small></h3>
    <form action="http://www.4hou.com/wp-comments-post.php" method="post" id="commentform">
        <p class="commentname"><label for="author">昵称</label>
            <input type="text" name="author" id="author" value="" size="14" tabindex="1" aria-required='true' placeholder = "请输入昵称" required />
        </p>
        <p class="commenteml">
            <label for="email">邮箱</label>
            <input type="text" name="email" id="email" value="" size="25" tabindex="2" aria-required='true' placeholder = "请输入邮箱地址" required />
        </p>
        <p class="comment-form-comment">
           <label for="comment">评论</label>
           <textarea id="comment" name="comment" cols="45" rows="8" maxlength="65525" aria-required="true" required="required"></textarea>
        </p>

        <p class="form-submit"><input name="submit" type="submit" id="submit" class="submit" value="发表评论" />
        <input type='hidden' name='comment_post_ID' value="5655" id='comment_post_ID' />
            <input type='hidden' name='comment_parent' id='comment_parent' value='0' />
        </p>
    </form>
					
<div class="new-review">
   <ol class="commentlist">
      </ol>
   <div class="hr clearfix">&nbsp;</div>
</div>
</div>             
        </article>

        <!--作者其他文章-->
        <aside class="article_authorbox">
          <div class="article_authorbox_top">
                <div class="article_author">
            <div class="article_author_avatar">
                 <a class="upload-img"><img alt='愣娃' src='http://img.4hou.com/wp-content/uploads/2017/06/5a19597ef5094d619012-96x96.jpg' class='avatar avatar-96 photo' height='96' width='96' /></a>
            </div>
            <h1 class="article_author_name"><a href="http://www.4hou.com/member?Author=愣娃" class="upload-img" target=_blank>
                    愣娃                </a></h1>
            <p class="article_author_type">这个人很懒，什么也没留下 </p>
            <div class="article_author_bottom">
                                        <span class="send-info" onclick="location.href='/mybox?action=reply&to_user=愣娃&type=send'">发私信</span>
                         
            </div>
          </div>  
            <div class="interested">
                <h1>可能喜欢</h1>
                                                    <li>
                    <i></i>
                    <a href="http://www.4hou.com/technology/7667.html" target="_blank">小心找工作时被挖坑，有人利用 LinkedIn 发送钓鱼链接</a> 
                </li> 
                                <li>
                    <i></i>
                    <a href="http://www.4hou.com/technology/7653.html" target="_blank">一次服务器被攻击的应急行动</a> 
                </li> 
                                <li>
                    <i></i>
                    <a href="http://www.4hou.com/info/news/7646.html" target="_blank">一个Tor浏览器0day漏洞价值100万美元，其中的隐情是……</a> 
                </li> 
                                <li>
                    <i></i>
                    <a href="http://www.4hou.com/info/news/7660.html" target="_blank">Elasticsearche僵尸网络：超过4000台服务器遭到两款POS 恶意软件感染</a> 
                </li> 
                                <li>
                    <i></i>
                    <a href="http://www.4hou.com/technology/7669.html" target="_blank">渗透挑战赛：从SQL注入到管理员权限</a> 
                </li> 
                                                </div>
       </div>

          
        </aside>
    </section>
    <div id="zooming">
        <img src="" id="imgcon">
    </div>
    <script>
        $(document).ready(function() {
            $.fn.postLike = function() {
                if ($(this).hasClass('done')) {
                    return false;
                } else {
                    $(this).addClass('done');
                    var id = $(this).data("id"),
                        action = $(this).data('action'),
                        rateHolder = $(this).children('.count');
                    var ajax_data = {
                        action: "bigfa_like",
                        um_id: id,
                        um_action: action
                    };
                    $.post("/wp-admin/admin-ajax.php", ajax_data,
                        function(data) {
                            $(rateHolder).html(data);
                        });
                    return false;
                }
            };
            $(document).on("click", ".favorite",
                function() {
                    $(this).postLike();
                });


            $("img").attr("title","");
            var altcon=$(".art_title").text();
            $("img").attr("alt",altcon);
            // 图片放大
            $(".article_cen").find('img').on("click",function(){
                var imgsrc=$(this).attr("src");
                var winthimg=$(this).width();
                var zooming=winthimg*1.2;
                $("#imgcon").css({width:zooming});
                $("#imgcon").css({marginLeft:-zooming/2});
                $("#imgcon").attr("src",imgsrc);
                $("#zooming").addClass("zoomaniatae");
                $("#imgcon").addClass("imgconadimate");
            });
            $("#zooming").on("click",function(){
                $("#imgcon").removeClass("imgconadimate");
                $("#zooming").removeClass("zoomaniatae");

            });

            $(window).scroll(function(){
                var scrtop=$(window).scrollTop();
                if(scrtop>450){
                    $(".article_authorbox_top").removeClass("asideanimateleave").addClass('asideanimate')
                    // $(".interested").hide()
                }
                else if(scrtop<450&&scrtop>350){
                     $(".article_authorbox_top").addClass("asideanimateleave").removeClass('asideanimate')
                     $(".interested").show()

                }
            });
            var start=$(".strat .wpfp-span .wpfp-link").text()
            if(start=="已收藏"){
                $(".strat").addClass("stratend")
            }else{
                $(".strat").removeClass("stratend")
            }

            $(".avatar-96").width(72);
            $(".avatar-96").height(72);
            $(".avatar-120").width(50);
            $(".avatar-120").height(50);

        });
    </script>
<style type="text/css">
.footer{height:auto; background-color: #282828}
.footer_about{width: 1200px;height: 50px;padding-top: 26px; margin: 0 auto;border-bottom-color: transparent !important; position: relative;}
.footer_about>a{font-size: 16px;height: 16px !important;line-height: 16px !important; float: left; padding-right: 18px; border-right:1px solid #ccc;}
.last-child-a{border:none !important}
.footer_bottom_cen p{ margin-top: 5px; margin-right: 25px;text-align: left; margin-bottom: 6px;float: left;}
.footer_bottom_cen>div{width: 450px;float: left;margin-right: 8px}
.footer_bottom{height: 74px}
.footerlogos{width: 130px; height: 24px; position: absolute;right: 10%; top:24px;}
.footerlogos dd{float: left; margin-right: 20px;cursor: pointer;}
.footerlogos dd a{display: block;width: 100%; height: 100%}
.wechartlogo{width: 20px; height: 20px; background-position:-227px 0px;}
.weibologo{width: 20px; height: 20px; background-position:-269px 0px;}
.zhihulogo{width: 20px; height: 20px; background-position:-361px 0px;}
.wechartlogo i{width: 80px;height: 78px;background-size: contain !important; right: 137px;display: none;opacity: 1;background: url(http://www.4hou.com/wp-content/themes/4houv2/img/wechatqr.png) no-repeat;position: absolute;top: -28px;}
.wechartlogo:hover i{display: block;}
.footer_bottom{width: 1200px; background-color: #282828; margin:0 auto } 
.footer_bottom_cen>div img{float: left; margin-right: 4px;margin-top: 4px; margin-left: 4px;width: 66px;}
.footer_bottom_cen{width: 100%}
.cloudserver{float: right !important; margin: 0 auto !important;width: 385px !important; margin-top: -31px}
.cloudserver img{float: left;}
.cloudserver dd{float: left;}
@media screen and (max-width:1260px) {
    .footer{width: 100%; padding: 0px 20px;}
    .footer_about{width: 100%}
    .footer_bottom{width: 100%}
    .footer_bottom div{width: 100%;display: none;}
}
@media screen and (max-width:660px) {
    .footer_about{padding-top: 14px; margin-bottom: 22px;}
    .footerlogos{display: none;}
    .footer_bottom{height: 44px;}

}
</style>
<footer class="footer">
    <div class="footer_about">
        <a href="/about" target=_blank>关于我们</a>
        <!--<a href="">加入我们</a>-->
        <a href="/submit" target=_blank>我要投稿</a>
        <a href="/service" target=_blank>广告及服务</a>
        <a href="/partner" target=_blank class="last-child-a">友情链接</a>
        <div class="footerlogos">
                <dd class="wechartlogo icons">
                  <i></i>
                </dd>
                <dd class="weibologo icons">
                 <a href="http://weibo.com/u/6069423878" target=_blank></a>
                </dd>
                <dd class="zhihulogo icons">
                    <a href="https://zhuanlan.zhihu.com/roartalk" target=_blank></a>
                    
                </dd>
        </div>
    </div>

    <section class="footer_bottom">
        <article class="footer_bottom_cen">
            <p>©2017 北京嘶吼文化传媒有限公司&nbsp;&nbsp;&nbsp;京ICP备16063439号</p>
            <p class="mobilefooter">©2017 北京嘶吼文化传媒有限公司&nbsp;&nbsp;|&nbsp;&nbsp;京ICP备16063439号</p>
            <div class="cloudserver">
                <span>本站由</span>
                <img src="http://img.4hou.com/wp-content/themes/4houv2/img/bdcloud.png">
                <img src="http://img.4hou.com/wp-content/themes/4houv2/img/bdcloud1.png">
                <img src="http://img.4hou.com/wp-content/themes/4houv2/img/ucloud.png">
                <span>提供云计算服务</span>
            </div>
        </article>
    </section>
    <section class="footer_top" style="display:none">
        <article class="footer_top_cen">
            <div class="homeqrcode">
                <dd class="icons"></dd>
                <div class="wb">
                    <a href="http://weibo.com/u/6069423878" target=_blank>
                    <i class="icons"></i>
                    <p>关注嘶吼传媒</p>
                    </a>
                </div>

                <div class="sh">
                    <a href="https://zhuanlan.zhihu.com/roartalk" target=_blank>
                    <i class="icons"></i>
                    <p>关注嘶吼</p>
                    </a>
                </div>
            </div>
            
            <h1>合作伙伴</h1>
            <div class="footer_friend">
                <a href="http://www.xinhuanet.com/talking/chinasafety/" target=_blank>新华网安全中国</a>
                <a href="http://jaq.alibaba.com/" target=_blank>阿里聚安全</a>
                <a href="http://www.seclover.com/" target=_blank>四叶草安全</a>
                <a href="https://sec.vip.com/" target=_blank>唯品会安全应急响应中心</a>
                <a href="https://www.duoyinsu.com/" target=_blank>安识科技</a>
                <a href="http://xianzhi.aliyun.com" target=_blank>云盾先知</a>
                <a href="http://www.ardsec.com/" target=_blank>兴华永恒</a>
                <a href="https://www.sobug.com/" target=_blank>SOBUG</a>
            </div>
        </article>
    </section>
    
</footer>
<aside class="side" >
    <div class="side_top icons "></div>
    <div class="iconbox">
        <div class="side_wechart icons iconhover">微信
            <dd></dd>
        </div>
        <a href="http://weibo.com/u/6069423878" target=_blank><div class="side_webo icons iconhover">微博</div></a>
        <a href="http://www.4hou.com/feed/" target=_blank><div class="side_rss icons iconhover">RSS</div></a>
        <a href="https://zhuanlan.zhihu.com/roartalk" target=_blank><div class="side_zh icons iconhover">知乎</div></a>
    </div>
    <div class="side_bottom icons"></div>
    
</aside>

<script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?ac201c14c3d2a4747423252be421e1bc";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>

<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-91554508-1', 'auto');
    ga('send', 'pageview');

</script>
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
</body>
</html>