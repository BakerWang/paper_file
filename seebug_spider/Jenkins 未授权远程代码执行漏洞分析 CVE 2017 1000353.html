<!DOCTYPE html>


<html xmlns:wb="http://open.weibo.com/wb">

<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta property="wb:webmaster" content="ccd3e79934f3322d"/>
  <title>Jenkins 未授权远程代码执行漏洞分析(CVE-2017-1000353)</title>
  <meta name="keywords" content="漏洞文档,漏洞分析,安全技术"/>
  <meta name="description" content=""/>

  <meta name="HandheldFriendly" content="True"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <link rel="shortcut icon" href="/static/images/favicon.ico">
  <link rel="stylesheet" type="text/css" href="/static/css/screen.css"/>
  <link rel="stylesheet" type="text/css" href="/static/css/font.css"/>
  <link rel="stylesheet"
        href="//libs.baidu.com/fontawesome/4.0.3/css/font-awesome.min.css">
  <link rel="stylesheet" type="text/css" href="/static/css/prism.css"/>
  <link rel="stylesheet" type="text/css" href="/static/css/monokai.css" media="screen"/>
  <link rel="stylesheet" type="text/css" href="/static/css/custom.css?t=20170821"/>
  <link rel="stylesheet" type="text/css" href="/static/css/print.css?t=20170821" media="print"/>
  <script>
    var _hmt = _hmt || [];
    (function () {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?ef67a70a7641da3b52452a05b3bbecae";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


</head>

<body class="home-template">
<div class="weixin-share-img" style="display: none">
  <img src="/static/images/weixin-share.png" alt="Paper"/>
</div>

<div id="wrapper" class="">

<div id="sidebar">
  <button type="button" class="hamburger is-closed" data-toggle="offcanvas">
    <span class="hamb-top"></span>
    <span class="hamb-middle"></span>
    <span class="hamb-bottom"></span>
  </button>
  <div id="sidebar-content" class="inner">
    <h2 class="blog-title"><a href="/">Paper</a></h2>
    <h3 class="blog-description">安全技术精粹</h3>

    <form id="search" action="/">
      <button type="submit" style="background: #13313f; border: #13313f; position: absolute; right: -4px; margin-top: -3px;">
        <i class="fa fa-search search-button" style="position: absolute;right:10px; margin-top:6px;" > </i>
      </button>
      <input id="search-field" name="keyword" value="" placeholder="Search"/>

    </form>
    <div class="overlay"></div>
    <div id="sidebar-links">
      <ul id="subscription-links">
        <li><a target="_blank" href="/rss/"><i class="fa fa-rss"></i>RSS 订阅</a>
        </li>
        <li><a href="https://www.seebug.org/contribute/paper"><i
            class="fa fa-envelope-o"></i>投稿</a></li>
      </ul>
      <ul id="navigation">
        <li class="nav-" role="presentation"><a href="/"><i
            class="fa fa-angle-right"></i>首页</a></li>
        
  <li class="nav-" role="presentation"><a href="/category/vul-analysis/"><i
      class="fa fa-angle-right"></i>漏洞分析</a></li>

  <li class="nav-" role="presentation"><a href="/category/tools/"><i
      class="fa fa-angle-right"></i>安全工具&amp;安全开发</a></li>

  <li class="nav-" role="presentation"><a href="/category/information/"><i
      class="fa fa-angle-right"></i>情报分析</a></li>

  <li class="nav-" role="presentation"><a href="/category/experience/"><i
      class="fa fa-angle-right"></i>经验心得</a></li>

  <li class="nav-" role="presentation"><a href="/category/web-security/"><i
      class="fa fa-angle-right"></i>Web安全</a></li>

  <li class="nav-" role="presentation"><a href="/category/bin-security/"><i
      class="fa fa-angle-right"></i>二进制安全</a></li>

  <li class="nav-" role="presentation"><a href="/category/mobile-security/"><i
      class="fa fa-angle-right"></i>移动安全</a></li>

  <li class="nav-" role="presentation"><a href="/category/paper-archive/"><i
      class="fa fa-angle-right"></i>纸篓</a></li>

  <li class="nav-" role="presentation"><a href="/category/prime/"><i
      class="fa fa-angle-right"></i>安全基础&amp;教学篇</a></li>


        <li class="nav-" role="presentation"><a href="/call-for-paper/"><i
            class="fa fa-angle-right"></i>如何投稿</a></li>
        <li class="nav-" role="presentation"><a href="https://paper.seebug.org/papers/"><i
            class="fa fa-angle-right"></i>归档文件</a></li>
      </ul>
      <ul id="sidebar-external">
      </ul>
    </div>

    <footer class="site-footer">
      <section class="copyright">Copyright @ 404 Team from Knownsec.</section>
    </footer>
  </div>
</div>

<main>
  <div class="main-inner">
    <section id="results"></section>
    
  <article class="">
    <header class="post-header">

      <h1 class="post-title">Jenkins 未授权远程代码执行漏洞分析(CVE-2017-1000353)</h1>

      <span class="post-print">
        <a href="javascript:window.print()">
        <i class="fa fa-print fa-2x" aria-hidden="true"></i>
        </a>
      </span>
      <section class="post-meta">
        <span class="post-time">
          <i class='fa fa-calendar'></i>
          <time datetime="2017-05-05" class="timeago">4 月，2 周 之前</time>
          <time datetime="2017-05-05" class="fulldate">五月 05, 2017</time>
        </span>
        
          <br>
          <i class='fa fa-tag'></i>
          
            <a href="/category/vul-analysis/">漏洞分析</a>
            
          
        








      </section>
    </header>

    <section class="post-content">
      <p><input type="hidden" class="Authorrss" value="Janes" name="https://3wapp.github.io/2017/05/05/Jenkins-%E6%9C%AA%E6%8E%88%E6%9D%83%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E-CVE-2017-1000353/"></p>
<p>作者：<a href="https://3wapp.github.io/2017/05/05/Jenkins-%E6%9C%AA%E6%8E%88%E6%9D%83%E8%BF%9C%E7%A8%8B%E4%BB%A3%E7%A0%81%E6%89%A7%E8%A1%8C%E6%BC%8F%E6%B4%9E-CVE-2017-1000353/"><strong>Janes</strong></a></p>
<h2>漏洞概要</h2>
<p>Jenkins 未授权远程代码执行漏洞, 允许攻击者将序列化的Java SignedObject对象传输给Jenkins CLI处理，反序列化ObjectInputStream作为Command对象，这将绕过基于黑名单的保护机制, 导致代码执行。</p>
<h2>漏洞触发执行流程</h2>
<p><a href="https://blogs.securiteam.com/index.php/archives/3171">SSD的报告</a>披露了完整的漏洞细节，作为才学JAVA的我来说，看完这份报告，依旧不清楚具体的执行流程，因此有了下文，梳理漏洞触发的具体执行流程。</p>
<p>触发jenkins反序列化导致代码执行的漏洞发生在使用HTTP协议实现双向通信通道的代码中，Jenkins利用此通道来接收命令。大致流程如下图:</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/05/jenkins.png-w331s" /></p>
<h3>如何建立双向Channel</h3>
<p>基于HTTP建立双向Channel的入口函数位于<code>jenkins-2.46.1/core/src/main/java/hudson/cli/CLIAction.java</code>文件中</p>
<div class="codehilite"><pre><span></span><span class="nd">@Extension</span> <span class="nd">@Symbol</span><span class="o">(</span><span class="s">&quot;cli&quot;</span><span class="o">)</span>
<span class="nd">@Restricted</span><span class="o">(</span><span class="n">NoExternalUse</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">CLIAction</span> <span class="kd">implements</span> <span class="n">UnprotectedRootAction</span><span class="o">,</span> <span class="n">StaplerProxy</span> <span class="o">{</span>

    <span class="kd">private</span> <span class="kd">transient</span> <span class="kd">final</span> <span class="n">Map</span><span class="o">&lt;</span><span class="n">UUID</span><span class="o">,</span><span class="n">FullDuplexHttpChannel</span><span class="o">&gt;</span> <span class="n">duplexChannels</span> <span class="o">=</span> <span class="k">new</span> <span class="n">HashMap</span><span class="o">&lt;</span><span class="n">UUID</span><span class="o">,</span> <span class="n">FullDuplexHttpChannel</span><span class="o">&gt;();</span>

     <span class="o">......</span>

    <span class="nd">@Override</span>
    <span class="kd">public</span> <span class="n">Object</span> <span class="nf">getTarget</span><span class="o">()</span> <span class="o">{</span>
        <span class="n">StaplerRequest</span> <span class="n">req</span> <span class="o">=</span> <span class="n">Stapler</span><span class="o">.</span><span class="na">getCurrentRequest</span><span class="o">();</span>
        <span class="k">if</span> <span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="na">getRestOfPath</span><span class="o">().</span><span class="na">length</span><span class="o">()==</span><span class="mi">0</span> <span class="o">&amp;&amp;</span> <span class="s">&quot;POST&quot;</span><span class="o">.</span><span class="na">equals</span><span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="na">getMethod</span><span class="o">()))</span> <span class="o">{</span>
            <span class="c1">// CLI connection request</span>
            <span class="k">throw</span> <span class="k">new</span> <span class="n">CliEndpointResponse</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
            <span class="k">return</span> <span class="k">this</span><span class="o">;</span>
        <span class="o">}</span>
    <span class="o">}</span>

    <span class="kd">private</span> <span class="kd">class</span> <span class="nc">CliEndpointResponse</span> <span class="kd">extends</span> <span class="n">HttpResponseException</span> <span class="o">{</span>
        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">generateResponse</span><span class="o">(</span><span class="n">StaplerRequest</span> <span class="n">req</span><span class="o">,</span> <span class="n">StaplerResponse</span> <span class="n">rsp</span><span class="o">,</span> <span class="n">Object</span> <span class="n">node</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ServletException</span> <span class="o">{</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="c1">// do not require any permission to establish a CLI connection</span>
                <span class="c1">// the actual authentication for the connecting Channel is done by CLICommand</span>

                <span class="n">UUID</span> <span class="n">uuid</span> <span class="o">=</span> <span class="n">UUID</span><span class="o">.</span><span class="na">fromString</span><span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="s">&quot;Session&quot;</span><span class="o">));</span>
                <span class="n">rsp</span><span class="o">.</span><span class="na">setHeader</span><span class="o">(</span><span class="s">&quot;Hudson-Duplex&quot;</span><span class="o">,</span><span class="s">&quot;&quot;</span><span class="o">);</span> <span class="c1">// set the header so that the client would know</span>

                <span class="n">FullDuplexHttpChannel</span> <span class="n">server</span><span class="o">;</span>
                <span class="k">if</span><span class="o">(</span><span class="n">req</span><span class="o">.</span><span class="na">getHeader</span><span class="o">(</span><span class="s">&quot;Side&quot;</span><span class="o">).</span><span class="na">equals</span><span class="o">(</span><span class="s">&quot;download&quot;</span><span class="o">))</span> <span class="o">{</span>
                    <span class="n">duplexChannels</span><span class="o">.</span><span class="na">put</span><span class="o">(</span><span class="n">uuid</span><span class="o">,</span><span class="n">server</span><span class="o">=</span><span class="k">new</span> <span class="n">FullDuplexHttpChannel</span><span class="o">(</span><span class="n">uuid</span><span class="o">,</span> <span class="o">!</span><span class="n">Jenkins</span><span class="o">.</span><span class="na">getActiveInstance</span><span class="o">().</span><span class="na">hasPermission</span><span class="o">(</span><span class="n">Jenkins</span><span class="o">.</span><span class="na">ADMINISTER</span><span class="o">))</span> <span class="o">{</span>
                        <span class="nd">@Override</span>
                        <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="n">Channel</span> <span class="n">channel</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">InterruptedException</span> <span class="o">{</span>
                            <span class="c1">// capture the identity given by the transport, since this can be useful for SecurityRealm.createCliAuthenticator()</span>
                            <span class="n">channel</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="n">CLICommand</span><span class="o">.</span><span class="na">TRANSPORT_AUTHENTICATION</span><span class="o">,</span> <span class="n">Jenkins</span><span class="o">.</span><span class="na">getAuthentication</span><span class="o">());</span>
                            <span class="n">channel</span><span class="o">.</span><span class="na">setProperty</span><span class="o">(</span><span class="n">CliEntryPoint</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">(),</span><span class="k">new</span> <span class="n">CliManagerImpl</span><span class="o">(</span><span class="n">channel</span><span class="o">));</span>
                        <span class="o">}</span>
                    <span class="o">});</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="n">server</span><span class="o">.</span><span class="na">download</span><span class="o">(</span><span class="n">req</span><span class="o">,</span><span class="n">rsp</span><span class="o">);</span>
                    <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
                        <span class="n">duplexChannels</span><span class="o">.</span><span class="na">remove</span><span class="o">(</span><span class="n">uuid</span><span class="o">);</span>
                    <span class="o">}</span>
                <span class="o">}</span> <span class="k">else</span> <span class="o">{</span>
                    <span class="n">duplexChannels</span><span class="o">.</span><span class="na">get</span><span class="o">(</span><span class="n">uuid</span><span class="o">).</span><span class="na">upload</span><span class="o">(</span><span class="n">req</span><span class="o">,</span><span class="n">rsp</span><span class="o">);</span>
                <span class="o">}</span>
            <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="n">InterruptedException</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">IOException</span><span class="o">(</span><span class="n">e</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>从上述代码可知，建立一对双向通道(download/upload), 需要发送两次POST请求，根据请求头Session字段的值uuid识别不同的双向通道，Side字段的值识别download或upload通道，请求发送的顺序是先发送download请求再发送upload请求，跟进<code>download</code>函数(<code>/Users/js/IdeaProjects/vulnhub/jenkins-2.46.1/core/src/main/java/hudson/model/FullDuplexHttpChannel.java</code>), 当服务器收到download请求时会阻塞请求，等待upload请求，收到upload请求后，新建Channel对象处理upload请求和返回响应，代码如下:</p>
<div class="codehilite"><pre><span></span> <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">download</span><span class="o">(</span><span class="n">StaplerRequest</span> <span class="n">req</span><span class="o">,</span> <span class="n">StaplerResponse</span> <span class="n">rsp</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>
            <span class="o">......</span>

        <span class="o">{</span><span class="c1">// wait until we have the other channel</span>
            <span class="kt">long</span> <span class="n">end</span> <span class="o">=</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()</span> <span class="o">+</span> <span class="n">CONNECTION_TIMEOUT</span><span class="o">;</span>
            <span class="k">while</span> <span class="o">(</span><span class="n">upload</span> <span class="o">==</span> <span class="kc">null</span> <span class="o">&amp;&amp;</span> <span class="n">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">()&lt;</span><span class="n">end</span><span class="o">)</span>
                <span class="n">wait</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span>

            <span class="k">if</span> <span class="o">(</span><span class="n">upload</span><span class="o">==</span><span class="kc">null</span><span class="o">)</span>
                <span class="k">throw</span> <span class="k">new</span> <span class="n">IOException</span><span class="o">(</span><span class="s">&quot;HTTP full-duplex channel timeout: &quot;</span><span class="o">+</span><span class="n">uuid</span><span class="o">);</span>
        <span class="o">}</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="n">channel</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Channel</span><span class="o">(</span><span class="s">&quot;HTTP full-duplex channel &quot;</span> <span class="o">+</span> <span class="n">uuid</span><span class="o">,</span>
                    <span class="n">Computer</span><span class="o">.</span><span class="na">threadPoolForRemoting</span><span class="o">,</span> <span class="n">Mode</span><span class="o">.</span><span class="na">BINARY</span><span class="o">,</span> <span class="n">upload</span><span class="o">,</span> <span class="n">out</span><span class="o">,</span> <span class="kc">null</span><span class="o">,</span> <span class="n">restricted</span><span class="o">);</span>
             <span class="o">......</span>
        <span class="o">}</span> <span class="k">finally</span> <span class="o">{</span>
            <span class="c1">// publish that we are done</span>
            <span class="n">completed</span><span class="o">=</span><span class="kc">true</span><span class="o">;</span>
            <span class="n">notify</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>

  <span class="kd">public</span> <span class="kd">synchronized</span> <span class="kt">void</span> <span class="nf">upload</span><span class="o">(</span><span class="n">StaplerRequest</span> <span class="n">req</span><span class="o">,</span> <span class="n">StaplerResponse</span> <span class="n">rsp</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">InterruptedException</span><span class="o">,</span> <span class="n">IOException</span> <span class="o">{</span>
        <span class="n">rsp</span><span class="o">.</span><span class="na">setStatus</span><span class="o">(</span><span class="n">HttpServletResponse</span><span class="o">.</span><span class="na">SC_OK</span><span class="o">);</span>
        <span class="n">InputStream</span> <span class="n">in</span> <span class="o">=</span> <span class="n">req</span><span class="o">.</span><span class="na">getInputStream</span><span class="o">();</span>
        <span class="k">if</span><span class="o">(</span><span class="n">DIY_CHUNKING</span><span class="o">)</span>    <span class="n">in</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ChunkedInputStream</span><span class="o">(</span><span class="n">in</span><span class="o">);</span>

        <span class="c1">// publish the upload channel</span>
        <span class="n">upload</span> <span class="o">=</span> <span class="n">in</span><span class="o">;</span>
        <span class="n">notify</span><span class="o">();</span>

        <span class="c1">// wait until we are done</span>
        <span class="k">while</span> <span class="o">(!</span><span class="n">completed</span><span class="o">)</span>
            <span class="n">wait</span><span class="o">();</span>
    <span class="o">}</span>
</pre></div>


<p>以上就是建立双向通道的基本过程。</p>
<h3>Channel对象启动ReaderThread</h3>
<p>upload请求作为输入流实例化Channel对象(<code>~/.m2/repository/org/jenkins-ci/main/remoting/3.7/remoting-3.7-sources.jar!/hudson/remoting/Channel.java</code>), Channel类的构造链比较繁琐如下图，
<img alt="" src="https://images.seebug.org/content/images/2017/05/Channel.png-w331s" /></p>
<p>最终调用的构造方法为<code>Channel(ChannelBuilder settings, CommandTransport transport)</code>, 该构造方法的transport参数，由ChannelBuilder类的negotiate()方法获得。</p>
<div class="codehilite"><pre><span></span><span class="kd">protected</span> <span class="n">CommandTransport</span> <span class="nf">negotiate</span><span class="o">(</span><span class="kd">final</span> <span class="n">InputStream</span> <span class="n">is</span><span class="o">,</span> <span class="kd">final</span> <span class="n">OutputStream</span> <span class="n">os</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
          <span class="o">......</span>
        <span class="o">{</span><span class="c1">// read the input until we hit preamble</span>
            <span class="n">Mode</span><span class="o">[]</span> <span class="n">modes</span><span class="o">={</span><span class="n">Mode</span><span class="o">.</span><span class="na">BINARY</span><span class="o">,</span><span class="n">Mode</span><span class="o">.</span><span class="na">TEXT</span><span class="o">};</span>
            <span class="kt">byte</span><span class="o">[][]</span> <span class="n">preambles</span> <span class="o">=</span> <span class="k">new</span> <span class="kt">byte</span><span class="o">[][]{</span><span class="n">Mode</span><span class="o">.</span><span class="na">BINARY</span><span class="o">.</span><span class="na">preamble</span><span class="o">,</span> <span class="n">Mode</span><span class="o">.</span><span class="na">TEXT</span><span class="o">.</span><span class="na">preamble</span><span class="o">,</span> <span class="n">Capability</span><span class="o">.</span><span class="na">PREAMBLE</span><span class="o">};</span>
            <span class="kt">int</span><span class="o">[]</span> <span class="n">ptr</span><span class="o">=</span><span class="k">new</span> <span class="kt">int</span><span class="o">[</span><span class="mi">3</span><span class="o">];</span>
            <span class="n">Capability</span> <span class="n">cap</span> <span class="o">=</span> <span class="k">new</span> <span class="n">Capability</span><span class="o">(</span><span class="mi">0</span><span class="o">);</span> <span class="c1">// remote capacity that we obtained. If we don&#39;t hear from remote, assume no capability</span>

            <span class="k">while</span><span class="o">(</span><span class="kc">true</span><span class="o">)</span> <span class="o">{</span>
                <span class="kt">int</span> <span class="n">ch</span> <span class="o">=</span> <span class="n">is</span><span class="o">.</span><span class="na">read</span><span class="o">();</span>
                <span class="o">......</span>
                <span class="k">for</span><span class="o">(</span><span class="kt">int</span> <span class="n">i</span><span class="o">=</span><span class="mi">0</span><span class="o">;</span><span class="n">i</span><span class="o">&lt;</span><span class="n">preambles</span><span class="o">.</span><span class="na">length</span><span class="o">;</span><span class="n">i</span><span class="o">++)</span> <span class="o">{</span>
                    <span class="kt">byte</span><span class="o">[]</span> <span class="n">preamble</span> <span class="o">=</span> <span class="n">preambles</span><span class="o">[</span><span class="n">i</span><span class="o">];</span>
                    <span class="k">if</span><span class="o">(</span><span class="n">preamble</span><span class="o">[</span><span class="n">ptr</span><span class="o">[</span><span class="n">i</span><span class="o">]]==</span><span class="n">ch</span><span class="o">)</span> <span class="o">{</span>
                        <span class="k">if</span><span class="o">(++</span><span class="n">ptr</span><span class="o">[</span><span class="n">i</span><span class="o">]==</span><span class="n">preamble</span><span class="o">.</span><span class="na">length</span><span class="o">)</span> <span class="o">{</span>
                            <span class="k">switch</span> <span class="o">(</span><span class="n">i</span><span class="o">)</span> <span class="o">{</span>
                            <span class="k">case</span> <span class="mi">0</span><span class="o">:</span>
                            <span class="k">case</span> <span class="mi">1</span><span class="o">:</span>
                                <span class="o">......</span>
                                <span class="k">return</span> <span class="n">makeTransport</span><span class="o">(</span><span class="n">is</span><span class="o">,</span> <span class="n">os</span><span class="o">,</span> <span class="n">mode</span><span class="o">,</span> <span class="n">cap</span><span class="o">);</span>
                            <span class="k">case</span> <span class="mi">2</span><span class="o">:</span>
                                <span class="n">cap</span> <span class="o">=</span> <span class="n">Capability</span><span class="o">.</span><span class="na">read</span><span class="o">(</span><span class="n">is</span><span class="o">);</span>
</pre></div>


<p>negotiate()会检查输入(upload请求)的前导码, 所有发往Jenkins CLI的命令中都包含某种格式的前导码（preamble），前导码格式通常为：<code>&lt;===[JENKINS REMOTING CAPACITY]===&gt;rO0ABXNyABpodWRzb24ucmVtb3RpbmcuQ2FwYWJpbGl0eQAAAAAAAAABAgABSgAEbWFza3hwAAAAAAAAAH4=</code>, 该前导码包含一个经过base64编码的序列化对象。“Capability”类型的序列化对象的功能是告诉服务器客户端具备哪些具体功能（比如HTTP分块编码功能）。</p>
<p>最后调用makeTransport()方法返回<code>CommandTransport</code>对象, 根据cap是否支持<code>Chunking</code>返回不同的对象<code>ChunkedCommandTransport</code>或<code>ClassicCommandTransport</code>。</p>
<div class="codehilite"><pre><span></span><span class="kd">protected</span> <span class="n">CommandTransport</span> <span class="nf">makeTransport</span><span class="o">(</span><span class="n">InputStream</span> <span class="n">is</span><span class="o">,</span> <span class="n">OutputStream</span> <span class="n">os</span><span class="o">,</span> <span class="n">Mode</span> <span class="n">mode</span><span class="o">,</span> <span class="n">Capability</span> <span class="n">cap</span><span class="o">)</span> <span class="kd">throws</span> <span class="n">IOException</span> <span class="o">{</span>
    <span class="n">FlightRecorderInputStream</span> <span class="n">fis</span> <span class="o">=</span> <span class="k">new</span> <span class="n">FlightRecorderInputStream</span><span class="o">(</span><span class="n">is</span><span class="o">);</span>

    <span class="k">if</span> <span class="o">(</span><span class="n">cap</span><span class="o">.</span><span class="na">supportsChunking</span><span class="o">())</span>
        <span class="k">return</span> <span class="k">new</span> <span class="n">ChunkedCommandTransport</span><span class="o">(</span><span class="n">cap</span><span class="o">,</span> <span class="n">mode</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">fis</span><span class="o">),</span> <span class="n">mode</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">os</span><span class="o">),</span> <span class="n">os</span><span class="o">);</span>
    <span class="k">else</span> <span class="o">{</span>
        <span class="n">ObjectOutputStream</span> <span class="n">oos</span> <span class="o">=</span> <span class="k">new</span> <span class="n">ObjectOutputStream</span><span class="o">(</span><span class="n">mode</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">os</span><span class="o">));</span>
        <span class="n">oos</span><span class="o">.</span><span class="na">flush</span><span class="o">();</span>    <span class="c1">// make sure that stream preamble is sent to the other end. avoids dead-lock</span>

        <span class="k">return</span> <span class="k">new</span> <span class="n">ClassicCommandTransport</span><span class="o">(</span>
                <span class="k">new</span> <span class="n">ObjectInputStreamEx</span><span class="o">(</span><span class="n">mode</span><span class="o">.</span><span class="na">wrap</span><span class="o">(</span><span class="n">fis</span><span class="o">),</span><span class="n">getBaseLoader</span><span class="o">(),</span><span class="n">getClassFilter</span><span class="o">()),</span>
                <span class="n">oos</span><span class="o">,</span><span class="n">fis</span><span class="o">,</span><span class="n">os</span><span class="o">,</span><span class="n">cap</span><span class="o">);</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></div>


<p>利用SSD的PoC脚本发送的upload请求返回的是<code>ClassicCommandTransport</code>对象，其继承关系如下图所示。</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/05/CmdT.png-w331s" /></p>
<p>Channel构造函数<code>Channel(ChannelBuilder settings, CommandTransport transport)</code>中, transport.setup()调用SynchronousCommandTransport类的setup()方法来启动一个ReaderThread线程。</p>
<div class="codehilite"><pre><span></span> <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setup</span><span class="o">(</span><span class="n">Channel</span> <span class="n">channel</span><span class="o">,</span> <span class="n">CommandReceiver</span> <span class="n">receiver</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">channel</span> <span class="o">=</span> <span class="n">channel</span><span class="o">;</span>
        <span class="k">new</span> <span class="n">ReaderThread</span><span class="o">(</span><span class="n">receiver</span><span class="o">).</span><span class="na">start</span><span class="o">();</span>
    <span class="o">}</span>
</pre></div>


<h3>读取Command对象</h3>
<p>通过上面的ReaderThread.start()方法启动一个线程，ReaderThread为SynchronousCommandTransport类的内部类，在run()方法中，调用<code>ClassicCommandTransport</code>类的read()方法读取输入，read()方法实际是调用Command类的readFrom()方法读取，通过反序列化输入返回一个Command对象。</p>
<div class="codehilite"><pre><span></span><span class="kd">private</span> <span class="kd">final</span> <span class="kd">class</span> <span class="nc">ReaderThread</span> <span class="kd">extends</span> <span class="n">Thread</span> <span class="o">{</span>
        <span class="o">......</span>
        <span class="kd">public</span> <span class="nf">ReaderThread</span><span class="o">(</span><span class="n">CommandReceiver</span> <span class="n">receiver</span><span class="o">)</span> <span class="o">{</span>
            <span class="kd">super</span><span class="o">(</span><span class="s">&quot;Channel reader thread: &quot;</span><span class="o">+</span><span class="n">channel</span><span class="o">.</span><span class="na">getName</span><span class="o">());</span>
            <span class="k">this</span><span class="o">.</span><span class="na">receiver</span> <span class="o">=</span> <span class="n">receiver</span><span class="o">;</span>
        <span class="o">}</span>

        <span class="nd">@Override</span>
        <span class="kd">public</span> <span class="kt">void</span> <span class="nf">run</span><span class="o">()</span> <span class="o">{</span>
            <span class="kd">final</span> <span class="n">String</span> <span class="n">name</span> <span class="o">=</span><span class="n">channel</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>
            <span class="k">try</span> <span class="o">{</span>
                <span class="k">while</span><span class="o">(!</span><span class="n">channel</span><span class="o">.</span><span class="na">isInClosed</span><span class="o">())</span> <span class="o">{</span>
                    <span class="n">Command</span> <span class="n">cmd</span> <span class="o">=</span> <span class="kc">null</span><span class="o">;</span>
                    <span class="k">try</span> <span class="o">{</span>
                        <span class="n">cmd</span> <span class="o">=</span> <span class="n">read</span><span class="o">();</span>
</pre></div>


<div class="codehilite"><pre><span></span>  <span class="kd">public</span> <span class="kd">final</span> <span class="n">Command</span> <span class="nf">read</span><span class="o">()</span> <span class="kd">throws</span> <span class="n">IOException</span><span class="o">,</span> <span class="n">ClassNotFoundException</span> <span class="o">{</span>
        <span class="k">try</span> <span class="o">{</span>
            <span class="n">Command</span> <span class="n">cmd</span> <span class="o">=</span> <span class="n">Command</span><span class="o">.</span><span class="na">readFrom</span><span class="o">(</span><span class="n">channel</span><span class="o">,</span> <span class="n">ois</span><span class="o">);</span>
</pre></div>


<p><img alt="" src="https://images.seebug.org/content/images/2017/05/cmd.png-w331s" /></p>
<p>在反序列化输入返回一个Command对象时就执行了cmd命令，而不是通过正常的回调handle()方法执行cmd命令，反序列化导致的执行代码触发的相关异常如下:</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/05/except.png-w331s" /></p>
<p>类型转换异常<code>ClassCastException</code>: <code>org.apache.commons.collections.map.ReferenceMap cannot be cast to hudson.remoting.Command</code>.</p>
<h3>正常执行Command</h3>
<p>虽说反序列化时就执行了cmd代码，这里也顺带了解下正常的执行cmd的过程。SynchronousCommandTransport类的run()方法中，获得返回的Command对象(cmd)，然后调用<code>receiver.handle(cmd);</code>处理命令，其实质是回调Channel类构造方法里面的handle方法，而传入handle方法的cmd参数就是反序列化得到的Command对象。</p>
<div class="codehilite"><pre><span></span>transport.setup(this, new CommandReceiver() {
            public void handle(Command cmd) {
                ......
                try {
                    cmd.execute(Channel.this);
</pre></div>


<h2>绕过黑名单保护机制</h2>
<p>上面过程主要讲述的是漏洞触发的流程，而该漏洞的核心是反序列化Java SignedObject对象会绕过黑名单保护机制，从而导致的代码执行漏洞。</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/05/sign.png-w331s" /></p>
<p>ClassFilter类定义的默认的黑名单如下：</p>
<div class="codehilite"><pre><span></span><span class="kd">private</span> <span class="kd">static</span> <span class="kd">final</span> <span class="n">String</span><span class="o">[]</span> <span class="n">DEFAULT_PATTERNS</span> <span class="o">=</span> <span class="o">{</span>
        <span class="s">&quot;^bsh[.].*&quot;</span><span class="o">,</span>
        <span class="s">&quot;^com[.]google[.]inject[.].*&quot;</span><span class="o">,</span>
        <span class="s">&quot;^com[.]mchange[.]v2[.]c3p0[.].*&quot;</span><span class="o">,</span>
        <span class="s">&quot;^com[.]sun[.]jndi[.].*&quot;</span><span class="o">,</span>
        <span class="s">&quot;^com[.]sun[.]corba[.].*&quot;</span><span class="o">,</span>
        <span class="s">&quot;^com[.]sun[.]javafx[.].*&quot;</span><span class="o">,</span>
        <span class="s">&quot;^com[.]sun[.]org[.]apache[.]regex[.]internal[.].*&quot;</span><span class="o">,</span>
        <span class="s">&quot;^java[.]awt[.].*&quot;</span><span class="o">,</span>
        <span class="s">&quot;^java[.]rmi[.].*&quot;</span><span class="o">,</span>
        <span class="s">&quot;^javax[.]management[.].*&quot;</span><span class="o">,</span>
        <span class="s">&quot;^javax[.]naming[.].*&quot;</span><span class="o">,</span>
        <span class="s">&quot;^javax[.]script[.].*&quot;</span><span class="o">,</span>
        <span class="s">&quot;^javax[.]swing[.].*&quot;</span><span class="o">,</span>
        <span class="s">&quot;^org[.]apache[.]commons[.]beanutils[.].*&quot;</span><span class="o">,</span>
        <span class="s">&quot;^org[.]apache[.]commons[.]collections[.]functors[.].*&quot;</span><span class="o">,</span>
        <span class="s">&quot;^org[.]apache[.]myfaces[.].*&quot;</span><span class="o">,</span>
        <span class="s">&quot;^org[.]apache[.]wicket[.].*&quot;</span><span class="o">,</span>
        <span class="s">&quot;.*org[.]apache[.]xalan.*&quot;</span><span class="o">,</span>
        <span class="s">&quot;^org[.]codehaus[.]groovy[.]runtime[.].*&quot;</span><span class="o">,</span>
        <span class="s">&quot;^org[.]hibernate[.].*&quot;</span><span class="o">,</span>
        <span class="s">&quot;^org[.]python[.].*&quot;</span><span class="o">,</span>
        <span class="s">&quot;^org[.]springframework[.](?!(\\p{Alnum}+[.])*\\p{Alnum}*Exception$).*&quot;</span><span class="o">,</span>
        <span class="s">&quot;^sun[.]rmi[.].*&quot;</span><span class="o">,</span>
        <span class="s">&quot;^javax[.]imageio[.].*&quot;</span><span class="o">,</span>
        <span class="s">&quot;^java[.]util[.]ServiceLoader$&quot;</span><span class="o">,</span>
        <span class="s">&quot;^java[.]net[.]URLClassLoader$&quot;</span>
    <span class="o">};</span>
</pre></div>


<p>黑名单机制绕过可以通过分析补丁得到印证。
<img alt="" src="https://images.seebug.org/content/images/2017/05/fix.png-w331s" /></p>
<h2>参考</h2>
<ul>
<li><a href="https://www.seebug.org/vuldb/ssvid-93062">https://www.seebug.org/vuldb/ssvid-93062</a></li>
<li><a href="http://www.securityfocus.com/bid/98056">http://www.securityfocus.com/bid/98056</a></li>
<li><a href="https://blogs.securiteam.com/index.php/archives/3171">https://blogs.securiteam.com/index.php/archives/3171</a></li>
<li><a href="https://jenkins.io/security/advisory/2017-04-26/">https://jenkins.io/security/advisory/2017-04-26/</a></li>
<li><a href="https://github.com/jenkinsci/jenkins/commit/36b8285a41eb28333549e8d851f81fd80a184076">https://github.com/jenkinsci/jenkins/commit/36b8285a41eb28333549e8d851f81fd80a184076</a></li>
<li><a href="https://github.com/jenkinsci/jenkins/commit/f237601afd750a0eaaf961e8120b08de238f2c3f">https://github.com/jenkinsci/jenkins/commit/f237601afd750a0eaaf961e8120b08de238f2c3f</a></li>
<li><a href="http://www.lilihongblog.com/Blog/jenkins+Slave+Receiving+Remote+Request">http://www.lilihongblog.com/Blog/jenkins+Slave+Receiving+Remote+Request</a></li>
</ul>
      
<hr>
<p><img src="https://images.seebug.org/content/images/2017/08/0e69b04c-e31f-4884-8091-24ec334fbd7e.jpeg" alt="Paper" style="width: 220px">
本文由 Seebug Paper 发布，如需转载请注明来源。本文地址：<a href="https://paper.seebug.org/295/">https://paper.seebug.org/295/</a></p>
            
    </section>

  <nav class="pagination" role="navigation" style="padding: 3rem;">
    
      <a class="newer-posts" href="/294/"><span aria-hidden="true">&larr;</span> bug bounty - 绕过限制劫持Skpe账号</a>
    
    
      <a class="older-posts" href="/296/">TrustZone安全技术研究 <span aria-hidden="true">&rarr;</span></a>
    
  </nav>


    

      
        <footer class="post-footer">
          <figure class="author-image">
            <a class="img" href="/users/author/?nickname=Janes"
               style="background-image: url(https://images.seebug.org/uploads/2017/08/avatar.png)"><span
                class="hidden">'s Picture</span></a>
          </figure>

          <section class="author">
            <h4><a
                href="/users/author/?nickname=Janes">Janes</a>
            </h4>
            <p>阅读更多有关<a
                href="/users/author/?nickname=Janes">该作者</a>的文章
            </p>
            
            <div class="author-meta">
            </div>
          </section>

          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          

        </footer>
      
    
    <br>
    <section class="plugin_comment">
    </section>

  </article>
  <section class="plugin_feedback"></section>


  </div>
</main>
</div>

<script type="text/javascript" src="/static/js/jquery.min.js"></script>
<script type="text/javascript" src="/static/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/static/js/index.js"></script>
<script type="text/javascript" src="/static/js/prism-loader.js"></script>
<script type="text/javascript" src="/static/js/prism.js"></script>
<script type="text/javascript" src="/static/js/jquery.ghostHunter.js"></script>
<script type="text/javascript" src="/static/js/js.cookie.js"></script>
<script type="text/javascript" src="/static/js/custom.js?t=20170821"></script>
<script type="text/javascript" src="https://www.seebug.org/static/dist2/scripts/comment_main.js"></script>
<script type="text/javascript" src="https://www.seebug.org/static/dist2/scripts/plugin_feedback.js"></script>
</body>

</html>
