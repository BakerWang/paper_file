<!DOCTYPE html>


<html xmlns:wb="http://open.weibo.com/wb">

<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta property="wb:webmaster" content="ccd3e79934f3322d"/>
  <title>CVE-2016-7637---再谈Mach IPC</title>
  <meta name="keywords" content="漏洞文档,漏洞分析,安全技术"/>
  <meta name="description" content=""/>

  <meta name="HandheldFriendly" content="True"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <link rel="shortcut icon" href="/static/images/favicon.ico">
  <link rel="stylesheet" type="text/css" href="/static/css/screen.css"/>
  <link rel="stylesheet" type="text/css" href="/static/css/font.css"/>
  <link rel="stylesheet"
        href="//libs.baidu.com/fontawesome/4.0.3/css/font-awesome.min.css">
  <link rel="stylesheet" type="text/css" href="/static/css/prism.css"/>
  <link rel="stylesheet" type="text/css" href="/static/css/monokai.css" media="screen"/>
  <link rel="stylesheet" type="text/css" href="/static/css/custom.css?t=20170821"/>
  <link rel="stylesheet" type="text/css" href="/static/css/print.css?t=20170821" media="print"/>
  <script>
    var _hmt = _hmt || [];
    (function () {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?ef67a70a7641da3b52452a05b3bbecae";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


</head>

<body class="home-template">
<div class="weixin-share-img" style="display: none">
  <img src="/static/images/weixin-share.png" alt="Paper"/>
</div>

<div id="wrapper" class="">

<div id="sidebar">
  <button type="button" class="hamburger is-closed" data-toggle="offcanvas">
    <span class="hamb-top"></span>
    <span class="hamb-middle"></span>
    <span class="hamb-bottom"></span>
  </button>
  <div id="sidebar-content" class="inner">
    <h2 class="blog-title"><a href="/">Paper</a></h2>
    <h3 class="blog-description">安全技术精粹</h3>

    <form id="search" action="/">
      <button type="submit" style="background: #13313f; border: #13313f; position: absolute; right: -4px; margin-top: -3px;">
        <i class="fa fa-search search-button" style="position: absolute;right:10px; margin-top:6px;" > </i>
      </button>
      <input id="search-field" name="keyword" value="" placeholder="Search"/>

    </form>
    <div class="overlay"></div>
    <div id="sidebar-links">
      <ul id="subscription-links">
        <li><a target="_blank" href="/rss/"><i class="fa fa-rss"></i>RSS 订阅</a>
        </li>
        <li><a href="https://www.seebug.org/contribute/paper"><i
            class="fa fa-envelope-o"></i>投稿</a></li>
      </ul>
      <ul id="navigation">
        <li class="nav-" role="presentation"><a href="/"><i
            class="fa fa-angle-right"></i>首页</a></li>
        
  <li class="nav-" role="presentation"><a href="/category/vul-analysis/"><i
      class="fa fa-angle-right"></i>漏洞分析</a></li>

  <li class="nav-" role="presentation"><a href="/category/tools/"><i
      class="fa fa-angle-right"></i>安全工具&amp;安全开发</a></li>

  <li class="nav-" role="presentation"><a href="/category/information/"><i
      class="fa fa-angle-right"></i>情报分析</a></li>

  <li class="nav-" role="presentation"><a href="/category/experience/"><i
      class="fa fa-angle-right"></i>经验心得</a></li>

  <li class="nav-" role="presentation"><a href="/category/web-security/"><i
      class="fa fa-angle-right"></i>Web安全</a></li>

  <li class="nav-" role="presentation"><a href="/category/bin-security/"><i
      class="fa fa-angle-right"></i>二进制安全</a></li>

  <li class="nav-" role="presentation"><a href="/category/mobile-security/"><i
      class="fa fa-angle-right"></i>移动安全</a></li>

  <li class="nav-" role="presentation"><a href="/category/paper-archive/"><i
      class="fa fa-angle-right"></i>纸篓</a></li>

  <li class="nav-" role="presentation"><a href="/category/prime/"><i
      class="fa fa-angle-right"></i>安全基础&amp;教学篇</a></li>


        <li class="nav-" role="presentation"><a href="/call-for-paper/"><i
            class="fa fa-angle-right"></i>如何投稿</a></li>
        <li class="nav-" role="presentation"><a href="https://paper.seebug.org/papers/"><i
            class="fa fa-angle-right"></i>归档文件</a></li>
      </ul>
      <ul id="sidebar-external">
      </ul>
    </div>

    <footer class="site-footer">
      <section class="copyright">Copyright @ 404 Team from Knownsec.</section>
    </footer>
  </div>
</div>

<main>
  <div class="main-inner">
    <section id="results"></section>
    
  <article class="">
    <header class="post-header">

      <h1 class="post-title">CVE-2016-7637---再谈Mach IPC</h1>

      <span class="post-print">
        <a href="javascript:window.print()">
        <i class="fa fa-print fa-2x" aria-hidden="true"></i>
        </a>
      </span>
      <section class="post-meta">
        <span class="post-time">
          <i class='fa fa-calendar'></i>
          <time datetime="2017-01-25" class="timeago">7 月，3 周 之前</time>
          <time datetime="2017-01-25" class="fulldate">一月 25, 2017</time>
        </span>
        
          <br>
          <i class='fa fa-tag'></i>
          
            <a href="/category/vul-analysis/">漏洞分析</a>
            
          
        








      </section>
    </header>

    <section class="post-content">
      <p>来源：<a href="http://turingh.github.io/2017/01/10/CVE-2016-7637-%E5%86%8D%E8%B0%88Mach-IPC/">turingh.github.io</a></p>
<p>作者：<a href="https://github.com/turingH">turingH</a></p>
<blockquote>
<p>为学大病在好名。</p>
</blockquote>
<h2>0x00 摘要</h2>
<p>去年在分析<a href="http://turingh.github.io/2016/07/05/%E5%86%8D%E7%9C%8BCVE-2016-1757%E6%B5%85%E6%9E%90mach%20message%E7%9A%84%E4%BD%BF%E7%94%A8/">CVE-2016-1757</a>时，初步的接触了<code>Mach</code>在<code>IPC</code>系统中使用的<code>Message</code>，在分析最近的一系列与<code>IPC</code>模块相关的漏洞时，又加强对<code>IPC</code>模块的理解，所以通过一到两篇文章梳理一下最近的学习总结与心得体会。</p>
<p>关于<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2016-7637">CVE-2016-7637</a>这个漏洞的描述有很多资料了，是一个攻击<code>Mach</code>的内核<code>IPC</code>模块的漏洞，本文最后会对漏洞做出比较详细的解释，这里给出几个链接，不熟悉这个漏洞的读者可以先了解一下。</p>
<p><a href="https://jaq.alibaba.com/community/art/show?articleid=687">黑云压城城欲摧 - 2016年iOS公开可利用漏洞总结</a></p>
<p><a href="http://blog.pangu.io/mach-portal-details/">mach portal漏洞利用的一些细节</a></p>
<p><a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=959&amp;can=1&amp;q=apple&amp;sort=-id">Broken kernel mach port name uref</a></p>
<h2>0x01 什么是Port</h2>
<p>对于一般的开发者，在用到<code>Port</code>的时候可以简单的将<code>Port</code>理解为进程间通信所使用的类似于<code>Socket</code>的东西，可以用他来发送消息，也可以用来接收消息。</p>
<p>下面我们来一步一步的构建对整个模块的理解。</p>
<p>已经知道<code>Port</code>是什么的读者可以跳过这一个部分。</p>
<h3>1.1 利用Port传递数据</h3>
<p><code>Port</code>最简单的可以理解为一个内核中的消息队列。不同的<code>Task</code>通过这个消息队列相互传递数据。而<code>Port</code>就是用于找到这个队列的索引。</p>
<p><img alt="利用Port传递数据" src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/CVE-2016-7637-%E5%86%8D%E8%B0%88Mach-IPC/%E5%88%A9%E7%94%A8Port%E4%BC%A0%E9%80%92%E6%95%B0%E6%8D%AE.png" /></p>
<h3>1.2 Port、Port Name 与 Right</h3>
<p>通过函数<code>mach_port_allocate</code>就可以在内核中建立一个消息队列，并获取一个与之对应的的<code>Port</code>。代码如下。</p>
<div class="codehilite"><pre><span></span><span class="n">mach_port_t</span> <span class="n">p</span><span class="p">;</span>
<span class="n">mach_port_allocate</span><span class="p">(</span><span class="n">mach_task_self</span><span class="p">(),</span> <span class="n">MACH_PORT_RIGHT_RECEIVE</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">p</span><span class="p">);</span>
</pre></div>


<p>通过查看内核源码，</p>
<div class="codehilite"><pre><span></span><span class="cm">/*</span>
<span class="cm"> *  Purpose:</span>
<span class="cm"> *      Allocates a right in a space.  Like mach_port_allocate_name,</span>
<span class="cm"> *      except that the implementation picks a name for the right.</span>
<span class="cm"> *      The name may be any legal name in the space that doesn&#39;t</span>
<span class="cm"> *      currently denote a right.</span>
<span class="cm"> */</span>
<span class="n">kern_return_t</span>
<span class="nf">mach_port_allocate</span><span class="p">(</span>
    <span class="n">ipc_space_t</span>     <span class="n">space</span><span class="p">,</span>
    <span class="n">mach_port_right_t</span>   <span class="n">right</span><span class="p">,</span>
    <span class="n">mach_port_name_t</span>    <span class="o">*</span><span class="n">namep</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">kern_return_t</span>       <span class="n">kr</span><span class="p">;</span>
    <span class="n">mach_port_qos_t</span>     <span class="n">qos</span> <span class="o">=</span> <span class="n">qos_template</span><span class="p">;</span>

    <span class="n">kr</span> <span class="o">=</span> <span class="n">mach_port_allocate_full</span> <span class="p">(</span><span class="n">space</span><span class="p">,</span> <span class="n">right</span><span class="p">,</span> <span class="n">MACH_PORT_NULL</span><span class="p">,</span>
                    <span class="o">&amp;</span><span class="n">qos</span><span class="p">,</span> <span class="n">namep</span><span class="p">);</span>
    <span class="k">return</span> <span class="p">(</span><span class="n">kr</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<p>仔细看的话会发现，对我们刚刚申请的<code>p</code>出现了好几个解释，一下就晕了。</p>
<ul>
<li>在应用层代码中，p被定义为<code>mach_port_t</code>。</li>
<li>在内核中代码中，<code>namep</code>是<code>mach_port_name_t</code>。</li>
<li>在注释中又说，Allocates a <font color=Crimson>RIGHT</font>  in a space。</li>
</ul>
<h4>1.2.1 Port与Port Name</h4>
<p>通过调试器观察一下，可以发现，</p>
<div class="codehilite"><pre><span></span><span class="o">(</span>lldb<span class="o">)</span> p p
<span class="o">(</span>mach_port_t<span class="o">)</span> <span class="nv">$0</span> <span class="o">=</span> <span class="m">3331</span>
</pre></div>


<div class="codehilite"><pre><span></span> <span class="o">*</span> <span class="n">frame</span> <span class="err">#</span><span class="mi">0</span><span class="o">:</span> <span class="mh">0xffffff801d4ee11d</span> <span class="n">kernel</span><span class="err">`</span><span class="n">mach_port_allocate_full</span><span class="p">(</span><span class="n">space</span><span class="o">=</span><span class="mh">0xffffff8024ceac00</span><span class="p">,</span> <span class="n">right</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">proto</span><span class="o">=</span><span class="mh">0x0000000000000000</span><span class="p">,</span> <span class="n">qosp</span><span class="o">=</span><span class="mh">0xffffff887d7b3ef0</span><span class="p">,</span> <span class="n">namep</span><span class="o">=</span><span class="mh">0xffffff887d7b3eec</span>
</pre></div>


<p>在应用层的<code>mach_port_t</code>是一个已经经过代码处理的类似于<code>Socket</code>的一个整数，来表示这个<code>Port</code>。</p>
<p>而<code>namep</code>在内核之中是一个地址，指向了一块用来索引<code>Port</code>的内存，具体的实现在本文的后面会有更详细的解释。</p>
<h4>1.2.2 Right</h4>
<p>这里注释所说的<code>Right</code>简单的理解，其实是一个<code>Port</code>和对这个<code>Port</code>进行访问的权限。每一个<code>Port</code>代表的消息队列并不是可以任意访问的，需要有对这个队列的访问权限。各种权限在头文件中的定义如下。</p>
<div class="codehilite"><pre><span></span><span class="cp">#define MACH_PORT_RIGHT_SEND      ((mach_port_right_t) 0)</span>
<span class="cp">#define MACH_PORT_RIGHT_RECEIVE   ((mach_port_right_t) 1)</span>
<span class="cp">#define MACH_PORT_RIGHT_SEND_ONCE ((mach_port_right_t) 2)</span>
<span class="cp">#define MACH_PORT_RIGHT_PORT_SET  ((mach_port_right_t) 3)</span>
<span class="cp">#define MACH_PORT_RIGHT_DEAD_NAME ((mach_port_right_t) 4)</span>
<span class="cp">#define MACH_PORT_RIGHT_NUMBER    ((mach_port_right_t) 5)</span>
</pre></div>


<p>每种<code>Right</code>都有不同的含义，可以自行查阅文档。</p>
<p>这里需要简单的提一下的就是每一个<code>Port</code>都有且只有<code>Task</code>对其拥有<code>RECEIVE</code>的权限，<code>SEND</code>的权限不限。拥有<code>MACH_PORT_RIGHT_RECEIVE</code>时也可以对<code>Port</code>进行消息的Send。</p>
<p><img alt="PORT_NAME_RIGHT" src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/CVE-2016-7637-%E5%86%8D%E8%B0%88Mach-IPC/PORT_NAME_RIGHT.png" /></p>
<h3>1.3 Port的具体实现</h3>
<p>阅读<code>mach_port_allocate_full</code>函数的源码，最终在一个<code>port</code>的创建流程中，最主要的函数是<code>ipc_port_alloc</code>以及在其实现中调用的<code>ipc_object_alloc</code>。</p>
<div class="codehilite"><pre><span></span><span class="n">kern_return_t</span>
<span class="nf">ipc_port_alloc</span><span class="p">(</span>
    <span class="n">ipc_space_t</span>     <span class="n">space</span><span class="p">,</span>
    <span class="n">mach_port_name_t</span>    <span class="o">*</span><span class="n">namep</span><span class="p">,</span>
    <span class="n">ipc_port_t</span>      <span class="o">*</span><span class="n">portp</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ipc_port_t</span> <span class="n">port</span><span class="p">;</span>
    <span class="n">mach_port_name_t</span> <span class="n">name</span><span class="p">;</span>
    <span class="n">kern_return_t</span> <span class="n">kr</span><span class="p">;</span>

    <span class="n">kr</span> <span class="o">=</span> <span class="n">ipc_object_alloc</span><span class="p">(</span><span class="n">space</span><span class="p">,</span> <span class="n">IOT_PORT</span><span class="p">,</span>
                  <span class="n">MACH_PORT_TYPE_RECEIVE</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span>
                  <span class="o">&amp;</span><span class="n">name</span><span class="p">,</span> <span class="p">(</span><span class="n">ipc_object_t</span> <span class="o">*</span><span class="p">)</span> <span class="o">&amp;</span><span class="n">port</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">kr</span> <span class="o">!=</span> <span class="n">KERN_SUCCESS</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">kr</span><span class="p">;</span>

    <span class="cm">/* port and space are locked */</span>
    <span class="n">ipc_port_init</span><span class="p">(</span><span class="n">port</span><span class="p">,</span> <span class="n">space</span><span class="p">,</span> <span class="n">name</span><span class="p">);</span>
    <span class="p">[...]</span>

    <span class="o">*</span><span class="n">namep</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span> <span class="o">&lt;--</span><span class="n">namep是从这里来的</span><span class="err">。</span>
    <span class="o">*</span><span class="n">portp</span> <span class="o">=</span> <span class="n">port</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">KERN_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>很明显，<code>port</code>和<code>name</code>两个变量都是由函数<code>ipc_object_alloc</code>中获取的。关键源码如下。</p>
<div class="codehilite"><pre><span></span><span class="n">kern_return_t</span>
<span class="nf">ipc_object_alloc</span><span class="p">(</span>
    <span class="n">ipc_space_t</span>     <span class="n">space</span><span class="p">,</span> 
    <span class="n">ipc_object_type_t</span>   <span class="n">otype</span><span class="p">,</span>
    <span class="n">mach_port_type_t</span>    <span class="n">type</span><span class="p">,</span>
    <span class="n">mach_port_urefs_t</span>   <span class="n">urefs</span><span class="p">,</span>
    <span class="n">mach_port_name_t</span>    <span class="o">*</span><span class="n">namep</span><span class="p">,</span>
    <span class="n">ipc_object_t</span>        <span class="o">*</span><span class="n">objectp</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ipc_object_t</span> <span class="n">object</span><span class="p">;</span>
    <span class="n">ipc_entry_t</span> <span class="n">entry</span><span class="p">;</span>
    <span class="n">kern_return_t</span> <span class="n">kr</span><span class="p">;</span>

    <span class="p">[...]</span>

    <span class="c1">//从zone中申请内存,这个object就是ipc_port</span>
    <span class="n">object</span> <span class="o">=</span> <span class="n">io_alloc</span><span class="p">(</span><span class="n">otype</span><span class="p">);</span>   

    <span class="p">[...]</span>

    <span class="c1">//获取namep和entry</span>
    <span class="o">*</span><span class="n">namep</span> <span class="o">=</span> <span class="n">CAST_MACH_PORT_TO_NAME</span><span class="p">(</span><span class="n">object</span><span class="p">);</span>
    <span class="n">kr</span> <span class="o">=</span> <span class="n">ipc_entry_alloc</span><span class="p">(</span><span class="n">space</span><span class="p">,</span> <span class="n">namep</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">entry</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">kr</span> <span class="o">!=</span> <span class="n">KERN_SUCCESS</span><span class="p">)</span> <span class="p">{</span>
        <span class="n">io_free</span><span class="p">(</span><span class="n">otype</span><span class="p">,</span> <span class="n">object</span><span class="p">);</span>
        <span class="k">return</span> <span class="n">kr</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="cm">/* space is write-locked */</span>

    <span class="c1">//设置关键的参数</span>
    <span class="n">entry</span><span class="o">-&gt;</span><span class="n">ie_bits</span> <span class="o">|=</span> <span class="n">type</span> <span class="o">|</span> <span class="n">urefs</span><span class="p">;</span>
    <span class="n">entry</span><span class="o">-&gt;</span><span class="n">ie_object</span> <span class="o">=</span> <span class="n">object</span><span class="p">;</span>
    <span class="n">ipc_entry_modified</span><span class="p">(</span><span class="n">space</span><span class="p">,</span> <span class="o">*</span><span class="n">namep</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>

    <span class="n">io_lock</span><span class="p">(</span><span class="n">object</span><span class="p">);</span>

    <span class="n">object</span><span class="o">-&gt;</span><span class="n">io_references</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span> <span class="cm">/* for entry, not caller */</span>
    <span class="n">object</span><span class="o">-&gt;</span><span class="n">io_bits</span> <span class="o">=</span> <span class="n">io_makebits</span><span class="p">(</span><span class="n">TRUE</span><span class="p">,</span> <span class="n">otype</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>

    <span class="o">*</span><span class="n">objectp</span> <span class="o">=</span> <span class="n">object</span><span class="p">;</span>
    <span class="k">return</span> <span class="n">KERN_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<h4>1.3.1 IPC Space 和 IPC Entry</h4>
<p>细心的读者会发现前面有个叫做<code>space</code>的参数没有解释。这里又出现了一个新的结构叫做<code>entry</code>。他们是有关系的，这里我们来一起解释一下。</p>
<blockquote>
<p>Each task has a private IPC <em>space</em>a namespace for portsthat is represented by the ipc_space structure in the kernel.</p>
<p>Mac OS X Internals</p>
</blockquote>
<p>每一个<code>Task</code>都有一个自己独立的<code>IPC</code>的数据空间，就是这里的<code>space</code>。他的数据结构是定义如下。</p>
<div class="codehilite"><pre><span></span><span class="c1">// osfmk/ipc/ipc_space.h</span>

<span class="k">typedef</span> <span class="n">natural_t</span> <span class="n">ipc_space_refs_t</span><span class="p">;</span>

<span class="k">struct</span> <span class="n">ipc_space</span> <span class="p">{</span>
    <span class="n">decl_mutex_data</span><span class="p">(,</span><span class="n">is_ref_lock_data</span><span class="p">)</span>
    <span class="n">ipc_space_refs_t</span> <span class="n">is_references</span><span class="p">;</span>

    <span class="n">decl_mutex_data</span><span class="p">(,</span><span class="n">is_lock_data</span><span class="p">)</span>

    <span class="c1">// is the space active?</span>
    <span class="n">boolean_t</span> <span class="n">is_active</span><span class="p">;</span>

    <span class="c1">// is the space growing?</span>
    <span class="n">boolean_t</span> <span class="n">is_growing</span><span class="p">;</span>

    <span class="c1">// table (array) of IPC entries</span>
    <span class="c1">// 这个是最重要的，存放了所有的entry</span>
    <span class="n">ipc_entry_t</span> <span class="n">is_table</span><span class="p">;</span> 

    <span class="c1">// current table size</span>
    <span class="n">ipc_entry_num_t</span> <span class="n">is_table_size</span><span class="p">;</span>

    <span class="c1">// information for larger table</span>
    <span class="k">struct</span> <span class="n">ipc_table_size</span> <span class="o">*</span><span class="n">is_table_next</span><span class="p">;</span>

    <span class="c1">// splay tree of IPC entries (can be NULL)</span>
    <span class="k">struct</span> <span class="n">ipc_splay_tree</span> <span class="n">is_tree</span><span class="p">;</span>

    <span class="c1">// number of entries in the tree</span>
    <span class="n">ipc_entry_num_t</span> <span class="n">is_tree_total</span><span class="p">;</span>

    <span class="c1">// number of &quot;small&quot; entries in the tree</span>
    <span class="n">ipc_entry_num_t</span> <span class="n">is_tree_small</span><span class="p">;</span>

    <span class="c1">// number of hashed entries in the tree</span>
    <span class="n">ipc_entry_num_t</span> <span class="n">is_tree_hash</span><span class="p">;</span>

    <span class="c1">// for is_fast_space()</span>
    <span class="n">boolean_t</span> <span class="n">is_fast</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>


<p>而我们研究的对象 <code>Mach Ports</code>全都存储在<code>is_table</code>这个数组中，这个数组就是由<code>ipc_entry</code>组成的。</p>
<div class="codehilite"><pre><span></span>    <span class="k">struct</span> <span class="n">ipc_entry</span> <span class="p">{</span>
        <span class="k">struct</span> <span class="n">ipc_object</span> <span class="o">*</span><span class="n">ie_object</span><span class="p">;</span>   <span class="c1">//ipc_port_t</span>
        <span class="n">ipc_entry_bits_t</span> <span class="n">ie_bits</span><span class="p">;</span>       <span class="c1">//gen|0|0|0|capability|user reference</span>
        <span class="n">mach_port_index_t</span> <span class="n">ie_index</span><span class="p">;</span>
        <span class="k">union</span> <span class="p">{</span>
            <span class="n">mach_port_index_t</span> <span class="n">next</span><span class="p">;</span>     <span class="cm">/* next in freelist, or...  */</span>
            <span class="n">ipc_table_index_t</span> <span class="n">request</span><span class="p">;</span>  <span class="cm">/* dead name request notify */</span>
        <span class="p">}</span> <span class="n">index</span><span class="p">;</span>
    <span class="p">};</span>
</pre></div>


<p>用一张书上的图，很清楚的表明了他们之间的关系。</p>
<p><img alt="" src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/CVE-2016-7637-%E5%86%8D%E8%B0%88Mach-IPC/space%E5%92%8Centry.png" /></p>
<h4>1.3.2 ipc_port</h4>
<p>相对而言ipc_port的数据结构就较为简单了。在复制给<code>space</code>的<code>ie_object</code>之后，通过<code>ipc_port_init</code>函数的初始化，就完成了<code>port</code>的创建了。</p>
<div class="codehilite"><pre><span></span><span class="n">ipc_port_init</span><span class="p">(</span>
    <span class="n">ipc_port_t</span>      <span class="n">port</span><span class="p">,</span>
    <span class="n">ipc_space_t</span>     <span class="n">space</span><span class="p">,</span>
    <span class="n">mach_port_name_t</span>    <span class="n">name</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* port-&gt;ip_kobject doesn&#39;t have to be initialized */</span>

    <span class="n">port</span><span class="o">-&gt;</span><span class="n">ip_receiver</span> <span class="o">=</span> <span class="n">space</span><span class="p">;</span>
    <span class="n">port</span><span class="o">-&gt;</span><span class="n">ip_receiver_name</span> <span class="o">=</span> <span class="n">name</span><span class="p">;</span>

    <span class="n">port</span><span class="o">-&gt;</span><span class="n">ip_mscount</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">port</span><span class="o">-&gt;</span><span class="n">ip_srights</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">port</span><span class="o">-&gt;</span><span class="n">ip_sorights</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">port</span><span class="o">-&gt;</span><span class="n">ip_nsrequest</span> <span class="o">=</span> <span class="n">IP_NULL</span><span class="p">;</span>
    <span class="n">port</span><span class="o">-&gt;</span><span class="n">ip_pdrequest</span> <span class="o">=</span> <span class="n">IP_NULL</span><span class="p">;</span>
    <span class="n">port</span><span class="o">-&gt;</span><span class="n">ip_requests</span> <span class="o">=</span> <span class="n">IPR_NULL</span><span class="p">;</span>

    <span class="n">port</span><span class="o">-&gt;</span><span class="n">ip_premsg</span> <span class="o">=</span> <span class="n">IKM_NULL</span><span class="p">;</span>
    <span class="n">port</span><span class="o">-&gt;</span><span class="n">ip_context</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">port</span><span class="o">-&gt;</span><span class="n">ip_sprequests</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">port</span><span class="o">-&gt;</span><span class="n">ip_spimportant</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">port</span><span class="o">-&gt;</span><span class="n">ip_impdonation</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">port</span><span class="o">-&gt;</span><span class="n">ip_tempowner</span>   <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">port</span><span class="o">-&gt;</span><span class="n">ip_guarded</span>      <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">port</span><span class="o">-&gt;</span><span class="n">ip_strict_guard</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="n">port</span><span class="o">-&gt;</span><span class="n">ip_impcount</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">port</span><span class="o">-&gt;</span><span class="n">ip_reserved</span>    <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="n">ipc_mqueue_init</span><span class="p">(</span><span class="o">&amp;</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">ip_messages</span><span class="p">,</span>
            <span class="n">FALSE</span> <span class="cm">/* !set */</span><span class="p">,</span> <span class="nb">NULL</span> <span class="cm">/* no reserved link */</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<p>这里同样的用书上的一张图就可以很简单的解释清楚了。</p>
<p><img alt="ipc_port" src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/CVE-2016-7637-%E5%86%8D%E8%B0%88Mach-IPC/ipc_port.png" /></p>
<h2>0x02 POC的分析</h2>
<p>​   POC原来的writeup在<a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=959&amp;can=1&amp;q=apple&amp;sort=-id">这里</a>。</p>
<p>​   原文已经解释的非常清楚了，我就不画蛇添足了。简单记录一下我自己在分析的过程中的一些问题。</p>
<h3>2.1 port的user reference计数代表了什么？</h3>
<p>​   一个<code>port</code>的<code>user reference</code>只表示了某个<code>entry</code>在<code>task</code>的<code>space</code>中被多少个地方使用，和<code>entry</code>实际指向哪个<code>port</code>没有关系。</p>
<p>​   </p>
<h3>2.2 ipc_right_dealloc函数是只释放了entry还是同时也在内存中释放了port？</h3>
<p>​   <code>ipc_right_dealloc</code>函数相关部分源码如下：</p>
<div class="codehilite"><pre><span></span><span class="n">kern_return_t</span>
<span class="nf">ipc_right_dealloc</span><span class="p">(</span>
    <span class="n">ipc_space_t</span>     <span class="n">space</span><span class="p">,</span>
    <span class="n">mach_port_name_t</span>    <span class="n">name</span><span class="p">,</span>
    <span class="n">ipc_entry_t</span>     <span class="n">entry</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ipc_port_t</span> <span class="n">port</span> <span class="o">=</span> <span class="n">IP_NULL</span><span class="p">;</span>
    <span class="n">ipc_entry_bits_t</span> <span class="n">bits</span><span class="p">;</span>
    <span class="n">mach_port_type_t</span> <span class="n">type</span><span class="p">;</span>

    <span class="n">bits</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">ie_bits</span><span class="p">;</span>
    <span class="n">type</span> <span class="o">=</span> <span class="n">IE_BITS_TYPE</span><span class="p">(</span><span class="n">bits</span><span class="p">);</span>

    <span class="n">assert</span><span class="p">(</span><span class="n">is_active</span><span class="p">(</span><span class="n">space</span><span class="p">));</span>
    <span class="k">switch</span> <span class="p">(</span><span class="n">type</span><span class="p">)</span> <span class="p">{</span>
         <span class="p">[...]</span>
        <span class="k">case</span> <span class="nl">MACH_PORT_TYPE_SEND</span><span class="p">:</span> <span class="p">{</span>
        <span class="p">[...]</span>
        <span class="n">port</span> <span class="o">=</span> <span class="p">(</span><span class="n">ipc_port_t</span><span class="p">)</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">ie_object</span><span class="p">;</span>
        <span class="p">[...]</span>
         <span class="c1">//如果在task内entry的reference已经为1了就</span>
         <span class="c1">//释放entry</span>
         <span class="c1">//如果计数不为1，就将计数减一</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">IE_BITS_UREFS</span><span class="p">(</span><span class="n">bits</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">--</span><span class="n">port</span><span class="o">-&gt;</span><span class="n">ip_srights</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                <span class="n">nsrequest</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">ip_nsrequest</span><span class="p">;</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">nsrequest</span> <span class="o">!=</span> <span class="n">IP_NULL</span><span class="p">)</span> <span class="p">{</span>
                    <span class="n">port</span><span class="o">-&gt;</span><span class="n">ip_nsrequest</span> <span class="o">=</span> <span class="n">IP_NULL</span><span class="p">;</span>
                    <span class="n">mscount</span> <span class="o">=</span> <span class="n">port</span><span class="o">-&gt;</span><span class="n">ip_mscount</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>

            <span class="p">[...]</span>
            <span class="n">entry</span><span class="o">-&gt;</span><span class="n">ie_object</span> <span class="o">=</span> <span class="n">IO_NULL</span><span class="p">;</span>
            <span class="n">ipc_entry_dealloc</span><span class="p">(</span><span class="n">space</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>
            <span class="n">is_write_unlock</span><span class="p">(</span><span class="n">space</span><span class="p">);</span>
            <span class="n">ip_release</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>

        <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
            <span class="n">ip_unlock</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>            
            <span class="n">entry</span><span class="o">-&gt;</span><span class="n">ie_bits</span> <span class="o">=</span> <span class="n">bits</span><span class="o">-</span><span class="mi">1</span><span class="p">;</span> <span class="cm">/* decrement urefs */</span>
            <span class="n">ipc_entry_modified</span><span class="p">(</span><span class="n">space</span><span class="p">,</span> <span class="n">name</span><span class="p">,</span> <span class="n">entry</span><span class="p">);</span>
            <span class="n">is_write_unlock</span><span class="p">(</span><span class="n">space</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">[...]</span>

    <span class="k">return</span> <span class="n">KERN_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>所以当<code>entry</code>计数为1的时候，调用了<code>ipc_entry_dealloc</code>，<code>ipc_entry_dealloc</code>不会将<code>entry</code>对应的内存释放，而是将其放入一个<code>free_list</code>等待重复使用。<code>entry</code>的内存不会释放，而且<code>entry</code>在<code>is_table</code>中的<code>index</code>也并不会改变，只是被放到了一个结构管理的队列中去了。</p>
<p>对于<code>Port</code>来说，内核调用了<code>ip_release</code>，这个函数的作用是减少<code>ipc_object</code>自身的<code>reference</code>，如果<code>port</code>的索引变为0了，那就会被释放，如果系统中还有其他的进程在使用这个<code>port</code>，那么这个<code>port</code>就不会被释放。</p>
<h3>2.3 如何通过调试器调试漏洞触发的现场?</h3>
<p>一开始我想的方法是对<code>ipc_right_copyout</code>下条件断点，条件是<code>entry-&gt;ie_bits&amp;0xffff == 0xfffe</code>。但是因为<code>ipc_right_copyout</code>这个函数在内核中的调用太过于频繁，导致虚拟机跑太卡了。</p>
<p>只能通过逆向，在汇编代码处下断点。（内核版本10.12_16A323）</p>
<p><img alt="" src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/CVE-2016-7637-%E5%86%8D%E8%B0%88Mach-IPC/bug%E7%82%B9.png" /></p>
<p>对应的就是出bug的代码段。</p>
<div class="codehilite"><pre><span></span>           <span class="k">if</span> <span class="p">(</span><span class="n">urefs</span><span class="o">+</span><span class="mi">1</span> <span class="o">==</span> <span class="n">MACH_PORT_UREFS_MAX</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">overflow</span><span class="p">)</span> <span class="p">{</span>
                    <span class="cm">/* leave urefs pegged to maximum */</span>     <span class="o">&lt;----</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>

                    <span class="n">port</span><span class="o">-&gt;</span><span class="n">ip_srights</span><span class="o">--</span><span class="p">;</span>
                    <span class="n">ip_unlock</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
                    <span class="n">ip_release</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
                    <span class="k">return</span> <span class="n">KERN_SUCCESS</span><span class="p">;</span>
                <span class="p">}</span>

                <span class="n">ip_unlock</span><span class="p">(</span><span class="n">port</span><span class="p">);</span>
                <span class="k">return</span> <span class="n">KERN_UREFS_OVERFLOW</span><span class="p">;</span>
            <span class="p">}</span>
</pre></div>


<p>所以通过断点</p>
<div class="codehilite"><pre><span></span>b *<span class="o">(</span>0xffffff80002e6fbb + kslide<span class="o">)</span>
</pre></div>


<p>就可以得到漏洞触发时的情况。</p>
<p><img alt="" src="https://raw.githubusercontent.com/turingH/BLOGIMAGE/master/png/CVE-2016-7637-%E5%86%8D%E8%B0%88Mach-IPC/%E8%A7%A6%E5%8F%91.png" /></p>
<h3>2.4  port替换的原理是什么?</h3>
<p>port是通过<code>port name</code>在task中来获取的。在前文中提到，<code>namep</code>是通过函数<code>ipc_entry_alloc</code>来获取的。查看获取到<code>namep</code>的核心代码如下：</p>
<div class="codehilite"><pre><span></span><span class="n">kern_return_t</span>
<span class="nf">ipc_entry_claim</span><span class="p">(</span>
    <span class="n">ipc_space_t</span>     <span class="n">space</span><span class="p">,</span>
    <span class="n">mach_port_name_t</span>    <span class="o">*</span><span class="n">namep</span><span class="p">,</span>
    <span class="n">ipc_entry_t</span>     <span class="o">*</span><span class="n">entryp</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">ipc_entry_t</span> <span class="n">entry</span><span class="p">;</span>
    <span class="n">ipc_entry_t</span> <span class="n">table</span><span class="p">;</span>
    <span class="n">mach_port_index_t</span> <span class="n">first_free</span><span class="p">;</span>
    <span class="n">mach_port_gen_t</span> <span class="n">gen</span><span class="p">;</span>
    <span class="n">mach_port_name_t</span> <span class="n">new_name</span><span class="p">;</span>

    <span class="n">table</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">space</span><span class="o">-&gt;</span><span class="n">is_table</span><span class="p">[</span><span class="mi">0</span><span class="p">];</span>

    <span class="n">first_free</span> <span class="o">=</span> <span class="n">table</span><span class="o">-&gt;</span><span class="n">ie_next</span><span class="p">;</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">first_free</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">);</span>

    <span class="n">entry</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">table</span><span class="p">[</span><span class="n">first_free</span><span class="p">];</span>  <span class="c1">//[1]</span>
    <span class="n">table</span><span class="o">-&gt;</span><span class="n">ie_next</span> <span class="o">=</span> <span class="n">entry</span><span class="o">-&gt;</span><span class="n">ie_next</span><span class="p">;</span>
    <span class="n">space</span><span class="o">-&gt;</span><span class="n">is_table_free</span><span class="o">--</span><span class="p">;</span>

    <span class="n">assert</span><span class="p">(</span><span class="n">table</span><span class="o">-&gt;</span><span class="n">ie_next</span> <span class="o">&lt;</span> <span class="n">space</span><span class="o">-&gt;</span><span class="n">is_table_size</span><span class="p">);</span>

    <span class="cm">/*</span>
<span class="cm">     *  Initialize the new entry.  We need only</span>
<span class="cm">     *  increment the generation number and clear ie_request.</span>
<span class="cm">     */</span>
    <span class="n">gen</span> <span class="o">=</span> <span class="n">IE_BITS_NEW_GEN</span><span class="p">(</span><span class="n">entry</span><span class="o">-&gt;</span><span class="n">ie_bits</span><span class="p">);</span> <span class="c1">//[2]</span>
    <span class="n">entry</span><span class="o">-&gt;</span><span class="n">ie_bits</span> <span class="o">=</span> <span class="n">gen</span><span class="p">;</span>
    <span class="n">entry</span><span class="o">-&gt;</span><span class="n">ie_request</span> <span class="o">=</span> <span class="n">IE_REQ_NONE</span><span class="p">;</span>

    <span class="cm">/*</span>
<span class="cm">     *  The new name can&#39;t be MACH_PORT_NULL because index</span>
<span class="cm">     *  is non-zero.  It can&#39;t be MACH_PORT_DEAD because</span>
<span class="cm">     *  the table isn&#39;t allowed to grow big enough.</span>
<span class="cm">     *  (See comment in ipc/ipc_table.h.)</span>
<span class="cm">     */</span>
    <span class="n">new_name</span> <span class="o">=</span> <span class="n">MACH_PORT_MAKE</span><span class="p">(</span><span class="n">first_free</span><span class="p">,</span> <span class="n">gen</span><span class="p">);</span> <span class="c1">//[3]</span>
    <span class="n">assert</span><span class="p">(</span><span class="n">MACH_PORT_VALID</span><span class="p">(</span><span class="n">new_name</span><span class="p">));</span>
    <span class="o">*</span><span class="n">namep</span> <span class="o">=</span> <span class="n">new_name</span><span class="p">;</span>
    <span class="o">*</span><span class="n">entryp</span> <span class="o">=</span> <span class="n">entry</span><span class="p">;</span>

    <span class="k">return</span> <span class="n">KERN_SUCCESS</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>通过[1]可以看到，正如2.2节提到的一样，<code>entry</code>在<code>table</code>中的<code>index</code>是不变的。</p>
<p>通过[2]可以看到，每次使用<code>entry</code>来存放一个新<code>port</code>时，<code>gen</code>的值会加1。</p>
<p>通过[3]可以看到，<code>namep</code>就是通过这两个参数生成的。</p>
<p>因为<code>index</code>是不变的，所以在通过漏洞释放target_port之后，不断的对目标<code>entry</code>进行申请和释放，就可以通过整形溢出，使得<code>gen</code>变成和taget_port释放之前使用的entry相同。</p>
<p>那么就实现了在<code>port_name</code>不变的情况下替换了<code>port</code>的内核对象。</p>
<h2>0x03 小结</h2>
<p>通过CVE-2016-7637的分析和研究加深了对<code>port</code>这个数据结构的理解，并且通过对<code>poc</code>的分析，体现了一个<code>port</code>在单个<code>task</code>中的状态变化，实际上是<code>ipc_space</code>和<code>ipc_entry</code>状态变化。</p>
<p>接下来就要分析学习CVE-2016-7644，通过对CVE-2016-7644的分析学习，可以更加深入的理解port在内核中状态的变化。也就是<code>port</code>自身的<code>port-&gt;srights</code>和<code>io_reference</code>的状态变化及漏洞的利用。</p>
<h2>参考</h2>
<ol>
<li>
<p>《Mac OS X Internals》</p>
</li>
<li>
<p><a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=959&amp;can=1&amp;q=apple&amp;sort=-id">Broken kernel mach port name uref</a></p>
</li>
</ol>
      
<hr>
<p><img src="https://images.seebug.org/content/images/2017/08/0e69b04c-e31f-4884-8091-24ec334fbd7e.jpeg" alt="Paper" style="width: 220px">
本文由 Seebug Paper 发布，如需转载请注明来源。本文地址：<a href="https://paper.seebug.org/197/">https://paper.seebug.org/197/</a></p>
            
    </section>

  <nav class="pagination" role="navigation" style="padding: 3rem;">
    
      <a class="newer-posts" href="/196/"><span aria-hidden="true">&larr;</span> 浏览器漏洞利用学习篇之 Internet Explor...</a>
    
    
      <a class="older-posts" href="/199/">Jenkins-LDAP (CVE-2016-9299... <span aria-hidden="true">&rarr;</span></a>
    
  </nav>


    

      
    
    <br>
    <section class="plugin_comment">
    </section>

  </article>
  <section class="plugin_feedback"></section>


  </div>
</main>
</div>

<script type="text/javascript" src="/static/js/jquery.min.js"></script>
<script type="text/javascript" src="/static/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/static/js/index.js"></script>
<script type="text/javascript" src="/static/js/prism-loader.js"></script>
<script type="text/javascript" src="/static/js/prism.js"></script>
<script type="text/javascript" src="/static/js/jquery.ghostHunter.js"></script>
<script type="text/javascript" src="/static/js/js.cookie.js"></script>
<script type="text/javascript" src="/static/js/custom.js?t=20170821"></script>
<script type="text/javascript" src="https://www.seebug.org/static/dist2/scripts/comment_main.js"></script>
<script type="text/javascript" src="https://www.seebug.org/static/dist2/scripts/plugin_feedback.js"></script>
</body>

</html>
