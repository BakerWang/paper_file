<!DOCTYPE html>


<html xmlns:wb="http://open.weibo.com/wb">

<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta property="wb:webmaster" content="ccd3e79934f3322d"/>
  <title>Microsoft Edge:插件检测</title>
  <meta name="keywords" content="漏洞文档,漏洞分析,安全技术"/>
  <meta name="description" content=""/>

  <meta name="HandheldFriendly" content="True"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <link rel="shortcut icon" href="/static/images/favicon.ico">
  <link rel="stylesheet" type="text/css" href="/static/css/screen.css"/>
  <link rel="stylesheet" type="text/css" href="/static/css/font.css"/>
  <link rel="stylesheet"
        href="//libs.baidu.com/fontawesome/4.0.3/css/font-awesome.min.css">
  <link rel="stylesheet" type="text/css" href="/static/css/prism.css"/>
  <link rel="stylesheet" type="text/css" href="/static/css/monokai.css" media="screen"/>
  <link rel="stylesheet" type="text/css" href="/static/css/custom.css?t=20170821"/>
  <link rel="stylesheet" type="text/css" href="/static/css/print.css?t=20170821" media="print"/>
  <script>
    var _hmt = _hmt || [];
    (function () {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?ef67a70a7641da3b52452a05b3bbecae";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


</head>

<body class="home-template">
<div class="weixin-share-img" style="display: none">
  <img src="/static/images/weixin-share.png" alt="Paper"/>
</div>

<div id="wrapper" class="">

<div id="sidebar">
  <button type="button" class="hamburger is-closed" data-toggle="offcanvas">
    <span class="hamb-top"></span>
    <span class="hamb-middle"></span>
    <span class="hamb-bottom"></span>
  </button>
  <div id="sidebar-content" class="inner">
    <h2 class="blog-title"><a href="/">Paper</a></h2>
    <h3 class="blog-description">安全技术精粹</h3>

    <form id="search" action="/">
      <button type="submit" style="background: #13313f; border: #13313f; position: absolute; right: -4px; margin-top: -3px;">
        <i class="fa fa-search search-button" style="position: absolute;right:10px; margin-top:6px;" > </i>
      </button>
      <input id="search-field" name="keyword" value="" placeholder="Search"/>

    </form>
    <div class="overlay"></div>
    <div id="sidebar-links">
      <ul id="subscription-links">
        <li><a target="_blank" href="/rss/"><i class="fa fa-rss"></i>RSS 订阅</a>
        </li>
        <li><a href="https://www.seebug.org/contribute/paper"><i
            class="fa fa-envelope-o"></i>投稿</a></li>
      </ul>
      <ul id="navigation">
        <li class="nav-" role="presentation"><a href="/"><i
            class="fa fa-angle-right"></i>首页</a></li>
        
  <li class="nav-" role="presentation"><a href="/category/vul-analysis/"><i
      class="fa fa-angle-right"></i>漏洞分析</a></li>

  <li class="nav-" role="presentation"><a href="/category/tools/"><i
      class="fa fa-angle-right"></i>安全工具&amp;安全开发</a></li>

  <li class="nav-" role="presentation"><a href="/category/information/"><i
      class="fa fa-angle-right"></i>情报分析</a></li>

  <li class="nav-" role="presentation"><a href="/category/experience/"><i
      class="fa fa-angle-right"></i>经验心得</a></li>

  <li class="nav-" role="presentation"><a href="/category/web-security/"><i
      class="fa fa-angle-right"></i>Web安全</a></li>

  <li class="nav-" role="presentation"><a href="/category/bin-security/"><i
      class="fa fa-angle-right"></i>二进制安全</a></li>

  <li class="nav-" role="presentation"><a href="/category/mobile-security/"><i
      class="fa fa-angle-right"></i>移动安全</a></li>

  <li class="nav-" role="presentation"><a href="/category/paper-archive/"><i
      class="fa fa-angle-right"></i>纸篓</a></li>

  <li class="nav-" role="presentation"><a href="/category/prime/"><i
      class="fa fa-angle-right"></i>安全基础&amp;教学篇</a></li>


        <li class="nav-" role="presentation"><a href="/call-for-paper/"><i
            class="fa fa-angle-right"></i>如何投稿</a></li>
        <li class="nav-" role="presentation"><a href="https://paper.seebug.org/papers/"><i
            class="fa fa-angle-right"></i>归档文件</a></li>
      </ul>
      <ul id="sidebar-external">
      </ul>
    </div>

    <footer class="site-footer">
      <section class="copyright">Copyright @ 404 Team from Knownsec.</section>
    </footer>
  </div>
</div>

<main>
  <div class="main-inner">
    <section id="results"></section>
    
  <article class="">
    <header class="post-header">

      <h1 class="post-title">Microsoft Edge:插件检测</h1>

      <span class="post-print">
        <a href="javascript:window.print()">
        <i class="fa fa-print fa-2x" aria-hidden="true"></i>
        </a>
      </span>
      <section class="post-meta">
        <span class="post-time">
          <i class='fa fa-calendar'></i>
          <time datetime="2017-04-08" class="timeago">5 月，2 周 之前</time>
          <time datetime="2017-04-08" class="fulldate">四月 08, 2017</time>
        </span>
        
          <br>
          <i class='fa fa-tag'></i>
          
            <a href="/category/web-security/">Web安全</a>
            
          
        








      </section>
    </header>

    <section class="post-content">
      <p><input type="hidden" class="Authorrss" value="Holic" name="#"></p>
<p>原文：<a href="https://www.brokenbrowser.com/microsoft-edge-detecting-installed-extensions/">brokenbrowser</a><br />
原作者：<a href="https://twitter.com/magicmac2000">Manuel Caballero</a><br />
译：<strong>Holic (知道创宇404安全实验室)</strong></p>
<p>攻击者喜欢收集受害者的指纹特征。我们之前已经见识了两种技术，坏人可以通过检测特定文件（来逃避分析人员），甚至可以获取特定关联应用的名称。Microsoft 修补了诸如此类的特性，而今天我们会看到如何在 Edge 上检测安装的浏览器扩展程序。</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/04/01-edge-excluded.png-w331s" /></p>
<p>另外，如此精彩的研究和 PoC 来自于 <a href="https://twitter.com/PrivaticsInria">Inria Privatics</a>, <a href="https://twitter.com/GulyasGG">Gábor Gulyás</a> 和 <a href="https://twitter.com/nataliabielova">Nataliia Bielova</a>。</p>
<h3>安装扩展程序</h3>
<p>我在扩展应用商店随意选了 AdGuard 广告屏蔽插件。两次点击之后，它已经安装并自动打开感谢页面，而且在开始研究之前给了我灵感。下面一探究竟。</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/04/02-thank-you.png-w331s" /></p>
<p>这一切从 URL 开始。如果我们可以在 iframe 中加载之，并检测其存在 (onload/onreadystatechange/不胜枚举)，即区分出它与默认的 Edge 404 页面， 我们基本就完成任务了。但很不幸，iframe 拒绝加载 <em>ms-browser-extension:</em> 协议。</p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;iframe</span> <span class="na">src=</span><span class="s">&quot;ms-browser-extension://EdgeExtension_AdguardAdguardAdBlocker_m055xr0c82818/pages/thankyou.html&quot;</span><span class="nt">&gt;&lt;/iframe&gt;</span>
</pre></div>


<p><img alt="" src="https://images.seebug.org/content/images/2017/04/03-iframe-fails.png-w331s" /></p>
<p>OK。那么用 window.open 又如何？至少可以用脚本打开这些 URL 吧？试一下便知！</p>
<div class="codehilite"><pre><span></span><span class="nx">win</span> <span class="o">=</span> <span class="nb">window</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s2">&quot;ms-browser-extension://EdgeExtension_AdguardAdguardAdBlocker_m055xr0c82818/pages/thankyou.html&quot;</span><span class="p">);</span>
<span class="c1">// returns null when the URL is ms-browser-extension: (not useful for us)</span>
</pre></div>


<p><img alt="" src="https://images.seebug.org/content/images/2017/04/04-open-null.png-w331s" /></p>
<p>打开了！但是对我们并不重要，因为不管安没安装插件， window.open() 返回的都是 null 而不是 window 对象。换而言之，我们试图使用扩展程序协议 <em>ms-browser-extension</em> 打开新窗口时：它总是返回 null 的。所以即使能打开新窗口（这是个很丑的解决方案），我们也不能检验内容是否得以加载。</p>
<p>来自扩展程序的图片呢？或许图像暴露在主页的时候，使用 onload/onerror 事件，我们可以检测到扩展程序是否安装。我们先看看扩展文件在我们文件系统中的位置。</p>
<h3>查找扩展程序相关文件</h3>
<p>启动 Process Monitor，过滤 MicrosoftEdgeCP.exe。关闭 Edge，并通过复制到地址栏的方法打开 AdGuard 感谢页面，Bang！我们马上就能在 Process Monitor 中看到文件所在的位置。记住，我们的目标是从这个扩展程序中找出一个图像，看看能否加载它，并通过 onload/onerror 检测其存在。</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/04/05-procmon.png-w331s" /></p>
<p>看来扩展程序文件在这里：</p>
<div class="codehilite"><pre><span></span>C:\Program Files\WindowsApps\Adguard.AdguardAdBlocker_2.5.18.0_neutral__m055xr0c82818\Extension\Pages
</pre></div>


<p>转到上层（父）文件夹，我们可以看到，就像 Chrome 和 Firefox，其中有个 manifest.json，允许某些资源被任何网站加载。</p>
<div class="codehilite"><pre><span></span>&quot;web_accessible_resources&quot;: [
   &quot;elemhidehit.png&quot;, 
   &quot;lib/content-script/assistant/css/assistant.css&quot;, 
   &quot;lib/content-script/assistant/i/close.svg&quot;, 
   &quot;lib/content-script/assistant/i/logo.svg&quot;, // Let&#39;s use this one!
   &quot;lib/content-script/assistant/i/logo-white.svg&quot;
]
</pre></div>


<p>其中大多是图像，我们用脚本试着加载 <strong>logo.svg</strong>。如果 onload 得以触发，说明扩展程序已安装，否则说明用户没有该扩展名。</p>
<div class="codehilite"><pre><span></span><span class="kd">var</span> <span class="nx">img</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">Image</span><span class="p">();</span>

<span class="nx">img</span><span class="p">.</span><span class="nx">onload</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span><span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Extension Detected&quot;</span><span class="p">)}</span>
<span class="nx">img</span><span class="p">.</span><span class="nx">onerror</span> <span class="o">=</span> <span class="kd">function</span><span class="p">(){</span><span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Extension NOT Detected&quot;</span><span class="p">)}</span>

<span class="nx">img</span><span class="p">.</span><span class="nx">src</span> <span class="o">=</span> <span class="s2">&quot;ms-browser-extension://EdgeExtension_AdguardAdguardAdBlocker_m055xr0c82818/lib/content-script/assistant/i/logo.svg&quot;</span><span class="p">;</span>
</pre></div>


<p><img alt="" src="https://images.seebug.org/content/images/2017/04/06-adguard-detected.png-w331s" /></p>
<p>而我并不为之所动。我们基本上没有用到什么新的东西，就像其他检测方法一样（对应 Chrome/FF），我们依赖于特定扩展程序的配合，使资源得以加载。如果一个扩展程序在 manifest 中没有 <strong>web 可访问资源</strong> 的话，我们如何检测呢？</p>
<h3>插件检测的通用方法</h3>
<p>在各种技巧玩了几分钟，试着加载不可访问的资源后，我决定厂商用类似于 <a href="https://soroush.secproject.com/blog/2013/04/microsoft-xmldom-in-ie-can-divulge-information-of-local-drivenetwork-in-error-messages/">Soroush 的 IE DTD</a> 技巧。试着使用 Microsoft XMLDOM 对象加载资源，并根据错误号就能知道文件是否存在。在 Edge 上没有 XMLDOM 对象，但是我们可以做一些就像常规 XMLHTTPRequest 做的事情。</p>
<p>如果尝试打开资源而且扩展程序存在的话，它会抛出拒绝访问的错误，否则是文件找不到的错误。实际上，为了纪念 Soroush 的神奇发现，我们尽量做的和他一样优雅，并使用接受到的错误号进行判断。一段代码值千言，请看下面：</p>
<div class="codehilite"><pre><span></span><span class="kd">var</span> <span class="nx">extension</span> <span class="o">=</span> <span class="s2">&quot;ms-browser-extension://EdgeExtension_AdguardAdguardAdBlocker_m055xr0c82818&quot;</span><span class="p">;</span>
<span class="k">try</span>
<span class="p">{</span>
     <span class="kd">var</span> <span class="nx">xhr</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">XMLHttpRequest</span><span class="p">();</span>
     <span class="nx">xhr</span><span class="p">.</span><span class="nx">open</span><span class="p">(</span><span class="s2">&quot;GET&quot;</span><span class="p">,</span> <span class="nx">extension</span><span class="p">,</span> <span class="kc">false</span><span class="p">);</span>
     <span class="nx">xhr</span><span class="p">.</span><span class="nx">send</span><span class="p">(</span><span class="kc">null</span><span class="p">);</span>
<span class="p">}</span>
<span class="k">catch</span><span class="p">(</span><span class="nx">e</span><span class="p">)</span>
<span class="p">{</span>
     <span class="k">if</span> <span class="p">(</span><span class="nx">e</span><span class="p">.</span><span class="nx">number</span> <span class="o">==</span> <span class="o">-</span><span class="mi">2147024891</span><span class="p">)</span> <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Exists&quot;</span><span class="p">);</span>
     <span class="k">else</span> <span class="nx">alert</span><span class="p">(</span><span class="s2">&quot;Does not exist&quot;</span><span class="p">);</span>
<span class="p">}</span>
</pre></div>


<p><img alt="" src="https://images.seebug.org/content/images/2017/04/07-adguard-detected-generic.png-w331s" /></p>
<p>现在看起来不错了，感谢 <a href="https://twitter.com/irsdl">Soroush</a> 的精彩思路！</p>
<p>另外，你有没有注意到我们使用的URL甚至没有指向特定资源？这个 xml技巧与目录名有关，甚至不需要指向扩展程序的特定资源，所以现在有插件的 ID 就足以进行检测了。如果要构建一个通用探针来查找已经安装的扩展程序，就像我们在 Chrome 和 Firefox 中见过的<a href="https://extensions.inrialpes.fr/">这种</a>，首先要再 Edge 上安装所以的扩展程序，并记下所有的 ID。这颇为简单，只需要安装扩展程序，加载空白页，按下 F12，就足以展现插件的 ID。我已经安装的其中的几个，在下方清晰可见。</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/04/08-extension-ids.png-w331s" /></p>
<p>有了这些名称，现在可以为 Microsoft Edge 创建一个通用扩展检测器了。只有已禁用的扩展程序才不会在开发人员工具中加载，不过我们仍可以在注册表中找到它们。</p>
<div class="codehilite"><pre><span></span>HKEY_CLASSES_ROOT\Local Settings\Software\Microsoft\Windows\CurrentVersion\AppContainer\Storage\microsoft.microsoftedge_8wekyb3d8bbwe\MicrosoftEdge\Extensions
</pre></div>


<p>有一点值得注意，<strong>即使用户已经禁用扩展程序</strong>，我们的检测方法依然有效。以下便是用上述方法检测20个扩展的PoC。</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/04/09-installed-extensions-poc.png-w331s" /></p>
<p><strong><a href="https://www.cracking.com.ar/demos/edgeinstalledextensions/">[ PoC – Edge Detect Installed Extensions ]</a></strong></p>
<p>Have a nice day! ?</p>
      
<hr>
<p><img src="https://images.seebug.org/content/images/2017/08/0e69b04c-e31f-4884-8091-24ec334fbd7e.jpeg" alt="Paper" style="width: 220px">
本文由 Seebug Paper 发布，如需转载请注明来源。本文地址：<a href="https://paper.seebug.org/266/">https://paper.seebug.org/266/</a></p>
            
    </section>

  <nav class="pagination" role="navigation" style="padding: 3rem;">
    
      <a class="newer-posts" href="/265/"><span aria-hidden="true">&larr;</span> 一键无文件感染</a>
    
    
      <a class="older-posts" href="/268/">CVE-2017-2416 GIF表情引发的远程代码执行 <span aria-hidden="true">&rarr;</span></a>
    
  </nav>


    

      
        <footer class="post-footer">
          <figure class="author-image">
            <a class="img" href="/users/author/?nickname=Holic"
               style="background-image: url(https://images.seebug.org/uploads/2017/08/avatar.png)"><span
                class="hidden">'s Picture</span></a>
          </figure>

          <section class="author">
            <h4><a
                href="/users/author/?nickname=Holic">Holic</a>
            </h4>
            <p>阅读更多有关<a
                href="/users/author/?nickname=Holic">该作者</a>的文章
            </p>
            
            <div class="author-meta">
            </div>
          </section>

          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          

        </footer>
      
    
    <br>
    <section class="plugin_comment">
    </section>

  </article>
  <section class="plugin_feedback"></section>


  </div>
</main>
</div>

<script type="text/javascript" src="/static/js/jquery.min.js"></script>
<script type="text/javascript" src="/static/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/static/js/index.js"></script>
<script type="text/javascript" src="/static/js/prism-loader.js"></script>
<script type="text/javascript" src="/static/js/prism.js"></script>
<script type="text/javascript" src="/static/js/jquery.ghostHunter.js"></script>
<script type="text/javascript" src="/static/js/js.cookie.js"></script>
<script type="text/javascript" src="/static/js/custom.js?t=20170821"></script>
<script type="text/javascript" src="https://www.seebug.org/static/dist2/scripts/comment_main.js"></script>
<script type="text/javascript" src="https://www.seebug.org/static/dist2/scripts/plugin_feedback.js"></script>
</body>

</html>
