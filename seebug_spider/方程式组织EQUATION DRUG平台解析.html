<!DOCTYPE html>


<html xmlns:wb="http://open.weibo.com/wb">

<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta property="wb:webmaster" content="ccd3e79934f3322d"/>
  <title>方程式组织EQUATION DRUG平台解析</title>
  <meta name="keywords" content="漏洞文档,漏洞分析,安全技术"/>
  <meta name="description" content=""/>

  <meta name="HandheldFriendly" content="True"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <link rel="shortcut icon" href="/static/images/favicon.ico">
  <link rel="stylesheet" type="text/css" href="/static/css/screen.css"/>
  <link rel="stylesheet" type="text/css" href="/static/css/font.css"/>
  <link rel="stylesheet"
        href="//libs.baidu.com/fontawesome/4.0.3/css/font-awesome.min.css">
  <link rel="stylesheet" type="text/css" href="/static/css/prism.css"/>
  <link rel="stylesheet" type="text/css" href="/static/css/monokai.css" media="screen"/>
  <link rel="stylesheet" type="text/css" href="/static/css/custom.css?t=20170821"/>
  <link rel="stylesheet" type="text/css" href="/static/css/print.css?t=20170821" media="print"/>
  <script>
    var _hmt = _hmt || [];
    (function () {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?ef67a70a7641da3b52452a05b3bbecae";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


</head>

<body class="home-template">
<div class="weixin-share-img" style="display: none">
  <img src="/static/images/weixin-share.png" alt="Paper"/>
</div>

<div id="wrapper" class="">

<div id="sidebar">
  <button type="button" class="hamburger is-closed" data-toggle="offcanvas">
    <span class="hamb-top"></span>
    <span class="hamb-middle"></span>
    <span class="hamb-bottom"></span>
  </button>
  <div id="sidebar-content" class="inner">
    <h2 class="blog-title"><a href="/">Paper</a></h2>
    <h3 class="blog-description">安全技术精粹</h3>

    <form id="search" action="/">
      <button type="submit" style="background: #13313f; border: #13313f; position: absolute; right: -4px; margin-top: -3px;">
        <i class="fa fa-search search-button" style="position: absolute;right:10px; margin-top:6px;" > </i>
      </button>
      <input id="search-field" name="keyword" value="" placeholder="Search"/>

    </form>
    <div class="overlay"></div>
    <div id="sidebar-links">
      <ul id="subscription-links">
        <li><a target="_blank" href="/rss/"><i class="fa fa-rss"></i>RSS 订阅</a>
        </li>
        <li><a href="https://www.seebug.org/contribute/paper"><i
            class="fa fa-envelope-o"></i>投稿</a></li>
      </ul>
      <ul id="navigation">
        <li class="nav-" role="presentation"><a href="/"><i
            class="fa fa-angle-right"></i>首页</a></li>
        
  <li class="nav-" role="presentation"><a href="/category/vul-analysis/"><i
      class="fa fa-angle-right"></i>漏洞分析</a></li>

  <li class="nav-" role="presentation"><a href="/category/tools/"><i
      class="fa fa-angle-right"></i>安全工具&amp;安全开发</a></li>

  <li class="nav-" role="presentation"><a href="/category/information/"><i
      class="fa fa-angle-right"></i>情报分析</a></li>

  <li class="nav-" role="presentation"><a href="/category/experience/"><i
      class="fa fa-angle-right"></i>经验心得</a></li>

  <li class="nav-" role="presentation"><a href="/category/web-security/"><i
      class="fa fa-angle-right"></i>Web安全</a></li>

  <li class="nav-" role="presentation"><a href="/category/bin-security/"><i
      class="fa fa-angle-right"></i>二进制安全</a></li>

  <li class="nav-" role="presentation"><a href="/category/mobile-security/"><i
      class="fa fa-angle-right"></i>移动安全</a></li>

  <li class="nav-" role="presentation"><a href="/category/paper-archive/"><i
      class="fa fa-angle-right"></i>纸篓</a></li>

  <li class="nav-" role="presentation"><a href="/category/prime/"><i
      class="fa fa-angle-right"></i>安全基础&amp;教学篇</a></li>


        <li class="nav-" role="presentation"><a href="/call-for-paper/"><i
            class="fa fa-angle-right"></i>如何投稿</a></li>
        <li class="nav-" role="presentation"><a href="https://paper.seebug.org/papers/"><i
            class="fa fa-angle-right"></i>归档文件</a></li>
      </ul>
      <ul id="sidebar-external">
      </ul>
    </div>

    <footer class="site-footer">
      <section class="copyright">Copyright @ 404 Team from Knownsec.</section>
    </footer>
  </div>
</div>

<main>
  <div class="main-inner">
    <section id="results"></section>
    
  <article class="">
    <header class="post-header">

      <h1 class="post-title">方程式组织EQUATION DRUG平台解析</h1>

      <span class="post-print">
        <a href="javascript:window.print()">
        <i class="fa fa-print fa-2x" aria-hidden="true"></i>
        </a>
      </span>
      <section class="post-meta">
        <span class="post-time">
          <i class='fa fa-calendar'></i>
          <time datetime="2017-01-17" class="timeago">8 月 之前</time>
          <time datetime="2017-01-17" class="fulldate">一月 17, 2017</time>
        </span>
        
          <br>
          <i class='fa fa-tag'></i>
          
            <a href="/category/information/">情报分析</a>
            
          
        








      </section>
    </header>

    <section class="post-content">
      <p>作者：<a href="http://www.antiy.com/response/EQUATIONS/EQUATIONS.html">安天安全研究与应急处理中心（Antiy CERT）</a></p>
<blockquote>
<p>— 方程式组织系列分析报告之四</p>
<p>安天安全研究与应急处理中心（Antiy CERT）</p>
</blockquote>
<ul>
<li>报告初稿完成时间：2017年1月13日 16时00分</li>
<li>首次发布时间：2017年1月16日 10时00分</li>
<li>本版本更新时间：2017年1月17日 8时30分</li>
</ul>
<p><center><a href="http://www.antiy.com/response/EQUATION_DRUG/EQUATION_DRUG.pdf">PDF报告下载</a></center></p>
<h2>1 本版本更新小语</h2>
<p>安天在此前发布的报告版本的基础上，增加了一个方程式组织主机作业的模块积木图。这个积木图初步展示了一个将主机情报作业按照<strong>"原子化"拆分</strong>的模块组合的拼装，在本版本中安天CERT也细化了对部分模块的分析，尽管目前的分析只覆盖这些模块的一少部分。</p>
<p>在数天前，安天CERT把这份暂时称为"提纲"的未完成分析结果发布出来，这并非因为我们期望"速战速决"，而草率地发布一点粗浅的进展，而是我们需要获得更多的建议和批判。所幸的是，在上一版本发布后，获得了业内专家中肯而尖锐的批评，让安天认识到，在面对这组2007~2008年的攻击模块集合时，分析小组再次出现了和当年分析"火焰"时一样的迷茫（尽管安天曾经一度以为自己比那时更清晰）。这些庞杂的模块展开了一组拼图碎片，每一张图上都是有意义的图案，但如果逐一跟进进去，这些图案就会组成一个巨大的迷宫。迷宫之所以让人迷惑，不在于其处处是死路，而在于其看起来处处有出口，但所有的砖块都不能给进入者以足够的提示。此时，最大的期待，不只是有一只笔，可以在走过的地方做出标记，而是插上双翼凌空飞起，俯瞰迷宫的全貌。当然这是一种提升分析方法论的自我期待，我辈当下虽身无双翼，但或可练就一点灵犀。</p>
<p>目前安天的积木还原工作还刚刚起步，对于能够在中国的传统节日春节前，发布出分析报告的新版本，安天还是有些许欣慰的。网络安全注定是一个需要永远保持警惕和勤奋的行业，我们的分析工作会持续进行下去，即使是在焰火升腾，鞭炮响起的时刻，依然需要有紧盯反汇编代码和威胁态势的眼睛。</p>
<p>感谢业内专家同仁对安天的关注和支持，感谢安天客户对安天产品与服务的信任，祝大家新春快乐！</p>
<h2>2  背景</h2>
<p>对于方程式组织，在过去的两年中，安天已经连续发布了三篇分析报告：在《修改硬盘固件的木马--探索方程式（EQUATION）组织的攻击组件》<sup>[1]</sup> 中，安天对多个模块进行了分析，并对其写入硬盘固件的机理进行了分析验证；在《方程式（EQUATION）部分组件中的加密技巧分析》<sup>[2]</sup>报告中，对攻击组件中使用的加密方式实现了破解；在《从"方程式"到"方程组"--EQUATION攻击组织高级恶意代码的全平台能力解析》<sup>[3]</sup>报告中，安天独家提供了方程式在Linux和Solaris系统的样本分析，这也是业内首次正式证实这些"恶灵"真实存在的公开分析。</p>
<p>APT的分析成果，与研发反APT产品一样，都要基于充分的基础积累，而不可能"一夜之间建成罗马"。对于方程式这样大至无形的超级攻击组织来说，安天过去所做的具体的分析工作都是盲人摸象的过程，一旦飘忽的线索落入安天已经摸索过的范围之内，就可以迅速发布储备成果，而如果面对的是一个未曾充分探查的区域，则需要更长的时间展开分析工作，因此与安天此前已经发布的三篇方程式的长篇报告相比，本篇报告目前的版本依然是比较仓促的，因此安天会坚持称之为"提纲"，旨在能抛砖引玉，邀请更多兄弟团队共同加入分析工作，以便进一步呈现出其全貌。</p>
<p>本篇展现的分析工作是围绕2017年1月12日"影子经纪人"放出Equation Group 组件中的61个文件<sup>[4]</sup> 而展开的。经分析，在本次放出的61个文件中，其中含有Equation Group 组件和DanderSpritZ（RAT）工具中的一些插件。DanderSpritZ是NSA（National Security Agency）的间谍工具之一，在1月7号"影子经纪人"放出的Windows攻击工具<sup>[5]</sup>中也包含了大量DanderSpritZ的插件名称。</p>
<p>组件EquationDrug是一个很复杂的模块，其存活时间有近10年，后来被GrayFish升级替代。从EquationDrug到GrayFish是攻击平台级别的恶意代码体系，具有安装与卸载插件功能。在本次"影子经纪人"放出的文件中，安天CERT看到了更多的EquationDrug组件中的插件。通过分析比对发现，这些插件比之前安天分析过的插件版本低，但其中包含了一些此前未曾被业内捕获到的模块。</p>
<h2>3          方程式线索曝光和分析成果时间链梳理</h2>
<p>从2013年起，安天从样本分析中，逐步发现存在一个拥有全平台载荷攻击能力的攻击组织，并逐步关联分析了其多个平台的样本。在这个过程中，安天感到一个大至无形的超级攻击组织的存在，但并未找到其攻击背景。</p>
<p>2015年2月，卡巴斯基实验室曝光了一个名为方程式（Equation Group）<sup>[6]</sup>的攻击组织，引发了全球关注，卡巴斯基认为该组织已活跃近20年，可能是目前世界上存在的最复杂的APT攻击组织之一，并认为该组织是震网（Stuxnet）和火焰（Flame）病毒幕后的操纵者。经过线索比对，安天发现这正是此前一直跟踪的超级攻击组织，决定通过报告公开其针对硬盘固件作业的原理<sup>[1]</sup>和已破解的其部分加密算法<sup>[2]</sup>，形成了安天对于方程式系列分析的前两篇报告。</p>
<p>2015年3月，卡巴斯基实验室发布了基于Equation Drug组件或平台的剖析<sup>[7]</sup>，Equation Drug是方程式组织所用的主要间谍组件或平台之一，最早可追溯到2001年，并且一直沿用至今。该组件或平台的架构类似于一个具有内核模式和用户模式的微型操作系统，通过自定义接口进行交互。该组件或平台包括驱动程序、平台内核（协调器）和若干插件，其中一些插件配备独特的ID和版本号，用于定义相关功能等。</p>
<p>2016年8月，一个自称"影子经纪人"（The Shadow Brokers）的个人（或组织）声称入侵了网络间谍组织方程式（Equation）<sup>[8]</sup>，并以100万比特币（当时约价值为5.6亿美元）的价格，公开"拍卖"所掌握的方程式组织的攻击工具，方程式组织被认为与NSA存在联系。为证明成功入侵的真实性，"影子经纪人"于当月13日在开源项目托管平台GitHub加密发布了这些攻击工具，并有意将其中的少量攻击工具以明文形式发布。</p>
<p>2016年8月，卡巴斯基实验室通过对方程式组织与"影子经纪人"曝光的数据进行对比验证<sup>[9]</sup>，确认了曝光的数据与方程式组织有关。2016年10月，"影子经纪人"对攻击工具再度发起拍卖<sup>[10]</sup>，并称在GitHub发布的方程式攻击工具只占其掌握的60%。</p>
<p>2016年11月，"影子经纪人"公开了一份遭受入侵的服务器清单<sup>[11]</sup>，并称攻击方与NSA有关。清单的日期显示，各系统遭受入侵的时间是在2000年到2010年之间，受控IP及域名分布在49个国家，主要集中在亚太地区，受影响的国家包括中国、日本、韩国、西班牙、德国、印度等。 安天将这些数据导入到安天态势感知和预警平台，形成了下图的可视化展现。</p>
<p>在"影子经纪人"的爆料中，提及的相关服务器可能是Linux、FreeBSD和Solaris。而在2016年上半年的两次技术会议中，安天则明确说明，方程式有针对多个系统平台的样本，其中包括Linux和Solaris。安天最终于2016年11月5日公开了方程式组织针对Linux和Solaris的部分样本载荷的分析报告（安天方程式系列报告之三）<sup>[3]</sup>。</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/01/0R00351H-0.jpg-w331s" /></p>
<p>图 3 - 1 安天态势感知与监控预警平台："方程式"组织对全球互联网节点的入侵可视化复现</p>
<p>安天分析团队小组对方程式的上述信息进行了梳理，整理出方程式事件曝光和相关分析的时间链。</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/01/0R0036111-1.PNG-w331s" /></p>
<p>图 3 - 2 方程式事件相关信息曝光和厂商分析的时间链</p>
<h2>4          DanderSpritz攻击平台</h2>
<p>安天通过对本次泄露的文件以及对以往方程式资料的分析发现，方程式组织的"EquationDrug"平台与泄露文件中提到的"DanderSpritz"具有一定内在联系：</p>
<p>1.         本次泄露的msgkd.ex_、msgki.ex_、msgks.ex_、msgku.ex_为GROK插件，是"DanderSpritz"的插件或模块，该插件在"EquationDrug"平台中也曾出现，通过分析发现本次泄露的GROK为低版本GROK插件。</p>
<p>2.         本次曝光的各类DLL插件中的一处数据为插件ID，插件ID都是以0x79开头，如：0x79A4、0x79D8，同样，"EquationDrug"平台的插件也设有内置ID，"EquationDrug"平台的插件ID为0x80开头，且两个平台的插件导出函数参数的数据结构也存在相似之处。</p>
<p>因此，基本可以认为方程式组织使用的"EquationDrug"攻击平台与"DanderSpritz"使用了相同的架构设计，两者可能是不同的版本代号，或至少来自同一开发团队或资源高度共享的团队。</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/01/0R00363R-2.png-w331s" /></p>
<p>图 4 - 1 方程式组织的DanderSpritz攻击平台</p>
<p><img alt="" src="http://antiy.cn/uploads/allimg/170117/0R0033049-3.png" /></p>
<p>图 4 - 2 "影子经纪人"泄露的"DanderSpritz"攻击平台截图</p>
<p>本次"影子经纪人"所曝光的文件中多数为"DanderSpritz"平台的攻击插件，一是文件列表，二是61个部分插件实体文件。从放出的文件列表HASH和截图来看，攻击工具和插件非常丰富且标准化，具体包括远控、漏洞利用、后门、插件等。DanderSpritz_All_Find.txt文件内容多达7千余行，其中插件有数百个之多。对泄露出来的61个文件进行分析梳理，根据样本中的一些信息推断，这61个样本应该属于两类：测试版本与发布版本。测试版本中含有一些明文信息，并没有进行加密处理，使用了常规的函数调用方式，而在发布版本中这些信息并不存在，函数调用方式也改为动态调用，更加隐蔽。从时间戳上来看，测试版本的生成时间比发布版本要早5秒左右。测试版本是不应用于实际攻击中的，从侧面也再次证实了这些文件是被从开发和保管场景窃取出来的，而不是在攻击中捕获到的。</p>
<p>表 4 - 1 泄露实体文件的部分插件功能列表
<table>
      <tr>
        <td><p><b>测试版本</b><b></p>
<pre class="codehilite"><code>    &lt;/b&gt;&lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;&lt;b&gt;发布版本&lt;/b&gt;&lt;b&gt;

    &lt;/b&gt;&lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;&lt;b&gt;功能&lt;/b&gt;&lt;b&gt;

    &lt;/b&gt;&lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;DoubleFeatureDll.dll.unfinalized

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;该模块用于创建线程执行函数，地址由调用者传入。同时，内部还有SHA256、AES、CRC32等算法。

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;p&gt;DuplicateToken_Lp.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;DuplicateToken_Implant.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;该模块用于获取Token，并执行操作。

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;DXGHLP16.SYS

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;该模块用于网络嗅探 监测以太网和VPN的流量 ，用于Windows 9x系统。

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;p&gt;EventLogEdit_Lp.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;EventLogEdit_Implant.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;该模块可对事件日志文件进行编辑。

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;p&gt;GetAdmin_Lp.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;GetAdmin_Implant.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;该模块用于获取管理员权限，并执行操作。

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;kill_Implant.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;该模块功能是结束进程，传入参数中有要结束进程的ID，该功能的实现使用了常规的系统函数，如：OpenProcess、TerminateProcess。

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;kill_Implant9x.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;该模块功能与kill_Implant.dll相同，是针对64位系统的版本。

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;p&gt;LSADUMP_Lp.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;LSADUMP_Implant.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;该模块可用来读取LSA 凭据，根据传入参数的不同执行不同的操作。

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;p&gt;modifyAudit_Lp.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;modifyAudit_Implant.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;该模块用于修改审核配置。

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;p&gt;modifyAuthentication_Lp.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;modifyAuthentication_Implant.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;该模块用于修改权限认证。

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;p&gt;ModifyGroup_Lp.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;ModifyGroup_Implant.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;该模块用于修改用户组权限。

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;p&gt;ModifyPrivilege_Lp.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;ModifyPrivilege_Implant.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;该模块用于修改用户权限。

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;msgkd.ex_

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;释放GROK键盘/剪贴板记录器驱动。

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;msgki.ex_

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;msgks.ex_

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;msgku.ex_

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;mstcp32.sys

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;该模块用于网络嗅探 监测以太网和VPN的流量 。

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;p&gt;nethide_Lp.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;nethide_Implant.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;该模块用于隐藏网络连接。

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;ntevt.sys

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;该模块是事件日志相关驱动。

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;ntevtx64.sys

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;该模块功能与ntevt.sys相同，是针对64位系统的版本。

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;p&gt;PortMap_Lp.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;PortMap_Implant.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;该模块进行端口映射。

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;p&gt;ProcessHide_Lp.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;ProcessHide_Implant.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;该模块可以进行隐藏进程，恢复隐藏的进程，根据传入参数的不同执行不同的操作。

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;processinfo_Implant.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;该模块可以用来获取进程信息。

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;processinfo_Implant9x.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;该模块功能与processinfo_Implant.dll相同，是针对64位系统的版本。

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;p&gt;ProcessOptions_Lp.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;ProcessOptions_Implant.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;该模块用于设定进程执行属性。

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;p&gt;pwdump_Lp.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;pwdump_Implant.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;该模块可用来读取系统中密码，根据传入参数的不同执行不同的操作。

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;p&gt;RunAsChild_Lp.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;RunAsChild_Implant.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;该模块用于创建子进程，并执行操作。

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;p&gt;
       
    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;tdi6.sys

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;该模块用于网络嗅探 监测以太网和VPN的流量 。

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;p&gt;PassFreely_LP.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;PassFreely_Implant.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;正在分析中

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;p&gt;...

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;
       
    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
&lt;/table&gt;</code></pre>


<p>表 4 - 2 仅泄露文件名的部分插件功能猜测</p>
<p><table>
      <tr>
        <td><p><b>测试版本</b><b></p>
<pre class="codehilite"><code>    &lt;/b&gt;&lt;/p&gt;&lt;/td&gt;
    &lt;td width=301&gt;&lt;p&gt;&lt;b&gt;发布版本&lt;/b&gt;&lt;b&gt;

    &lt;/b&gt;&lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;&lt;b&gt;猜测功能&lt;/b&gt;&lt;b&gt;

    &lt;/b&gt;&lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;p&gt;Users_Lp.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td width=301&gt;&lt;p&gt;Users_Implant.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;查看当前用户列表

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;p&gt;GroupUsers_Lp.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td width=301&gt;&lt;p&gt;GroupUsers_Implant.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;修改指定用户所在组

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;/td&gt;
    &lt;td width=301&gt;&lt;p&gt;nc.exe

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;nc网络工具

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;p&gt;ProcessCheck_Lp.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td width=301&gt;&lt;p&gt;ProcessCheck_Implant.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;检测指定进程

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;p&gt;machineinfo_LP.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td width=301&gt;&lt;p&gt;machineinfo_Implant.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;获取主机相关信息

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;p&gt;IpConfig_LP.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td width=301&gt;&lt;p&gt;IpConfig_Implant.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;IP信息获取

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;p&gt;FileAttribs_LP.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td width=301&gt;&lt;p&gt;FileAttribs_Implant.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;文件属性获取

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;p&gt;NetstatMon_LP.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td width=301&gt;&lt;p&gt;NetstatMon_Implant.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;网络状态获取

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;p&gt;Dns_LP.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td width=301&gt;&lt;p&gt;Dns_Implant.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;DNS设置获取

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;p&gt;language_LP.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td width=301&gt;&lt;p&gt;language_Implant.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;语言信息获取

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;p&gt;Environment_LP.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td width=301&gt;&lt;p&gt;Environment_Implant.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;环境变量信息获取

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;p&gt;CheckMouse_LP.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td width=301&gt;&lt;p&gt;CheckMouse_Implant.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;鼠标相关检测

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;p&gt;CheckKeyboard_LP.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td width=301&gt;&lt;p&gt;CheckKeyboard_Implant.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;键盘相关检测

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;p&gt;NetBios_LP.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td width=301&gt;&lt;p&gt;NetBios_Implant.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;网络共享查看

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;p&gt;NetGetDCName_LP.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td width=301&gt;&lt;p&gt;NetGetDCName_Implant.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;网络主机名获取

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;p&gt;Scheduler_LP.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td width=301&gt;&lt;p&gt;Scheduler_Implant.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;计划任务设置

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;p&gt;AdUser_LP.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td width=301&gt;&lt;p&gt;AdUser_Implant.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;添加账户

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;p&gt;ArpScan_LP.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td width=301&gt;&lt;p&gt;ArpScan_Implant.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;ARP扫描

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;p&gt;PacketRedirect_LP.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td width=301&gt;&lt;p&gt;PacketRedirect_Implant.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;数据包重定向

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;p&gt;PacketScan_LP.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td width=301&gt;&lt;p&gt;PacketScan_Implant.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;数据包扫描

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;p&gt;RegKeys_LP.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td width=301&gt;&lt;p&gt;RegKeys_Implant.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;注册表操作

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;p&gt;RegQuery_LP.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td width=301&gt;&lt;p&gt;RegQuery_Implant.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;注册表键值内容获取

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;p&gt;procMon _LP.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td width=301&gt;&lt;p&gt;procMon_Implant.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;进程监控

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td&gt;&lt;p&gt;RemoteExecute_LP.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td width=301&gt;&lt;p&gt;RemoteExecute_Implant.dll

    &lt;/p&gt;&lt;/td&gt;
    &lt;td&gt;&lt;p&gt;远程执行文件

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;</code></pre>


</table>

<p>安天CERT根据分析出的部分实体文件功能和文件列表进行梳理，再加上之前卡巴斯基<sup>[7]</sup>和安天<sup>[1]</sup>对方程式插件的分析，整理了这些功能插件在攻击过程中可能形成的组合，并绘制了"方程式组织主机作业模块积木图"。从图中可以看出攻击者通过对这些插件进行组合来完成相应的功能，这些插件体现了如下架构风格--不编写功能高度复杂的单一木马，而是<strong>把功能拆解成高度独立的小模块，这种拆解的粒度，几乎到了"原子化"的程度</strong>，即使简单如获取系统信息的操作，也把类似获取环境变量、语言集、网络状态等都作为一个独立的小模块，<strong>这将保证系统作业可以完全按需展开，从而最大化的保证作业的谨慎和静默。</strong>从对主机安全环境的逃逸和对抗来看，这批插件的编译时间为2007年，从反病毒技术发展上来看，正是主机主动防御技术走入成熟的阶段。主动防御技术普遍采用行为加权的思路对未知文件进行判定，但这些完成这种"原子"操作的模块，是不会累加到阈值的。这种单独功能片段不仅在当时的情况下很难被发现，即使从现代的动静态检测角度上来看也很难被发现。每个单独功能片段不具任何明显的恶意功能，只有总调度平台将各功能插件协调使用才会组合出各种作业能力。这种作业方式，也会导致安全厂商很难获取到完整的模块，而在没有有效Loader的情况下，这些模块很难在沙箱中被加载起来，从而也很难有效地进行行为分析，其比那些探测虚拟环境从而拒绝执行的木马更难以分析。</p>
<p>从文件名上来看，这些模块的功能规划得非常清晰。当然在实际作业中，这些DLL可能会以其他的一些形态表现出来，其中包括可能使用窃取的数字证书进行签名。在这种情况下，部分驱动文件的Version信息预计也会被定制为对应的数字证书信息，其使用的文件名，可能与其伪装的系统或应用的风格一致，或者使用类似震网<sup>[12]</sup>、毒曲<sup>[13]</sup>和火焰<sup>[14]</sup>中使用的伪装成预编译或者临时文件的技巧。</p>
<table>
      <tr>
        <td width=75><p><b>A<sup>2</sup>PT</b><b
 >事件</b><b
 >

        </b></p></td>
        <td width=154><p><b>使用过的签名信息</b><b>

        </b></p></td>
        <td><p><b>命名规律</b><b>

        </b></p></td>
      </tr>
      <tr>
        <td width=75><p>Stuxnet

        </p></td>
        <td width=154><p>JMicron Technology Corp

        </p></td>
        <td><p>仿冒系统文件如：MRxCls.sys，S7HKIMDX.DLL，comspol32.ocx；按照Windows命名规律伪装成oem、和mdm开头的pnf预编译文件；伪装成临时文件。

        </p></td>
      </tr>
      <tr>
        <td width=154><p>Realtek Semiconductor Corp

        </p></td>
      </tr>
      <tr>
        <td width=75><p>Flame

        </p></td>
        <td width=154><p>亚洲诚信数字签名测试证书

        </p></td>
        <td><p>仿冒系统文件名，如：MSSECMGR.OCX，icsvntu32.ocx，FRAGWIZ.OCX

        </p></td>
      </tr>
      <tr>
        <td width=75><p>Duqu

        </p></td>
        <td width=154><p>HON HAI PRECISION INDUSTRY CO. LTD

        </p></td>
        <td><p>仿冒系统文件名，如：adpu321.sys，igdkmd16b.sys，iaStor451.sys

        </p></td>
      </tr>
      <tr>
        <td width=154><p>C-Media Electronics Incorporation

        </p></td>
      </tr>
      <tr>
        <td width=75><p>Equation

        </p></td>
        <td width=154><p>尚未发现

        </p></td>
        <td><p>仿冒系统文件名，如：mstcp32.sys，DXGHLP16.SYS，tdi6.sys；伪装成Dat文件。

        </p></td>
      </tr>
</table>

<p>表 4 - 3 系列 A2PT 行动中样本使用的数字签名和场景中的文件命名风格</p>
<p>当然，这些模块也可能是以采用文件不落地的方式进行投放的，其直接运行在内存中，而没有相应的文件实体。</p>
<p><img alt="" src="http://www.antiy.com/response/EQUATION_DRUG/img/image011.jpg" /></p>
<p>图 4 - 3 方程式组织主机作业模块积木图</p>
<p>"DanderSpritz"一词在"棱镜"事件中曾被曝光，在ANT中的"FIREWALK"<sup>[16]</sup>工具中也提及到了DNT的"DanderSpritz"，DNT与ANT同属于NSA的网络组织。类似这种攻击装备可被用于多种作业场景，通过"FIREWALK"<sup>[16]</sup>工具的网络流量采集和注入使得受害主机与攻击者的远程控制中心建立联系，使得<strong>远控变成了抵近战术作业，如，通过物流链劫持或者在内部节点上插入或替换设备，只要启动远控工具，就可以达成就近控制和人工作业相结合的攻击方式</strong>。</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/01/0R0033a2-4.png-w331s" /></p>
<p>图 4 - 4 斯诺登曝光的NSA-ANT网络武器FIREWALK（安天公益翻译小组译）</p>
<p>NSA-ANT网络武器最早在2013年斯诺登事件中曝光，共包含48个攻击武器，随着事件的发酵，不断有媒体和组织对其进行曝光，安天安全分析工程师根据目前曝光的全部资料和技术分析尝试初步绘制了相关攻击装备的图谱。</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/01/0R0032200-5.jpg-w331s" /></p>
<p>图 4 - 5 NSA-TAO攻击装备体系（完善中）</p>
<h2>5   部分组件与插件分析（继续完善中）</h2>
<p>通过一段时间的跟进分析安天CERT发现此次曝光的插件具有模块化和反检测特点，安天CERT根据现有分析情况总结了这批攻击插件的三个特点：</p>
<p>1.         各个插件在DllMain函数中均不直接实现恶意行为。基于沙箱的威胁检测系统在检测DLL形态PE文件时，通常会调用Windows API LoadLibrary() 来实现动态加载待检测对象，执行待检测对象的DllMain函数功能，触发待检测对象动态行为。但对于这些方程式插件，由于DllMain函数并不表现恶意行为（如 图 5-1 所示），很容易被沙箱视作非恶意程序。</p>
<p><img alt="" src="http://www.antiy.com/response/EQUATION_DRUG/img/image014.png" /></p>
<p>图 5 - 1 DllMain函数并没有恶意功能</p>
<p>2.         各插件的导出函数中均不直接实现恶意功能。这些方程式插件均只提供4个按序号（而不是按名称）导出的函数。在其函数功能中，第1个导出函数负责接收调用者以特定数据结构传递的回调函数指针或参数（如 图 5-2 所示）；第2个导出函数负责在必要释放已申请资源；第3个导出函数根据调用参数返回其核心功能函数指针；第4个导出函数负责填写调用者提供的数据结构、向调用者传递插件版本信息。除了第4个导出函数未对参数进行严格判断而可能因访问空指针产生异常外，各插件的导出函数均不直接实现恶意功能，基于沙箱的威胁检测系统无法通过调用各导出函数触发其恶意行为，从而将其视作非恶意程序。</p>
<p><img alt="" src="http://www.antiy.com/response/EQUATION_DRUG/img/image015.png" /></p>
<p>图 5 - 2 i1函数中的回调函数指针或参数</p>
<p>3.         各个插件均只实现最基本能力。这些方程式插件均只实现最基本的功能，即使分析人员掌握了插件的调用方法，传递正确的调用参数，也只能执行最基本的程序功能，并在回调函数得到程序功能的中间结果（如进程名称、模块名称、用户密码），如果不是非常有经验的分析人员，是很难将这些程序功能与正常程序的功能实现区分开。方程式攻击组织这样设计插件，除了考虑到框架的可扩展性和功能剪裁的方便性等因素之外，很可能是以此绕过某些反病毒引擎的静态检测机制。</p>
<h3>5.1 Processinfo插件遍历进程模块</h3>
<p>由于这批插件的复杂性，安天CERT挑选了其中相对较小的文件以便于分析。通过分析发现，用于实现对指定进程的模块遍历，并调用上层模块预设的回调函数。</p>
<h4>5.1.1  样本标签</h4>
<table width="68%">
      <tr>
        <td width="32%"><p><b>病毒名</b>

        </p></td>
        <td width="67%"><p>Trojan/Win32.EquationDrug

        </p></td>
      </tr>
      <tr>
        <td width="32%"><p><b>原始文件名</b>

        </p></td>
        <td width="67%"><p>processinfo_Implant9x.dll

        </p></td>
      </tr>
      <tr>
        <td width="32%"><p><b>MD5</b>

        </p></td>
        <td width="67%"><p>6042EA9707316784FBC77A8B450E0991

        </p></td>
      </tr>
      <tr>
        <td width="32%"><p><b>处理器架构</b>

        </p></td>
        <td width="67%"><p>X86-32

        </p></td>
      </tr>
      <tr>
        <td width="32%"><p><b>文件大小</b>

        </p></td>
        <td width="67%"><p>8
          KB (8,192 字节)

          </p></td>
      </tr>
      <tr>
        <td width="32%"><p><b>文件格式</b>

        </p></td>
        <td width="67%"><p>BinExecute/Microsoft.DLL[:X86]

        </p></td>
      </tr>
      <tr>
        <td width="32%"><p><b>时间戳</b>

        </p></td>
        <td width="67%"><p>45A40EC7->2007-01-10
          05:53:11

        </p></td>
      </tr>
</table>

<p>表 5 - 1 样本标签</p>
<p><img alt="" src="http://www.antiy.com/response/EQUATION_DRUG/img/image016.png" /></p>
<h4>5.1.2          主要功能</h4>
<p>本插件提供四个基于序号导出的函数。</p>
<p>表 5 - 2 主要功能
<table>
      <tr>
        <td width=75><p><b>序号</p>
<pre class="codehilite"><code>    &lt;/b&gt;&lt;/p&gt;&lt;/td&gt;
    &lt;td width=384&gt;&lt;p&gt;&lt;b&gt;功能

    &lt;/b&gt;&lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td width=75&gt;&lt;p&gt;1

    &lt;/p&gt;&lt;/td&gt;
    &lt;td width=384&gt;&lt;p&gt;设置上层模块回调函数，创建互斥体

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td width=75&gt;&lt;p&gt;2

    &lt;/p&gt;&lt;/td&gt;
    &lt;td width=384&gt;&lt;p&gt;释放资源

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td width=75&gt;&lt;p&gt;3

    &lt;/p&gt;&lt;/td&gt;
    &lt;td width=384&gt;&lt;p&gt;返回核心功能函数地址

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td width=75&gt;&lt;p&gt;4

    &lt;/p&gt;&lt;/td&gt;
    &lt;td width=384&gt;&lt;p&gt;获取插件版本信息

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
&lt;/table&gt;</code></pre>


<p><img alt="" src="http://www.antiy.com/response/EQUATION_DRUG/img/image016.png" /></p>
<p>图 5 - 3  1号导出函数 设置上层模块回调函数</p>
<p><img alt="" src="http://www.antiy.com/response/EQUATION_DRUG/img/image018.png" /></p>
<p>图 5 - 4  3号导出函数 返回核心功能函数地址</p>
<p><img alt="" src="http://www.antiy.com/response/EQUATION_DRUG/img/image019.png" /></p>
<p>图 5 - 5  4号导出函数 获取插件版本信息</p>
<p><img alt="" src="http://www.antiy.com/response/EQUATION_DRUG/img/image020.png" /></p>
<p>图 5 - 6 遍历指定进程，默认为当前进程</p>
<p><img alt="" src="http://www.antiy.com/response/EQUATION_DRUG/img/image021.png" /></p>
<p>图 5 - 7 遍历指定进程模块，计算模块对应文件HASH（SHA1）</p>
<h3>5.2         kill_Implant插件杀进程模块</h3>
<p>该模块是另一个相对较小的文件，安天CERT通过分析发现，该插件主要功能为根据传入的进程ID来结束对应进程。</p>
<h4>5.2.1          样本标签</h4>
<p>表 5 - 3 样本标签</p>
<h4>5.2.2          主要功能</h4>
<p>模块调用者传递进来进程ID，该模块利用函数OpenProcess获取句柄，再利用函数TerminateProcess结束对应进程。</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/01/0R0034Z3-15.png-w331s" /></p>
<p>图 5 - 8 结束进程</p>
<h3>5.3         GROK键盘与剪贴版记录器驱动</h3>
<p>本次泄露的文件除DLL插件外还有一些EXE格式，安天CERT发现其中几个EXE文件与之前方程式平台中的GROK组件相同，本次曝光的版本为1.2.0.1，均可以从资源段中解密并释放键盘与剪贴版记录器驱动msrtdv.sys。</p>
<h4>5.3.1          样本标签</h4>
<p>表 5 - 4 样本标签
<table width="68%">
      <tr>
        <td width="41%"><p><b>病毒名</b></p>
<pre class="codehilite"><code>    &lt;/p&gt;&lt;/td&gt;
    &lt;td width=&quot;59%&quot;&gt;&lt;p&gt;Trojan/Win32.EquationDrug

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td width=&quot;41%&quot;&gt;&lt;p&gt;&lt;b&gt;原始文件名&lt;/b&gt;

    &lt;/p&gt;&lt;/td&gt;
    &lt;td width=&quot;59%&quot;&gt;&lt;p&gt;msrtdv.sys

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td width=&quot;41%&quot;&gt;&lt;p&gt;&lt;b&gt;MD5&lt;/b&gt;

    &lt;/p&gt;&lt;/td&gt;
    &lt;td width=&quot;59%&quot;&gt;&lt;p&gt;6A4461AF87371B89D240A34846A7BC64

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td width=&quot;41%&quot;&gt;&lt;p&gt;&lt;b&gt;处理器架构&lt;/b&gt;

    &lt;/p&gt;&lt;/td&gt;
    &lt;td width=&quot;59%&quot;&gt;&lt;p&gt;X86-32

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td width=&quot;41%&quot;&gt;&lt;p&gt;&lt;b&gt;文件大小&lt;/b&gt;

    &lt;/p&gt;&lt;/td&gt;
    &lt;td width=&quot;59%&quot;&gt;&lt;p&gt;36.3
      KB (37,248 字节)

      &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td width=&quot;41%&quot;&gt;&lt;p&gt;&lt;b&gt;文件格式&lt;/b&gt;

    &lt;/p&gt;&lt;/td&gt;
    &lt;td width=&quot;59%&quot;&gt;&lt;p&gt;BinExecute/Microsoft.SYS[:X86]

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;
  &lt;tr&gt;
    &lt;td width=&quot;41%&quot;&gt;&lt;p&gt;&lt;b&gt;时间戳&lt;/b&gt;

    &lt;/p&gt;&lt;/td&gt;
    &lt;td width=&quot;59%&quot;&gt;&lt;p&gt;0x4B7F1480-&gt;2010-02-20
      06:45:20

    &lt;/p&gt;&lt;/td&gt;
  &lt;/tr&gt;</code></pre>


</table>

<p>该恶意代码样本是键盘记录器及剪贴版监视工具，在之前友商报告中曾经提到过有相似功能的恶意代码，下面对其相似之处进行对比。</p>
<h4>5.3.2          版本信息</h4>
<p>样本包含版本信息，文件版本为5.1.1364.6430，源文件名为msrtdv.sys，文件描述为MSRTdv interface driver。其中文件版本低于之前已经曝光的版本5.3.1365.2180，源文件名与文件描述的不同在于将两个字母"d"和"v"的位置互换，一个是"mstrdv.sys"，另一个是"msrtvd.sys"。</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/01/0R0031N4-6.png-w331s" /></p>
<p>图 5 - 9 本次泄露版本与之前曝光版本的版本信息</p>
<p>5.3.3          主要功能</p>
<p>两个不同版本的样本其主要功能相同，通过给转储程序建立专用的进程来汇集所收集的数据，每隔30分钟，将结果压缩到文件"%TEMP%tm154o.da"。之前曝光的版本中，包含多个IoControlCode，分别对应不同的功能。</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/01/0R0033D0-7.png-w331s" /></p>
<p>图 5 - 10 之前曝光版本的主要功能代码</p>
<p>而本次泄露的样本中，IoControlCode虽然只有0x22002C，但一些主要功能仍然存在，可以通过反编译后的代码看出它们的相同之处。</p>
<p><img alt="" src="http://www.antiy.com/response/EQUATION_DRUG/img/image025.png" /></p>
<p>图 5 - 11 之前曝光版本的主要功能代码</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/01/0R0031558-8.png-w331s" /></p>
<p>图 5 - 12 本次泄露版本的主要功能代码</p>
<p>从以上分析比较中可以发现，本次泄露的恶意代码样本应为较低版本，版本信息低于之前卡巴斯基与安天分析曝光的版本，功能也弱于相关版本。在影子经纪人泄露出的文件DanderSpritz_All_Find.txt中，GROK的版本号也清楚的说明了这个问题，影子经纪人所释放出的只是GROK组件的低版本部分文件。<strong>但这批文件信息的丰富程度，则是将"千年暗室"打开了一个难得的缝隙。</strong></p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/01/0R0031156-9.png-w331s" /></p>
<p>图 5 - 13 GROK组件的不同版本号</p>
<h2>6          小结</h2>
<p>此次"影子经纪人"释放的Equation Group中的61个文件，对于全球网络安全研究者分析厘清EQUATION相关攻击平台的组成和架构有很大帮助。特别是能够观察其恶意代码的Debug版本，这在常规超级攻击组织的对抗中是很难想象的，这是一次难得从"内部"观察发动方程式组织的机会。经过初步打通和分析相关曝光信息，安天CERT看到、分析和梳理了该攻击平台的更多信息，包括如数百个攻击插件以及"DanderSpritz"攻击平台。</p>
<p>安天CERT分析相关文件后，判断其中部分组件与之前曝光的GROK组件为同类样本，而这些组件均为早期的低版本。另外，安天CERT的分析结果也表明"DanderSpritz"与Equation Drug使用了相同的组件和架构设计，"DanderSpritz"可能就是方程式组织使用的Equation Drug攻击平台，而其模块"原子化"的设计思路，让更多人可以看到该方程式组织支撑体系的庞大精密，作业过程的严密谨慎，以及其在武器研发使用中，绕过安全防御手段异常丰富的经验。</p>
<p>五年前，在安天展开针对Flame（火焰）蠕虫的马拉松分析中，有专家曾提醒我们不要"只见树叶，不见森林"，这让安天的安全工程师们深刻地反思了传统分析工程师"视野从入口点开始"的局限性，从那时开始尝试建立从微观见宏观的分析视野。安天CERT的安全工程师们通过本次分析，发现自己依然在迷宫中挣扎--或许这就是面对超级攻击者时，安全分析团队面临的分析常态。</p>
<p>过去的四年，针对方程式组织的持续跟踪分析，是安天了解最高级别攻击者（即A<sup>2</sup>PT--高级的APT）的极为难得的经历。深入研究这种具有超级成本支撑和先进理念引领的超级攻击者，对于改善和增强安天探海、智甲、追影等高级威胁检测和防御产品的防御能力也非常关键。安天也在深入思考和探索面对行业和地域的大规模态势感知系统，即达成"以资产防护为核心"的有效能力，尤其是面对海量事件锁定关键威胁和高级攻击者的能力。但对于应对A<sup>2</sup>PT攻击者来说，无论是有效改善防御，还是进行更为全面深入系统的分析，都不是一家安全企业能够独立承载的，此中还需要更多协同和接力式分析，而不是重复"发明轮子"。正是基于这种共同认知，在不久之前的第四届安天网络安全冬训营上，安天和360企业安全等安全企业向部分与会专家介绍了能力型安全厂商分析成果互认的部分尝试。唯有中国的机构用户和能力型安全厂商形成一个积极互动的体系，才能更好的防御来自各方面的威胁。</p>
<p>我们警惕，但并不恐惧。对于一场防御战而言，除了扎实的架构、防御和分析工作之外，必胜的信念是一个最大的前提。</p>
<p>无形者未必无影，安天追影，画影图形。</p>
<h2>附录一：参考资料</h2>
<ul>
<li>[1]      安天：修改硬盘固件的木马 探索方程式（EQUATION）组织的攻击组件
<a href="http://www.antiy.com/response/EQUATION_ANTIY_REPORT.html">http://www.antiy.com/response/EQUATION_ANTIY_REPORT.html</a></li>
<li>[2]      安天：方程式（EQUATION）部分组件中的加密技巧分析
<a href="http://www.antiy.com/response/Equation_part_of_the_component_analysis_of_cryptographic_techniques.html">http://www.antiy.com/response/Equation_part_of_the_component_analysis_of_cryptographic_techniques.html</a></li>
<li>[3]      安天：从“方程式”到“方程组”EQUATION攻击组织高级恶意代码的全平台能力解析
<a href="http://www.antiy.com/response/EQUATIONS/EQUATIONS.html">http://www.antiy.com/response/EQUATIONS/EQUATIONS.html</a></li>
<li>[4]      THESHADOWBROKERS CLOSED, GOING DARK
<a href="https://onlyzero.net/theshadowbrokers.bit/post/messagefinale/">https://onlyzero.net/theshadowbrokers.bit/post/messagefinale/</a></li>
<li>[5]      Stolen NSA "Windows Hacking Tools" Now Up For Sale!
<a href="http://thehackernews.com/2017/01/nsa-windows-hacking-tools.html">http://thehackernews.com/2017/01/nsa-windows-hacking-tools.html</a></li>
<li>[6]      Kaspersky：Equation: The Death Star of Malware Galaxy
<a href="http://securelist.com/blog/research/68750/equation-the-death-star-of-malware-galaxy/">http://securelist.com/blog/research/68750/equation-the-death-star-of-malware-galaxy/</a></li>
<li>[7]      Kaspersky：Inside the EquationDrug Espionage Platform
https://securelist.com/blog/research/69203/inside-the-equationdrug-espionage-platform/</li>
<li>[8]      Equation Group Cyber Weapons Auction - Invitation
<a href="https://github.com/theshadowbrokers/EQGRP-AUCTION">https://github.com/theshadowbrokers/EQGRP-AUCTION</a></li>
<li>[9]      The Equation giveaway
<a href="https://securelist.com/blog/incidents/75812/the-equation-giveaway/">https://securelist.com/blog/incidents/75812/the-equation-giveaway/</a></li>
<li>[10]   I just published “TheShadowBrokers Message #3”
<a href="https://medium.com/@shadowbrokerss/theshadowbrokers-message-3-af1b181b481">https://medium.com/@shadowbrokerss/theshadowbrokers-message-3-af1b181b481</a></li>
<li>[11]   Shadow Brokers reveals list of Servers Hacked by the NSA
<a href="http://thehackernews.com/2016/10/nsa-shadow-brokers-hacking.html">http://thehackernews.com/2016/10/nsa-shadow-brokers-hacking.html</a></li>
<li>[12]   ANTProductData2013
https://search.edwardsnowden.com/docs/ANTProductData2013-12-30nsadocs</li>
<li>[13]   Kaspersky：A Fanny Equation: "I am your father, Stuxnet"
<a href="http://securelist.com/blog/research/68787/a-fanny-equation-i-am-your-father-stuxnet/">http://securelist.com/blog/research/68787/a-fanny-equation-i-am-your-father-stuxnet/</a></li>
<li>[14]   Kaspersky：Equation Group: from Houston with love
<a href="http://securelist.com/blog/research/68877/equation-group-from-houston-with-love/">http://securelist.com/blog/research/68877/equation-group-from-houston-with-love/</a></li>
<li>[15]   Kaspersky：Equation_group_questions_and_answers
<a href="https://securelist.com/files/2015/02/Equation_group_questions_and_answers.pdf">https://securelist.com/files/2015/02/Equation_group_questions_and_answers.pdf</a></li>
<li>[16]   Kaspersky：The Equation giveaway
https://securelist.com/blog/incidents/75812/the-equation-giveaway/</li>
</ul>
<h2>附录二：关于安天</h2>
<p>安天从反病毒引擎研发团队起步，目前已发展成为以安天实验室为总部，以企业安全公司、移动安全公司为两翼的集团化安全企业。安天始终坚持以安全保障用户价值为企业信仰，崇尚自主研发创新，在安全检测引擎、移动安全、网络协议分析还原、动态分析、终端防护、虚拟化安全等方面形成了全能力链布局。安天的监控预警能力覆盖全国、产品与服务辐射多个国家。安天将大数据分析、安全可视化等方面的技术与产品体系有效结合，以海量样本自动化分析平台延展工程师团队作业能力、缩短产品响应周期。结合多年积累的海量安全威胁知识库，综合应用大数据分析、安全可视化等方面经验，推出了应对高级持续性威胁（APT）和面向大规模网络与关键基础设施的态势感知与监控预警解决方案。</p>
<p>全球超过三十家以上的著名安全厂商、IT厂商选择安天作为检测能力合作伙伴，安天的反病毒引擎得以为全球近十万台网络设备和网络安全设备、超过五亿部手机提供安全防护。安天移动检测引擎是全球首个获得AV-TEST年度奖项的中国产品。安天技术实力得到行业管理机构、客户和伙伴的认可，安天已连续四届蝉联国家级安全应急支撑单位资质，亦是中国国家信息安全漏洞库六家首批一级支撑单位之一。安天是中国应急响应体系中重要的企业节点，在红色代码、口令蠕虫、震网、破壳、沙虫、方程式等重大安全事件中，安天提供了先发预警、深度分析或系统的解决方案。</p>
<table>
    <tr>
      <td width="293"><p>关于反病毒引擎更多信息请访问：</p></td>
      <td width="260"><p><a href="http://www.antiy.com">http://www.antiy.com</a>（中文）</p>
          <p><a href="http://www.antiy.net">http://www.antiy.net</a> （英文）</p></td>
    </tr>
    <tr>
      <td width="293"><p>关于安天反APT相关产品更多信息请访问：</p></td>
      <td width="260"><p><a href="http://www.antiy.cn/">http://www.antiy.cn</a><u>

      </u></p></td>
    </tr>
  </table>
      
<hr>
<p><img src="https://images.seebug.org/content/images/2017/08/0e69b04c-e31f-4884-8091-24ec334fbd7e.jpeg" alt="Paper" style="width: 220px">
本文由 Seebug Paper 发布，如需转载请注明来源。本文地址：<a href="https://paper.seebug.org/185/">https://paper.seebug.org/185/</a></p>
            
    </section>

  <nav class="pagination" role="navigation" style="padding: 3rem;">
    
      <a class="newer-posts" href="/184/"><span aria-hidden="true">&larr;</span> 网络安全强国 - 以色列的工控安全之路</a>
    
    
      <a class="older-posts" href="/187/">BadBookmarklet <span aria-hidden="true">&rarr;</span></a>
    
  </nav>


    

      
    
    <br>
    <section class="plugin_comment">
    </section>

  </article>
  <section class="plugin_feedback"></section>


  </div>
</main>
</div>

<script type="text/javascript" src="/static/js/jquery.min.js"></script>
<script type="text/javascript" src="/static/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/static/js/index.js"></script>
<script type="text/javascript" src="/static/js/prism-loader.js"></script>
<script type="text/javascript" src="/static/js/prism.js"></script>
<script type="text/javascript" src="/static/js/jquery.ghostHunter.js"></script>
<script type="text/javascript" src="/static/js/js.cookie.js"></script>
<script type="text/javascript" src="/static/js/custom.js?t=20170821"></script>
<script type="text/javascript" src="https://www.seebug.org/static/dist2/scripts/comment_main.js"></script>
<script type="text/javascript" src="https://www.seebug.org/static/dist2/scripts/plugin_feedback.js"></script>
</body>

</html>
