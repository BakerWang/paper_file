<!DOCTYPE html>


<html xmlns:wb="http://open.weibo.com/wb">

<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta property="wb:webmaster" content="ccd3e79934f3322d"/>
  <title>MENU 比较“81端口的botnet”和 MIRAI 之间的联系</title>
  <meta name="keywords" content="漏洞文档,漏洞分析,安全技术"/>
  <meta name="description" content=""/>

  <meta name="HandheldFriendly" content="True"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <link rel="shortcut icon" href="/static/images/favicon.ico">
  <link rel="stylesheet" type="text/css" href="/static/css/screen.css"/>
  <link rel="stylesheet" type="text/css" href="/static/css/font.css"/>
  <link rel="stylesheet"
        href="//libs.baidu.com/fontawesome/4.0.3/css/font-awesome.min.css">
  <link rel="stylesheet" type="text/css" href="/static/css/prism.css"/>
  <link rel="stylesheet" type="text/css" href="/static/css/monokai.css" media="screen"/>
  <link rel="stylesheet" type="text/css" href="/static/css/custom.css?t=20170821"/>
  <link rel="stylesheet" type="text/css" href="/static/css/print.css?t=20170821" media="print"/>
  <script>
    var _hmt = _hmt || [];
    (function () {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?ef67a70a7641da3b52452a05b3bbecae";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


</head>

<body class="home-template">
<div class="weixin-share-img" style="display: none">
  <img src="/static/images/weixin-share.png" alt="Paper"/>
</div>

<div id="wrapper" class="">

<div id="sidebar">
  <button type="button" class="hamburger is-closed" data-toggle="offcanvas">
    <span class="hamb-top"></span>
    <span class="hamb-middle"></span>
    <span class="hamb-bottom"></span>
  </button>
  <div id="sidebar-content" class="inner">
    <h2 class="blog-title"><a href="/">Paper</a></h2>
    <h3 class="blog-description">安全技术精粹</h3>

    <form id="search" action="/">
      <button type="submit" style="background: #13313f; border: #13313f; position: absolute; right: -4px; margin-top: -3px;">
        <i class="fa fa-search search-button" style="position: absolute;right:10px; margin-top:6px;" > </i>
      </button>
      <input id="search-field" name="keyword" value="" placeholder="Search"/>

    </form>
    <div class="overlay"></div>
    <div id="sidebar-links">
      <ul id="subscription-links">
        <li><a target="_blank" href="/rss/"><i class="fa fa-rss"></i>RSS 订阅</a>
        </li>
        <li><a href="https://www.seebug.org/contribute/paper"><i
            class="fa fa-envelope-o"></i>投稿</a></li>
      </ul>
      <ul id="navigation">
        <li class="nav-" role="presentation"><a href="/"><i
            class="fa fa-angle-right"></i>首页</a></li>
        
  <li class="nav-" role="presentation"><a href="/category/vul-analysis/"><i
      class="fa fa-angle-right"></i>漏洞分析</a></li>

  <li class="nav-" role="presentation"><a href="/category/tools/"><i
      class="fa fa-angle-right"></i>安全工具&amp;安全开发</a></li>

  <li class="nav-" role="presentation"><a href="/category/information/"><i
      class="fa fa-angle-right"></i>情报分析</a></li>

  <li class="nav-" role="presentation"><a href="/category/experience/"><i
      class="fa fa-angle-right"></i>经验心得</a></li>

  <li class="nav-" role="presentation"><a href="/category/web-security/"><i
      class="fa fa-angle-right"></i>Web安全</a></li>

  <li class="nav-" role="presentation"><a href="/category/bin-security/"><i
      class="fa fa-angle-right"></i>二进制安全</a></li>

  <li class="nav-" role="presentation"><a href="/category/mobile-security/"><i
      class="fa fa-angle-right"></i>移动安全</a></li>

  <li class="nav-" role="presentation"><a href="/category/paper-archive/"><i
      class="fa fa-angle-right"></i>纸篓</a></li>

  <li class="nav-" role="presentation"><a href="/category/prime/"><i
      class="fa fa-angle-right"></i>安全基础&amp;教学篇</a></li>


        <li class="nav-" role="presentation"><a href="/call-for-paper/"><i
            class="fa fa-angle-right"></i>如何投稿</a></li>
        <li class="nav-" role="presentation"><a href="https://paper.seebug.org/papers/"><i
            class="fa fa-angle-right"></i>归档文件</a></li>
      </ul>
      <ul id="sidebar-external">
      </ul>
    </div>

    <footer class="site-footer">
      <section class="copyright">Copyright @ 404 Team from Knownsec.</section>
    </footer>
  </div>
</div>

<main>
  <div class="main-inner">
    <section id="results"></section>
    
  <article class="">
    <header class="post-header">

      <h1 class="post-title">MENU 比较“81端口的botnet”和 MIRAI 之间的联系</h1>

      <span class="post-print">
        <a href="javascript:window.print()">
        <i class="fa fa-print fa-2x" aria-hidden="true"></i>
        </a>
      </span>
      <section class="post-meta">
        <span class="post-time">
          <i class='fa fa-calendar'></i>
          <time datetime="2017-04-29" class="timeago">4 月，3 周 之前</time>
          <time datetime="2017-04-29" class="fulldate">四月 29, 2017</time>
        </span>
        
          <br>
          <i class='fa fa-tag'></i>
          
            <a href="/category/information/">情报分析</a>
            
          
        








      </section>
    </header>

    <section class="post-content">
      <p><input type="hidden" class="Authorrss" value="Rootkiter" name="http://blog.netlab.360.com/author/rootkiter/"></p>
<p>来源：<a href="http://blog.netlab.360.com/content/images/2017/04/table_command_parse_Persirai-1.jpg"><strong>360 网络安全研究院</strong></a><br />
作者：<a href="http://blog.netlab.360.com/author/rootkiter/"><strong>Rootkiter</strong></a></p>
<h2>概述</h2>
<p>从 "<a href="http://blog.netlab.360.com/a-new-threat-an-iot-botnet-scanning-internet-on-port-81-ch/">81 端口的异常流量</a>"中，我们发现了一个新的僵尸网络家族，它和 MRIAI 存在一定的联系，本文将介绍一些对比结果，同时介绍一下我们从这个 botnet 中发现的一种依赖SSDP协议的感染机制。</p>
<p><em><strong>*注：</strong>如无特殊声明，MIRAI的分析将以github源码为基础；新botnet 将以其中的9584B6AEC418A2AF4EFAC24867A8C7EC样本的逆向结果为基础。</em></p>
<h2>相同点</h2>
<h3>相同的扫描方案</h3>
<p>众所周知，MIRAI在传播过程中用到了SYN端口探测的技巧，来提高传播效率。新Botnet 也使用了该技巧并将其用在了81端口扫描中。随着研究的深入我们发现它和MIRAI有着相同的扫描规则。
在 MIRAI 中，被扫描IP是通过一系列随机函数生成的，但他有个黑名单机制，用于跳过一些IP地址范围（代码来自scanner.c），相关截图如下：</p>
<p><img alt="" src="http://ogb2rw42s.bkt.clouddn.com/images/1_SYN_SCAN_BLACK_IP_ADDRESS.png" /></p>
<p>而在我们发现的 新Botnet 中（截图选自sub_A7C4函数），也有完全相同的黑名单机制（上下两图红框中是三行比对样例，实际上整个 while 循环体都是完全一致的）。</p>
<p><img alt="" src="http://ogb2rw42s.bkt.clouddn.com/images/2_SYN_SCANN_BLACK_LIST.jpg" /></p>
<h3>部分util函数同源</h3>
<p>当我们将 新Botnet 和 MIRAI 进行汇编指令级别对比时，可以很清晰的发现，它们之间的少部分函数具有高度的一致性。</p>
<p><img alt="" src="http://ogb2rw42s.bkt.clouddn.com/images/table_Function_Name_From_MIRAI-3.jpg" /></p>
<h2>不同点</h2>
<h3>配置C2的区别</h3>
<p>在公开的 MIRAI 源码中，用了 一个异或加密算法 来保护 C2 域名，并将 C2 以密文形式编码在原始代码之中，相关代码可参考 table.c 的 table_init 函数，其截图如下：</p>
<p><img alt="" src="http://ogb2rw42s.bkt.clouddn.com/images/3_C2_Config_Of_MIRAI.png" /></p>
<p>而在 该 Botnet 中，却是直接的明文字符串编码，相关截图如下：</p>
<p><img alt="" src="http://ogb2rw42s.bkt.clouddn.com/images/4_C2_Config_Of_Persirai.png" /></p>
<p>值得一提的是，域名 <code>ntp.gtpnet.ir</code> 现阶段的解析目标为一个内网地址。 在此种情况下，攻击者是无法对僵尸网络进行正常控制的，且解析方式也不同于BlackHole（即域名的控制权仍然掌握在管理者手中）。 我们推测产生这种状态的原因有两种可能：</p>
<ol>
<li>管理者发现僵尸网络暴露了，切断了解析以防被追踪。</li>
<li>管理者正在进行新版本的研发和测试，而网络上有大量的被控端，它们会对测试造成干扰，把解析目标设置到自己可控的内网地址后，可以很方便的排除干扰。</li>
</ol>
<h3>传播方式的区别</h3>
<p>在所有公开的 MIRAI 源码中，只有弱口令扫描一种传播方式，在 MIRAI 的已知变种中，出现过利用7547/5555/6789/37777等端口传播的情况，关于 MIRAI 更多的跟踪细节可以参考 <a href="http://data.netlab.360.com/mirai-scanner/">Mirai Scanner主页</a>。</p>
<p>而 81 端口却从未发现过传播的 MIRAI 的先例，这是 新Botnet 独有的传播方式，“<a href="http://blog.netlab.360.com/a-new-threat-an-iot-botnet-scanning-internet-on-port-81-ch/">新威胁报告：一个新IoT僵尸网络正在 HTTP 81上大范围传播</a>” 记录了和其有关的更多内容。</p>
<h3>通讯协议的区别</h3>
<p>MIRAI 的通讯协议可以从 attack.c 文件的 attack_parse 函数获取到。</p>
<p>而在 新Botnet 中却采取了一套全新的指令系统，相关内容可以用下表来表示： <img alt="" src="http://ogb2rw42s.bkt.clouddn.com/images/table_command_parse_Persirai-1.jpg" /></p>
<h3>攻击向量的区别</h3>
<p>在原版 MIRAI 中，拥有包括 GRE 攻击在内的 10 种 ddos 攻击向量可供选择，相关证据可以参考 attack.h 文件中的相关定义，下面是一张截图证明：</p>
<p><img alt="" src="http://ogb2rw42s.bkt.clouddn.com/images/5_DDOS_attack_Vector_In_MIRAI.jpg" /></p>
<p>而在 新Botnet 中，只存在两种 UDP-flood 攻击向量，可供选择，具体证据可参阅“通讯协议的区别”章节提供的表格。</p>
<h2>更多关于 新Botnet 的细节</h2>
<h3>除 81 端口外还存在其他传播方案</h3>
<p>虽然 新Botnet 是从 81 端口上被披露出来的，但其内部还包含有一个备份的传播方案，它似乎还没有被使用过。</p>
<p><code>00 04 02</code> 是该传播方案对应的指令码。这是一个基于 “SSDP协议+UPnP实现漏洞利用” 的传播方案，传播将基于 1900 端口。其发送的第一个探测包内容如下：</p>
<pre class="codehilite"><code>M-SEARCH * HTTP/1.1
HOST:239.255.255.250:1900
ST:upnp:rootdevice
MAN:&quot;ssdp:discover&quot;
MX:3</code></pre>


<p>这是 SSDP 协议的第一个请求包（函数地址 <code>0x0000A918</code>），当目标可以处理 SSDP 时，则进入 SSDP 交互逻辑，进而获得更多的智能设备信息及相应控制方法，当发现潜在 CVE-2014-8361 漏洞（Realtek SDK Miniigd UPnP SOAP Command Execution）的设备时(识别关键字<code>:52869/picsdesc.xml</code>)，尝试发送 CVE-2014-8361 对应的 payload 完成一次试探性传播（函数地址 <code>0x0000A458</code>）。</p>
<p>当存在漏洞的服务无法从外网直接访问时，扫描器将会通过调用拥有“AddPortMapping” 功能的函数（函数地址 <code>0x0000AE20</code>）建立一个端口映射，并通过新映射的端口来完成试探性payload投递。</p>
<h3>UDP-Flood 的网络特征</h3>
<p>该样本支持两种UDP-flood 攻击，分别为 <code>00 06</code> 和 <code>00 08</code>。</p>
<p>其中 <code>00 06</code> 对应的 flood 内容同 SSDP 探测包相同，截图证明如下：</p>
<p><img alt="" src="http://ogb2rw42s.bkt.clouddn.com/images/00_06_udp_flood.jpg" /></p>
<p>而 <code>00 08</code> 对应的 flood 内容为：</p>
<p><img alt="" src="http://ogb2rw42s.bkt.clouddn.com/images/00_08_udp_flood.jpg" /></p>
<h2>回顾</h2>
<p>本文从逆向样本出发，详细阐述了 新Botnet 和 MIRAI 之间的2个相同点和4个不同点。</p>
<p><strong>相同点</strong></p>
<ol>
<li>相同的扫描方案</li>
<li>部分util函数同源</li>
</ol>
<p><strong>不同点</strong></p>
<ol>
<li>配置C2的区别</li>
<li>传播方式的区别</li>
<li>通讯协议的区别</li>
<li>攻击向量的区别</li>
</ol>
<p>虽然 新Botnet 和 MIRAI 之间存在一定的共同点，但从 Botnet 识别的角度来看，这些不同点均为识别 Botnet 的重要指标，我们没有理由将其归类为 MIRAI 的变种，而应当把它当做一个全新的 Botnet 家族。</p>
      
<hr>
<p><img src="https://images.seebug.org/content/images/2017/08/0e69b04c-e31f-4884-8091-24ec334fbd7e.jpeg" alt="Paper" style="width: 220px">
本文由 Seebug Paper 发布，如需转载请注明来源。本文地址：<a href="https://paper.seebug.org/291/">https://paper.seebug.org/291/</a></p>
            
    </section>

  <nav class="pagination" role="navigation" style="padding: 3rem;">
    
      <a class="newer-posts" href="/290/"><span aria-hidden="true">&larr;</span> 新威胁报告：一个新IoT僵尸网络正在 HTTP 81上...</a>
    
    
      <a class="older-posts" href="/292/">Fastjson 远程反序列化程序验证的构造和分析 <span aria-hidden="true">&rarr;</span></a>
    
  </nav>


    

      
        <footer class="post-footer">
          <figure class="author-image">
            <a class="img" href="/users/author/?nickname=Rootkiter"
               style="background-image: url(https://images.seebug.org/uploads/2017/08/avatar.png)"><span
                class="hidden">'s Picture</span></a>
          </figure>

          <section class="author">
            <h4><a
                href="/users/author/?nickname=Rootkiter">Rootkiter</a>
            </h4>
            <p>阅读更多有关<a
                href="/users/author/?nickname=Rootkiter">该作者</a>的文章
            </p>
            
            <div class="author-meta">
            </div>
          </section>

          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          

        </footer>
      
    
    <br>
    <section class="plugin_comment">
    </section>

  </article>
  <section class="plugin_feedback"></section>


  </div>
</main>
</div>

<script type="text/javascript" src="/static/js/jquery.min.js"></script>
<script type="text/javascript" src="/static/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/static/js/index.js"></script>
<script type="text/javascript" src="/static/js/prism-loader.js"></script>
<script type="text/javascript" src="/static/js/prism.js"></script>
<script type="text/javascript" src="/static/js/jquery.ghostHunter.js"></script>
<script type="text/javascript" src="/static/js/js.cookie.js"></script>
<script type="text/javascript" src="/static/js/custom.js?t=20170821"></script>
<script type="text/javascript" src="https://www.seebug.org/static/dist2/scripts/comment_main.js"></script>
<script type="text/javascript" src="https://www.seebug.org/static/dist2/scripts/plugin_feedback.js"></script>
</body>

</html>
