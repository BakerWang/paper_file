<!DOCTYPE html>


<html xmlns:wb="http://open.weibo.com/wb">

<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta property="wb:webmaster" content="ccd3e79934f3322d"/>
  <title>Exploiting Python PIL Module Command Execution Vulnerability</title>
  <meta name="keywords" content="漏洞文档,漏洞分析,安全技术"/>
  <meta name="description" content=""/>

  <meta name="HandheldFriendly" content="True"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <link rel="shortcut icon" href="/static/images/favicon.ico">
  <link rel="stylesheet" type="text/css" href="/static/css/screen.css"/>
  <link rel="stylesheet" type="text/css" href="/static/css/font.css"/>
  <link rel="stylesheet"
        href="//libs.baidu.com/fontawesome/4.0.3/css/font-awesome.min.css">
  <link rel="stylesheet" type="text/css" href="/static/css/prism.css"/>
  <link rel="stylesheet" type="text/css" href="/static/css/monokai.css" media="screen"/>
  <link rel="stylesheet" type="text/css" href="/static/css/custom.css?t=20170821"/>
  <link rel="stylesheet" type="text/css" href="/static/css/print.css?t=20170821" media="print"/>
  <script>
    var _hmt = _hmt || [];
    (function () {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?ef67a70a7641da3b52452a05b3bbecae";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


</head>

<body class="home-template">
<div class="weixin-share-img" style="display: none">
  <img src="/static/images/weixin-share.png" alt="Paper"/>
</div>

<div id="wrapper" class="">

<div id="sidebar">
  <button type="button" class="hamburger is-closed" data-toggle="offcanvas">
    <span class="hamb-top"></span>
    <span class="hamb-middle"></span>
    <span class="hamb-bottom"></span>
  </button>
  <div id="sidebar-content" class="inner">
    <h2 class="blog-title"><a href="/">Paper</a></h2>
    <h3 class="blog-description">安全技术精粹</h3>

    <form id="search" action="/">
      <button type="submit" style="background: #13313f; border: #13313f; position: absolute; right: -4px; margin-top: -3px;">
        <i class="fa fa-search search-button" style="position: absolute;right:10px; margin-top:6px;" > </i>
      </button>
      <input id="search-field" name="keyword" value="" placeholder="Search"/>

    </form>
    <div class="overlay"></div>
    <div id="sidebar-links">
      <ul id="subscription-links">
        <li><a target="_blank" href="/rss/"><i class="fa fa-rss"></i>RSS 订阅</a>
        </li>
        <li><a href="https://www.seebug.org/contribute/paper"><i
            class="fa fa-envelope-o"></i>投稿</a></li>
      </ul>
      <ul id="navigation">
        <li class="nav-" role="presentation"><a href="/"><i
            class="fa fa-angle-right"></i>首页</a></li>
        
  <li class="nav-" role="presentation"><a href="/category/vul-analysis/"><i
      class="fa fa-angle-right"></i>漏洞分析</a></li>

  <li class="nav-" role="presentation"><a href="/category/tools/"><i
      class="fa fa-angle-right"></i>安全工具&amp;安全开发</a></li>

  <li class="nav-" role="presentation"><a href="/category/information/"><i
      class="fa fa-angle-right"></i>情报分析</a></li>

  <li class="nav-" role="presentation"><a href="/category/experience/"><i
      class="fa fa-angle-right"></i>经验心得</a></li>

  <li class="nav-" role="presentation"><a href="/category/web-security/"><i
      class="fa fa-angle-right"></i>Web安全</a></li>

  <li class="nav-" role="presentation"><a href="/category/bin-security/"><i
      class="fa fa-angle-right"></i>二进制安全</a></li>

  <li class="nav-" role="presentation"><a href="/category/mobile-security/"><i
      class="fa fa-angle-right"></i>移动安全</a></li>

  <li class="nav-" role="presentation"><a href="/category/paper-archive/"><i
      class="fa fa-angle-right"></i>纸篓</a></li>

  <li class="nav-" role="presentation"><a href="/category/prime/"><i
      class="fa fa-angle-right"></i>安全基础&amp;教学篇</a></li>


        <li class="nav-" role="presentation"><a href="/call-for-paper/"><i
            class="fa fa-angle-right"></i>如何投稿</a></li>
        <li class="nav-" role="presentation"><a href="https://paper.seebug.org/papers/"><i
            class="fa fa-angle-right"></i>归档文件</a></li>
      </ul>
      <ul id="sidebar-external">
      </ul>
    </div>

    <footer class="site-footer">
      <section class="copyright">Copyright @ 404 Team from Knownsec.</section>
    </footer>
  </div>
</div>

<main>
  <div class="main-inner">
    <section id="results"></section>
    
  <article class="">
    <header class="post-header">

      <h1 class="post-title">Exploiting Python PIL Module Command Execution Vulnerability</h1>

      <span class="post-print">
        <a href="javascript:window.print()">
        <i class="fa fa-print fa-2x" aria-hidden="true"></i>
        </a>
      </span>
      <section class="post-meta">
        <span class="post-time">
          <i class='fa fa-calendar'></i>
          <time datetime="2017-09-27" class="timeago">11小时之前</time>
          <time datetime="2017-09-27" class="fulldate">九月 27, 2017</time>
        </span>
        
          <br>
          <i class='fa fa-tag'></i>
          
            <a href="/category/web-security/">Web安全</a>
            
          
        








      </section>
    </header>

    <section class="post-content">
      <p>来源：<a href="https://xianzhi.aliyun.com/forum/read/2163.html" title="先知安全技术社区">先知安全技术社区</a><br />
作者：nearg1e@YSRC</p>
<p>PIL (Python Image Library) 应该是 Python 图片处理库中运用最广泛的，它拥有强大的功能和简洁的 API。很多 Python Web 应用在需要实现处理图片的功能时，都会选择使用 PIL。</p>
<p>PIL 在对 eps 图片格式进行处理的时候，如果环境内装有 GhostScript，则会调用 GhostScript 在 dSAFER 模式下处理图片，即使是最新版本的PIL模块，也会受到 <code>GhostButt CVE-2017-8291</code> dSAFER 模式 Bypass 漏洞的影响，产生命令执行漏洞。</p>
<p>据说大牛们看源码和 dockerfile 就可以了：<a href="https://github.com/neargle/PIL-RCE-By-GhostButt">https://github.com/neargle/PIL-RCE-By-GhostButt</a></https://github.com/neargle/PIL-RCE-By-GhostButt></p>
<p><br/></p>
<h4>一个简单常见的 Demo</h4>
<div class="codehilite"><pre><span></span><span class="kn">from</span> <span class="nn">PIL</span> <span class="kn">import</span> <span class="n">Image</span>
<span class="k">def</span> <span class="nf">get_img_size</span><span class="p">(</span><span class="n">filepath</span><span class="o">=</span><span class="s2">&quot;&quot;</span><span class="p">):</span>
    <span class="sd">&#39;&#39;&#39;获取图片长宽&#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">filepath</span><span class="p">:</span>
        <span class="n">img</span> <span class="o">=</span> <span class="n">Image</span><span class="o">.</span><span class="n">open</span><span class="p">(</span><span class="n">filepath</span><span class="p">)</span>
        <span class="n">img</span><span class="o">.</span><span class="n">load</span><span class="p">()</span>
        <span class="k">return</span> <span class="n">img</span><span class="o">.</span><span class="n">size</span>
    <span class="k">return</span> <span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">)</span>
</pre></div>


<p>我们在 Demo 里调用了 PIL 的 <code>Image.open</code>, <code>Image.load</code> 方法加载图片，最后返回图片的长和宽。</p>
<div class="codehilite"><pre><span></span>In [2]: get_img_size(&#39;/tmp/images.png&#39;)
Out[2]: (183, 275)
</pre></div>


<p><br/></p>
<h4>分析</h4>
<h6>Image.open 图片格式判断的问题</h6>
<p>PIL在 <code>Image.open</code> 函数里面判断图片的格式，首先它调用 <code>_open_core</code> 函数， 在 <code>_open_core</code> 里面则是调用各个格式模块中的 <code>_accept</code> 函数，判断所处理的图片属于哪一个格式。</p>
<div class="codehilite"><pre><span></span>def _open_core(fp, filename, prefix):
    for i in ID:
        try:
            factory, accept = OPEN[i]
            if not accept or accept(prefix):
                fp.seek(0)
                im = factory(fp, filename)
                _decompression_bomb_check(im.size)
                return im
        except (SyntaxError, IndexError, TypeError, struct.error):
            # Leave disabled by default, spams the logs with image
            # opening failures that are entirely expected.
            # logger.debug(&quot;&quot;, exc_info=True)
            continue
    return None

im = _open_core(fp, filename, prefix)
</pre></div>


<p>这里 <code>_accept(prefix)</code> 函数中的参数 prefix 就是图片文件头部的内容</p>
<div class="codehilite"><pre><span></span># PIL/GifImagePlugin.py
def _accept(prefix):
    return prefix[:6] in [b&quot;GIF87a&quot;, b&quot;GIF89a&quot;]

# PIL/EpsImagePlugin.py
def _accept(prefix):
    return prefix[:4] == b&quot;%!PS&quot; or \
           (len(prefix) &gt;= 4 and i32(prefix) == 0xC6D3D0C5)
</pre></div>


<p>可以发现 PIL 使用文件头来判断文件类型，也就是说即使我们用它处理一个以 <code>.jpg</code> 结尾的文件，只要文件内容以 <code>%!PS</code> 开头，那么 PIL 就会返回一个 <code>PIL.EpsImagePlugin.EpsImageFile</code> 对象，使用 eps 格式的逻辑去处理它。之后调用的 load 方法也是 <code>EpsImageFile</code> 里面的 load 方法。</p>
<h6>Image.load 到 subprocess.check_call</h6>
<p>真实的环境中，程序员可能不会刻意去调用 <code>load()</code> 方法，但是其实 Image 文件中几乎所有的功能函数都会调用到 <code>load()</code>。在 PIL/EpsImagePlugin.py 文件内我们关注的调用链为: <code>load()</code> -&gt; <code>Ghostscript()</code> -&gt; <code>subprocess.check_call()</code>, 最后使用 <code>subprocess.check_call</code> 执行了 gs 命令。</p>
<div class="codehilite"><pre><span></span>command = [&quot;gs&quot;,
            &quot;-q&quot;,                         # quiet mode
            &quot;-g%dx%d&quot; % size,             # set output geometry (pixels)
            &quot;-r%fx%f&quot; % res,              # set input DPI (dots per inch)
            &quot;-dBATCH&quot;,                    # exit after processing
            &quot;-dNOPAUSE&quot;,                  # don&#39;t pause between pages,
            &quot;-dSAFER&quot;,                    # safe mode
            &quot;-sDEVICE=ppmraw&quot;,            # ppm driver
            &quot;-sOutputFile=%s&quot; % outfile,  # output file
            &quot;-c&quot;, &quot;%d %d translate&quot; % (-bbox[0], -bbox[1]),
                                            # adjust for image origin
            &quot;-f&quot;, infile,                 # input file
            ]

# 省略判断是GhostScript是否安装的代码
try:
    with open(os.devnull, &#39;w+b&#39;) as devnull:
        subprocess.check_call(command, stdin=devnull, stdout=devnull)
    im = Image.open(outfile)
</pre></div>


<p>最后其执行的命令为 <code>gs -q -g100x100 -r72.000000x72.000000 -dBATCH -dNOPAUSE -dSAFER -sDEVICE=ppmraw -sOutputFile=/tmp/tmpi8gqd19k -c 0 0 translate -f ../poc.png</code>, 可以看到 PIL 使用了 dSAFER 参数。这个参数限制了文件删除,重命名和命令执行等行为,只允许 gs 打开标准输出和标准错误输出。而 <code>GhostButt CVE-2017-8291</code> 刚好就是 dSAFER 参数的 bypass。</p>
<h6>GhostButt CVE-2017-8291</h6>
<p>该漏洞的详细的分析可以看 binjo 师傅的文章:<a href="https://paper.seebug.org/310/" title="GhostButt - CVE-2017-8291利用分析">GhostButt - CVE-2017-8291利用分析</a>，原先我复现和构造POC的时候花费了很多时间，后来看了这篇文章，给了我很多帮助。</p>
<p>这里我们用的 poc 和文章里面一样使用，也就是 msf 里面的 poc:poc.png。虽然这里修改 eps 后缀为 png ，但其实文件内容确实典型的 eps 文件。截取部分内容如下:</p>
<div class="codehilite"><pre><span></span><span class="c">%!PS-Adobe-3.0 EPSF-3.0</span>
<span class="c">%%BoundingBox: -0 -0 100 100</span>

<span class="c">... 省略</span>

<span class="n">currentdevice</span> <span class="n">null</span> <span class="n">false</span> <span class="n">mark</span> <span class="o">/</span><span class="n">OutputFile</span> <span class="p">(</span><span class="c">%pipe%touch /tmp/aaaaa)</span>
</pre></div>


<p>我们需要构造的命令执行payload就插入在这里 : <code>(%pipe%touch /tmp/aaaaa)</code>。</p>
<p><br/></p>
<h4>真实环境（伪）和复现</h4>
<p>我使用之前写的的 demo 函数和 Flask file-upload-sample 写了一个简单的 Web app:<a href="https://github.com/neargle/PIL-RCE-By-GhostButt/blob/master/src/app.py" title="app.py">app.py</a>，使这个本地命令执行变成一个远程命令执行。主要代码如下：</p>
<div class="codehilite"><pre><span></span>UPLOAD_FOLDER = &#39;/tmp&#39;
ALLOWED_EXTENSIONS = set([&#39;png&#39;])

app = Flask(__name__)
app.config[&#39;UPLOAD_FOLDER&#39;] = UPLOAD_FOLDER

def get_img_size(filepath=&quot;&quot;):
    &#39;&#39;&#39;获取图片长宽&#39;&#39;&#39;
    if filepath:
        img = Image.open(filepath)
        img.load()
        return img.size
    return (0, 0)

def allowed_file(filename):
    &#39;&#39;&#39;判断文件后缀是否合法&#39;&#39;&#39;
    return &#39;.&#39; in filename and \
           filename.rsplit(&#39;.&#39;, 1)[1].lower() in ALLOWED_EXTENSIONS

@app.route(&#39;/&#39;, methods=[&#39;GET&#39;, &#39;POST&#39;])
def upload_file():
    &#39;&#39;&#39;文件上传app&#39;&#39;&#39;
    if request.method == &#39;POST&#39;:
        if &#39;file&#39; not in request.files:
            flash(&#39;No file part&#39;)
            return redirect(request.url)
        image_file = request.files[&#39;file&#39;]
        if image_file.filename == &#39;&#39;:
            flash(&#39;No selected file&#39;)
            return redirect(request.url)
        if image_file and allowed_file(image_file.filename):
            filename = secure_filename(image_file.filename)
            img_path = os.path.join(app.config[&#39;UPLOAD_FOLDER&#39;], filename)
            image_file.save(img_path)
            height, width = get_img_size(img_path)
            return &#39;&lt;html&gt;&lt;body&gt;the image\&#39;s height : {}, width : {}; &lt;/body&gt;&lt;/html&gt;&#39;\
                .format(height, width)

    return &#39;&#39;&#39;
    &lt;!doctype html&gt;
    &lt;title&gt;Upload new File&lt;/title&gt;
    &lt;h1&gt;Upload new File&lt;/h1&gt;
    &lt;form method=post enctype=multipart/form-data&gt;
      &lt;p&gt;&lt;input type=file name=file&gt;
         &lt;input type=submit value=Upload&gt;
    &lt;/form&gt;
    &#39;&#39;&#39;
</pre></div>


<p>考虑到在 Windows 上面安装 PIL 和 GhostScript 可能会比较费劲，这里给大家提供一个 dockerfile。</p>
<div class="codehilite"><pre><span></span>git clone https://github.com/neargle/PIL-RCE-By-GhostButt.git &amp;&amp; cd PIL-RCE-By-GhostButt
docker-compose build
docker-compose up -d
</pre></div>


<p>访问 <a href="http://localhost:8000/">http://localhost:8000/</a> 可以看到文件上传页面。程序只使用允许后缀为 png 的文件上传，并在上传成功之后使用PIL获取图片长宽。我们修改 poc，使用 dnslog 来验证漏洞。</p>
<p>页面截图:</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/09/3471461f-7e4e-4c9f-b12a-95df0a68b39a.png-w331s" /></p>
<p>DNSlog:</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/09/cb9a76c7-cd0f-487d-9ee9-98a636c20004.png-w331s" /></p>
<p><br/></p>
<h4>总结</h4>
<h6>什么情况下我们的web服务会受到该漏洞影响</h6>
<ul>
<li>使用 Python PIL 库处理图片(应该是任意版本)</li>
<li>环境中有 GhostScript(version &lt;= 9.21)</li>
</ul>
<h6>如何修复？</h6>
<p>一个是升级 GhostScript 版本。当然更新 PIL 的版本并不能解决问题，因为 pip 不会帮我们升级 GhostScript。</p>
<p>另外在 Python 代码里面，如果我们的 web 程序不需要处理 eps 格式，除了对文件头进行判断排除 eps 文件之外，借用PIL自带的程序逻辑，也可以避免产生命令执行漏洞。PIL.Image 会在 <code>init()</code> 里面加载 PIL 目录下的所有图片格式的处理方法。</p>
<div class="codehilite"><pre><span></span><span class="k">def</span> <span class="nf">init</span><span class="p">():</span>
    <span class="k">global</span> <span class="n">_initialized</span>
    <span class="k">if</span> <span class="n">_initialized</span> <span class="o">&gt;=</span> <span class="mi">2</span><span class="p">:</span>
        <span class="k">return</span> <span class="mi">0</span>

    <span class="k">for</span> <span class="n">plugin</span> <span class="ow">in</span> <span class="n">_plugins</span><span class="p">:</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Importing </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">plugin</span><span class="p">)</span>
            <span class="nb">__import__</span><span class="p">(</span><span class="s2">&quot;PIL.</span><span class="si">%s</span><span class="s2">&quot;</span> <span class="o">%</span> <span class="n">plugin</span><span class="p">,</span> <span class="nb">globals</span><span class="p">(),</span> <span class="nb">locals</span><span class="p">(),</span> <span class="p">[])</span>
        <span class="k">except</span> <span class="ne">ImportError</span> <span class="k">as</span> <span class="n">e</span><span class="p">:</span>
            <span class="n">logger</span><span class="o">.</span><span class="n">debug</span><span class="p">(</span><span class="s2">&quot;Image: failed to import </span><span class="si">%s</span><span class="s2">: </span><span class="si">%s</span><span class="s2">&quot;</span><span class="p">,</span> <span class="n">plugin</span><span class="p">,</span> <span class="n">e</span><span class="p">)</span>
    <span class="o">...</span>
</pre></div>


<p>但同时也为我们提供了preinit()方法，该方法只加载 Bmp, Gif, Jpeg, Ppm, Png，这五种常见图片格式的处理方法。只需在用<code>open</code>函数打开图片文件之前，使用 preinit()，并设置 <code>_initialized</code> 的值大于等于2，即可避免 Image 调用 GhostScript 去解析 eps 文件：</p>
<div class="codehilite"><pre><span></span>Image.preinit()
Image._initialized = 2
</pre></div>


<p><br/></p>
<h4>最后</h4>
<p>其实 Python 开发过程中有很多经典的代码执行或者命令执行问题，包括但不限于以下几种:</p>
<ul>
<li><code>pickle.loads(user_input)</code> : yaml, pickle等库在反序列化时产生的代码执行</li>
<li><code>Template(user_input)</code> : 模板注入(SSTI)所产生的代码执行</li>
<li><code>eval(user_input)</code> : eval等代码执行函数所导致的任意代码执行</li>
<li><code>subprocess.call(user_input, shell=True)</code> : popen, subprocess.call等函数所导致的命令执行</li>
</ul>
<p>PIL 这里出现的问题是比较少被提及的，实际的生产环境中到底常不常见就只能期待大家的反馈了。欢迎任何角度的纠错以及观点独到的建议。感谢祝好。</p>
<p><br/></p>
<h4>Link</h4>
<ul>
<li><a href="https://github.com/neargle/PIL-RCE-By-GhostButt">https://github.com/neargle/PIL-RCE-By-GhostButt</a></https://github.com/neargle/PIL-RCE-By-GhostButt></li>
<li><a href="https://github.com/ArtifexSoftware/ghostpdl-downloads/releases/download/gs921/ghostscript-9.21-linux-x86_64.tgz">https://github.com/ArtifexSoftware/ghostpdl-downloads/releases/download/gs921/ghostscript-9.21-linux-x86_64.tgz</a></https://github.com/ArtifexSoftware/ghostpdl-downloads/releases/download/gs921/ghostscript-9.21-linux-x86_64.tgz></li>
<li><a href="https://paper.seebug.org/310/">https://paper.seebug.org/310/</a></li>
</ul>
      
<hr>
<p><img src="https://images.seebug.org/content/images/2017/08/0e69b04c-e31f-4884-8091-24ec334fbd7e.jpeg" alt="Paper" style="width: 220px">
本文由 Seebug Paper 发布，如需转载请注明来源。本文地址：<a href="https://paper.seebug.org/405/">https://paper.seebug.org/405/</a></p>
            
    </section>

  <nav class="pagination" role="navigation" style="padding: 3rem;">
    
      <a class="newer-posts" href="/403/"><span aria-hidden="true">&larr;</span> Abuse Cache of WinNTFileSys...</a>
    
    
      <a class="older-posts" href="/406/">phpjiami 数种解密方法 <span aria-hidden="true">&rarr;</span></a>
    
  </nav>


    

      
        <footer class="post-footer">
          <figure class="author-image">
            <a class="img" href="/users/author/?nickname=Nearg1e"
               style="background-image: url(https://images.seebug.org/uploads/2017/08/avatar.png)"><span
                class="hidden">'s Picture</span></a>
          </figure>

          <section class="author">
            <h4><a
                href="/users/author/?nickname=Nearg1e">Nearg1e</a>
            </h4>
            <p>阅读更多有关<a
                href="/users/author/?nickname=Nearg1e">该作者</a>的文章
            </p>
            
            <div class="author-meta">
            </div>
          </section>

          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          

        </footer>
      
    
    <br>
    <section class="plugin_comment">
    </section>

  </article>
  <section class="plugin_feedback"></section>


  </div>
</main>
</div>

<script type="text/javascript" src="/static/js/jquery.min.js"></script>
<script type="text/javascript" src="/static/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/static/js/index.js"></script>
<script type="text/javascript" src="/static/js/prism-loader.js"></script>
<script type="text/javascript" src="/static/js/prism.js"></script>
<script type="text/javascript" src="/static/js/jquery.ghostHunter.js"></script>
<script type="text/javascript" src="/static/js/js.cookie.js"></script>
<script type="text/javascript" src="/static/js/custom.js?t=20170821"></script>
<script type="text/javascript" src="https://www.seebug.org/static/dist2/scripts/comment_main.js"></script>
<script type="text/javascript" src="https://www.seebug.org/static/dist2/scripts/plugin_feedback.js"></script>
</body>

</html>
