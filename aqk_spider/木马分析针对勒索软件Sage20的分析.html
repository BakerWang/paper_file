<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns:wb="http://open.weibo.com/wb" xml:lang="en" lang="en">
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"/>
    <link rel="shortcut icon" href="http://bobao.360.cn/favicon.ico?v=1.1"/>
    <link rel="alternate" title="安全资讯" href="/rss?type=news" type="application/rss+xml"/>
    <link rel="alternate" title="安全知识" href="/rss?type=learning" type="application/rss+xml"/>
    <link rel="alternate" title="安全圈活动" href="/rss?type=activity" type="application/rss+xml"/>
    <link rel="alternate" title="所有漏洞" href="/rss?type=vul" type="application/rss+xml"/>
    <link rel="alternate" title="通用型漏洞" href="/rss?type=commonvul" type="application/rss+xml"/>
    <link rel="alternate" title="事件型漏洞" href="/rss?type=eventvul" type="application/rss+xml"/>
    <link rel="alternate" title="热门漏洞" href="/rss?type=hotvul" type="application/rss+xml"/>

        <title>【木马分析】针对勒索软件Sage 2.0的分析 - 安全客 - 有思想的安全新媒体</title>
    
        <meta name="keywords" content="Sage 2.0,勒索软件"/>
    
        <meta name="description" content="Sage勒索软件是勒索软件家族的一个新成员，也是勒索软件CryLocker的一个变种。从目前情况分析，隐藏在Sage背后的始作俑者与勒索软件Cerber、Locky和Spora的散布者应该师出同门。本文为针对该勒索软件的分析。"/>
        <meta property="wb:webmaster" content="224437c7be31d633"/>

    <script type="text/javascript" src="http://s7.qhimg.com/!56caa871/xpc_sync_height.js"></script>
    <link rel="stylesheet" type="text/css" href="/css/reset.css" />
    <link rel="stylesheet" type="text/css" href="/css/common_new.css?v=4.4.2.1" />
    <link rel="stylesheet" type="text/css" href="/css/jquery.notyfy.css" />
    <link rel="stylesheet" type="text/css" href="/css/notyfy.theme.default.css" />
    <link rel="stylesheet" type="text/css" href="/css/s_common.css?v=2.2.7" media="only screen and
    (max-device-width:900px), only screen and (max-width:900px)" />
    <script type="text/javascript" src="/js/jquery.min.js?v=3.1"></script>
    <script type="text/javascript" src="/js/jquery.notyfy.js"></script>
    <script type="text/javascript" src="/js/iscroll.js"></script>
    <script src="http://js.passport.qihucdn.com/5.0.3.js"></script>
    <script type="text/javascript">
        var myScroll, myNavScroll;

        function iscrollLoaded() {
            myScroll = new IScroll('#wrapper',
                {
                    scrollX: true,
                    scrollY: false,
                    bounceEasing: 'circular',
                    eventPassthrough: true,
                    preventDefault: false,
                    bounceTime: 500
                }
            );
        }

        $(function () {

            //导航横向滚动


            function setNavWidth() {

                /* 计算导航宽度 */
                var allWidth = $(window).width();
                var scroller = $('#scroller');

                if (allWidth > 900) {
                    scroller.find('ul').add(scroller.find('.scroll')).removeAttr('style');
                    scroller.css('overflow', 'visible');
                    if (myNavScroll) myNavScroll.destroy();
                } else {

                    var width = 0;
                    scroller.find('.scroll').children('ul').children('li').each(function (index, el) {
                        if (!$(this).hasClass('mobile-hide')) {
                            width += $(this).outerWidth();
                        }
                    });
                    scroller.find('ul').add(scroller.find('.scroll')).width(width);

                    if (myNavScroll) myNavScroll.destroy();

                    myNavScroll = new IScroll('#scroller', {
                        scrollX: true,
                        scrollY: false,
                        momentum: false,
                        click: true
                    });

                }

            }

            setNavWidth();
            $(window).resize(function (event) {
                setNavWidth();
            });

        });

    </script>
</head>
<body onload="iscrollLoaded();">
<div style='margin:0 auto;width:0px;height:0px;overflow:hidden;'>
    <img src=""/>
</div>

<div id="is-mobile"></div>
<div class="container">
        <div class="mobile-header">
        <div class="header clearfix">
            <div class="header-wrapper clearfix">
                <a href="/index/index" class="logo"><img class="slogan" src="/img/logo.png?v=1.5"/></a>
                                <form id="search" class="search-box" action="/search/index" method="GET">
                    <input class="keys" name="keywords" type="text" placeholder="搜索漏洞" required="required">
                    <input class="icon" type="submit" value="">
                    <input type="hidden" name="type" value=""/>
                </form>
                <div class="bug">
                    <div class="name"><span class="seled">全部</span><i class="arrow"></i></div>
                    <ul class="typelist">
                        <li data-index="3"><a href="javascript:void(0);">全部</a></li>
                        <li data-index="0"><a href="javascript:void(0);">漏洞</a></li>
                        <li data-index="1"><a href="javascript:void(0);">资讯</a></li>
                        <li data-index="2"><a href="javascript:void(0);">知识</a></li>
                    </ul>
                </div>
                                <div class="logNreg mobile-hide">
                    <div class="unlog">
                        <i></i>
                        <a href="log.html" class="log">登录</a>
                        <span>|</span>
                        <a href="reg.html" class="reg">注册</a>
                    </div>
                    <div class="loged">
                        <a href="/member/profile" class="user-center"><i></i><span class="user-name-tag">个人中心</span></a>
                        <div class="user-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting"><a href="http://i.360.cn/profile/accountmanage"
                                                               target="_blank"><i></i><span>账号设置</span></a></li>
                                <li class="alert-setting"><a href="/keywords/index"
                                                             target="_blank"><i></i><span>告警设置</span></a></li>
                                <li class="bug-alert"><a href="/myalarm/index" target="_blank"><i></i><span>漏洞告警</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mylearn/index" target="_blank"><i></i><span>我的知识</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mycourse/index" target="_blank"><i></i><span>我的课堂</span></a>
                                </li>
                                <li class="my-exit"><a
                                            href="http://login.360.cn/?src=pcw_adlab&op=logout&destUrl=http://bobao.360.cn"><i></i><span>退出系统</span></a>
                                </li>
                            </ul>
                        </div>

                        <a href="/message" class="message-center" target="_blank"><i></i><span>我的消息</span></a>
                        <div class="message-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting" style="display:none;"><a href="/myres/index"
                                                                                     target="_blank"><i></i><span>回复我的</span></a>
                                </li>
                                <li class="my-bug"><a href="/myvul/index"
                                                      target="_blank"><i></i><span>我的漏洞</span></a></li>
                                <!--<li class="my-bug"><a href="/myres/index" target="_blank"><i></i><span>我的评论</span></a></li>-->
                                <!--<li class="alert-setting"><a href="###" target="_blank"><i></i><span>提到我的</span></a>
                                </li>-->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <style type="text/css">
            .nav {
                overflow: hidden;
            }

            .nav .scroll {
                width: auto;
            }
        </style>
        <div id="wrapper">
            <div id="scroller" class="nav">
                <div class="scroll">
                    <ul class="nav-list">
                        <li ><a class="link-nav"
                                                                                 href="/index/index">首页</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/vul/index">漏洞</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/introduce/list">招聘</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/news/index">资讯</a><!--<i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/introduce/list">招聘</a></li>
                        </ul>
			-->
                        </li>
                        <li class="cur">
                        <a class="link-nav" href="/learning/index">知识</a><i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/course/index">学院</a></li>
                        </ul>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/activity/index">活动</a></li>
                        <li class="mobile-hide "><a class="link-nav"
                                                                                                   href="/ctf/index">CTF训练营</a>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/interref/list">安全内参</a></li>
                        <li ><a class="link-nav" href="/app/index">APP</a></li>

                        <!--<li ><a href="/course/index">学院</a></li>-->
                        <!--<li ><a href="/introduce/list">招聘</a></li>-->
                        <!--<li  class="mobile-hide"><a href="/ctf/index">CTF训练营</a></li>-->
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="mobile-content">
        <link rel="stylesheet" type="text/css" href="/css/news.css?v=3.5" />
<link rel="stylesheet" type="text/css" href="/ue/SyntaxHighlighter/shCoreDefault.css?v=1.0" />
<style>
    p .syntaxhighlighter {
        width: 80%;
    }
</style>

<div class="cur-pos w1000">当前位置：<a href="http://bobao.360.cn/">安全客</a> &gt;&gt; 知识详情</div>

<div class="content clearfix">
    <div class="main">
        <div class="article">
            <div id="article_box">
                <h2>【木马分析】针对勒索软件Sage 2.0的分析</h2>
                <div class="article-msg">
                    <span class="time">2017-02-23 11:08:23</span>
                    
                                        <span class="read">阅读：12012次</span>
                    <span><a style="display: none;" class="good" href="javascript:;"
                             data-target="/learning/good" data-value="g_3523"
                             data-type="learning">点赞(0)</a></span>
                    <span><a class="fav" href="javascript:;" data-target="/mylearning/add"
                             data-pk="3523" data-type="learning">收藏</a></span>
                                        <span><a style="margin-left: 4px;" class="fav" href="https://www.cert.pl/en/news/single/sage-2-0-analysis/"
                             target="_blank">来源： cert.pl</a></span>
                    
                    
                    <div style="margin-top:10px; ">
                        <a href="/member/contribute?uid=2819002922" style="color:#848e99;">
                            <img src="http://p1.qhmsg.com/dm/150_150_100/t0104d1b8b4ca36e961.jpg" data-is-avatar="true"
                                 style="border: 1px solid #d5d5d5;padding: 2px; width: 80px;height: 80px;border-radius: 43px;"/>
                        </a>

                    </div>
                    <span class="orig">作者：<a href="/member/contribute?uid=2819002922" style="color:#848e99;">興趣使然的小胃</a></span>
                                    </div>
                <hr size="1">
                <div class="article-msg">
                    <p><!-- JiaThis Button BEGIN -->

<!--
<span class="jiathis_style"><span class="jiathis_txt">分享到：</span>
	<a class="jiathis_button_weixin"></a>
	<a class="jiathis_button_tsina"></a>
    <a class="jiathis_button_tqq"></a>
    <a class="jiathis_button_qzone"></a>
    <a class="jiathis_button_renren"></a>
    <a class="jiathis_button_xiaoyou"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
</span>

-->
</p>
                </div>
                <p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></strong></span></p><p style="margin: 0px 25px 8px; white-space: normal; padding: 0px; line-height: 25px; color: rgb(70, 79, 85); word-break: break-all; font-family: Helvetica, &#39;Hiragino Sans GB&#39;, &#39;Microsoft Yahei&#39;, 微软雅黑, serif; text-indent: 0em; text-align: center; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 112, 192); font-weight: 900; font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 18px;"><img src="http://p3.qhimg.com/t01debf358c4f01f946.jpg" title="t01debf358c4f01f946.jpg" alt="http://p3.qhimg.com/t01debf358c4f01f946.jpg"/></span></p><p style="margin: 0px 25px 8px; white-space: normal; padding: 0px; line-height: 25px; color: rgb(70, 79, 85); word-break: break-all; font-family: Helvetica, &#39;Hiragino Sans GB&#39;, &#39;Microsoft Yahei&#39;, 微软雅黑, serif; text-indent: 2em; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 112, 192); font-weight: 900; font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 18px;">作者：</span><a href="http://bobao.360.cn/member/contribute?uid=2819002922" target="_blank" textvalue="興趣使然的小胃" style="text-decoration: none;"><span style="color: rgb(0, 112, 192); font-weight: 900; font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 18px;">興趣使然的小胃</span></a></p><p style="margin: 0px 25px 8px; white-space: normal; padding: 0px; line-height: 25px; color: rgb(70, 79, 85); word-break: break-all; font-family: Helvetica, &#39;Hiragino Sans GB&#39;, &#39;Microsoft Yahei&#39;, 微软雅黑, serif; text-indent: 2em; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 112, 192); font-weight: 900; font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 18px;">预估稿费：180RMB</span></p><p style="margin: 0px 25px 8px; white-space: normal; padding: 0px; line-height: 25px; color: rgb(70, 79, 85); word-break: break-all; font-family: Helvetica, &#39;Hiragino Sans GB&#39;, &#39;Microsoft Yahei&#39;, 微软雅黑, serif; text-indent: 2em; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 112, 192); font-weight: 900; font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 18px;">投稿方式：发送邮件至<a href="mailto:linwei@360.cn" target="_self" style="text-decoration: none; color: rgb(51, 51, 51); line-height: 28px;"><span style="color: rgb(0, 112, 192);">linwei#360.cn</span></a>，或登陆<a href="http://bobao.360.cn/contribute/index" target="_blank" style="text-decoration: none; color: rgb(0, 112, 192); line-height: 28px;">网页版</a>在线投稿</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">前言</span></strong></span><br/></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">Sage勒索软件是勒索软件家族的一个新成员，也是勒索软件CryLocker的一个变种。从目前情况分析，隐藏在Sage背后的始作俑者与勒索软件Cerber、Locky和Spora的散布者应该师出同门。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">在本文的分析案例中，Sage借助垃圾邮件进行传播扩散，恶意垃圾邮件中仅仅包含一个zip压缩文件，没有其他文字内容。该zip文件包含了一份Word宏文档，其主要功能是下载及安装Sage勒索软件。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">运行该勒索软件后，Windows的UAC窗口会不断重复显示，直到用户点击“Yes”按钮，允许勒索软件运行为止。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">随后勒索软件开始对文件进行加密，被加密过的文件名以“.sage”结尾。</span></p><p style="text-align:center"><img src="http://p2.qhimg.com/t01930740a8e2bd2211.png" alt="t01571456af6f7acdb7.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">勒索软件的赎金页面会告诉受害者去Tor网络页面支付赎金，但首先受害者需要输入正确的验证码才能访问该页面。</span></p><p style="text-align:center"><img src="http://p9.qhimg.com/t01b2fd5d718ad2d841.png" alt="t01be2c9d8ef8cd3696.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">验证码校验通过后，受害者可以看到Sage 2.0的主页面，如下图所示。</span></p><p style="text-align:center"><img src="http://p0.qhimg.com/t0126a5d4aee9b0c296.png" alt="t0191adeee8f44454c1.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">受害者甚至可以在这个网站与软件作者进行交流。</span></p><p style="text-align:center"><img src="http://p7.qhimg.com/t01a9a751919303790a.png" alt="t01b82ed6b1931330e7.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">Sage不会在加密工作结束后自我删除，而是将自身复制到“%APPDATA%\Roaming”目录，每次系统重启后，Sage会重新加密所有文件，直到受害者支付赎金。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">技术分析</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;"></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">接下来我们将着重从技术角度对Sage 2.0进行分析。</span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">软件的主函数流程与以下代码类似：</span></p><pre class="brush:plain;toolbar:false">int&nbsp;main(int&nbsp;argc,&nbsp;const&nbsp;char&nbsp;**argv,&nbsp;const&nbsp;char&nbsp;**envp)
{
&nbsp;&nbsp;ModCheck();
&nbsp;&nbsp;DebugCheck();
&nbsp;&nbsp;AntiDebug(v3);
&nbsp;&nbsp;if&nbsp;(&nbsp;AntiDebugCheckMutex()&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0;
&nbsp;&nbsp;GetOrGenerateMainCryptoKey();
&nbsp;&nbsp;if&nbsp;(&nbsp;IsProtectedLocale()&nbsp;)
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;FingerprintLocation(2);
&nbsp;&nbsp;&nbsp;&nbsp;Sleep(0x493E0u);
&nbsp;&nbsp;&nbsp;&nbsp;FingerprintLocation(2);
&nbsp;&nbsp;&nbsp;&nbsp;Sleep(0x927C0u);
&nbsp;&nbsp;&nbsp;&nbsp;FingerprintLocation(2);
&nbsp;&nbsp;&nbsp;&nbsp;SelfDelete();
&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;=&nbsp;0;
&nbsp;&nbsp;}
&nbsp;&nbsp;else
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;!CheckFingerprintLocation()&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0;
&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;=&nbsp;CreateThreadsAndEncrypt(&amp;mainEncKeyt);
&nbsp;&nbsp;}
&nbsp;&nbsp;return&nbsp;result;
}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">代码中包含很多的指纹信息探测及检查过程，这些过程都是常见流程，比较有趣的功能包括以下几点：</span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">1）调试开关功能</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">首次运行时软件可能会出现某些问题，因此软件内置了一个调试命令行参数功能来测试软件设置参数是否正确：</span></p><pre class="brush:plain;toolbar:false">LPWSTR&nbsp;*DebugCheck()
{
&nbsp;&nbsp;cmdLine&nbsp;=&nbsp;GetCommandLineW();
&nbsp;&nbsp;result&nbsp;=&nbsp;CommandLineToArgvW(cmdLine,&nbsp;&amp;numArgs);
&nbsp;&nbsp;if&nbsp;(&nbsp;numArgs&nbsp;==&nbsp;2&nbsp;)
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;=&nbsp;(LPWSTR&nbsp;*)result[1];
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;*result&nbsp;==&nbsp;&#39;d&#39;&nbsp;&amp;&amp;&nbsp;!*(result&nbsp;+&nbsp;1)&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;AttachConsole(0xFFFFFFFF)&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stdout&nbsp;=&nbsp;GetStdHandle(0xFFFFFFF5);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;debugmsg&nbsp;=&nbsp;sprintf_0(&quot;{\&quot;b\&quot;:\&quot;%#.*s\&quot;}&quot;,&nbsp;8,&nbsp;FingerprintDword&nbsp;+&nbsp;4);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WriteFile(stdout,&nbsp;debugmsg,&nbsp;lstrlenA(debugmsg),&nbsp;&amp;NumberOfBytesWritten,&nbsp;0);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ExitProcess(0);
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;}
}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">调试功能的运行结果如下图所示。</span></p><p style="text-align:center"><img src="http://p4.qhimg.com/t01163e809cb79544c4.png" alt="t0157eac7a44c67c721.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">这个调试功能之所以存在，可能是因为作者疏忽大意，忘了从最终版本中删除相应代码。</span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">2）区域检查功能</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">Sage 2.0的作者给了某几个国家特殊关照，如以下的区域检查代码片段：</span></p><pre class="brush:plain;toolbar:false">signed&nbsp;int&nbsp;IsProtectedLocale()
{
&nbsp;&nbsp;localeCount&nbsp;=&nbsp;GetKeyboardLayoutList(10,&nbsp;(HKL&nbsp;*)&amp;List);
&nbsp;&nbsp;if&nbsp;(&nbsp;localeCount&nbsp;&lt;=&nbsp;0&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0;
&nbsp;&nbsp;i&nbsp;=&nbsp;0;
&nbsp;&nbsp;if&nbsp;(&nbsp;localeCount&nbsp;&lt;=&nbsp;0&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0;
&nbsp;&nbsp;while&nbsp;(&nbsp;1&nbsp;)
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;next&nbsp;=&nbsp;(unsigned&nbsp;int)(&amp;List)[i]&nbsp;&amp;&nbsp;0x3FF;
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;next&nbsp;==&nbsp;0x23&nbsp;||&nbsp;next&nbsp;==&nbsp;0x3F&nbsp;||&nbsp;next&nbsp;==&nbsp;0x19&nbsp;||&nbsp;next&nbsp;==&nbsp;0x22&nbsp;||&nbsp;next&nbsp;==&nbsp;0x43&nbsp;||&nbsp;(_WORD)next&nbsp;==&nbsp;0x85&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;++i&nbsp;&gt;=&nbsp;localeCount&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0;
&nbsp;&nbsp;}
&nbsp;&nbsp;return&nbsp;1;
}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">上述代码对用户键盘布局进行了检测，next变量的数值与语种的对应关系为：</span></p><p style="text-align: center; text-indent: 0em;"><img src="http://p0.qhimg.com/t01d2068cdc4c87ba65.png" title="t019c208c34b78966fd.png" alt="http://p2.qhimg.com/t019c208c34b78966fd.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">有点令人失望的是波兰语系并不在软件的例外列表中，如果Sage作者能看到这篇文章的话，请将0x15值添加到程序代码中（注：作者的调侃）。</span><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">3）地理位置指纹识别功能</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">Sage试图通过maps.googleapis.com得到宿主机的地理位置信息以及SSID、MAC信息，如以下代码：</span></p><pre class="brush:plain;toolbar:false">strcpy_((int)arg0,&nbsp;&quot;/maps/api/browserlocation/json?browser=firefox&amp;sensor=true&quot;);
i&nbsp;=&nbsp;0;
if&nbsp;(&nbsp;v12[1]&nbsp;)
{
&nbsp;&nbsp;&nbsp;&nbsp;offset&nbsp;=&nbsp;0;
&nbsp;&nbsp;&nbsp;&nbsp;do
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ss_&nbsp;=&nbsp;(int)&amp;v12[offset&nbsp;+&nbsp;2];
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;*(_DWORD&nbsp;*)ss_&nbsp;&lt;=&nbsp;0x20u&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ToHexStrring(&amp;mac,&nbsp;(unsigned&nbsp;__int8&nbsp;*)&amp;v12[offset&nbsp;+&nbsp;12]);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;str_append(ssid,&nbsp;(_BYTE&nbsp;*)(ss_&nbsp;+&nbsp;4),&nbsp;*(_DWORD&nbsp;*)ss_);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ssid[*(_DWORD&nbsp;*)ss_]&nbsp;=&nbsp;0;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sprintf_1((int)arg0,&nbsp;&quot;&amp;wifi=mac:%s|ssid:%s|ss:%d&quot;,&nbsp;&amp;mac,&nbsp;ssid,&nbsp;(*(_DWORD&nbsp;*)(ss_&nbsp;+&nbsp;60)&nbsp;&gt;&gt;&nbsp;1)&nbsp;-&nbsp;100);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++i;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;offset&nbsp;+=&nbsp;90;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;(&nbsp;i&nbsp;&lt;&nbsp;v12[1]&nbsp;);
}
&nbsp;
//&nbsp;...
&nbsp;
DoHttpGetRequest((DWORD)&amp;dwNumberOfBytesAvailable,&nbsp;&quot;maps.googleapis.com&quot;,&nbsp;0x1BBu,&nbsp;v8)</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">特征文件判定，</span><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">文件加密流程开始前，Sage首先检查某个特征文件是否存在：</span></p><pre class="brush:plain;toolbar:false">if&nbsp;(&nbsp;CreateFileW(L&quot;C:\\Temp\\lol.txt&quot;,&nbsp;0x80000000,&nbsp;1u,&nbsp;0,&nbsp;3u,&nbsp;0,&nbsp;0)&nbsp;==&nbsp;(HANDLE)-1&nbsp;)
{
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;encryption&nbsp;code
}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">Sage作者通过判断特征文件是否存在，决定加密流程是否启动，以避免对作者本机的文件造成影响。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">若该特征文件不存在，Sage将启动加密流程。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">文件后缀清单</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;"></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">Sage不会对所有文件进行加密，它只对文件后缀清单中的文件进行加密，受影响的文件后缀如下所示：</span><br/></p><pre class="brush:plain;toolbar:false">.dat&nbsp;.mx0&nbsp;.cd&nbsp;.pdb&nbsp;.xqx&nbsp;.old&nbsp;.cnt&nbsp;.rtp&nbsp;.qss&nbsp;.qst&nbsp;.fx0&nbsp;.fx1&nbsp;.ipg&nbsp;.ert&nbsp;.pic&nbsp;.img
.cur&nbsp;.fxr&nbsp;.slk&nbsp;.m4u&nbsp;.mpe&nbsp;.mov&nbsp;.wmv&nbsp;.mpg&nbsp;.vob&nbsp;.mpeg&nbsp;.3g2&nbsp;.m4v&nbsp;.avi&nbsp;.mp4&nbsp;.flv
.mkv&nbsp;.3gp&nbsp;.asf&nbsp;.m3u&nbsp;.m3u8&nbsp;.wav&nbsp;.mp3&nbsp;.m4a&nbsp;.m&nbsp;.rm&nbsp;.flac&nbsp;.mp2&nbsp;.mpa&nbsp;.aac&nbsp;.wma&nbsp;.djv
.pdf&nbsp;.djvu&nbsp;.jpeg&nbsp;.jpg&nbsp;.bmp&nbsp;.png&nbsp;.jp2&nbsp;.lz&nbsp;.rz&nbsp;.zipx&nbsp;.gz&nbsp;.bz2&nbsp;.s7z&nbsp;.tar&nbsp;.7z&nbsp;.tgz
.rar&nbsp;.zip&nbsp;.arc&nbsp;.paq&nbsp;.bak&nbsp;.set&nbsp;.back&nbsp;.std&nbsp;.vmx&nbsp;.vmdk&nbsp;.vdi&nbsp;.qcow&nbsp;.ini&nbsp;.accd&nbsp;.db
.sqli&nbsp;.sdf&nbsp;.mdf&nbsp;.myd&nbsp;.frm&nbsp;.odb&nbsp;.myi&nbsp;.dbf&nbsp;.indb&nbsp;.mdb&nbsp;.ibd&nbsp;.sql&nbsp;.cgn&nbsp;.dcr&nbsp;.fpx
.pcx&nbsp;.rif&nbsp;.tga&nbsp;.wpg&nbsp;.wi&nbsp;.wmf&nbsp;.tif&nbsp;.xcf&nbsp;.tiff&nbsp;.xpm&nbsp;.nef&nbsp;.orf&nbsp;.ra&nbsp;.bay&nbsp;.pcd&nbsp;.dng
.ptx&nbsp;.r3d&nbsp;.raf&nbsp;.rw2&nbsp;.rwl&nbsp;.kdc&nbsp;.yuv&nbsp;.sr2&nbsp;.srf&nbsp;.dip&nbsp;.x3f&nbsp;.mef&nbsp;.raw&nbsp;.log&nbsp;.odg&nbsp;.uop
.potx&nbsp;.potm&nbsp;.pptx&nbsp;.rss&nbsp;.pptm&nbsp;.aaf&nbsp;.xla&nbsp;.sxd&nbsp;.pot&nbsp;.eps&nbsp;.as3&nbsp;.pns&nbsp;.wpd&nbsp;.wps&nbsp;.msg
.pps&nbsp;.xlam&nbsp;.xll&nbsp;.ost&nbsp;.sti&nbsp;.sxi&nbsp;.otp&nbsp;.odp&nbsp;.wks&nbsp;.vcf&nbsp;.xltx&nbsp;.xltm&nbsp;.xlsx&nbsp;.xlsm
.xlsb&nbsp;.cntk&nbsp;.xlw&nbsp;.xlt&nbsp;.xlm&nbsp;.xlc&nbsp;.dif&nbsp;.sxc&nbsp;.vsd&nbsp;.ots&nbsp;.prn&nbsp;.ods&nbsp;.hwp&nbsp;.dotm&nbsp;.dotx
.docm&nbsp;.docx&nbsp;.dot&nbsp;.cal&nbsp;.shw&nbsp;.sldm&nbsp;.txt&nbsp;.csv&nbsp;.mac&nbsp;.met&nbsp;.wk3&nbsp;.wk4&nbsp;.uot&nbsp;.rtf&nbsp;.sldx
.xls&nbsp;.ppt&nbsp;.stw&nbsp;.sxw&nbsp;.dtd&nbsp;.eml&nbsp;.ott&nbsp;.odt&nbsp;.doc&nbsp;.odm&nbsp;.ppsm&nbsp;.xlr&nbsp;.odc&nbsp;.xlk&nbsp;.ppsx
.obi&nbsp;.ppam&nbsp;.text&nbsp;.docb&nbsp;.wb2&nbsp;.mda&nbsp;.wk1&nbsp;.sxm&nbsp;.otg&nbsp;.oab&nbsp;.cmd&nbsp;.bat&nbsp;.h&nbsp;.asx&nbsp;.lua&nbsp;.pl
.as&nbsp;.hpp&nbsp;.clas&nbsp;.js&nbsp;.fla&nbsp;.py&nbsp;.rb&nbsp;.jsp&nbsp;.cs&nbsp;.c&nbsp;.jar&nbsp;.java&nbsp;.asp&nbsp;.vb&nbsp;.vbs&nbsp;.asm&nbsp;.pas
.cpp&nbsp;.xml&nbsp;.php&nbsp;.plb&nbsp;.asc&nbsp;.lay6&nbsp;.pp4&nbsp;.pp5&nbsp;.ppf&nbsp;.pat&nbsp;.sct&nbsp;.ms11&nbsp;.lay&nbsp;.iff&nbsp;.ldf
.tbk&nbsp;.swf&nbsp;.brd&nbsp;.css&nbsp;.dxf&nbsp;.dds&nbsp;.efx&nbsp;.sch&nbsp;.dch&nbsp;.ses&nbsp;.mml&nbsp;.fon&nbsp;.gif&nbsp;.psd&nbsp;.html
.ico&nbsp;.ipe&nbsp;.dwg&nbsp;.jng&nbsp;.cdr&nbsp;.aep&nbsp;.aepx&nbsp;.123&nbsp;.prel&nbsp;.prpr&nbsp;.aet&nbsp;.fim&nbsp;.pfb&nbsp;.ppj&nbsp;.indd
.mhtm&nbsp;.cmx&nbsp;.cpt&nbsp;.csl&nbsp;.indl&nbsp;.dsf&nbsp;.ds4&nbsp;.drw&nbsp;.indt&nbsp;.pdd&nbsp;.per&nbsp;.lcd&nbsp;.pct&nbsp;.prf&nbsp;.pst
.inx&nbsp;.plt&nbsp;.idml&nbsp;.pmd&nbsp;.psp&nbsp;.ttf&nbsp;.3dm&nbsp;.ai&nbsp;.3ds&nbsp;.ps&nbsp;.cpx&nbsp;.str&nbsp;.cgm&nbsp;.clk&nbsp;.cdx&nbsp;.xhtm
.cdt&nbsp;.fmv&nbsp;.aes&nbsp;.gem&nbsp;.max&nbsp;.svg&nbsp;.mid&nbsp;.iif&nbsp;.nd&nbsp;.2017&nbsp;.tt20&nbsp;.qsm&nbsp;.2015&nbsp;.2014&nbsp;.2013
.aif&nbsp;.qbw&nbsp;.qbb&nbsp;.qbm&nbsp;.ptb&nbsp;.qbi&nbsp;.qbr&nbsp;.2012&nbsp;.des&nbsp;.v30&nbsp;.qbo&nbsp;.stc&nbsp;.lgb&nbsp;.qwc&nbsp;.qbp
.qba&nbsp;.tlg&nbsp;.qbx&nbsp;.qby&nbsp;.1pa&nbsp;.ach&nbsp;.qpd&nbsp;.gdb&nbsp;.tax&nbsp;.qif&nbsp;.t14&nbsp;.qdf&nbsp;.ofx&nbsp;.qfx&nbsp;.t13&nbsp;.ebc
.ebq&nbsp;.2016&nbsp;.tax2&nbsp;.mye&nbsp;.myox&nbsp;.ets&nbsp;.tt14&nbsp;.epb&nbsp;.500&nbsp;.txf&nbsp;.t15&nbsp;.t11&nbsp;.gpc&nbsp;.qtx&nbsp;.itf
.tt13&nbsp;.t10&nbsp;.qsd&nbsp;.iban&nbsp;.ofc&nbsp;.bc9&nbsp;.mny&nbsp;.13t&nbsp;.qxf&nbsp;.amj&nbsp;.m14&nbsp;._vc&nbsp;.tbp&nbsp;.qbk&nbsp;.aci
.npc&nbsp;.qbmb&nbsp;.sba&nbsp;.cfp&nbsp;.nv2&nbsp;.tfx&nbsp;.n43&nbsp;.let&nbsp;.tt12&nbsp;.210&nbsp;.dac&nbsp;.slp&nbsp;.qb20&nbsp;.saj&nbsp;.zdb
.tt15&nbsp;.ssg&nbsp;.t09&nbsp;.epa&nbsp;.qch&nbsp;.pd6&nbsp;.rdy&nbsp;.sic&nbsp;.ta1&nbsp;.lmr&nbsp;.pr5&nbsp;.op&nbsp;.sdy&nbsp;.brw&nbsp;.vnd&nbsp;.esv
.kd3&nbsp;.vmb&nbsp;.qph&nbsp;.t08&nbsp;.qel&nbsp;.m12&nbsp;.pvc&nbsp;.q43&nbsp;.etq&nbsp;.u12&nbsp;.hsr&nbsp;.ati&nbsp;.t00&nbsp;.mmw&nbsp;.bd2&nbsp;.ac2
.qpb&nbsp;.tt11&nbsp;.zix&nbsp;.ec8&nbsp;.nv&nbsp;.lid&nbsp;.qmtf&nbsp;.hif&nbsp;.lld&nbsp;.quic&nbsp;.mbsb&nbsp;.nl2&nbsp;.qml&nbsp;.wac&nbsp;.cf8
.vbpf&nbsp;.m10&nbsp;.qix&nbsp;.t04&nbsp;.qpg&nbsp;.quo&nbsp;.ptdb&nbsp;.gto&nbsp;.pr0&nbsp;.vdf&nbsp;.q01&nbsp;.fcr&nbsp;.gnc&nbsp;.ldc&nbsp;.t05
.t06&nbsp;.tom&nbsp;.tt10&nbsp;.qb1&nbsp;.t01&nbsp;.rpf&nbsp;.t02&nbsp;.tax1&nbsp;.1pe&nbsp;.skg&nbsp;.pls&nbsp;.t03&nbsp;.xaa&nbsp;.dgc&nbsp;.mnp
.qdt&nbsp;.mn8&nbsp;.ptk&nbsp;.t07&nbsp;.chg&nbsp;.#vc&nbsp;.qfi&nbsp;.acc&nbsp;.m11&nbsp;.kb7&nbsp;.q09&nbsp;.esk&nbsp;.09i&nbsp;.cpw&nbsp;.sbf&nbsp;.mql
.dxi&nbsp;.kmo&nbsp;.md&nbsp;.u11&nbsp;.oet&nbsp;.ta8&nbsp;.efs&nbsp;.h12&nbsp;.mne&nbsp;.ebd&nbsp;.fef&nbsp;.qpi&nbsp;.mn5&nbsp;.exp&nbsp;.m16&nbsp;.09t
.00c&nbsp;.qmt&nbsp;.cfdi&nbsp;.u10&nbsp;.s12&nbsp;.qme&nbsp;.int?&nbsp;.cf9&nbsp;.ta5&nbsp;.u08&nbsp;.mmb&nbsp;.qnx&nbsp;.q07&nbsp;.tb2&nbsp;.say
.ab4&nbsp;.pma&nbsp;.defx&nbsp;.tkr&nbsp;.q06&nbsp;.tpl&nbsp;.ta2&nbsp;.qob&nbsp;.m15&nbsp;.fca&nbsp;.eqb&nbsp;.q00&nbsp;.mn4&nbsp;.lhr&nbsp;.t99
.mn9&nbsp;.qem&nbsp;.scd&nbsp;.mwi&nbsp;.mrq&nbsp;.q98&nbsp;.i2b&nbsp;.mn6&nbsp;.q08&nbsp;.kmy&nbsp;.bk2&nbsp;.stm&nbsp;.mn1&nbsp;.bc8&nbsp;.pfd&nbsp;.bgt
.hts&nbsp;.tax0&nbsp;.cb&nbsp;.resx&nbsp;.mn7&nbsp;.08i&nbsp;.mn3&nbsp;.ch&nbsp;.meta&nbsp;.07i&nbsp;.rcs&nbsp;.dtl&nbsp;.ta9&nbsp;.mem&nbsp;.seam
.btif&nbsp;.11t&nbsp;.efsl&nbsp;.$ac&nbsp;.emp&nbsp;.imp&nbsp;.fxw&nbsp;.sbc&nbsp;.bpw&nbsp;.mlb&nbsp;.10t&nbsp;.fa1&nbsp;.saf&nbsp;.trm&nbsp;.fa2
.pr2&nbsp;.xeq&nbsp;.sbd&nbsp;.fcpa&nbsp;.ta6&nbsp;.tdr&nbsp;.acm&nbsp;.lin&nbsp;.dsb&nbsp;.vyp&nbsp;.emd&nbsp;.pr1&nbsp;.mn2&nbsp;.bpf&nbsp;.mws
.h11&nbsp;.pr3&nbsp;.gsb&nbsp;.mlc&nbsp;.nni&nbsp;.cus&nbsp;.ldr&nbsp;.ta4&nbsp;.inv&nbsp;.omf&nbsp;.reb&nbsp;.qdfx&nbsp;.pg&nbsp;.coa&nbsp;.rec&nbsp;.rda
.ffd&nbsp;.ml2&nbsp;.ddd&nbsp;.ess&nbsp;.qbmd&nbsp;.afm&nbsp;.d07&nbsp;.vyr&nbsp;.acr&nbsp;.dtau&nbsp;.ml9&nbsp;.bd3&nbsp;.pcif&nbsp;.cat&nbsp;.h10
.ent&nbsp;.fyc&nbsp;.p08&nbsp;.jsd&nbsp;.zka&nbsp;.hbk&nbsp;.mone&nbsp;.pr4&nbsp;.qw5&nbsp;.cdf&nbsp;.gfi&nbsp;.cht&nbsp;.por&nbsp;.qbz&nbsp;.ens
.3pe&nbsp;.pxa&nbsp;.intu&nbsp;.trn&nbsp;.3me&nbsp;.07g&nbsp;.jsda&nbsp;.2011&nbsp;.fcpr&nbsp;.qwmo&nbsp;.t12&nbsp;.pfx&nbsp;.p7b&nbsp;.der&nbsp;.nap
.p12&nbsp;.p7c&nbsp;.crt&nbsp;.csr&nbsp;.pem&nbsp;.gpg&nbsp;.key</pre><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">加密过程</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">勒索软件最有趣的部分莫过于文件的加密过程。在勒索软件中，Sage 2.0是非常特别的一个存在，因为它采用了椭圆曲线加密算法对文件进行加密。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">加密所使用的椭圆曲线函数是“y^2 = x^3 + 486662x^x + x”，使用的素数范围是“2^255 – 19”，基数变量x=9。Sage所采用的椭圆曲线是著名的Curve25519曲线，是现代密码学中最先进的技术。Curve25519不仅是最快的ECC（Elliptic Curve Cryptography，椭圆曲线加密算法）曲线之一，也不易受到弱RNG（Random Number Generator，随机数生成器）的影响，设计时考虑了侧信道攻击，避免了许多潜在的实现缺陷，并且很有可能不存在第三方内置后门。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">Sage将Curve25519算法与硬编码的公钥一起使用生成共享密钥。主密钥生成算法如下所示（结构体和函数名由我们重新命名）：</span></p><pre class="brush:plain;toolbar:false">int&nbsp;__cdecl&nbsp;GenerateMainKey(curve_key&nbsp;*result,&nbsp;const&nbsp;void&nbsp;*publicKey)
{
&nbsp;&nbsp;char&nbsp;mysecret[32];&nbsp;//&nbsp;[esp+4h]&nbsp;[ebp-40h]@1
&nbsp;&nbsp;char&nbsp;shared[32];&nbsp;//&nbsp;[esp+24h]&nbsp;[ebp-20h]@1
&nbsp;
&nbsp;&nbsp;result-&gt;flag&nbsp;=&nbsp;1;
&nbsp;&nbsp;GenerateCurve25519SecretKey(mysecret);
&nbsp;&nbsp;ComputeCurve25519MatchingPublicKey(result-&gt;gpk,&nbsp;mysecret);
&nbsp;&nbsp;ComputeCurve25519SharedSecret(shared,&nbsp;mysecret,&nbsp;publicKey);
&nbsp;&nbsp;ConvertBytesToCurve22519SecretKey(shared);
&nbsp;&nbsp;ComputeCurve25519MatchingPublicKey(result-&gt;pk,&nbsp;shared);
&nbsp;&nbsp;return&nbsp;0;
}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">这段代码看起来像是基于ECC的DH密钥交换协议（ECDH，Elliptic Curve Diffie-Hellman）的实现代码，但其中没有任何保存算法私钥的流程（私钥只用于数据解密用途，可由软件作者可以使用自己的私钥随时创建）。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">代码中复杂的函数只是ECC函数（我们称之为CurveEncrypt函数）的封装而已。例如，计算匹配公钥的函数是curve25519(secretKey, basePoint)，其中basePoint等于9（即9后面跟31个零）。</span></p><pre class="brush:plain;toolbar:false">int&nbsp;__cdecl&nbsp;ComputeCurve25519MatchingPublicKey(char&nbsp;*outPtr,&nbsp;char&nbsp;*randbytes)
{
&nbsp;&nbsp;char&nbsp;key[32];&nbsp;//&nbsp;[esp+8h]&nbsp;[ebp-20h]@1
&nbsp;
&nbsp;&nbsp;qmemcpy(key,&nbsp;&amp;Curve25519BasePoint,&nbsp;sizeof(key));
&nbsp;&nbsp;key[31]&nbsp;=&nbsp;Curve25519BasePointEnd&nbsp;&amp;&nbsp;0x7F;
&nbsp;&nbsp;return&nbsp;CurveEncrypt(outPtr,&nbsp;randbytes,&nbsp;key);
}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">共享密钥的计算与之类似，不同的是所使用的是公钥而不是常数基数，如下：</span></p><pre class="brush:plain;toolbar:false">int&nbsp;__cdecl&nbsp;ComputeCurve25519SharedSecret(char&nbsp;*shared,&nbsp;char&nbsp;*mySecret,&nbsp;const&nbsp;void&nbsp;*otherPublicKey)
{
&nbsp;&nbsp;char&nbsp;a3a[32];&nbsp;//&nbsp;[esp+8h]&nbsp;[ebp-20h]@1
&nbsp;
&nbsp;&nbsp;qmemcpy(a3a,&nbsp;otherPublicKey,&nbsp;sizeof(a3a));
&nbsp;&nbsp;a3a[31]&nbsp;&amp;=&nbsp;0x7Fu;
&nbsp;&nbsp;return&nbsp;CurveEncrypt(shared,&nbsp;mySecret,&nbsp;a3a);
}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">得益于Curve25519的精妙设计，任意序列随机字节与密钥之间的相互转换是非常容易的，只需要对几个比特进行修改就已足够：</span></p><pre class="brush:plain;toolbar:false">curve_key&nbsp;*__cdecl&nbsp;ConvertBytesToCurve22519SecretKey(curve_key&nbsp;*a1)
{
&nbsp;&nbsp;curve_key&nbsp;*result;&nbsp;//&nbsp;eax@1
&nbsp;&nbsp;char&nbsp;v2;&nbsp;//&nbsp;cl@1
&nbsp;
&nbsp;&nbsp;result&nbsp;=&nbsp;a1;
&nbsp;&nbsp;v2&nbsp;=&nbsp;a1-&gt;gpk[31];
&nbsp;&nbsp;result-&gt;gpk[0]&nbsp;&amp;=&nbsp;248u;
&nbsp;&nbsp;a1-&gt;gpk[31]&nbsp;=&nbsp;v2&nbsp;&amp;&nbsp;0x3F&nbsp;|&nbsp;0x40;
&nbsp;&nbsp;return&nbsp;result;
}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">同理，私钥的生成也非常容易，只需要生成一个32字节的随机数，将其转换为私钥即可：</span></p><pre class="brush:plain;toolbar:false">int&nbsp;__cdecl&nbsp;GenerateCurve25519SecretKey(_BYTE&nbsp;*buffer)
{
&nbsp;&nbsp;char&nbsp;v1;&nbsp;//&nbsp;al@1
&nbsp;
&nbsp;&nbsp;getSecureRandom(32,&nbsp;(int)buffer);
&nbsp;&nbsp;v1&nbsp;=&nbsp;buffer[31];
&nbsp;&nbsp;*buffer&nbsp;&amp;=&nbsp;248u;
&nbsp;&nbsp;buffer[31]&nbsp;=&nbsp;v1&nbsp;&amp;&nbsp;0x3F&nbsp;|&nbsp;0x40;
&nbsp;&nbsp;return&nbsp;0;
}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">以上就是密钥生成的全部流程。至于文件加密流程，Sage首先是使用Curve25519对文件进行首次加密，再利用ChaCha算法进行后续加密（同样也是非常规加密方法），加密密钥附在输出文件的尾部：</span></p><pre class="brush:plain;toolbar:false">GenerateCurve25519SecretKey(&amp;secretKey);
ComputeCurve25519MatchingPublicKey(pubKey,&nbsp;&amp;secretKey);
ComputeCurve25519SharedSecret(sharedSecret,&nbsp;&amp;secretKey,&nbsp;ellipticCurveKey-&gt;pk);
&nbsp;
//
&nbsp;
ChaChaInit(&amp;chaCha20key,&nbsp;(unsigned&nbsp;__int8&nbsp;*)sharedSecret,&nbsp;(unsigned&nbsp;__int8&nbsp;*)minikey);
&nbsp;
while&nbsp;(bytesLeftToRead)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Read&nbsp;from&nbsp;file&nbsp;to&nbsp;lpBuff
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;ChaChaEncrypt(&amp;chaCha20key,&nbsp;lpBuff,&nbsp;lpBuff,&nbsp;numBytesRead);
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Write&nbsp;from&nbsp;file&nbsp;to&nbsp;lpBuff
}
&nbsp;
AppendFileKeyInfo(hFile_1,&nbsp;ellipticCurveKey,&nbsp;&amp;FileSize,&nbsp;pubKey,&nbsp;a5);</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">AppendFileKeyInfo函数的功能是将共享密钥和pubKey附加到文件尾部：</span></p><pre class="brush:plain;toolbar:false">int&nbsp;__cdecl&nbsp;AppendFileKeyInfo(HANDLE&nbsp;hFile,&nbsp;curve_key&nbsp;*sharedKey,&nbsp;DWORD&nbsp;*dataSize,&nbsp;char&nbsp;*pubKey,&nbsp;int&nbsp;a5)
{
&nbsp;&nbsp;DWORD&nbsp;dataSizeV;&nbsp;//&nbsp;edx@1
&nbsp;&nbsp;int&nbsp;result;&nbsp;//&nbsp;eax@3
&nbsp;&nbsp;_DWORD&nbsp;buffer[24];&nbsp;//&nbsp;[esp+8h]&nbsp;[ebp-60h]@1
&nbsp;
&nbsp;&nbsp;buffer[0]&nbsp;=&nbsp;0x5A9EDEAD;
&nbsp;&nbsp;qmemcpy(&amp;buffer[1],&nbsp;sharedKey,&nbsp;0x20u);
&nbsp;&nbsp;qmemcpy(&amp;buffer[9],&nbsp;pubKey,&nbsp;0x20u);
&nbsp;&nbsp;dataSizeV&nbsp;=&nbsp;*dataSize;
&nbsp;&nbsp;buffer[19]&nbsp;=&nbsp;dataSize[1];
&nbsp;&nbsp;buffer[18]&nbsp;=&nbsp;dataSizeV;
&nbsp;&nbsp;buffer[21]&nbsp;=&nbsp;a5;
&nbsp;&nbsp;buffer[20]&nbsp;=&nbsp;0;
&nbsp;&nbsp;buffer[22]&nbsp;=&nbsp;0x5A9EBABE;
&nbsp;&nbsp;if&nbsp;(&nbsp;WriteFile(hFile,&nbsp;buffer,&nbsp;0x60u,&nbsp;(LPDWORD)&amp;sharedKey,&nbsp;0)&nbsp;&amp;&amp;&nbsp;sharedKey&nbsp;==&nbsp;(curve_key&nbsp;*)96&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;=&nbsp;0;
&nbsp;&nbsp;else
&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;=&nbsp;-5;
&nbsp;&nbsp;return&nbsp;result;
}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">ChaCha并不是勒索软件常用的算法，它与Salsa20算法紧密相关（勒索软件Petya用的就是Salsa20算法）。我们并不知道为何Sage不适用AES，有可能它只是想特立独行而已。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">换而言之，对于每一个加密文件，都对应有两组密钥+一个密钥对，对应关系如下所示：</span></p><pre class="brush:plain;toolbar:false">my_secret&nbsp;&lt;-&nbsp;random
my_public&nbsp;&lt;-&nbsp;f(my_secret)&nbsp;&nbsp;#&nbsp;gpk
&nbsp;
sh_secret&nbsp;&lt;-&nbsp;f(my_secret,&nbsp;c2_public)
sh_public&nbsp;&lt;-&nbsp;f(sh_secret)&nbsp;#&nbsp;pk
&nbsp;
fl_secret&nbsp;&lt;-&nbsp;random
fl_public&nbsp;&lt;-&nbsp;f(fl_secret)
fl_shared&nbsp;&lt;-&nbsp;f(fl_secret,&nbsp;sh_public)
&nbsp;
chachakey&nbsp;&lt;-&nbsp;f(fl_shared)</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">Sage完成加密工作后，我们只获得了其中my_public、sh_public以及fl_shared的值，我们还需要获得chachakey的值才能正确解密文件。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">Sage采用了相当牢固的加密方法，可以在离线状态下加密文件，不需要连接C&amp;C服务器进行密钥协商，原因在于加密所需要的公钥已经硬编码在勒索软件中，并且经过了非对称加密处理。如果Sage作者没有犯太大的编程错误的话，那么文件的解密恢复就渺渺无期。当然，主加密密钥最终总是有可能会被泄露或者公布出来的。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">附加信息</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">匹配Sage所使用的Yara规则：</span></strong></span></p><pre class="brush:plain;toolbar:false">rule&nbsp;sage
{
&nbsp;&nbsp;&nbsp;&nbsp;meta:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;author=&quot;msm&quot;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;strings:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;ransom&nbsp;message&nbsp;*/
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ransom1&nbsp;=&nbsp;&quot;ATTENTION!&nbsp;ALL&nbsp;YOUR&nbsp;FILES&nbsp;WERE&nbsp;ENCRYPTED!&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ransom2&nbsp;=&nbsp;&quot;SAGE&nbsp;2.0&nbsp;uses&nbsp;military&nbsp;grade&nbsp;elliptic&nbsp;curve&nbsp;cryptography&nbsp;and&nbsp;you&quot;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;other&nbsp;strings&nbsp;*/
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$str0&nbsp;=&nbsp;&quot;!Recovery_%s.html&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$str1&nbsp;=&nbsp;&quot;/CREATE&nbsp;/TN&nbsp;\&quot;%s\&quot;&nbsp;/TR&nbsp;\&quot;%s\&quot;&nbsp;/SC&nbsp;ONLOGON&nbsp;/RL&nbsp;HIGHEST&nbsp;/F&quot;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;code&nbsp;*/
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$get_subdomain&nbsp;=&nbsp;{8B&nbsp;0D&nbsp;??&nbsp;??&nbsp;40&nbsp;00&nbsp;6A&nbsp;??&nbsp;[2]&nbsp;A1&nbsp;??&nbsp;??&nbsp;40&nbsp;00&nbsp;5?&nbsp;5?&nbsp;50&nbsp;51&nbsp;53&nbsp;E8}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$debug_file_name&nbsp;=&nbsp;{6A&nbsp;00&nbsp;6A&nbsp;01&nbsp;68&nbsp;00&nbsp;00&nbsp;00&nbsp;80&nbsp;68&nbsp;[4]&nbsp;FF&nbsp;15&nbsp;[4]&nbsp;83&nbsp;F8&nbsp;FF}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$get_request_subdomain&nbsp;=&nbsp;{74&nbsp;??&nbsp;A1&nbsp;[4]&nbsp;5?&nbsp;5?&nbsp;68&nbsp;??&nbsp;??&nbsp;40&nbsp;00&nbsp;E8}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$get_ec_pubkey&nbsp;=&nbsp;{68&nbsp;[2]&nbsp;40&nbsp;00&nbsp;68&nbsp;[2]&nbsp;40&nbsp;00&nbsp;E8&nbsp;[4]&nbsp;68&nbsp;B9&nbsp;0B&nbsp;00&nbsp;00&nbsp;6A&nbsp;08&nbsp;E8}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$get_extensions&nbsp;=&nbsp;{&nbsp;8B&nbsp;35&nbsp;[2]&nbsp;40&nbsp;00&nbsp;[0-3]&nbsp;80&nbsp;3E&nbsp;00&nbsp;74&nbsp;24&nbsp;}
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;condition:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;all&nbsp;of&nbsp;($ransom*)&nbsp;and&nbsp;any&nbsp;of&nbsp;($str*)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;any&nbsp;of&nbsp;($get_subdomain,&nbsp;$debug_file_name,&nbsp;$get_request_subdomain,&nbsp;$get_ec_pubkey,&nbsp;$get_extensions)
}</pre><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">样本哈希值（SHA256）：</span></strong></span></p><pre class="brush:plain;toolbar:false">sample&nbsp;1,&nbsp;362baeb80b854c201c4e7a1cfd3332fd58201e845f6aebe7def05ff0e00bf339
sample&nbsp;2,&nbsp;3b4e0460d4a5d876e7e64bb706f7fdbbc6934e2dea7fa06e34ce01de8b78934c
sample&nbsp;3,&nbsp;ccd6a495dfb2c5e26cd65e34c9569615428801e01fd89ead8d5ce1e70c680850
sample&nbsp;4,&nbsp;8a0a191d055b4b4dd15c66bfb9df223b384abb75d4bb438594231788fb556bc2
sample&nbsp;5,&nbsp;0ecf3617c1d3313fdb41729c95215c4d2575b4b11666c1e9341f149d02405c05</pre><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">其他资料：</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><a href="https://www.govcert.admin.ch/blog/27/saga-2.0-comes-with-ip-generation-algorithm-ipga" _src="https://www.govcert.admin.ch/blog/27/saga-2.0-comes-with-ip-generation-algorithm-ipga">https://www.govcert.admin.ch/blog/27/saga-2.0-comes-with-ip-generation-algorithm-ipga</a>&nbsp;</span></p></p>
                <hr/>
                <p style="text-align: center;">
                    <img src="http://bobao.360.cn/img/app.jpeg"/>
                    <img src="http://bobao.360.cn/img/weixin.jpeg"/>
                </p>
                                <p>本文由 安全客 翻译，转载请注明“转自安全客”，并附上链接。<br/><a class="text-more" href="https://www.cert.pl/en/news/single/sage-2-0-analysis/" target="_blank">原文链接：https://www.cert.pl/en/news/single/sage-2-0-analysis/</a></p>
                            </div>
            <div style="margin-top: 20px;background-color:#FFFFFF">
    <input type="hidden" id="detail_title" name="detail_title" value="【木马分析】针对勒索软件Sage 2.0的分析 - 安全客 - 有思想的安全新媒体" />
    <input type="hidden" id="use_nickname" name="use_nickname" value="0" />
    <a name="mao"></a>
    <div class="reg-log mobile-hiden">
        <div class="" id="userTo">   
            <div id="to-list" class="input-text" style="">
                <textarea disabled="disabled" class="hide"  id="comment-content" to="to"></textarea>
                <ul id="preadded" style="display:none">       
                </ul>
                <div id="to-auto" style="width: 200px">
                    <ul id="feed">
                    </ul>
                </div>
            </div>
        </div>
        <input type="hidden" id="source-id" value="3523" />
        <input type="hidden" id="source-type" value="learning" />
        <input type="hidden" id="post-comment-url" value="/comment/add" />
        <input type="hidden" id="post-nickname-url-ajax" value="/comment/randnicknameajax" />
        <input type="hidden" id="post-check-login-url-ajax" value="/comment/checklogin" />
        <input type="hidden" id="stoken_comment_set" value="ea3898fb4df38673fdeb61c458234054">                 <span class="join">参与讨论，请先 <a href="javascript:;" class="comment-login">登录</a> | <a href="javascript:;" class="comment-reg">注册</a> |  <a href="javascript:;" class="anonymous-comment">匿名评论</a></span>
            </div>
    <div class="mobile-hide" style="width: 870px; margin: 0 auto;">
        <label style="vertical-align:middle;" for="use_nickname">匿名</label> 
        <input style="vertical-align:middle;" id="trigger-nickname" name="use_nickname" class="use_nickname" type="checkbox" value="0" />

        <a href="javascript:;" class="apply-use button" id="submit-comment" data-target="/comment/add">发布</a>
    </div>


    <div class="clearfix"></div>
    <div class="comments">
        <div class="comments-head">
            <span class="title">用户评论</span>
        </div>
                <div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src='http://p1.qhmsg.com/dm/48_48_100/t01857c1978f2c4da10.jpg'/>              
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="390662405" class="response" data-bind-id="390662405" data-target="12002" user-name="聪明的狗子" href="javascript:;">
                聪明的狗子            </a>
                        <span class="comment-time">2017-02-24 10:45:26</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="390662405" data-target="12002">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_12002" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">这个是翻译哈~</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
<div class="clearfix re-comment">
    <div class="comment-quote">  
        <div class="comment-user">
            <a href="javascript:;" class="response" data-bind-id="323090143" data-target="11983">教主</a> <span class="comment-time">2017-02-23 18:39:06</span>            <div class="comment-action">                        <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="323090143" data-target="11983">回复</a></span>&nbsp;|&nbsp;                        <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_11983" data-type="comment">点赞</a></span>            </div>
            <p>文章分析的这么详细居然才给180</p>
        </div>
    </div>
        </div>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/1x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="323090143" class="response" data-bind-id="323090143" data-target="11983" user-name="教主" href="javascript:;">
                教主            </a>
                        <span class="comment-time">2017-02-23 18:39:06</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="323090143" data-target="11983">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_11983" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">文章分析的这么详细居然才给180</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>

        <a class="more-long comment-more" href="javascript:;" data-target="/comment/more" data-type="learning" data-source-id="3523" data-page="2">查看更多</a>
            </div>
</div>
<script>
    $(function () {
        $('.anonymous-comment').click(function () {
            $(".join").hide();
            $(".reg-log textarea").first().removeAttr("disabled").show();
            $('#use_nickname').val('1');
//            $('#trigger-nickname').attr('checked', true);
            $('#trigger-nickname').trigger('click');
        });
        //为所有复选框绑定事件
//        checkbox_on_click();
        //ajax随机获取昵称
//        randnicknameajax(0);
        //ajax检测登录状态
        comment_check_login();
    });



    function input_checkbox(flag) {
        $('input:checkbox').each(function () {
            var value = flag ? 1 : 0;
            $(this).prop('checked', flag);
            $(this).val(value);
        });
    }

//ajax随机获取昵称
    function randnicknameajax(flag) {
        $.ajax({
            type: 'POST',
            url: $('#post-nickname-url-ajax').val(),
            data: {limit: 1, flag: flag},
            dataType: "json",
            success: function (data) {
                $('#nick-name').val(data.data[0]);
                _nick_name=data.data[0];
            }
        });
    }
    $();
//ajax检测登录状态
    function comment_check_login() {
        $.ajax({
            type: 'POST',
            url: $('#post-check-login-url-ajax').val(),
            data: {},
            dataType: "json",
            success: function (data) {
                if (data.success) {
                    $('.join').hide();
                    $(".reg-log textarea").first().removeAttr("disabled").show();
                    $("#span_use_nickname").show();
                    $('#use_nickname').val('0');
                    $('#use_nickname').attr('checked', false);
                }
            }
        });
    }
</script>        </div>
    </div>
    <div class="side-bar">
        <div class="mod hot-news">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-hot"></i><span>热门知识</span></h2>
    </div>
    <ul class="links-list">
                                <li><a href="/learning/detail/4411.html" alt="【漏洞预警】一个换行符引发的奥斯卡0day漏洞(CVE-2017-8759)重现——最新的Office高级威胁攻击预警" target="_blank">【漏洞预警】一个换行符引发的奥斯卡...</a></li>
                                <li><a href="/learning/detail/4416.html" alt="【漏洞预警】Microsoft .NET Framework漏洞（CVE–2017–8759）预警" target="_blank">【漏洞预警】Microsoft .NE...</a></li>
                                <li><a href="/learning/detail/4414.html" alt="【技术分享】妙用JavaScript绕过XSS过滤" target="_blank">【技术分享】妙用JavaScrip...</a></li>
                                <li><a href="/learning/detail/4418.html" alt="【技术分享】利用威胁情报数据平台拓展APT攻击线索一例" target="_blank">【技术分享】利用威胁情报数据平台拓...</a></li>
                                <li><a href="/learning/detail/4417.html" alt="【知识】9月15日 - 每日安全知识热点" target="_blank">【知识】9月15日 - 每日安全知识热...</a></li>
                                <li><a href="/learning/detail/4425.html" alt="【安全报告】XShellGhost事件技术回顾报告" target="_blank">【安全报告】XShellGhost事件...</a></li>
            </ul>
</div>        <!-- 友情链接 -->
        <div class="mod blog-links mobile-hide">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-link"></i><span>友情链接</span></h2>
        <a href="/links/index.html" class="more">更多<i></i></a>
    </div>
        <ul class="links-list">
                <li><a href="http://bbs.360safe.com" alt="360安全社区" target="_blank">360安全社区</a></li>
                <li><a href="http://zhuji.360.cn" alt="360主机卫士" target="_blank">360主机卫士</a></li>
                <li><a href="http://blogs.360.cn/" alt="奇虎360技术博客" target="_blank">奇虎360技术博客</a></li>
                <li><a href="http://wangzhan.360.cn/" alt="360网站卫士" target="_blank">360网站卫士</a></li>
                <li><a href="http://webscan.360.cn/" alt="360网站安全检测" target="_blank">360网站安全检测</a></li>
                <li><a href="http://research.360.cn/report/" alt="360研究报告" target="_blank">360研究报告</a></li>
                <li><a href="http://unicorn.360.cn/" alt="360 Unicorn Team" target="_blank">360 Unicorn Team</a></li>
                <li><a href="http://appscan.360.cn/" alt="360捉虫猎手" target="_blank">360捉虫猎手</a></li>
                <li><a href="https://threathunter.org/" alt="ThreatHunter社区" target="_blank">ThreatHunter社区</a></li>
                <li><a href="http://security.360.cn/" alt="360安全应急响应中心" target="_blank">360安全应急响应中心</a></li>
            </ul>
    </div>
        <!-- 联系我们 -->
        <div class="mod contact mobile-hide" style="text-align:center">
    <div class="head-bar clearfix">
        <h2><i></i><span>关注我们</span></h2>
    </div>
    <!-- 微信关注 -->
    <ul class="contact-way">
        <li><a>微信关注</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/qrcode_adlab_weixin.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
    <!-- APP下载 -->
    <ul class="contact-way">
        <li><a>安全播报APP</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/scan_code_big.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
</div>

    </div>
</div>

<script type="text/javascript" src="/js/jquery-ui.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/jquery.noty.packaged.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/common.js?v=4.5"></script>
<script>$(function() {sync_count('comment');});</script>


<!-- 语法高亮 -->
<script type="text/javascript" src="/ue/SyntaxHighlighter/shCore.js"></script>
<script type="text/javascript">SyntaxHighlighter.all();sync_count('vul');sync_count('news');sync_count('learning');sync_count('activity');sync_count('course');sync_count('ctf');</script>
    </div>

        <div class="footer">
        <div class="friend-link">
            <a href="http://www.360.cn/" target="_blank">360首页</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">关于我们</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">联系我们</a>
            <span>|</span>
            <a href="/links/index.html" target="_blank">友情链接</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">招贤纳士</a>
        </div>
        <div class="copy">
            Copyright &copy; 360网络攻防实验室 All Rights Reserved <span class="copy_icp">京ICP证080047号[京ICP备08010314号-6]</span>
        </div>
    </div>
    
</div>

<!--奇舞团统计-->

<script src='https://s.ssl.qhimg.com/static/f5407c785655e6a1/monitor_analytic.js'></script>
<script>
    monitor.setProject('QH_171_1').getTrack().getClickAndKeydown().getClickHeatmap(10, 1);
</script>

<div class="hide">
    <script src="https://s95.cnzz.com/z_stat.php?id=1253147824&web_id=1253147824" language="JavaScript"></script>
</div>
<div class="backToTop_wrap off">
    <a id="back_to_top" class="backToTop" href="javascript:;" title="返回顶部"></a>
</div>
<script>
    var $backToTop_wrap = $(".backToTop_wrap"),
        $backToTop_btn = $("#back_to_top");

    if ($(window).scrollTop() > 100) {
        $backToTop_wrap.removeClass("off");
    }
    else {
        $backToTop_wrap.addClass("off");
    }

    $(window).on("scroll", function () {
        if ($(this).scrollTop() > 100) {
            $backToTop_wrap.removeClass("off");
        }
        else {
            $backToTop_wrap.addClass("off");
        }
    });

    $backToTop_btn.on("click", function () {
        $("html, body").animate({scrollTop: 0}, 120);
    });

    $(function () {
        var navlist = $('.nav-list > li');

        navlist.each(function () {
            $(this).on('mouseenter', function () {
                $(this).addClass('selected');
            });

            $(this).on('mouseleave', function () {
                $(this).removeClass('selected');
            });
        });
    })
</script>



</body>
</html>
