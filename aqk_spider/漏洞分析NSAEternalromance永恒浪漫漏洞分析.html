<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns:wb="http://open.weibo.com/wb" xml:lang="en" lang="en">
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"/>
    <link rel="shortcut icon" href="http://bobao.360.cn/favicon.ico?v=1.1"/>
    <link rel="alternate" title="安全资讯" href="/rss?type=news" type="application/rss+xml"/>
    <link rel="alternate" title="安全知识" href="/rss?type=learning" type="application/rss+xml"/>
    <link rel="alternate" title="安全圈活动" href="/rss?type=activity" type="application/rss+xml"/>
    <link rel="alternate" title="所有漏洞" href="/rss?type=vul" type="application/rss+xml"/>
    <link rel="alternate" title="通用型漏洞" href="/rss?type=commonvul" type="application/rss+xml"/>
    <link rel="alternate" title="事件型漏洞" href="/rss?type=eventvul" type="application/rss+xml"/>
    <link rel="alternate" title="热门漏洞" href="/rss?type=hotvul" type="application/rss+xml"/>

        <title>【漏洞分析】NSA Eternalromance （永恒浪漫） 漏洞分析 - 安全客 - 有思想的安全新媒体</title>
    
        <meta name="keywords" content="Eternalromance,Eternalromance分析."/>
    
        <meta name="description" content="影子经纪（Shadow Brokers）声称攻破了为NSA开发网络武器的美国黑客团队方程式组织（Equation Group）黑客组织的计算机系统，并下载了他们大量的攻击工具（包括恶意软件、私有的攻击框架及其它攻击工具）。本篇文章为针对其泄露的Eternalromance （永恒浪漫） 漏洞分析。"/>
        <meta property="wb:webmaster" content="224437c7be31d633"/>

    <script type="text/javascript" src="http://s7.qhimg.com/!56caa871/xpc_sync_height.js"></script>
    <link rel="stylesheet" type="text/css" href="/css/reset.css" />
    <link rel="stylesheet" type="text/css" href="/css/common_new.css?v=4.4.2.1" />
    <link rel="stylesheet" type="text/css" href="/css/jquery.notyfy.css" />
    <link rel="stylesheet" type="text/css" href="/css/notyfy.theme.default.css" />
    <link rel="stylesheet" type="text/css" href="/css/s_common.css?v=2.2.7" media="only screen and
    (max-device-width:900px), only screen and (max-width:900px)" />
    <script type="text/javascript" src="/js/jquery.min.js?v=3.1"></script>
    <script type="text/javascript" src="/js/jquery.notyfy.js"></script>
    <script type="text/javascript" src="/js/iscroll.js"></script>
    <script src="http://js.passport.qihucdn.com/5.0.3.js"></script>
    <script type="text/javascript">
        var myScroll, myNavScroll;

        function iscrollLoaded() {
            myScroll = new IScroll('#wrapper',
                {
                    scrollX: true,
                    scrollY: false,
                    bounceEasing: 'circular',
                    eventPassthrough: true,
                    preventDefault: false,
                    bounceTime: 500
                }
            );
        }

        $(function () {

            //导航横向滚动


            function setNavWidth() {

                /* 计算导航宽度 */
                var allWidth = $(window).width();
                var scroller = $('#scroller');

                if (allWidth > 900) {
                    scroller.find('ul').add(scroller.find('.scroll')).removeAttr('style');
                    scroller.css('overflow', 'visible');
                    if (myNavScroll) myNavScroll.destroy();
                } else {

                    var width = 0;
                    scroller.find('.scroll').children('ul').children('li').each(function (index, el) {
                        if (!$(this).hasClass('mobile-hide')) {
                            width += $(this).outerWidth();
                        }
                    });
                    scroller.find('ul').add(scroller.find('.scroll')).width(width);

                    if (myNavScroll) myNavScroll.destroy();

                    myNavScroll = new IScroll('#scroller', {
                        scrollX: true,
                        scrollY: false,
                        momentum: false,
                        click: true
                    });

                }

            }

            setNavWidth();
            $(window).resize(function (event) {
                setNavWidth();
            });

        });

    </script>
</head>
<body onload="iscrollLoaded();">
<div style='margin:0 auto;width:0px;height:0px;overflow:hidden;'>
    <img src=""/>
</div>

<div id="is-mobile"></div>
<div class="container">
        <div class="mobile-header">
        <div class="header clearfix">
            <div class="header-wrapper clearfix">
                <a href="/index/index" class="logo"><img class="slogan" src="/img/logo.png?v=1.5"/></a>
                                <form id="search" class="search-box" action="/search/index" method="GET">
                    <input class="keys" name="keywords" type="text" placeholder="搜索漏洞" required="required">
                    <input class="icon" type="submit" value="">
                    <input type="hidden" name="type" value=""/>
                </form>
                <div class="bug">
                    <div class="name"><span class="seled">全部</span><i class="arrow"></i></div>
                    <ul class="typelist">
                        <li data-index="3"><a href="javascript:void(0);">全部</a></li>
                        <li data-index="0"><a href="javascript:void(0);">漏洞</a></li>
                        <li data-index="1"><a href="javascript:void(0);">资讯</a></li>
                        <li data-index="2"><a href="javascript:void(0);">知识</a></li>
                    </ul>
                </div>
                                <div class="logNreg mobile-hide">
                    <div class="unlog">
                        <i></i>
                        <a href="log.html" class="log">登录</a>
                        <span>|</span>
                        <a href="reg.html" class="reg">注册</a>
                    </div>
                    <div class="loged">
                        <a href="/member/profile" class="user-center"><i></i><span class="user-name-tag">个人中心</span></a>
                        <div class="user-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting"><a href="http://i.360.cn/profile/accountmanage"
                                                               target="_blank"><i></i><span>账号设置</span></a></li>
                                <li class="alert-setting"><a href="/keywords/index"
                                                             target="_blank"><i></i><span>告警设置</span></a></li>
                                <li class="bug-alert"><a href="/myalarm/index" target="_blank"><i></i><span>漏洞告警</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mylearn/index" target="_blank"><i></i><span>我的知识</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mycourse/index" target="_blank"><i></i><span>我的课堂</span></a>
                                </li>
                                <li class="my-exit"><a
                                            href="http://login.360.cn/?src=pcw_adlab&op=logout&destUrl=http://bobao.360.cn"><i></i><span>退出系统</span></a>
                                </li>
                            </ul>
                        </div>

                        <a href="/message" class="message-center" target="_blank"><i></i><span>我的消息</span></a>
                        <div class="message-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting" style="display:none;"><a href="/myres/index"
                                                                                     target="_blank"><i></i><span>回复我的</span></a>
                                </li>
                                <li class="my-bug"><a href="/myvul/index"
                                                      target="_blank"><i></i><span>我的漏洞</span></a></li>
                                <!--<li class="my-bug"><a href="/myres/index" target="_blank"><i></i><span>我的评论</span></a></li>-->
                                <!--<li class="alert-setting"><a href="###" target="_blank"><i></i><span>提到我的</span></a>
                                </li>-->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <style type="text/css">
            .nav {
                overflow: hidden;
            }

            .nav .scroll {
                width: auto;
            }
        </style>
        <div id="wrapper">
            <div id="scroller" class="nav">
                <div class="scroll">
                    <ul class="nav-list">
                        <li ><a class="link-nav"
                                                                                 href="/index/index">首页</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/vul/index">漏洞</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/introduce/list">招聘</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/news/index">资讯</a><!--<i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/introduce/list">招聘</a></li>
                        </ul>
			-->
                        </li>
                        <li class="cur">
                        <a class="link-nav" href="/learning/index">知识</a><i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/course/index">学院</a></li>
                        </ul>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/activity/index">活动</a></li>
                        <li class="mobile-hide "><a class="link-nav"
                                                                                                   href="/ctf/index">CTF训练营</a>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/interref/list">安全内参</a></li>
                        <li ><a class="link-nav" href="/app/index">APP</a></li>

                        <!--<li ><a href="/course/index">学院</a></li>-->
                        <!--<li ><a href="/introduce/list">招聘</a></li>-->
                        <!--<li  class="mobile-hide"><a href="/ctf/index">CTF训练营</a></li>-->
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="mobile-content">
        <link rel="stylesheet" type="text/css" href="/css/news.css?v=3.5" />
<link rel="stylesheet" type="text/css" href="/ue/SyntaxHighlighter/shCoreDefault.css?v=1.0" />
<style>
    p .syntaxhighlighter {
        width: 80%;
    }
</style>

<div class="cur-pos w1000">当前位置：<a href="http://bobao.360.cn/">安全客</a> &gt;&gt; 知识详情</div>

<div class="content clearfix">
    <div class="main">
        <div class="article">
            <div id="article_box">
                <h2>【漏洞分析】NSA Eternalromance （永恒浪漫） 漏洞分析</h2>
                <div class="article-msg">
                    <span class="time">2017-04-19 16:06:21</span>
                    
                                        <span class="read">阅读：27220次</span>
                    <span><a style="display: none;" class="good" href="javascript:;"
                             data-target="/learning/good" data-value="g_3747"
                             data-type="learning">点赞(0)</a></span>
                    <span><a class="fav" href="javascript:;" data-target="/mylearning/add"
                             data-pk="3747" data-type="learning">收藏</a></span>
                                        <span><a style="margin-left: 4px;" class="fav" href="http://blogs.360.cn/360safe/2017/04/19/eternalromance-analyze/"
                             target="_blank">来源： 360安全卫士技术博客</a></span>
                    
                    
                    <div style="margin-top:10px; ">
                        <a href="/member/contribute?uid=2515404167" style="color:#848e99;">
                            <img src="http://p1.qhmsg.com/dm/150_150_100/t01cc856584b7ed76c0.jpg" data-is-avatar="true"
                                 style="border: 1px solid #d5d5d5;padding: 2px; width: 80px;height: 80px;border-radius: 43px;"/>
                        </a>

                    </div>
                    <span class="orig">作者：<a href="/member/contribute?uid=2515404167" style="color:#848e99;">360安全卫士</a></span>
                                    </div>
                <hr size="1">
                <div class="article-msg">
                    <p><!-- JiaThis Button BEGIN -->

<!--
<span class="jiathis_style"><span class="jiathis_txt">分享到：</span>
	<a class="jiathis_button_weixin"></a>
	<a class="jiathis_button_tsina"></a>
    <a class="jiathis_button_tqq"></a>
    <a class="jiathis_button_qzone"></a>
    <a class="jiathis_button_renren"></a>
    <a class="jiathis_button_xiaoyou"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
</span>

-->
</p>
                </div>
                <p><p style="text-align: center; text-indent: 0em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><strong><img src="http://p3.qhimg.com/t01973c96a737e38720.png" title="t01a88020151f7d250f.png" alt="http://p8.qhimg.com/t01a88020151f7d250f.png"/></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px;">传送门</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192);"><strong><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px;"></span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><a href="http://bobao.360.cn/learning/detail/3738.html" target="_self" style="text-decoration: underline; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px; color: rgb(0, 112, 192);"><span style="color: rgb(0, 112, 192);"><strong><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px;">【漏洞分析】MS 17-010：NSA Eternalblue SMB 漏洞分析</span></strong></span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px;"></span><br/></p><p style="text-indent: 2em; text-align: left;"><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px;"><strong>1 环境</strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(227, 108, 9); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><strong><span style="color: rgb(227, 108, 9); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">EXPLOIT：</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Eternalromance-1.3.0</span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(227, 108, 9); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><strong>TARGET：</strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">windows xp sp3</span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(227, 108, 9);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">FILE：</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">srv.sys 5.1.2600.5512</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><strong><br/></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px;"><strong>2 Exploit使用</strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">我们可以发现工具包中有两个Eternalromance, 一个1.4.0, 另外一个是1.3.0。经过我一翻折腾也没有把1.4.0跑起来。无奈试了下1.3.0发现竟然能成功运行。因此便有了这篇分析。大家可能都会用fuzzbunch这个命令行了。但是我们调试的时候总不能调一次都要重新输入TargetIp等那些配置吧。告诉大家一个省劲的方法。首先fuzzbunch按正常流程走一遍。在最后跑起exp的时候，在Log目录下会生成一个xml的配置文件。然后大家就可以用Eternalromance.1.3.0 –inconfig “xml路径” 来调用了。还有就是你也可以改exploit下的那个配置文件不过你得填非常多的参数。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><strong><br/></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px;"><strong>3 基础知识</strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">不想看的同学可以直接跳到 3.5 漏洞相关的重点那里</span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px;"><strong>3.1 SMB Message structure</strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">SMB Messages are divisible into three parts:</span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(227, 108, 9); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><strong>* fixed-length header</strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(227, 108, 9); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><strong>* variable length parameter block</strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(227, 108, 9); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><strong>* variable length data block</strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">header的结构如下：</span></p><pre class="brush:plain;toolbar:false">&nbsp;SMB_Header
&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;UCHAR&nbsp;&nbsp;Protocol[4];
&nbsp;&nbsp;&nbsp;UCHAR&nbsp;&nbsp;Command;
&nbsp;&nbsp;&nbsp;SMB_ERROR&nbsp;Status;
&nbsp;&nbsp;&nbsp;UCHAR&nbsp;&nbsp;Flags;
&nbsp;&nbsp;&nbsp;USHORT&nbsp;Flags2;
&nbsp;&nbsp;&nbsp;USHORT&nbsp;PIDHigh;
&nbsp;&nbsp;&nbsp;UCHAR&nbsp;&nbsp;SecurityFeatures[8];
&nbsp;&nbsp;&nbsp;USHORT&nbsp;Reserved;
&nbsp;&nbsp;&nbsp;USHORT&nbsp;TID;
&nbsp;&nbsp;&nbsp;USHORT&nbsp;PIDLow;
&nbsp;&nbsp;&nbsp;USHORT&nbsp;UID;
&nbsp;&nbsp;&nbsp;USHORT&nbsp;MID;
&nbsp;&nbsp;&nbsp;}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">更详细见 (</span><a href="https://msdn.microsoft.com/en-us/library/ee441702.aspx" _src="https://msdn.microsoft.com/en-us/library/ee441702.aspx" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">https://msdn.microsoft.com/en-us/library/ee441702.aspx</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;)</span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px;"><strong>3.2 SMB_COM_TRANSACTION (0x25)</strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">为事务处理协议的传输子协议服务。这些命令可以用于CIFS文件系统内部通信的邮箱和命名管道。如果出书的数据超过了会话建立时规定的MaxBufferSize，必须使用SMB_COM_TRANSACTION_SECONDARY命令来传输超出的部分：SMB_Data.Trans_Data和SMB_Data.Trans_Parameter。这两部分在初始化消息中没有固定。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">如果客户端没有发送完所有的SMB_Data.Trans_Data，会将DataCount设置为小于TotalDataCount的一个值。同样的，如果SMB_Data.Trans_Parameters没有发送完，会设置ParameterCount为一个小于TotalParameterCount的值。参数部分优先级高于数据部分，客户端在每个消息中应该尽量多的发送数据。服务器应该可以接收无序到达的SMB_Data.Trans_Parameters 和 SMB_Data.Trans_Data，不论是大量还是少量的数据。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">在请求和响应消息中，SMB_Data.Trans_Parameters和SMB_Data.Trans_Data的位置和长度都是由SMB_Parameters.ParameterOffset、SMB_Parameters.ParameterCount,SMB_Parameters.DataOffset和SMB_Parameters.DataCount决定。另外需要说明的是，SMB_Parameters.ParameterDisplacement和SMB_Parameters.DataDisplacement可以用来改变发送数据段的序号。服务器应该优先发送SMB_Data.Trans_Parameters。客户端应该准备好组装收到的SMB_Data.Trans_Parameters和SMB_Data.Trans_Data，即使它们是乱序到达的。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">The PID, MID, TID, and UID MUST be the same for all requests and responses that are part of the same transaction.</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">更详细看 (</span><a href="https://msdn.microsoft.com/en-us/library/ee441489.aspx" _src="https://msdn.microsoft.com/en-us/library/ee441489.aspx" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">https://msdn.microsoft.com/en-us/library/ee441489.aspx</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;)</span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px;"><strong>3.3 SMB_COM_TRANSACTION_SECONDARY(0x26)</strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">此命令用来完成SMB_COM_TRANSACTION中未传输完毕数据的传输。在请求和响应消息中，SMB_Data.Trans_Parameters和SMB_Data.Trans_Data的位置和长度都是由SMB_Parameters.ParameterOffset、SMB_Parameters.ParameterCount,SMB_Parameters.DataOffset和SMB_Parameters.DataCount决定。另外需要说明的是，SMB_Parameters.ParameterDisplacement和SMB_Parameters.DataDisplacement可以用来改变发送数据段的序号。服务器应该优先发送SMB_Data.Trans_Parameters。客户端应该准备好组装收到的SMB_Data.Trans_Parameters和SMB_Data.Trans_Data，即使它们是乱序到达的。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">更详细看 (</span><a href="https://msdn.microsoft.com/en-us/library/ee441949.aspx" _src="https://msdn.microsoft.com/en-us/library/ee441949.aspx" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">https://msdn.microsoft.com/en-us/library/ee441949.aspx</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;)</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 112, 192); font-size: 18px;"><strong>3.4 SMB_COM_WRITE_ANDX (0x2F)</strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">结构如图：</span></p><p style="text-align:center"><img src="http://p6.qhimg.com/t011fda792f0f66b20a.png" title="t01b7ec5d0715d07eb0.png" alt="http://p4.qhimg.com/t01b7ec5d0715d07eb0.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">更详细看 (</span><a href="https://msdn.microsoft.com/en-us/library/ee441848.aspx" _src="https://msdn.microsoft.com/en-us/library/ee441848.aspx" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">https://msdn.microsoft.com/en-us/library/ee441848.aspx</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;)</span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px;"><strong>3.5 总结下漏洞相关的重点</strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">客户端处理SMB_COM_TRANSACTION命令的时候如果数据大小超过MaxBufferSize，则需要使用SMB_COM_TRANSACTION_SECONDARY传输剩下的数据。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">对于作为同一Transcation部分的所有请求和响应，PID，MID，TID和UID必须相同。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><strong><br/></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px;"><strong>4 漏洞分析</strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 112, 192); text-indent: 2em;">4.1 SrvSmbTransactionSecondary</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">结合上一节的重点中提到的。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">如果我们先发送了一个数据大小大于MaxBufferSize的SMB_COM_TRANSACTION数据包。那么接下来肯定是要发送SMB_COM_TRANSACTION_SECONDARY来传输剩余的数据，那么服务器在收到处理SMB_COM_TRANSACTION_SECONDARY这个命令的时候肯定会找他对应的那个Transcation。同时服务器也可能同时收到很多个包含SMB_COM_TRANSACTION_SECONDARY命令的数据包。怎么定位某个MB_COM_TRANSACTION_SECONDARY数据包对应的SMB_COM_TRANSACTION数据包呢？重点里也提到了。如果MB_COM_TRANSACTION_SECONDARY数据包中的PID,MID,TID和UID和SMB_COM_TRANSACTION数据包中的相同，那么就认为是同一部分的请求。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">代码是这么实现的。</span></p><pre class="brush:plain;toolbar:false">int&nbsp;__thiscall&nbsp;SrvSmbTransactionSecondary(int&nbsp;this)
{
&nbsp;&nbsp;int&nbsp;v1;&nbsp;//&nbsp;ebx@1
&nbsp;&nbsp;int&nbsp;pSmbParamter;&nbsp;//&nbsp;edi@1
&nbsp;&nbsp;TRANSCATION&nbsp;*pTransation;&nbsp;//&nbsp;eax@1&nbsp;MAPDST
&nbsp;&nbsp;unsigned&nbsp;int&nbsp;ParameterDisplayment;&nbsp;//&nbsp;ecx@10&nbsp;MAPDST
&nbsp;&nbsp;size_t&nbsp;ParameterSize;&nbsp;//&nbsp;eax@10&nbsp;MAPDST
&nbsp;&nbsp;size_t&nbsp;DataSize;&nbsp;//&nbsp;edx@10&nbsp;MAPDST
&nbsp;&nbsp;int&nbsp;pTransList;&nbsp;//&nbsp;[sp+Ch]&nbsp;[bp-24h]@1
&nbsp;&nbsp;PERESOURCE&nbsp;Resource;&nbsp;//&nbsp;[sp+18h]&nbsp;[bp-18h]@26
&nbsp;&nbsp;struct&nbsp;_ERESOURCE&nbsp;*Resourcea;&nbsp;//&nbsp;[sp+18h]&nbsp;[bp-18h]@30
&nbsp;&nbsp;int&nbsp;pSmbHeader;&nbsp;//&nbsp;[sp+1Ch]&nbsp;[bp-14h]@1
&nbsp;&nbsp;int&nbsp;ParameterOffset;&nbsp;//&nbsp;[sp+20h]&nbsp;[bp-10h]@10
&nbsp;&nbsp;int&nbsp;DataOffset;&nbsp;//&nbsp;[sp+28h]&nbsp;[bp-8h]@10
&nbsp;&nbsp;v1&nbsp;=&nbsp;this;
&nbsp;&nbsp;pSmbParamter&nbsp;=&nbsp;*(_DWORD&nbsp;*)(this&nbsp;+&nbsp;0x6C);
&nbsp;&nbsp;pSmbHeader&nbsp;=&nbsp;*(_DWORD&nbsp;*)(this&nbsp;+&nbsp;0x68);
&nbsp;&nbsp;pTransList&nbsp;=&nbsp;*(_DWORD&nbsp;*)(this&nbsp;+&nbsp;0x4C);
&nbsp;&nbsp;//
&nbsp;&nbsp;//&nbsp;首先查找SMB_COM_TRANSACTION_SECONDARY对应的SMB_COM_TRANSACTION
&nbsp;&nbsp;//
&nbsp;&nbsp;pTransation&nbsp;=&nbsp;(TRANSCATION&nbsp;*)SrvFindTransaction(pTransList,&nbsp;pSmbHeader,&nbsp;0);
&nbsp;&nbsp;if&nbsp;(&nbsp;!pTransation&nbsp;)
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;2;
&nbsp;&nbsp;}
&nbsp;&nbsp;if&nbsp;(&nbsp;!*(_BYTE&nbsp;*)(pTransation-&gt;field_10&nbsp;+&nbsp;0x98)&nbsp;)
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;ParameterDisplayment&nbsp;=&nbsp;*(_WORD&nbsp;*)(pSmbParamter&nbsp;+&nbsp;9);
&nbsp;&nbsp;&nbsp;&nbsp;ParameterOffset&nbsp;=&nbsp;*(_WORD&nbsp;*)(pSmbParamter&nbsp;+&nbsp;7);
&nbsp;&nbsp;&nbsp;&nbsp;ParameterSize&nbsp;=&nbsp;*(_WORD&nbsp;*)(pSmbParamter&nbsp;+&nbsp;5);
&nbsp;&nbsp;&nbsp;&nbsp;DataOffset&nbsp;=&nbsp;*(_WORD&nbsp;*)(pSmbParamter&nbsp;+&nbsp;0xD);
&nbsp;&nbsp;&nbsp;&nbsp;DataSize&nbsp;=&nbsp;*(_WORD&nbsp;*)(pSmbParamter&nbsp;+&nbsp;0xB);
&nbsp;&nbsp;&nbsp;&nbsp;DataDisplayment&nbsp;=&nbsp;*(_WORD&nbsp;*)(pSmbParamter&nbsp;+&nbsp;0xF);
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;pTransation-&gt;field_93&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//...
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;else
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//Check
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Resource&nbsp;=&nbsp;*(PERESOURCE&nbsp;*)(*(_DWORD&nbsp;*)(v1&nbsp;+&nbsp;0x60)&nbsp;+&nbsp;0x10);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;ParameterSize&nbsp;+&nbsp;ParameterOffset&nbsp;&gt;&nbsp;*(_DWORD&nbsp;*)(*(_DWORD&nbsp;*)(v1&nbsp;+&nbsp;0x60)&nbsp;+&nbsp;0x10)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;||&nbsp;DataOffset&nbsp;+&nbsp;DataSize&nbsp;&gt;&nbsp;(unsigned&nbsp;int)Resource
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;||&nbsp;ParameterSize&nbsp;+&nbsp;ParameterDisplayment&nbsp;&gt;&nbsp;pTransation-&gt;TotalParameterCount
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;||&nbsp;DataSize&nbsp;+&nbsp;DataDisplayment&nbsp;&gt;&nbsp;pTransation-&gt;TotalDataCount&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//CheckFaild
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;pTransation-&gt;field_94&nbsp;!=&nbsp;1&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;这里将SMB_COM_TRANSACTION_SECONDARY传过来的Parameter和Data都保存
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;到Transaction中
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//拷贝Parameter&nbsp;Buffer
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;ParameterSize&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_memmove(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(void&nbsp;*)(ParameterDisplayment&nbsp;+&nbsp;pTransation-&gt;ParameterBuffer),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(const&nbsp;void&nbsp;*)(pSmbHeader&nbsp;+&nbsp;ParameterOffset),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ParameterSize);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;parameter
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//复制Data&nbsp;Buffer,这里注意下，下面会提到！！
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;DataSize&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_memmove(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(void&nbsp;*)(DataDisplayment&nbsp;+&nbsp;pTransation-&gt;DataBuffer),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(const&nbsp;void&nbsp;*)(pSmbHeader&nbsp;+&nbsp;DataOffset),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DataSize);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;data
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;2;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;}
&nbsp;&nbsp;return&nbsp;1;
}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">这个SMB_COM_TRANSACTION_SECONDARY命令的处理函数的大体流程就是首先查找SMB_COM_TRANSACTION_SECONDARY对应的SMB_COM_TRANSACTION如果找到就将SMB_COM_TRANSACTION_SECONDARY中的Parameter和Data都复制到SMB_COM_TRANSACTION中去。</span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px;"><strong>4.2 SrvFindTransaction</strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">下面来看下查找的逻辑SrvFindTransaction:</span></p><pre class="brush:plain;toolbar:false">int&nbsp;__stdcall&nbsp;SrvFindTransaction(int&nbsp;a1,&nbsp;int&nbsp;pSmbHeaderOrMid,&nbsp;int&nbsp;a3)
{
&nbsp;&nbsp;SMB_HEADER&nbsp;*pSmbHeader_;&nbsp;//&nbsp;edi@1
&nbsp;&nbsp;struct&nbsp;_ERESOURCE&nbsp;*v4;&nbsp;//&nbsp;ebx@4
&nbsp;&nbsp;_DWORD&nbsp;**pTransList;&nbsp;//&nbsp;edx@4
&nbsp;&nbsp;_DWORD&nbsp;*i;&nbsp;//&nbsp;ecx@4
&nbsp;&nbsp;TRANSCATION&nbsp;*v7;&nbsp;//&nbsp;eax@5
&nbsp;&nbsp;int&nbsp;v9;&nbsp;//&nbsp;esi@14
&nbsp;&nbsp;pSmbHeader_&nbsp;=&nbsp;(SMB_HEADER&nbsp;*)pSmbHeaderOrMid;
&nbsp;&nbsp;//
&nbsp;&nbsp;//&nbsp;command&nbsp;0x2f&nbsp;is&nbsp;SUM_CMD_WRITE_ANDX
&nbsp;&nbsp;//&nbsp;a3&nbsp;=&nbsp;SUM_CMD_WRITE_ANDX-&gt;Fid
&nbsp;&nbsp;//
&nbsp;&nbsp;if&nbsp;(&nbsp;*(_BYTE&nbsp;*)(pSmbHeaderOrMid&nbsp;+&nbsp;4)&nbsp;==&nbsp;0x2F&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;pSmbHeaderOrMid&nbsp;=&nbsp;a3;
&nbsp;&nbsp;else
&nbsp;&nbsp;&nbsp;&nbsp;LOWORD(pSmbHeaderOrMid)&nbsp;=&nbsp;*(_WORD&nbsp;*)(pSmbHeaderOrMid&nbsp;+&nbsp;0x1E);
&nbsp;&nbsp;v4&nbsp;=&nbsp;(struct&nbsp;_ERESOURCE&nbsp;*)(a1&nbsp;+&nbsp;0x130);
&nbsp;&nbsp;ExAcquireResourceExclusiveLite((PERESOURCE)(a1&nbsp;+&nbsp;0x130),&nbsp;1u);
&nbsp;&nbsp;pTransList&nbsp;=&nbsp;(_DWORD&nbsp;**)(*(_DWORD&nbsp;*)(a1&nbsp;+&nbsp;0xF4)&nbsp;+&nbsp;8);
&nbsp;&nbsp;for&nbsp;(&nbsp;i&nbsp;=&nbsp;*pTransList;&nbsp;;&nbsp;i&nbsp;=&nbsp;(_DWORD&nbsp;*)*i&nbsp;)
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;i&nbsp;==&nbsp;pTransList&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;查到最后了退出
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ExReleaseResourceLite(v4);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;//
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;这里是对比TID，PID，UID,MID
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;这里注意这个MID,如果命令是SUM_CMD_WRITE_ANDX&nbsp;MID就是SUM_CMD_WRITE_ANDX&nbsp;MID数据包中的Fid
&nbsp;&nbsp;&nbsp;&nbsp;//
&nbsp;&nbsp;&nbsp;&nbsp;v7&nbsp;=&nbsp;(TRANSCATION&nbsp;*)(i&nbsp;-&nbsp;6);
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;*((_WORD&nbsp;*)i&nbsp;+&nbsp;47)&nbsp;==&nbsp;pSmbHeader_-&gt;TID
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;v7-&gt;ProcessId&nbsp;==&nbsp;pSmbHeader_-&gt;PIDLow
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;v7-&gt;UserId&nbsp;==&nbsp;pSmbHeader_-&gt;UID
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;v7-&gt;MutiplexId&nbsp;==&nbsp;(_WORD)pSmbHeaderOrMid&nbsp;)//&nbsp;MutilplexId如果名令时SMB_CMD_WRITE_ANDX那么这里是Fid
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;}
&nbsp;&nbsp;if&nbsp;(&nbsp;BYTE1(v7-&gt;field_0)&nbsp;==&nbsp;2&nbsp;)
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;_InterlockedExchangeAdd((volatile&nbsp;signed&nbsp;__int32&nbsp;*)(v7-&gt;field_8&nbsp;+&nbsp;4),&nbsp;1u);
&nbsp;&nbsp;&nbsp;&nbsp;v9&nbsp;=&nbsp;(int)(i&nbsp;-&nbsp;6);
&nbsp;&nbsp;}
&nbsp;&nbsp;else
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;v9&nbsp;=&nbsp;0;
&nbsp;&nbsp;}
&nbsp;&nbsp;ExReleaseResourceLite(v4);
&nbsp;&nbsp;return&nbsp;v9;
}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">大家可以看下逻辑。重点在这里如果命令是SMB_CMD_WRITE_ANDX(0x2f)话那么MID的对比就不一样了，这里是用Transaction-&gt;MID和SMB_CMD_WRITE_ANDX-&gt;Fid比较。如果一样返回pTransaction。那么问题来了。如果服务器端正好有一个其他的Transaction-&gt;MID恰好和SMB_CMD_WRITE_ANDX-&gt;Fid的相等那么将会返回一个错误的pTransaction。很经典的类型混淆。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">处理SUM_CMD_WRITE_ANDX的函数SrvSmbWriteAndX代码如下:</span></p><pre class="brush:plain;toolbar:false">signed&nbsp;int&nbsp;__thiscall&nbsp;SrvSmbWriteAndX(int&nbsp;this)
{
&nbsp;&nbsp;&nbsp;&nbsp;...略
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pTrans&nbsp;=&nbsp;(TRANSCATION&nbsp;*)SrvFindTransaction(pTransList,&nbsp;pSmbTranscationBuffer,&nbsp;Fid);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pTrans_&nbsp;=&nbsp;pTrans;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;!pTrans&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;(unsigned&nbsp;int)SrvWmiEnableLevel&nbsp;&gt;=&nbsp;2&nbsp;&amp;&amp;&nbsp;SrvWmiEnableFlags&nbsp;&amp;&nbsp;1&nbsp;&amp;&amp;&nbsp;KeGetCurrentIrql()&nbsp;&lt;&nbsp;2u&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WPP_SF_(64,&nbsp;&amp;unk_1E1CC);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v40&nbsp;=&nbsp;&quot;d:\\xpsp\\base\\fs\\srv\\smbrdwrt.c&quot;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v37&nbsp;=&nbsp;3216;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto&nbsp;LABEL_69;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;pTrans-&gt;TotalDataCount&nbsp;-&nbsp;pTrans-&gt;nTransDataCounts&nbsp;&lt;&nbsp;v11&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SrvCloseTransaction(pTrans);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SrvDereferenceTransaction(pTrans_);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_SrvSetSmbError2(v1,&nbsp;0x80000005,&nbsp;0,&nbsp;3238,&nbsp;(int)&quot;d:\\xpsp\\base\\fs\\srv\\smbrdwrt.c&quot;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;StatusCode&nbsp;=&nbsp;0x80000005;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto&nbsp;LABEL_100;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v31&nbsp;=&nbsp;Size;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;qmemcpy((void&nbsp;*)pTrans-&gt;DataBuffer,&nbsp;VirtualAddress,&nbsp;Size);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;！！！！这里将DataBuffer指针给增加了！！！！
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pTrans_-&gt;DataBuffer&nbsp;+=&nbsp;Size;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pTrans_-&gt;nTransDataCounts&nbsp;+=&nbsp;v31;
&nbsp;&nbsp;&nbsp;&nbsp;...略
}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">看到pTrans_-&amp;gt;DataBuffer += Size这句相信大家就能明白了。这里将DataBuffer的指针增大了。再处理此Transcation的SMB_COM_TRANSACTION_SECONDARY命令的时候也就是SrvSmbTransactionSecondary中复制Data的memcpy可就越界了！！！！！</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">所以此漏洞可以总结成类型混淆造成的越界写。</span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px;"><strong>4.3 Exploit数据包</strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">通过对Exploit抓包我们可以看到其漏洞触发过程。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">首先发送SMB_COM_TRANSACTION命令创建一个TID=2049 PID=0 UID=2049 MID=16385(0x4001)的Transcation：</span></p><p style="text-align:center"><img src="http://p5.qhimg.com/t01f0e95b5749b0608e.png" title="t016be9f61d1c4d7600.png" alt="http://p0.qhimg.com/t016be9f61d1c4d7600.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">然后发送SMB_CMD_WRITE_ANDX命令还增加pTrans_-&amp;gt;DataBuffer这个指针：</span></p><p style="text-align:center"><img src="http://p3.qhimg.com/t01aa2cb84850da9d56.png" title="t0158f63bf96f1cff54.png" alt="http://p6.qhimg.com/t0158f63bf96f1cff54.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><strong><br/></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px;"><strong>5 漏洞利用</strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">从上面描述可以看出，该漏洞为类型混淆导致的越界写漏洞。前期通过spray 使多个TRANSACTION相邻，然后让其中一个TRANSACTION触发该漏洞，再通过该TRANSACTION越界写其相邻的TRANSACTION</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">spary 最终 memory view:</span></p><p style="text-align:center"><img src="http://p2.qhimg.com/t012e6576a28a96ff64.png" title="t013ad87e18590fcaef.png" alt="http://p9.qhimg.com/t013ad87e18590fcaef.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">spray的目的是构造出下出三个相邻的transaction, 其中write_transaction 主要用于写操作，leak_transaction 主要用于信息泄露，而control_transaction为触发漏洞的transaction,触发之后其他InData字段会增加0x200, 以致于可写的范围可以向后延伸0x200.利用于这点可以写与其相依的write_transaction的InData字段。从面达到任意地址写的效果。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">注: 本次调试中 control_transaction地址为：0x58b90, write_transaction地址为: 0x59c38, leak_transaction地址为:0x5ace0</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">其中TRANSACTION 结构部份如下：</span></p><pre class="brush:plain;toolbar:false">typedef&nbsp;struct&nbsp;_TRANSACTION&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;//...
&nbsp;&nbsp;&nbsp;&nbsp;/*+0xc*/&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LPVOID&nbsp;Connection;
&nbsp;&nbsp;&nbsp;&nbsp;//...
&nbsp;&nbsp;&nbsp;&nbsp;/*+0x34*/&nbsp;&nbsp;&nbsp;&nbsp;LPWORD&nbsp;InSetup;
&nbsp;&nbsp;&nbsp;&nbsp;//...
&nbsp;&nbsp;&nbsp;&nbsp;/*+0x40*/&nbsp;&nbsp;&nbsp;&nbsp;LPBYTE&nbsp;OutParameters;
&nbsp;&nbsp;&nbsp;&nbsp;/*+0x44*/&nbsp;&nbsp;&nbsp;&nbsp;LPBYTE&nbsp;InData;&nbsp;/*写的目的地址*/
&nbsp;&nbsp;&nbsp;&nbsp;/*+0x48*/&nbsp;&nbsp;&nbsp;LPBYTE&nbsp;OutData;&nbsp;/*读的目的地址*/
&nbsp;&nbsp;&nbsp;&nbsp;//...
&nbsp;&nbsp;&nbsp;&nbsp;/*+0x60*/&nbsp;&nbsp;&nbsp;DWORD&nbsp;DataCount;&nbsp;/*控制可读的长度*/
&nbsp;&nbsp;&nbsp;&nbsp;/*+0x64*/&nbsp;&nbsp;&nbsp;DWORD&nbsp;TotalDataCount
&nbsp;&nbsp;&nbsp;&nbsp;}TRANSACTION</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">写操作：</span></p><pre class="brush:plain;toolbar:false">SMB_PROCESSOR_RETURN_TYPE&nbsp;SrvSmbTransactionSecondary&nbsp;(
&nbsp;&nbsp;&nbsp;&nbsp;SMB_PROCESSOR_PARAMETERS
&nbsp;&nbsp;&nbsp;&nbsp;)
{
&nbsp;&nbsp;&nbsp;&nbsp;//...
&nbsp;&nbsp;&nbsp;&nbsp;request&nbsp;=&nbsp;(PREQ_TRANSACTION_SECONDARY)WorkContext-&gt;RequestParameters;
&nbsp;&nbsp;&nbsp;&nbsp;header&nbsp;=&nbsp;WorkContext-&gt;RequestHeader;
&nbsp;&nbsp;&nbsp;&nbsp;transaction&nbsp;=&nbsp;SrvFindTransaction(&nbsp;connection,&nbsp;header,&nbsp;0&nbsp;);
&nbsp;&nbsp;&nbsp;&nbsp;//...
&nbsp;&nbsp;&nbsp;&nbsp;dataOffset&nbsp;=&nbsp;SmbGetUshort(&nbsp;&amp;request-&gt;DataOffset&nbsp;);
&nbsp;&nbsp;&nbsp;&nbsp;dataCount&nbsp;=&nbsp;SmbGetUshort(&nbsp;&amp;request-&gt;DataCount&nbsp;);
&nbsp;&nbsp;&nbsp;&nbsp;dataDisplacement&nbsp;=&nbsp;SmbGetUshort(&nbsp;&amp;request-&gt;DataDisplacement&nbsp;);
&nbsp;&nbsp;&nbsp;&nbsp;//...
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Copy&nbsp;the&nbsp;parameter&nbsp;and&nbsp;data&nbsp;bytes&nbsp;that&nbsp;arrived&nbsp;in&nbsp;this&nbsp;SMB.
&nbsp;&nbsp;&nbsp;&nbsp;//...
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;dataCount&nbsp;!=&nbsp;0&nbsp;)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RtlMoveMemory(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;transaction-&gt;InData&nbsp;+&nbsp;dataDisplacement,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(PCHAR)header&nbsp;+&nbsp;dataOffset,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dataCount);
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;//...
}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">读操作：</span></p><pre class="brush:plain;toolbar:false">VOID&nbsp;SrvCompleteExecuteTransaction&nbsp;(
&nbsp;&nbsp;&nbsp;&nbsp;IN&nbsp;OUT&nbsp;PWORK_CONTEXT&nbsp;WorkContext,
&nbsp;&nbsp;&nbsp;&nbsp;IN&nbsp;SMB_TRANS_STATUS&nbsp;ResultStatus)
{
&nbsp;&nbsp;&nbsp;&nbsp;//...
&nbsp;&nbsp;&nbsp;&nbsp;transaction&nbsp;=&nbsp;WorkContext-&gt;Parameters.Transaction;
&nbsp;&nbsp;&nbsp;&nbsp;header&nbsp;=&nbsp;WorkContext-&gt;ResponseHeader;
&nbsp;&nbsp;&nbsp;&nbsp;transactionCommand&nbsp;=&nbsp;(UCHAR)SmbGetUshort(&nbsp;&amp;transaction-&gt;InSetup[0]&nbsp;);
&nbsp;&nbsp;&nbsp;&nbsp;//...
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Copy&nbsp;the&nbsp;appropriate&nbsp;parameter&nbsp;and&nbsp;data&nbsp;bytes&nbsp;into&nbsp;the&nbsp;message.
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;paramLength&nbsp;!=&nbsp;0&nbsp;)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RtlMoveMemory(&nbsp;paramPtr,&nbsp;transaction-&gt;OutParameters,&nbsp;paramLength&nbsp;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;dataLength&nbsp;!=&nbsp;0&nbsp;)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RtlMoveMemory(&nbsp;dataPtr,&nbsp;transaction-&gt;OutData,&nbsp;dataLength&nbsp;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;//...
}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">从exp运行的log可以看出该漏洞利用分为两部份：信息泄露 与 代码执行</span></p><p style="text-align:center"><img src="http://p6.qhimg.com/t013548a68038b8c8ca.png" title="t01dd554b64731f4940.png" alt="http://p3.qhimg.com/t01dd554b64731f4940.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px;"><strong>5.1 信息泄露</strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">需要泄露的信息包括 Transaction2Dispatch Table基址 与 一块NonePagedPool Buffer地址. 通过修改Transaction2Dispatch Table中的函数指针来执行 shellcode， 其中NonePagedPool Buffer就是用于存放shellcode.</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><strong>5.1.1 泄露Transaction2Dispatch Table基址</strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">从exp运行的log可以看出首先泄露CONNECTION结构基址：CONNECTION地址存放于TRANSACTION-&amp;gt;Connection字段。看到这，你可能已经想到该怎么做了：直接利用constrol transaction的0x200字节的越界能力修改write_transaction的DataCount字段让其可以越界读leak_transaction上的内容，从而读出TRANSACTION-&amp;gt;Connection。 但exp作者却并没有这么做，这里并不打算深究其原因，或许是有其他限制，或许不是。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">作者这里利用了另一种复杂不少方法，通过另一种方法修改 write_transaction的DataCount字段。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><strong>5.1.1.1 write_transaction初始状态如下:</strong></span></p><p style="text-align:center"><img src="http://p3.qhimg.com/t01640474a166d43c96.png" title="t01ef5c033224c6cce8.png" alt="http://p5.qhimg.com/t01ef5c033224c6cce8.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">可以看出CONNECTION地址为：89a29c18，OutData为0x5acd4 (== 59c38+0x109c)已经是write_transaction的末尾，所以其DataCount为0,表示不可读。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><strong>5.1.1.2 修改write_transaction-&gt;DataCount</strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">首先 修改write_transaction的InSetup为0x23，这点通过control_transaction很容易完成。之后发包触发写write_transaction操作，会走到：</span></p><pre class="brush:plain;toolbar:false">SMB_STATUS&nbsp;SRVFASTCALL&nbsp;ExecuteTransaction&nbsp;(
&nbsp;&nbsp;&nbsp;&nbsp;IN&nbsp;OUT&nbsp;PWORK_CONTEXT&nbsp;WorkContext)
{
&nbsp;&nbsp;&nbsp;&nbsp;//...
&nbsp;&nbsp;&nbsp;&nbsp;transaction&nbsp;=&nbsp;WorkContext-&gt;Parameters.Transaction;
&nbsp;&nbsp;&nbsp;&nbsp;//...
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;command&nbsp;=&nbsp;SmbGetUshort(&amp;transaction-&gt;InSetup[0]);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//...
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;switch(&nbsp;command&nbsp;)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;TRANS_TRANSACT_NMPIPE:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resultStatus&nbsp;=&nbsp;SrvTransactNamedPipe(&nbsp;WorkContext&nbsp;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;TRANS_PEEK_NMPIPE:&nbsp;//0x23
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resultStatus&nbsp;=&nbsp;SrvPeekNamedPipe(&nbsp;WorkContext&nbsp;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;TRANS_CALL_NMPIPE:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resultStatus&nbsp;=&nbsp;SrvCallNamedPipe(&nbsp;WorkContext&nbsp;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//...
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//...
}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">由于之前已经将write_transaction的InSetup修改为0x23, 所以会call SrvPeekNamedPipe。</span></p><pre class="brush:plain;toolbar:false">#&nbsp;ChildEBP&nbsp;RetAddr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
00&nbsp;b21f8d44&nbsp;b24cdcce&nbsp;srv!ExecuteTransaction+0x23b&nbsp;(FPO:&nbsp;[0,0,0])
01&nbsp;b21f8d7c&nbsp;b248a836&nbsp;srv!SrvSmbTransactionSecondary+0x2f1&nbsp;(FPO:&nbsp;[Non-Fpo])
02&nbsp;b21f8d88&nbsp;b249ad98&nbsp;srv!SrvProcessSmb+0xb7&nbsp;(FPO:&nbsp;[0,0,0])
03&nbsp;b21f8dac&nbsp;805c7160&nbsp;srv!WorkerThread+0x11e&nbsp;(FPO:&nbsp;[Non-Fpo])
04&nbsp;b21f8ddc&nbsp;80542dd2&nbsp;nt!PspSystemThreadStartup+0x34&nbsp;(FPO:&nbsp;[Non-Fpo])
05&nbsp;00000000&nbsp;00000000&nbsp;nt!KiThreadStartup+0x16
SrvPeekNamedPipe()&nbsp;调用IoCallDriver最终调到&nbsp;RestartPeekNamedPipe()函数&nbsp;
VOID&nbsp;SRVFASTCALL&nbsp;RestartPeekNamedPipe&nbsp;(
&nbsp;&nbsp;&nbsp;&nbsp;IN&nbsp;OUT&nbsp;PWORK_CONTEXT&nbsp;WorkContext)
{
&nbsp;&nbsp;&nbsp;&nbsp;//...
&nbsp;&nbsp;&nbsp;&nbsp;//
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Success.&nbsp;&nbsp;Generate&nbsp;and&nbsp;send&nbsp;the&nbsp;response.
&nbsp;&nbsp;&nbsp;&nbsp;//
&nbsp;&nbsp;&nbsp;&nbsp;transaction&nbsp;=&nbsp;WorkContext-&gt;Parameters.Transaction;
&nbsp;&nbsp;&nbsp;&nbsp;pipePeekBuffer&nbsp;=&nbsp;(PFILE_PIPE_PEEK_BUFFER)transaction-&gt;OutParameters;
&nbsp;&nbsp;&nbsp;&nbsp;readDataAvailable&nbsp;=&nbsp;(USHORT)pipePeekBuffer-&gt;ReadDataAvailable;
&nbsp;&nbsp;&nbsp;&nbsp;messageLength&nbsp;=&nbsp;(USHORT)pipePeekBuffer-&gt;MessageLength;
&nbsp;&nbsp;&nbsp;&nbsp;namedPipeState&nbsp;=&nbsp;(USHORT)pipePeekBuffer-&gt;NamedPipeState;
&nbsp;&nbsp;&nbsp;&nbsp;//
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;...&nbsp;then&nbsp;copy&nbsp;them&nbsp;back&nbsp;in&nbsp;the&nbsp;new&nbsp;format.
&nbsp;&nbsp;&nbsp;&nbsp;//
&nbsp;&nbsp;&nbsp;&nbsp;respPeekNmPipe&nbsp;=&nbsp;(PRESP_PEEK_NMPIPE)pipePeekBuffer;
&nbsp;&nbsp;&nbsp;&nbsp;SmbPutAlignedUshort(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;respPeekNmPipe-&gt;ReadDataAvailable,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;readDataAvailable
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);
&nbsp;&nbsp;&nbsp;&nbsp;SmbPutAlignedUshort(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;respPeekNmPipe-&gt;MessageLength,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;messageLength
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);
&nbsp;&nbsp;&nbsp;&nbsp;SmbPutAlignedUshort(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;respPeekNmPipe-&gt;NamedPipeState,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;namedPipeState
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);
&nbsp;&nbsp;&nbsp;&nbsp;//
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Send&nbsp;the&nbsp;response.&nbsp;&nbsp;Set&nbsp;the&nbsp;output&nbsp;counts.
&nbsp;&nbsp;&nbsp;&nbsp;//
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;NT&nbsp;return&nbsp;to&nbsp;us&nbsp;4&nbsp;ULONGS&nbsp;of&nbsp;parameter&nbsp;bytes,&nbsp;followed&nbsp;by&nbsp;data.
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;We&nbsp;return&nbsp;to&nbsp;the&nbsp;client&nbsp;6&nbsp;parameter&nbsp;bytes.
&nbsp;&nbsp;&nbsp;&nbsp;//
&nbsp;&nbsp;&nbsp;&nbsp;transaction-&gt;SetupCount&nbsp;=&nbsp;0;
&nbsp;&nbsp;&nbsp;&nbsp;transaction-&gt;ParameterCount&nbsp;=&nbsp;6;
&nbsp;&nbsp;&nbsp;&nbsp;transaction-&gt;DataCount&nbsp;=&nbsp;WorkContext-&gt;Irp-&gt;IoStatus.Information&nbsp;-&nbsp;(4&nbsp;*&nbsp;sizeof(ULONG));
&nbsp;&nbsp;&nbsp;&nbsp;//...
}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">该函数最终会修改Transaction-&amp;gt;DataCount 为 0x23c。</span></p><pre class="brush:plain;toolbar:false">kd&gt;&nbsp;ub
srv!RestartPeekNamedPipe+0x42:
b7700137&nbsp;66895004&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;word&nbsp;ptr&nbsp;[eax+4],dx
b770013b&nbsp;83614c00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[ecx+4Ch],0
b770013f&nbsp;c7415406000000&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[ecx+54h],6
b7700146&nbsp;8b4678&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,dword&nbsp;ptr&nbsp;[esi+78h]
b7700149&nbsp;8b401c&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,dword&nbsp;ptr&nbsp;[eax+1Ch]
b770014c&nbsp;83e810&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sub&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,10h
b770014f&nbsp;85ff&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;test&nbsp;&nbsp;&nbsp;&nbsp;edi,edi
b7700151&nbsp;894160&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[ecx+60h],eax
kd&gt;&nbsp;?ecx+0x60
Evaluate&nbsp;expression:&nbsp;367768&nbsp;=&nbsp;00059c98
kd&gt;&nbsp;r&nbsp;eax
eax=0000023c
kd&gt;&nbsp;dd&nbsp;00059c38
00059c38&nbsp;&nbsp;109c020c&nbsp;00000000&nbsp;ffdff500&nbsp;89a29c18
00059c48&nbsp;&nbsp;e1ed9900&nbsp;e15e2960&nbsp;0005acf8&nbsp;00058ba8
00059c58&nbsp;&nbsp;00020000&nbsp;00059cd0&nbsp;00002307&nbsp;00000001
00059c68&nbsp;&nbsp;00000000&nbsp;00059cd4&nbsp;8993b3e5&nbsp;00059cd4
00059c78&nbsp;&nbsp;00059d14&nbsp;ffdff500&nbsp;0005acd4&nbsp;00000000
00059c88&nbsp;&nbsp;00000000&nbsp;00000006&nbsp;00000000&nbsp;00000ff0
00059c98&nbsp;&nbsp;0000023c&nbsp;00000000&nbsp;00000001&nbsp;00000000
00059ca8&nbsp;&nbsp;00000101&nbsp;08000000&nbsp;0800cee6&nbsp;00000000
kd&gt;&nbsp;k
&nbsp;#&nbsp;ChildEBP&nbsp;RetAddr&nbsp;&nbsp;
00&nbsp;b7c0ed88&nbsp;b76dad98&nbsp;srv!RestartPeekNamedPipe+0x5f
01&nbsp;b7c0edac&nbsp;805c6160&nbsp;srv!WorkerThread+0x11e
02&nbsp;b7c0eddc&nbsp;80541dd2&nbsp;nt!PspSystemThreadStartup+0x34
03&nbsp;00000000&nbsp;00000000&nbsp;nt!KiThreadStartup+0x16</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">至此，已经成功修改了write_transaction的DataCount值，之后便可以越界读出 leak_transacion-&amp;gt;Connection值: 89a29c18。</span></p><p style="text-indent: 2em; text-align: left;"><strong>5.1.1.3 SRV global data pointer</strong></p><pre class="brush:plain;toolbar:false">kd&gt;&nbsp;dds&nbsp;89a29c18
89a29c18&nbsp;&nbsp;02580202
89a29c1c&nbsp;&nbsp;0000001d
89a29c20&nbsp;&nbsp;00000000
89a29c24&nbsp;&nbsp;00000000
89a29c28&nbsp;&nbsp;00000000
89a29c2c&nbsp;&nbsp;00000000
89a29c30&nbsp;&nbsp;00000000
89a29c34&nbsp;&nbsp;00000000
89a29c38&nbsp;&nbsp;00000000
89a29c3c&nbsp;&nbsp;b76d8bec&nbsp;srv!SrvGlobalSpinLocks+0x3c
89a29c40&nbsp;&nbsp;899d0020
89a29c44&nbsp;&nbsp;000005b3
89a29c48&nbsp;&nbsp;8976c200
89a29c4c&nbsp;&nbsp;00004000
89a29c50&nbsp;&nbsp;10000100
89a29c54&nbsp;&nbsp;00000000
89a29c58&nbsp;&nbsp;8988e010
89a29c5c&nbsp;&nbsp;89aedc30
89a29c60&nbsp;&nbsp;89a7d898
89a29c64&nbsp;&nbsp;0001ffff</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">其中srv!SrvGlobalSpinLocks+0x3c 就是所谓的 SRV global data pointer ：b76d8bec</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><strong>5.1.1.4 Locating function tables</strong></span></p><pre class="brush:plain;toolbar:false">kd&gt;&nbsp;dds&nbsp;b76d8bec-0x654
b76d8598&nbsp;&nbsp;b7709683&nbsp;srv!SrvSmbOpen2
b76d859c&nbsp;&nbsp;b76f62a8&nbsp;srv!SrvSmbFindFirst2
b76d85a0&nbsp;&nbsp;b76f74e5&nbsp;srv!SrvSmbFindNext2
b76d85a4&nbsp;&nbsp;b76f6309&nbsp;srv!SrvSmbQueryFsInformation
b76d85a8&nbsp;&nbsp;b7707293&nbsp;srv!SrvSmbSetFsInformation
b76d85ac&nbsp;&nbsp;b77041ad&nbsp;srv!SrvSmbQueryPathInformation
b76d85b0&nbsp;&nbsp;b7703ce7&nbsp;srv!SrvSmbSetPathInformation
b76d85b4&nbsp;&nbsp;b77025ad&nbsp;srv!SrvSmbQueryFileInformation
b76d85b8&nbsp;&nbsp;b770367f&nbsp;srv!SrvSmbSetFileInformation
b76d85bc&nbsp;&nbsp;b7705c85&nbsp;srv!SrvSmbFsctl
b76d85c0&nbsp;&nbsp;b7706419&nbsp;srv!SrvSmbIoctl2
b76d85c4&nbsp;&nbsp;b7705c85&nbsp;srv!SrvSmbFsctl
b76d85c8&nbsp;&nbsp;b7705c85&nbsp;srv!SrvSmbFsctl
b76d85cc&nbsp;&nbsp;b77047bb&nbsp;srv!SrvSmbCreateDirectory2
b76d85d0&nbsp;&nbsp;b7709a51&nbsp;srv!SrvTransactionNotImplemented
b76d85d4&nbsp;&nbsp;b7709a51&nbsp;srv!SrvTransactionNotImplemented
b76d85d8&nbsp;&nbsp;b76fb144&nbsp;srv!SrvSmbGetDfsReferral
b76d85dc&nbsp;&nbsp;b76faf7e&nbsp;srv!SrvSmbReportDfsInconsistency
b76d85e0&nbsp;&nbsp;00000000</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">5.1.2 泄露Npp Buffer (shellcode buffer)</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">这里又得回到ExecuteTransaction函数：</span></p><pre class="brush:plain;toolbar:false">SMB_STATUS&nbsp;SRVFASTCALL&nbsp;ExecuteTransaction&nbsp;(
&nbsp;&nbsp;&nbsp;&nbsp;IN&nbsp;OUT&nbsp;PWORK_CONTEXT&nbsp;WorkContext)
{
&nbsp;&nbsp;&nbsp;&nbsp;//...
&nbsp;&nbsp;&nbsp;&nbsp;header&nbsp;=&nbsp;WorkContext-&amp;gt;ResponseHeader;
&nbsp;&nbsp;&nbsp;&nbsp;response&nbsp;=&nbsp;(PRESP_TRANSACTION)WorkContext-&amp;gt;ResponseParameters;
&nbsp;&nbsp;&nbsp;&nbsp;ntResponse&nbsp;=&nbsp;(PRESP_NT_TRANSACTION)WorkContext-&amp;gt;ResponseParameters;
&nbsp;&nbsp;&nbsp;&nbsp;//
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Setup&nbsp;output&nbsp;pointers
&nbsp;&nbsp;&nbsp;&nbsp;//
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;transaction-&amp;gt;OutParameters&nbsp;==&nbsp;NULL&nbsp;)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Parameters&nbsp;will&nbsp;go&nbsp;into&nbsp;the&nbsp;SMB&nbsp;buffer.&nbsp;&nbsp;Calculate&nbsp;the&nbsp;pointer
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;then&nbsp;round&nbsp;it&nbsp;up&nbsp;to&nbsp;the&nbsp;next&nbsp;DWORD&nbsp;address.
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;transaction-&amp;gt;OutParameters&nbsp;=&nbsp;(PCHAR)(transaction-&amp;gt;OutSetup&nbsp;+
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;transaction-&amp;gt;MaxSetupCount);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;offset&nbsp;=&nbsp;(transaction-&amp;gt;OutParameters&nbsp;-&nbsp;(PCHAR)header&nbsp;+&nbsp;3)&nbsp;&amp;amp;&nbsp;~3;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;transaction-&amp;gt;OutParameters&nbsp;=&nbsp;(PCHAR)header&nbsp;+&nbsp;offset;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;transaction-&amp;gt;OutData&nbsp;==&nbsp;NULL&nbsp;)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Data&nbsp;will&nbsp;go&nbsp;into&nbsp;the&nbsp;SMB&nbsp;buffer.&nbsp;&nbsp;Calculate&nbsp;the&nbsp;pointer
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;then&nbsp;round&nbsp;it&nbsp;up&nbsp;to&nbsp;the&nbsp;next&nbsp;DWORD&nbsp;address.
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;transaction-&amp;gt;OutData&nbsp;=&nbsp;transaction-&amp;gt;OutParameters&nbsp;+
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;transaction-&amp;gt;MaxParameterCount;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;offset&nbsp;=&nbsp;(transaction-&amp;gt;OutData&nbsp;-&nbsp;(PCHAR)header&nbsp;+&nbsp;3)&nbsp;&amp;amp;&nbsp;~3;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;transaction-&amp;gt;OutData&nbsp;=&nbsp;(PCHAR)header&nbsp;+&nbsp;offset;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//...
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;command&nbsp;=&nbsp;SmbGetUshort(&amp;amp;transaction-&amp;gt;InSetup[0]);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//...
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;switch(&nbsp;command&nbsp;)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;TRANS_TRANSACT_NMPIPE:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resultStatus&nbsp;=&nbsp;SrvTransactNamedPipe(&nbsp;WorkContext&nbsp;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;TRANS_PEEK_NMPIPE:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;resultStatus&nbsp;=&nbsp;SrvPeekNamedPipe(&nbsp;WorkContext&nbsp;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//...
}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">这在这个函数里有这么一个逻辑，当transaction-&amp;gt;OutParameters==NULL里，会将PWORK_CONTEXT-&amp;gt;ResponseHeader加上一定的offset赋于它，PWORK_CONTEXT-&amp;gt;ResponseHeader就是个NonePagedPool.</span></p><pre class="brush:plain;toolbar:false">kd&gt;&nbsp;ub&nbsp;eip
srv!ExecuteTransaction+0x60:
b76e8d05&nbsp;46&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;inc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;esi
b76e8d06&nbsp;50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;eax
b76e8d07&nbsp;d1e0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shl&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,1
b76e8d09&nbsp;2bc2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sub&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,edx
b76e8d0b&nbsp;8d440803&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lea&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,[eax+ecx+3]
b76e8d0f&nbsp;83e0fc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,0FFFFFFFCh
b76e8d12&nbsp;03c2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,edx
b76e8d14&nbsp;894640&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[esi+40h],eax
kd&gt;&nbsp;dd&nbsp;5ace0
0005ace0&nbsp;&nbsp;109c020c&nbsp;00000000&nbsp;89b2c948&nbsp;89a29c18
0005acf0&nbsp;&nbsp;e1ed9900&nbsp;e15e2960&nbsp;0005bda0&nbsp;00059c50
0005ad00&nbsp;&nbsp;00020000&nbsp;0005ad78&nbsp;00002361&nbsp;40010036
0005ad10&nbsp;&nbsp;00000000&nbsp;0005ad0c&nbsp;8993fa25&nbsp;0005ad7c
0005ad20&nbsp;&nbsp;8993fa28&nbsp;0005ad7c&nbsp;b76d84ec&nbsp;00000004
0005ad30&nbsp;&nbsp;00000000&nbsp;00000000&nbsp;00000000&nbsp;00000010
0005ad40&nbsp;&nbsp;00000000&nbsp;00000000&nbsp;00000100&nbsp;00000000
0005ad50&nbsp;&nbsp;00000101&nbsp;08000000&nbsp;0800cee6&nbsp;0000004b
kd&gt;&nbsp;?&nbsp;esi+0x40
Evaluate&nbsp;expression:&nbsp;372000&nbsp;=&nbsp;0005ad20
kd&gt;&nbsp;r&nbsp;eax
eax=8993fa28</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><strong>5.1.2.1 transaction-&gt;OutParameters=NULL</strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Transaction 初始状态下OutParameters并不为NULL：</span></p><pre class="brush:plain;toolbar:false">kd&gt;&nbsp;dd&nbsp;5ace0
0005ace0&nbsp;&nbsp;109c020c&nbsp;00000000&nbsp;89b2c948&nbsp;89a29c18
0005acf0&nbsp;&nbsp;e1ed9900&nbsp;e15e2960&nbsp;0005bda0&nbsp;00059c50
0005ad00&nbsp;&nbsp;00020000&nbsp;0005ad78&nbsp;00002361&nbsp;00000001
0005ad10&nbsp;&nbsp;00000000&nbsp;0005ad7c&nbsp;00000000&nbsp;0005ad7c
0005ad20&nbsp;&nbsp;0005adbc&nbsp;0005ad7c&nbsp;0005bd7c&nbsp;00000000
0005ad30&nbsp;&nbsp;00000000&nbsp;00000000&nbsp;00000000&nbsp;00000fc0
0005ad40&nbsp;&nbsp;00000000&nbsp;00000040&nbsp;00000000&nbsp;00000000
0005ad50&nbsp;&nbsp;00000101&nbsp;08000000&nbsp;0800cee6&nbsp;0000004b</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">这里通过write_transaction越界 写 leak_transaction-&amp;gt;OutParameters为NULL, 然后发包触发写leak_transaction操作，之后leak_transaction-&amp;gt;OutParameters便为一 Npp Buffer值了。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><strong>5.1.2.2 leak_transaction-&gt;OutData = &amp;leak_transaction-&gt;OutParameters</strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">这里要事先泄露leak_transaction的基址，其实也不难，通过读leak_transaction的OutData 或 OutParameters 或 InData 字段的值再减去一定的偏移便得到了基址，使leak_transaction-&amp;gt;OutData = &amp;amp;leak_transaction-&amp;gt;OutParameters之后，发包触发leak_transaction读操作便将该Npp buffer地址泄露出来了。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><strong>5.1.2.3 写shellcode到Npp Buffer</strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">将control_transaction-&amp;gt;OutData设为Npp Buffer+0x100地址，然后发包发送shellcode，便将shellcode写到了Npp Buffer+0x100内。</span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192); font-size: 18px; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><strong>5.2 代码执行</strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">至此，直接将Npp buffer+0x100写到之前泄露出来的函数表里</span></p><pre class="brush:plain;toolbar:false">kd&gt;&nbsp;dds&nbsp;b76d8598
b76d8598&nbsp;&nbsp;b7709683&nbsp;srv!SrvSmbOpen2
b76d859c&nbsp;&nbsp;b76f62a8&nbsp;srv!SrvSmbFindFirst2
b76d85a0&nbsp;&nbsp;b76f74e5&nbsp;srv!SrvSmbFindNext2
b76d85a4&nbsp;&nbsp;b76f6309&nbsp;srv!SrvSmbQueryFsInformation
b76d85a8&nbsp;&nbsp;b7707293&nbsp;srv!SrvSmbSetFsInformation
b76d85ac&nbsp;&nbsp;b77041ad&nbsp;srv!SrvSmbQueryPathInformation
b76d85b0&nbsp;&nbsp;b7703ce7&nbsp;srv!SrvSmbSetPathInformation
b76d85b4&nbsp;&nbsp;b77025ad&nbsp;srv!SrvSmbQueryFileInformation
b76d85b8&nbsp;&nbsp;b770367f&nbsp;srv!SrvSmbSetFileInformation
b76d85bc&nbsp;&nbsp;b7705c85&nbsp;srv!SrvSmbFsctl
b76d85c0&nbsp;&nbsp;b7706419&nbsp;srv!SrvSmbIoctl2
b76d85c4&nbsp;&nbsp;b7705c85&nbsp;srv!SrvSmbFsctl
b76d85c8&nbsp;&nbsp;b7705c85&nbsp;srv!SrvSmbFsctl
b76d85cc&nbsp;&nbsp;b77047bb&nbsp;srv!SrvSmbCreateDirectory2
b76d85d0&nbsp;&nbsp;8993fb28
b76d85d4&nbsp;&nbsp;b7709a51&nbsp;srv!SrvTransactionNotImplemented
b76d85d8&nbsp;&nbsp;b76fb144&nbsp;srv!SrvSmbGetDfsReferral
b76d85dc&nbsp;&nbsp;b76faf7e&nbsp;srv!SrvSmbReportDfsInconsistency
b76d85e0&nbsp;&nbsp;00000000</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">之后发包就能触发该函数调用：</span></p><pre class="brush:plain;toolbar:false">kd&gt;&nbsp;k
&nbsp;#&nbsp;ChildEBP&nbsp;RetAddr&nbsp;&nbsp;
WARNING:&nbsp;Frame&nbsp;IP&nbsp;not&nbsp;in&nbsp;any&nbsp;known&nbsp;module.&nbsp;Following&nbsp;frames&nbsp;may&nbsp;be&nbsp;wrong.
00&nbsp;b72b4cf0&nbsp;b76e8d76&nbsp;0x8993fb28
01&nbsp;b72b4d04&nbsp;b76e341f&nbsp;srv!ExecuteTransaction+0xdb
02&nbsp;b72b4d7c&nbsp;b76ca836&nbsp;srv!SrvSmbTransaction+0x7ac
03&nbsp;b72b4d88&nbsp;b76dad98&nbsp;srv!SrvProcessSmb+0xb7
04&nbsp;b72b4dac&nbsp;805c6160&nbsp;srv!WorkerThread+0x11e
05&nbsp;b72b4ddc&nbsp;80541dd2&nbsp;nt!PspSystemThreadStartup+0x34
06&nbsp;00000000&nbsp;00000000&nbsp;nt!KiThreadStartup+0x16</pre><p style="text-indent: 2em; text-align: left;"><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><strong>6 关于补丁</strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">了解了漏洞原理之后修补都很简单了。只要在srv!SrvFindTransaction里面判断一下SMB COMMAND的类型是否一致就好了。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">修补前</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:plain;toolbar:false">TRANSCATION&nbsp;*__fastcall&nbsp;SrvFindTransaction(int&nbsp;pConnect,&nbsp;SMB_HEADER&nbsp;*Fid,&nbsp;__int16&nbsp;a3)
{
&nbsp;&nbsp;_DWORD&nbsp;**pTransList;&nbsp;//&nbsp;eax@4
&nbsp;&nbsp;_DWORD&nbsp;*v6;&nbsp;//&nbsp;ebx@4
&nbsp;&nbsp;PDEVICE_OBJECT&nbsp;v7;&nbsp;//&nbsp;ecx@5
&nbsp;&nbsp;TRANSCATION&nbsp;*pTransaction;&nbsp;//&nbsp;esi@6
&nbsp;&nbsp;char&nbsp;Command_Trans;&nbsp;//&nbsp;al@10
&nbsp;&nbsp;char&nbsp;Command_header;&nbsp;//&nbsp;dl@10
&nbsp;&nbsp;__int16&nbsp;MIDorFID;&nbsp;//&nbsp;[sp+Ch]&nbsp;[bp-Ch]@2
&nbsp;&nbsp;struct&nbsp;_ERESOURCE&nbsp;*Resource;&nbsp;//&nbsp;[sp+14h]&nbsp;[bp-4h]@4
&nbsp;&nbsp;if&nbsp;(&nbsp;Fid-&gt;Command&nbsp;==&nbsp;0x2F&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;MIDorFID&nbsp;=&nbsp;a3;
&nbsp;&nbsp;else
&nbsp;&nbsp;&nbsp;&nbsp;MIDorFID&nbsp;=&nbsp;Fid-&gt;MID;
&nbsp;&nbsp;Resource&nbsp;=&nbsp;(struct&nbsp;_ERESOURCE&nbsp;*)(pConnect&nbsp;+&nbsp;0x19C);
&nbsp;&nbsp;ExAcquireResourceExclusiveLite((PERESOURCE)(pConnect&nbsp;+&nbsp;0x19C),&nbsp;1u);
&nbsp;&nbsp;pTransList&nbsp;=&nbsp;(_DWORD&nbsp;**)(*(_DWORD&nbsp;*)(pConnect&nbsp;+&nbsp;0x160)&nbsp;+&nbsp;8);
&nbsp;&nbsp;v6&nbsp;=&nbsp;*pTransList;
&nbsp;&nbsp;if&nbsp;(&nbsp;*pTransList&nbsp;==&nbsp;pTransList&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;goto&nbsp;LABEL_14;
&nbsp;&nbsp;v7&nbsp;=&nbsp;WPP_GLOBAL_Control;
&nbsp;&nbsp;while&nbsp;(&nbsp;1&nbsp;)
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;pTransaction&nbsp;=&nbsp;(TRANSCATION&nbsp;*)(v6&nbsp;-&nbsp;6);
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;*((_WORD&nbsp;*)v6&nbsp;+&nbsp;49)&nbsp;==&nbsp;Fid-&gt;TID
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;pTransaction-&gt;PID&nbsp;==&nbsp;Fid-&gt;PID
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;pTransaction-&gt;UID&nbsp;==&nbsp;Fid-&gt;UID
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;pTransaction-&gt;MID&nbsp;==&nbsp;MIDorFID&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;
&nbsp;&nbsp;&nbsp;&nbsp;}
LABEL_13:
&nbsp;&nbsp;&nbsp;&nbsp;v6&nbsp;=&nbsp;(_DWORD&nbsp;*)*v6;
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;v6&nbsp;==&nbsp;(_DWORD&nbsp;*)(*(_DWORD&nbsp;*)(pConnect&nbsp;+&nbsp;0x160)&nbsp;+&nbsp;8)&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto&nbsp;LABEL_14;
&nbsp;&nbsp;}
&nbsp;&nbsp;//
&nbsp;&nbsp;//&nbsp;这里添加了对COMMAND的比较。比较pTransaction和请求中SMB_HEADER中的COMMAND进行对比
&nbsp;&nbsp;//
&nbsp;&nbsp;Command_Trans&nbsp;=&nbsp;pTransaction-&gt;Command;
&nbsp;&nbsp;Command_header&nbsp;=&nbsp;Fid-&gt;Command;
&nbsp;&nbsp;if&nbsp;(&nbsp;Command_Trans&nbsp;!=&nbsp;Command_header&nbsp;)
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;(PDEVICE_OBJECT&nbsp;*)v7&nbsp;!=&nbsp;&amp;WPP_GLOBAL_Control&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WPP_SF_qDD(v7-&gt;AttachedDevice,&nbsp;v7-&gt;CurrentIrp,&nbsp;(_BYTE)v6&nbsp;-&nbsp;24,&nbsp;Command_header,&nbsp;Command_Trans);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v7&nbsp;=&nbsp;WPP_GLOBAL_Control;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;goto&nbsp;LABEL_13;
&nbsp;&nbsp;}
&nbsp;&nbsp;if&nbsp;(&nbsp;BYTE1(pTransaction-&gt;field_0)&nbsp;==&nbsp;2&nbsp;)
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;_InterlockedIncrement((volatile&nbsp;signed&nbsp;__int32&nbsp;*)(pTransaction-&gt;field_8&nbsp;+&nbsp;4));
&nbsp;&nbsp;&nbsp;&nbsp;goto&nbsp;LABEL_15;
&nbsp;&nbsp;}
LABEL_14:
&nbsp;&nbsp;pTransaction&nbsp;=&nbsp;0;
LABEL_15:
&nbsp;&nbsp;ExReleaseResourceLite(Resource);
&nbsp;&nbsp;return&nbsp;pTransaction;
}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">补丁点就是if ( Command_Trans != Command_header )看注释的地方。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">7 总结</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">总之，这个漏洞还是非常好的，远程任意地址写，还可以信息泄露。威力很大。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">8 联系作者</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><a href="http://weibo.com/pgboy1988" target="_self" style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(227, 108, 9); text-decoration: underline;"><span style="color: rgb(227, 108, 9);"><strong>pgboy 微博</strong></span></a></p><p style="text-indent: 2em; text-align: left;"><a href="http://weibo.com/2641521260" target="_self" style="text-decoration: underline; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(227, 108, 9);"><span style="color: rgb(227, 108, 9);"><strong><span style="color: rgb(227, 108, 9); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">zhong_sf 微博</span></strong></span></a></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">如果你感觉排版不舒服可以去<a href="https://github.com/progmboy/vul_analyze_doc" target="_self" style="color: rgb(227, 108, 9); text-decoration: underline;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(227, 108, 9);"><strong>这里</strong></span></a>下载原始的markdown文件。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><p style="white-space: normal; text-indent: 2em;"><span style="color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px;">传送门</span></strong></span></p><p style="white-space: normal; text-indent: 2em;"><span style="color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px;"></span></strong></span></p><hr style="white-space: normal;"/><p style="white-space: normal; text-indent: 2em;"><a href="http://bobao.360.cn/learning/detail/3738.html" target="_self" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px; color: rgb(0, 112, 192);"><strong>【漏洞分析】MS 17-010：NSA Eternalblue SMB 漏洞分析</strong></a></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span><br/></p></p>
                <hr/>
                <p style="text-align: center;">
                    <img src="http://bobao.360.cn/img/app.jpeg"/>
                    <img src="http://bobao.360.cn/img/weixin.jpeg"/>
                </p>
                                <p>本文转载自 360安全卫士技术博客<br/><a class="text-more" href="http://blogs.360.cn/360safe/2017/04/19/eternalromance-analyze/" target="_blank">原文链接：http://blogs.360.cn/360safe/2017/04/19/eternalromance-analyze/</a></p>
                            </div>
            <div style="margin-top: 20px;background-color:#FFFFFF">
    <input type="hidden" id="detail_title" name="detail_title" value="【漏洞分析】NSA Eternalromance （永恒浪漫） 漏洞分析 - 安全客 - 有思想的安全新媒体" />
    <input type="hidden" id="use_nickname" name="use_nickname" value="0" />
    <a name="mao"></a>
    <div class="reg-log mobile-hiden">
        <div class="" id="userTo">   
            <div id="to-list" class="input-text" style="">
                <textarea disabled="disabled" class="hide"  id="comment-content" to="to"></textarea>
                <ul id="preadded" style="display:none">       
                </ul>
                <div id="to-auto" style="width: 200px">
                    <ul id="feed">
                    </ul>
                </div>
            </div>
        </div>
        <input type="hidden" id="source-id" value="3747" />
        <input type="hidden" id="source-type" value="learning" />
        <input type="hidden" id="post-comment-url" value="/comment/add" />
        <input type="hidden" id="post-nickname-url-ajax" value="/comment/randnicknameajax" />
        <input type="hidden" id="post-check-login-url-ajax" value="/comment/checklogin" />
        <input type="hidden" id="stoken_comment_set" value="ea3898fb4df38673fdeb61c458234054">                 <span class="join">参与讨论，请先 <a href="javascript:;" class="comment-login">登录</a> | <a href="javascript:;" class="comment-reg">注册</a> |  <a href="javascript:;" class="anonymous-comment">匿名评论</a></span>
            </div>
    <div class="mobile-hide" style="width: 870px; margin: 0 auto;">
        <label style="vertical-align:middle;" for="use_nickname">匿名</label> 
        <input style="vertical-align:middle;" id="trigger-nickname" name="use_nickname" class="use_nickname" type="checkbox" value="0" />

        <a href="javascript:;" class="apply-use button" id="submit-comment" data-target="/comment/add">发布</a>
    </div>


    <div class="clearfix"></div>
    <div class="comments">
        <div class="comments-head">
            <span class="title">用户评论</span>
        </div>
                <div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/9x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="2518293786" class="response" data-bind-id="2518293786" data-target="13583" user-name="三六零他爸爸爸" href="javascript:;">
                三六零他爸爸爸            </a>
                        <span class="comment-time">2017-04-24 03:35:56</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="2518293786" data-target="13583">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_13583" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">有谁改造了这个利用工具吗</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/9x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="397635307" class="response" data-bind-id="397635307" data-target="13467" user-name="匿名用户" href="javascript:;">
                匿名用户            </a>
                        <span class="comment-time">2017-04-20 13:33:09</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="397635307" data-target="13467">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_13467" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">好像没看到到底怎么利用工具去撸</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/11x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="13418" user-name="妇科圣手" href="javascript:;">
                妇科圣手            </a>
                        <span class="comment-time">2017-04-19 20:16:03</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="13418">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_13418" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">网上已经被各种BLUE打到飞起了。。。。。</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>

        <a class="more-long comment-more" href="javascript:;" data-target="/comment/more" data-type="learning" data-source-id="3747" data-page="2">查看更多</a>
            </div>
</div>
<script>
    $(function () {
        $('.anonymous-comment').click(function () {
            $(".join").hide();
            $(".reg-log textarea").first().removeAttr("disabled").show();
            $('#use_nickname').val('1');
//            $('#trigger-nickname').attr('checked', true);
            $('#trigger-nickname').trigger('click');
        });
        //为所有复选框绑定事件
//        checkbox_on_click();
        //ajax随机获取昵称
//        randnicknameajax(0);
        //ajax检测登录状态
        comment_check_login();
    });



    function input_checkbox(flag) {
        $('input:checkbox').each(function () {
            var value = flag ? 1 : 0;
            $(this).prop('checked', flag);
            $(this).val(value);
        });
    }

//ajax随机获取昵称
    function randnicknameajax(flag) {
        $.ajax({
            type: 'POST',
            url: $('#post-nickname-url-ajax').val(),
            data: {limit: 1, flag: flag},
            dataType: "json",
            success: function (data) {
                $('#nick-name').val(data.data[0]);
                _nick_name=data.data[0];
            }
        });
    }
    $();
//ajax检测登录状态
    function comment_check_login() {
        $.ajax({
            type: 'POST',
            url: $('#post-check-login-url-ajax').val(),
            data: {},
            dataType: "json",
            success: function (data) {
                if (data.success) {
                    $('.join').hide();
                    $(".reg-log textarea").first().removeAttr("disabled").show();
                    $("#span_use_nickname").show();
                    $('#use_nickname').val('0');
                    $('#use_nickname').attr('checked', false);
                }
            }
        });
    }
</script>        </div>
    </div>
    <div class="side-bar">
        <div class="mod hot-news">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-hot"></i><span>热门知识</span></h2>
    </div>
    <ul class="links-list">
                                <li><a href="/learning/detail/4411.html" alt="【漏洞预警】一个换行符引发的奥斯卡0day漏洞(CVE-2017-8759)重现——最新的Office高级威胁攻击预警" target="_blank">【漏洞预警】一个换行符引发的奥斯卡...</a></li>
                                <li><a href="/learning/detail/4416.html" alt="【漏洞预警】Microsoft .NET Framework漏洞（CVE–2017–8759）预警" target="_blank">【漏洞预警】Microsoft .NE...</a></li>
                                <li><a href="/learning/detail/4414.html" alt="【技术分享】妙用JavaScript绕过XSS过滤" target="_blank">【技术分享】妙用JavaScrip...</a></li>
                                <li><a href="/learning/detail/4418.html" alt="【技术分享】利用威胁情报数据平台拓展APT攻击线索一例" target="_blank">【技术分享】利用威胁情报数据平台拓...</a></li>
                                <li><a href="/learning/detail/4417.html" alt="【知识】9月15日 - 每日安全知识热点" target="_blank">【知识】9月15日 - 每日安全知识热...</a></li>
                                <li><a href="/learning/detail/4425.html" alt="【安全报告】XShellGhost事件技术回顾报告" target="_blank">【安全报告】XShellGhost事件...</a></li>
            </ul>
</div>        <!-- 友情链接 -->
        <div class="mod blog-links mobile-hide">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-link"></i><span>友情链接</span></h2>
        <a href="/links/index.html" class="more">更多<i></i></a>
    </div>
        <ul class="links-list">
                <li><a href="http://bbs.360safe.com" alt="360安全社区" target="_blank">360安全社区</a></li>
                <li><a href="http://zhuji.360.cn" alt="360主机卫士" target="_blank">360主机卫士</a></li>
                <li><a href="http://blogs.360.cn/" alt="奇虎360技术博客" target="_blank">奇虎360技术博客</a></li>
                <li><a href="http://wangzhan.360.cn/" alt="360网站卫士" target="_blank">360网站卫士</a></li>
                <li><a href="http://webscan.360.cn/" alt="360网站安全检测" target="_blank">360网站安全检测</a></li>
                <li><a href="http://research.360.cn/report/" alt="360研究报告" target="_blank">360研究报告</a></li>
                <li><a href="http://unicorn.360.cn/" alt="360 Unicorn Team" target="_blank">360 Unicorn Team</a></li>
                <li><a href="http://appscan.360.cn/" alt="360捉虫猎手" target="_blank">360捉虫猎手</a></li>
                <li><a href="https://threathunter.org/" alt="ThreatHunter社区" target="_blank">ThreatHunter社区</a></li>
                <li><a href="http://security.360.cn/" alt="360安全应急响应中心" target="_blank">360安全应急响应中心</a></li>
            </ul>
    </div>
        <!-- 联系我们 -->
        <div class="mod contact mobile-hide" style="text-align:center">
    <div class="head-bar clearfix">
        <h2><i></i><span>关注我们</span></h2>
    </div>
    <!-- 微信关注 -->
    <ul class="contact-way">
        <li><a>微信关注</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/qrcode_adlab_weixin.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
    <!-- APP下载 -->
    <ul class="contact-way">
        <li><a>安全播报APP</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/scan_code_big.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
</div>

    </div>
</div>

<script type="text/javascript" src="/js/jquery-ui.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/jquery.noty.packaged.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/common.js?v=4.5"></script>
<script>$(function() {sync_count('comment');});</script>


<!-- 语法高亮 -->
<script type="text/javascript" src="/ue/SyntaxHighlighter/shCore.js"></script>
<script type="text/javascript">SyntaxHighlighter.all();sync_count('vul');sync_count('news');sync_count('learning');sync_count('activity');sync_count('course');sync_count('ctf');</script>
    </div>

        <div class="footer">
        <div class="friend-link">
            <a href="http://www.360.cn/" target="_blank">360首页</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">关于我们</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">联系我们</a>
            <span>|</span>
            <a href="/links/index.html" target="_blank">友情链接</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">招贤纳士</a>
        </div>
        <div class="copy">
            Copyright &copy; 360网络攻防实验室 All Rights Reserved <span class="copy_icp">京ICP证080047号[京ICP备08010314号-6]</span>
        </div>
    </div>
    
</div>

<!--奇舞团统计-->

<script src='https://s.ssl.qhimg.com/static/f5407c785655e6a1/monitor_analytic.js'></script>
<script>
    monitor.setProject('QH_171_1').getTrack().getClickAndKeydown().getClickHeatmap(10, 1);
</script>

<div class="hide">
    <script src="https://s95.cnzz.com/z_stat.php?id=1253147824&web_id=1253147824" language="JavaScript"></script>
</div>
<div class="backToTop_wrap off">
    <a id="back_to_top" class="backToTop" href="javascript:;" title="返回顶部"></a>
</div>
<script>
    var $backToTop_wrap = $(".backToTop_wrap"),
        $backToTop_btn = $("#back_to_top");

    if ($(window).scrollTop() > 100) {
        $backToTop_wrap.removeClass("off");
    }
    else {
        $backToTop_wrap.addClass("off");
    }

    $(window).on("scroll", function () {
        if ($(this).scrollTop() > 100) {
            $backToTop_wrap.removeClass("off");
        }
        else {
            $backToTop_wrap.addClass("off");
        }
    });

    $backToTop_btn.on("click", function () {
        $("html, body").animate({scrollTop: 0}, 120);
    });

    $(function () {
        var navlist = $('.nav-list > li');

        navlist.each(function () {
            $(this).on('mouseenter', function () {
                $(this).addClass('selected');
            });

            $(this).on('mouseleave', function () {
                $(this).removeClass('selected');
            });
        });
    })
</script>



</body>
</html>
