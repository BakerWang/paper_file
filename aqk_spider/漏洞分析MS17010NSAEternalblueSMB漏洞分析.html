<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns:wb="http://open.weibo.com/wb" xml:lang="en" lang="en">
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"/>
    <link rel="shortcut icon" href="http://bobao.360.cn/favicon.ico?v=1.1"/>
    <link rel="alternate" title="安全资讯" href="/rss?type=news" type="application/rss+xml"/>
    <link rel="alternate" title="安全知识" href="/rss?type=learning" type="application/rss+xml"/>
    <link rel="alternate" title="安全圈活动" href="/rss?type=activity" type="application/rss+xml"/>
    <link rel="alternate" title="所有漏洞" href="/rss?type=vul" type="application/rss+xml"/>
    <link rel="alternate" title="通用型漏洞" href="/rss?type=commonvul" type="application/rss+xml"/>
    <link rel="alternate" title="事件型漏洞" href="/rss?type=eventvul" type="application/rss+xml"/>
    <link rel="alternate" title="热门漏洞" href="/rss?type=hotvul" type="application/rss+xml"/>

        <title>【漏洞分析】MS 17-010：NSA Eternalblue SMB 漏洞分析 - 安全客 - 有思想的安全新媒体</title>
    
        <meta name="keywords" content="MS17-010,ShadowBrokers,Eternalblue"/>
    
        <meta name="description" content="本文为针对ShadowBrokers放出的黑客工具包中其中一个漏洞利用工具Eternalblue SMB 的漏洞分析。"/>
        <meta property="wb:webmaster" content="224437c7be31d633"/>

    <script type="text/javascript" src="http://s7.qhimg.com/!56caa871/xpc_sync_height.js"></script>
    <link rel="stylesheet" type="text/css" href="/css/reset.css" />
    <link rel="stylesheet" type="text/css" href="/css/common_new.css?v=4.4.2.1" />
    <link rel="stylesheet" type="text/css" href="/css/jquery.notyfy.css" />
    <link rel="stylesheet" type="text/css" href="/css/notyfy.theme.default.css" />
    <link rel="stylesheet" type="text/css" href="/css/s_common.css?v=2.2.7" media="only screen and
    (max-device-width:900px), only screen and (max-width:900px)" />
    <script type="text/javascript" src="/js/jquery.min.js?v=3.1"></script>
    <script type="text/javascript" src="/js/jquery.notyfy.js"></script>
    <script type="text/javascript" src="/js/iscroll.js"></script>
    <script src="http://js.passport.qihucdn.com/5.0.3.js"></script>
    <script type="text/javascript">
        var myScroll, myNavScroll;

        function iscrollLoaded() {
            myScroll = new IScroll('#wrapper',
                {
                    scrollX: true,
                    scrollY: false,
                    bounceEasing: 'circular',
                    eventPassthrough: true,
                    preventDefault: false,
                    bounceTime: 500
                }
            );
        }

        $(function () {

            //导航横向滚动


            function setNavWidth() {

                /* 计算导航宽度 */
                var allWidth = $(window).width();
                var scroller = $('#scroller');

                if (allWidth > 900) {
                    scroller.find('ul').add(scroller.find('.scroll')).removeAttr('style');
                    scroller.css('overflow', 'visible');
                    if (myNavScroll) myNavScroll.destroy();
                } else {

                    var width = 0;
                    scroller.find('.scroll').children('ul').children('li').each(function (index, el) {
                        if (!$(this).hasClass('mobile-hide')) {
                            width += $(this).outerWidth();
                        }
                    });
                    scroller.find('ul').add(scroller.find('.scroll')).width(width);

                    if (myNavScroll) myNavScroll.destroy();

                    myNavScroll = new IScroll('#scroller', {
                        scrollX: true,
                        scrollY: false,
                        momentum: false,
                        click: true
                    });

                }

            }

            setNavWidth();
            $(window).resize(function (event) {
                setNavWidth();
            });

        });

    </script>
</head>
<body onload="iscrollLoaded();">
<div style='margin:0 auto;width:0px;height:0px;overflow:hidden;'>
    <img src=""/>
</div>

<div id="is-mobile"></div>
<div class="container">
        <div class="mobile-header">
        <div class="header clearfix">
            <div class="header-wrapper clearfix">
                <a href="/index/index" class="logo"><img class="slogan" src="/img/logo.png?v=1.5"/></a>
                                <form id="search" class="search-box" action="/search/index" method="GET">
                    <input class="keys" name="keywords" type="text" placeholder="搜索漏洞" required="required">
                    <input class="icon" type="submit" value="">
                    <input type="hidden" name="type" value=""/>
                </form>
                <div class="bug">
                    <div class="name"><span class="seled">全部</span><i class="arrow"></i></div>
                    <ul class="typelist">
                        <li data-index="3"><a href="javascript:void(0);">全部</a></li>
                        <li data-index="0"><a href="javascript:void(0);">漏洞</a></li>
                        <li data-index="1"><a href="javascript:void(0);">资讯</a></li>
                        <li data-index="2"><a href="javascript:void(0);">知识</a></li>
                    </ul>
                </div>
                                <div class="logNreg mobile-hide">
                    <div class="unlog">
                        <i></i>
                        <a href="log.html" class="log">登录</a>
                        <span>|</span>
                        <a href="reg.html" class="reg">注册</a>
                    </div>
                    <div class="loged">
                        <a href="/member/profile" class="user-center"><i></i><span class="user-name-tag">个人中心</span></a>
                        <div class="user-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting"><a href="http://i.360.cn/profile/accountmanage"
                                                               target="_blank"><i></i><span>账号设置</span></a></li>
                                <li class="alert-setting"><a href="/keywords/index"
                                                             target="_blank"><i></i><span>告警设置</span></a></li>
                                <li class="bug-alert"><a href="/myalarm/index" target="_blank"><i></i><span>漏洞告警</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mylearn/index" target="_blank"><i></i><span>我的知识</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mycourse/index" target="_blank"><i></i><span>我的课堂</span></a>
                                </li>
                                <li class="my-exit"><a
                                            href="http://login.360.cn/?src=pcw_adlab&op=logout&destUrl=http://bobao.360.cn"><i></i><span>退出系统</span></a>
                                </li>
                            </ul>
                        </div>

                        <a href="/message" class="message-center" target="_blank"><i></i><span>我的消息</span></a>
                        <div class="message-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting" style="display:none;"><a href="/myres/index"
                                                                                     target="_blank"><i></i><span>回复我的</span></a>
                                </li>
                                <li class="my-bug"><a href="/myvul/index"
                                                      target="_blank"><i></i><span>我的漏洞</span></a></li>
                                <!--<li class="my-bug"><a href="/myres/index" target="_blank"><i></i><span>我的评论</span></a></li>-->
                                <!--<li class="alert-setting"><a href="###" target="_blank"><i></i><span>提到我的</span></a>
                                </li>-->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <style type="text/css">
            .nav {
                overflow: hidden;
            }

            .nav .scroll {
                width: auto;
            }
        </style>
        <div id="wrapper">
            <div id="scroller" class="nav">
                <div class="scroll">
                    <ul class="nav-list">
                        <li ><a class="link-nav"
                                                                                 href="/index/index">首页</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/vul/index">漏洞</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/introduce/list">招聘</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/news/index">资讯</a><!--<i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/introduce/list">招聘</a></li>
                        </ul>
			-->
                        </li>
                        <li class="cur">
                        <a class="link-nav" href="/learning/index">知识</a><i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/course/index">学院</a></li>
                        </ul>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/activity/index">活动</a></li>
                        <li class="mobile-hide "><a class="link-nav"
                                                                                                   href="/ctf/index">CTF训练营</a>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/interref/list">安全内参</a></li>
                        <li ><a class="link-nav" href="/app/index">APP</a></li>

                        <!--<li ><a href="/course/index">学院</a></li>-->
                        <!--<li ><a href="/introduce/list">招聘</a></li>-->
                        <!--<li  class="mobile-hide"><a href="/ctf/index">CTF训练营</a></li>-->
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="mobile-content">
        <link rel="stylesheet" type="text/css" href="/css/news.css?v=3.5" />
<link rel="stylesheet" type="text/css" href="/ue/SyntaxHighlighter/shCoreDefault.css?v=1.0" />
<style>
    p .syntaxhighlighter {
        width: 80%;
    }
</style>

<div class="cur-pos w1000">当前位置：<a href="http://bobao.360.cn/">安全客</a> &gt;&gt; 知识详情</div>

<div class="content clearfix">
    <div class="main">
        <div class="article">
            <div id="article_box">
                <h2>【漏洞分析】MS 17-010：NSA Eternalblue SMB 漏洞分析</h2>
                <div class="article-msg">
                    <span class="time">2017-04-17 18:27:16</span>
                    
                                        <span class="read">阅读：75236次</span>
                    <span><a style="display: none;" class="good" href="javascript:;"
                             data-target="/learning/good" data-value="g_3738"
                             data-type="learning">点赞(0)</a></span>
                    <span><a class="fav" href="javascript:;" data-target="/mylearning/add"
                             data-pk="3738" data-type="learning">收藏</a></span>
                                        <span><a style="margin-left: 4px;" class="fav" href="http://blogs.360.cn/360safe/2017/04/17/nsa-eternalblue-smb/"
                             target="_blank">来源： 360安全卫士技术博客</a></span>
                    
                    
                    <div style="margin-top:10px; ">
                        <a href="/member/contribute?uid=2515404167" style="color:#848e99;">
                            <img src="http://p1.qhmsg.com/dm/150_150_100/t01cc856584b7ed76c0.jpg" data-is-avatar="true"
                                 style="border: 1px solid #d5d5d5;padding: 2px; width: 80px;height: 80px;border-radius: 43px;"/>
                        </a>

                    </div>
                    <span class="orig">作者：<a href="/member/contribute?uid=2515404167" style="color:#848e99;">360安全卫士</a></span>
                                    </div>
                <hr size="1">
                <div class="article-msg">
                    <p><!-- JiaThis Button BEGIN -->

<!--
<span class="jiathis_style"><span class="jiathis_txt">分享到：</span>
	<a class="jiathis_button_weixin"></a>
	<a class="jiathis_button_tsina"></a>
    <a class="jiathis_button_tqq"></a>
    <a class="jiathis_button_qzone"></a>
    <a class="jiathis_button_renren"></a>
    <a class="jiathis_button_xiaoyou"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
</span>

-->
</p>
                </div>
                <p><p style="text-align: center; text-indent: 0em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px;"><strong><img src="http://p7.qhimg.com/t010c3c599c5bc305ea.png" alt="http://p6.qhimg.com/t01b77bc14774cc38ab.png"/></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px;"><strong>环境</strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">EXPLOIT:</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Eternalblue-2.2.0.exe</span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">TARGET:</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">win7 sp1 32bits</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">srv.sys 6.1.7601.17514</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">srvnet.sys 6.1.7601.17514</span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">PATCH:</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">MS17-010</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">漏洞原理</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">srv.sys在处理SrvOs2FeaListSizeToNt的时候逻辑不正确导致越界拷贝。我们首先看下漏洞的触发点：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:plain;toolbar:false">unsigned&nbsp;int&nbsp;__fastcall&nbsp;SrvOs2FeaToNt(int&nbsp;a1,&nbsp;int&nbsp;a2)
{
&nbsp;&nbsp;int&nbsp;v4;&nbsp;//&nbsp;edi@1
&nbsp;&nbsp;_BYTE&nbsp;*v5;&nbsp;//&nbsp;edi@1
&nbsp;&nbsp;unsigned&nbsp;int&nbsp;result;&nbsp;//&nbsp;eax@1
&nbsp;&nbsp;v4&nbsp;=&nbsp;a1&nbsp;+&nbsp;8;
&nbsp;&nbsp;*(_BYTE&nbsp;*)(a1&nbsp;+&nbsp;4)&nbsp;=&nbsp;*(_BYTE&nbsp;*)a2;
&nbsp;&nbsp;*(_BYTE&nbsp;*)(a1&nbsp;+&nbsp;5)&nbsp;=&nbsp;*(_BYTE&nbsp;*)(a2&nbsp;+&nbsp;1);
&nbsp;&nbsp;*(_WORD&nbsp;*)(a1&nbsp;+&nbsp;6)&nbsp;=&nbsp;*(_WORD&nbsp;*)(a2&nbsp;+&nbsp;2);
&nbsp;&nbsp;_memmove((void&nbsp;*)(a1&nbsp;+&nbsp;8),&nbsp;(const&nbsp;void&nbsp;*)(a2&nbsp;+&nbsp;4),&nbsp;*(_BYTE&nbsp;*)(a2&nbsp;+&nbsp;1));
&nbsp;&nbsp;v5&nbsp;=&nbsp;(_BYTE&nbsp;*)(*(_BYTE&nbsp;*)(a1&nbsp;+&nbsp;5)&nbsp;+&nbsp;v4);
&nbsp;&nbsp;*v5++&nbsp;=&nbsp;0;
&nbsp;&nbsp;_memmove(v5,&nbsp;(const&nbsp;void&nbsp;*)(a2&nbsp;+&nbsp;5&nbsp;+&nbsp;*(_BYTE&nbsp;*)(a1&nbsp;+&nbsp;5)),&nbsp;*(_WORD&nbsp;*)(a1&nbsp;+&nbsp;6));&nbsp;//这里产生的越界覆盖
&nbsp;&nbsp;result&nbsp;=&nbsp;(unsigned&nbsp;int)&amp;v5[*(_WORD&nbsp;*)(a1&nbsp;+&nbsp;6)&nbsp;+&nbsp;3]&nbsp;&amp;&nbsp;0xFFFFFFFC;
&nbsp;&nbsp;*(_DWORD&nbsp;*)a1&nbsp;=&nbsp;result&nbsp;-&nbsp;a1;
&nbsp;&nbsp;return&nbsp;result;
}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">发生越界的地方见上面第二个memmove。调试的时候可以这样下断点：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:plain;toolbar:false">kd&gt;&nbsp;u&nbsp;srv!SrvOs2FeaToNt+0x4d
srv!SrvOs2FeaToNt+0x4d:
9877b278&nbsp;ff15e0a07698&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[srv!_imp__memmove&nbsp;(9876a0e0)]
9877b27e&nbsp;0fb74606&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;movzx&nbsp;&nbsp;&nbsp;eax,word&nbsp;ptr&nbsp;[esi+6]
9877b282&nbsp;8d441803&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lea&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,[eax+ebx+3]
9877b286&nbsp;83e0fc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,0FFFFFFFCh
9877b289&nbsp;83c418&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;esp,18h
9877b28c&nbsp;8bc8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ecx,eax
9877b28e&nbsp;2bce&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sub&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ecx,esi
9877b290&nbsp;5f&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pop&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;edi
//最后一次越界的拷贝的长度是0xa8
ba&nbsp;e1&nbsp;srv!SrvOs2FeaToNt+0x4d&nbsp;&quot;.if(poi(esp+8)&nbsp;!=&nbsp;a8){gc}&nbsp;.else&nbsp;{}&quot;</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">这么设断点的原因是最后一次越界的拷贝的长度是0xa8,断下来后可以发现：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:plain;toolbar:false">kd&gt;&nbsp;dd&nbsp;esp
99803b38&nbsp;&nbsp;88c8dff9&nbsp;a3fc203a&nbsp;000000a8&nbsp;88c8dff8
99803b48&nbsp;&nbsp;a3fc2039&nbsp;00000000&nbsp;a3fb20d8&nbsp;a3fc2035
99803b58&nbsp;&nbsp;a3fd2030&nbsp;99803b7c&nbsp;9877b603&nbsp;88c8dff0
99803b68&nbsp;&nbsp;a3fc2035&nbsp;88307360&nbsp;a3fb20b4&nbsp;a3fb2008
99803b78&nbsp;&nbsp;a3fc2035&nbsp;99803bb4&nbsp;98794602&nbsp;88c8dff0
99803b88&nbsp;&nbsp;99803bbc&nbsp;99803ba8&nbsp;99803bac&nbsp;88307360
99803b98&nbsp;&nbsp;a3fb2008&nbsp;00000002&nbsp;a3fb20b4&nbsp;a3fb20d8
99803ba8&nbsp;&nbsp;00010fe8&nbsp;00000000&nbsp;00000000&nbsp;99803c00
kd&gt;&nbsp;!pool&nbsp;88c8dff9&nbsp;
Pool&nbsp;page&nbsp;88c8dff9&nbsp;region&nbsp;is&nbsp;Nonpaged&nbsp;pool
*88c7d000&nbsp;:&nbsp;large&nbsp;page&nbsp;allocation,&nbsp;tag&nbsp;is&nbsp;LSdb,&nbsp;size&nbsp;is&nbsp;0x11000&nbsp;bytes
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Pooltag&nbsp;LSdb&nbsp;:&nbsp;SMB1&nbsp;data&nbsp;buffer,&nbsp;Binary&nbsp;:&nbsp;srv.sys
kd&gt;&nbsp;!pool&nbsp;88c8e009&nbsp;
Pool&nbsp;page&nbsp;88c8e009&nbsp;region&nbsp;is&nbsp;Nonpaged&nbsp;pool
&nbsp;88c8e000&nbsp;size:&nbsp;&nbsp;&nbsp;&nbsp;8&nbsp;previous&nbsp;size:&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;(Free)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;....
88c8e008&nbsp;doesn&#39;t&nbsp;look&nbsp;like&nbsp;a&nbsp;valid&nbsp;small&nbsp;pool&nbsp;allocation,&nbsp;checking&nbsp;to&nbsp;see
if&nbsp;the&nbsp;entire&nbsp;page&nbsp;is&nbsp;actually&nbsp;part&nbsp;of&nbsp;a&nbsp;large&nbsp;page&nbsp;allocation...
*88c8e000&nbsp;:&nbsp;large&nbsp;page&nbsp;allocation,&nbsp;tag&nbsp;is&nbsp;LSbf,&nbsp;size&nbsp;is&nbsp;0x11000&nbsp;bytes
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Pooltag&nbsp;LSbf&nbsp;:&nbsp;SMB1&nbsp;buffer&nbsp;descriptor&nbsp;or&nbsp;srvnet&nbsp;allocation,&nbsp;Binary&nbsp;:&nbsp;srvnet.sys
kd&gt;&nbsp;?&nbsp;88c7d000&nbsp;+11000
Evaluate&nbsp;expression:&nbsp;-2000101376&nbsp;=&nbsp;88c8e000
kd&gt;&nbsp;?&nbsp;88c8dff9&nbsp;+a8
Evaluate&nbsp;expression:&nbsp;-2000101215&nbsp;=&nbsp;88c8e0a1&nbsp;//这里明显越界了。</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">我们可以从上面的调试记录看到明显的越写拷贝操作。可以看到被覆盖的是SMB1的buffer是有srvnet.sys分配的。这里exploit精心布局好的，是通过pool喷射的将两个pool连接在一起的。覆盖后面的这个pool有啥用后面会提到。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">有同学会说”这只是现象,漏洞真正的成因在哪里呢？”。往下看：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:plain;toolbar:false">unsigned&nbsp;int&nbsp;__fastcall&nbsp;SrvOs2FeaListSizeToNt(int&nbsp;pOs2Fea)
{
&nbsp;&nbsp;unsigned&nbsp;int&nbsp;v1;&nbsp;//&nbsp;edi@1
&nbsp;&nbsp;int&nbsp;Length;&nbsp;//&nbsp;ebx@1
&nbsp;&nbsp;int&nbsp;pBody;&nbsp;//&nbsp;esi@1
&nbsp;&nbsp;unsigned&nbsp;int&nbsp;v4;&nbsp;//&nbsp;ebx@1
&nbsp;&nbsp;int&nbsp;v5;&nbsp;//&nbsp;ecx@3
&nbsp;&nbsp;int&nbsp;v8;&nbsp;//&nbsp;[sp+10h]&nbsp;[bp-8h]@3
&nbsp;&nbsp;unsigned&nbsp;int&nbsp;v9;&nbsp;//&nbsp;[sp+14h]&nbsp;[bp-4h]@1
&nbsp;&nbsp;v1&nbsp;=&nbsp;0;
&nbsp;&nbsp;Length&nbsp;=&nbsp;*(_DWORD&nbsp;*)pOs2Fea;
&nbsp;&nbsp;pBody&nbsp;=&nbsp;pOs2Fea&nbsp;+&nbsp;4;
&nbsp;&nbsp;v9&nbsp;=&nbsp;0;
&nbsp;&nbsp;v4&nbsp;=&nbsp;pOs2Fea&nbsp;+&nbsp;Length;
&nbsp;&nbsp;while&nbsp;(&nbsp;pBody&nbsp;&lt;&nbsp;v4&nbsp;)
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;pBody&nbsp;+&nbsp;4&nbsp;&gt;=&nbsp;v4
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;||&nbsp;(v5&nbsp;=&nbsp;*(_BYTE&nbsp;*)(pBody&nbsp;+&nbsp;1)&nbsp;+&nbsp;*(_WORD&nbsp;*)(pBody&nbsp;+&nbsp;2),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v8&nbsp;=&nbsp;*(_BYTE&nbsp;*)(pBody&nbsp;+&nbsp;1)&nbsp;+&nbsp;*(_WORD&nbsp;*)(pBody&nbsp;+&nbsp;2),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v5&nbsp;+&nbsp;pBody&nbsp;+&nbsp;5&nbsp;&gt;&nbsp;v4)&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;注意这里修改了Os2Fea的Length，自动适应大小
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;初始值是0x10000,最终变成了0x1ff5d
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*(_WORD&nbsp;*)pOs2Fea&nbsp;=&nbsp;pBody&nbsp;-&nbsp;pOs2Fea;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;v1;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;RtlULongAdd(v1,&nbsp;(v5&nbsp;+&nbsp;0xC)&nbsp;&amp;&nbsp;0xFFFFFFFC,&nbsp;&amp;v9)&nbsp;&lt;&nbsp;0&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0;
&nbsp;&nbsp;&nbsp;&nbsp;v1&nbsp;=&nbsp;v9;
&nbsp;&nbsp;&nbsp;&nbsp;pBody&nbsp;+=&nbsp;v8&nbsp;+&nbsp;5;
&nbsp;&nbsp;}
&nbsp;&nbsp;return&nbsp;v1;
}
unsigned&nbsp;int&nbsp;__fastcall&nbsp;SrvOs2FeaListToNt(int&nbsp;pOs2Fea,&nbsp;int&nbsp;*pArgNtFea,&nbsp;int&nbsp;*a3,&nbsp;_WORD&nbsp;*a4)
{
&nbsp;&nbsp;__int16&nbsp;v5;&nbsp;//&nbsp;bx@1
&nbsp;&nbsp;unsigned&nbsp;int&nbsp;Size;&nbsp;//&nbsp;eax@1
&nbsp;&nbsp;NTFEA&nbsp;*pNtFea;&nbsp;//&nbsp;ecx@3
&nbsp;&nbsp;int&nbsp;pOs2FeaBody;&nbsp;//&nbsp;esi@9
&nbsp;&nbsp;int&nbsp;v10;&nbsp;//&nbsp;edx@9
&nbsp;&nbsp;unsigned&nbsp;int&nbsp;v11;&nbsp;//&nbsp;esi@14
&nbsp;&nbsp;int&nbsp;v12;&nbsp;//&nbsp;[sp+Ch]&nbsp;[bp-Ch]@11
&nbsp;&nbsp;unsigned&nbsp;int&nbsp;v14;&nbsp;//&nbsp;[sp+20h]&nbsp;[bp+8h]@9
&nbsp;&nbsp;v5&nbsp;=&nbsp;0;
&nbsp;&nbsp;Size&nbsp;=&nbsp;SrvOs2FeaListSizeToNt(pOs2Fea);
&nbsp;&nbsp;*a3&nbsp;=&nbsp;Size;
&nbsp;&nbsp;if&nbsp;(&nbsp;!Size&nbsp;)
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;*a4&nbsp;=&nbsp;0;
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0xC098F0FF;
&nbsp;&nbsp;}
&nbsp;&nbsp;pNtFea&nbsp;=&nbsp;(NTFEA&nbsp;*)SrvAllocateNonPagedPool(Size,&nbsp;0x15);
&nbsp;&nbsp;*pArgNtFea&nbsp;=&nbsp;(int)pNtFea;
&nbsp;&nbsp;if&nbsp;(&nbsp;pNtFea&nbsp;)
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;pOs2FeaBody&nbsp;=&nbsp;pOs2Fea&nbsp;+&nbsp;4;
&nbsp;&nbsp;&nbsp;&nbsp;v10&nbsp;=&nbsp;(int)pNtFea;
&nbsp;&nbsp;&nbsp;&nbsp;v14&nbsp;=&nbsp;pOs2Fea&nbsp;+&nbsp;*(_DWORD&nbsp;*)pOs2Fea&nbsp;-&nbsp;5;
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;pOs2Fea&nbsp;+&nbsp;4&nbsp;&gt;&nbsp;v14&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;{
LABEL_13:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;pOs2FeaBody&nbsp;==&nbsp;pOs2Fea&nbsp;+&nbsp;*(_DWORD&nbsp;*)pOs2Fea&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*(_DWORD&nbsp;*)v10&nbsp;=&nbsp;0;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v11&nbsp;=&nbsp;0xC0000001;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*a4&nbsp;=&nbsp;v5&nbsp;-&nbsp;pOs2Fea;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;else
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;(&nbsp;!(*(_BYTE&nbsp;*)pOs2FeaBody&nbsp;&amp;&nbsp;0x7F)&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v12&nbsp;=&nbsp;(int)pNtFea;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v5&nbsp;=&nbsp;pOs2FeaBody;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pNtFea&nbsp;=&nbsp;(NTFEA&nbsp;*)SrvOs2FeaToNt(pNtFea,&nbsp;pOs2FeaBody);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pOs2FeaBody&nbsp;+=&nbsp;*(_BYTE&nbsp;*)(pOs2FeaBody&nbsp;+&nbsp;1)&nbsp;+&nbsp;*(_WORD&nbsp;*)(pOs2FeaBody&nbsp;+&nbsp;2)&nbsp;+&nbsp;5;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;由于SrvOs2FeaListSizeToNt将pOs2Fea的Length改大了。
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;而且变得大了不少，所以这里的判读就没有什么意义了。最终导致越界的产生。
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;pOs2FeaBody&nbsp;&gt;&nbsp;v14&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v10&nbsp;=&nbsp;v12;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto&nbsp;LABEL_13;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*a4&nbsp;=&nbsp;pOs2FeaBody&nbsp;-&nbsp;pOs2Fea;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v11&nbsp;=&nbsp;0xC000000D;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;SrvFreeNonPagedPool(*pArgNtFea);
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;v11;
&nbsp;&nbsp;}
&nbsp;&nbsp;if&nbsp;(&nbsp;BYTE1(WPP_GLOBAL_Control-&gt;Flags)&nbsp;&gt;=&nbsp;2u&nbsp;&amp;&amp;&nbsp;WPP_GLOBAL_Control-&gt;Characteristics&nbsp;&amp;&nbsp;1&nbsp;&amp;&amp;&nbsp;KeGetCurrentIrql()&nbsp;&lt;&nbsp;2u&nbsp;)
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;_DbgPrint(&quot;SrvOs2FeaListToNt:&nbsp;Unable&nbsp;to&nbsp;allocate&nbsp;%d&nbsp;bytes&nbsp;from&nbsp;nonpaged&nbsp;pool.&quot;,&nbsp;*a3,&nbsp;0);
&nbsp;&nbsp;&nbsp;&nbsp;_DbgPrint(&quot;\n&quot;);
&nbsp;&nbsp;}
&nbsp;&nbsp;return&nbsp;0xC0000205;
}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">首先SrvOs2FeaListToNt首先调用SrvOs2FeaListSizeToNt计算pNtFea的大小。这里注意了SrvOs2FeaListSizeToNt函数会修改原始的pOs2Fea中的Length大小,然后以计算出来的Length来分配pNtFea.最后调用SrvOs2FeaToNt来实现转换。SrvOs2FeaToNt后面的判断就有问题了。这里还不止一个问题。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">1. 转换完成后，增加pOs2FeaBody然后比较。正确的逻辑难道不应该是先判断再转换吗？</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">2. 由于SrvOs2FeaListSizeToNt中改变了pOs2Fea的length的值，这里使用变大后的值做比较，肯定会越界。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">为了方便同学们调试，我把代码扣出来了。大家可以在环3围观下这段代码。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:plain;toolbar:false">#include&nbsp;&lt;windows.h&gt;
signed&nbsp;int&nbsp;RtlULongAdd(unsigned&nbsp;int&nbsp;a1,&nbsp;int&nbsp;a2,&nbsp;unsigned&nbsp;int&nbsp;*a3)
{
&nbsp;&nbsp;&nbsp;&nbsp;unsigned&nbsp;int&nbsp;v3;&nbsp;//&nbsp;edx@1
&nbsp;&nbsp;&nbsp;&nbsp;signed&nbsp;int&nbsp;result;&nbsp;//&nbsp;eax@2
&nbsp;&nbsp;&nbsp;&nbsp;v3&nbsp;=&nbsp;a1&nbsp;+&nbsp;a2;
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(v3&nbsp;&lt;&nbsp;a1)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*a3&nbsp;=&nbsp;-1;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;=&nbsp;-1073741675;
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*a3&nbsp;=&nbsp;v3;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;=&nbsp;0;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;result;
}
unsigned&nbsp;int&nbsp;SrvOs2FeaListSizeToNt(PUCHAR&nbsp;pOs2Fea)
{
&nbsp;&nbsp;&nbsp;&nbsp;unsigned&nbsp;int&nbsp;v1;&nbsp;//&nbsp;edi@1
&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;Length;&nbsp;//&nbsp;ebx@1
&nbsp;&nbsp;&nbsp;&nbsp;PUCHAR&nbsp;pBody;&nbsp;//&nbsp;esi@1
&nbsp;&nbsp;&nbsp;&nbsp;PUCHAR&nbsp;v4;&nbsp;//&nbsp;ebx@1
&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;v5;&nbsp;//&nbsp;ecx@3
&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;v8;&nbsp;//&nbsp;[sp+10h]&nbsp;[bp-8h]@3
&nbsp;&nbsp;&nbsp;&nbsp;unsigned&nbsp;int&nbsp;v9;&nbsp;//&nbsp;[sp+14h]&nbsp;[bp-4h]@1
&nbsp;&nbsp;&nbsp;&nbsp;v1&nbsp;=&nbsp;0;
&nbsp;&nbsp;&nbsp;&nbsp;Length&nbsp;=&nbsp;*(DWORD*)pOs2Fea;
&nbsp;&nbsp;&nbsp;&nbsp;pBody&nbsp;=&nbsp;pOs2Fea&nbsp;+&nbsp;4;
&nbsp;&nbsp;&nbsp;&nbsp;v9&nbsp;=&nbsp;0;
&nbsp;&nbsp;&nbsp;&nbsp;v4&nbsp;=&nbsp;pOs2Fea&nbsp;+&nbsp;Length;
&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;(pBody&nbsp;&lt;&nbsp;v4)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(pBody&nbsp;+&nbsp;4&nbsp;&gt;=&nbsp;v4
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;||&nbsp;(v5&nbsp;=&nbsp;*(BYTE&nbsp;*)(pBody&nbsp;+&nbsp;1)&nbsp;+&nbsp;*(WORD&nbsp;*)(pBody&nbsp;+&nbsp;2),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v8&nbsp;=&nbsp;*(BYTE&nbsp;*)(pBody&nbsp;+&nbsp;1)&nbsp;+&nbsp;*(WORD&nbsp;*)(pBody&nbsp;+&nbsp;2),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v5&nbsp;+&nbsp;pBody&nbsp;+&nbsp;5&nbsp;&gt;&nbsp;v4))
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*(WORD&nbsp;*)pOs2Fea&nbsp;=&nbsp;pBody&nbsp;-&nbsp;pOs2Fea;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;v1;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(RtlULongAdd(v1,&nbsp;(v5&nbsp;+&nbsp;0xC)&nbsp;&amp;&nbsp;0xFFFFFFFC,&nbsp;&amp;v9)&nbsp;&lt;&nbsp;0)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v1&nbsp;=&nbsp;v9;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pBody&nbsp;+=&nbsp;v8&nbsp;+&nbsp;5;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;v1;
}
PUCHAR&nbsp;gpBuffer&nbsp;=&nbsp;NULL;
ULONG&nbsp;guSize&nbsp;=&nbsp;0;
PUCHAR&nbsp;SrvOs2FeaToNt(PUCHAR&nbsp;pNtFea,&nbsp;PUCHAR&nbsp;pOs2FeaBody)
{
&nbsp;&nbsp;&nbsp;&nbsp;PUCHAR&nbsp;pBody;&nbsp;//&nbsp;edi@1
&nbsp;&nbsp;&nbsp;&nbsp;BYTE&nbsp;*pNtBodyStart;&nbsp;//&nbsp;edi@1
&nbsp;&nbsp;&nbsp;&nbsp;PUCHAR&nbsp;result;&nbsp;//&nbsp;eax@1
&nbsp;&nbsp;&nbsp;&nbsp;pBody&nbsp;=&nbsp;pNtFea&nbsp;+&nbsp;8;
&nbsp;&nbsp;&nbsp;&nbsp;*(BYTE&nbsp;*)(pNtFea&nbsp;+&nbsp;4)&nbsp;=&nbsp;*(BYTE&nbsp;*)pOs2FeaBody;
&nbsp;&nbsp;&nbsp;&nbsp;*(BYTE&nbsp;*)(pNtFea&nbsp;+&nbsp;5)&nbsp;=&nbsp;*(BYTE&nbsp;*)(pOs2FeaBody&nbsp;+&nbsp;1);
&nbsp;&nbsp;&nbsp;&nbsp;*(WORD&nbsp;*)(pNtFea&nbsp;+&nbsp;6)&nbsp;=&nbsp;*(WORD&nbsp;*)(pOs2FeaBody&nbsp;+&nbsp;2);
&nbsp;&nbsp;&nbsp;&nbsp;memcpy((void&nbsp;*)(pNtFea&nbsp;+&nbsp;8),&nbsp;(const&nbsp;void&nbsp;*)(pOs2FeaBody&nbsp;+&nbsp;4),&nbsp;*(BYTE&nbsp;*)(pOs2FeaBody&nbsp;+&nbsp;1));
&nbsp;&nbsp;&nbsp;&nbsp;pNtBodyStart&nbsp;=&nbsp;(BYTE&nbsp;*)(*(BYTE&nbsp;*)(pNtFea&nbsp;+&nbsp;5)&nbsp;+&nbsp;pBody);
&nbsp;&nbsp;&nbsp;&nbsp;*pNtBodyStart++&nbsp;=&nbsp;0;
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;((pNtBodyStart&nbsp;+&nbsp;*(WORD&nbsp;*)(pNtFea&nbsp;+&nbsp;6))&nbsp;&gt;&nbsp;(gpBuffer&nbsp;+&nbsp;guSize)){
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__debugbreak();
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;memcpy(pNtBodyStart,&nbsp;(const&nbsp;void&nbsp;*)(pOs2FeaBody&nbsp;+&nbsp;5&nbsp;+&nbsp;*(BYTE&nbsp;*)(pNtFea&nbsp;+&nbsp;5)),&nbsp;*(WORD&nbsp;*)(pNtFea&nbsp;+&nbsp;6));
&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;=&nbsp;(PUCHAR)((ULONG_PTR)&amp;pNtBodyStart[*(WORD&nbsp;*)(pNtFea&nbsp;+&nbsp;6)&nbsp;+&nbsp;3]&nbsp;&amp;&nbsp;0xFFFFFFFC);
&nbsp;&nbsp;&nbsp;&nbsp;*(DWORD&nbsp;*)pNtFea&nbsp;=&nbsp;result&nbsp;-&nbsp;pNtFea;
&nbsp;&nbsp;&nbsp;&nbsp;static&nbsp;int&nbsp;j&nbsp;=&nbsp;0;
&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;j=%d\n&quot;,&nbsp;j++);
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;result;
}
int&nbsp;main()
{
&nbsp;&nbsp;&nbsp;&nbsp;FILE*&nbsp;pFile&nbsp;=&nbsp;fopen(&quot;1.bin&quot;,&nbsp;&quot;r+b&quot;);
&nbsp;&nbsp;&nbsp;&nbsp;fseek(pFile,&nbsp;0,&nbsp;SEEK_END);
&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;uSize&nbsp;=&nbsp;(ULONG)ftell(pFile);
&nbsp;&nbsp;&nbsp;&nbsp;fseek(pFile,&nbsp;0,&nbsp;SEEK_SET);
&nbsp;&nbsp;&nbsp;&nbsp;PUCHAR&nbsp;pOs2Fea&nbsp;=&nbsp;(PUCHAR)malloc(uSize);
&nbsp;&nbsp;&nbsp;&nbsp;fread(pOs2Fea,&nbsp;1,&nbsp;uSize,&nbsp;pFile);
&nbsp;&nbsp;&nbsp;&nbsp;fclose(pFile);
&nbsp;&nbsp;&nbsp;&nbsp;ULONG&nbsp;uFixSize&nbsp;=&nbsp;SrvOs2FeaListSizeToNt(pOs2Fea);
&nbsp;&nbsp;&nbsp;&nbsp;PUCHAR&nbsp;pOs2FeaBody;
&nbsp;&nbsp;&nbsp;&nbsp;PUCHAR&nbsp;&nbsp;pNtFea&nbsp;=&nbsp;(PUCHAR)malloc(uFixSize);
&nbsp;&nbsp;&nbsp;&nbsp;PUCHAR&nbsp;v10;
&nbsp;&nbsp;&nbsp;&nbsp;PUCHAR&nbsp;v14;
&nbsp;&nbsp;&nbsp;&nbsp;PUCHAR&nbsp;v12;
&nbsp;&nbsp;&nbsp;&nbsp;PUCHAR&nbsp;v5;
&nbsp;&nbsp;&nbsp;&nbsp;LONG&nbsp;v11;
&nbsp;&nbsp;&nbsp;&nbsp;PUCHAR&nbsp;&nbsp;pNtFeaEnd&nbsp;=&nbsp;pNtFea&nbsp;+&nbsp;uFixSize;
&nbsp;&nbsp;&nbsp;&nbsp;gpBuffer&nbsp;=&nbsp;pNtFea;
&nbsp;&nbsp;&nbsp;&nbsp;guSize&nbsp;=&nbsp;uFixSize;
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(pNtFea)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pOs2FeaBody&nbsp;=&nbsp;pOs2Fea&nbsp;+&nbsp;4;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v10&nbsp;=&nbsp;pNtFea;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v14&nbsp;=&nbsp;pOs2Fea&nbsp;+&nbsp;*(DWORD&nbsp;*)pOs2Fea&nbsp;-&nbsp;5;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(pOs2Fea&nbsp;+&nbsp;4&nbsp;&gt;&nbsp;v14)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LABEL_13:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(pOs2FeaBody&nbsp;==&nbsp;pOs2Fea&nbsp;+&nbsp;*(DWORD&nbsp;*)pOs2Fea)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*(DWORD&nbsp;*)v10&nbsp;=&nbsp;0;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v11&nbsp;=&nbsp;0xC0000001;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//*a4&nbsp;=&nbsp;v5&nbsp;-&nbsp;pOs2Fea;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;(!(*(BYTE&nbsp;*)pOs2FeaBody&nbsp;&amp;&nbsp;0x7F))
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v12&nbsp;=&nbsp;pNtFea;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v5&nbsp;=&nbsp;pOs2FeaBody;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pNtFea&nbsp;=&nbsp;SrvOs2FeaToNt(pNtFea,&nbsp;pOs2FeaBody);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pOs2FeaBody&nbsp;+=&nbsp;*(BYTE&nbsp;*)(pOs2FeaBody&nbsp;+&nbsp;1)&nbsp;+&nbsp;*(WORD&nbsp;*)(pOs2FeaBody&nbsp;+&nbsp;2)&nbsp;+&nbsp;5;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(pOs2FeaBody&nbsp;&gt;&nbsp;v14)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v10&nbsp;=&nbsp;v12;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto&nbsp;LABEL_13;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//*a4&nbsp;=&nbsp;pOs2FeaBody&nbsp;-&nbsp;pOs2Fea;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v11&nbsp;=&nbsp;0xC000000D;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;v11;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0;
}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">看到我加了个__debugbreak的地方，断在那里就说明溢出了</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">1.bin的内容最后我会给大家带上。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">大家也可以自己抓1.bin的内容，方法如下：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:plain;toolbar:false">kd&gt;&nbsp;u&nbsp;SrvOs2FeaListToNt
srv!SrvOs2FeaListToNt:
9877b565&nbsp;8bff&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;edi,edi
9877b567&nbsp;55&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;ebp
9877b568&nbsp;8bec&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ebp,esp
9877b56a&nbsp;51&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;ecx
9877b56b&nbsp;8365fc00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[ebp-4],0
9877b56f&nbsp;56&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;esi
9877b570&nbsp;57&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;edi
9877b571&nbsp;8b7d08&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;edi,dword&nbsp;ptr&nbsp;[ebp+8]
9877b574&nbsp;57&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;edi
9877b575&nbsp;e82effffff&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;&nbsp;srv!SrvOs2FeaListSizeToNt&nbsp;(9877b4a8)
kd&gt;&nbsp;ba&nbsp;e1&nbsp;9877b575
kd&gt;&nbsp;g
Breakpoint&nbsp;0&nbsp;hit
srv!SrvOs2FeaListToNt+0x10:
9877b575&nbsp;e82effffff&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;&nbsp;srv!SrvOs2FeaListSizeToNt&nbsp;(9877b4a8)
kd&gt;&nbsp;!pool&nbsp;edi
Pool&nbsp;page&nbsp;a3fd10d8&nbsp;region&nbsp;is&nbsp;Paged&nbsp;pool
*a3fd1000&nbsp;:&nbsp;large&nbsp;page&nbsp;allocation,&nbsp;tag&nbsp;is&nbsp;LStr,&nbsp;size&nbsp;is&nbsp;0x11000&nbsp;bytes
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Pooltag&nbsp;LStr&nbsp;:&nbsp;SMB1&nbsp;transaction,&nbsp;Binary&nbsp;:&nbsp;srv.sys
kd&gt;&nbsp;.writemem&nbsp;1.bin&nbsp;a3fd10d8&nbsp;l0x11000-d8</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">漏洞利用</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">我们先来看pool数据覆盖的情况。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">覆盖前</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:plain;toolbar:false">8d1aa000&nbsp;00&nbsp;10&nbsp;01&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;58&nbsp;00&nbsp;00&nbsp;00&nbsp;70&nbsp;&nbsp;........X...p
8d1aa00d&nbsp;09&nbsp;11&nbsp;95&nbsp;08&nbsp;00&nbsp;00&nbsp;00&nbsp;08&nbsp;2f&nbsp;1f&nbsp;9f&nbsp;08&nbsp;2f&nbsp;&nbsp;......../.../
8d1aa01a&nbsp;1f&nbsp;9f&nbsp;60&nbsp;a1&nbsp;1a&nbsp;8d&nbsp;a0&nbsp;0e&nbsp;01&nbsp;00&nbsp;80&nbsp;00&nbsp;00&nbsp;&nbsp;..`..........
8d1aa027&nbsp;00&nbsp;3c&nbsp;a0&nbsp;1a&nbsp;8d&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;f7&nbsp;ff&nbsp;00&nbsp;00&nbsp;&nbsp;.............
8d1aa034&nbsp;10&nbsp;a0&nbsp;1a&nbsp;8d&nbsp;a4&nbsp;a0&nbsp;1a&nbsp;8d&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;60&nbsp;&nbsp;............`
8d1aa041&nbsp;00&nbsp;04&nbsp;10&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;60&nbsp;a1&nbsp;1a&nbsp;8d&nbsp;00&nbsp;a0&nbsp;&nbsp;.......`.....
8d1aa04e&nbsp;1a&nbsp;8d&nbsp;a0&nbsp;0e&nbsp;01&nbsp;00&nbsp;60&nbsp;01&nbsp;00&nbsp;00&nbsp;d5&nbsp;8e&nbsp;01&nbsp;&nbsp;......`......
8d1aa05b&nbsp;00&nbsp;d4&nbsp;8e&nbsp;01&nbsp;00&nbsp;13&nbsp;8d&nbsp;01&nbsp;00&nbsp;92&nbsp;6f&nbsp;00&nbsp;00&nbsp;&nbsp;..........o..
8d1aa068&nbsp;11&nbsp;36&nbsp;01&nbsp;00&nbsp;10&nbsp;6a&nbsp;00&nbsp;00&nbsp;4f&nbsp;9a&nbsp;03&nbsp;00&nbsp;8e&nbsp;&nbsp;.6...j..O....
8d1aa075&nbsp;4d&nbsp;01&nbsp;00&nbsp;4d&nbsp;d6&nbsp;00&nbsp;00&nbsp;0c&nbsp;6f&nbsp;00&nbsp;00&nbsp;4b&nbsp;71&nbsp;&nbsp;M..M....o..Kq
8d1aa082&nbsp;00&nbsp;00&nbsp;8a&nbsp;99&nbsp;03&nbsp;00&nbsp;c9&nbsp;6d&nbsp;00&nbsp;00&nbsp;c8&nbsp;70&nbsp;00&nbsp;&nbsp;.......m...p.
8d1aa08f&nbsp;00&nbsp;c7&nbsp;69&nbsp;00&nbsp;00&nbsp;86&nbsp;35&nbsp;01&nbsp;00&nbsp;05&nbsp;94&nbsp;03&nbsp;00&nbsp;&nbsp;..i...5......
8d1aa09c&nbsp;70&nbsp;09&nbsp;11&nbsp;95&nbsp;28&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;64&nbsp;&nbsp;p...(.......d
8d1aa0a9&nbsp;00&nbsp;00&nbsp;00&nbsp;70&nbsp;09&nbsp;11&nbsp;95&nbsp;38&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;&nbsp;...p...8.....
8d1aa0b6&nbsp;00&nbsp;00&nbsp;a0&nbsp;0e&nbsp;01&nbsp;00&nbsp;ff&nbsp;0f&nbsp;00&nbsp;00&nbsp;28&nbsp;a5&nbsp;00&nbsp;&nbsp;..........(..
8d1aa0c3&nbsp;00&nbsp;70&nbsp;09&nbsp;11&nbsp;95&nbsp;30&nbsp;a5&nbsp;00&nbsp;00&nbsp;70&nbsp;09&nbsp;11&nbsp;95&nbsp;&nbsp;.p...0...p...
8d1aa0d0&nbsp;38&nbsp;a5&nbsp;00&nbsp;00&nbsp;70&nbsp;09&nbsp;11&nbsp;95&nbsp;40&nbsp;a5&nbsp;00&nbsp;00&nbsp;70&nbsp;&nbsp;8...p...@...p
8d1aa0dd&nbsp;09&nbsp;11&nbsp;95&nbsp;48&nbsp;a5&nbsp;00&nbsp;00&nbsp;70&nbsp;09&nbsp;11&nbsp;95&nbsp;50&nbsp;a5&nbsp;&nbsp;...H...p...P.
8d1aa0ea&nbsp;00&nbsp;00&nbsp;70&nbsp;09&nbsp;11&nbsp;95&nbsp;58&nbsp;a5&nbsp;00&nbsp;00&nbsp;70&nbsp;09&nbsp;11&nbsp;&nbsp;..p...X...p..
8d1aa0f7&nbsp;95&nbsp;f0&nbsp;04&nbsp;00&nbsp;00&nbsp;70&nbsp;09&nbsp;11&nbsp;95&nbsp;f8&nbsp;04&nbsp;00&nbsp;00&nbsp;&nbsp;.....p.......
8d1aa104&nbsp;70&nbsp;09&nbsp;11&nbsp;95&nbsp;00&nbsp;05&nbsp;00&nbsp;00&nbsp;70&nbsp;09&nbsp;11&nbsp;95&nbsp;4e&nbsp;&nbsp;p.......p...N
8d1aa111&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;&nbsp;NNNNNNNNNNNNN
8d1aa11e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;&nbsp;NNNNNNNNNNNNN
8d1aa12b&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;&nbsp;NNNNNNNNNNNNN
8d1aa138&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;&nbsp;NNNNNNNNNNNNN
8d1aa145&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;&nbsp;NNNNNNNNNNNNN
8d1aa152&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;&nbsp;NNNNNNNNNNNNN
8d1aa15f&nbsp;4e&nbsp;fe&nbsp;53&nbsp;4d&nbsp;42&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;&nbsp;N.SMB........</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">覆盖后</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:plain;toolbar:false">8d1aa000&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;ff&nbsp;ff&nbsp;00&nbsp;00&nbsp;00&nbsp;&nbsp;.............
8d1aa00d&nbsp;00&nbsp;00&nbsp;00&nbsp;ff&nbsp;ff&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;&nbsp;.............
8d1aa01a&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;&nbsp;.............
8d1aa027&nbsp;00&nbsp;00&nbsp;f1&nbsp;df&nbsp;ff&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;&nbsp;.............
8d1aa034&nbsp;20&nbsp;f0&nbsp;df&nbsp;ff&nbsp;00&nbsp;f1&nbsp;df&nbsp;ff&nbsp;ff&nbsp;ff&nbsp;ff&nbsp;ff&nbsp;60&nbsp;&nbsp;&nbsp;...........`
8d1aa041&nbsp;00&nbsp;04&nbsp;10&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;80&nbsp;ef&nbsp;df&nbsp;ff&nbsp;00&nbsp;00&nbsp;&nbsp;.............
8d1aa04e&nbsp;00&nbsp;00&nbsp;10&nbsp;00&nbsp;d0&nbsp;ff&nbsp;ff&nbsp;ff&nbsp;ff&nbsp;ff&nbsp;18&nbsp;01&nbsp;d0&nbsp;&nbsp;.............
8d1aa05b&nbsp;ff&nbsp;ff&nbsp;ff&nbsp;ff&nbsp;ff&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;&nbsp;.............
8d1aa068&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;60&nbsp;00&nbsp;04&nbsp;10&nbsp;00&nbsp;&nbsp;........`....
8d1aa075&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;90&nbsp;ff&nbsp;&nbsp;.............
8d1aa082&nbsp;cf&nbsp;ff&nbsp;ff&nbsp;ff&nbsp;ff&nbsp;ff&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;&nbsp;.............
8d1aa08f&nbsp;00&nbsp;80&nbsp;10&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;&nbsp;.............
8d1aa09c&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;4b&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;64&nbsp;&nbsp;....K.......d
8d1aa0a9&nbsp;00&nbsp;00&nbsp;00&nbsp;70&nbsp;09&nbsp;11&nbsp;95&nbsp;38&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;&nbsp;...p...8.....
8d1aa0b6&nbsp;00&nbsp;00&nbsp;a0&nbsp;0e&nbsp;01&nbsp;00&nbsp;ff&nbsp;0f&nbsp;00&nbsp;00&nbsp;28&nbsp;a5&nbsp;00&nbsp;&nbsp;..........(..
8d1aa0c3&nbsp;00&nbsp;70&nbsp;09&nbsp;11&nbsp;95&nbsp;30&nbsp;a5&nbsp;00&nbsp;00&nbsp;70&nbsp;09&nbsp;11&nbsp;95&nbsp;&nbsp;.p...0...p...
8d1aa0d0&nbsp;38&nbsp;a5&nbsp;00&nbsp;00&nbsp;70&nbsp;09&nbsp;11&nbsp;95&nbsp;40&nbsp;a5&nbsp;00&nbsp;00&nbsp;70&nbsp;&nbsp;8...p...@...p
8d1aa0dd&nbsp;09&nbsp;11&nbsp;95&nbsp;48&nbsp;a5&nbsp;00&nbsp;00&nbsp;70&nbsp;09&nbsp;11&nbsp;95&nbsp;50&nbsp;a5&nbsp;&nbsp;...H...p...P.
8d1aa0ea&nbsp;00&nbsp;00&nbsp;70&nbsp;09&nbsp;11&nbsp;95&nbsp;58&nbsp;a5&nbsp;00&nbsp;00&nbsp;70&nbsp;09&nbsp;11&nbsp;&nbsp;..p...X...p..
8d1aa0f7&nbsp;95&nbsp;f0&nbsp;04&nbsp;00&nbsp;00&nbsp;70&nbsp;09&nbsp;11&nbsp;95&nbsp;f8&nbsp;04&nbsp;00&nbsp;00&nbsp;&nbsp;.....p.......
8d1aa104&nbsp;70&nbsp;09&nbsp;11&nbsp;95&nbsp;00&nbsp;05&nbsp;00&nbsp;00&nbsp;70&nbsp;09&nbsp;11&nbsp;95&nbsp;4e&nbsp;&nbsp;p.......p...N
8d1aa111&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;&nbsp;NNNNNNNNNNNNN
8d1aa11e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;&nbsp;NNNNNNNNNNNNN
8d1aa12b&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;&nbsp;NNNNNNNNNNNNN
8d1aa138&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;&nbsp;NNNNNNNNNNNNN
8d1aa145&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;&nbsp;NNNNNNNNNNNNN
8d1aa152&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;4e&nbsp;&nbsp;NNNNNNNNNNNNN
8d1aa15f&nbsp;4e&nbsp;fe&nbsp;53&nbsp;4d&nbsp;42&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;&nbsp;N.SMB........</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">在将下面SrvNet分配的对象覆盖前面的a1字节后。由于被覆盖的pool里面存在用于接收数据的buffer的指针。像上面描述的0x8d1aa034(0xffd0f020)这个地方的指针（我发懒了没有去确定到底是哪一个）。srvnet在接收包的时候就会在固定0xffdff000这个地址存入客户端发送来的数据。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">0xffdff0000这个地址是什么？wrk中有定义，如下：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:plain;toolbar:false">//&nbsp;addressed&nbsp;from&nbsp;0xffdf0000&nbsp;-&nbsp;0xffdfffff&nbsp;are&nbsp;reserved&nbsp;for&nbsp;the&nbsp;system
//&nbsp;begin_ntddk&nbsp;begin_ntosp
#define&nbsp;KI_USER_SHARED_DATA&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0xffdf0000
#define&nbsp;SharedUserData&nbsp;&nbsp;((KUSER_SHARED_DATA&nbsp;*&nbsp;const)&nbsp;KI_USER_SHARED_DATA)</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">这块内存是系统预留的，里面保存了系统的一些信息，像时钟，版本，配置之类。注意这个地址在win10下是不可以执行的。所以这个利用方法在win10下是不可用的。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">win7</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:plain;toolbar:false">kd&gt;&nbsp;!pte&nbsp;ffdff000
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VA&nbsp;ffdff000
PDE&nbsp;at&nbsp;C0603FF0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;PTE&nbsp;at&nbsp;C07FEFF8
contains&nbsp;000000000018A063&nbsp;&nbsp;contains&nbsp;00000000001E3163
pfn&nbsp;18a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;---DA--KWEV&nbsp;&nbsp;pfn&nbsp;1e3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-G-DA--KWEV&nbsp;&nbsp;//E表示可执行</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">覆盖完之后是这样。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:plain;toolbar:false">kd&amp;gt;&nbsp;db&nbsp;ffdff000&nbsp;l1000
ffdff000&nbsp;&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00-03&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;&nbsp;................
ffdff010&nbsp;&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00-00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;&nbsp;................
ffdff020&nbsp;&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00-03&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;&nbsp;................
ffdff030&nbsp;&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00-00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;&nbsp;................
ffdff040&nbsp;&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00-00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;&nbsp;................
ffdff050&nbsp;&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00-00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;&nbsp;................
ffdff060&nbsp;&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00-00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;&nbsp;................
ffdff070&nbsp;&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00-00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;&nbsp;................
ffdff080&nbsp;&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00-00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;&nbsp;................
ffdff090&nbsp;&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00-00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;&nbsp;................
ffdff0a0&nbsp;&nbsp;b0&nbsp;00&nbsp;d0&nbsp;ff&nbsp;ff&nbsp;ff&nbsp;ff&nbsp;ff-b0&nbsp;00&nbsp;d0&nbsp;ff&nbsp;ff&nbsp;ff&nbsp;ff&nbsp;ff&nbsp;&nbsp;................
ffdff0b0&nbsp;&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00-00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;&nbsp;................
ffdff0c0&nbsp;&nbsp;c0&nbsp;f0&nbsp;df&nbsp;ff&nbsp;c0&nbsp;f0&nbsp;df&nbsp;ff-00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;&nbsp;................
ffdff0d0&nbsp;&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00-00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;&nbsp;................
ffdff0e0&nbsp;&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00-00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;&nbsp;................
ffdff0f0&nbsp;&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00-00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;&nbsp;................
ffdff100&nbsp;&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00-00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;&nbsp;................
ffdff110&nbsp;&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00-00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;&nbsp;................
ffdff120&nbsp;&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00-00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;&nbsp;................
ffdff130&nbsp;&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00-00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;&nbsp;................
ffdff140&nbsp;&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00-00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;&nbsp;................
ffdff150&nbsp;&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00-00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;&nbsp;................
ffdff160&nbsp;&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00-00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;&nbsp;................
ffdff170&nbsp;&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00-00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;&nbsp;................
ffdff180&nbsp;&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00-00&nbsp;00&nbsp;00&nbsp;00&nbsp;90&nbsp;f1&nbsp;df&nbsp;ff&nbsp;&nbsp;................
ffdff190&nbsp;&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;f0&nbsp;f1&nbsp;df&nbsp;ff-00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;&nbsp;................
ffdff1a0&nbsp;&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00-00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;&nbsp;................
ffdff1b0&nbsp;&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00-00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;&nbsp;................
ffdff1c0&nbsp;&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00-00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;&nbsp;................
ffdff1d0&nbsp;&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00-f0&nbsp;01&nbsp;d0&nbsp;ff&nbsp;ff&nbsp;ff&nbsp;ff&nbsp;ff&nbsp;&nbsp;................
ffdff1e0&nbsp;&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00-00&nbsp;02&nbsp;d0&nbsp;ff&nbsp;ff&nbsp;ff&nbsp;ff&nbsp;ff&nbsp;&nbsp;................
ffdff1f0&nbsp;&nbsp;00&nbsp;31&nbsp;c0&nbsp;40&nbsp;90&nbsp;74&nbsp;08&nbsp;e8-09&nbsp;00&nbsp;00&nbsp;00&nbsp;c2&nbsp;24&nbsp;00&nbsp;e8&nbsp;&nbsp;.1.@.t.......$..
ffdff200&nbsp;&nbsp;a7&nbsp;00&nbsp;00&nbsp;00&nbsp;c3&nbsp;e8&nbsp;01&nbsp;00-00&nbsp;00&nbsp;eb&nbsp;90&nbsp;5b&nbsp;b9&nbsp;76&nbsp;01&nbsp;&nbsp;............[.v.
ffdff210&nbsp;&nbsp;00&nbsp;00&nbsp;0f&nbsp;32&nbsp;a3&nbsp;fc&nbsp;ff&nbsp;df-ff&nbsp;8d&nbsp;43&nbsp;17&nbsp;31&nbsp;d2&nbsp;0f&nbsp;30&nbsp;&nbsp;...2......C.1..0
ffdff220&nbsp;&nbsp;c3&nbsp;b9&nbsp;23&nbsp;00&nbsp;00&nbsp;00&nbsp;6a&nbsp;30-0f&nbsp;a1&nbsp;8e&nbsp;d9&nbsp;8e&nbsp;c1&nbsp;64&nbsp;8b&nbsp;&nbsp;..#...j0......d.
ffdff230&nbsp;&nbsp;0d&nbsp;40&nbsp;00&nbsp;00&nbsp;00&nbsp;8b&nbsp;61&nbsp;04-ff&nbsp;35&nbsp;fc&nbsp;ff&nbsp;df&nbsp;ff&nbsp;60&nbsp;9c&nbsp;&nbsp;.@....a..5....`.
ffdff240&nbsp;&nbsp;6a&nbsp;23&nbsp;52&nbsp;9c&nbsp;6a&nbsp;02&nbsp;83&nbsp;c2-08&nbsp;9d&nbsp;80&nbsp;4c&nbsp;24&nbsp;01&nbsp;02&nbsp;6a&nbsp;&nbsp;j#R.j......L$..j
ffdff250&nbsp;&nbsp;1b&nbsp;ff&nbsp;35&nbsp;04&nbsp;03&nbsp;df&nbsp;ff&nbsp;6a-00&nbsp;55&nbsp;53&nbsp;56&nbsp;57&nbsp;64&nbsp;8b&nbsp;1d&nbsp;&nbsp;..5....j.USVWd..
ffdff260&nbsp;&nbsp;1c&nbsp;00&nbsp;00&nbsp;00&nbsp;6a&nbsp;3b&nbsp;8b&nbsp;b3-24&nbsp;01&nbsp;00&nbsp;00&nbsp;ff&nbsp;33&nbsp;31&nbsp;c0&nbsp;&nbsp;....j;..$....31.
ffdff270&nbsp;&nbsp;48&nbsp;89&nbsp;03&nbsp;8b&nbsp;6e&nbsp;28&nbsp;6a&nbsp;01-83&nbsp;ec&nbsp;48&nbsp;81&nbsp;ed&nbsp;9c&nbsp;02&nbsp;00&nbsp;&nbsp;H...n(j...H.....
ffdff280&nbsp;&nbsp;00&nbsp;a1&nbsp;fc&nbsp;ff&nbsp;df&nbsp;ff&nbsp;b9&nbsp;76-01&nbsp;00&nbsp;00&nbsp;31&nbsp;d2&nbsp;0f&nbsp;30&nbsp;fb&nbsp;&nbsp;.......v...1..0.
ffdff290&nbsp;&nbsp;e8&nbsp;11&nbsp;00&nbsp;00&nbsp;00&nbsp;fa&nbsp;64&nbsp;8b-0d&nbsp;40&nbsp;00&nbsp;00&nbsp;00&nbsp;8b&nbsp;61&nbsp;04&nbsp;&nbsp;......d..@....a.
ffdff2a0&nbsp;&nbsp;83&nbsp;ec&nbsp;28&nbsp;9d&nbsp;61&nbsp;c3&nbsp;e9&nbsp;ef-00&nbsp;00&nbsp;00&nbsp;b9&nbsp;82&nbsp;00&nbsp;00&nbsp;c0&nbsp;&nbsp;..(.a...........
ffdff2b0&nbsp;&nbsp;0f&nbsp;32&nbsp;48&nbsp;bb&nbsp;f8&nbsp;0f&nbsp;d0&nbsp;ff-ff&nbsp;ff&nbsp;ff&nbsp;ff&nbsp;89&nbsp;53&nbsp;04&nbsp;89&nbsp;&nbsp;.2H..........S..
ffdff2c0&nbsp;&nbsp;03&nbsp;48&nbsp;8d&nbsp;05&nbsp;0a&nbsp;00&nbsp;00&nbsp;00-48&nbsp;89&nbsp;c2&nbsp;48&nbsp;c1&nbsp;ea&nbsp;20&nbsp;0f&nbsp;&nbsp;.H......H..H..&nbsp;.</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">0xffdff1f1处为shellcode.最后在接收完成后，最终调到srvnet!SrvNetWskReceiveComplete.在这个函数中会调用最终的shellcode。可以这么下断点:</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:plain;toolbar:false">srvnet!SrvNetWskReceiveComplete:
986e9569&nbsp;8bff&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;edi,edi
986e956b&nbsp;55&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;ebp
986e956c&nbsp;8bec&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ebp,esp
986e956e&nbsp;8b450c&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,dword&nbsp;ptr&nbsp;[ebp+0Ch]
986e9571&nbsp;8b4818&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ecx,dword&nbsp;ptr&nbsp;[eax+18h]
986e9574&nbsp;53&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;ebx
986e9575&nbsp;8b581c&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ebx,dword&nbsp;ptr&nbsp;[eax+1Ch]
986e9578&nbsp;56&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;esi
986e9579&nbsp;8b7510&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;esi,dword&nbsp;ptr&nbsp;[ebp+10h]
986e957c&nbsp;57&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;edi
986e957d&nbsp;8b7e24&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;edi,dword&nbsp;ptr&nbsp;[esi+24h]
986e9580&nbsp;50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;eax
986e9581&nbsp;894d0c&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[ebp+0Ch],ecx
986e9584&nbsp;c6451300&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;byte&nbsp;ptr&nbsp;[ebp+13h],0
986e9588&nbsp;ff1518106f98&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[srvnet!_imp__IoFreeIrp&nbsp;(986f1018)]
986e958e&nbsp;33c0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xor&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,eax
986e9590&nbsp;39450c&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[ebp+0Ch],eax
986e9593&nbsp;7553&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jne&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;srvnet!SrvNetWskReceiveComplete+0x7f&nbsp;(986e95e8)
kd&gt;&nbsp;.reload&nbsp;srvnet.sys
kd&gt;&nbsp;ba&nbsp;e1&nbsp;srvnet!SrvNetWskReceiveComplete+0x13&nbsp;&quot;.if(poi(esi+0x24)&nbsp;==&nbsp;ffdff020)&nbsp;{}&nbsp;.else&nbsp;{gc}&quot;</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">最终调用到shellcode的调用栈为：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:plain;toolbar:false">&nbsp;#&nbsp;ChildEBP&nbsp;RetAddr&nbsp;&nbsp;Args&nbsp;to&nbsp;Child&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
WARNING:&nbsp;Frame&nbsp;IP&nbsp;not&nbsp;in&nbsp;any&nbsp;known&nbsp;module.&nbsp;Following&nbsp;frames&nbsp;may&nbsp;be&nbsp;wrong.
00&nbsp;83f6c2e0&nbsp;986ea290&nbsp;00000000&nbsp;00000000&nbsp;00000420&nbsp;0xffdff1f1
01&nbsp;83f6c330&nbsp;986e8204&nbsp;ffdff020&nbsp;00001068&nbsp;00001068&nbsp;srvnet!SrvNetCommonReceiveHandler+0x94&nbsp;(FPO:&nbsp;[Non-Fpo])
02&nbsp;83f6c370&nbsp;986e95db&nbsp;ffdff020&nbsp;00000001&nbsp;870cb26b&nbsp;srvnet!SrvNetIndicateData+0x73&nbsp;(FPO:&nbsp;[Non-Fpo])
03&nbsp;83f6c38c&nbsp;83ebaf83&nbsp;00000000&nbsp;02000000&nbsp;019bd010&nbsp;srvnet!SrvNetWskReceiveComplete+0x72&nbsp;(FPO:&nbsp;[Non-Fpo])
04&nbsp;83f6c3d0&nbsp;8998db8c&nbsp;865fd020&nbsp;83f6c454&nbsp;89661c8a&nbsp;nt!IopfCompleteRequest+0x128
05&nbsp;83f6c3dc&nbsp;89661c8a&nbsp;870cb1f8&nbsp;00000000&nbsp;00001068&nbsp;afd!WskProTLReceiveComplete+0x5e&nbsp;(FPO:&nbsp;[Non-Fpo])
06&nbsp;83f6c454&nbsp;8964d839&nbsp;865fd020&nbsp;00000000&nbsp;8841a608&nbsp;tcpip!TcpCompleteClientReceiveRequest+0x1c&nbsp;(FPO:&nbsp;[Non-Fpo])
07&nbsp;83f6c4c0&nbsp;8964d8be&nbsp;8841a608&nbsp;8841a700&nbsp;00000000&nbsp;tcpip!TcpFlushTcbDelivery+0x1f6&nbsp;(FPO:&nbsp;[Non-Fpo])
08&nbsp;83f6c4dc&nbsp;8965af7f&nbsp;8841a608&nbsp;00000000&nbsp;83f6c5d0&nbsp;tcpip!TcpFlushRequestReceive+0x1c&nbsp;(FPO:&nbsp;[Non-Fpo])
09&nbsp;83f6c518&nbsp;8965ae47&nbsp;8841a608&nbsp;8841a608&nbsp;83f6c5a8&nbsp;tcpip!TcpDeliverFinToClient+0x37&nbsp;(FPO:&nbsp;[Non-Fpo])
0a&nbsp;83f6c528&nbsp;896abfc1&nbsp;8841a608&nbsp;83f6c688&nbsp;8841a608&nbsp;tcpip!TcpAllowFin+0x86&nbsp;(FPO:&nbsp;[Non-Fpo])
0b&nbsp;83f6c5a8&nbsp;896aa5a5&nbsp;86f8c078&nbsp;8841a608&nbsp;83f6c5d0&nbsp;tcpip!TcpTcbCarefulDatagram+0x16f2&nbsp;(FPO:&nbsp;[Non-Fpo])
0c&nbsp;83f6c614&nbsp;8968da38&nbsp;86f8c078&nbsp;8841a608&nbsp;00f6c688&nbsp;tcpip!TcpTcbReceive+0x22d&nbsp;(FPO:&nbsp;[Non-Fpo])
0d&nbsp;83f6c67c&nbsp;8968e23a&nbsp;8656b9b8&nbsp;86f9657c&nbsp;86f965f0&nbsp;tcpip!TcpMatchReceive+0x237&nbsp;(FPO:&nbsp;[Non-Fpo])
0e&nbsp;83f6c6cc&nbsp;8965dd90&nbsp;86f8c078&nbsp;86f9600c&nbsp;00003d08&nbsp;tcpip!TcpPreValidatedReceive+0x263&nbsp;(FPO:&nbsp;[Non-Fpo])
0f&nbsp;83f6c6e0&nbsp;89693396&nbsp;83f6c6fc&nbsp;00000011&nbsp;86f96008&nbsp;tcpip!TcpNlClientReceivePreValidatedDatagrams+0x15&nbsp;(FPO:&nbsp;[Non-Fpo])
10&nbsp;83f6c704&nbsp;896938dd&nbsp;83f6c710&nbsp;00000000&nbsp;00000011&nbsp;tcpip!IppDeliverPreValidatedListToProtocol+0x33&nbsp;(FPO:&nbsp;[Non-Fpo])
11&nbsp;83f6c7a0&nbsp;89698a7b&nbsp;8665d918&nbsp;00000000&nbsp;83f79480&nbsp;tcpip!IpFlcReceivePreValidatedPackets+0x479&nbsp;(FPO:&nbsp;[Non-Fpo])
12&nbsp;83f6c7c8&nbsp;83ecbb95&nbsp;00000000&nbsp;ee2bb116&nbsp;865bab48&nbsp;tcpip!FlReceiveNetBufferListChainCalloutRoutine+0xfc&nbsp;(FPO:&nbsp;[Non-Fpo])
13&nbsp;83f6c830&nbsp;89698c0b&nbsp;8969897f&nbsp;83f6c858&nbsp;00000000&nbsp;nt!KeExpandKernelStackAndCalloutEx+0x132
14&nbsp;83f6c86c&nbsp;8951f18d&nbsp;8665d002&nbsp;87773900&nbsp;00000000&nbsp;tcpip!FlReceiveNetBufferListChain+0x7c&nbsp;(FPO:&nbsp;[Non-Fpo])
15&nbsp;83f6c8a4&nbsp;8950d5be&nbsp;8665eaa8&nbsp;87773988&nbsp;00000000&nbsp;ndis!ndisMIndicateNetBufferListsToOpen+0x188&nbsp;(FPO:&nbsp;[Non-Fpo])
16&nbsp;83f6c8cc&nbsp;8950d4b2&nbsp;00000000&nbsp;87773988&nbsp;871650e0&nbsp;ndis!ndisIndicateSortedNetBufferLists+0x4a&nbsp;(FPO:&nbsp;[Non-Fpo])
17&nbsp;83f6ca48&nbsp;894b8c1d&nbsp;871650e0&nbsp;00000000&nbsp;00000000&nbsp;ndis!ndisMDispatchReceiveNetBufferLists+0x129&nbsp;(FPO:&nbsp;[Non-Fpo])
18&nbsp;83f6ca64&nbsp;8950d553&nbsp;871650e0&nbsp;87773988&nbsp;00000000&nbsp;ndis!ndisMTopReceiveNetBufferLists+0x2d&nbsp;(FPO:&nbsp;[Non-Fpo])
19&nbsp;83f6ca8c&nbsp;894b8c78&nbsp;871650e0&nbsp;87773988&nbsp;00000000&nbsp;ndis!ndisMIndicateReceiveNetBufferListsInternal+0x62&nbsp;(FPO:&nbsp;[Non-Fpo])
1a&nbsp;83f6cab4&nbsp;903ab7f4&nbsp;871650e0&nbsp;87773988&nbsp;00000000&nbsp;ndis!NdisMIndicateReceiveNetBufferLists+0x52&nbsp;(FPO:&nbsp;[Non-Fpo])
1b&nbsp;83f6cafc&nbsp;903aa77e&nbsp;00000000&nbsp;87792660&nbsp;00000001&nbsp;E1G60I32!RxProcessReceiveInterrupts+0x108&nbsp;(FPO:&nbsp;[Non-Fpo])
1c&nbsp;83f6cb14&nbsp;8950d89a&nbsp;011e9138&nbsp;00000000&nbsp;83f6cb40&nbsp;E1G60I32!E1000HandleInterrupt+0x80&nbsp;(FPO:&nbsp;[Non-Fpo])
1d&nbsp;83f6cb50&nbsp;894b8a0f&nbsp;87792674&nbsp;00792660&nbsp;00000000&nbsp;ndis!ndisMiniportDpc+0xe2&nbsp;(FPO:&nbsp;[Non-Fpo])
1e&nbsp;83f6cb78&nbsp;83eba696&nbsp;87792674&nbsp;87792660&nbsp;00000000&nbsp;ndis!ndisInterruptDpc+0xaf&nbsp;(FPO:&nbsp;[Non-Fpo])
1f&nbsp;83f6cbd4&nbsp;83eba4f8&nbsp;83f6fe20&nbsp;83f79480&nbsp;00000000&nbsp;nt!KiExecuteAllDpcs+0xfa
20&nbsp;83f6cc20&nbsp;83eba318&nbsp;00000000&nbsp;0000000e&nbsp;00000000&nbsp;nt!KiRetireDpcList+0xd5
21&nbsp;83f6cc24&nbsp;00000000&nbsp;0000000e&nbsp;00000000&nbsp;00000000&nbsp;nt!KiIdleLoop+0x38&nbsp;(FPO:&nbsp;[0,0,0])</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">关于补丁</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">微软在补丁中并没有补掉漏洞的代码而是在上层过滤了触发漏洞的一个Type。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">补丁修补的逻辑在srv!ExecuteTransaction</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">修补前：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:plain;toolbar:false">int&nbsp;__thiscall&nbsp;ExecuteTransaction(int&nbsp;this)
{
&nbsp;&nbsp;&nbsp;&nbsp;//略...
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;*(_DWORD&nbsp;*)(v3&nbsp;+&nbsp;0x50)&nbsp;&gt;=&nbsp;1u&nbsp;&amp;&amp;&nbsp;v10&nbsp;&lt;=&nbsp;0x11&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v2&nbsp;=&nbsp;SrvTransaction2DispatchTable[v10](this);&nbsp;//这里进入派发函数
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;BYTE1(WPP_GLOBAL_Control-&gt;Flags)&nbsp;&gt;=&nbsp;2u
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;WPP_GLOBAL_Control-&gt;Characteristics&nbsp;&amp;&nbsp;1
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;KeGetCurrentIrql()&nbsp;&lt;&nbsp;2u
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;v2
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;(PDEVICE_OBJECT&nbsp;*)WPP_GLOBAL_Control&nbsp;!=&nbsp;&amp;WPP_GLOBAL_Control&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WPP_SF_(WPP_GLOBAL_Control-&gt;AttachedDevice,&nbsp;WPP_GLOBAL_Control-&gt;CurrentIrp);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto&nbsp;LABEL_104;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;//goto&nbsp;error
&nbsp;&nbsp;&nbsp;&nbsp;//略...
}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">修复后：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:plain;toolbar:false">int&nbsp;__thiscall&nbsp;ExecuteTransaction(int&nbsp;this)
{
&nbsp;&nbsp;&nbsp;//略...
&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;*(_DWORD&nbsp;*)(v3&nbsp;+&nbsp;0x50)&nbsp;&lt;&nbsp;2u&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_SrvSetSmbError2(0,&nbsp;464,&nbsp;&quot;onecore\\base\\fs\\remotefs\\smb\\srv\\srv.downlevel\\smbtrans.c&quot;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SrvLogInvalidSmbDirect(v1,&nbsp;v10);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto&nbsp;LABEL_109;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;v11&nbsp;&lt;=&nbsp;0x11&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v2&nbsp;=&nbsp;SrvTransaction2DispatchTable[v11](v1);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;BYTE1(WPP_GLOBAL_Control-&gt;Flags)&nbsp;&gt;=&nbsp;2u
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;WPP_GLOBAL_Control-&gt;Characteristics&nbsp;&amp;&nbsp;1
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;KeGetCurrentIrql()&nbsp;&lt;&nbsp;2u
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;v2
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;(PDEVICE_OBJECT&nbsp;*)WPP_GLOBAL_Control&nbsp;!=&nbsp;&amp;WPP_GLOBAL_Control&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;WPP_SF_(WPP_GLOBAL_Control-&gt;AttachedDevice,&nbsp;WPP_GLOBAL_Control-&gt;CurrentIrp);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto&nbsp;LABEL_108;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;//goto&nbsp;error
&nbsp;&nbsp;&nbsp;&nbsp;//略...
}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">修补的方法就是将修补*(WORD*)v6 ==&gt; *(DWORD*)v6; 还有就是*(_DWORD *)(v3 + 0x50) &gt;= 1 变成了 *(_DWORD *)(v3 + 0x50) &gt;= 2u 笔者在调试的时候发现触发漏洞的正好是1。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">由于作者水平有限，有什么错误欢迎大家指出</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">联系作者：</span><a href="http://weibo.com/pgboy1988" target="_self" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline; color: rgb(255, 0, 0);"><span style="color: rgb(255, 0, 0);"><strong><span style="color: rgb(255, 0, 0); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">pgboy1988</span></strong></span></a></p></p>
                <hr/>
                <p style="text-align: center;">
                    <img src="http://bobao.360.cn/img/app.jpeg"/>
                    <img src="http://bobao.360.cn/img/weixin.jpeg"/>
                </p>
                                <p>本文转载自 360安全卫士技术博客<br/><a class="text-more" href="http://blogs.360.cn/360safe/2017/04/17/nsa-eternalblue-smb/" target="_blank">原文链接：http://blogs.360.cn/360safe/2017/04/17/nsa-eternalblue-smb/</a></p>
                            </div>
            <div style="margin-top: 20px;background-color:#FFFFFF">
    <input type="hidden" id="detail_title" name="detail_title" value="【漏洞分析】MS 17-010：NSA Eternalblue SMB 漏洞分析 - 安全客 - 有思想的安全新媒体" />
    <input type="hidden" id="use_nickname" name="use_nickname" value="0" />
    <a name="mao"></a>
    <div class="reg-log mobile-hiden">
        <div class="" id="userTo">   
            <div id="to-list" class="input-text" style="">
                <textarea disabled="disabled" class="hide"  id="comment-content" to="to"></textarea>
                <ul id="preadded" style="display:none">       
                </ul>
                <div id="to-auto" style="width: 200px">
                    <ul id="feed">
                    </ul>
                </div>
            </div>
        </div>
        <input type="hidden" id="source-id" value="3738" />
        <input type="hidden" id="source-type" value="learning" />
        <input type="hidden" id="post-comment-url" value="/comment/add" />
        <input type="hidden" id="post-nickname-url-ajax" value="/comment/randnicknameajax" />
        <input type="hidden" id="post-check-login-url-ajax" value="/comment/checklogin" />
        <input type="hidden" id="stoken_comment_set" value="ea3898fb4df38673fdeb61c458234054">                 <span class="join">参与讨论，请先 <a href="javascript:;" class="comment-login">登录</a> | <a href="javascript:;" class="comment-reg">注册</a> |  <a href="javascript:;" class="anonymous-comment">匿名评论</a></span>
            </div>
    <div class="mobile-hide" style="width: 870px; margin: 0 auto;">
        <label style="vertical-align:middle;" for="use_nickname">匿名</label> 
        <input style="vertical-align:middle;" id="trigger-nickname" name="use_nickname" class="use_nickname" type="checkbox" value="0" />

        <a href="javascript:;" class="apply-use button" id="submit-comment" data-target="/comment/add">发布</a>
    </div>


    <div class="clearfix"></div>
    <div class="comments">
        <div class="comments-head">
            <span class="title">用户评论</span>
        </div>
                <div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src='http://p1.qhmsg.com/dm/48_48_100/t01049cac452ac00f3e.jpg'/>              
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="2802394681" class="response" data-bind-id="2802394681" data-target="14307" user-name="houjingyi233" href="javascript:;">
                houjingyi233            </a>
                        <span class="comment-time">2017-05-23 15:53:16</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="2802394681" data-target="14307">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_14307" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">windows\lib\x86-Windows里面有</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
<div class="clearfix re-comment">
    <div class="comment-quote">  
        <div class="comment-user">
            <a href="javascript:;" class="response" data-bind-id="0" data-target="13454">Anonymous</a> <span class="comment-time">2017-04-20 11:40:02</span>            <div class="comment-action">                        <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="13454">回复</a></span>&nbsp;|&nbsp;                        <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_13454" data-type="comment">点赞</a></span>            </div>
            <p>能说的详细点吗，我这单独拿出来提示丢失trch-1.dll</p>
        </div>
    </div>
            <div class="clearfix re-comment">
        <div class="comment-quote">  
            <div class="comment-user">
                <a href="javascript:;" class="response" data-bind-id="0" data-target="13433">Mickey牛</a> <span class="comment-time">2017-04-20 09:07:49</span>            <div class="comment-action">                        <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="13433">回复</a></span>&nbsp;|&nbsp;                        <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_13433" data-type="comment">点赞</a></span>            </div>
                <p>把相关的dll和配置文件拿出来就可以</p>
            </div>
        </div>
                        <div class="clearfix re-comment">
            <div class="comment-quote">  
                <div class="comment-user">
                    <a href="javascript:;" class="response" data-bind-id="0" data-target="13233">Mickey牛</a> <span class="comment-time">2017-04-17 22:27:30</span>            <div class="comment-action">                        <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="13233">回复</a></span>&nbsp;|&nbsp;                        <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_13233" data-type="comment">点赞</a></span>            </div>
                    <p>Eternalblue-2.2.0.exe这个程序能不能独立运行</p>
                </div>
            </div>
                                </div>
            </div>
    </div>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/0x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="14230" user-name="男科圣手" href="javascript:;">
                男科圣手            </a>
                        <span class="comment-time">2017-05-17 22:45:35</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="14230">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_14230" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">“0xffdff1f1”处为shellcode,能否详细解释一下0xffdff1f1这个地址是怎么控制的，让程序到这个地址执行？</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/0x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="14094" user-name="熊猫烧香作者被抓" href="javascript:;">
                熊猫烧香作者被抓            </a>
                        <span class="comment-time">2017-05-13 18:57:00</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="14094">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_14094" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">有没有demo</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
<div class="clearfix re-comment">
    <div class="comment-quote">  
        <div class="comment-user">
            <a href="javascript:;" class="response" data-bind-id="0" data-target="13233">Mickey牛</a> <span class="comment-time">2017-04-17 22:27:30</span>            <div class="comment-action">                        <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="13233">回复</a></span>&nbsp;|&nbsp;                        <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_13233" data-type="comment">点赞</a></span>            </div>
            <p>Eternalblue-2.2.0.exe这个程序能不能独立运行</p>
        </div>
    </div>
        </div>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/9x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="13454" user-name="Anonymous" href="javascript:;">
                Anonymous            </a>
                        <span class="comment-time">2017-04-20 11:40:02</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="13454">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_13454" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">能说的详细点吗，我这单独拿出来提示丢失trch-1.dll</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
<div class="clearfix re-comment">
    <div class="comment-quote">  
        <div class="comment-user">
            <a href="javascript:;" class="response" data-bind-id="0" data-target="13433">Mickey牛</a> <span class="comment-time">2017-04-20 09:07:49</span>            <div class="comment-action">                        <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="13433">回复</a></span>&nbsp;|&nbsp;                        <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_13433" data-type="comment">点赞</a></span>            </div>
            <p>把相关的dll和配置文件拿出来就可以</p>
        </div>
    </div>
            <div class="clearfix re-comment">
        <div class="comment-quote">  
            <div class="comment-user">
                <a href="javascript:;" class="response" data-bind-id="0" data-target="13233">Mickey牛</a> <span class="comment-time">2017-04-17 22:27:30</span>            <div class="comment-action">                        <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="13233">回复</a></span>&nbsp;|&nbsp;                        <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_13233" data-type="comment">点赞</a></span>            </div>
                <p>Eternalblue-2.2.0.exe这个程序能不能独立运行</p>
            </div>
        </div>
                    </div>
    </div>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/2x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="13433" user-name="Mickey牛" href="javascript:;">
                Mickey牛            </a>
                        <span class="comment-time">2017-04-20 09:07:49</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="13433">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_13433" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">把相关的dll和配置文件拿出来就可以</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
<div class="clearfix re-comment">
    <div class="comment-quote">  
        <div class="comment-user">
            <a href="javascript:;" class="response" data-bind-id="0" data-target="13233">Mickey牛</a> <span class="comment-time">2017-04-17 22:27:30</span>            <div class="comment-action">                        <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="13233">回复</a></span>&nbsp;|&nbsp;                        <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_13233" data-type="comment">点赞</a></span>            </div>
            <p>Eternalblue-2.2.0.exe这个程序能不能独立运行</p>
        </div>
    </div>
        </div>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/2x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="13233" user-name="Mickey牛" href="javascript:;">
                Mickey牛            </a>
                        <span class="comment-time">2017-04-17 22:27:30</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="13233">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_13233" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">Eternalblue-2.2.0.exe这个程序能不能独立运行</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>

        <a class="more-long comment-more" href="javascript:;" data-target="/comment/more" data-type="learning" data-source-id="3738" data-page="2">查看更多</a>
            </div>
</div>
<script>
    $(function () {
        $('.anonymous-comment').click(function () {
            $(".join").hide();
            $(".reg-log textarea").first().removeAttr("disabled").show();
            $('#use_nickname').val('1');
//            $('#trigger-nickname').attr('checked', true);
            $('#trigger-nickname').trigger('click');
        });
        //为所有复选框绑定事件
//        checkbox_on_click();
        //ajax随机获取昵称
//        randnicknameajax(0);
        //ajax检测登录状态
        comment_check_login();
    });



    function input_checkbox(flag) {
        $('input:checkbox').each(function () {
            var value = flag ? 1 : 0;
            $(this).prop('checked', flag);
            $(this).val(value);
        });
    }

//ajax随机获取昵称
    function randnicknameajax(flag) {
        $.ajax({
            type: 'POST',
            url: $('#post-nickname-url-ajax').val(),
            data: {limit: 1, flag: flag},
            dataType: "json",
            success: function (data) {
                $('#nick-name').val(data.data[0]);
                _nick_name=data.data[0];
            }
        });
    }
    $();
//ajax检测登录状态
    function comment_check_login() {
        $.ajax({
            type: 'POST',
            url: $('#post-check-login-url-ajax').val(),
            data: {},
            dataType: "json",
            success: function (data) {
                if (data.success) {
                    $('.join').hide();
                    $(".reg-log textarea").first().removeAttr("disabled").show();
                    $("#span_use_nickname").show();
                    $('#use_nickname').val('0');
                    $('#use_nickname').attr('checked', false);
                }
            }
        });
    }
</script>        </div>
    </div>
    <div class="side-bar">
        <div class="mod hot-news">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-hot"></i><span>热门知识</span></h2>
    </div>
    <ul class="links-list">
                                <li><a href="/learning/detail/4411.html" alt="【漏洞预警】一个换行符引发的奥斯卡0day漏洞(CVE-2017-8759)重现——最新的Office高级威胁攻击预警" target="_blank">【漏洞预警】一个换行符引发的奥斯卡...</a></li>
                                <li><a href="/learning/detail/4416.html" alt="【漏洞预警】Microsoft .NET Framework漏洞（CVE–2017–8759）预警" target="_blank">【漏洞预警】Microsoft .NE...</a></li>
                                <li><a href="/learning/detail/4414.html" alt="【技术分享】妙用JavaScript绕过XSS过滤" target="_blank">【技术分享】妙用JavaScrip...</a></li>
                                <li><a href="/learning/detail/4418.html" alt="【技术分享】利用威胁情报数据平台拓展APT攻击线索一例" target="_blank">【技术分享】利用威胁情报数据平台拓...</a></li>
                                <li><a href="/learning/detail/4417.html" alt="【知识】9月15日 - 每日安全知识热点" target="_blank">【知识】9月15日 - 每日安全知识热...</a></li>
                                <li><a href="/learning/detail/4425.html" alt="【安全报告】XShellGhost事件技术回顾报告" target="_blank">【安全报告】XShellGhost事件...</a></li>
            </ul>
</div>        <!-- 友情链接 -->
        <div class="mod blog-links mobile-hide">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-link"></i><span>友情链接</span></h2>
        <a href="/links/index.html" class="more">更多<i></i></a>
    </div>
        <ul class="links-list">
                <li><a href="http://bbs.360safe.com" alt="360安全社区" target="_blank">360安全社区</a></li>
                <li><a href="http://zhuji.360.cn" alt="360主机卫士" target="_blank">360主机卫士</a></li>
                <li><a href="http://blogs.360.cn/" alt="奇虎360技术博客" target="_blank">奇虎360技术博客</a></li>
                <li><a href="http://wangzhan.360.cn/" alt="360网站卫士" target="_blank">360网站卫士</a></li>
                <li><a href="http://webscan.360.cn/" alt="360网站安全检测" target="_blank">360网站安全检测</a></li>
                <li><a href="http://research.360.cn/report/" alt="360研究报告" target="_blank">360研究报告</a></li>
                <li><a href="http://unicorn.360.cn/" alt="360 Unicorn Team" target="_blank">360 Unicorn Team</a></li>
                <li><a href="http://appscan.360.cn/" alt="360捉虫猎手" target="_blank">360捉虫猎手</a></li>
                <li><a href="https://threathunter.org/" alt="ThreatHunter社区" target="_blank">ThreatHunter社区</a></li>
                <li><a href="http://security.360.cn/" alt="360安全应急响应中心" target="_blank">360安全应急响应中心</a></li>
            </ul>
    </div>
        <!-- 联系我们 -->
        <div class="mod contact mobile-hide" style="text-align:center">
    <div class="head-bar clearfix">
        <h2><i></i><span>关注我们</span></h2>
    </div>
    <!-- 微信关注 -->
    <ul class="contact-way">
        <li><a>微信关注</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/qrcode_adlab_weixin.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
    <!-- APP下载 -->
    <ul class="contact-way">
        <li><a>安全播报APP</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/scan_code_big.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
</div>

    </div>
</div>

<script type="text/javascript" src="/js/jquery-ui.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/jquery.noty.packaged.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/common.js?v=4.5"></script>
<script>$(function() {sync_count('comment');});</script>


<!-- 语法高亮 -->
<script type="text/javascript" src="/ue/SyntaxHighlighter/shCore.js"></script>
<script type="text/javascript">SyntaxHighlighter.all();sync_count('vul');sync_count('news');sync_count('learning');sync_count('activity');sync_count('course');sync_count('ctf');</script>
    </div>

        <div class="footer">
        <div class="friend-link">
            <a href="http://www.360.cn/" target="_blank">360首页</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">关于我们</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">联系我们</a>
            <span>|</span>
            <a href="/links/index.html" target="_blank">友情链接</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">招贤纳士</a>
        </div>
        <div class="copy">
            Copyright &copy; 360网络攻防实验室 All Rights Reserved <span class="copy_icp">京ICP证080047号[京ICP备08010314号-6]</span>
        </div>
    </div>
    
</div>

<!--奇舞团统计-->

<script src='https://s.ssl.qhimg.com/static/f5407c785655e6a1/monitor_analytic.js'></script>
<script>
    monitor.setProject('QH_171_1').getTrack().getClickAndKeydown().getClickHeatmap(10, 1);
</script>

<div class="hide">
    <script src="https://s95.cnzz.com/z_stat.php?id=1253147824&web_id=1253147824" language="JavaScript"></script>
</div>
<div class="backToTop_wrap off">
    <a id="back_to_top" class="backToTop" href="javascript:;" title="返回顶部"></a>
</div>
<script>
    var $backToTop_wrap = $(".backToTop_wrap"),
        $backToTop_btn = $("#back_to_top");

    if ($(window).scrollTop() > 100) {
        $backToTop_wrap.removeClass("off");
    }
    else {
        $backToTop_wrap.addClass("off");
    }

    $(window).on("scroll", function () {
        if ($(this).scrollTop() > 100) {
            $backToTop_wrap.removeClass("off");
        }
        else {
            $backToTop_wrap.addClass("off");
        }
    });

    $backToTop_btn.on("click", function () {
        $("html, body").animate({scrollTop: 0}, 120);
    });

    $(function () {
        var navlist = $('.nav-list > li');

        navlist.each(function () {
            $(this).on('mouseenter', function () {
                $(this).addClass('selected');
            });

            $(this).on('mouseleave', function () {
                $(this).removeClass('selected');
            });
        });
    })
</script>



</body>
</html>
