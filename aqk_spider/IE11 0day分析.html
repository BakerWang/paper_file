<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns:wb="http://open.weibo.com/wb" xml:lang="en" lang="en">
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"/>
    <link rel="shortcut icon" href="http://bobao.360.cn/favicon.ico?v=1.1"/>
    <link rel="alternate" title="安全资讯" href="/rss?type=news" type="application/rss+xml"/>
    <link rel="alternate" title="安全知识" href="/rss?type=learning" type="application/rss+xml"/>
    <link rel="alternate" title="安全圈活动" href="/rss?type=activity" type="application/rss+xml"/>
    <link rel="alternate" title="所有漏洞" href="/rss?type=vul" type="application/rss+xml"/>
    <link rel="alternate" title="通用型漏洞" href="/rss?type=commonvul" type="application/rss+xml"/>
    <link rel="alternate" title="事件型漏洞" href="/rss?type=eventvul" type="application/rss+xml"/>
    <link rel="alternate" title="热门漏洞" href="/rss?type=hotvul" type="application/rss+xml"/>

        <title>IE11 0day分析 - 安全客 - 有思想的安全新媒体</title>
    
        <meta name="keywords" content="IE11,0day分析"/>
    
        <meta name="description" content="7月6日，有消息传言意大利公司也是Hacking Team这次网络攻击中的受害者之一。在数据泄露之后，Vectra的研究人员分析了泄露的数据，并鉴定出了一个先前没有被发现的Internet Explorer 11中的漏洞，该漏洞威胁到Windows 7和 Windows 8.1版本。"/>
        <meta property="wb:webmaster" content="224437c7be31d633"/>

    <script type="text/javascript" src="http://s7.qhimg.com/!56caa871/xpc_sync_height.js"></script>
    <link rel="stylesheet" type="text/css" href="/css/reset.css" />
    <link rel="stylesheet" type="text/css" href="/css/common_new.css?v=4.4.2.1" />
    <link rel="stylesheet" type="text/css" href="/css/jquery.notyfy.css" />
    <link rel="stylesheet" type="text/css" href="/css/notyfy.theme.default.css" />
    <link rel="stylesheet" type="text/css" href="/css/s_common.css?v=2.2.7" media="only screen and
    (max-device-width:900px), only screen and (max-width:900px)" />
    <script type="text/javascript" src="/js/jquery.min.js?v=3.1"></script>
    <script type="text/javascript" src="/js/jquery.notyfy.js"></script>
    <script type="text/javascript" src="/js/iscroll.js"></script>
    <script src="http://js.passport.qihucdn.com/5.0.3.js"></script>
    <script type="text/javascript">
        var myScroll, myNavScroll;

        function iscrollLoaded() {
            myScroll = new IScroll('#wrapper',
                {
                    scrollX: true,
                    scrollY: false,
                    bounceEasing: 'circular',
                    eventPassthrough: true,
                    preventDefault: false,
                    bounceTime: 500
                }
            );
        }

        $(function () {

            //导航横向滚动


            function setNavWidth() {

                /* 计算导航宽度 */
                var allWidth = $(window).width();
                var scroller = $('#scroller');

                if (allWidth > 900) {
                    scroller.find('ul').add(scroller.find('.scroll')).removeAttr('style');
                    scroller.css('overflow', 'visible');
                    if (myNavScroll) myNavScroll.destroy();
                } else {

                    var width = 0;
                    scroller.find('.scroll').children('ul').children('li').each(function (index, el) {
                        if (!$(this).hasClass('mobile-hide')) {
                            width += $(this).outerWidth();
                        }
                    });
                    scroller.find('ul').add(scroller.find('.scroll')).width(width);

                    if (myNavScroll) myNavScroll.destroy();

                    myNavScroll = new IScroll('#scroller', {
                        scrollX: true,
                        scrollY: false,
                        momentum: false,
                        click: true
                    });

                }

            }

            setNavWidth();
            $(window).resize(function (event) {
                setNavWidth();
            });

        });

    </script>
</head>
<body onload="iscrollLoaded();">
<div style='margin:0 auto;width:0px;height:0px;overflow:hidden;'>
    <img src=""/>
</div>

<div id="is-mobile"></div>
<div class="container">
        <div class="mobile-header">
        <div class="header clearfix">
            <div class="header-wrapper clearfix">
                <a href="/index/index" class="logo"><img class="slogan" src="/img/logo.png?v=1.5"/></a>
                                <form id="search" class="search-box" action="/search/index" method="GET">
                    <input class="keys" name="keywords" type="text" placeholder="搜索漏洞" required="required">
                    <input class="icon" type="submit" value="">
                    <input type="hidden" name="type" value=""/>
                </form>
                <div class="bug">
                    <div class="name"><span class="seled">全部</span><i class="arrow"></i></div>
                    <ul class="typelist">
                        <li data-index="3"><a href="javascript:void(0);">全部</a></li>
                        <li data-index="0"><a href="javascript:void(0);">漏洞</a></li>
                        <li data-index="1"><a href="javascript:void(0);">资讯</a></li>
                        <li data-index="2"><a href="javascript:void(0);">知识</a></li>
                    </ul>
                </div>
                                <div class="logNreg mobile-hide">
                    <div class="unlog">
                        <i></i>
                        <a href="log.html" class="log">登录</a>
                        <span>|</span>
                        <a href="reg.html" class="reg">注册</a>
                    </div>
                    <div class="loged">
                        <a href="/member/profile" class="user-center"><i></i><span class="user-name-tag">个人中心</span></a>
                        <div class="user-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting"><a href="http://i.360.cn/profile/accountmanage"
                                                               target="_blank"><i></i><span>账号设置</span></a></li>
                                <li class="alert-setting"><a href="/keywords/index"
                                                             target="_blank"><i></i><span>告警设置</span></a></li>
                                <li class="bug-alert"><a href="/myalarm/index" target="_blank"><i></i><span>漏洞告警</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mylearn/index" target="_blank"><i></i><span>我的知识</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mycourse/index" target="_blank"><i></i><span>我的课堂</span></a>
                                </li>
                                <li class="my-exit"><a
                                            href="http://login.360.cn/?src=pcw_adlab&op=logout&destUrl=http://bobao.360.cn"><i></i><span>退出系统</span></a>
                                </li>
                            </ul>
                        </div>

                        <a href="/message" class="message-center" target="_blank"><i></i><span>我的消息</span></a>
                        <div class="message-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting" style="display:none;"><a href="/myres/index"
                                                                                     target="_blank"><i></i><span>回复我的</span></a>
                                </li>
                                <li class="my-bug"><a href="/myvul/index"
                                                      target="_blank"><i></i><span>我的漏洞</span></a></li>
                                <!--<li class="my-bug"><a href="/myres/index" target="_blank"><i></i><span>我的评论</span></a></li>-->
                                <!--<li class="alert-setting"><a href="###" target="_blank"><i></i><span>提到我的</span></a>
                                </li>-->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <style type="text/css">
            .nav {
                overflow: hidden;
            }

            .nav .scroll {
                width: auto;
            }
        </style>
        <div id="wrapper">
            <div id="scroller" class="nav">
                <div class="scroll">
                    <ul class="nav-list">
                        <li ><a class="link-nav"
                                                                                 href="/index/index">首页</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/vul/index">漏洞</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/introduce/list">招聘</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/news/index">资讯</a><!--<i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/introduce/list">招聘</a></li>
                        </ul>
			-->
                        </li>
                        <li class="cur">
                        <a class="link-nav" href="/learning/index">知识</a><i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/course/index">学院</a></li>
                        </ul>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/activity/index">活动</a></li>
                        <li class="mobile-hide "><a class="link-nav"
                                                                                                   href="/ctf/index">CTF训练营</a>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/interref/list">安全内参</a></li>
                        <li ><a class="link-nav" href="/app/index">APP</a></li>

                        <!--<li ><a href="/course/index">学院</a></li>-->
                        <!--<li ><a href="/introduce/list">招聘</a></li>-->
                        <!--<li  class="mobile-hide"><a href="/ctf/index">CTF训练营</a></li>-->
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="mobile-content">
        <link rel="stylesheet" type="text/css" href="/css/news.css?v=3.5" />
<link rel="stylesheet" type="text/css" href="/ue/SyntaxHighlighter/shCoreDefault.css?v=1.0" />
<style>
    p .syntaxhighlighter {
        width: 80%;
    }
</style>

<div class="cur-pos w1000">当前位置：<a href="http://bobao.360.cn/">安全客</a> &gt;&gt; 知识详情</div>

<div class="content clearfix">
    <div class="main">
        <div class="article">
            <div id="article_box">
                <h2>IE11 0day分析</h2>
                <div class="article-msg">
                    <span class="time">2015-07-17 16:29:17</span>
                                        <span class="read">阅读：12506次</span>
                    <span><a style="display: none;" class="good" href="javascript:;"
                             data-target="/learning/good" data-value="g_530"
                             data-type="learning">点赞(0)</a></span>
                    <span><a class="fav" href="javascript:;" data-target="/mylearning/add"
                             data-pk="530" data-type="learning">收藏</a></span>
                                        <span><a style="margin-left: 4px;" class="fav" href="http://blog.vectranetworks.com/blog/microsoft-internet-explorer-11-zero-day"
                             target="_blank">来源： 360安全播报</a></span>
                    
                                    </div>
                <hr size="1">
                <div class="article-msg">
                    <p><!-- JiaThis Button BEGIN -->

<!--
<span class="jiathis_style"><span class="jiathis_txt">分享到：</span>
	<a class="jiathis_button_weixin"></a>
	<a class="jiathis_button_tsina"></a>
    <a class="jiathis_button_tqq"></a>
    <a class="jiathis_button_qzone"></a>
    <a class="jiathis_button_renren"></a>
    <a class="jiathis_button_xiaoyou"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
</span>

-->
</p>
                </div>
                <p><p style="text-align:center"><span style="font-size: 14px;"><strong><span style="font-family: &quot;微软雅黑&quot;,&quot;Microsoft YaHei&quot;;"><img alt="http://p4.qhimg.com/t018dcc0f98b409dbf2.jpg" src="http://p4.qhimg.com/t018dcc0f98b409dbf2.jpg" title="t018dcc0f98b409dbf2.jpg"/></span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 14px;"><strong><span style="font-family: &quot;微软雅黑&quot;,&quot;Microsoft YaHei&quot;;">摘要</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family:&#39;微软雅黑&#39;, &#39;Microsoft YaHei&#39;;font-size:14px;color:rgb(0,176,80);">7月6日，有消息传言意大利公司也是Hacking Team这次网络攻击中的受害者之一。在数据泄露之后，Vectra的研究人员分析了泄露的数据，并鉴定出了一个先前没有被发现的Internet Explorer 11中的漏洞，该漏洞威胁到Windows 7和 Windows 8.1版本。</span></p><p style="text-indent:2em;text-align:left;"><span style="font-family:&#39;微软雅黑&#39;, &#39;Microsoft YaHei&#39;;font-size:14px;">在搜寻漏洞刚开始的时候，我们注意到了一封来自外部研究人员的邮件，这个人视图向Hacking Team出售一个proof-of-concept（POC）。</span></p><p style="text-indent:2em;text-align:left;"><span style="font-family:&#39;微软雅黑&#39;, &#39;Microsoft YaHei&#39;;font-size:14px;">这封邮件发送于2015年6月2号，邮件内容大体上是描述了Internet Explorer 11中的一个可利用的use-after-free漏洞。然而Hacking Team最终却拒绝购买这个POC，这邮件为Vectra的研究人员找到并分析该漏洞提供了充分的信息。</span></p><p style="text-indent:2em;text-align:left;"><span style="font-family:&#39;微软雅黑&#39;, &#39;Microsoft YaHei&#39;;font-size:14px;">Hacking Team拒绝购买POC，那么那个漏洞发现这就有可能把该漏洞卖到了别处。这意味着该漏洞可能已经在其他地方被利用。</span></p><p style="text-indent:2em;text-align:left;"><strong><span style="font-family:&#39;微软雅黑&#39;, &#39;Microsoft YaHei&#39;;font-size:14px;">严重程度</span></strong></p><p style="text-indent:2em;text-align:left;"><span style="font-family:&#39;微软雅黑&#39;, &#39;Microsoft YaHei&#39;;font-size:14px;">高</span></p><p style="text-indent:2em;text-align:left;"><strong><span style="font-family:&#39;微软雅黑&#39;, &#39;Microsoft YaHei&#39;;font-size:14px;">受影响版本</span></strong></p><p style="text-indent:2em;text-align:left;"><span style="font-family:&#39;微软雅黑&#39;, &#39;Microsoft YaHei&#39;;font-size:14px;">Internet Explorer 11.0.9600.17631 / 11.0.16及IE11之前的版本。</span></p><p style="text-indent:2em;text-align:left;"><strong><span style="font-family:&#39;微软雅黑&#39;, &#39;Microsoft YaHei&#39;;font-size:14px;">概述</span></strong></p><p style="text-indent:2em;text-align:left;"><span style="font-family:&#39;微软雅黑&#39;, &#39;Microsoft YaHei&#39;;font-size:14px;">这是一个可利用的use-after-free（UAF）安全漏洞，它发生在JSCRIPT9的自定义堆中。正是由于该漏洞存在于自定义堆，所以它允许攻击者绕过内存保护技术。</span></p><p style="text-indent:2em;text-align:left;"><strong><span style="font-family:&#39;微软雅黑&#39;, &#39;Microsoft YaHei&#39;;font-size:14px;">供应商动态</span></strong></p><p style="text-indent:2em;text-align:left;"><span style="font-family:&#39;微软雅黑&#39;, &#39;Microsoft YaHei&#39;;font-size:14px;">微软在2015年7月9日接到了通知</span></p><p style="text-indent:2em;text-align:left;"><strong><span style="font-family:&#39;微软雅黑&#39;, &#39;Microsoft YaHei&#39;;font-size:14px;">解决方案</span></strong></p><p style="text-indent:2em;text-align:left;"><span style="font-family:&#39;微软雅黑&#39;, &#39;Microsoft YaHei&#39;;font-size:14px;">微软在2015年7月14日修复了该漏洞，更多信息可以看 https://technet.microsoft.com/en-us/library/security/ms15-065.aspx，我们建议用户尽快应用此更新。</span></p><p style="text-indent:2em;text-align:center;"><strong><span style="font-family:&#39;微软雅黑&#39;, &#39;Microsoft YaHei&#39;;font-size:16px;">技术分析</span></strong></p><p style="text-indent:2em;text-align:left;"><span style="font-family:&#39;微软雅黑&#39;, &#39;Microsoft YaHei&#39;;font-size:14px;">在细阅Hacking Team转储数据时，我们遇到一个电子邮件，内容是一个人试图向Hacking Team(HT)售卖一个Oday,该谈话片段如下（通过谷歌翻译）：</span></p><p style="text-indent:2em;text-align:left;"><span style="font-family:&#39;微软雅黑&#39;, &#39;Microsoft YaHei&#39;;font-size:14px;color:rgb(0,176,80);">“让我猜猜，你们或许会对在win7和win8上最近更新到的IE11中的Poc（DEP冲突）感兴趣，我不能控制EIP的确定性，但貌似对于用户而言是可控的，所以应该可以允许执行代码”</span></p><p style="text-indent:2em;text-align:left;"><span style="font-family:&#39;微软雅黑&#39;, &#39;Microsoft YaHei&#39;;font-size:14px;">奇怪的是，这个人并没有提及任何关于这个BUG的信息，也没有进行任何分析。如果我们再来看这一连串的Email内容， 我们会发现这个POC和HT的一个员工基本上是在说这个漏洞确实看起来很有意思，并且可以使用一个use-after-free，但是这看起来还是很困难的。</span></p><p style="text-indent:2em;text-align:left;"><span style="font-family:&#39;微软雅黑&#39;, &#39;Microsoft YaHei&#39;;font-size:14px;color:rgb(0,176,80);">“我做了一些POC的快速发送测试，一目了然：只有IE11崩溃，听起来很有意思，EIP和EAX的值应该是一个use-after-free。”</span></p><p style="text-indent:2em;text-align:left;"><span style="font-family:&#39;微软雅黑&#39;, &#39;Microsoft YaHei&#39;;font-size:14px;">&nbsp;我们很好奇故事的细节和下载下来的POC（803c696c。94c798f2.131_2。HTML），除去不相关的东西，可以看出如下结果：</span></p><p style="text-align:center;"><img src="http://p5.qhimg.com/t01552cd5b94025acd6.png" title="t01552cd5b94025acd6.png" alt="t01552cd5b94025acd6.png" style="width:580px;height:452px;" height="452" border="0" vspace="0" width="580"/></p><p style="text-indent:2em;text-align:left;"><span style="font-family:&#39;微软雅黑&#39;, &#39;Microsoft YaHei&#39;;font-size:14px;">我们的问题是，这到底是一个use-after-free还是其他的东西?让我们在调试器中找到答案吧！（由于从多个调试器回话中输出，请注意偏移量可能会不一样）</span></p><p style="text-indent:2em;text-align:left;"><span style="font-family:&#39;微软雅黑&#39;, &#39;Microsoft YaHei&#39;;font-size:14px;">如果我们打开GFLAGS，并且用WinDbg加载该文件到IE11中，我们可以看到这个预期的崩溃：</span></p><pre class="brush:cpp;toolbar:false">(334.b28):&nbsp;Access&nbsp;violation&nbsp;-&nbsp;code&nbsp;c0000005&nbsp;(first&nbsp;chance)&nbsp;First&nbsp;chance&nbsp;exceptions&nbsp;are&nbsp;reported&nbsp;before&nbsp;any&nbsp;exception&nbsp;handling.&nbsp;This&nbsp;exception&nbsp;may&nbsp;be&nbsp;expected&nbsp;and&nbsp;handled.&nbsp;eax=047e0000&nbsp;ebx=04668d20&nbsp;ecx=65e9c76d&nbsp;edx=00862f84&nbsp;esi=00000003&nbsp;edi=04a2c7b4&nbsp;eip=047e0000&nbsp;esp=04a2c5dc&nbsp;ebp=04a2c628&nbsp;iopl=0&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;zr&nbsp;na&nbsp;pe&nbsp;nc&nbsp;cs=001b&nbsp;ss=0023&nbsp;ds=0023&nbsp;es=0023&nbsp;fs=003b&nbsp;gs=0000&nbsp;efl=00010246</pre><p style="text-indent:2em;text-align:left;"><span style="font-family:&#39;微软雅黑&#39;, &#39;Microsoft YaHei&#39;;font-size:14px;">047e0000 ?? ???</span></p><p style="text-indent:2em;text-align:left;"><span style="font-family:&#39;微软雅黑&#39;, &#39;Microsoft YaHei&#39;;font-size:14px;">我们当然可以看到HT的员工在EAX和EIP崩溃的时候说的些什么。</span></p><p style="text-indent:2em;text-align:left;"><span style="font-family:&#39;微软雅黑&#39;, &#39;Microsoft YaHei&#39;;font-size:14px;">当时，我们的调用栈顶看起来就像这样：</span></p><pre class="brush:cpp;toolbar:false">028ec510&nbsp;660082cd&nbsp;02409d20&nbsp;00000003&nbsp;03416f30&nbsp;0x33e0000
028ec560&nbsp;66008a05&nbsp;00000003&nbsp;028ec6ec&nbsp;ffab2388&nbsp;jscript9!Js::JavascriptFunction::CallFunction&lt;1&gt;+0x91&nbsp;(FPO:&nbsp;[Non-Fpo])
028ec5d4&nbsp;6600893f&nbsp;01cd50f0&nbsp;00000003&nbsp;028ec6ec&nbsp;jscript9!Js::JavascriptFunction::CallRootFunction+0xc1&nbsp;(FPO:&nbsp;[Non-Fpo])
028ec61c&nbsp;660088bf&nbsp;028ec644&nbsp;00000003&nbsp;028ec6ec&nbsp;jscript9!ScriptSite::CallRootFunction+0x42&nbsp;(FPO:&nbsp;[Non-Fpo])
028ec64c&nbsp;6600d0f0&nbsp;02409d20&nbsp;028ec674&nbsp;00000000&nbsp;jscript9!ScriptSite::Execute+0x61&nbsp;(FPO:&nbsp;[Non-Fpo])
028ec6a8&nbsp;6600d02c&nbsp;00000003&nbsp;028ec6ec&nbsp;00000000&nbsp;jscript9!ScriptEngineBase::ExecuteInternal&lt;0&gt;+0xbb&nbsp;(FPO:&nbsp;[Non-Fpo])
028ec6c0&nbsp;66e32258&nbsp;01d1ad10&nbsp;02409d20&nbsp;00000003&nbsp;jscript9!ScriptEngineBase::Execute+0x1c&nbsp;(FPO:&nbsp;[Non-Fpo])
028ec700&nbsp;66e32166&nbsp;006eafa8&nbsp;00000000&nbsp;00000000&nbsp;MSHTML!CMutationObserver::PerformMicrotaskCheckpoint+0x97&nbsp;(FPO:&nbsp;[Non-Fpo])
028ec784&nbsp;66ed4211&nbsp;006fda30&nbsp;028ec79c&nbsp;006eafa8&nbsp;MSHTML!CObserverManager::InvokeObserversForCheckpoint+0x78&nbsp;(FPO:&nbsp;[Non-Fpo])
028ec794&nbsp;66f3f51e&nbsp;006eafa8&nbsp;00000000&nbsp;00008002&nbsp;MSHTML!PerformMicrotaskCheckpoint+0x2e&nbsp;(FPO:&nbsp;[0,1,0])</pre><p style="text-indent:2em;text-align:left;"><span style="font-family:&#39;微软雅黑&#39;, &#39;Microsoft YaHei&#39;;font-size:14px;">显然，我们已经破坏了EIP，而我们又不能完全依靠这个调用栈。我们应该计算出导致这个调用栈崩溃的原因是什么，我们可以在 jscript!Js::JavascriptFunction::CallFunctioin&lt;1&gt; 这里下一个断点来达到这个目的。</span></p><p style="text-indent:2em;text-align:left;"><span style="font-family:&#39;微软雅黑&#39;, &#39;Microsoft YaHei&#39;;font-size:14px;">这个断点被触发了好几次。上一次，我们向前步进，直到下一个相关联的调用，如下：</span></p><pre class="brush:cpp;toolbar:false">eax=06996f30&nbsp;ebx=04619d20&nbsp;ecx=6600c780&nbsp;edx=04a8c738&nbsp;esi=00000003&nbsp;edi=04a8c904
eip=660082ca&nbsp;esp=04a8c730&nbsp;ebp=04a8c778&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;zr&nbsp;na&nbsp;pe&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000246
jscript9!Js::JavascriptFunction::CallFunction&lt;1&gt;+0x8e:
660082ca&nbsp;ff55f4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[ebp-0Ch]&nbsp;&nbsp;ss:0023:04a8c76c=6600c780
0:007&gt;&nbsp;dt&nbsp;6600c780
NativeCodeGenerator::CheckCodeGen</pre><p style="text-indent:2em;text-align:left;"><span style="font-family:&#39;微软雅黑&#39;, &#39;Microsoft YaHei&#39;;font-size:14px;">这样看来，我们貌似在做一个CheckCodeGen的间接调用。我们继续步进。这里的jscript9!NativeCodeGenerator 立即下降到 jscript9!NativeCodeGenerator::CheckCodeGenThunk. &nbsp;这有个后续调用jscript9!NativeCodeGenerator::CheckCodeGen，然后结束。</span></p><pre class="brush:cpp;toolbar:false">eax=04870000&nbsp;ebx=04619d20&nbsp;ecx=6600c76d&nbsp;edx=057aef84&nbsp;esi=00000003&nbsp;edi=04a8c904
eip=6600c78f&nbsp;esp=04a8c72c&nbsp;ebp=04a8c778&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;zr&nbsp;na&nbsp;pe&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000246
jscript9!NativeCodeGenerator::CheckCodeGenThunk+0xd:
6600c78f&nbsp;ffe0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jmp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax&nbsp;{04870000}</pre><p style="text-indent:2em;text-align:left;"><span style="font-family:&#39;微软雅黑&#39;, &#39;Microsoft YaHei&#39;;font-size:14px;">如果我们从调用栈的顶部看，会发现这里是一个被破坏的EIP。</span></p><pre class="brush:cpp;toolbar:false">04a8c728&nbsp;660082cd&nbsp;04619d20&nbsp;00000003&nbsp;06996f30&nbsp;jscript9!NativeCodeGenerator::CheckCodeGenThunk+0xd&nbsp;(FPO:&nbsp;[2,0,0])
04a8c778&nbsp;66008a05&nbsp;00000003&nbsp;04a8c904&nbsp;02fd0849&nbsp;jscript9!Js::JavascriptFunction::CallFunction&lt;1&gt;+0x91&nbsp;(FPO:&nbsp;[Non-Fpo])
04a8c7ec&nbsp;6600893f&nbsp;057928b8&nbsp;00000003&nbsp;04a8c904&nbsp;jscript9!Js::JavascriptFunction::CallRootFunction+0xc1&nbsp;(FPO:&nbsp;[Non-Fpo])
04a8c834&nbsp;660088bf&nbsp;04a8c85c&nbsp;00000003&nbsp;04a8c904&nbsp;jscript9!ScriptSite::CallRootFunction+0x42&nbsp;(FPO:&nbsp;[Non-Fpo])
04a8c864&nbsp;6600d0f0&nbsp;04619d20&nbsp;04a8c88c&nbsp;00000000&nbsp;jscript9!ScriptSite::Execute+0x61&nbsp;(FPO:&nbsp;[Non-Fpo])
04a8c8c0&nbsp;6600d02c&nbsp;00000003&nbsp;04a8c904&nbsp;00000000&nbsp;jscript9!ScriptEngineBase::ExecuteInternal&lt;0&gt;+0xbb&nbsp;(FPO:&nbsp;[Non-Fpo])
04a8c8d8&nbsp;66e32258&nbsp;09afcde0&nbsp;04619d20&nbsp;00000003&nbsp;jscript9!ScriptEngineBase::Execute+0x1c&nbsp;(FPO:&nbsp;[Non-Fpo])
04a8c918&nbsp;66e32166&nbsp;0674ecc8&nbsp;00000000&nbsp;00000080&nbsp;MSHTML!CMutationObserver::PerformMicrotaskCheckpoint+0x97&nbsp;(FPO:&nbsp;[Non-Fpo])
04a8c99c&nbsp;66ed4211&nbsp;068a6f98&nbsp;04a8c9b4&nbsp;0674ecc8&nbsp;MSHTML!CObserverManager::InvokeObserversForCheckpoint+0x78&nbsp;(FPO:&nbsp;[Non-Fpo])
04a8c9ac&nbsp;66f3f51e&nbsp;0674ecc8&nbsp;00000000&nbsp;00008002&nbsp;MSHTML!PerformMicrotaskCheckpoint+0x2e&nbsp;(FPO:&nbsp;[0,1,0])
04a8c9f0&nbsp;667fde4a&nbsp;02f3f428&nbsp;04a8cabc&nbsp;00008002&nbsp;MSHTML!GlobalWndOnMethodCall+0x18b&nbsp;(FPO:&nbsp;[Non-Fpo])
04a8ca40&nbsp;77a6c4e7&nbsp;007c016e&nbsp;00008002&nbsp;00000000&nbsp;MSHTML!GlobalWndProc+0x2e5&nbsp;(FPO:&nbsp;[Non-Fpo])</pre><p style="text-indent:2em;text-align:left;"><span style="font-family:&#39;微软雅黑&#39;, &#39;Microsoft YaHei&#39;;font-size:14px;">下一步我们想知道来自我们的jmp eax的EAX的值在哪。让我们反汇编CheckCodeGenThunk</span></p><pre class="brush:cpp;toolbar:false">0:007&gt;&nbsp;u&nbsp;jscript9!NativeCodeGenerator::CheckCodeGenThunk
jscript9!NativeCodeGenerator::CheckCodeGenThunk:
6600c782&nbsp;55&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;ebp
6600c783&nbsp;8bec&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ebp,esp
6600c785&nbsp;ff742408&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[esp+8]
6600c789&nbsp;e812ffffff&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;&nbsp;jscript9!NativeCodeGenerator::CheckCodeGen&nbsp;(6600c6a0)
6600c78e&nbsp;5d&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pop&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ebp
6600c78f&nbsp;ffe0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jmp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax
6600c791&nbsp;66894daa&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;word&nbsp;ptr&nbsp;[ebp-56h],cx
6600c795&nbsp;e909faffff&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jmp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jscript9!Js::InterpreterStackFrame::Process+0x9b6&nbsp;(6600c1a3)</pre><p style="text-indent:2em;text-align:left;"><span style="font-family:&#39;微软雅黑&#39;, &#39;Microsoft YaHei&#39;;font-size:14px;">它似乎来自jscript9!NativeCodeGenerator::CheckCodeGen的返回值。你如果查看IDA，会发现那里有三条路径导致函数的返回。</span></p><p style="text-align:center;"><img src="http://p9.qhimg.com/t0125ca104602dea16e.png" title="t0125ca104602dea16e.png" alt="t0125ca104602dea16e.png" style="width:580px;height:400px;" height="400" border="0" vspace="0" width="580"/></p><p style="text-indent:2em;text-align:left;"><span style="font-family:&#39;微软雅黑&#39;, &#39;Microsoft YaHei&#39;;font-size:14px;color:rgb(0,176,80);">为了更好的控制，我们需要单步执行此功能。在jscript9!NativeCodeGenerator::CheckCodeGen断点出程序会重新启动。</span></p><p style="text-indent:2em;text-align:left;"><span style="font-family:&#39;微软雅黑&#39;, &#39;Microsoft YaHei&#39;;font-size:14px;">在崩溃前的最后一个bp中，我们可以设置一个新断点，并允许这个函数结束。</span></p><pre class="brush:cpp;toolbar:false">0:007&gt;&nbsp;bc&nbsp;*
0:007&gt;&nbsp;bp&nbsp;jscript9!NativeCodeGenerator::CheckCodeGen+CD
0:007&gt;&nbsp;pa
eax=07416f30&nbsp;ebx=05209d20&nbsp;ecx=6600c780&nbsp;edx=0541c558&nbsp;esi=00000003&nbsp;edi=0541c724
eip=6600c6a2&nbsp;esp=0541c53c&nbsp;ebp=0541c548&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;zr&nbsp;na&nbsp;pe&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000246
jscript9!NativeCodeGenerator::CheckCodeGen+0x2:
6600c6a2&nbsp;b8e9b72166&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,offset&nbsp;jscript9!DListBase::DListBase+0x3119&nbsp;(6621b7e9)
///&nbsp;SNIP&nbsp;///
eax=0541c518&nbsp;ebx=00000001&nbsp;ecx=05209d20&nbsp;edx=06189f88&nbsp;esi=05836100&nbsp;edi=06258f50
eip=660074ec&nbsp;esp=0541c504&nbsp;ebp=0541c53c&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;nz&nbsp;na&nbsp;po&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000202
jscript9!NativeCodeGenerator::CheckCodeGen+0x113:
660074ec&nbsp;e80a000000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;&nbsp;jscript9!NativeCodeGenerator::CheckCodeGenDone&nbsp;(660074fb)
eax=073e0000&nbsp;ebx=00000001&nbsp;ecx=073e0000&nbsp;edx=06189f84&nbsp;esi=05836100&nbsp;edi=06258f50
eip=660074f1&nbsp;esp=0541c504&nbsp;ebp=0541c53c&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;zr&nbsp;na&nbsp;pe&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000246
jscript9!NativeCodeGenerator::CheckCodeGen+0x118:
660074f1&nbsp;e972520000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jmp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jscript9!NativeCodeGenerator::CheckCodeGen+0xc0&nbsp;(6600c768)
eax=073e0000&nbsp;ebx=00000001&nbsp;ecx=073e0000&nbsp;edx=06189f84&nbsp;esi=05836100&nbsp;edi=06258f50
eip=6600c768&nbsp;esp=0541c504&nbsp;ebp=0541c53c&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;zr&nbsp;na&nbsp;pe&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000246
jscript9!NativeCodeGenerator::CheckCodeGen+0xc0:
6600c768&nbsp;e8e3cbfeff&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;&nbsp;jscript9!_EH_epilog3&nbsp;(65ff9350)</pre><p style="text-indent:2em;text-align:left;"><span style="font-family:&#39;微软雅黑&#39;, &#39;Microsoft YaHei&#39;;font-size:14px;">从上图我们可以看到，我们的返回值是073e0000，在我们即将跳转的地址之后，这个值可以追溯到jscript9!NativeCodeGenerator::CheckCodeGenDone的返回值。</span></p><p style="text-align:center;"><img src="http://p0.qhimg.com/t013074763165285e84.png" title="t013074763165285e84.png" alt="t013074763165285e84.png" style="width:580px;height:400px;" height="400" border="0" vspace="0" width="580"/></p><p style="text-indent:2em;text-align:left;"><span style="font-family:&#39;微软雅黑&#39;, &#39;Microsoft YaHei&#39;;font-size:14px;">用同样的技巧，我们还可以看看NativeCodeGenerator::CheckCodeGenDone</span></p><pre class="brush:cpp;toolbar:false">Breakpoint&nbsp;0&nbsp;hit
eax=04aac728&nbsp;ebx=00000001&nbsp;ecx=045c9d20&nbsp;edx=058e4f88&nbsp;esi=047e6100&nbsp;edi=05a88f50
eip=660074fb&nbsp;esp=04aac710&nbsp;ebp=04aac74c&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;nz&nbsp;na&nbsp;po&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000202
jscript9!NativeCodeGenerator::CheckCodeGenDone:
660074fb&nbsp;8bff&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;edi,edi
0:007&gt;&nbsp;bp&nbsp;jscript9!NativeCodeGenerator::CheckCodeGenDone+0x81
0:007&gt;&nbsp;pa
eax=04aac728&nbsp;ebx=00000001&nbsp;ecx=045c9d20&nbsp;edx=058e4f88&nbsp;esi=047e6100&nbsp;edi=05a88f50
eip=660074fd&nbsp;esp=04aac710&nbsp;ebp=04aac74c&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;nz&nbsp;na&nbsp;po&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000202
jscript9!NativeCodeGenerator::CheckCodeGenDone+0x2:
660074fd&nbsp;55&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;ebp
///&nbsp;SNIP&nbsp;///
Breakpoint&nbsp;1&nbsp;hit
eax=04870000&nbsp;ebx=00000001&nbsp;ecx=04870000&nbsp;edx=058e4f84&nbsp;esi=047e6100&nbsp;edi=05a88f50
eip=6600757c&nbsp;esp=04aac710&nbsp;ebp=04aac74c&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;zr&nbsp;na&nbsp;pe&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000246
jscript9!NativeCodeGenerator::CheckCodeGenDone+0x7d:
6600757c&nbsp;c3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret</pre><p style="text-indent:2em;text-align:left;"><span style="font-family:&#39;微软雅黑&#39;, &#39;Microsoft YaHei&#39;;font-size:14px;">这里是我们熟悉的返回值EIP &nbsp;04870000。让我们看看EAX在哪获取的值—</span></p><pre class="brush:cpp;toolbar:false">eax=04870000&nbsp;ebx=047e6100&nbsp;ecx=04870000&nbsp;edx=058e4f84&nbsp;esi=047e7120&nbsp;edi=04870000
eip=66007574&nbsp;esp=04aac6f8&nbsp;ebp=04aac70c&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;zr&nbsp;na&nbsp;pe&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000246
jscript9!NativeCodeGenerator::CheckCodeGenDone+0x75:
66007574&nbsp;8bc7&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,edi</pre><p style="text-indent:2em;text-align:left;"><span style="font-family:&#39;微软雅黑&#39;, &#39;Microsoft YaHei&#39;;font-size:14px;">跟踪EDI倒退，我们可以看到这是一个指向jscript9!Js::ScriptFunction::UpdateThunkEntryPoint的参数。</span></p><pre class="brush:cpp;toolbar:false">eax=058d08b8&nbsp;ebx=047e6100&nbsp;ecx=045c9d20&nbsp;edx=058e4f84&nbsp;esi=047e7120&nbsp;edi=04870000
eip=6600756d&nbsp;esp=04aac6f8&nbsp;ebp=04aac70c&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;ng&nbsp;nz&nbsp;na&nbsp;po&nbsp;cy
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000283
jscript9!NativeCodeGenerator::CheckCodeGenDone+0x6e:
6600756d&nbsp;57&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;edi
eax=058d08b8&nbsp;ebx=047e6100&nbsp;ecx=045c9d20&nbsp;edx=058e4f84&nbsp;esi=047e7120&nbsp;edi=04870000
eip=6600756e&nbsp;esp=04aac6f4&nbsp;ebp=04aac70c&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;ng&nbsp;nz&nbsp;na&nbsp;po&nbsp;cy
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000283
jscript9!NativeCodeGenerator::CheckCodeGenDone+0x6f:
6600756e&nbsp;53&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;ebx
eax=058d08b8&nbsp;ebx=047e6100&nbsp;ecx=045c9d20&nbsp;edx=058e4f84&nbsp;esi=047e7120&nbsp;edi=04870000
eip=6600756f&nbsp;esp=04aac6f0&nbsp;ebp=04aac70c&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;ng&nbsp;nz&nbsp;na&nbsp;po&nbsp;cy
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000283
jscript9!NativeCodeGenerator::CheckCodeGenDone+0x70:
6600756f&nbsp;e8c7540000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;&nbsp;jscript9!Js::ScriptFunction::UpdateThunkEntryPoint&nbsp;(6600ca3b)
eax=04870000&nbsp;ebx=047e6100&nbsp;ecx=04870000&nbsp;edx=058e4f84&nbsp;esi=047e7120&nbsp;edi=04870000
eip=66007574&nbsp;esp=04aac6f8&nbsp;ebp=04aac70c&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;zr&nbsp;na&nbsp;pe&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000246
jscript9!NativeCodeGenerator::CheckCodeGenDone+0x75:
66007574&nbsp;8bc7&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,edi</pre><p style="text-indent:2em;text-align:left;"><span style="font-family:&#39;微软雅黑&#39;, &#39;Microsoft YaHei&#39;;font-size:14px;">此外，我们看到它进入了同一个函数中，因此我们大胆地假设里面没有被修改。我们需要进一步向后追溯EDI。之所以下一步对EDI发起写操作是由于取消了引用</span></p><pre class="brush:cpp;toolbar:false">eax=058d08b8&nbsp;ebx=047e6100&nbsp;ecx=00000000&nbsp;edx=058e4f84&nbsp;esi=047e7120&nbsp;edi=662ef9a0
eip=662371c5&nbsp;esp=04aac6f8&nbsp;ebp=04aac70c&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;ng&nbsp;nz&nbsp;na&nbsp;po&nbsp;cy
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000283
jscript9!NativeCodeGenerator::CheckCodeGenDone+0x22fcca:
662371c5&nbsp;8b7e04&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;edi,dword&nbsp;ptr&nbsp;[esi+4]&nbsp;ds:0023:047e7124=04870000</pre><p style="text-indent:2em;text-align:left;"><span style="font-family:&#39;微软雅黑&#39;, &#39;Microsoft YaHei&#39;;font-size:14px;">现在我们需要要跟踪ESI。我们可以看到，ESI来自EAX的引用</span></p><pre class="brush:cpp;toolbar:false">eax=047e7120&nbsp;ebx=00000001&nbsp;ecx=045c9d20&nbsp;edx=058e4f88&nbsp;esi=047e6100&nbsp;edi=05a88f50
eip=66007508&nbsp;esp=04aac6f8&nbsp;ebp=04aac70c&nbsp;iopl=0&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;nz&nbsp;na&nbsp;po&nbsp;nc
cs=001b&nbsp;ss=0023&nbsp;ds=0023&nbsp;es=0023&nbsp;fs=003b&nbsp;gs=0000&nbsp;efl=00000202
jscript9!NativeCodeGenerator::CheckCodeGenDone+0xd:
66007508&nbsp;8b7010&nbsp;mov&nbsp;esi,dword&nbsp;ptr&nbsp;[eax+10h]&nbsp;ds:0023:047e7130=047e7120</pre><p style="text-indent:2em;text-align:left;"><span style="font-family:&#39;微软雅黑&#39;, &#39;Microsoft YaHei&#39;;font-size:14px;">EAX倒退后，我们终于到达源了</span></p><pre class="brush:cpp;toolbar:false">eax=04aac728&nbsp;ebx=00000001&nbsp;ecx=045c9d20&nbsp;edx=058e4f88&nbsp;esi=047e6100&nbsp;edi=05a88f50
eip=66007502&nbsp;esp=04aac704&nbsp;ebp=04aac70c&nbsp;iopl=0&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;nz&nbsp;na&nbsp;po&nbsp;nc
cs=001b&nbsp;ss=0023&nbsp;ds=0023&nbsp;es=0023&nbsp;fs=003b&nbsp;gs=0000&nbsp;efl=00000202
jscript9!NativeCodeGenerator::CheckCodeGenDone+0x7:
66007502&nbsp;8b4114&nbsp;mov&nbsp;eax,dword&nbsp;ptr&nbsp;[ecx+14h]&nbsp;ds:0023:045c9d34=047e7120</pre><p style="text-indent:2em;text-align:left;"><span style="font-family:&#39;微软雅黑&#39;, &#39;Microsoft YaHei&#39;;font-size:14px;">ECX在这里是“this”指针</span></p><p style="text-indent:2em;text-align:left;"><span style="font-family:&#39;微软雅黑&#39;, &#39;Microsoft YaHei&#39;;font-size:14px;">所以我们从jscript9!NativeCodeGenerator::CheckCodeGenDone返回值，在这种情况下值为poi(poi(poi(this+0x14)+0x10)+0x04)，这就是被破坏的例子。</span></p><p style="text-indent:2em;text-align:left;"><span style="font-family:&#39;微软雅黑&#39;, &#39;Microsoft YaHei&#39;;font-size:14px;">我们可以通过执行指向CheckCodeGenDone的指针来确认这个假设：</span></p><pre class="brush:cpp;toolbar:false">0:007&gt;&nbsp;dd&nbsp;poi(poi(poi(073d9d20+0x14)+0x10)+4)
07560000&nbsp;&nbsp;????????&nbsp;????????&nbsp;????????&nbsp;????????
07560010&nbsp;&nbsp;????????&nbsp;????????&nbsp;????????&nbsp;????????
07560020&nbsp;&nbsp;????????&nbsp;????????&nbsp;????????&nbsp;????????
07560030&nbsp;&nbsp;????????&nbsp;????????&nbsp;????????&nbsp;????????
07560040&nbsp;&nbsp;????????&nbsp;????????&nbsp;????????&nbsp;????????
07560050&nbsp;&nbsp;????????&nbsp;????????&nbsp;????????&nbsp;????????
07560060&nbsp;&nbsp;????????&nbsp;????????&nbsp;????????&nbsp;????????
07560070&nbsp;&nbsp;????????&nbsp;????????&nbsp;????????&nbsp;????????</pre><p style="text-indent:2em;text-align:left;"><span style="font-family:&#39;微软雅黑&#39;, &#39;Microsoft YaHei&#39;;font-size:14px;">继续这个过程</span></p><pre class="brush:cpp;toolbar:false">(c8c.b84):&nbsp;Access&nbsp;violation&nbsp;-&nbsp;code&nbsp;c0000005&nbsp;(first&nbsp;chance)
First&nbsp;chance&nbsp;exceptions&nbsp;are&nbsp;reported&nbsp;before&nbsp;any&nbsp;exception&nbsp;handling.
This&nbsp;exception&nbsp;may&nbsp;be&nbsp;expected&nbsp;and&nbsp;handled.
eax=07560000&nbsp;ebx=073d9d20&nbsp;ecx=6600c76d&nbsp;edx=050aef84&nbsp;esi=00000003&nbsp;edi=04ecca3c
eip=07560000&nbsp;esp=04ecc864&nbsp;ebp=04ecc8b0&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;zr&nbsp;na&nbsp;pe&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00010246
07560000&nbsp;??&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;???</pre><p style="text-indent:2em;text-align:left;"><span style="font-family:&#39;微软雅黑&#39;, &#39;Microsoft YaHei&#39;;font-size:14px;">我们需要弄清楚它是如何被破坏的。让我们再次反弹调试器，重新在 jscript9!NativeCodeGenerator::CheckCodeGen这里下一个断点。破坏发生在第四个break，所以我们在第三个的时候就要检查这个指针。</span></p><pre class="brush:cpp;toolbar:false">0:007&gt;&nbsp;dd&nbsp;poi(poi(068c8d20&nbsp;+&nbsp;0x14)+0x10)+4
068a7124&nbsp;&nbsp;6600cc20&nbsp;00000002&nbsp;00000000&nbsp;068a7120
068a7134&nbsp;&nbsp;00000000&nbsp;0000011c&nbsp;018358b8&nbsp;068a3210
068a7144&nbsp;&nbsp;068a5121&nbsp;00000024&nbsp;068a4300&nbsp;00000000
068a7154&nbsp;&nbsp;068a6100&nbsp;00000000&nbsp;00000023&nbsp;00000000
068a7164&nbsp;&nbsp;00000001&nbsp;00000000&nbsp;05121ea7&nbsp;000004a7
068a7174&nbsp;&nbsp;0000002c&nbsp;0000001d&nbsp;00000003&nbsp;000004a7
068a7184&nbsp;&nbsp;0000002c&nbsp;050f76a0&nbsp;00002001&nbsp;00000000
068a7194&nbsp;&nbsp;068c8b80&nbsp;00000000&nbsp;00000000&nbsp;00000000</pre><p style="text-indent:2em;text-align:left;"><span style="font-family:&#39;微软雅黑&#39;, &#39;Microsoft YaHei&#39;;font-size:14px;">相关指针在这里是6600cc20。我们可以看看这这阵究竟指向什么</span></p><pre class="brush:cpp;toolbar:false">&nbsp;0:007&gt;&nbsp;dt&nbsp;6600cc20&nbsp;
Js::FunctionBody::EnsureDynamicInterpreterThunk</pre><p style="text-indent:2em;text-align:left;"><span style="font-family:&#39;微软雅黑&#39;, &#39;Microsoft YaHei&#39;;font-size:14px;">因此看起来在下一个代码路径调用这个函数时将会导致失败，我们可以设置一个断点看看这个值是从哪里来的：</span></p><pre class="brush:cpp;toolbar:false">0:007&gt;&nbsp;ba&nbsp;w&nbsp;4&nbsp;068a7124
Breakpoint&nbsp;1&nbsp;hit
eax=068d0000&nbsp;ebx=068a7120&nbsp;ecx=068a7160&nbsp;edx=068d0fc7&nbsp;esi=068a7120&nbsp;edi=05b4afcc
eip=6600cbc6&nbsp;esp=04ccab68&nbsp;ebp=04ccab98&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;nz&nbsp;na&nbsp;po&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000202
jscript9!Js::FunctionBody::GenerateDynamicInterpreterThunk+0x22:
6600cbc6&nbsp;f605405e3c6604&nbsp;&nbsp;test&nbsp;&nbsp;&nbsp;&nbsp;byte&nbsp;ptr&nbsp;[jscript9!Microsoft_JScriptEnableBits&nbsp;(663c5e40)],4&nbsp;ds:0023:663c5e40=00
0:007&gt;&nbsp;kv
ChildEBP&nbsp;RetAddr&nbsp;&nbsp;Args&nbsp;to&nbsp;Child&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
04ccab70&nbsp;6600cb7c&nbsp;d7314443&nbsp;04ccad94&nbsp;068c8d20&nbsp;jscript9!Js::FunctionBody::GenerateDynamicInterpreterThunk+0x22&nbsp;(FPO:&nbsp;[0,0,4])
04ccab98&nbsp;6600cbf7&nbsp;068a6100&nbsp;04ccad94&nbsp;00000003&nbsp;jscript9!Js::FunctionBody::EnsureDynamicInterpreterThunk+0x64&nbsp;(FPO:&nbsp;[Non-Fpo])
04ccabac&nbsp;6600cc2e&nbsp;068c8d20&nbsp;04ccac08&nbsp;660082cd&nbsp;jscript9!Js::InterpreterStackFrame::EnsureDynamicInterpreterThunk+0x1b&nbsp;(FPO:&nbsp;[Non-Fpo])
04ccabb8&nbsp;660082cd&nbsp;068c8d20&nbsp;00000003&nbsp;06d26f30&nbsp;jscript9!Js::InterpreterStackFrame::DelayDynamicInterpreterThunk+0xc&nbsp;(FPO:&nbsp;[2,0,0])
04ccac08&nbsp;66008a05&nbsp;00000003&nbsp;04ccad94&nbsp;d73143a7&nbsp;jscript9!Js::JavascriptFunction::CallFunction&lt;1&gt;+0x91&nbsp;(FPO:&nbsp;[Non-Fpo])
04ccac7c&nbsp;6600893f&nbsp;018358b8&nbsp;00000003&nbsp;04ccad94&nbsp;jscript9!Js::JavascriptFunction::CallRootFunction+0xc1&nbsp;(FPO:&nbsp;[Non-Fpo])
04ccacc4&nbsp;660088bf&nbsp;04ccacec&nbsp;00000003&nbsp;04ccad94&nbsp;jscript9!ScriptSite::CallRootFunction+0x42&nbsp;(FPO:&nbsp;[Non-Fpo])
04ccacf4&nbsp;6600d0f0&nbsp;068c8d20&nbsp;04ccad1c&nbsp;00000000&nbsp;jscript9!ScriptSite::Execute+0x61&nbsp;(FPO:&nbsp;[Non-Fpo])
04ccad50&nbsp;6600d02c&nbsp;00000003&nbsp;04ccad94&nbsp;00000000&nbsp;jscript9!ScriptEngineBase::ExecuteInternal&lt;0&gt;+0xbb&nbsp;(FPO:&nbsp;[Non-Fpo])
04ccad68&nbsp;66e32258&nbsp;0ad22de0&nbsp;068c8d20&nbsp;00000003&nbsp;jscript9!ScriptEngineBase::Execute+0x1c&nbsp;(FPO:&nbsp;[Non-Fpo])
04ccada8&nbsp;66e32166&nbsp;00000000&nbsp;04ccae74&nbsp;08d50bb8&nbsp;MSHTML!CMutationObserver::PerformMicrotaskCheckpoint+0x97&nbsp;(FPO:&nbsp;[Non-Fpo])
04ccae28&nbsp;66bb6f27&nbsp;00000000&nbsp;00000000&nbsp;04ccae74&nbsp;MSHTML!CObserverManager::InvokeObserversForCheckpoint+0x78&nbsp;(FPO:&nbsp;[Non-Fpo])
04ccae40&nbsp;66bb6297&nbsp;04ccaeb8&nbsp;66bb8080&nbsp;08cd4f6c&nbsp;MSHTML!CMarkup::CScriptExecution::LeaveScriptExecution+0xa8&nbsp;(FPO:&nbsp;[Non-Fpo])
04ccaeb0&nbsp;668cfe33&nbsp;04ccafc0&nbsp;08cd4f38&nbsp;08c60bb8&nbsp;MSHTML!CScriptData::Execute+0x33c&nbsp;(FPO:&nbsp;[Non-Fpo])
04ccaedc&nbsp;66bb77c7&nbsp;04ccafc0&nbsp;04ccaf00&nbsp;66a03870&nbsp;MSHTML!CScriptData::ScriptData_OnEnterTree+0x631&nbsp;(FPO:&nbsp;[Non-Fpo])
04ccaef4&nbsp;66fa2312&nbsp;04ccafc0&nbsp;06bc9bd0&nbsp;00000000&nbsp;MSHTML!CScriptElement::Notify+0x3e&nbsp;(FPO:&nbsp;[Non-Fpo])
04ccb208&nbsp;66eb70fb&nbsp;04ccb4a0&nbsp;00000000&nbsp;04ccb528&nbsp;MSHTML!CSpliceTreeEngine::InsertSplice+0x1403&nbsp;(FPO:&nbsp;[0,192,0])
04ccb330&nbsp;66ee39d9&nbsp;04ccb37c&nbsp;04ccb388&nbsp;08d50bb8&nbsp;MSHTML!CMarkup::SpliceTreeInternal+0xba&nbsp;(FPO:&nbsp;[6,69,4])
04ccb40c&nbsp;66896db2&nbsp;04ccb4a0&nbsp;04ccb458&nbsp;04ccb528&nbsp;MSHTML!CDoc::CutCopyMove+0x27f&nbsp;(FPO:&nbsp;[5,43,4])
04ccb428&nbsp;66a0cc0f&nbsp;04ccb4a0&nbsp;04ccb458&nbsp;04ccb528&nbsp;MSHTML!CDoc::Move+0x18&nbsp;(FPO:&nbsp;[Non-Fpo])
04ccb4e8&nbsp;66a0ca96&nbsp;04ccb528&nbsp;00000000&nbsp;04ccb618&nbsp;MSHTML!InsertDOMNodeHelper+0xef&nbsp;(FPO:&nbsp;[Non-Fpo])
04ccb5a8&nbsp;66a0cc73&nbsp;08cd4f38&nbsp;00000000&nbsp;00000003&nbsp;MSHTML!CElement::InsertBeforeHelper+0x22b&nbsp;(FPO:&nbsp;[Non-Fpo])
04ccb5cc&nbsp;66a0cff3&nbsp;08cd4f38&nbsp;00000001&nbsp;00000000&nbsp;MSHTML!CElement::InsertBefore+0x2f&nbsp;(FPO:&nbsp;[Non-Fpo])
04ccb660&nbsp;66a0cf06&nbsp;0ad22de0&nbsp;04ccb6a0&nbsp;00000002&nbsp;MSHTML!CElement::Var_appendChild+0xb3&nbsp;(FPO:&nbsp;[Non-Fpo])</pre><p style="text-indent:2em;text-align:left;"><span style="font-family:&#39;微软雅黑&#39;, &#39;Microsoft YaHei&#39;;font-size:14px;">实际上写入的是在这之前发生的一条指令。我们可以从分解的周围看到这个：</span></p><pre class="brush:cpp;toolbar:false">6600cbbe&nbsp;e8ec000000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;&nbsp;jscript9!InterpreterThunkEmitter::GetNextThunk&nbsp;(6600ccaf)
6600cbc3&nbsp;894304&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[ebx+4],eax
6600cbc6&nbsp;f605405e3c6604&nbsp;&nbsp;test&nbsp;&nbsp;&nbsp;&nbsp;byte&nbsp;ptr&nbsp;[jscript9!Microsoft_JScriptEnableBits&nbsp;(663c5e40)],4</pre><p style="text-indent:2em;text-align:left;"><span style="font-family:&#39;微软雅黑&#39;, &#39;Microsoft YaHei&#39;;font-size:14px;">注意EAX（068d0000）被转移到了[ EBX + 4 ]（068a7124。另外值得注意的是，我们仍然在 MSHTML!CElement::InsertBefore调用栈。</span></p><p style="text-indent:2em;text-align:left;"><span style="font-family:&#39;微软雅黑&#39;, &#39;Microsoft YaHei&#39;;font-size:14px;">jscript9!InterpreterThunkEmitter::GetNextThunk的返回值必然是无效的，让我们进行验证：</span></p><pre class="brush:cpp;toolbar:false">0:016&gt;&nbsp;bp&nbsp;&nbsp;jscript9!InterpreterThunkEmitter::GetNextThunk
Breakpoint&nbsp;0&nbsp;hit
eax=00000000&nbsp;ebx=04e07120&nbsp;ecx=055faed0&nbsp;edx=04e07160&nbsp;esi=04e07120&nbsp;edi=063f8fcc
eip=6600ccaf&nbsp;esp=0542a7d0&nbsp;ebp=0542a808&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;zr&nbsp;na&nbsp;pe&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000246
jscript9!InterpreterThunkEmitter::GetNextThunk:
6600ccaf&nbsp;8bff&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;edi,edi
0:007&gt;&nbsp;bp&nbsp;jscript9!InterpreterThunkEmitter::GetNextThunk+0x33
0:007&gt;&nbsp;pa
eax=00000000&nbsp;ebx=04e07120&nbsp;ecx=055faed0&nbsp;edx=04e07160&nbsp;esi=04e07120&nbsp;edi=063f8fcc
eip=6600ccb1&nbsp;esp=0542a7d0&nbsp;ebp=0542a808&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;zr&nbsp;na&nbsp;pe&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000246
jscript9!InterpreterThunkEmitter::GetNextThunk+0x2:
6600ccb1&nbsp;55&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;ebp
///&nbsp;SNIP&nbsp;///
eax=00000000&nbsp;ebx=04e07120&nbsp;ecx=055faed0&nbsp;edx=04e07160&nbsp;esi=04e07120&nbsp;edi=063f8fcc
eip=6600ccb5&nbsp;esp=0542a7c8&nbsp;ebp=0542a7cc&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;zr&nbsp;na&nbsp;pe&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000246
jscript9!InterpreterThunkEmitter::GetNextThunk+0x6:
6600ccb5&nbsp;8bf1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;esi,ecx
///&nbsp;SNIP&nbsp;///
eax=00000000&nbsp;ebx=04e07120&nbsp;ecx=000001f6&nbsp;edx=04e07160&nbsp;esi=055faed0&nbsp;edi=063f8fcc
eip=6600ccd0&nbsp;esp=0542a7c8&nbsp;ebp=0542a7cc&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;nz&nbsp;na&nbsp;pe&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000206
jscript9!InterpreterThunkEmitter::GetNextThunk+0x1d:
6600ccd0&nbsp;8b8620010000&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,dword&nbsp;ptr&nbsp;[esi+120h]&nbsp;ds:0023:055faff0=051a0000</pre><p style="text-indent:2em;text-align:left;"><span style="font-family:&#39;微软雅黑&#39;, &#39;Microsoft YaHei&#39;;font-size:14px;">如果我们看到堆的细节，会发现这个函数基本上返回的是这个实例的一个成员。</span></p><pre class="brush:cpp;toolbar:false">0:007&gt;&nbsp;!heap&nbsp;-p&nbsp;-a&nbsp;&nbsp;055faed0+0x120
&nbsp;&nbsp;&nbsp;&nbsp;address&nbsp;055faff0&nbsp;found&nbsp;in
&nbsp;&nbsp;&nbsp;&nbsp;_DPH_HEAP_ROOT&nbsp;@&nbsp;1771000
&nbsp;&nbsp;&nbsp;&nbsp;in&nbsp;busy&nbsp;allocation&nbsp;(&nbsp;&nbsp;DPH_HEAP_BLOCK:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UserAddr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UserSize&nbsp;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtAddr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtSize)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;17730d0:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;55faed0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;12c&nbsp;-&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;55fa000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2000
&nbsp;&nbsp;&nbsp;&nbsp;70eb8e89&nbsp;verifier!AVrfDebugPageHeapAllocate+0x00000229
&nbsp;&nbsp;&nbsp;&nbsp;779961fe&nbsp;ntdll!RtlDebugAllocateHeap+0x00000030
&nbsp;&nbsp;&nbsp;&nbsp;7795a6bb&nbsp;ntdll!RtlpAllocateHeap+0x000000c4
&nbsp;&nbsp;&nbsp;&nbsp;77925ca0&nbsp;ntdll!RtlAllocateHeap+0x0000023a
&nbsp;&nbsp;&nbsp;&nbsp;76ac9d45&nbsp;msvcrt!malloc+0x0000008d
&nbsp;&nbsp;&nbsp;&nbsp;6600048e&nbsp;jscript9!HeapAllocator::Alloc+0x0000000e
&nbsp;&nbsp;&nbsp;&nbsp;66088a96&nbsp;jscript9!Js::ScriptContext::InitializePostGlobal+0x000000b5
&nbsp;&nbsp;&nbsp;&nbsp;660889ca&nbsp;jscript9!Js::ScriptContext::Initialize+0x00000052
&nbsp;&nbsp;&nbsp;&nbsp;6608894e&nbsp;jscript9!ScriptEngine::EnsureScriptContext+0x000000e3
&nbsp;&nbsp;&nbsp;&nbsp;6608881b&nbsp;jscript9!ScriptSite::Init+0x00000026
&nbsp;&nbsp;&nbsp;&nbsp;660848a9&nbsp;jscript9!ScriptSite::Create+0x0000003f
&nbsp;&nbsp;&nbsp;&nbsp;6608485f&nbsp;jscript9!ScriptEngine::SetScriptSite+0x00000051
&nbsp;&nbsp;&nbsp;&nbsp;6698716d&nbsp;MSHTML!CActiveScriptHolder::Init+0x00000146
&nbsp;&nbsp;&nbsp;&nbsp;66986ef4&nbsp;MSHTML!CScriptCollection::GetHolderForLanguageHelper+0x000006a8
&nbsp;&nbsp;&nbsp;&nbsp;6697e3f1&nbsp;MSHTML!CScriptCollection::ParseScriptText+0x00000095
&nbsp;&nbsp;&nbsp;&nbsp;66bb6669&nbsp;MSHTML!CScriptData::CommitCode+0x00000370
&nbsp;&nbsp;&nbsp;&nbsp;66bb6204&nbsp;MSHTML!CScriptData::Execute+0x000002a9
&nbsp;&nbsp;&nbsp;&nbsp;66bb6ca4&nbsp;MSHTML!CHtmScriptParseCtx::Execute+0x00000130
&nbsp;&nbsp;&nbsp;&nbsp;669c2c60&nbsp;MSHTML!CHtmParseBase::Execute+0x00000196</pre><p style="text-indent:2em;text-align:left;"><span style="font-family:&#39;微软雅黑&#39;, &#39;Microsoft YaHei&#39;;font-size:14px;">我们可以看到这里的代码</span></p><pre class="brush:cpp;toolbar:false">0:007&gt;&nbsp;u&nbsp;poi(055faed0+0x120)
051a0000&nbsp;55&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;ebp
051a0001&nbsp;8bec&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ebp,esp
051a0003&nbsp;8b4508&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,dword&nbsp;ptr&nbsp;[ebp+8]
051a0006&nbsp;8b4014&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,dword&nbsp;ptr&nbsp;[eax+14h]
051a0009&nbsp;8b4840&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ecx,dword&nbsp;ptr&nbsp;[eax+40h]
051a000c&nbsp;8d4508&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lea&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,[ebp+8]
051a000f&nbsp;50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;eax
051a0010&nbsp;b8a0c70066&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,offset&nbsp;jscript9!Js::InterpreterStackFrame::InterpreterThunk&lt;1&gt;&nbsp;(6600c7a0)</pre><p style="text-indent: 2em; text-align: left;"><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">让我们继续这个进程，并中断内存访问的成员和这个指针（因为他们不在同一个回话中，所以偏移量是不同的）</span></p><pre class="brush:cpp;toolbar:false;">0:018&gt;&nbsp;ba&nbsp;r1&nbsp;04f5ced0&nbsp;&nbsp;&nbsp;;&nbsp;this&nbsp;ptr
0:018&gt;&nbsp;ba&nbsp;r1&nbsp;06c70000&nbsp;&nbsp;&nbsp;;&nbsp;this.annoying_member
Breakpoint&nbsp;2&nbsp;hit
eax=04f5cfe8&nbsp;ebx=00000000&nbsp;ecx=04f5ced0&nbsp;edx=00000000&nbsp;esi=04485240&nbsp;edi=04f5ced0
eip=660f7d6a&nbsp;esp=04e6c1a8&nbsp;ebp=04e6c1b4&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;zr&nbsp;na&nbsp;pe&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000246
jscript9!EmitBufferManager::FreeAllocations+0xf:
660f7d6a&nbsp;85f6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;test&nbsp;&nbsp;&nbsp;&nbsp;esi,esi</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">然后PTR断点被触发。让我们反汇编查看这个调用栈。</span></p><pre class="brush:cpp;toolbar:false;">0:007&gt;&nbsp;u&nbsp;660f7d6a&nbsp;-&nbsp;4
jscript9!EmitBufferManager::FreeAllocations+0xb:
660f7d66&nbsp;8bf9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;edi,ecx
660f7d68&nbsp;8b37&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;esi,dword&nbsp;ptr&nbsp;[edi]
660f7d6a&nbsp;85f6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;test&nbsp;&nbsp;&nbsp;&nbsp;esi,esi
660f7d6c&nbsp;0f85c21a0000&nbsp;&nbsp;&nbsp;&nbsp;jne&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jscript9!EmitBufferManager::FreeAllocations+0x21&nbsp;(660f9834)
660f7d72&nbsp;84db&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;test&nbsp;&nbsp;&nbsp;&nbsp;bl,bl
660f7d74&nbsp;7403&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;je&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jscript9!EmitBufferManager::FreeAllocations+0x1a&nbsp;(660f7d79)
660f7d76&nbsp;832700&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[edi],0
660f7d79&nbsp;5f&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pop&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;edi
0:007&gt;&nbsp;kv
ChildEBP&nbsp;RetAddr&nbsp;&nbsp;Args&nbsp;to&nbsp;Child&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
04e6c1b4&nbsp;660f8629&nbsp;00000000&nbsp;05bd0f68&nbsp;660f8b2c&nbsp;jscript9!EmitBufferManager::FreeAllocations+0xf&nbsp;(FPO:&nbsp;[Non-Fpo])
04e6c1c0&nbsp;660f8b2c&nbsp;7ab2217d&nbsp;04f3a8b8&nbsp;05bd0f68&nbsp;jscript9!InterpreterThunkEmitter::Close+0x30&nbsp;(FPO:&nbsp;[0,0,4])
04e6c1f0&nbsp;660f7d1a&nbsp;7ab22291&nbsp;04f3cf98&nbsp;04f3a8b8&nbsp;jscript9!Js::ScriptContext::InternalClose+0x76&nbsp;(FPO:&nbsp;[Non-Fpo])
04e6c21c&nbsp;660f8d53&nbsp;00000000&nbsp;00000000&nbsp;660f8a3c&nbsp;jscript9!Js::ScriptContext::Close+0x38&nbsp;(FPO:&nbsp;[Non-Fpo])
04e6c228&nbsp;660f8a3c&nbsp;7ab222fd&nbsp;04e6c278&nbsp;660f8cc0&nbsp;jscript9!Js::ScriptContext::MarkForClose+0x3d&nbsp;(FPO:&nbsp;[0,0,4])
04e6c270&nbsp;660f883f&nbsp;04e6c2cc&nbsp;04ea2dfc&nbsp;07b83ac8&nbsp;jscript9!ScriptSite::Close+0x147&nbsp;(FPO:&nbsp;[Non-Fpo])
04e6c298&nbsp;660f7e0b&nbsp;7ab2224d&nbsp;04e6c2cc&nbsp;660f7de0&nbsp;jscript9!ScriptEngine::CloseInternal+0xbc&nbsp;(FPO:&nbsp;[Non-Fpo])
04e6c2c0&nbsp;66b7d47b&nbsp;04ea2dfc&nbsp;04e6c2f0&nbsp;65ffa790&nbsp;jscript9!ScriptEngine::Close+0x2b&nbsp;(FPO:&nbsp;[Non-Fpo])
04e6c2e8&nbsp;66b7dd05&nbsp;07b83ac8&nbsp;66b7db00&nbsp;04e6c320&nbsp;MSHTML!CActiveScriptHolder::Close+0x6b&nbsp;(FPO:&nbsp;[Non-Fpo])
04e6c318&nbsp;66b7d4f8&nbsp;08d44fa8&nbsp;08d44fa8&nbsp;050adbb8&nbsp;MSHTML!CJScript9Holder::Close+0x220&nbsp;(FPO:&nbsp;[Non-Fpo])
04e6c334&nbsp;67059005&nbsp;00000000&nbsp;66ebe337&nbsp;06b78f68&nbsp;MSHTML!CScriptCollection::~CScriptCollection+0x3f&nbsp;(FPO:&nbsp;[Non-Fpo])
04e6c34c&nbsp;6698199a&nbsp;08d44fa8&nbsp;04e6c3b8&nbsp;667fda00&nbsp;MSHTML!CScriptCollection::SubRelease+0x83631c
04e6c3b0&nbsp;66981431&nbsp;06abdbd0&nbsp;091cef48&nbsp;06abdbec&nbsp;MSHTML!CMarkup::OnLoadStatusDone+0x52c&nbsp;(FPO:&nbsp;[Non-Fpo])
04e6c3c4&nbsp;6698078b&nbsp;00000004&nbsp;06bd2f98&nbsp;04e6c824&nbsp;MSHTML!CMarkup::OnLoadStatus+0xfa&nbsp;(FPO:&nbsp;[Non-Fpo])
04e6c808&nbsp;6697a322&nbsp;10000019&nbsp;04e6c860&nbsp;667fe541&nbsp;MSHTML!CProgSink::DoUpdate+0x4c7&nbsp;(FPO:&nbsp;[Non-Fpo])
04e6c814&nbsp;667fe541&nbsp;091cef48&nbsp;091cef48&nbsp;06a7acc8&nbsp;MSHTML!CProgSink::OnMethodCall+0x12&nbsp;(FPO:&nbsp;[2,0,0])
04e6c860&nbsp;667fde4a&nbsp;7aa93778&nbsp;04e6c92c&nbsp;00008002&nbsp;MSHTML!GlobalWndOnMethodCall+0x16d&nbsp;(FPO:&nbsp;[Non-Fpo])
04e6c8b0&nbsp;77a6c4e7&nbsp;01300252&nbsp;00008002&nbsp;00000000&nbsp;MSHTML!GlobalWndProc+0x2e5&nbsp;(FPO:&nbsp;[Non-Fpo])
04e6c8dc&nbsp;77a6c5e7&nbsp;667fd020&nbsp;01300252&nbsp;00008002&nbsp;user32!InternalCallWinProc+0x23</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">所以的确出现了我们的这个指针被释放的情况<br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">当我们破坏了这个空闲空间的顶部，我们仍然可以检查令人头疼的成员，并且可以观察到它仍然包含代码<br/></span></p><pre class="brush:cpp;toolbar:false">0:007&gt;&nbsp;dd&nbsp;poi(04f5ced0+120)
06c70000&nbsp;&nbsp;8bec8b55&nbsp;408b0845&nbsp;40488b14&nbsp;5008458d
06c70010&nbsp;&nbsp;00c7a0b8&nbsp;ffe1ff66&nbsp;0fd2e9d0&nbsp;ff900000
06c70020&nbsp;&nbsp;0fcae9d0&nbsp;ff900000&nbsp;0fc2e9d0&nbsp;ff900000
06c70030&nbsp;&nbsp;0fbae9d0&nbsp;ff900000&nbsp;0fb2e9d0&nbsp;ff900000
06c70040&nbsp;&nbsp;0faae9d0&nbsp;ff900000&nbsp;0fa2e9d0&nbsp;ff900000
06c70050&nbsp;&nbsp;0f9ae9d0&nbsp;ff900000&nbsp;0f92e9d0&nbsp;ff900000
06c70060&nbsp;&nbsp;0f8ae9d0&nbsp;ff900000&nbsp;0f82e9d0&nbsp;ff900000
06c70070&nbsp;&nbsp;0f7ae9d0&nbsp;ff900000&nbsp;0f72e9d0&nbsp;ff900000</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">现在让我们滚出FreeAllocatioins()吧。<br/>0:007&gt; gu<br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">再次检查<br/></span></p><pre class="brush:cpp;toolbar:false">0:007&gt;&nbsp;dd&nbsp;poi(04f5ced0+120)
06c70000&nbsp;&nbsp;????????&nbsp;????????&nbsp;????????&nbsp;????????
06c70010&nbsp;&nbsp;????????&nbsp;????????&nbsp;????????&nbsp;????????
06c70020&nbsp;&nbsp;????????&nbsp;????????&nbsp;????????&nbsp;????????
06c70030&nbsp;&nbsp;????????&nbsp;????????&nbsp;????????&nbsp;????????
06c70040&nbsp;&nbsp;????????&nbsp;????????&nbsp;????????&nbsp;????????
06c70050&nbsp;&nbsp;????????&nbsp;????????&nbsp;????????&nbsp;????????
06c70060&nbsp;&nbsp;????????&nbsp;????????&nbsp;????????&nbsp;????????
06c70070&nbsp;&nbsp;????????&nbsp;????????&nbsp;????????&nbsp;????????</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">酷！我们的内存确实被释放了，让我们继续执行相应措施<br/></span></p><pre class="brush:cpp;toolbar:false">0:007&gt;&nbsp;g
(820.9ec):&nbsp;Access&nbsp;violation&nbsp;-&nbsp;code&nbsp;c0000005&nbsp;(first&nbsp;chance)
First&nbsp;chance&nbsp;exceptions&nbsp;are&nbsp;reported&nbsp;before&nbsp;any&nbsp;exception&nbsp;handling.
This&nbsp;exception&nbsp;may&nbsp;be&nbsp;expected&nbsp;and&nbsp;handled.
eax=06c70000&nbsp;ebx=046f9d20&nbsp;ecx=6600c76d&nbsp;edx=04f50f84&nbsp;esi=00000003&nbsp;edi=04e6c774
eip=06c70000&nbsp;esp=04e6c59c&nbsp;ebp=04e6c5e8&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;zr&nbsp;na&nbsp;pe&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00010246
06c70000&nbsp;??&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;???</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">现在奇怪的是什么呢？是尽管我们的内存断点没有被激活，但那里还是没有关于06c70000的pageheap的信息。让我们从一个开始崩溃的地方下一个断点：。<br/></span></p><pre class="brush:cpp;toolbar:false">0:015&gt;&nbsp;bp&nbsp;&nbsp;jscript9!EmitBufferManager::FreeAllocations
0:015&gt;&nbsp;g
(6ac.93c):&nbsp;C++&nbsp;EH&nbsp;exception&nbsp;-&nbsp;code&nbsp;e06d7363&nbsp;(first&nbsp;chance)
Breakpoint&nbsp;0&nbsp;hit
eax=056fafe8&nbsp;ebx=00000000&nbsp;ecx=056faed0&nbsp;edx=00000000&nbsp;esi=056faed0&nbsp;edi=056308b8
eip=666c7d5b&nbsp;esp=0562c120&nbsp;ebp=0562c158&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;zr&nbsp;na&nbsp;pe&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000246
jscript9!EmitBufferManager::FreeAllocations:
666c7d5b&nbsp;8bff&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;edi,edi
0:007&gt;&nbsp;dd&nbsp;@ecx
056faed0&nbsp;&nbsp;04da5240&nbsp;05630a60&nbsp;00000000&nbsp;665d21c8
056faee0&nbsp;&nbsp;0572cfd0&nbsp;0572cfd0&nbsp;056faee8&nbsp;056faee8
056faef0&nbsp;&nbsp;056faef0&nbsp;056faef0&nbsp;056faef8&nbsp;056faef8
056faf00&nbsp;&nbsp;056faf00&nbsp;056faf00&nbsp;00000020&nbsp;00000000
056faf10&nbsp;&nbsp;00000000&nbsp;0000001f&nbsp;00000000&nbsp;c0000000
056faf20&nbsp;&nbsp;00000000&nbsp;00000000&nbsp;01000000&nbsp;00000000
056faf30&nbsp;&nbsp;00000001&nbsp;00001000&nbsp;c0c0c000&nbsp;05630a60
056faf40&nbsp;&nbsp;056faf40&nbsp;056faf40&nbsp;056faf48&nbsp;056faf48
0:007&gt;&nbsp;dd&nbsp;@ecx+120
056faff0&nbsp;&nbsp;053e0000&nbsp;05630a60&nbsp;000001f6&nbsp;d0d0d0d0
056fb000&nbsp;&nbsp;????????&nbsp;????????&nbsp;????????&nbsp;????????
056fb010&nbsp;&nbsp;????????&nbsp;????????&nbsp;????????&nbsp;????????
056fb020&nbsp;&nbsp;????????&nbsp;????????&nbsp;????????&nbsp;????????
056fb030&nbsp;&nbsp;????????&nbsp;????????&nbsp;????????&nbsp;????????
056fb040&nbsp;&nbsp;????????&nbsp;????????&nbsp;????????&nbsp;????????
056fb050&nbsp;&nbsp;????????&nbsp;????????&nbsp;????????&nbsp;????????
056fb060&nbsp;&nbsp;????????&nbsp;????????&nbsp;????????&nbsp;????????
0:007&gt;&nbsp;dd&nbsp;poi(@ecx+120)
053e0000&nbsp;&nbsp;8bec8b55&nbsp;408b0845&nbsp;40488b14&nbsp;5008458d
053e0010&nbsp;&nbsp;5dc7a0b8&nbsp;ffe1ff66&nbsp;0fd2e9d0&nbsp;ff900000
053e0020&nbsp;&nbsp;0fcae9d0&nbsp;ff900000&nbsp;0fc2e9d0&nbsp;ff900000
053e0030&nbsp;&nbsp;0fbae9d0&nbsp;ff900000&nbsp;0fb2e9d0&nbsp;ff900000
053e0040&nbsp;&nbsp;0faae9d0&nbsp;ff900000&nbsp;0fa2e9d0&nbsp;ff900000
053e0050&nbsp;&nbsp;0f9ae9d0&nbsp;ff900000&nbsp;0f92e9d0&nbsp;ff900000
053e0060&nbsp;&nbsp;0f8ae9d0&nbsp;ff900000&nbsp;0f82e9d0&nbsp;ff900000
053e0070&nbsp;&nbsp;0f7ae9d0&nbsp;ff900000&nbsp;0f72e9d0&nbsp;ff900000</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">这里的 poi(@ecx+120) 是我们期望的代码. 让我们在056faff0下一个断点，它包含了那段代码中的ptr<br/></span></p><pre class="brush:cpp;toolbar:false">0:007&gt;&nbsp;ba&nbsp;w1&nbsp;056faff0
0:007&gt;&nbsp;g
Breakpoint&nbsp;1&nbsp;hit
eax=056faedc&nbsp;ebx=00000000&nbsp;ecx=056fafb8&nbsp;edx=04da5210&nbsp;esi=056faed0&nbsp;edi=056308b8
eip=666c8630&nbsp;esp=0562c128&nbsp;ebp=0562c158&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;zr&nbsp;na&nbsp;pe&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000246
jscript9!InterpreterThunkEmitter::Close+0x37:
666c8630&nbsp;83a62801000000&nbsp;&nbsp;and&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[esi+128h],0&nbsp;ds:0023:056faff8=000001f6
0:007&gt;&nbsp;dd&nbsp;056faff0&nbsp;&nbsp;
056faff0&nbsp;&nbsp;00000000&nbsp;05630a60&nbsp;000001f6&nbsp;d0d0d0d0
056fb000&nbsp;&nbsp;????????&nbsp;????????&nbsp;????????&nbsp;????????
056fb010&nbsp;&nbsp;????????&nbsp;????????&nbsp;????????&nbsp;????????
056fb020&nbsp;&nbsp;????????&nbsp;????????&nbsp;????????&nbsp;????????
056fb030&nbsp;&nbsp;????????&nbsp;????????&nbsp;????????&nbsp;????????
056fb040&nbsp;&nbsp;????????&nbsp;????????&nbsp;????????&nbsp;????????
056fb050&nbsp;&nbsp;????????&nbsp;????????&nbsp;????????&nbsp;????????
056fb060&nbsp;&nbsp;????????&nbsp;????????&nbsp;????????&nbsp;????????</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">好了，我们的ptr对象在jscript9!InterpreterThunkEmitter::Close中已经为null了。<br/></span></p><pre class="brush:cpp;toolbar:false">0:007&gt;&nbsp;kv
ChildEBP&nbsp;RetAddr&nbsp;&nbsp;Args&nbsp;to&nbsp;Child&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
0562c128&nbsp;666c8b2c&nbsp;ef1f07e1&nbsp;056308b8&nbsp;063e0f68&nbsp;jscript9!InterpreterThunkEmitter::Close+0x37&nbsp;(FPO:&nbsp;[0,0,4])
0562c158&nbsp;666c7d1a&nbsp;ef1f073d&nbsp;00788f98&nbsp;056308b8&nbsp;jscript9!Js::ScriptContext::InternalClose+0x76&nbsp;(FPO:&nbsp;[Non-Fpo])
0562c184&nbsp;666c8d53&nbsp;00000000&nbsp;00000000&nbsp;666c8a3c&nbsp;jscript9!Js::ScriptContext::Close+0x38&nbsp;(FPO:&nbsp;[Non-Fpo])
0562c190&nbsp;666c8a3c&nbsp;ef1f0761&nbsp;0562c1e0&nbsp;666c8cc0&nbsp;jscript9!Js::ScriptContext::MarkForClose+0x3d&nbsp;(FPO:&nbsp;[0,0,4])
0562c1d8&nbsp;666c883f&nbsp;0562c234&nbsp;00786dfc&nbsp;09402ac8&nbsp;jscript9!ScriptSite::Close+0x147&nbsp;(FPO:&nbsp;[Non-Fpo])
0562c200&nbsp;666c7e0b&nbsp;ef1f0491&nbsp;0562c234&nbsp;666c7de0&nbsp;jscript9!ScriptEngine::CloseInternal+0xbc&nbsp;(FPO:&nbsp;[Non-Fpo])
0562c228&nbsp;6b0bd47b&nbsp;00786dfc&nbsp;0562c258&nbsp;665ca790&nbsp;jscript9!ScriptEngine::Close+0x2b&nbsp;(FPO:&nbsp;[Non-Fpo])
0562c250&nbsp;6b0bdd05&nbsp;09402ac8&nbsp;6b0bdb00&nbsp;0562c288&nbsp;MSHTML!CActiveScriptHolder::Close+0x6b&nbsp;(FPO:&nbsp;[Non-Fpo])
0562c280&nbsp;6b0bd4f8&nbsp;08aeefa8&nbsp;08aeefa8&nbsp;0586dbb8&nbsp;MSHTML!CJScript9Holder::Close+0x220&nbsp;(FPO:&nbsp;[Non-Fpo])
0562c29c&nbsp;6b599005&nbsp;00000000&nbsp;6b3fe337&nbsp;07459f68&nbsp;MSHTML!CScriptCollection::~CScriptCollection+0x3f&nbsp;(FPO:&nbsp;[Non-Fpo])
0562c2b4&nbsp;6aec199a&nbsp;08aeefa8&nbsp;0562c320&nbsp;6ad3da00&nbsp;MSHTML!CScriptCollection::SubRelease+0x83631c
0562c318&nbsp;6aec1431&nbsp;0739ebd0&nbsp;08acef48&nbsp;0739ebec&nbsp;MSHTML!CMarkup::OnLoadStatusDone+0x52c&nbsp;(FPO:&nbsp;[Non-Fpo])
0562c32c&nbsp;6aec078b&nbsp;00000004&nbsp;075d4f98&nbsp;0562c78c&nbsp;MSHTML!CMarkup::OnLoadStatus+0xfa&nbsp;(FPO:&nbsp;[Non-Fpo])
0562c770&nbsp;6aeba322&nbsp;10000019&nbsp;0562c7c8&nbsp;6ad3e541&nbsp;MSHTML!CProgSink::DoUpdate+0x4c7&nbsp;(FPO:&nbsp;[Non-Fpo])
0562c77c&nbsp;6ad3e541&nbsp;08acef48&nbsp;08acef48&nbsp;0735bcc8&nbsp;MSHTML!CProgSink::OnMethodCall+0x12&nbsp;(FPO:&nbsp;[2,0,0])
0562c7c8&nbsp;6ad3de4a&nbsp;ef37235b&nbsp;0562c894&nbsp;00008002&nbsp;MSHTML!GlobalWndOnMethodCall+0x16d&nbsp;(FPO:&nbsp;[Non-Fpo])
0562c818&nbsp;7684c4e7&nbsp;000e02de&nbsp;00008002&nbsp;00000000&nbsp;MSHTML!GlobalWndProc+0x2e5&nbsp;(FPO:&nbsp;[Non-Fpo])
0562c844&nbsp;7684c5e7&nbsp;6ad3d020&nbsp;000e02de&nbsp;00008002&nbsp;user32!InternalCallWinProc+0x23
0562c8bc&nbsp;7684cc19&nbsp;00000000&nbsp;6ad3d020&nbsp;000e02de&nbsp;user32!UserCallWinProcCheckWow+0x14b&nbsp;(FPO:&nbsp;[Non-Fpo])
0562c91c&nbsp;7684cc70&nbsp;6ad3d020&nbsp;00000000&nbsp;0562fafc&nbsp;user32!DispatchMessageWorker+0x35e&nbsp;(FPO:&nbsp;[Non-Fpo])
0562c92c&nbsp;6ddcf7c8&nbsp;0562c96c&nbsp;0077ee48&nbsp;051cefe0&nbsp;user32!DispatchMessageW+0xf&nbsp;(FPO:&nbsp;[Non-Fpo])
0562fafc&nbsp;6df1f738&nbsp;0562fbc8&nbsp;6df1f3b0&nbsp;00780ff0&nbsp;IEFRAME!CTabWindow::_TabWindowThreadProc+0x464&nbsp;(FPO:&nbsp;[Non-Fpo])
0562fbbc&nbsp;7643e61c&nbsp;0077ee48&nbsp;0562fbe0&nbsp;6df230d0&nbsp;IEFRAME!LCIETab_ThreadProc+0x37b&nbsp;(FPO:&nbsp;[Non-Fpo])
0562fbd4&nbsp;70833991&nbsp;00780ff0&nbsp;00000000&nbsp;00000000&nbsp;iertutil!_IsoThreadProc_WrapperToReleaseScope+0x1c&nbsp;(FPO:&nbsp;[Non-Fpo])
0562fc0c&nbsp;760cee6c&nbsp;050eefe8&nbsp;0562fc58&nbsp;77b7399b&nbsp;IEShims!NS_CreateThread::DesktopIE_ThreadProc+0x94&nbsp;(FPO:&nbsp;[Non-Fpo])
0562fc18&nbsp;77b7399b&nbsp;050eefe8&nbsp;72ca3051&nbsp;00000000&nbsp;kernel32!BaseThreadInitThunk+0xe&nbsp;(FPO:&nbsp;[Non-Fpo])
0562fc58&nbsp;77b7396e&nbsp;70833900&nbsp;050eefe8&nbsp;ffffffff&nbsp;ntdll!__RtlUserThreadStart+0x70&nbsp;(FPO:&nbsp;[Non-Fpo])
0562fc70&nbsp;00000000&nbsp;70833900&nbsp;050eefe8&nbsp;00000000&nbsp;ntdll!_RtlUserThreadStart+0x1b&nbsp;(FPO:&nbsp;[Non-Fpo])</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">这看起来是正常合理的，既然这样那么到底给出了些什么信息呢？<br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">诀窍就在我们前面讨论的调用栈中，我们看到令我们头疼的区域被释放了。让我们再看看<br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;"><br/></span></p><pre class="brush:cpp;toolbar:false">60f8629&nbsp;00000000&nbsp;05bd0f68&nbsp;660f8b2c&nbsp;jscript9!EmitBufferManager::FreeAllocations+0xf&nbsp;(FPO:&nbsp;[Non-Fpo])
04e6c1c0&nbsp;660f8b2c&nbsp;7ab2217d&nbsp;04f3a8b8&nbsp;05bd0f68&nbsp;jscript9!InterpreterThunkEmitter::Close+0x30&nbsp;(FPO:&nbsp;[0,0,4])
04e6c1f0&nbsp;660f7d1a&nbsp;7ab22291&nbsp;04f3cf98&nbsp;04f3a8b8&nbsp;jscript9!Js::ScriptContext::InternalClose+0x76&nbsp;(FPO:&nbsp;[Non-Fpo])
04e6c21c&nbsp;660f8d53&nbsp;00000000&nbsp;00000000&nbsp;660f8a3c&nbsp;jscript9!Js::ScriptContext::Close+0x38&nbsp;(FPO:&nbsp;[Non-Fpo])
04e6c228&nbsp;660f8a3c&nbsp;7ab222fd&nbsp;04e6c278&nbsp;660f8cc0&nbsp;jscript9!Js::ScriptContext::MarkForClose+0x3d&nbsp;(FPO:&nbsp;[0,0,4])
04e6c270&nbsp;660f883f&nbsp;04e6c2cc&nbsp;04ea2dfc&nbsp;07b83ac8&nbsp;jscript9!ScriptSite::Close+0x147&nbsp;(FPO:&nbsp;[Non-Fpo])
04e6c298&nbsp;660f7e0b&nbsp;7ab2224d&nbsp;04e6c2cc&nbsp;660f7de0&nbsp;jscript9!ScriptEngine::CloseInternal+0xbc&nbsp;(FPO:&nbsp;[Non-Fpo])
04e6c2c0&nbsp;66b7d47b&nbsp;04ea2dfc&nbsp;04e6c2f0&nbsp;65ffa790&nbsp;jscript9!ScriptEngine::Close+0x2b&nbsp;(FPO:&nbsp;[Non-Fpo])
04e6c2e8&nbsp;66b7dd05&nbsp;07b83ac8&nbsp;66b7db00&nbsp;04e6c320&nbsp;MSHTML!CActiveScriptHolder::Close+0x6b&nbsp;(FPO:&nbsp;[Non-Fpo])
04e6c318&nbsp;66b7d4f8&nbsp;08d44fa8&nbsp;08d44fa8&nbsp;050adbb8&nbsp;MSHTML!CJScript9Holder::Close+0x220&nbsp;(FPO:&nbsp;[Non-Fpo])
04e6c334&nbsp;67059005&nbsp;00000000&nbsp;66ebe337&nbsp;06b78f68&nbsp;MSHTML!CScriptCollection::~CScriptCollection+0x3f&nbsp;(FPO:&nbsp;[Non-Fpo])
04e6c34c&nbsp;6698199a&nbsp;08d44fa8&nbsp;04e6c3b8&nbsp;667fda00&nbsp;MSHTML!CScriptCollection::SubRelease+0x83631c
04e6c3b0&nbsp;66981431&nbsp;06abdbd0&nbsp;091cef48&nbsp;06abdbec&nbsp;MSHTML!CMarkup::OnLoadStatusDone+0x52c&nbsp;(FPO:&nbsp;[Non-Fpo])
04e6c3c4&nbsp;6698078b&nbsp;00000004&nbsp;06bd2f98&nbsp;04e6c824&nbsp;MSHTML!CMarkup::OnLoadStatus+0xfa&nbsp;(FPO:&nbsp;[Non-Fpo])
04e6c808&nbsp;6697a322&nbsp;10000019&nbsp;04e6c860&nbsp;667fe541&nbsp;MSHTML!CProgSink::DoUpdate+0x4c7&nbsp;(FPO:&nbsp;[Non-Fpo])
04e6c814&nbsp;667fe541&nbsp;091cef48&nbsp;091cef48&nbsp;06a7acc8&nbsp;MSHTML!CProgSink::OnMethodCall+0x12&nbsp;(FPO:&nbsp;[2,0,0])
04e6c860&nbsp;667fde4a&nbsp;7aa93778&nbsp;04e6c92c&nbsp;00008002&nbsp;MSHTML!GlobalWndOnMethodCall+0x16d&nbsp;(FPO:&nbsp;[Non-Fpo])
04e6c8b0&nbsp;77a6c4e7&nbsp;01300252&nbsp;00008002&nbsp;00000000&nbsp;MSHTML!GlobalWndProc+0x2e5&nbsp;(FPO:&nbsp;[Non-Fpo])
04e6c8dc&nbsp;77a6c5e7&nbsp;667fd020&nbsp;01300252&nbsp;00008002&nbsp;user32!InternalCallWinProc+0x23</pre><p><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">jscript9!EmitBufferManager::FreeAllocations究竟做了些什么？<br/></span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">仔细检查IDA，我们可以发现它做了两件事的其中之一：<br/>(1)<br/></span></p><pre class="brush:cpp;toolbar:false">push&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[esi]&nbsp;;&nbsp;struct&nbsp;CustomHeap::Allocation&nbsp;*
mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ecx,&nbsp;eax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;this
call&nbsp;&nbsp;&nbsp;&nbsp;?Free@Heap@CustomHeap@@QAE_NPAUAllocation@2@@Z&nbsp;;&nbsp;CustomHeap::Heap::Free(CustomHeap::Allocation&nbsp;*)
jmp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;short&nbsp;loc_10109839
;&nbsp;END&nbsp;OF&nbsp;FUNCTION&nbsp;CHUNK&nbsp;FOR&nbsp;?FreeAllocations@EmitBufferManager@@AAEX_N@Z</pre><p><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">--- OR ---</span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">(2)<br/></span></p><pre class="brush:cpp;toolbar:false">push&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[esi]
mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ecx,&nbsp;eax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;this
call&nbsp;&nbsp;&nbsp;&nbsp;?Decommit@Heap@CustomHeap@@QAE_NPAUAllocation@2@@Z&nbsp;;&nbsp;CustomHeap::Heap::Decommit(CustomHeap::Allocation&nbsp;*)
jmp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;loc_10109839
;&nbsp;END&nbsp;OF&nbsp;FUNCTION&nbsp;CHUNK&nbsp;FOR&nbsp;?FreeAllocations@EmitBufferManager@@AAEX_N@Z</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">行，那么，之所以我们没有堆信息页，是因为故障是发生自JSCRIPT9的自定义堆里面的。这有一定的道理<br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">现在我们知道，我们正是在试图访问已经被CustonHeap::Heap::Free释放了的内存，但是它又被分配到哪里去了呢？<br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">从逻辑上讲，如果他是用 jscript9!EmitBufferManager::FreeAllocations来释放的内存，那么它一定会被比如jscript9!EmitBufferManager::这类的代码分配。<br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">浏览标识符，我们发现了相关函数NewAllocation，并且下了断点。<br/></span></p><pre class="brush:cpp;toolbar:false">0:015&gt;&nbsp;bp&nbsp;jscript9!EmitBufferManager::NewAllocation
0:015&gt;&nbsp;g
ModLoad:&nbsp;6c410000&nbsp;6c44c000&nbsp;C:\Windows\system32\OLEACC.DLL
ModLoad:&nbsp;75a00000&nbsp;75a5f000&nbsp;C:\Windows\system32\SXS.DLL
ModLoad:&nbsp;6c470000&nbsp;6c4fc000&nbsp;C:\Windows\system32\uiautomationcore.dll
ModLoad:&nbsp;77ca0000&nbsp;77ca5000&nbsp;C:\Windows\system32\PSAPI.DLL
Breakpoint&nbsp;0&nbsp;hit
eax=0553bcf8&nbsp;ebx=07365000&nbsp;ecx=0614aed0&nbsp;edx=07365040&nbsp;esi=00000000&nbsp;edi=0614aed0
eip=662f1688&nbsp;esp=0553bca8&nbsp;ebp=0553bccc&nbsp;iopl=0&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;zr&nbsp;na&nbsp;pe&nbsp;nc
cs=001b&nbsp;ss=0023&nbsp;ds=0023&nbsp;es=0023&nbsp;fs=003b&nbsp;gs=0000&nbsp;efl=00000246
jscript9!EmitBufferManager::NewAllocation:
662f1688&nbsp;6a08&nbsp;push&nbsp;8</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">酷！让我们转到上一级<br/></span></p><pre class="brush:cpp;toolbar:false">0:007&gt;&nbsp;gu
eax=06185240&nbsp;ebx=07725000&nbsp;ecx=65fa16df&nbsp;edx=00000018&nbsp;esi=00000000&nbsp;edi=0644eed0
eip=65fa1627&nbsp;esp=0570bfd8&nbsp;ebp=0570bfec&nbsp;iopl=0&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;zr&nbsp;na&nbsp;pe&nbsp;nc
cs=001b&nbsp;ss=0023&nbsp;ds=0023&nbsp;es=0023&nbsp;fs=003b&nbsp;gs=0000&nbsp;efl=00000246
jscript9!EmitBufferManager::AllocateBuffer+0x37:
65fa1627&nbsp;8bf0&nbsp;mov&nbsp;esi,eax</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">一切顺利，现在让我们检查一下我们的返回值<br/></span></p><pre class="brush:cpp;toolbar:false">0:007&gt;&nbsp;dd&nbsp;@eax
05055240&nbsp;05055230&nbsp;00000000&nbsp;00001000&nbsp;00000000
05055250&nbsp;00000000&nbsp;00000000&nbsp;00000000&nbsp;00000000
05055260&nbsp;00000000&nbsp;00000000&nbsp;00000000&nbsp;00000000
05055270&nbsp;00000000&nbsp;00000000&nbsp;00000000&nbsp;00000000
05055280&nbsp;00000000&nbsp;00000000&nbsp;00000000&nbsp;00000000
05055290&nbsp;00000000&nbsp;00000000&nbsp;00000000&nbsp;00000000
050552a0&nbsp;00000000&nbsp;00000000&nbsp;00000000&nbsp;00000000
050552b0&nbsp;00000000&nbsp;00000000&nbsp;00000000&nbsp;00000000
0:007&gt;&nbsp;dd&nbsp;poi(@eax)
05055230&nbsp;05055218&nbsp;00000000&nbsp;07860000&nbsp;00001000
05055240&nbsp;05055230&nbsp;00000000&nbsp;00001000&nbsp;00000000
05055250&nbsp;00000000&nbsp;00000000&nbsp;00000000&nbsp;00000000
05055260&nbsp;00000000&nbsp;00000000&nbsp;00000000&nbsp;00000000
05055270&nbsp;00000000&nbsp;00000000&nbsp;00000000&nbsp;00000000
05055280&nbsp;00000000&nbsp;00000000&nbsp;00000000&nbsp;00000000
05055290&nbsp;00000000&nbsp;00000000&nbsp;00000000&nbsp;00000000
050552a0&nbsp;00000000&nbsp;00000000&nbsp;00000000&nbsp;00000000
&nbsp;
0:007&gt;&nbsp;!heap&nbsp;-p&nbsp;-a&nbsp;@eax
&nbsp;
0:007&gt;&nbsp;!heap&nbsp;-p&nbsp;-a&nbsp;poi(@eax)
&nbsp;
0:007&gt;&nbsp;!heap&nbsp;-p&nbsp;-a&nbsp;poi(@eax)+8</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">我们可以看到我们的不受信任的堆值潜伏在那里，不出所料的是那里没有可怕的pageheap跟踪信息。让我们跟到另一层去<br/></span></p><pre class="brush:cpp;toolbar:false">//&nbsp;Snip&nbsp;//
0:007&gt;&nbsp;p
eax=05055240&nbsp;ebx=07365000&nbsp;ecx=07860000&nbsp;edx=00000018&nbsp;esi=0614aed0&nbsp;edi=062eafcc
eip=66393240&nbsp;esp=0553bce8&nbsp;ebp=0553bd00&nbsp;iopl=0&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;nz&nbsp;na&nbsp;pe&nbsp;nc
cs=001b&nbsp;ss=0023&nbsp;ds=0023&nbsp;es=0023&nbsp;fs=003b&nbsp;gs=0000&nbsp;efl=00000206
jscript9!InterpreterThunkEmitter::NewThunkBlock+0x26:
66393240&nbsp;8b7df8&nbsp;mov&nbsp;edi,dword&nbsp;ptr&nbsp;[ebp-8]&nbsp;ss:0023:0553bcf8=07860000</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">然后继续进程<br/></span></p><pre class="brush:cpp;toolbar:false">0:007&gt;&nbsp;g
(86c.e10):&nbsp;Access&nbsp;violation&nbsp;-&nbsp;code&nbsp;c0000005&nbsp;(first&nbsp;chance)
First&nbsp;chance&nbsp;exceptions&nbsp;are&nbsp;reported&nbsp;before&nbsp;any&nbsp;exception&nbsp;handling.
This&nbsp;exception&nbsp;may&nbsp;be&nbsp;expected&nbsp;and&nbsp;handled.
eax=07860000&nbsp;ebx=07349d20&nbsp;ecx=662cc76d&nbsp;edx=06130f84&nbsp;esi=00000003&nbsp;edi=0553c464
eip=07860000&nbsp;esp=0553c28c&nbsp;ebp=0553c2d8&nbsp;iopl=0&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;zr&nbsp;na&nbsp;pe&nbsp;nc
cs=001b&nbsp;ss=0023&nbsp;ds=0023&nbsp;es=0023&nbsp;fs=003b&nbsp;gs=0000&nbsp;efl=00010246
07860000&nbsp;??&nbsp;???</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">所以我们可以看到我们有一个包含可执行代码的缓冲区被jscript9!EmitBufferManager::NewAllocation分配到了用户堆空间中，然后它又被 jscript9!EmitBufferManager::FreeAllocations释放。然后</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">这段内存再次使用jscript9!NativeCodeGenerator::CheckCodeGenThunk导致我们闯进一个use-free-type空间中。</span></p></p>
                <hr/>
                <p style="text-align: center;">
                    <img src="http://bobao.360.cn/img/app.jpeg"/>
                    <img src="http://bobao.360.cn/img/weixin.jpeg"/>
                </p>
                                <p>本文由 安全客 翻译，转载请注明“转自安全客”，并附上链接。<br/><a class="text-more" href="http://blog.vectranetworks.com/blog/microsoft-internet-explorer-11-zero-day" target="_blank">原文链接：http://blog.vectranetworks.com/blog/microsoft-internet-explorer-11-zero-day</a></p>
                            </div>
            <div style="margin-top: 20px;background-color:#FFFFFF">
    <input type="hidden" id="detail_title" name="detail_title" value="IE11 0day分析 - 安全客 - 有思想的安全新媒体" />
    <input type="hidden" id="use_nickname" name="use_nickname" value="0" />
    <a name="mao"></a>
    <div class="reg-log mobile-hiden">
        <div class="" id="userTo">   
            <div id="to-list" class="input-text" style="">
                <textarea disabled="disabled" class="hide"  id="comment-content" to="to"></textarea>
                <ul id="preadded" style="display:none">       
                </ul>
                <div id="to-auto" style="width: 200px">
                    <ul id="feed">
                    </ul>
                </div>
            </div>
        </div>
        <input type="hidden" id="source-id" value="530" />
        <input type="hidden" id="source-type" value="learning" />
        <input type="hidden" id="post-comment-url" value="/comment/add" />
        <input type="hidden" id="post-nickname-url-ajax" value="/comment/randnicknameajax" />
        <input type="hidden" id="post-check-login-url-ajax" value="/comment/checklogin" />
        <input type="hidden" id="stoken_comment_set" value="64d932c9bb50dc5a83db601d9b02e735">                 <span class="join">参与讨论，请先 <a href="javascript:;" class="comment-login">登录</a> | <a href="javascript:;" class="comment-reg">注册</a> |  <a href="javascript:;" class="anonymous-comment">匿名评论</a></span>
            </div>
    <div class="mobile-hide" style="width: 870px; margin: 0 auto;">
        <label style="vertical-align:middle;" for="use_nickname">匿名</label> 
        <input style="vertical-align:middle;" id="trigger-nickname" name="use_nickname" class="use_nickname" type="checkbox" value="0" />

        <a href="javascript:;" class="apply-use button" id="submit-comment" data-target="/comment/add">发布</a>
    </div>


    <div class="clearfix"></div>
    <div class="comments">
        <div class="comments-head">
            <span class="title">用户评论</span>
        </div>
                <div class="comment-none alarm-info bg-primary">无任何评论</div>
            </div>
</div>
<script>
    $(function () {
        $('.anonymous-comment').click(function () {
            $(".join").hide();
            $(".reg-log textarea").first().removeAttr("disabled").show();
            $('#use_nickname').val('1');
//            $('#trigger-nickname').attr('checked', true);
            $('#trigger-nickname').trigger('click');
        });
        //为所有复选框绑定事件
//        checkbox_on_click();
        //ajax随机获取昵称
//        randnicknameajax(0);
        //ajax检测登录状态
        comment_check_login();
    });



    function input_checkbox(flag) {
        $('input:checkbox').each(function () {
            var value = flag ? 1 : 0;
            $(this).prop('checked', flag);
            $(this).val(value);
        });
    }

//ajax随机获取昵称
    function randnicknameajax(flag) {
        $.ajax({
            type: 'POST',
            url: $('#post-nickname-url-ajax').val(),
            data: {limit: 1, flag: flag},
            dataType: "json",
            success: function (data) {
                $('#nick-name').val(data.data[0]);
                _nick_name=data.data[0];
            }
        });
    }
    $();
//ajax检测登录状态
    function comment_check_login() {
        $.ajax({
            type: 'POST',
            url: $('#post-check-login-url-ajax').val(),
            data: {},
            dataType: "json",
            success: function (data) {
                if (data.success) {
                    $('.join').hide();
                    $(".reg-log textarea").first().removeAttr("disabled").show();
                    $("#span_use_nickname").show();
                    $('#use_nickname').val('0');
                    $('#use_nickname').attr('checked', false);
                }
            }
        });
    }
</script>        </div>
    </div>
    <div class="side-bar">
        <div class="mod hot-news">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-hot"></i><span>热门知识</span></h2>
    </div>
    <ul class="links-list">
                                <li><a href="/learning/detail/4411.html" alt="【漏洞预警】一个换行符引发的奥斯卡0day漏洞(CVE-2017-8759)重现——最新的Office高级威胁攻击预警" target="_blank">【漏洞预警】一个换行符引发的奥斯卡...</a></li>
                                <li><a href="/learning/detail/4416.html" alt="【漏洞预警】Microsoft .NET Framework漏洞（CVE–2017–8759）预警" target="_blank">【漏洞预警】Microsoft .NE...</a></li>
                                <li><a href="/learning/detail/4414.html" alt="【技术分享】妙用JavaScript绕过XSS过滤" target="_blank">【技术分享】妙用JavaScrip...</a></li>
                                <li><a href="/learning/detail/4425.html" alt="【安全报告】XShellGhost事件技术回顾报告" target="_blank">【安全报告】XShellGhost事件...</a></li>
                                <li><a href="/learning/detail/4424.html" alt="【知识】9月16日 - 每日安全知识热点" target="_blank">【知识】9月16日 - 每日安全知识热...</a></li>
                                <li><a href="/learning/detail/4418.html" alt="【技术分享】利用威胁情报数据平台拓展APT攻击线索一例" target="_blank">【技术分享】利用威胁情报数据平台拓...</a></li>
            </ul>
</div>        <!-- 友情链接 -->
        <div class="mod blog-links mobile-hide">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-link"></i><span>友情链接</span></h2>
        <a href="/links/index.html" class="more">更多<i></i></a>
    </div>
        <ul class="links-list">
                <li><a href="http://bbs.360safe.com" alt="360安全社区" target="_blank">360安全社区</a></li>
                <li><a href="http://zhuji.360.cn" alt="360主机卫士" target="_blank">360主机卫士</a></li>
                <li><a href="http://blogs.360.cn/" alt="奇虎360技术博客" target="_blank">奇虎360技术博客</a></li>
                <li><a href="http://wangzhan.360.cn/" alt="360网站卫士" target="_blank">360网站卫士</a></li>
                <li><a href="http://webscan.360.cn/" alt="360网站安全检测" target="_blank">360网站安全检测</a></li>
                <li><a href="http://research.360.cn/report/" alt="360研究报告" target="_blank">360研究报告</a></li>
                <li><a href="http://unicorn.360.cn/" alt="360 Unicorn Team" target="_blank">360 Unicorn Team</a></li>
                <li><a href="http://appscan.360.cn/" alt="360捉虫猎手" target="_blank">360捉虫猎手</a></li>
                <li><a href="https://threathunter.org/" alt="ThreatHunter社区" target="_blank">ThreatHunter社区</a></li>
                <li><a href="http://security.360.cn/" alt="360安全应急响应中心" target="_blank">360安全应急响应中心</a></li>
            </ul>
    </div>
        <!-- 联系我们 -->
        <div class="mod contact mobile-hide" style="text-align:center">
    <div class="head-bar clearfix">
        <h2><i></i><span>关注我们</span></h2>
    </div>
    <!-- 微信关注 -->
    <ul class="contact-way">
        <li><a>微信关注</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/qrcode_adlab_weixin.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
    <!-- APP下载 -->
    <ul class="contact-way">
        <li><a>安全播报APP</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/scan_code_big.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
</div>

    </div>
</div>

<script type="text/javascript" src="/js/jquery-ui.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/jquery.noty.packaged.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/common.js?v=4.5"></script>
<script>$(function() {sync_count('comment');});</script>


<!-- 语法高亮 -->
<script type="text/javascript" src="/ue/SyntaxHighlighter/shCore.js"></script>
<script type="text/javascript">SyntaxHighlighter.all();sync_count('vul');sync_count('news');sync_count('learning');sync_count('activity');sync_count('course');sync_count('ctf');</script>
    </div>

        <div class="footer">
        <div class="friend-link">
            <a href="http://www.360.cn/" target="_blank">360首页</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">关于我们</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">联系我们</a>
            <span>|</span>
            <a href="/links/index.html" target="_blank">友情链接</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">招贤纳士</a>
        </div>
        <div class="copy">
            Copyright &copy; 360网络攻防实验室 All Rights Reserved <span class="copy_icp">京ICP证080047号[京ICP备08010314号-6]</span>
        </div>
    </div>
    
</div>

<!--奇舞团统计-->

<script src='https://s.ssl.qhimg.com/static/f5407c785655e6a1/monitor_analytic.js'></script>
<script>
    monitor.setProject('QH_171_1').getTrack().getClickAndKeydown().getClickHeatmap(10, 1);
</script>

<div class="hide">
    <script src="https://s95.cnzz.com/z_stat.php?id=1253147824&web_id=1253147824" language="JavaScript"></script>
</div>
<div class="backToTop_wrap off">
    <a id="back_to_top" class="backToTop" href="javascript:;" title="返回顶部"></a>
</div>
<script>
    var $backToTop_wrap = $(".backToTop_wrap"),
        $backToTop_btn = $("#back_to_top");

    if ($(window).scrollTop() > 100) {
        $backToTop_wrap.removeClass("off");
    }
    else {
        $backToTop_wrap.addClass("off");
    }

    $(window).on("scroll", function () {
        if ($(this).scrollTop() > 100) {
            $backToTop_wrap.removeClass("off");
        }
        else {
            $backToTop_wrap.addClass("off");
        }
    });

    $backToTop_btn.on("click", function () {
        $("html, body").animate({scrollTop: 0}, 120);
    });

    $(function () {
        var navlist = $('.nav-list > li');

        navlist.each(function () {
            $(this).on('mouseenter', function () {
                $(this).addClass('selected');
            });

            $(this).on('mouseleave', function () {
                $(this).removeClass('selected');
            });
        });
    })
</script>



</body>
</html>
