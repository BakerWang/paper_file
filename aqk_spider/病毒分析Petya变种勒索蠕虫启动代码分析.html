<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns:wb="http://open.weibo.com/wb" xml:lang="en" lang="en">
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"/>
    <link rel="shortcut icon" href="http://bobao.360.cn/favicon.ico?v=1.1"/>
    <link rel="alternate" title="安全资讯" href="/rss?type=news" type="application/rss+xml"/>
    <link rel="alternate" title="安全知识" href="/rss?type=learning" type="application/rss+xml"/>
    <link rel="alternate" title="安全圈活动" href="/rss?type=activity" type="application/rss+xml"/>
    <link rel="alternate" title="所有漏洞" href="/rss?type=vul" type="application/rss+xml"/>
    <link rel="alternate" title="通用型漏洞" href="/rss?type=commonvul" type="application/rss+xml"/>
    <link rel="alternate" title="事件型漏洞" href="/rss?type=eventvul" type="application/rss+xml"/>
    <link rel="alternate" title="热门漏洞" href="/rss?type=hotvul" type="application/rss+xml"/>

        <title>【病毒分析】Petya变种勒索蠕虫启动代码分析 - 安全客 - 有思想的安全新媒体</title>
    
        <meta name="keywords" content="Petya,病毒分析"/>
    
        <meta name="description" content="继5月的WannaCry勒索蠕虫事件以后，2017年6月又出现了Petya变种勒索蠕虫，Petya变种与WannaCry有比较大的差别。WannaCry会加密机器上的文件，而Petya更为激进，它会加密系统的MBR直接导致机器无法启动，本文对其执行的MBR及文件系统的加密机制做详细的分析。"/>
        <meta property="wb:webmaster" content="224437c7be31d633"/>

    <script type="text/javascript" src="http://s7.qhimg.com/!56caa871/xpc_sync_height.js"></script>
    <link rel="stylesheet" type="text/css" href="/css/reset.css" />
    <link rel="stylesheet" type="text/css" href="/css/common_new.css?v=4.4.2.1" />
    <link rel="stylesheet" type="text/css" href="/css/jquery.notyfy.css" />
    <link rel="stylesheet" type="text/css" href="/css/notyfy.theme.default.css" />
    <link rel="stylesheet" type="text/css" href="/css/s_common.css?v=2.2.7" media="only screen and
    (max-device-width:900px), only screen and (max-width:900px)" />
    <script type="text/javascript" src="/js/jquery.min.js?v=3.1"></script>
    <script type="text/javascript" src="/js/jquery.notyfy.js"></script>
    <script type="text/javascript" src="/js/iscroll.js"></script>
    <script src="http://js.passport.qihucdn.com/5.0.3.js"></script>
    <script type="text/javascript">
        var myScroll, myNavScroll;

        function iscrollLoaded() {
            myScroll = new IScroll('#wrapper',
                {
                    scrollX: true,
                    scrollY: false,
                    bounceEasing: 'circular',
                    eventPassthrough: true,
                    preventDefault: false,
                    bounceTime: 500
                }
            );
        }

        $(function () {

            //导航横向滚动


            function setNavWidth() {

                /* 计算导航宽度 */
                var allWidth = $(window).width();
                var scroller = $('#scroller');

                if (allWidth > 900) {
                    scroller.find('ul').add(scroller.find('.scroll')).removeAttr('style');
                    scroller.css('overflow', 'visible');
                    if (myNavScroll) myNavScroll.destroy();
                } else {

                    var width = 0;
                    scroller.find('.scroll').children('ul').children('li').each(function (index, el) {
                        if (!$(this).hasClass('mobile-hide')) {
                            width += $(this).outerWidth();
                        }
                    });
                    scroller.find('ul').add(scroller.find('.scroll')).width(width);

                    if (myNavScroll) myNavScroll.destroy();

                    myNavScroll = new IScroll('#scroller', {
                        scrollX: true,
                        scrollY: false,
                        momentum: false,
                        click: true
                    });

                }

            }

            setNavWidth();
            $(window).resize(function (event) {
                setNavWidth();
            });

        });

    </script>
</head>
<body onload="iscrollLoaded();">
<div style='margin:0 auto;width:0px;height:0px;overflow:hidden;'>
    <img src=""/>
</div>

<div id="is-mobile"></div>
<div class="container">
        <div class="mobile-header">
        <div class="header clearfix">
            <div class="header-wrapper clearfix">
                <a href="/index/index" class="logo"><img class="slogan" src="/img/logo.png?v=1.5"/></a>
                                <form id="search" class="search-box" action="/search/index" method="GET">
                    <input class="keys" name="keywords" type="text" placeholder="搜索漏洞" required="required">
                    <input class="icon" type="submit" value="">
                    <input type="hidden" name="type" value=""/>
                </form>
                <div class="bug">
                    <div class="name"><span class="seled">全部</span><i class="arrow"></i></div>
                    <ul class="typelist">
                        <li data-index="3"><a href="javascript:void(0);">全部</a></li>
                        <li data-index="0"><a href="javascript:void(0);">漏洞</a></li>
                        <li data-index="1"><a href="javascript:void(0);">资讯</a></li>
                        <li data-index="2"><a href="javascript:void(0);">知识</a></li>
                    </ul>
                </div>
                                <div class="logNreg mobile-hide">
                    <div class="unlog">
                        <i></i>
                        <a href="log.html" class="log">登录</a>
                        <span>|</span>
                        <a href="reg.html" class="reg">注册</a>
                    </div>
                    <div class="loged">
                        <a href="/member/profile" class="user-center"><i></i><span class="user-name-tag">个人中心</span></a>
                        <div class="user-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting"><a href="http://i.360.cn/profile/accountmanage"
                                                               target="_blank"><i></i><span>账号设置</span></a></li>
                                <li class="alert-setting"><a href="/keywords/index"
                                                             target="_blank"><i></i><span>告警设置</span></a></li>
                                <li class="bug-alert"><a href="/myalarm/index" target="_blank"><i></i><span>漏洞告警</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mylearn/index" target="_blank"><i></i><span>我的知识</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mycourse/index" target="_blank"><i></i><span>我的课堂</span></a>
                                </li>
                                <li class="my-exit"><a
                                            href="http://login.360.cn/?src=pcw_adlab&op=logout&destUrl=http://bobao.360.cn"><i></i><span>退出系统</span></a>
                                </li>
                            </ul>
                        </div>

                        <a href="/message" class="message-center" target="_blank"><i></i><span>我的消息</span></a>
                        <div class="message-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting" style="display:none;"><a href="/myres/index"
                                                                                     target="_blank"><i></i><span>回复我的</span></a>
                                </li>
                                <li class="my-bug"><a href="/myvul/index"
                                                      target="_blank"><i></i><span>我的漏洞</span></a></li>
                                <!--<li class="my-bug"><a href="/myres/index" target="_blank"><i></i><span>我的评论</span></a></li>-->
                                <!--<li class="alert-setting"><a href="###" target="_blank"><i></i><span>提到我的</span></a>
                                </li>-->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <style type="text/css">
            .nav {
                overflow: hidden;
            }

            .nav .scroll {
                width: auto;
            }
        </style>
        <div id="wrapper">
            <div id="scroller" class="nav">
                <div class="scroll">
                    <ul class="nav-list">
                        <li ><a class="link-nav"
                                                                                 href="/index/index">首页</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/vul/index">漏洞</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/introduce/list">招聘</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/news/index">资讯</a><!--<i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/introduce/list">招聘</a></li>
                        </ul>
			-->
                        </li>
                        <li class="cur">
                        <a class="link-nav" href="/learning/index">知识</a><i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/course/index">学院</a></li>
                        </ul>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/activity/index">活动</a></li>
                        <li class="mobile-hide "><a class="link-nav"
                                                                                                   href="/ctf/index">CTF训练营</a>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/interref/list">安全内参</a></li>
                        <li ><a class="link-nav" href="/app/index">APP</a></li>

                        <!--<li ><a href="/course/index">学院</a></li>-->
                        <!--<li ><a href="/introduce/list">招聘</a></li>-->
                        <!--<li  class="mobile-hide"><a href="/ctf/index">CTF训练营</a></li>-->
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="mobile-content">
        <link rel="stylesheet" type="text/css" href="/css/news.css?v=3.5" />
<link rel="stylesheet" type="text/css" href="/ue/SyntaxHighlighter/shCoreDefault.css?v=1.0" />
<style>
    p .syntaxhighlighter {
        width: 80%;
    }
</style>

<div class="cur-pos w1000">当前位置：<a href="http://bobao.360.cn/">安全客</a> &gt;&gt; 知识详情</div>

<div class="content clearfix">
    <div class="main">
        <div class="article">
            <div id="article_box">
                <h2>【病毒分析】Petya变种勒索蠕虫启动代码分析</h2>
                <div class="article-msg">
                    <span class="time">2017-07-28 17:28:05</span>
                    
                                        <span class="read">阅读：15830次</span>
                    <span><a style="display: none;" class="good" href="javascript:;"
                             data-target="/learning/good" data-value="g_4169"
                             data-type="learning">点赞(0)</a></span>
                    <span><a class="fav" href="javascript:;" data-target="/mylearning/add"
                             data-pk="4169" data-type="learning">收藏</a></span>
                                        <span><a style="margin-left: 4px;" class="fav" href=""
                             target="_blank">来源： 安全客</a></span>
                    
                    
                    <div style="margin-top:10px; ">
                        <a href="/member/contribute?uid=2794533901" style="color:#848e99;">
                            <img src="http://p1.qhmsg.com/dm/150_150_100/t00df551a583a87f4e9.jpg" data-is-avatar="true"
                                 style="border: 1px solid #d5d5d5;padding: 2px; width: 80px;height: 80px;border-radius: 43px;"/>
                        </a>

                    </div>
                    <span class="orig">作者：<a href="/member/contribute?uid=2794533901" style="color:#848e99;">360天眼实验室</a></span>
                                    </div>
                <hr size="1">
                <div class="article-msg">
                    <p><!-- JiaThis Button BEGIN -->

<!--
<span class="jiathis_style"><span class="jiathis_txt">分享到：</span>
	<a class="jiathis_button_weixin"></a>
	<a class="jiathis_button_tsina"></a>
    <a class="jiathis_button_tqq"></a>
    <a class="jiathis_button_qzone"></a>
    <a class="jiathis_button_renren"></a>
    <a class="jiathis_button_xiaoyou"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
</span>

-->
</p>
                </div>
                <p><p style="text-align: center;"><img src="http://p1.qhimg.com/t01d934428202cd2edc.jpg" title="t01ecc846b4c3bc0516.jpg" alt="http://p7.qhimg.com/t01ecc846b4c3bc0516.jpg"/></p><p style="text-indent: 2em;"><strong style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 32px; white-space: normal; color: rgb(0, 112, 192); font-size: 18px;"><br/></strong></p><p style="text-indent: 2em;"><strong style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 32px; white-space: normal; color: rgb(0, 112, 192); font-size: 18px;">作者：360天眼实验室</strong></p><p><br/></p><p style="text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">背景</span></strong></span></p><p style="text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></strong></span></p><hr/><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">继5月的WannaCry勒索蠕虫事件以后，2017年6月又出现了Petya变种勒索蠕虫，除了利用永恒之蓝漏洞和加密勒索以后，Petya变种与WannaCry有比较大的差别。WannaCry会加密机器上的文件，导致数据损毁，而Petya更为激进，它会加密系统的MBR直接导致机器无法启动，本文对其执行的MBR及文件系统的加密机制做详细的分析。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></p><p style="text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">恶意代码分析</span></strong></span></p><p style="text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></strong></span></p><hr/><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">由于执行恶意操作的指令并不是以文件形式存在，我们使用WinHex工具提取受攻击机器的磁盘前23个扇区的数据进行分析，对应代码数据的Hash为 841e12729f200a5620859f2958e2d484。</span></p><p style="text-indent: 2em;"><span style="color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">相关数据结构</span></strong></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">计算机启动时执行完BIOS的启动代码，检查各硬件设备正常后，JMP到MBR的引导代码进行执行；然后由MBR引导至活动分区的DBR，再由DBR引导操作系统。如：DBR调用NTLDR，再由NTLDR调用系统内核。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Petya病毒修改了系统的MBR，病毒在Bios加载后获得执行机会，病毒将加载存储在0x1扇区后的大小为0x20大小的病毒代码加载执行，这些代码会还原出真实的MBR，通过对还原出来的MBR解析，得到系统的DBR，通过DBR解析到系统的MFT结构，遍历所有的MFT，根据MFT找到文件内容所在的扇区后，读取该扇区加密内容后再写回到扇区中，从而实现对文件的加密。要完整的了解整个的加密过程，首先就是熟悉系统的MBR、DBR、MFT等结构的含义与功能。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">MBR</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Petya病毒修改了系统的MBR，病毒在Bios加载后获得执行机会，病毒将加载存储在0x1扇区后的大小为0x20大小的病毒代码加载执行，这些代码会还原出真实的MBR。在加密文件的过程中，Petya病毒会使用到MBR中。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">MBR扇区由以下四部分组成：</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">引导代码：引导代码占MBR分区的前440字节，负责整个系统启动。如果引导代码被破坏，系统将无法启动。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Windows磁盘签名：占引导代码后面的4字节，是Windows初始化磁盘写入的磁盘标签，如果此标签被破坏，则系统会提示“初始化磁盘”。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">MBR分区表：占Windows磁盘标签后面的64个字节，是整个硬盘的分区表。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">MBR结束标志：占MBR扇区最后2个字节，一直为“55 AA”。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">MBR结构如下：</span></p><pre class="brush:cpp;toolbar:false">;====================================================================
;&nbsp;&nbsp;&nbsp;&nbsp;主引导记录(MBR)结构
;====================================================================
typedef&nbsp;struct&nbsp;_MASTER_BOOT_RECORD
{
&nbsp;UCHAR&nbsp;&nbsp;&nbsp;&nbsp;BootCode[446];
&nbsp;PARTITION_ENTRY&nbsp;&nbsp;Partition[4];
&nbsp;USHORT&nbsp;&nbsp;&nbsp;&nbsp;Signature;
}MASTER_BOOT_RECORD,*PMASTER_BOOT_RECORD;
;
;====================================================================
;====================================================================
;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;分区表项结构(16字节)
;====================================================================
;
&nbsp;typedef&nbsp;struct&nbsp;_PARTITION_ENTRY
&nbsp;{
&nbsp;&nbsp;UCHAR&nbsp;BootIndicator;&nbsp;&nbsp;//&nbsp;能否启动标志
&nbsp;&nbsp;UCHAR&nbsp;StartHead;&nbsp;&nbsp;&nbsp;//&nbsp;该分区起始磁头号
&nbsp;&nbsp;UCHAR&nbsp;StartSector;&nbsp;&nbsp;//&nbsp;起始柱面号高2位：6位起始扇区号
&nbsp;&nbsp;UCHAR&nbsp;StartCylinder;&nbsp;&nbsp;//&nbsp;起始柱面号低8位
&nbsp;&nbsp;UCHAR&nbsp;PartitionType;&nbsp;&nbsp;//&nbsp;分区类型
&nbsp;&nbsp;UCHAR&nbsp;EndHead;&nbsp;&nbsp;&nbsp;//&nbsp;该分区终止磁头号
&nbsp;&nbsp;UCHAR&nbsp;EndSector;&nbsp;&nbsp;&nbsp;//&nbsp;终止柱面号高2位：6位终止扇区号
&nbsp;&nbsp;UCHAR&nbsp;EndCylinder;&nbsp;&nbsp;//&nbsp;终止柱面号低8位
&nbsp;&nbsp;ULONG&nbsp;StartLBA;&nbsp;&nbsp;&nbsp;//&nbsp;起始扇区号
&nbsp;&nbsp;ULONG&nbsp;TotalSector;&nbsp;&nbsp;//&nbsp;分区尺寸（总扇区数）
&nbsp;}PARTITION_ENTRY,*PPARTITION_ENTRY;</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">对于其中的PartitionType 字段，Windows下可识别的分区类型主要有：</span><br/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">0x07 表示普通分区(Windows分区、数据分区。默认分区类型)。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">0xEE 表示该分区表是PMBR，紧随其后的应该是GPT分区表头和GPT分区表，因此这是一块GPT硬盘。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">0xEF 表示EFI系统分区</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Petya在解密出原始的MBR后，解析MBR结构，得到起始扇区号，并根据起始扇区定位到DBR。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">病毒解析MBR时，会对分区类型做判断，如果PMBR和EFI类型的系统分区，默认会不做处理。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">在010editor工具中查看</span></p><p style="text-indent: 0em; text-align: center;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;<img src="http://p8.qhimg.com/t01d7390fb26543d5cf.png" title="t0148250839ceea64ab.png" alt="http://p7.qhimg.com/t0148250839ceea64ab.png"/></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">判断分区类型，取了这两个字段：开始扇区与扇区大小：</span></p><p style="text-align: center; text-indent: 0em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;<img src="http://p9.qhimg.com/t0112b2220a0f230456.png" title="t018c4db3d3b173aa92.png" alt="http://p7.qhimg.com/t018c4db3d3b173aa92.png"/></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">在启动扇区（也就是63扇区）处，读一个扇区的内容，就是DBR结构</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">从MBR中可以定位到MBR分区表,根据分区表的属性就可以得到活动分区的扇区地址，也就得到了DBR结构地址。</span></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(247, 150, 70);">DBR</span></strong></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">DBR中存放着关于文件系统的重要参数信息以及系统引导代码。病毒解析到DBR后，只是为了取的DBR结构中的MftStartLcn字段(这个字段表明了MFT结构所在的扇区地址)，以便能进一步定位文件系统。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">DBR的结构如下：</span></p><pre class="brush:cpp;toolbar:false">1.	////////////////////////////////////////////////////////////////////////////&nbsp;&nbsp;
2.	//&nbsp;&nbsp;
3.	//&nbsp;&nbsp;NTFS&nbsp;的DBR&nbsp;数据结构&nbsp;&nbsp;
4.	//&nbsp;&nbsp;
5.	////////////////////////////////////////////////////////////////////////////&nbsp;&nbsp;
6.	typedef&nbsp;struct&nbsp;_BIOS_PARAMETER_BLOCK&nbsp;{&nbsp;&nbsp;
7.	&nbsp;&nbsp;
8.	&nbsp;/*+0x0B*/&nbsp;&nbsp;&nbsp;&nbsp;uint16&nbsp;&nbsp;BytesPerSector;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;字节/扇区一般为0x0200&nbsp;即512&nbsp;&nbsp;
9.	&nbsp;/*+0x0D*/&nbsp;&nbsp;&nbsp;&nbsp;uchar&nbsp;&nbsp;&nbsp;SectorsPerCluster;&nbsp;//&nbsp;扇区/簇&nbsp;&nbsp;&nbsp;
10.	&nbsp;/*+0x0E*/&nbsp;&nbsp;&nbsp;&nbsp;uint16&nbsp;&nbsp;ReservedSectors;&nbsp;&nbsp;&nbsp;//&nbsp;保留扇区&nbsp;&nbsp;
11.	&nbsp;/*+0x0F*/&nbsp;&nbsp;&nbsp;&nbsp;uchar&nbsp;&nbsp;&nbsp;Fats;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;
12.	&nbsp;/*+0x11*/&nbsp;&nbsp;&nbsp;&nbsp;uint16&nbsp;&nbsp;RootEntries;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;
13.	&nbsp;/*+0x13*/&nbsp;&nbsp;&nbsp;&nbsp;uint16&nbsp;&nbsp;Sectors;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;
14.	&nbsp;/*+0x15*/&nbsp;&nbsp;&nbsp;&nbsp;uchar&nbsp;&nbsp;&nbsp;Media;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;媒介描述&nbsp;&nbsp;
15.	&nbsp;/*+0x16*/&nbsp;&nbsp;&nbsp;&nbsp;uint16&nbsp;&nbsp;SectorsPerFat;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;&nbsp;&nbsp;
16.	&nbsp;/*+0x18*/&nbsp;&nbsp;&nbsp;&nbsp;uint16&nbsp;&nbsp;SectorsPerTrack;&nbsp;&nbsp;&nbsp;//&nbsp;扇区/磁轨&nbsp;&nbsp;
17.	&nbsp;/*+0x1A*/&nbsp;&nbsp;&nbsp;&nbsp;uint16&nbsp;&nbsp;Heads;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;头&nbsp;&nbsp;
18.	&nbsp;/*+0x1C*/&nbsp;&nbsp;&nbsp;&nbsp;uint32&nbsp;&nbsp;HiddenSectors;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;隐藏扇区&nbsp;&nbsp;
19.	&nbsp;/*+0x20*/&nbsp;&nbsp;&nbsp;&nbsp;uint32&nbsp;&nbsp;LargeSectors;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;checked&nbsp;when&nbsp;volume&nbsp;is&nbsp;mounted&nbsp;&nbsp;
20.	&nbsp;&nbsp;
21.	}BIOS_PARAMETER_BLOCK,&nbsp;*pBIOS_PARAMETER_BLOCK;&nbsp;&nbsp;


typedef&nbsp;struct&nbsp;_NTFS_Boot_Sector{&nbsp;&nbsp;
1.	&nbsp;/*+0x00*/&nbsp;&nbsp;uchar&nbsp;&nbsp;&nbsp;&nbsp;JmpCode[3];&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;跳转指令&nbsp;&nbsp;
2.	&nbsp;/*+0x03*/&nbsp;&nbsp;char&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;OemID[8];&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;文件系统ID&nbsp;&nbsp;
3.	&nbsp;/*+0x0B*/&nbsp;&nbsp;BIOS_PARAMETER_BLOCK&nbsp;PackedBpb;&nbsp;&nbsp;&nbsp;//&nbsp;BPB&nbsp;&nbsp;
4.	&nbsp;/*+0x24*/&nbsp;&nbsp;uchar&nbsp;&nbsp;&nbsp;&nbsp;Unused[4];&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;未使用,总是为&nbsp;&nbsp;
5.	&nbsp;/*+0x28*/&nbsp;&nbsp;uint64&nbsp;&nbsp;&nbsp;NumberSectors;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;扇区总数&nbsp;&nbsp;
6.	&nbsp;/*+0x30*/&nbsp;&nbsp;lcn&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MftStartLcn;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;开始C#&nbsp;$MFT&nbsp;&nbsp;(簇)&nbsp;乘以&nbsp;BIOS_PARAMETER_BLOCK.SectorsPerCluster&nbsp;值得到扇区号&nbsp;&nbsp;
7.	&nbsp;/*+0x38*/&nbsp;&nbsp;lcn&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Mft2StartLcn;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;开始C#&nbsp;$MFTMirr&nbsp;(簇)&nbsp;&nbsp;
8.	&nbsp;/*+0x40*/&nbsp;&nbsp;uchar&nbsp;&nbsp;&nbsp;&nbsp;ClustersPerFileRecordSegment;&nbsp;&nbsp;//&nbsp;文件记录大小指示器&nbsp;&nbsp;
9.	&nbsp;/*+0x41*/&nbsp;&nbsp;uchar&nbsp;&nbsp;&nbsp;Reserved0[3];&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;未使用&nbsp;&nbsp;
10.	&nbsp;/*+0x44*/&nbsp;&nbsp;uchar&nbsp;DefaultClustersPerIndexAllocationBuffer;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;簇/索引块&nbsp;&nbsp;
11.	&nbsp;/*+0x45*/&nbsp;&nbsp;uchar&nbsp;&nbsp;&nbsp;Reserved1[3];&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;未使用&nbsp;&nbsp;
12.	&nbsp;/*+0x48*/&nbsp;&nbsp;uint64&nbsp;&nbsp;SerialNumber;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;64位序列号&nbsp;&nbsp;
13.	&nbsp;/*+0x50*/&nbsp;&nbsp;uint32&nbsp;&nbsp;Checksum;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;校验和&nbsp;&nbsp;
14.	&nbsp;/*+0x54*/&nbsp;&nbsp;uchar&nbsp;&nbsp;&nbsp;BootStrap[426];&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;启动代码&nbsp;&nbsp;
15.	&nbsp;/*+0x1FE*/&nbsp;uint16&nbsp;&nbsp;RecordEndSign;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;0xAA55&nbsp;结束标记&nbsp;&nbsp;
16.	}NTFS_Boot_Sector,&nbsp;*pNTFS_Boot_Sector;</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">其中，定位MFT时，最重要的结构为MftStartLcn表示起始簇号，乘以BIOS_PARAMETER_BLOCK.SectorsPerCluster（在我的机器上这个值为8，表示一个簇由8个扇区组成）后就得到起始扇区号。</span><br/></p><p style="text-indent: 2em;"><span style="color: rgb(247, 150, 70);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">MFT</span></strong></span></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">简介</span></strong></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">MFT，即主文件表（Master File Table）的简称，它是NTFS文件系统的核心。MFT由一个个MFT项（也称为文件记录）组成。每个MFT项的前部为0x10字节的头结构，用来描述本MFT项的相关信息。后面节存放着属性。每个文件和目录的信息都包含在MFT中，每个文件和目录至少有一个MFT项。除了引导扇区外，访问其他任何一个文件前都需要先访问MFT，在MFT中找到该文件的MFT项，根据MFT项中记录的信息找到文件内容并对其进行访问。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">MFT结构分为两种：元文件与普通文件。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">元文件对于用户是不能直接访问的，MFT将开头的16个文件记录块保留用于这些元数据文件，除此之外的文件记录块才用于普通的用户文件和目录。</span></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">16个元文件</span></strong></p><pre class="brush:cpp;toolbar:false">#defineMFT_IDX_MFT0
#defineMFT_IDX_MFT_MIRR1
#defineMFT_IDX_LOG_FILE2
#defineMFT_IDX_VOLUME3
#defineMFT_IDX_ATTR_DEF4
#defineMFT_IDX_ROOT5
#defineMFT_IDX_BITMAP6
#defineMFT_IDX_BOOT7
#defineMFT_IDX_BAD_CLUSTER8
#defineMFT_IDX_SECURE9
#defineMFT_IDX_UPCASE10
#defineMFT_IDX_EXTEND11
#defineMFT_IDX_RESERVED1212
#defineMFT_IDX_RESERVED1313
#defineMFT_IDX_RESERVED1414
#defineMFT_IDX_RESERVED1515
#defineMFT_IDX_USER16</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">这16个原文件本身也是MFT结构的模式，可以理解为记录了MFT信息的MFT结构。</span><br/></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">怎么解析这16个原文件的MFT结构呢？</span></strong></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">换句话说，通过MBR定位到DBR,通过DBR定位到MFT，此时的MFT就对应着索引为MFT_IDX_MFT的MFT，向后偏移文件记录大小的地方，就存放着索引为MFT_IDX_MFT_MIRR的MFT。再向后偏移文件记录大小的地方，就存放着索引为MFT_IDX_LOG_FILE的MFT</span></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">解析这16个原文件的MFT结构有什么用？</span></strong></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">如对于MFT_IDX_VOLUME 这个MFT结构，解析这个MFT结构中的ATTR_TYPE_VOLUME_INFORMATION（对应着0x70）就可以得到NTFS卷的版本信息,解析这个MFT结构中的ATTR_TYPE_VOLUME_NAME属性（对应着0x60）就可以得到NTFS卷名信息。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">再如，对于MFT_IDX_MFT 这个MFT结构，解析这个MFT结构中的ATTR_TYPE_DATA（对应0x80）的属性RealSize，就表示整个卷所有的文件记录的大小信息。利用这个大小信息是以字节表示的，用这个大小信息除以每个文件记录所占用的字节就得到了卷占有的文件记录数量。计算出来的文件记录数量是将元文件也计算在内的。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">依次遍历每个文件记录数量，读取这个文件记录的内容就是MFT结构，解析这个MFT的对应属性就可以解析出文件名、文件属性、文件内容等。</span></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">普通MFT</span></strong></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">遍历文件时，从第16个文件记录开始向后遍历，才会得到普通的用户文件和目录信息及内容。</span></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">数据结构</span></strong></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">MFT的直观结构如下，</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">// 文件记录体</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">// 属性1</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">// 属性2</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">// …………</span></p><p style="text-indent: 0em; text-align: center;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;<img src="http://p8.qhimg.com/t019c1b045eb1394645.png" title="t01ff58aa1211b1fc17.png" alt="http://p1.qhimg.com/t01ff58aa1211b1fc17.png"/></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">每个MFT的结构如下：</span></p><pre class="brush:cpp;toolbar:false">//&nbsp;文件记录头&nbsp;&nbsp;
typedef&nbsp;struct&nbsp;_FILE_RECORD_HEADER&nbsp;&nbsp;
{&nbsp;&nbsp;
&nbsp;/*+0x00*/&nbsp;&nbsp;uint32&nbsp;Type;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;固定值&#39;FILE&#39;&nbsp;&nbsp;
&nbsp;/*+0x04*/&nbsp;&nbsp;uint16&nbsp;UsaOffset;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;更新序列号偏移,&nbsp;与操作系统有关&nbsp;&nbsp;
&nbsp;/*+0x06*/&nbsp;&nbsp;uint16&nbsp;UsaCount;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;固定列表大小Size&nbsp;in&nbsp;words&nbsp;of&nbsp;Update&nbsp;Sequence&nbsp;Number&nbsp;&amp;&nbsp;Array&nbsp;(S)&nbsp;&nbsp;
&nbsp;/*+0x08*/&nbsp;&nbsp;uint64&nbsp;Lsn;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;日志文件序列号(LSN)&nbsp;&nbsp;
}&nbsp;FILE_RECORD_HEADER,&nbsp;*PFILE_RECORD_HEADER;&nbsp;&nbsp;

//&nbsp;文件记录体&nbsp;&nbsp;
typedef&nbsp;struct&nbsp;_FILE_RECORD{&nbsp;&nbsp;
&nbsp;/*+0x00*/&nbsp;&nbsp;FILE_RECORD_HEADER&nbsp;Ntfs;&nbsp;&nbsp;//&nbsp;MFT表头&nbsp;&nbsp;
&nbsp;/*+0x10*/&nbsp;&nbsp;uint16&nbsp;&nbsp;SequenceNumber;&nbsp;&nbsp;&nbsp;//&nbsp;序列号(用于记录文件被反复使用的次数)&nbsp;&nbsp;
&nbsp;/*+0x12*/&nbsp;&nbsp;uint16&nbsp;&nbsp;LinkCount;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;硬连接数&nbsp;&nbsp;
&nbsp;/*+0x14*/&nbsp;&nbsp;uint16&nbsp;&nbsp;AttributeOffset;&nbsp;&nbsp;//&nbsp;第一个属性偏移&nbsp;&nbsp;
&nbsp;/*+0x16*/&nbsp;&nbsp;uint16&nbsp;&nbsp;Flags;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;falgs,&nbsp;00表示删除文件,01表示正常文件,02表示删除目录,03表示正常目录&nbsp;&nbsp;
&nbsp;/*+0x18*/&nbsp;&nbsp;uint32&nbsp;&nbsp;BytesInUse;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;文件记录实时大小(字节)&nbsp;当前MFT表项长度,到FFFFFF的长度+4&nbsp;&nbsp;
&nbsp;/*+0x1C*/&nbsp;&nbsp;uint32&nbsp;&nbsp;BytesAllocated;&nbsp;&nbsp;&nbsp;//&nbsp;文件记录分配大小(字节)&nbsp;&nbsp;
&nbsp;/*+0x20*/&nbsp;&nbsp;uint64&nbsp;&nbsp;BaseFileRecord;&nbsp;&nbsp;&nbsp;//&nbsp;=&nbsp;0&nbsp;基础文件记录&nbsp;File&nbsp;reference&nbsp;to&nbsp;the&nbsp;base&nbsp;FILE&nbsp;record&nbsp;&nbsp;
&nbsp;/*+0x28*/&nbsp;&nbsp;uint16&nbsp;&nbsp;NextAttributeNumber;&nbsp;//&nbsp;下一个自由ID号&nbsp;&nbsp;
&nbsp;/*+0x2A*/&nbsp;&nbsp;uint16&nbsp;&nbsp;Pading;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;边界&nbsp;&nbsp;
&nbsp;/*+0x2C*/&nbsp;&nbsp;uint32&nbsp;&nbsp;MFTRecordNumber;&nbsp;&nbsp;//&nbsp;windows&nbsp;xp中使用,本MFT记录号&nbsp;&nbsp;
&nbsp;/*+0x30*/&nbsp;&nbsp;uint32&nbsp;&nbsp;MFTUseFlags;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;MFT的使用标记&nbsp;&nbsp;
}FILE_RECORD,&nbsp;*pFILE_RECORD;</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">根据FILE头部数据找到下面的一个个属性,接下来分析的就是一个个属性了，属性由属性头跟属性体组成,属性头的结构定义如下：</span></p><pre class="brush:cpp;toolbar:false">//&nbsp;属性头&nbsp;&nbsp;
typedef&nbsp;struct&nbsp;&nbsp;
{&nbsp;&nbsp;
&nbsp;/*+0x00*/&nbsp;&nbsp;ATTRIBUTE_TYPE&nbsp;AttributeType;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;属性类型&nbsp;&nbsp;
&nbsp;/*+0x04*/&nbsp;&nbsp;uint16&nbsp;RecordLength;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;总长度(Header+body长度)&nbsp;&nbsp;
&nbsp;/**0x06*/&nbsp;&nbsp;uint16&nbsp;unknow0;&nbsp;&nbsp;
&nbsp;/*+0x08*/&nbsp;&nbsp;uchar&nbsp;Nonresident;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;非常驻标志&nbsp;&nbsp;
&nbsp;/*+0x09*/&nbsp;&nbsp;uchar&nbsp;NameLength;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;操作属性名长度&nbsp;&nbsp;
&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;0X0001为压缩标记&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;0X4000为加密标记&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;0X8000为系数文件标志&nbsp;&nbsp;
&nbsp;/*+0x0A*/&nbsp;&nbsp;uint16&nbsp;NameOffset;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;属性名偏移(从属性起始位置的偏移)&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;NameLength&nbsp;如果不为零,则用这个值去寻址数据偏移&nbsp;&nbsp;
&nbsp;/*+0x0C*/&nbsp;&nbsp;uint16&nbsp;Flags;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;ATTRIBUTE_xxx&nbsp;flags.&nbsp;&nbsp;
&nbsp;/*+0x0E*/&nbsp;&nbsp;uint16&nbsp;AttributeNumber;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;The&nbsp;file-record-unique&nbsp;attribute&nbsp;instance&nbsp;number&nbsp;for&nbsp;this&nbsp;attribute.&nbsp;&nbsp;
}&nbsp;ATTRIBUTE,&nbsp;*PATTRIBUTE;&nbsp;&nbsp;
&nbsp;&nbsp;
//&nbsp;属性头&nbsp;&nbsp;&nbsp;
typedef&nbsp;struct&nbsp;_RESIDENT_ATTRIBUTE&nbsp;&nbsp;
{&nbsp;&nbsp;
&nbsp;/*+0x00*/&nbsp;&nbsp;ATTRIBUTE&nbsp;Attribute;&nbsp;&nbsp;&nbsp;//&nbsp;属性&nbsp;&nbsp;
&nbsp;/*+0x10*/&nbsp;&nbsp;uint32&nbsp;ValueLength;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Data部分长度&nbsp;&nbsp;
&nbsp;/*+0x14*/&nbsp;&nbsp;uint16&nbsp;ValueOffset;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;Data内容起始偏移&nbsp;&nbsp;
&nbsp;/*+0x16*/&nbsp;&nbsp;uchar&nbsp;Flags;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;索引标志&nbsp;&nbsp;
&nbsp;/*+0x17*/&nbsp;&nbsp;uchar&nbsp;Padding0;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;填充&nbsp;&nbsp;
}&nbsp;RESIDENT_ATTRIBUTE,&nbsp;*PRESIDENT_ATTRIBUTE;</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Petya中涉及到MFT的属性</span></p><pre class="brush:cpp;toolbar:false">//&nbsp;属性类型定义&nbsp;
AttributeFileName&nbsp;=&nbsp;0x30,&nbsp;&nbsp;
AttributeData&nbsp;=&nbsp;0x80,&nbsp;
这两个属性的定义如下：
//&nbsp;文件属性ATTRIBUTE.AttributeType&nbsp;==&nbsp;0x30&nbsp;&nbsp;
typedef&nbsp;struct&nbsp;&nbsp;
{&nbsp;&nbsp;
&nbsp;/*+0x00*/&nbsp;&nbsp;uint64&nbsp;DirectoryFile:48;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;父目录记录号(前个字节)&nbsp;&nbsp;
&nbsp;/*+0x06*/&nbsp;&nbsp;uint64&nbsp;ReferenceNumber:16;&nbsp;&nbsp;//&nbsp;+序列号(与目录相关)&nbsp;&nbsp;
&nbsp;/*+0x08*/&nbsp;&nbsp;uint64&nbsp;CreationTime;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;文件创建时间&nbsp;&nbsp;
&nbsp;/*+0x10*/&nbsp;&nbsp;uint64&nbsp;ChangeTime;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;文件修改时间&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;/*+0x18*/&nbsp;&nbsp;uint64&nbsp;LastWriteTime;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;MFT更新的时间&nbsp;&nbsp;
&nbsp;/*+0x20*/&nbsp;&nbsp;uint64&nbsp;LastAccessTime;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;最后一次访问时间&nbsp;&nbsp;
&nbsp;/*+0x28*/&nbsp;&nbsp;uint64&nbsp;AllocatedSize;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;文件分配大小&nbsp;&nbsp;
&nbsp;/*+0x30*/&nbsp;&nbsp;uint64&nbsp;DataSize;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;文件实际大小&nbsp;&nbsp;
&nbsp;/*+0x38*/&nbsp;&nbsp;uint32&nbsp;FileAttributes;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;标志,如目录\压缩\隐藏等&nbsp;&nbsp;
&nbsp;/*+0x3C*/&nbsp;&nbsp;uint32&nbsp;AlignmentOrReserved;&nbsp;//&nbsp;用于EAS和重解析&nbsp;&nbsp;
&nbsp;/*+0x40*/&nbsp;&nbsp;uchar&nbsp;NameLength;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;以字符计的文件名长度,没字节占用字节数由下一字节命名空间确定&nbsp;&nbsp;
&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;文件名命名空间,&nbsp;0&nbsp;POSIX大小写敏感,1&nbsp;win32空间,2&nbsp;DOS空间,&nbsp;3&nbsp;win32&amp;DOS空间&nbsp;&nbsp;
&nbsp;/*+0x41*/&nbsp;&nbsp;uchar&nbsp;NameType;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;/*+0x42*/&nbsp;&nbsp;wchar&nbsp;Name[1];&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;以Unicode方式标识的文件名&nbsp;&nbsp;
}&nbsp;FILENAME_ATTRIBUTE,&nbsp;*PFILENAME_ATTRIBUTE;

//&nbsp;数据流属性&nbsp;ATTRIBUTE.AttributeType&nbsp;==&nbsp;0x80&nbsp;&nbsp;&nbsp;
typedef&nbsp;struct&nbsp;_NONRESIDENT_ATTRIBUTE&nbsp;&nbsp;
{&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;/*+0x00*/&nbsp;&nbsp;&nbsp;ATTRIBUTE&nbsp;Attribute;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;/*+0x10*/&nbsp;&nbsp;&nbsp;uint64&nbsp;StartVcn;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;LowVcn&nbsp;起始VCN&nbsp;&nbsp;起始簇号&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;/*+0x18*/&nbsp;&nbsp;&nbsp;uint64&nbsp;LastVcn;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;HighVcn&nbsp;&nbsp;结束VCN&nbsp;&nbsp;结束簇号&nbsp;&nbsp;
&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;/*+0x20*/&nbsp;&nbsp;&nbsp;uint16&nbsp;RunArrayOffset;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;数据运行的偏移，非常重要&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;/*+0x22*/&nbsp;&nbsp;&nbsp;uint16&nbsp;CompressionUnit;&nbsp;&nbsp;&nbsp;//&nbsp;压缩引擎&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;/*+0x24*/&nbsp;&nbsp;&nbsp;uint32&nbsp;&nbsp;Padding0;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;填充&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;/*+0x28*/&nbsp;&nbsp;&nbsp;uint32&nbsp;&nbsp;IndexedFlag;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;为属性值分配大小(按分配的簇的字节数计算)&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;/*+0x30*/&nbsp;&nbsp;&nbsp;uint64&nbsp;AllocatedSize;&nbsp;&nbsp;&nbsp;//&nbsp;属性值实际大小&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;/*+0x38*/&nbsp;&nbsp;&nbsp;uint64&nbsp;DataSize;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;属性值压缩大小&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;/*+0x40*/&nbsp;&nbsp;&nbsp;uint64&nbsp;InitializedSize;&nbsp;&nbsp;&nbsp;//&nbsp;实际数据大小&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;/*+0x48*/&nbsp;&nbsp;&nbsp;uint64&nbsp;CompressedSize;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;压缩后大小&nbsp;&nbsp;
}&nbsp;NONRESIDENT_ATTRIBUTE,&nbsp;*PNONRESIDENT_ATTRIBUTE;</pre><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">对于0x30属性：</span></strong></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">对于MFT中的0x30属性的直观认识，如下：</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">黄色部分对应着上表中的ATTRIBUTE结构，红色部分对应着上表中的NONRESIDENT_ATTRIBUTE结构。选中部分对应着FILENAME_ATTRIBUTE结构内容，这里面包含了文件的各种时间属性和文件名等内容。</span></p><p><br/></p><p style="text-indent: 0em; text-align: center;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;<img src="http://p1.qhimg.com/t0123690677a1e10c71.png" title="t01ac92ab17e9cc1a81.png" alt="http://p3.qhimg.com/t01ac92ab17e9cc1a81.png"/></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Petya病毒在遍历MFT时，会通过判断当前MFT的AttributeFileName属性判断是否加密该MFT。</span></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">对于0x80属性：</span></strong></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">对于MFT中的0x80属性的直观认识，如下：</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">黄色部分对应着上表中的ATTRIBUTE结构，红色部分对应着上表中的NONRESIDENT_ATTRIBUTE结构。绿色部分对应着RUN-LIST结构内容。</span></p><p style="text-indent: 0em; text-align: center;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;<img src="http://p9.qhimg.com/t01b1806f888abc79c0.png" title="t0175552ab898f72c2e.png" alt="http://p7.qhimg.com/t0175552ab898f72c2e.png"/></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">80H属性是文件数据属性，该属性容纳着文件的内容，文件的大小一般指的就是未命名数据流的大小。该属性没有最大最小限制，最小情况是该属性为常驻属性。常驻属性就不做多的解释了，如下是一个非常驻的80H属性。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">该属性的“Run List”值为“32 0C 1B 00 00 0C”，其具体含义如下：</span></p><p style="text-indent: 0em; text-align: center;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;<img src="http://p6.qhimg.com/t0158a3a2686e4efffe.png" title="t01d46110c846ba8262.png" alt="http://p9.qhimg.com/t01d46110c846ba8262.png"/></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Petya病毒在加密文件内容时，会通过Run List定位到文件内容所在的真正扇区加密文件，如果文件内容大于2个扇区，则只加密前两个扇区。</span></p><p style="text-indent: 2em;"><span style="color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">恶意代码加载过程</span></strong></span></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(247, 150, 70);">1 加载代码到0x8000执行</span></strong></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">从第一个扇区开始，读取0x20个扇区到0x8000地址处，随后跳到0x8000处执行</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">循环读取0x20个扇区代码片段：</span></p><p style="text-indent: 0em; text-align: center;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;<img src="http://p2.qhimg.com/t012ac8b56a69ddd46a.png" title="t01f78c8165b6965c9f.png" alt="http://p2.qhimg.com/t01f78c8165b6965c9f.png"/></span></p><p><br/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">在循环里使用int 13读取磁盘内容</span></p><p style="text-indent: 0em; text-align: center;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;<img src="http://p6.qhimg.com/t015f82fea4155f4f4a.png" title="t016222cb8d6d5da269.png" alt="http://p3.qhimg.com/t016222cb8d6d5da269.png"/></span></p><p><br/></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(247, 150, 70);">2 调用函数读取硬盘参数</span></strong></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">读取硬盘参数</span></p><p style="text-indent: 0em; text-align: center;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;<img src="http://p5.qhimg.com/t014de69af87b3cf3bd.png" title="t012080f6462c5fb334.png" alt="http://p0.qhimg.com/t012080f6462c5fb334.png"/></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">比较“FA 31 C0 8E”硬编码，判断当前的第一个扇区的内容是不是病毒写入的内容。</span></p><p style="text-indent: 0em; text-align: center;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;<img src="http://p8.qhimg.com/t019e8f14e49c204db0.png" title="t01f160a0c274fe365b.png" alt="http://p6.qhimg.com/t01f160a0c274fe365b.png"/></span></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(247, 150, 70);">3 判断加密标志</span></strong></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">读取0x20扇区的内容（该扇区保存了病毒的配置信息），判断该扇区的第一个字节是不是1，如果是1，表示mbr已经被加过密，就来到显示勒索界面的流程;如果不为1，表示还未对MBR和MFT进行加密，进入加密流程。</span><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-align: center; text-indent: 0em;">&nbsp;</span></p><p style="text-indent: 0em; text-align: center;"><img src="http://p5.qhimg.com/t01d97ccf3fd6c4ee0e.png" title="t01dafa334d6681da54.png" alt="http://p5.qhimg.com/t01dafa334d6681da54.png"/><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-align: center; text-indent: 0em;"></span></p><p style="text-indent: 2em;"><span style="color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">加密过程</span></strong></span></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(247, 150, 70);">1 打印修复磁盘信息，设置加密标志</span></strong></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">打印出虚假的“Repairing file system on C:”信息，读取0x20扇区中的配置信息到内存，并将读取到的配置信息的加密标志设置为1。随后，将修改过加密标志的内容写入到扇区中，为了保证写入成功，这里循环写了0x20次。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">打印的磁盘修复信息如下：</span></p><p style="text-indent: 0em; text-align: center;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;<strong style="color: rgb(0, 112, 192); text-indent: 32px; white-space: normal;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><img src="http://p5.qhimg.com/t011e2b0ee8c9167bdf.png" title="t0100691bfee5f16341.png" alt="http://p6.qhimg.com/t0100691bfee5f16341.png"/></span></strong></span></p><p style="text-indent: 0em; text-align: center;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;<img src="http://p7.qhimg.com/t016f39a8615c481359.png" title="t01521dd5605fc244be.png" alt="http://p6.qhimg.com/t01521dd5605fc244be.png"/></span></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(247, 150, 70);">2 加密验证扇区</span></strong></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">加密验证扇区的方法为：读取0x21扇区的内容（这个扇区保存的全是0x07数据），使用从配置信息扇区读取的key与n做为加密参数，调用salsa加密该读到的0x07内容，并将加密后的内容写入到0x21扇区中</span></p><p style="text-indent: 0em; text-align: center;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;<img src="http://p9.qhimg.com/t0173994279fe9c5873.png" title="t01d771eb02e70e26c2.png" alt="http://p7.qhimg.com/t01d771eb02e70e26c2.png"/></span></p><p style="text-align: center;"><img src="http://p7.qhimg.com/t01f4091a29872d00ea.png" title="t01a66bf14508f4a96f.png" alt="http://p5.qhimg.com/t01a66bf14508f4a96f.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">显示虚假的“CHKDSK is repairing sector”界面，实际在后台正在加密MFT数据。</span></p><p style="text-align: center; text-indent: 0em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;<img src="http://p2.qhimg.com/t01e8a46f4c9e47c485.png" title="t01ab5876d927cf46ad.png" alt="http://p5.qhimg.com/t01ab5876d927cf46ad.png"/></span></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(247, 150, 70);">3 加密操作</span></strong></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">文件遍历的原理</span></strong></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Petya病毒通过解析MBR，DBR得到MFT地址。解析MFT索引为0的元文件，得到属性为DATA的属性内容，取出属性中的RUN-LIST结构中的簇数量与起始扇区，根据这两个字段遍历所有的MFT就得到了当前文件系统中所有的文件信息。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">解析MBR</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">解析原始MBR数据的代码片段：</span></p><p style="text-indent: 0em; text-align: center;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;<img src="http://p9.qhimg.com/t0174bb7fec62f8ee59.png" title="t013ead219c97f15655.png" alt="http://p8.qhimg.com/t013ead219c97f15655.png"/></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">判断MBR中的分区类型：</span></p><p style="text-indent: 0em; text-align: center;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;<img src="http://p8.qhimg.com/t01e56ae96cd35811cd.png" title="t0158fb58496c219c8c.png" alt="http://p3.qhimg.com/t0158fb58496c219c8c.png"/></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">判断从mbr中读取到的StartLBA字段不为空</span></p><p style="text-align: center; text-indent: 0em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;&nbsp;<img src="http://p5.qhimg.com/t012f2c3f70460943d8.png" title="t01bba5ee740c4983d3.png" alt="http://p9.qhimg.com/t01bba5ee740c4983d3.png"/></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">从mbr中解析到StartLBA字段，并读取该字段对应的扇区，此扇区的内容就为DBR相关的内容：</span></p><p style="text-indent: 0em; text-align: center;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;<img src="http://p0.qhimg.com/t016136c167d805a735.png" title="t01f36b1d161a56532b.png" alt="http://p5.qhimg.com/t01f36b1d161a56532b.png"/></span></p><p><br/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">读取到DBR后，解析出MftStartLcn字段，该字段就表示 MFT地址：</span></p><p style="text-indent: 0em; text-align: center;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;<img src="http://p2.qhimg.com/t01b6c3721926e4da36.png" title="t019066a66d36fa564b.png" alt="http://p6.qhimg.com/t019066a66d36fa564b.png"/></span></p><p><br/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">得到MFT地址后，该地址就是索引为0的MFT元文件地址,从该元文件结构中取出属性为0x80（DATA）的内容。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">首先读取到$MFT的扇区内容：</span></p><p style="text-indent: 0em; text-align: center;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;<img src="http://p0.qhimg.com/t01e47eca964cc8b458.png" title="t01d117b15603d5e2c1.png" alt="http://p3.qhimg.com/t01d117b15603d5e2c1.png"/></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">解析属性，判断是不是0x80(DATA)属性类型</span></p><p style="text-indent: 0em; text-align: center;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;<img src="http://p0.qhimg.com/t01f5291057f95d6189.png" title="t010ba1baf59b2efbc7.png" alt="http://p9.qhimg.com/t010ba1baf59b2efbc7.png"/></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">对$MFT属性0x80中的解析，得到下面信息：</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">run_data_cluster*sector/cluster + 0x20(0x20为元文件占用的扇区大小)+mbr. arg_StartLBA，作为普通 MFT扇区的起始扇区，这样是保证加密的过程中不会加密元文件扇区与mbr相关的扇区。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">（run_data_num_clusters * sector/cluster）- 0x20(0x20为元文件占用的扇区大小)，做为普通MFT的扇区大小。</span></p><p style="text-indent: 0em; text-align: center;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><img src="http://p6.qhimg.com/t015c310cac5f2701e3.png" title="t014e25575ac86e9fc0.png" alt="http://p2.qhimg.com/t014e25575ac86e9fc0.png"/></span></p><p><br/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">随后，就来到遍历用户MFT的函数：</span></p><p style="text-indent: 0em; text-align: center;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;<img src="http://p1.qhimg.com/t01ccd4a09d181e8e9e.png" title="t01f1861aa06d1fa6c8.png" alt="http://p5.qhimg.com/t01f1861aa06d1fa6c8.png"/></span></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">遍历普通MFT结构</span></strong></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">遍历普通MFT结构的函数在00008FA6处，该函数为病毒代码中最为主要的函数。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">下面对这个函数进行详细分析:</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">在调试的过程中，parse_User_MFT函数的参数内容为：80 C6 5F 00 60 00 20 C6 &nbsp;00 00 3F 00 00 00 3F 00 60 00 08 C6 2C 67 4A 67 &nbsp;8B 77 52 9C 01,结合调试时传递的参数内容，对函数作出说明。</span></p><p style="text-indent: 0em; text-align: center;"><img src="http://p2.qhimg.com/t01e6f3566ea728be9f.png" title="t012df654d192991068.png" alt="http://p7.qhimg.com/t012df654d192991068.png"/></p><p><br/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">该函数主要功能为：对扇区中的MFT遍历，对不符合MFT头部标志(FILE)的扇区，会直接调用SALSA20算法进行加密该扇区，对符合MFT头部标志的扇区，判断0x30属性中的文件名判断是不是元文件，如果不是元文件名格式，则直接加密该扇区。其他情况下，判断MFT结构0x80属性中的常驻内存属性，如果是非常驻内存属性，就解析文件内容的前二个扇区，取出该扇区的内容后，使用salsa20算法进行加密。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">1.<span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; white-space: pre;"></span>先打印出“CHKDSK is repairing sector”，显示虚假的磁盘修复界面</span></p><p style="text-indent: 0em; text-align: center;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;<img src="http://p9.qhimg.com/t01ec1678ac553caed6.png" title="t01ad4b6c360b4c44a1.png" alt="http://p1.qhimg.com/t01ad4b6c360b4c44a1.png"/></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">2.<span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; white-space: pre;"></span>对当前MFT头是不是“FILE”,如果不是”FILE”的话，则直接加密这个扇区</span></p><p style="text-indent: 0em; text-align: center;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;<img src="http://p3.qhimg.com/t01a5c76acb10617254.png" title="t01d61d5103e28fe841.png" alt="http://p5.qhimg.com/t01d61d5103e28fe841.png"/></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">3.<span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; white-space: pre;"></span>如果是FILE，接着遍历mft的各个属性：</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">如果属性为AttributeFileName（0x30），判断文件名字长度是不是1，如果长度为1，直接加密，如果长度不为1，则看文件名字是不是以$开头(以$开头的是NTFS文件系统的元文件)，如果是元文件，则加密当前MFT.</span></p><p style="text-indent: 0em; text-align: center;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;<img src="http://p9.qhimg.com/t013909464db1c60b95.png" title="t014cbfa8b3699826ae.png" alt="http://p3.qhimg.com/t014cbfa8b3699826ae.png"/></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">如果属性为AttributeData文件数据属性（0x80），则首先根据属性头判断是不是非常驻内存，如果是常驻内存属性就跳过，不进行加密。如果是非常驻内存属性，则通过RUNLIST结构遍历到存储数据的真正的扇区位置。</span></p><p style="text-indent: 0em; text-align: center;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;<img src="http://p6.qhimg.com/t012c01eea93ad2e5eb.png" title="t01951723db780d25e0.png" alt="http://p4.qhimg.com/t01951723db780d25e0.png"/></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">解析RUNLIST</span></p><p style="text-indent: 0em; text-align: center;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;<img src="http://p5.qhimg.com/t010ffdbd87283cc1b4.png" title="t013cb29d1dee124011.png" alt="http://p1.qhimg.com/t013cb29d1dee124011.png"/></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">根据RUNLIST中的起始簇乘以MBR中保存的每簇对应的扇区数，得到数据真正所在的扇区。</span></p><p style="text-indent: 0em; text-align: center;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;<img src="http://p7.qhimg.com/t012366db3e73668a12.png" title="t013898fc1ec00d723e.png" alt="http://p8.qhimg.com/t013898fc1ec00d723e.png"/></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">随后，判断上面计算出的文件内容对应扇区数量是不是大于2，如果大于2，只加密前2个扇区。</span></p><p style="text-indent: 0em; text-align: center;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;<img src="http://p5.qhimg.com/t013c47b517ade7b68c.png" title="t0108bd01fd1b60a89b.png" alt="http://p4.qhimg.com/t0108bd01fd1b60a89b.png"/></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">读取该MFT文件对应的文件内容的前两个分区，通过直接使用int 13中断从扇区读取到文件内容，使用salsa20加密后，将密文直接写入的扇区中文件中。</span></p><p style="text-indent: 0em; text-align: center;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;<img src="http://p3.qhimg.com/t013657a687f1383fd3.png" title="t01a351a56bc944bf76.png" alt="http://p3.qhimg.com/t01a351a56bc944bf76.png"/></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">在动态调试时，可以看到加密了文件内容，加密文件内容前的数据</span></p><p style="text-indent: 0em; text-align: center;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;<img src="http://p8.qhimg.com/t01deabf7143a250b0c.png" title="t01627c2f0c65e01d5b.png" alt="http://p7.qhimg.com/t01627c2f0c65e01d5b.png"/></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">被加密后的文件内容：</span></p><p style="text-indent: 0em; text-align: center;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;<img src="http://p4.qhimg.com/t01acfcd6f23704dd69.png" title="t01fcf799def9ee1193.png" alt="http://p1.qhimg.com/t01fcf799def9ee1193.png"/></span></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">加密函数</span></strong></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">对文件的加密使用了SALSA20算法，该算法属于流加密，在知道key和iv的情况下，加密函数和解密函数可以为相同的函数代码。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">加密函数</span></p><p style="text-indent: 0em; text-align: center;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;<img src="http://p0.qhimg.com/t012a5889cc518a1ef9.png" title="t016739c4f46011859a.png" alt="http://p0.qhimg.com/t016739c4f46011859a.png"/></span></p><p><br/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">在密钥扩展的函数中，Petya将原始的常数“expand 16-byte k”更改成了“1nvald s3ct”</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">扩展密钥函数代码：</span></p><p style="text-indent: 0em; text-align: center;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;<img src="http://p1.qhimg.com/t015b12476130209766.png" title="t01297eadc4cf9c2e4d.png" alt="http://p7.qhimg.com/t01297eadc4cf9c2e4d.png"/></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Salsa20加密时使用的key和iv来自于配置信息扇区（0x20扇区）</span></p><p style="text-indent: 0em; text-align: center;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;<img src="http://p1.qhimg.com/t0195527a1b1abd280d.png" title="t01108990fc9c4e90f3.png" alt="http://p0.qhimg.com/t01108990fc9c4e90f3.png"/></span></p><p><br/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">将明文与生成的keystream异或，实现加密</span></p><p style="text-indent: 0em; text-align: center;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;<img src="http://p5.qhimg.com/t01a6a952577ed4ed67.png" title="t010127848139b7edf3.png" alt="http://p5.qhimg.com/t010127848139b7edf3.png"/></span></p><p style="text-indent: 2em;"><span style="color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">解密过程</span></strong></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">在开机启动过程中，MBR引导后，加载扇区中的恶意代码后，恶意代码会判断配置信息第1个BYTE是不是1，1表示已经加密过，则进入相应的解密过程中</span></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">1 打印勒索信息</span></strong></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">打印出勒索信息</span></p><p style="text-indent: 0em; text-align: center;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;<img src="http://p9.qhimg.com/t01edca150abf7ab3a2.png" title="t01707f25a4ff1fd5c7.png" alt="http://p9.qhimg.com/t01707f25a4ff1fd5c7.png"/></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">也就是显示如下的内容</span></p><p style="text-indent: 0em; text-align: center;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;<img src="http://p6.qhimg.com/t011fba72e925625d0b.png" title="t01199fd8d01eeb20e2.png" alt="http://p7.qhimg.com/t01199fd8d01eeb20e2.png"/></span></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">2 读取用户输入的key</span></strong></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">清空内存，读取用户输入的key</span></p><p style="text-indent: 0em; text-align: center;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;<img src="http://p0.qhimg.com/t0169011bbd4c2d5bb8.png" title="t01d5b1dd68efbd581f.png" alt="http://p6.qhimg.com/t01d5b1dd68efbd581f.png"/></span></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">3 验证用户的key</span></strong></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">在验证KEY的过程中，首先比较输入的key的长度，必须大于0x20长度</span></p><p style="text-indent: 0em; text-align: center;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;<img src="http://p6.qhimg.com/t018f8a4cbadd67c9ef.png" title="t01136ad0780d4480c1.png" alt="http://p4.qhimg.com/t01136ad0780d4480c1.png"/></span></p><p><br/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">将输入的key通过自定义算法的转换<span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; white-space: pre;"></span>0x21次</span></p><p style="text-indent: 0em; text-align: center;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;<img src="http://p6.qhimg.com/t015e237a13561729c4.png" title="t01991c9c1c09291f6a.png" alt="http://p0.qhimg.com/t01991c9c1c09291f6a.png"/></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">使用转换过的key，使用salsa20算法解密0x21扇区的内容（这个扇区的内容为加密过的0x7内容），比较解密出来的内容是不是0x7，如果是则表明解密密码正确。</span></p><p style="text-indent: 0em; text-align: center;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;<img src="http://p8.qhimg.com/t0130db97cc651e741d.png" title="t01386fbd69ad868670.png" alt="http://p3.qhimg.com/t01386fbd69ad868670.png"/></span></p><p style="text-indent: 0em; text-align: center;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><img src="http://p9.qhimg.com/t01e3c064a44c50dd54.png" title="t017be6cd11db67cda2.png" alt="http://p4.qhimg.com/t017be6cd11db67cda2.png"/></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">密码验证通过后，会使用这个key做为参数调用DecryptProc 函数(并非勒索软件作者定义的函数名)，</span></p><p style="text-indent: 0em; text-align: center;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;<img src="http://p5.qhimg.com/t01f81eb71d4380336a.png" title="t0199eececf6d82bb86.png" alt="http://p9.qhimg.com/t0199eececf6d82bb86.png"/></span></p><p><br/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">在DecryptProc函数中调用与加密时相同的函数进行对MFT结构进行遍历后解密，</span></p><p style="text-align: center;"><img src="http://p7.qhimg.com/t014b3011e43b487d2a.png" title="t01e831e9eb2b1d1942.png" alt="http://p8.qhimg.com/t01e831e9eb2b1d1942.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">在解密完成后，打印“Please reboot your computer!”信息</span></p><p style="text-indent: 0em; text-align: center;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;<img src="http://p4.qhimg.com/t0196c78726eee95343.png" title="t01cfa84c1a3c426e0d.png" alt="http://p1.qhimg.com/t01cfa84c1a3c426e0d.png"/></span></p><p style="text-indent: 2em;"><span style="color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">总结</span></strong></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">本文对Petya变种勒索蠕虫的扇区启动代码进行了详细分析，分析显示Petya变种勒索蠕虫并不仅会加密MBR和MFT结构，也会将MFT对应的文件内容的前两个扇区进行加密。换句话说，Petya变种勒索蠕虫在系统启动时MBR中的代码执行时也会进行全盘文件的加密操作。结合RING3级别的勒索代码功能，Petya会对文件执行两次加密操作，第一次为Petya勒索蠕虫执行时，使用RSA与AES算法遍历文件系统对指定扩展名的文件加密，第二次为系统启动时，启动扇区的代码会通过遍历MFT结构定位文件内容并对文件使用salsa20算法进行加密。对于RING3级别的文件加密过程，解密密钥可以通过勒索蠕虫作者的RSA私钥进行解密获得，而启动扇区级别的文件加密过程使用了随机密码进行，启动扇区级别的文件加密无法解密。</span></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 112, 192);">参考</span></strong></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><a href="http://dengqi.blog.51cto.com/5685776/1351300">http://dengqi.blog.51cto.com/5685776/1351300</a></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><a href="https://github.com/alexwebr/salsa20/blob/master/salsa20.c">https://github.com/alexwebr/salsa20/blob/master/salsa20.c</a></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><a href="http://blog.csdn.net/enjoy5512/article/details/50966009">http://blog.csdn.net/enjoy5512/article/details/50966009</a></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><a href="http://bobao.360.cn/learning/detail/4039.html">http://bobao.360.cn/learning/detail/4039.html</a></span></p></p>
                <hr/>
                <p style="text-align: center;">
                    <img src="http://bobao.360.cn/img/app.jpeg"/>
                    <img src="http://bobao.360.cn/img/weixin.jpeg"/>
                </p>
                                <p>本文由 安全客 原创发布，如需转载请注明来源及本文地址。<br/>本文地址：http://bobao.360.cn/learning/detail/4169.html
                </p>
                            </div>
            <div style="margin-top: 20px;background-color:#FFFFFF">
    <input type="hidden" id="detail_title" name="detail_title" value="【病毒分析】Petya变种勒索蠕虫启动代码分析 - 安全客 - 有思想的安全新媒体" />
    <input type="hidden" id="use_nickname" name="use_nickname" value="0" />
    <a name="mao"></a>
    <div class="reg-log mobile-hiden">
        <div class="" id="userTo">   
            <div id="to-list" class="input-text" style="">
                <textarea disabled="disabled" class="hide"  id="comment-content" to="to"></textarea>
                <ul id="preadded" style="display:none">       
                </ul>
                <div id="to-auto" style="width: 200px">
                    <ul id="feed">
                    </ul>
                </div>
            </div>
        </div>
        <input type="hidden" id="source-id" value="4169" />
        <input type="hidden" id="source-type" value="learning" />
        <input type="hidden" id="post-comment-url" value="/comment/add" />
        <input type="hidden" id="post-nickname-url-ajax" value="/comment/randnicknameajax" />
        <input type="hidden" id="post-check-login-url-ajax" value="/comment/checklogin" />
        <input type="hidden" id="stoken_comment_set" value="ea3898fb4df38673fdeb61c458234054">                 <span class="join">参与讨论，请先 <a href="javascript:;" class="comment-login">登录</a> | <a href="javascript:;" class="comment-reg">注册</a> |  <a href="javascript:;" class="anonymous-comment">匿名评论</a></span>
            </div>
    <div class="mobile-hide" style="width: 870px; margin: 0 auto;">
        <label style="vertical-align:middle;" for="use_nickname">匿名</label> 
        <input style="vertical-align:middle;" id="trigger-nickname" name="use_nickname" class="use_nickname" type="checkbox" value="0" />

        <a href="javascript:;" class="apply-use button" id="submit-comment" data-target="/comment/add">发布</a>
    </div>


    <div class="clearfix"></div>
    <div class="comments">
        <div class="comments-head">
            <span class="title">用户评论</span>
        </div>
                <div class="comment-none alarm-info bg-primary">无任何评论</div>
            </div>
</div>
<script>
    $(function () {
        $('.anonymous-comment').click(function () {
            $(".join").hide();
            $(".reg-log textarea").first().removeAttr("disabled").show();
            $('#use_nickname').val('1');
//            $('#trigger-nickname').attr('checked', true);
            $('#trigger-nickname').trigger('click');
        });
        //为所有复选框绑定事件
//        checkbox_on_click();
        //ajax随机获取昵称
//        randnicknameajax(0);
        //ajax检测登录状态
        comment_check_login();
    });



    function input_checkbox(flag) {
        $('input:checkbox').each(function () {
            var value = flag ? 1 : 0;
            $(this).prop('checked', flag);
            $(this).val(value);
        });
    }

//ajax随机获取昵称
    function randnicknameajax(flag) {
        $.ajax({
            type: 'POST',
            url: $('#post-nickname-url-ajax').val(),
            data: {limit: 1, flag: flag},
            dataType: "json",
            success: function (data) {
                $('#nick-name').val(data.data[0]);
                _nick_name=data.data[0];
            }
        });
    }
    $();
//ajax检测登录状态
    function comment_check_login() {
        $.ajax({
            type: 'POST',
            url: $('#post-check-login-url-ajax').val(),
            data: {},
            dataType: "json",
            success: function (data) {
                if (data.success) {
                    $('.join').hide();
                    $(".reg-log textarea").first().removeAttr("disabled").show();
                    $("#span_use_nickname").show();
                    $('#use_nickname').val('0');
                    $('#use_nickname').attr('checked', false);
                }
            }
        });
    }
</script>        </div>
    </div>
    <div class="side-bar">
        <div class="mod hot-news">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-hot"></i><span>热门知识</span></h2>
    </div>
    <ul class="links-list">
                                <li><a href="/learning/detail/4411.html" alt="【漏洞预警】一个换行符引发的奥斯卡0day漏洞(CVE-2017-8759)重现——最新的Office高级威胁攻击预警" target="_blank">【漏洞预警】一个换行符引发的奥斯卡...</a></li>
                                <li><a href="/learning/detail/4416.html" alt="【漏洞预警】Microsoft .NET Framework漏洞（CVE–2017–8759）预警" target="_blank">【漏洞预警】Microsoft .NE...</a></li>
                                <li><a href="/learning/detail/4414.html" alt="【技术分享】妙用JavaScript绕过XSS过滤" target="_blank">【技术分享】妙用JavaScrip...</a></li>
                                <li><a href="/learning/detail/4418.html" alt="【技术分享】利用威胁情报数据平台拓展APT攻击线索一例" target="_blank">【技术分享】利用威胁情报数据平台拓...</a></li>
                                <li><a href="/learning/detail/4417.html" alt="【知识】9月15日 - 每日安全知识热点" target="_blank">【知识】9月15日 - 每日安全知识热...</a></li>
                                <li><a href="/learning/detail/4425.html" alt="【安全报告】XShellGhost事件技术回顾报告" target="_blank">【安全报告】XShellGhost事件...</a></li>
            </ul>
</div>        <!-- 友情链接 -->
        <div class="mod blog-links mobile-hide">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-link"></i><span>友情链接</span></h2>
        <a href="/links/index.html" class="more">更多<i></i></a>
    </div>
        <ul class="links-list">
                <li><a href="http://bbs.360safe.com" alt="360安全社区" target="_blank">360安全社区</a></li>
                <li><a href="http://zhuji.360.cn" alt="360主机卫士" target="_blank">360主机卫士</a></li>
                <li><a href="http://blogs.360.cn/" alt="奇虎360技术博客" target="_blank">奇虎360技术博客</a></li>
                <li><a href="http://wangzhan.360.cn/" alt="360网站卫士" target="_blank">360网站卫士</a></li>
                <li><a href="http://webscan.360.cn/" alt="360网站安全检测" target="_blank">360网站安全检测</a></li>
                <li><a href="http://research.360.cn/report/" alt="360研究报告" target="_blank">360研究报告</a></li>
                <li><a href="http://unicorn.360.cn/" alt="360 Unicorn Team" target="_blank">360 Unicorn Team</a></li>
                <li><a href="http://appscan.360.cn/" alt="360捉虫猎手" target="_blank">360捉虫猎手</a></li>
                <li><a href="https://threathunter.org/" alt="ThreatHunter社区" target="_blank">ThreatHunter社区</a></li>
                <li><a href="http://security.360.cn/" alt="360安全应急响应中心" target="_blank">360安全应急响应中心</a></li>
            </ul>
    </div>
        <!-- 联系我们 -->
        <div class="mod contact mobile-hide" style="text-align:center">
    <div class="head-bar clearfix">
        <h2><i></i><span>关注我们</span></h2>
    </div>
    <!-- 微信关注 -->
    <ul class="contact-way">
        <li><a>微信关注</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/qrcode_adlab_weixin.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
    <!-- APP下载 -->
    <ul class="contact-way">
        <li><a>安全播报APP</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/scan_code_big.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
</div>

    </div>
</div>

<script type="text/javascript" src="/js/jquery-ui.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/jquery.noty.packaged.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/common.js?v=4.5"></script>
<script>$(function() {sync_count('comment');});</script>


<!-- 语法高亮 -->
<script type="text/javascript" src="/ue/SyntaxHighlighter/shCore.js"></script>
<script type="text/javascript">SyntaxHighlighter.all();sync_count('vul');sync_count('news');sync_count('learning');sync_count('activity');sync_count('course');sync_count('ctf');</script>
    </div>

        <div class="footer">
        <div class="friend-link">
            <a href="http://www.360.cn/" target="_blank">360首页</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">关于我们</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">联系我们</a>
            <span>|</span>
            <a href="/links/index.html" target="_blank">友情链接</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">招贤纳士</a>
        </div>
        <div class="copy">
            Copyright &copy; 360网络攻防实验室 All Rights Reserved <span class="copy_icp">京ICP证080047号[京ICP备08010314号-6]</span>
        </div>
    </div>
    
</div>

<!--奇舞团统计-->

<script src='https://s.ssl.qhimg.com/static/f5407c785655e6a1/monitor_analytic.js'></script>
<script>
    monitor.setProject('QH_171_1').getTrack().getClickAndKeydown().getClickHeatmap(10, 1);
</script>

<div class="hide">
    <script src="https://s95.cnzz.com/z_stat.php?id=1253147824&web_id=1253147824" language="JavaScript"></script>
</div>
<div class="backToTop_wrap off">
    <a id="back_to_top" class="backToTop" href="javascript:;" title="返回顶部"></a>
</div>
<script>
    var $backToTop_wrap = $(".backToTop_wrap"),
        $backToTop_btn = $("#back_to_top");

    if ($(window).scrollTop() > 100) {
        $backToTop_wrap.removeClass("off");
    }
    else {
        $backToTop_wrap.addClass("off");
    }

    $(window).on("scroll", function () {
        if ($(this).scrollTop() > 100) {
            $backToTop_wrap.removeClass("off");
        }
        else {
            $backToTop_wrap.addClass("off");
        }
    });

    $backToTop_btn.on("click", function () {
        $("html, body").animate({scrollTop: 0}, 120);
    });

    $(function () {
        var navlist = $('.nav-list > li');

        navlist.each(function () {
            $(this).on('mouseenter', function () {
                $(this).addClass('selected');
            });

            $(this).on('mouseleave', function () {
                $(this).removeClass('selected');
            });
        });
    })
</script>



</body>
</html>
