<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns:wb="http://open.weibo.com/wb" xml:lang="en" lang="en">
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"/>
    <link rel="shortcut icon" href="http://bobao.360.cn/favicon.ico?v=1.1"/>
    <link rel="alternate" title="安全资讯" href="/rss?type=news" type="application/rss+xml"/>
    <link rel="alternate" title="安全知识" href="/rss?type=learning" type="application/rss+xml"/>
    <link rel="alternate" title="安全圈活动" href="/rss?type=activity" type="application/rss+xml"/>
    <link rel="alternate" title="所有漏洞" href="/rss?type=vul" type="application/rss+xml"/>
    <link rel="alternate" title="通用型漏洞" href="/rss?type=commonvul" type="application/rss+xml"/>
    <link rel="alternate" title="事件型漏洞" href="/rss?type=eventvul" type="application/rss+xml"/>
    <link rel="alternate" title="热门漏洞" href="/rss?type=hotvul" type="application/rss+xml"/>

        <title>【技术分享】利用FRIDA攻击Android应用程序（四） - 安全客 - 有思想的安全新媒体</title>
    
        <meta name="keywords" content="FRIDA,android安全,android应用安全"/>
    
        <meta name="description" content="Frida是一个动态代码插桩框架。在这篇文章中，我们重点介绍Frida在Android安全方面的应用。"/>
        <meta property="wb:webmaster" content="224437c7be31d633"/>

    <script type="text/javascript" src="http://s7.qhimg.com/!56caa871/xpc_sync_height.js"></script>
    <link rel="stylesheet" type="text/css" href="/css/reset.css" />
    <link rel="stylesheet" type="text/css" href="/css/common_new.css?v=4.4.2.1" />
    <link rel="stylesheet" type="text/css" href="/css/jquery.notyfy.css" />
    <link rel="stylesheet" type="text/css" href="/css/notyfy.theme.default.css" />
    <link rel="stylesheet" type="text/css" href="/css/s_common.css?v=2.2.7" media="only screen and
    (max-device-width:900px), only screen and (max-width:900px)" />
    <script type="text/javascript" src="/js/jquery.min.js?v=3.1"></script>
    <script type="text/javascript" src="/js/jquery.notyfy.js"></script>
    <script type="text/javascript" src="/js/iscroll.js"></script>
    <script src="http://js.passport.qihucdn.com/5.0.3.js"></script>
    <script type="text/javascript">
        var myScroll, myNavScroll;

        function iscrollLoaded() {
            myScroll = new IScroll('#wrapper',
                {
                    scrollX: true,
                    scrollY: false,
                    bounceEasing: 'circular',
                    eventPassthrough: true,
                    preventDefault: false,
                    bounceTime: 500
                }
            );
        }

        $(function () {

            //导航横向滚动


            function setNavWidth() {

                /* 计算导航宽度 */
                var allWidth = $(window).width();
                var scroller = $('#scroller');

                if (allWidth > 900) {
                    scroller.find('ul').add(scroller.find('.scroll')).removeAttr('style');
                    scroller.css('overflow', 'visible');
                    if (myNavScroll) myNavScroll.destroy();
                } else {

                    var width = 0;
                    scroller.find('.scroll').children('ul').children('li').each(function (index, el) {
                        if (!$(this).hasClass('mobile-hide')) {
                            width += $(this).outerWidth();
                        }
                    });
                    scroller.find('ul').add(scroller.find('.scroll')).width(width);

                    if (myNavScroll) myNavScroll.destroy();

                    myNavScroll = new IScroll('#scroller', {
                        scrollX: true,
                        scrollY: false,
                        momentum: false,
                        click: true
                    });

                }

            }

            setNavWidth();
            $(window).resize(function (event) {
                setNavWidth();
            });

        });

    </script>
</head>
<body onload="iscrollLoaded();">
<div style='margin:0 auto;width:0px;height:0px;overflow:hidden;'>
    <img src=""/>
</div>

<div id="is-mobile"></div>
<div class="container">
        <div class="mobile-header">
        <div class="header clearfix">
            <div class="header-wrapper clearfix">
                <a href="/index/index" class="logo"><img class="slogan" src="/img/logo.png?v=1.5"/></a>
                                <form id="search" class="search-box" action="/search/index" method="GET">
                    <input class="keys" name="keywords" type="text" placeholder="搜索漏洞" required="required">
                    <input class="icon" type="submit" value="">
                    <input type="hidden" name="type" value=""/>
                </form>
                <div class="bug">
                    <div class="name"><span class="seled">全部</span><i class="arrow"></i></div>
                    <ul class="typelist">
                        <li data-index="3"><a href="javascript:void(0);">全部</a></li>
                        <li data-index="0"><a href="javascript:void(0);">漏洞</a></li>
                        <li data-index="1"><a href="javascript:void(0);">资讯</a></li>
                        <li data-index="2"><a href="javascript:void(0);">知识</a></li>
                    </ul>
                </div>
                                <div class="logNreg mobile-hide">
                    <div class="unlog">
                        <i></i>
                        <a href="log.html" class="log">登录</a>
                        <span>|</span>
                        <a href="reg.html" class="reg">注册</a>
                    </div>
                    <div class="loged">
                        <a href="/member/profile" class="user-center"><i></i><span class="user-name-tag">个人中心</span></a>
                        <div class="user-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting"><a href="http://i.360.cn/profile/accountmanage"
                                                               target="_blank"><i></i><span>账号设置</span></a></li>
                                <li class="alert-setting"><a href="/keywords/index"
                                                             target="_blank"><i></i><span>告警设置</span></a></li>
                                <li class="bug-alert"><a href="/myalarm/index" target="_blank"><i></i><span>漏洞告警</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mylearn/index" target="_blank"><i></i><span>我的知识</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mycourse/index" target="_blank"><i></i><span>我的课堂</span></a>
                                </li>
                                <li class="my-exit"><a
                                            href="http://login.360.cn/?src=pcw_adlab&op=logout&destUrl=http://bobao.360.cn"><i></i><span>退出系统</span></a>
                                </li>
                            </ul>
                        </div>

                        <a href="/message" class="message-center" target="_blank"><i></i><span>我的消息</span></a>
                        <div class="message-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting" style="display:none;"><a href="/myres/index"
                                                                                     target="_blank"><i></i><span>回复我的</span></a>
                                </li>
                                <li class="my-bug"><a href="/myvul/index"
                                                      target="_blank"><i></i><span>我的漏洞</span></a></li>
                                <!--<li class="my-bug"><a href="/myres/index" target="_blank"><i></i><span>我的评论</span></a></li>-->
                                <!--<li class="alert-setting"><a href="###" target="_blank"><i></i><span>提到我的</span></a>
                                </li>-->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <style type="text/css">
            .nav {
                overflow: hidden;
            }

            .nav .scroll {
                width: auto;
            }
        </style>
        <div id="wrapper">
            <div id="scroller" class="nav">
                <div class="scroll">
                    <ul class="nav-list">
                        <li ><a class="link-nav"
                                                                                 href="/index/index">首页</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/vul/index">漏洞</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/introduce/list">招聘</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/news/index">资讯</a><!--<i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/introduce/list">招聘</a></li>
                        </ul>
			-->
                        </li>
                        <li class="cur">
                        <a class="link-nav" href="/learning/index">知识</a><i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/course/index">学院</a></li>
                        </ul>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/activity/index">活动</a></li>
                        <li class="mobile-hide "><a class="link-nav"
                                                                                                   href="/ctf/index">CTF训练营</a>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/interref/list">安全内参</a></li>
                        <li ><a class="link-nav" href="/app/index">APP</a></li>

                        <!--<li ><a href="/course/index">学院</a></li>-->
                        <!--<li ><a href="/introduce/list">招聘</a></li>-->
                        <!--<li  class="mobile-hide"><a href="/ctf/index">CTF训练营</a></li>-->
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="mobile-content">
        <link rel="stylesheet" type="text/css" href="/css/news.css?v=3.5" />
<link rel="stylesheet" type="text/css" href="/ue/SyntaxHighlighter/shCoreDefault.css?v=1.0" />
<style>
    p .syntaxhighlighter {
        width: 80%;
    }
</style>

<div class="cur-pos w1000">当前位置：<a href="http://bobao.360.cn/">安全客</a> &gt;&gt; 知识详情</div>

<div class="content clearfix">
    <div class="main">
        <div class="article">
            <div id="article_box">
                <h2>【技术分享】利用FRIDA攻击Android应用程序（四）</h2>
                <div class="article-msg">
                    <span class="time">2017-06-02 10:14:09</span>
                    
                                        <span class="read">阅读：19219次</span>
                    <span><a style="display: none;" class="good" href="javascript:;"
                             data-target="/learning/good" data-value="g_3930"
                             data-type="learning">点赞(0)</a></span>
                    <span><a class="fav" href="javascript:;" data-target="/mylearning/add"
                             data-pk="3930" data-type="learning">收藏</a></span>
                                        <span><a style="margin-left: 4px;" class="fav" href="https://enovella.github.io/android/reverse/2017/05/20/android-owasp-crackmes-level-3.html"
                             target="_blank">来源： enovella.github.io</a></span>
                    
                    
                    <div style="margin-top:10px; ">
                        <a href="/member/contribute?uid=2802394681" style="color:#848e99;">
                            <img src="http://p1.qhmsg.com/dm/150_150_100/t01049cac452ac00f3e.jpg" data-is-avatar="true"
                                 style="border: 1px solid #d5d5d5;padding: 2px; width: 80px;height: 80px;border-radius: 43px;"/>
                        </a>

                    </div>
                    <span class="orig">作者：<a href="/member/contribute?uid=2802394681" style="color:#848e99;">ShadowBrokers</a></span>
                                    </div>
                <hr size="1">
                <div class="article-msg">
                    <p><!-- JiaThis Button BEGIN -->

<!--
<span class="jiathis_style"><span class="jiathis_txt">分享到：</span>
	<a class="jiathis_button_weixin"></a>
	<a class="jiathis_button_tsina"></a>
    <a class="jiathis_button_tqq"></a>
    <a class="jiathis_button_qzone"></a>
    <a class="jiathis_button_renren"></a>
    <a class="jiathis_button_xiaoyou"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
</span>

-->
</p>
                </div>
                <p><p style="text-align: center; text-indent: 0em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><img src="http://p5.qhimg.com/t01d81911e7e811a12c.jpg" alt="http://p6.qhimg.com/t0175df5f452002f202.jpg"/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><p style="margin: 0px 25px 8px; white-space: normal; padding: 0px; line-height: 25px; color: rgb(70, 79, 85); word-break: break-all; font-family: Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft Yahei&quot;, 微软雅黑, serif; text-indent: 2em; background-color: rgb(255, 255, 255);"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 112, 192); font-size: 18px; font-weight: 900;">翻译：</span><a href="http://bobao.360.cn/member/contribute?uid=2802394681" target="_blank" textvalue="houjingyi233" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px; color: rgb(0, 112, 192);"><strong>houjingyi233</strong></a></p><p style="margin: 0px 25px 8px; white-space: normal; padding: 0px; line-height: 25px; color: rgb(70, 79, 85); word-break: break-all; font-family: Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft Yahei&quot;, 微软雅黑, serif; text-indent: 2em; background-color: rgb(255, 255, 255);"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 112, 192); font-size: 18px; font-weight: 900;">预估稿费：200RMB</span></p><p style="margin: 0px 25px 8px; white-space: normal; padding: 0px; line-height: 25px; color: rgb(70, 79, 85); word-break: break-all; font-family: Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft Yahei&quot;, 微软雅黑, serif; text-indent: 2em; background-color: rgb(255, 255, 255);"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 112, 192); font-size: 18px; font-weight: 900;">投稿方式：发送邮件至linwei#360.cn，或登陆网页版在线投稿</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px;">传送门</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><a href="http://bobao.360.cn/learning/detail/3641.html" target="_self" style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px; color: rgb(0, 112, 192);"><strong>【技术分享】利用FRIDA攻击Android应用程序（一）</strong></a></p><p style="text-indent: 2em; text-align: left;"><a href="http://bobao.360.cn/learning/detail/3634.html" target="_self" style="text-decoration: underline; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px; color: rgb(0, 112, 192);"><span style="color: rgb(0, 112, 192);"><strong><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px;">【技术分享】利用FRIDA攻击Android应用程序（二）</span></strong></span></a></p><p style="text-indent: 2em; text-align: left;"><a href="http://bobao.360.cn/learning/detail/3794.html" target="_self" style="text-decoration: underline; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px; color: rgb(0, 112, 192);"><span style="color: rgb(0, 112, 192);"><strong><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px;">【技术分享】利用FRIDA攻击Android应用程序（三）</span></strong></span></a></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">这篇文章详细介绍了解决OWASP的Bernhard Mueller发布的Android crackme中的</span><a href="https://github.com/OWASP/owasp-mstg/tree/master/Crackmes/Android/Level_03" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">UnCrackable-Level3.apk</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">的几种方法。我们的主要目标是从一个被保护的APK中提取隐藏的字符串。</span><br/></p><p style="text-indent: 2em; text-align: left;"><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">UnCrackable Level3中的安全机制</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">APK中实施了反破解技术，主要是为了延长逆向分析人员所需的时间。冷静一下，因为现在我们必须处理所有的保护措施。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">我们在该APP中检测到以下保护措施。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Java层反调试</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Java层完整性检查</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Java层root检查</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Native层反DBI(动态二进制插桩)</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Native层反调试</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Native层对Dalvik字节码的完整性检查</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Native层混淆(只删除了一些符号信息并使用了一个函数来保护秘密信息)</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">在该APP中没有检测到以下保护措施。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Java层反DBI</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Java层混淆</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Native层root检查</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Native层对Native代码自身的完整性检查</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">开始之前</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">首先在分析APK之前，先明确以下几点。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Android手机需要root。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">在Java和Native层有反DBI，反调试，防篡改和root检查。我们不需要绕过它们，只需要提取我们需要的秘密信息。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Native层是执行重要代码的位置。不要在Dalvik字节码上纠缠。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">我的解决方案只是解决这个问题的一种方式。也许很快就会出现更好更聪明的解法。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">可能的解决方案</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">这个问题可以用很多方法解决。首先，我们需要知道应用程序到底在做什么。应用程序是通过比较用户输入和Java层与Native层的secret异或的结果来实现验证的。通过JNI将Java层的secret发送到native库后，验证在native层完成。事实上，验证是对用户输入的一个简单的strncmp的和对两个secret的xor操作。验证的伪代码如下(函数名由我给出)。</span></p><pre class="brush:plain;toolbar:false">strncmp_with_xor(user_input_native,&nbsp;native_secret,&nbsp;java_secret)&nbsp;==&nbsp;24;</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">因此，我们需要提取这两个secret来确定显示成功消息的正确的用户输入。通过反编译APK，可以很简单地恢复Java层的secret。然而，native层的函数通过混淆隐藏了secret使其不容易恢复，只通过静态的方法可能相当乏味耗时。hook或符号执行可能是一个聪明的想法。为了提取这些信息，我的解决方案是通过Frida。这个工具是一个注入JavaScript探索Windows，MacOS，Linux，iOS，Android和QNX上的应用程序的框架，并且这个工具还在不断改进中。Frida用于执行动态分析，hex-rays用于反编译native层代码，BytecodeViewer(Procyon)用于反编译Java层代码。使用hex-rays是因为它的ARM代码反编译出来的结果很可靠。Radare2加上开源的反编译器也可以做得很好。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">提取隐藏的secret</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">这篇文章的结构分为四个部分。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">逆向Dalvik字节码。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">逆向native层的代码。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">使用Frida插桩Dalvik字节码。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">使用Frida插桩native层的代码。</span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192); font-size: 18px;"><strong><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">1.逆向Dalvik字节码(classes.dex)</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">首先需要解压APK得到几个文件，以便稍后进行逆向。为了做到这一点，你可以使用apktool或7zip。一旦APK被打包，下面这两个文件在这篇文章中是非常重要的。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">./classes.dex包含Dalvik字节码。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">./lib/arm64-v8a/libfoo.so是一个包含ARM64汇编代码的native库。在这篇文章中讨论native代码时，我们会参考这一点(如果需要，请随意使用x86/ARM32代码)。当我在Nexus5X中运行应用程序时，对应的需要逆向的是为ARM64架构编译的库。</span></p><p style="text-align:center"><img src="http://p3.qhimg.com/t0147579b896548543f.png" title="t019cc3ab3913ca9eea.png" alt="http://p1.qhimg.com/t019cc3ab3913ca9eea.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">下面显示的MainActivity的代码片段是通过反编译UnCrackable app Level3的main class获得的。有一些有趣的问题需要讨论。</span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(227, 108, 9);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">(String xorkey = &quot;pizzapizzapizzapizzapizz&quot;)中的硬编码的key。</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(227, 108, 9);"><strong><span style="color: rgb(227, 108, 9); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">加载native库libfoo.so和两种native方法的声明：将通过JNI调用的init()和baz()。请注意，一个方法是用xorkey初始化的。</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(227, 108, 9);"><strong><span style="color: rgb(227, 108, 9); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">追踪变量和类，以防在运行时检测到任何篡改。</span></strong></span></p><pre class="brush:plain;toolbar:false">public&nbsp;class&nbsp;MainActivity&nbsp;extends&nbsp;AppCompatActivity&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;TAG&nbsp;=&nbsp;&quot;UnCrackable3&quot;;
&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;CodeCheck&nbsp;check;
&nbsp;&nbsp;&nbsp;&nbsp;Map&nbsp;crc;
&nbsp;&nbsp;&nbsp;&nbsp;static&nbsp;int&nbsp;tampered&nbsp;=&nbsp;0;
&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;static&nbsp;final&nbsp;String&nbsp;xorkey&nbsp;=&nbsp;&quot;pizzapizzapizzapizzapizz&quot;;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;static&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MainActivity.tampered&nbsp;=&nbsp;0;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.loadLibrary(&quot;foo&quot;);
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;MainActivity()&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;super();
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;native&nbsp;long&nbsp;baz();
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;private&nbsp;native&nbsp;void&nbsp;init(byte[]&nbsp;xorkey)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;//&lt;REDACTED&gt;
&nbsp;}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">当应用程序启动时，main activity的onCreate()方法被执行，该方法在Java层执行以下操作。</span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(227, 108, 9);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">通过计算CRC校验和来验证native库的完整性。请注意，native库的签名没有用到任何加密方法。</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(227, 108, 9);"><strong><span style="color: rgb(227, 108, 9); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">初始化native库，并通过JNI调用将Java secret(&quot;pizzapizzapizzapizzapizz&quot;)发送到native代码。</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(227, 108, 9);"><strong><span style="color: rgb(227, 108, 9); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">执行root，调试和篡改检测。如果检测到任何一个，则应用程序中止。</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">反编译代码如下。</span></p><pre class="brush:plain;toolbar:false">protected&nbsp;void&nbsp;onCreate(Bundle&nbsp;savedInstanceState)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;this.verifyLibs();
&nbsp;&nbsp;&nbsp;&nbsp;this.init(&quot;pizzapizzapizzapizzapizz&quot;.getBytes());
&nbsp;&nbsp;&nbsp;&nbsp;new&nbsp;AsyncTask()&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;Object&nbsp;doInBackground(Object[]&nbsp;arg2)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;this.doInBackground(((Void[])arg2));
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;String&nbsp;doInBackground(Void[]&nbsp;params)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while(!Debug.isDebuggerConnected())&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;SystemClock.sleep(100);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;null;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;void&nbsp;onPostExecute(Object&nbsp;arg1)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.onPostExecute(((String)arg1));
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;void&nbsp;onPostExecute(String&nbsp;msg)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MainActivity.this.showDialog(&quot;Debugger&nbsp;detected!&quot;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.exit(0);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;}.execute(new&nbsp;Void[]{null,&nbsp;null,&nbsp;null});
&nbsp;&nbsp;&nbsp;&nbsp;if((RootDetection.checkRoot1())&nbsp;||&nbsp;(RootDetection.checkRoot2())&nbsp;||&nbsp;(RootDetection.checkRoot3())
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;||&nbsp;(IntegrityCheck.isDebuggable(this.getApplicationContext()))&nbsp;||&nbsp;MainActivity.tampered
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!=&nbsp;0)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.showDialog(&quot;Rooting&nbsp;or&nbsp;tampering&nbsp;detected.&quot;);
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;this.check&nbsp;=&nbsp;new&nbsp;CodeCheck();
&nbsp;&nbsp;&nbsp;&nbsp;super.onCreate(savedInstanceState);
&nbsp;&nbsp;&nbsp;&nbsp;this.setContentView(0x7F04001B);
}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">一旦观察到应用程序的主要流程，我们现在来描述找到的安全机制。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">完整性检查：如上所述，verifyLibs在保护native库和Dalvik字节码的功能中使用了完整性检查。请注意，由于使用了较弱的CRC校验和，重新打包Dalvik字节码和native代码可能仍然可行。通过patch Dalvik字节码中的verifyLibs函数和native库中的baz函数，攻击者可以绕过所有的完整性检查，然后继续篡改app。负责验证库的函数反编译如下。</span></p><pre class="brush:plain;toolbar:false">private&nbsp;void&nbsp;verifyLibs()&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;(this.crc&nbsp;=&nbsp;new&nbsp;HashMap&lt;String,&nbsp;Long&gt;()).put(&quot;armeabi&quot;,&nbsp;Long.parseLong(this.getResources().getString(2131099684)));
&nbsp;&nbsp;&nbsp;&nbsp;this.crc.put(&quot;mips&quot;,&nbsp;Long.parseLong(this.getResources().getString(2131099689)));
&nbsp;&nbsp;&nbsp;&nbsp;this.crc.put(&quot;armeabi-v7a&quot;,&nbsp;Long.parseLong(this.getResources().getString(2131099685)));
&nbsp;&nbsp;&nbsp;&nbsp;this.crc.put(&quot;arm64-v8a&quot;,&nbsp;Long.parseLong(this.getResources().getString(2131099683)));
&nbsp;&nbsp;&nbsp;&nbsp;this.crc.put(&quot;mips64&quot;,&nbsp;Long.parseLong(this.getResources().getString(2131099690)));
&nbsp;&nbsp;&nbsp;&nbsp;this.crc.put(&quot;x86&quot;,&nbsp;Long.parseLong(this.getResources().getString(2131099691)));
&nbsp;&nbsp;&nbsp;&nbsp;this.crc.put(&quot;x86_64&quot;,&nbsp;Long.parseLong(this.getResources().getString(2131099692)));
&nbsp;&nbsp;&nbsp;&nbsp;ZipFile&nbsp;zipFile&nbsp;=&nbsp;null;
&nbsp;&nbsp;&nbsp;&nbsp;Label_0419:&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;try&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;zipFile&nbsp;=&nbsp;new&nbsp;ZipFile(this.getPackageCodePath());
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(final&nbsp;Map.Entry&lt;String,&nbsp;Long&gt;&nbsp;entry&nbsp;:&nbsp;this.crc.entrySet())&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;String&nbsp;string&nbsp;=&nbsp;&quot;lib/&quot;&nbsp;+&nbsp;entry.getKey()&nbsp;+&nbsp;&quot;/libfoo.so&quot;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;ZipEntry&nbsp;entry2&nbsp;=&nbsp;zipFile.getEntry(string);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Log.v(&quot;UnCrackable3&quot;,&nbsp;&quot;CRC[&quot;&nbsp;+&nbsp;string&nbsp;+&nbsp;&quot;]&nbsp;=&nbsp;&quot;&nbsp;+&nbsp;entry2.getCrc());
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(entry2.getCrc()&nbsp;!=&nbsp;entry.getValue())&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MainActivity.tampered&nbsp;=&nbsp;31337;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Log.v(&quot;UnCrackable3&quot;,&nbsp;string&nbsp;+&nbsp;&quot;:&nbsp;Invalid&nbsp;checksum&nbsp;=&nbsp;&quot;&nbsp;+&nbsp;entry2.getCrc()&nbsp;+&nbsp;&quot;,&nbsp;supposed&nbsp;to&nbsp;be&nbsp;&quot;&nbsp;+&nbsp;entry.getValue());
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break&nbsp;Label_0419;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;catch&nbsp;(IOException&nbsp;ex)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Log.v(&quot;UnCrackable3&quot;,&nbsp;&quot;Exception&quot;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;System.exit(0);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;final&nbsp;ZipEntry&nbsp;entry3&nbsp;=&nbsp;zipFile.getEntry(&quot;classes.dex&quot;);
&nbsp;&nbsp;&nbsp;&nbsp;Log.v(&quot;UnCrackable3&quot;,&nbsp;&quot;CRC[&quot;&nbsp;+&nbsp;&quot;classes.dex&quot;&nbsp;+&nbsp;&quot;]&nbsp;=&nbsp;&quot;&nbsp;+&nbsp;entry3.getCrc());
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(entry3.getCrc()&nbsp;!=&nbsp;this.baz())&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MainActivity.tampered&nbsp;=&nbsp;31337;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Log.v(&quot;UnCrackable3&quot;,&nbsp;&quot;classes.dex&quot;&nbsp;+&nbsp;&quot;:&nbsp;crc&nbsp;=&nbsp;&quot;&nbsp;+&nbsp;entry3.getCrc()&nbsp;+&nbsp;&quot;,&nbsp;supposed&nbsp;to&nbsp;be&nbsp;&quot;&nbsp;+&nbsp;this.baz());
&nbsp;&nbsp;&nbsp;&nbsp;}
}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">在这些完整性检查之上，我们还观察到，类IntegrityCheck还验证了应用程序没有被篡改，因此不包含可调试标志。这个类被反编译如下。</span></p><pre class="brush:plain;toolbar:false">package&nbsp;sg.vantagepoint.util;
&nbsp;
import&nbsp;android.content.*;
&nbsp;
public&nbsp;class&nbsp;IntegrityCheck
{
&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;boolean&nbsp;isDebuggable(final&nbsp;Context&nbsp;context)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;(0x2&nbsp;&amp;&nbsp;context.getApplicationContext().getApplicationInfo().flags)&nbsp;!=&nbsp;0x0;
&nbsp;&nbsp;&nbsp;&nbsp;}
}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">阅读ADB日志，我们还可以跟踪运行APP时执行的计算。运行时这些检查的一个例子如下。</span></p><pre class="brush:plain;toolbar:false">05-06&nbsp;16:58:39.353&nbsp;&nbsp;9623&nbsp;10651&nbsp;I&nbsp;ActivityManager:&nbsp;Start&nbsp;proc&nbsp;15027:sg.vantagepoint.uncrackable3/u0a92&nbsp;for&nbsp;activity&nbsp;sg.vantagepoint.uncrackable3/.MainActivity
05-06&nbsp;16:58:40.096&nbsp;15027&nbsp;15027&nbsp;V&nbsp;UnCrackable3:&nbsp;CRC[lib/armeabi/libfoo.so]&nbsp;=&nbsp;1285790320
05-06&nbsp;16:58:40.096&nbsp;15027&nbsp;15027&nbsp;V&nbsp;UnCrackable3:&nbsp;CRC[lib/mips/libfoo.so]&nbsp;=&nbsp;839666376
05-06&nbsp;16:58:40.096&nbsp;15027&nbsp;15027&nbsp;V&nbsp;UnCrackable3:&nbsp;CRC[lib/armeabi-v7a/libfoo.so]&nbsp;=&nbsp;2238279083
05-06&nbsp;16:58:40.096&nbsp;15027&nbsp;15027&nbsp;V&nbsp;UnCrackable3:&nbsp;CRC[lib/arm64-v8a/libfoo.so]&nbsp;=&nbsp;2185392167
05-06&nbsp;16:58:40.096&nbsp;15027&nbsp;15027&nbsp;V&nbsp;UnCrackable3:&nbsp;CRC[lib/mips64/libfoo.so]&nbsp;=&nbsp;2232215089
05-06&nbsp;16:58:40.096&nbsp;15027&nbsp;15027&nbsp;V&nbsp;UnCrackable3:&nbsp;CRC[lib/x86_64/libfoo.so]&nbsp;=&nbsp;1653680883
05-06&nbsp;16:58:40.097&nbsp;15027&nbsp;15027&nbsp;V&nbsp;UnCrackable3:&nbsp;CRC[lib/x86/libfoo.so]&nbsp;=&nbsp;1546037721
05-06&nbsp;16:58:40.097&nbsp;15027&nbsp;15027&nbsp;V&nbsp;UnCrackable3:&nbsp;CRC[classes.dex]&nbsp;=&nbsp;2378563664</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">因为我们不想patch二进制代码，所以我们不会深入这些检查。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Root检查：Java包sg.vantagepoint.util有一个称为RootDetection的类，最多可执行三次检查，以检测运行该应用程序的设备是否已经root。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">checkRoot1()检查文件系统中是否存在二进制文件su。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">checkRoot2()检查BUILD标签test-keys。默认情况下，来自Google的ROM是使用release-keys标签构建的。如果test-keys存在，这可能意味着在设备上构建的Android是测试版或非Google官方发布的。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">checkRoot3()检查危险的root应用程序、配置文件和守护程序的存在。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">负责执行root检查的Java代码如下。</span></p><pre class="brush:plain;toolbar:false">package&nbsp;sg.vantagepoint.util;
&nbsp;
import&nbsp;android.os.Build;
import&nbsp;java.io.File;
&nbsp;
public&nbsp;class&nbsp;RootDetection&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;RootDetection()&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;super();
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;boolean&nbsp;checkRoot1()&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean&nbsp;bool&nbsp;=&nbsp;false;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String[]&nbsp;array_string&nbsp;=&nbsp;System.getenv(&quot;PATH&quot;).split(&quot;:&quot;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;i&nbsp;=&nbsp;array_string.length;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;i1&nbsp;=&nbsp;0;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while(i1&nbsp;&lt;&nbsp;i)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(new&nbsp;File(array_string[i1],&nbsp;&quot;su&quot;).exists())&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bool&nbsp;=&nbsp;true;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++i1;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;bool;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;bool;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;boolean&nbsp;checkRoot2()&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String&nbsp;string0&nbsp;=&nbsp;Build.TAGS;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean&nbsp;bool&nbsp;=&nbsp;string0&nbsp;==&nbsp;null&nbsp;||&nbsp;!string0.contains(&quot;test-keys&quot;)&nbsp;?&nbsp;false&nbsp;:&nbsp;true;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;bool;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;static&nbsp;boolean&nbsp;checkRoot3()&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;boolean&nbsp;bool&nbsp;=&nbsp;true;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;String[]&nbsp;array_string&nbsp;=&nbsp;new&nbsp;String[]{&quot;/system/app/Superuser.apk&quot;,&nbsp;&quot;/system/xbin/daemonsu&quot;,&nbsp;&quot;/system/etc/init.d/99SuperSUDaemon&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;/system/bin/.ext/.su&quot;,&nbsp;&quot;/system/etc/.has_su_daemon&quot;,&nbsp;&quot;/system/etc/.installed_su_daemon&quot;,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;/dev/com.koushikdutta.superuser.daemon/&quot;};
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;i&nbsp;=&nbsp;array_string.length;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;i1&nbsp;=&nbsp;0;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while(true)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(i1&nbsp;&gt;=&nbsp;i)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;false;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;if(!new&nbsp;File(array_string[i1]).exists())&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;++i1;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;bool;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;false;
&nbsp;&nbsp;&nbsp;&nbsp;}
}</pre><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192); font-size: 18px;"><strong><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">2.逆向native代码(libfoo.so)</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Java(Dalvik)和native代码通过JNI调用进行通信。当Java代码启动时将加载native代码，并使用包含Java密钥的一堆字节对其进行初始化。除了保护secret的函数之外，native代码不会被混淆。此外，它删除一些符号并且不是静态编译的。重要的是IDA Pro可能不会将JNI回调检测为函数。为了解决这个问题，只需转到exports窗口在导出的Java_sg_vantagepoint_uncrackable3_MainActivity_*按下P键。之后，您还需要在其函数声明处按Y键重新定义函数参数。您可以定义JNIEnv*对象以获得更好的反编译结果，如本节中所示的类C代码。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">native构造函数：ELF二进制文件包含一个称为.init_array的部分，它保存了当程序启动时将执行的函数的指针。如果我们观察在其构造函数中的ARM共享对象，那么我们可以在偏移0x19cb0处看到函数指针sub_73D0:(在IDA Pro中使用快捷键ctrl+s显示sections)。</span></p><pre class="brush:plain;toolbar:false">.init_array:0000000000019CB0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;==================================================
.init_array:0000000000019CB0
.init_array:0000000000019CB0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;Segment&nbsp;type:&nbsp;Pure&nbsp;data
.init_array:0000000000019CB0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;AREA&nbsp;.init_array,&nbsp;DATA,
.init_array:0000000000019CB0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;ORG&nbsp;0x19CB0
.init_array:0000000000019CB0&nbsp;D0&nbsp;73&nbsp;00&nbsp;00&nbsp;00&nbsp;00+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;DCQ&nbsp;sub_73D0
.init_array:0000000000019CB8&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00+&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ALIGN&nbsp;0x20
.init_array:0000000000019CB8&nbsp;00&nbsp;00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;.init_array&nbsp;&nbsp;&nbsp;ends
.init_array:0000000000019CB8
.fini_array:0000000000019CC0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;==================================================</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Radare2最近也支持JNI init方法的识别。感谢@pancake和@alvaro_fe，他们在radare2快速实现了支持JNI入口点。如果您正在使用radare2，只需使用命令ie即可显示入口点。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">构造函数sub_73D0()执行以下操作。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">①pthread_create()函数创建一个新线程执行monitor_frida_xposed函数。此函数已被重命名为这个名称，因为Frida和Xposed这两个框架不间断地被检查，以避免hook操作。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">②在从Java secret初始化之前，xorkey_native的内存被清除。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">③codecheck变量是确定完整性的计数器。之后，在计算native secret之前会检查它。因此，我们需要这个函数结束之后获得正确的codecheck值以进入最终的验证。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">sub_73D0()(重命名为init)的反编译代码如下。</span></p><pre class="brush:plain;toolbar:false">int&nbsp;init()
{
&nbsp;&nbsp;int&nbsp;result;&nbsp;//&nbsp;r0@1
&nbsp;&nbsp;pthread_t&nbsp;newthread;&nbsp;//&nbsp;[sp+10h]&nbsp;[bp-10h]@1
&nbsp;
&nbsp;&nbsp;result&nbsp;=&nbsp;pthread_create(&amp;newthread,&nbsp;0,&nbsp;(void&nbsp;*(*)(void&nbsp;*))monitor_frida_xposed,&nbsp;0);
&nbsp;&nbsp;byte_9034&nbsp;=&nbsp;0;
&nbsp;&nbsp;dword_9030&nbsp;=&nbsp;0;
&nbsp;&nbsp;dword_902C&nbsp;=&nbsp;0;
&nbsp;&nbsp;dword_9028&nbsp;=&nbsp;0;
&nbsp;&nbsp;dword_9024&nbsp;=&nbsp;0;
&nbsp;&nbsp;dword_9020&nbsp;=&nbsp;0;
&nbsp;&nbsp;xorkey_native&nbsp;=&nbsp;0;
&nbsp;&nbsp;++codecheck;
&nbsp;&nbsp;return&nbsp;result;
}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">native反hook检查：monitor_frida_xposed函数执行几个安全检查，以避免人们使用DBI框架。如果我们仔细观察以下反编译代码，那么可以看到几个DBI框架被列入黑名单。这种检查在无限循环中进行一遍又一遍，如果检测到任何DBI框架，则调用goodbye函数并且应用程序崩溃。该函数的反编译代码如下。</span></p><pre class="brush:plain;toolbar:false">void&nbsp;__fastcall&nbsp;__noreturn&nbsp;monitor_frida_xposed(int&nbsp;a1)
{
&nbsp;&nbsp;FILE&nbsp;*stream;&nbsp;//&nbsp;[sp+2Ch]&nbsp;[bp-214h]@1
&nbsp;&nbsp;char&nbsp;s;&nbsp;//&nbsp;[sp+30h]&nbsp;[bp-210h]@2
&nbsp;
&nbsp;&nbsp;while&nbsp;(&nbsp;1&nbsp;)
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;stream&nbsp;=&nbsp;fopen(&quot;/proc/self/maps&quot;,&nbsp;&quot;r&quot;);
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;!stream&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;
&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;(&nbsp;fgets(&amp;s,&nbsp;512,&nbsp;stream)&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;strstr(&amp;s,&nbsp;&quot;frida&quot;)&nbsp;||&nbsp;strstr(&amp;s,&nbsp;&quot;xposed&quot;)&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_android_log_print(2,&nbsp;&quot;UnCrackable3&quot;,&nbsp;&quot;Tampering&nbsp;detected!&nbsp;Terminating...&quot;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goodbye();
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;fclose(stream);
&nbsp;&nbsp;&nbsp;&nbsp;usleep(500u);
&nbsp;&nbsp;}
&nbsp;&nbsp;_android_log_print(2,&nbsp;&quot;UnCrackable3&quot;,&nbsp;&quot;Error&nbsp;opening&nbsp;/proc/self/maps!&nbsp;Terminating...&quot;);
&nbsp;&nbsp;goodbye();
}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">下面显示了篡改检测的示例，其中应用程序使用信号SIGABRT(6)中止。</span></p><pre class="brush:plain;toolbar:false">ActivityManager:&nbsp;Start&nbsp;proc&nbsp;7098:sg.vantagepoint.uncrackable3/u0a92&nbsp;for&nbsp;activity&nbsp;sg.vantagepoint.uncrackable3/.MainActivity
UnCrackable3:&nbsp;Tampering&nbsp;detected!&nbsp;Terminating...
libc&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;Fatal&nbsp;signal&nbsp;6&nbsp;(SIGABRT),&nbsp;code&nbsp;-6&nbsp;in&nbsp;tid&nbsp;7112&nbsp;(nt.uncrackable3)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;debuggerd:&nbsp;handling&nbsp;request:&nbsp;pid=7098&nbsp;uid=10092&nbsp;gid=10092&nbsp;tid=7112
DEBUG&nbsp;&nbsp;&nbsp;:&nbsp;***&nbsp;***&nbsp;***&nbsp;***&nbsp;***&nbsp;***&nbsp;***&nbsp;***&nbsp;***&nbsp;***&nbsp;***&nbsp;***&nbsp;***&nbsp;***&nbsp;***&nbsp;***
DEBUG&nbsp;&nbsp;&nbsp;:&nbsp;Build&nbsp;fingerprint:&nbsp;&#39;google/bullhead/bullhead:7.1.1/N4F26O/3582057:user/release-keys&#39;
DEBUG&nbsp;&nbsp;&nbsp;:&nbsp;Revision:&nbsp;&#39;rev_1.0&#39;
DEBUG&nbsp;&nbsp;&nbsp;:&nbsp;ABI:&nbsp;&#39;arm64&#39;
DEBUG&nbsp;&nbsp;&nbsp;:&nbsp;pid:&nbsp;7098,&nbsp;tid:&nbsp;7112,&nbsp;name:&nbsp;nt.uncrackable3&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;sg.vantagepoint.uncrackable3&nbsp;&lt;&lt;&lt;
DEBUG&nbsp;&nbsp;&nbsp;:&nbsp;signal&nbsp;6&nbsp;(SIGABRT),&nbsp;code&nbsp;-6&nbsp;(SI_TKILL),&nbsp;fault&nbsp;addr&nbsp;--------
DEBUG&nbsp;&nbsp;&nbsp;:&nbsp;&nbsp;x0&nbsp;&nbsp;&nbsp;0000000000000000&nbsp;&nbsp;x1&nbsp;&nbsp;&nbsp;0000000000001bc8&nbsp;&nbsp;x2&nbsp;&nbsp;&nbsp;0000000000000006&nbsp;&nbsp;x3&nbsp;&nbsp;&nbsp;0000000000000003
DEBUG&nbsp;&nbsp;&nbsp;:&nbsp;&nbsp;x4&nbsp;&nbsp;&nbsp;0000000000000000&nbsp;&nbsp;x5&nbsp;&nbsp;&nbsp;0000000000000000&nbsp;&nbsp;x6&nbsp;&nbsp;&nbsp;00000074378cc000&nbsp;&nbsp;x7&nbsp;&nbsp;&nbsp;0000000000000000
DEBUG&nbsp;&nbsp;&nbsp;:&nbsp;&nbsp;x8&nbsp;&nbsp;&nbsp;0000000000000083&nbsp;&nbsp;x9&nbsp;&nbsp;&nbsp;0000000000000031&nbsp;&nbsp;x10&nbsp;&nbsp;00000074323d5c20&nbsp;&nbsp;x11&nbsp;&nbsp;0000000000000023
DEBUG&nbsp;&nbsp;&nbsp;:&nbsp;&nbsp;x12&nbsp;&nbsp;0000000000000018&nbsp;&nbsp;x13&nbsp;&nbsp;0000000000000000&nbsp;&nbsp;x14&nbsp;&nbsp;0000000000000000&nbsp;&nbsp;x15&nbsp;&nbsp;003687eda0f93200
DEBUG&nbsp;&nbsp;&nbsp;:&nbsp;&nbsp;x16&nbsp;&nbsp;0000007436453ee0&nbsp;&nbsp;x17&nbsp;&nbsp;00000074363fdb24&nbsp;&nbsp;x18&nbsp;&nbsp;000000006ff29a18&nbsp;&nbsp;x19&nbsp;&nbsp;00000074323d64f8
DEBUG&nbsp;&nbsp;&nbsp;:&nbsp;&nbsp;x20&nbsp;&nbsp;0000000000000006&nbsp;&nbsp;x21&nbsp;&nbsp;00000074323d6450&nbsp;&nbsp;x22&nbsp;&nbsp;0000000000000000&nbsp;&nbsp;x23&nbsp;&nbsp;e9e946d86ea1f14f
DEBUG&nbsp;&nbsp;&nbsp;:&nbsp;&nbsp;x24&nbsp;&nbsp;00000074323d64d0&nbsp;&nbsp;x25&nbsp;&nbsp;00000000000fd000&nbsp;&nbsp;x26&nbsp;&nbsp;e9e946d86ea1f14f&nbsp;&nbsp;x27&nbsp;&nbsp;00000074323de2f8
DEBUG&nbsp;&nbsp;&nbsp;:&nbsp;&nbsp;x28&nbsp;&nbsp;0000000000000000&nbsp;&nbsp;x29&nbsp;&nbsp;00000074323d6140&nbsp;&nbsp;x30&nbsp;&nbsp;00000074363faf50
DEBUG&nbsp;&nbsp;&nbsp;:&nbsp;&nbsp;sp&nbsp;&nbsp;&nbsp;00000074323d6120&nbsp;&nbsp;pc&nbsp;&nbsp;&nbsp;00000074363fdb2c&nbsp;&nbsp;pstate&nbsp;0000000060000000
DEBUG&nbsp;&nbsp;&nbsp;:
DEBUG&nbsp;&nbsp;&nbsp;:&nbsp;backtrace:
DEBUG&nbsp;&nbsp;&nbsp;:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#00&nbsp;pc&nbsp;000000000004fb2c&nbsp;&nbsp;/system/lib64/libc.so&nbsp;(offset&nbsp;0x1c000)
DEBUG&nbsp;&nbsp;&nbsp;:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#01&nbsp;pc&nbsp;000000000004cf4c&nbsp;&nbsp;/system/lib64/libc.so&nbsp;(offset&nbsp;0x1c000)</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">在DBI部分我们将通过以不同的方式插桩，了解如何绕过这些检查。使用Frida绕过反frida检查那将是最好不过了。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">native反调试检查：Java_sg_vantagepoint_uncrackable3_MainActivity_init先执行anti_debug函数，如果反调试检查正确完成那么复制xorkey到全局变量中并将全局计数器codecheck递增以用来稍后检测。该变量的值在验证时需要等于2，因为这将意味着反DBI和反调试检查正确完成。这个JNI调用被反编译如下。</span></p><pre class="brush:plain;toolbar:false">int&nbsp;*__fastcall&nbsp;Java_sg_vantagepoint_uncrackable3_MainActivity_init(JNIEnv&nbsp;*env,&nbsp;jobject&nbsp;this,&nbsp;char&nbsp;*xorkey)
{
&nbsp;&nbsp;const&nbsp;char&nbsp;*xorkey_jni;&nbsp;//&nbsp;ST18_4@1
&nbsp;&nbsp;int&nbsp;*result;&nbsp;//&nbsp;r0@1
&nbsp;
&nbsp;&nbsp;anti_debug();
&nbsp;&nbsp;xorkey_jni&nbsp;=&nbsp;(const&nbsp;char&nbsp;*)_JNIEnv::GetByteArrayElements(env,&nbsp;xorkey,&nbsp;0);
&nbsp;&nbsp;strncpy((char&nbsp;*)&amp;xorkey_native,&nbsp;xorkey_jni,&nbsp;24u);
&nbsp;&nbsp;_JNIEnv::ReleaseByteArrayElements(env,&nbsp;xorkey,&nbsp;xorkey_jni,&nbsp;2);
&nbsp;&nbsp;result&nbsp;=&nbsp;&amp;codecheck;
&nbsp;&nbsp;++codecheck;
&nbsp;&nbsp;return&nbsp;result;
}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">研究anti_debug函数得到如下所示的代码(函数名称和变量由我重新命名)。</span></p><pre class="brush:plain;toolbar:false">int&nbsp;anti_debug()
{
&nbsp;&nbsp;__pid_t&nbsp;pid;&nbsp;//&nbsp;[sp+28h]&nbsp;[bp-18h]@2
&nbsp;&nbsp;pthread_t&nbsp;newthread;&nbsp;//&nbsp;[sp+2Ch]&nbsp;[bp-14h]@8
&nbsp;&nbsp;int&nbsp;stat_loc;&nbsp;//&nbsp;[sp+30h]&nbsp;[bp-10h]@3
&nbsp;
&nbsp;&nbsp;::pid&nbsp;=&nbsp;fork();
&nbsp;&nbsp;if&nbsp;(&nbsp;::pid&nbsp;)
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;pthread_create(&amp;newthread,&nbsp;0,&nbsp;(void&nbsp;*(*)(void&nbsp;*))monitor_pid,&nbsp;0);
&nbsp;&nbsp;}
&nbsp;&nbsp;else
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;pid&nbsp;=&nbsp;getppid();
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;!ptrace(PTRACE_ATTACH,&nbsp;pid,&nbsp;0,&nbsp;0)&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;waitpid(pid,&nbsp;&amp;stat_loc,&nbsp;0);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ptrace(PTRACE_CONT,&nbsp;pid,&nbsp;0,&nbsp;0);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;(&nbsp;waitpid(pid,&nbsp;&amp;stat_loc,&nbsp;0)&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;(stat_loc&nbsp;&amp;&nbsp;127)&nbsp;!=&nbsp;127&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit(0);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ptrace(PTRACE_CONT,&nbsp;pid);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;}
&nbsp;&nbsp;return&nbsp;_stack_chk_guard;
}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">这个crackme的作者写了一篇很棒的文章，解释了如何执行</span><a href="http://www.vantagepoint.sg/blog/89-more-android-anti-debugging-fun" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">自调试技术</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">。这利用了一个事实，即只有一个调试器可以随时附加到进程。想深入研究的话请仔细看看他的博客，因为我不会在这里重新解释。实际上，如果我们运行附带调试器的应用程序，那么我们可以看到启动了两个线程并且应用程序崩溃。</span></p><pre class="brush:plain;toolbar:false">bullhead:/&nbsp;#&nbsp;ps|grep&nbsp;uncrack
u0_a92&nbsp;&nbsp;&nbsp;&nbsp;7593&nbsp;&nbsp;563&nbsp;&nbsp;&nbsp;1633840&nbsp;76644&nbsp;SyS_epoll_&nbsp;7f99a8fb6c&nbsp;S&nbsp;sg.vantagepoint.uncrackable3
u0_a92&nbsp;&nbsp;&nbsp;&nbsp;7614&nbsp;&nbsp;7593&nbsp;&nbsp;1585956&nbsp;37604&nbsp;ptrace_sto&nbsp;7f99b37e3c&nbsp;t&nbsp;sg.vantagepoint.uncrackable3</pre><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192); font-size: 18px;"><strong><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">3.用Frida hook java层代码</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">现在，我们需要隐藏我们的手机是root过的这一事实。用Frida绕过这些检查的通常方法将是为这些功能编写hook。hook MainActivity的onCreate()的方法上时，出现了一个问题。Frida基本上无法在正确的时候截获方法onCreate()。更多信息可以在</span><a href="https://github.com/frida/frida-java/issues/29" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">frida-Java issue #29</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">找到。我们可以想到其它的方法来绕过这些检查。如果我们接管系统调用的exit()呢？这样做可以让我们不花时间绕过Java安全机制，并且在hook exit方法之后，我们可以继续与应用程序进行交互，就好像没有启动任何检查一样。以下hook是有效的。</span></p><pre class="brush:plain;toolbar:false">Java.perform(function&nbsp;()&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;send(&quot;Placing&nbsp;Java&nbsp;hooks...&quot;);
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;sys&nbsp;=&nbsp;Java.use(&quot;java.lang.System&quot;);
&nbsp;&nbsp;&nbsp;&nbsp;sys.exit.overload(&quot;int&quot;).implementation&nbsp;=&nbsp;function(var_0)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;send(&quot;java.lang.System.exit(I)V&nbsp;&nbsp;//&nbsp;We&nbsp;avoid&nbsp;exiting&nbsp;the&nbsp;application&nbsp;&nbsp;:)&quot;);
&nbsp;&nbsp;&nbsp;&nbsp;};
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;send(&quot;Done&nbsp;Java&nbsp;hooks&nbsp;installed.&quot;);
});</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">一旦我们放置这个hook并启动应用程序，我们就可以输入了。然而，native层检查也需要被绕过。</span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192); font-size: 18px;"><strong><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">4.使用Frida hook native层代码</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">如逆向native代码部分所示，有几个libc函数(例如strstr)执行一些关于Frida和Xposed检查。此外，该应用程序还创建线程来循环检查调试器或附加到应用程序的DBI框架。在这个阶段，我们可以考虑如何绕过这些检查。我想到了hook strstr和hook pthread_create。我们将尝试这两种方法，并将向您展示无论选择哪种方法都能达到相同的效果。请注意，在这两种情况下，应用程序都需要重启，因为Frida将代理注入到程序的地址空间中，然后才会取消附加。因此，反调试检查不是一个大问题。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">解决方案1：hook strstr并禁用反frida检查</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">我们想干扰这一行反编译代码的行为。</span></p><pre class="brush:plain;toolbar:false">if&nbsp;(&nbsp;strstr(&amp;s,&nbsp;&quot;frida&quot;)&nbsp;||&nbsp;strstr(&amp;s,&nbsp;&quot;xposed&quot;)&nbsp;)
{
&nbsp;&nbsp;&nbsp;&nbsp;_android_log_print(2,&nbsp;&quot;UnCrackable3&quot;,&nbsp;&quot;Tampering&nbsp;detected!&nbsp;Terminating...&quot;);
&nbsp;&nbsp;&nbsp;&nbsp;goodbye();
}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">为了hook这个libc函数，我们可以编写一个native hook来检查传递给该函数的字符串是否是Frida或者Xposed然后返回null指针，就像这个字符串没有被发现一样。在Frida中，我们可以使用如下所示的Interceptor附加native hook:(如果要观察整个行为，请取消最后的注释)。</span></p><pre class="brush:plain;toolbar:false">//&nbsp;char&nbsp;*strstr(const&nbsp;char&nbsp;*haystack,&nbsp;const&nbsp;char&nbsp;*needle);
Interceptor.attach(Module.findExportByName(&quot;libc.so&quot;,&nbsp;&quot;strstr&quot;),&nbsp;{
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;onEnter:&nbsp;function&nbsp;(args)&nbsp;{
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.haystack&nbsp;=&nbsp;args[0];
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.needle&nbsp;&nbsp;&nbsp;=&nbsp;args[1];
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.frida&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;Boolean(0);
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;haystack&nbsp;=&nbsp;Memory.readUtf8String(this.haystack);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;needle&nbsp;&nbsp;&nbsp;=&nbsp;Memory.readUtf8String(this.needle);
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;haystack.indexOf(&quot;frida&quot;)&nbsp;!=&nbsp;-1&nbsp;||&nbsp;haystack.indexOf(&quot;xposed&quot;)&nbsp;!=&nbsp;-1&nbsp;)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.frida&nbsp;=&nbsp;Boolean(1);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;},
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;onLeave:&nbsp;function&nbsp;(retval)&nbsp;{
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(this.frida)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//send(&quot;strstr(frida)&nbsp;was&nbsp;patched!!&nbsp;:)&nbsp;&quot;&nbsp;+&nbsp;haystack);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;retval.replace(0);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;retval;
&nbsp;&nbsp;&nbsp;&nbsp;}
});</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">下面是hook strstr之后的输出。</span></p><pre class="brush:plain;toolbar:false">[20:15&nbsp;edu@ubuntu&nbsp;hooks]&nbsp;&gt;&nbsp;python&nbsp;run_usb_spawn.py
pid:&nbsp;7846
[*]&nbsp;Intercepting&nbsp;...
[!]&nbsp;Received:&nbsp;[Placing&nbsp;native&nbsp;hooks....]
[!]&nbsp;Received:&nbsp;[arch:&nbsp;arm64]
[!]&nbsp;Received:&nbsp;[Done&nbsp;with&nbsp;native&nbsp;hooks....]
[!]&nbsp;Received:&nbsp;[strstr(frida)&nbsp;was&nbsp;patched!!&nbsp;77e5d48000-77e6cfb000&nbsp;r-xp&nbsp;00000000&nbsp;fd:00&nbsp;752205&nbsp;&nbsp;&nbsp;&nbsp;/data/local/tmp/re.frida.server/frida-agent-64.so]
[!]&nbsp;Received:&nbsp;[strstr(frida)&nbsp;was&nbsp;patched!!&nbsp;77e5d48000-77e6cfb000&nbsp;r-xp&nbsp;00000000&nbsp;fd:00&nbsp;752205&nbsp;&nbsp;&nbsp;&nbsp;/data/local/tmp/re.frida.server/frida-agent-64.so]
[!]&nbsp;Received:&nbsp;[strstr(frida)&nbsp;was&nbsp;patched!!&nbsp;77e6cfc000-77e6d8e000&nbsp;r--p&nbsp;00fb3000&nbsp;fd:00&nbsp;752205&nbsp;&nbsp;&nbsp;&nbsp;/data/local/tmp/re.frida.server/frida-agent-64.so]
[!]&nbsp;Received:&nbsp;[strstr(frida)&nbsp;was&nbsp;patched!!&nbsp;77e6cfc000-77e6d8e000&nbsp;r--p&nbsp;00fb3000&nbsp;fd:00&nbsp;752205&nbsp;&nbsp;&nbsp;&nbsp;/data/local/tmp/re.frida.server/frida-agent-64.so]
[!]&nbsp;Received:&nbsp;[strstr(frida)&nbsp;was&nbsp;patched!!&nbsp;77e6d8e000-77e6def000&nbsp;rw-p&nbsp;01045000&nbsp;fd:00&nbsp;752205&nbsp;&nbsp;&nbsp;&nbsp;/data/local/tmp/re.frida.server/frida-agent-64.so]
[!]&nbsp;Received:&nbsp;[strstr(frida)&nbsp;was&nbsp;patched!!&nbsp;77e6d8e000-77e6def000&nbsp;rw-p&nbsp;01045000&nbsp;fd:00&nbsp;752205&nbsp;&nbsp;&nbsp;&nbsp;/data/local/tmp/re.frida.server/frida-agent-64.so]
[!]&nbsp;Received:&nbsp;[strstr(frida)&nbsp;was&nbsp;patched!!&nbsp;77ff497000-77ff567000&nbsp;r-xp&nbsp;00000000&nbsp;fd:00&nbsp;752212&nbsp;&nbsp;&nbsp;&nbsp;/data/local/tmp/re.frida.server/frida-loader-64.so]
[!]&nbsp;Received:&nbsp;[strstr(frida)&nbsp;was&nbsp;patched!!&nbsp;77ff497000-77ff567000&nbsp;r-xp&nbsp;00000000&nbsp;fd:00&nbsp;752212&nbsp;&nbsp;&nbsp;&nbsp;/data/local/tmp/re.frida.server/frida-loader-64.so]
[!]&nbsp;Received:&nbsp;[strstr(frida)&nbsp;was&nbsp;patched!!&nbsp;77ff568000-77ff596000&nbsp;r--p&nbsp;000d0000&nbsp;fd:00&nbsp;752212&nbsp;&nbsp;&nbsp;&nbsp;/data/local/tmp/re.frida.server/frida-loader-64.so]
[!]&nbsp;Received:&nbsp;[strstr(frida)&nbsp;was&nbsp;patched!!&nbsp;77ff568000-77ff596000&nbsp;r--p&nbsp;000d0000&nbsp;fd:00&nbsp;752212&nbsp;&nbsp;&nbsp;&nbsp;/data/local/tmp/re.frida.server/frida-loader-64.so]
[!]&nbsp;Received:&nbsp;[strstr(frida)&nbsp;was&nbsp;patched!!&nbsp;77ff596000-77ff5f0000&nbsp;rw-p&nbsp;000fe000&nbsp;fd:00&nbsp;752212&nbsp;&nbsp;&nbsp;&nbsp;/data/local/tmp/re.frida.server/frida-loader-64.so]
[!]&nbsp;Received:&nbsp;[strstr(frida)&nbsp;was&nbsp;patched!!&nbsp;77ff596000-77ff5f0000&nbsp;rw-p&nbsp;000fe000&nbsp;fd:00&nbsp;752212&nbsp;&nbsp;&nbsp;&nbsp;/data/local/tmp/re.frida.server/frida-loader-64.so]
[!]&nbsp;Received:&nbsp;[strstr(frida)&nbsp;was&nbsp;patched!!&nbsp;77e5d48000-77e6cfb000&nbsp;r-xp&nbsp;00000000&nbsp;fd:00&nbsp;752205&nbsp;&nbsp;&nbsp;&nbsp;/data/local/tmp/re.frida.server/frida-agent-64.so]</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">应用程序现在检测不到我们，我们可以在DBI阶段更进一步了。你想到下一次hook哪个函数了吗？之后，我们将hook通过strncmp和xor执行验证的函数。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">解决方案2：替换native函数pthread_create并禁用安全线程</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">如果我们看看pthread_create的交叉引用，那么我们意识到所有的引用都是我们想要影响的回调。请参见下图。</span></p><p style="text-align:center"><img src="http://p4.qhimg.com/t018c22fa3017a0fb26.png" title="t0116be596ad6a7b7db.png" alt="http://p9.qhimg.com/t0116be596ad6a7b7db.png" width="664" height="274" style="width: 664px; height: 274px;"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">请注意，这两个线程有一些共同点。看着它们，我们观察到第一个和第三个参数都是0，如下所示。</span></p><pre class="brush:plain;toolbar:false">pthread_create(&amp;newthread,&nbsp;0,&nbsp;(void&nbsp;*(*)(void&nbsp;*))monitor_pid,&nbsp;0);
pthread_create(&amp;newthread,&nbsp;0,&nbsp;(void&nbsp;*(*)(void&nbsp;*))monitor_frida_xposed,&nbsp;0);</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">为了避免调用这些线程，策略如下。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">①从libc函数获取native指针pthread_create。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">②使用此指针创建native函数。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">③定义native回调并重载此方法。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">④使用Interceptor与replace模式注入。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">⑤如果我们检测到pthread_create想要检测我们，那么我们将假冒回调并且将始终返回0，模拟Frida不在进程的地址空间中。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">以下代码代替native功能pthread_create。</span></p><pre class="brush:plain;toolbar:false">//&nbsp;int&nbsp;pthread_create(pthread_t&nbsp;*thread,&nbsp;const&nbsp;pthread_attr_t&nbsp;*attr,&nbsp;void&nbsp;*(*start_routine)&nbsp;(void&nbsp;*),&nbsp;void&nbsp;*arg);
var&nbsp;p_pthread_create&nbsp;=&nbsp;Module.findExportByName(&quot;libc.so&quot;,&nbsp;&quot;pthread_create&quot;);
var&nbsp;pthread_create&nbsp;=&nbsp;new&nbsp;NativeFunction(&nbsp;p_pthread_create,&nbsp;&quot;int&quot;,&nbsp;[&quot;pointer&quot;,&nbsp;&quot;pointer&quot;,&nbsp;&quot;pointer&quot;,&nbsp;&quot;pointer&quot;]);
send(&quot;NativeFunction&nbsp;pthread_create()&nbsp;replaced&nbsp;@&nbsp;&quot;&nbsp;+&nbsp;pthread_create);
&nbsp;
Interceptor.replace(&nbsp;p_pthread_create,&nbsp;new&nbsp;NativeCallback(function&nbsp;(ptr0,&nbsp;ptr1,&nbsp;ptr2,&nbsp;ptr3)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;send(&quot;pthread_create()&nbsp;overloaded&quot;);
&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;ret&nbsp;=&nbsp;ptr(0);
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(ptr1.isNull()&nbsp;&amp;&amp;&nbsp;ptr3.isNull())&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;send(&quot;loading&nbsp;fake&nbsp;pthread_create&nbsp;because&nbsp;ptr1&nbsp;and&nbsp;ptr3&nbsp;are&nbsp;equal&nbsp;to&nbsp;0!&quot;);
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;send(&quot;loading&nbsp;real&nbsp;pthread_create()&quot;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret&nbsp;=&nbsp;pthread_create(ptr0,ptr1,ptr2,ptr3);
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;do_native_hooks_libfoo();
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;send(&quot;ret:&nbsp;&quot;&nbsp;+&nbsp;ret);
&nbsp;
},&nbsp;&quot;int&quot;,&nbsp;[&quot;pointer&quot;,&nbsp;&quot;pointer&quot;,&nbsp;&quot;pointer&quot;,&nbsp;&quot;pointer&quot;]));</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">让我们运行这个脚本看看会发生什么事情。请注意，两个native调用pthread_create被hook，因此我们绕过了安全检查(init和anti_debug函数)。还要注意，我们希望在第一个和第三个参数被设置为0时避免pthread_create被调用并在应用程序中留下其它正常的线程。</span></p><pre class="brush:plain;toolbar:false">[20:07&nbsp;edu@ubuntu&nbsp;hooks]&nbsp;&gt;&nbsp;python&nbsp;run_usb_spawn.py
pid:&nbsp;11075
[*]&nbsp;Intercepting&nbsp;...
[!]&nbsp;Received:&nbsp;[Placing&nbsp;native&nbsp;hooks....]
[!]&nbsp;Received:&nbsp;[arch:&nbsp;arm64]
[!]&nbsp;Received:&nbsp;[NativeFunction&nbsp;pthread_create()&nbsp;replaced&nbsp;@&nbsp;0x7ef5b63170]
[!]&nbsp;Received:&nbsp;[Done&nbsp;with&nbsp;native&nbsp;hooks....]
[!]&nbsp;Received:&nbsp;[pthread_create()&nbsp;overloaded]
[!]&nbsp;Received:&nbsp;[loading&nbsp;real&nbsp;pthread_create()]
[!]&nbsp;Received:&nbsp;[p_foo&nbsp;is&nbsp;null&nbsp;(libfoo.so).&nbsp;Returning&nbsp;now...]
[!]&nbsp;Received:&nbsp;[ret:&nbsp;0]
[!]&nbsp;Received:&nbsp;[pthread_create()&nbsp;overloaded]
[!]&nbsp;Received:&nbsp;[loading&nbsp;fake&nbsp;pthread_create&nbsp;because&nbsp;ptr1&nbsp;and&nbsp;ptr3&nbsp;are&nbsp;equal&nbsp;to&nbsp;0!]
[!]&nbsp;Received:&nbsp;[ret:&nbsp;0x0]
[!]&nbsp;Received:&nbsp;[pthread_create()&nbsp;overloaded]
[!]&nbsp;Received:&nbsp;[loading&nbsp;fake&nbsp;pthread_create&nbsp;because&nbsp;ptr1&nbsp;and&nbsp;ptr3&nbsp;are&nbsp;equal&nbsp;to&nbsp;0!]
[!]&nbsp;Received:&nbsp;[ret:&nbsp;0x0]
[!]&nbsp;Received:&nbsp;[pthread_create()&nbsp;overloaded]
[!]&nbsp;Received:&nbsp;[loading&nbsp;real&nbsp;pthread_create()]
[!]&nbsp;Received:&nbsp;[ret:&nbsp;0]
[!]&nbsp;Received:&nbsp;[pthread_create()&nbsp;overloaded]
[!]&nbsp;Received:&nbsp;[loading&nbsp;real&nbsp;pthread_create()]
[!]&nbsp;Received:&nbsp;[ret:&nbsp;0]</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">或者，如果你想要更多地使用Frida的话，那么你可能会首先想要调用pthread_create观察行为。为此，您可以使用下面的hook。</span></p><pre class="brush:plain;toolbar:false">//&nbsp;int&nbsp;pthread_create(pthread_t&nbsp;*thread,&nbsp;const&nbsp;pthread_attr_t&nbsp;*attr,&nbsp;void&nbsp;*(*start_routine)&nbsp;(void&nbsp;*),&nbsp;void&nbsp;*arg);
var&nbsp;p_pthread_create&nbsp;=&nbsp;Module.findExportByName(&quot;libc.so&quot;,&quot;pthread_create&quot;);
Interceptor.attach(ptr(p_pthread_create),&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;onEnter:&nbsp;function&nbsp;(args)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.thread&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;args[0];
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.attr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;args[1];
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.start_routine&nbsp;=&nbsp;args[2];
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.arg&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;args[3];
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.fakeRet&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;Boolean(0);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;send(&quot;onEnter()&nbsp;pthread_create(&quot;&nbsp;+&nbsp;this.thread.toString()&nbsp;+&nbsp;&quot;,&nbsp;&quot;&nbsp;+&nbsp;this.attr.toString()&nbsp;+&nbsp;&quot;,&nbsp;&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;+&nbsp;this.start_routine.toString()&nbsp;+&nbsp;&quot;,&nbsp;&quot;&nbsp;+&nbsp;this.arg.toString()&nbsp;+&nbsp;&quot;);&quot;);
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(parseInt(this.attr)&nbsp;==&nbsp;0&nbsp;&amp;&amp;&nbsp;parseInt(this.arg)&nbsp;==&nbsp;0)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;this.fakeRet&nbsp;=&nbsp;Boolean(1);
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;},
&nbsp;&nbsp;&nbsp;&nbsp;onLeave:&nbsp;function&nbsp;(retval)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;send(retval);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;send(&quot;onLeave()&nbsp;pthread_create&quot;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(this.fakeRet&nbsp;==&nbsp;1)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;fakeRet&nbsp;=&nbsp;ptr(0);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;send(&quot;pthread_create&nbsp;real&nbsp;ret:&nbsp;&quot;&nbsp;+&nbsp;retval);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;send(&quot;pthread_create&nbsp;fake&nbsp;ret:&nbsp;&quot;&nbsp;+&nbsp;fakeRet);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;fakeRet;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;retval;
&nbsp;&nbsp;&nbsp;&nbsp;}
});</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Hook secret：一旦抵达这里，我们几乎准备好进行最后一步了。下一个native hook将包含拦截与用户输入进行比较的参数。在下面的C代码中，我们已经把一个函数重命名为protect_secret。这个函数在一堆经过混淆的操作之后生成secret。一旦生成了这个secret，它就在strncmp_with_xor函数中与用户输入进行比较。如果我们hook这个函数的参数呢？</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">验证的代码被反编译如下:(名称由我重命名)。</span></p><pre class="brush:plain;toolbar:false">bool&nbsp;__fastcall&nbsp;Java_sg_vantagepoint_uncrackable3_CodeCheck_bar(JNIEnv&nbsp;*env,&nbsp;jobject&nbsp;this,&nbsp;jbyte&nbsp;*user_input)
{
&nbsp;&nbsp;bool&nbsp;result;&nbsp;//&nbsp;r0@6
&nbsp;&nbsp;int&nbsp;user_input_native;&nbsp;//&nbsp;[sp+1Ch]&nbsp;[bp-3Ch]@2
&nbsp;&nbsp;bool&nbsp;ret;&nbsp;//&nbsp;[sp+2Fh]&nbsp;[bp-29h]@4
&nbsp;&nbsp;int&nbsp;secret;&nbsp;//&nbsp;[sp+30h]&nbsp;[bp-28h]@1
&nbsp;&nbsp;int&nbsp;v9;&nbsp;//&nbsp;[sp+34h]&nbsp;[bp-24h]@1
&nbsp;&nbsp;int&nbsp;v10;&nbsp;//&nbsp;[sp+38h]&nbsp;[bp-20h]@1
&nbsp;&nbsp;int&nbsp;v11;&nbsp;//&nbsp;[sp+3Ch]&nbsp;[bp-1Ch]@1
&nbsp;&nbsp;int&nbsp;v12;&nbsp;//&nbsp;[sp+40h]&nbsp;[bp-18h]@1
&nbsp;&nbsp;int&nbsp;v13;&nbsp;//&nbsp;[sp+44h]&nbsp;[bp-14h]@1
&nbsp;&nbsp;char&nbsp;v14;&nbsp;//&nbsp;[sp+48h]&nbsp;[bp-10h]@1
&nbsp;&nbsp;int&nbsp;cookie;&nbsp;//&nbsp;[sp+4Ch]&nbsp;[bp-Ch]@6
&nbsp;
&nbsp;&nbsp;v14&nbsp;=&nbsp;0;
&nbsp;&nbsp;v13&nbsp;=&nbsp;0;
&nbsp;&nbsp;v12&nbsp;=&nbsp;0;
&nbsp;&nbsp;v11&nbsp;=&nbsp;0;
&nbsp;&nbsp;v10&nbsp;=&nbsp;0;
&nbsp;&nbsp;v9&nbsp;=&nbsp;0;
&nbsp;&nbsp;secret&nbsp;=&nbsp;0;
&nbsp;&nbsp;ret&nbsp;=&nbsp;codecheck&nbsp;==&nbsp;2
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;(protect_secret(&amp;secret),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;user_input_native&nbsp;=&nbsp;_JNIEnv::GetByteArrayElements(env,&nbsp;user_input,&nbsp;0),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;_JNIEnv::GetArrayLength(env,&nbsp;user_input)&nbsp;==&nbsp;24)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;strncmp_with_xor(user_input_native,&nbsp;(int)&amp;secret,&nbsp;(int)&amp;xorkey_native)&nbsp;==&nbsp;24;
&nbsp;&nbsp;result&nbsp;=&nbsp;ret;
&nbsp;&nbsp;if&nbsp;(&nbsp;_stack_chk_guard&nbsp;==&nbsp;cookie&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;=&nbsp;ret;
&nbsp;&nbsp;return&nbsp;result;
}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">为了准备hook strncmp_with_xor，我们需要在反汇编代码中获得某些偏移量，还要获得libc的基址，并在运行时重新计算最终的指针。可以通过调用Interceptor来附加到native指针。请注意，使用native指针p_protect_secret的hook不需要恢复secret。因此，您可以在脚本中跳过它。</span></p><pre class="brush:plain;toolbar:false">var&nbsp;offset_anti_debug_x64&nbsp;&nbsp;&nbsp;=&nbsp;0x000075f0;
var&nbsp;offset_protect_secret64&nbsp;=&nbsp;0x0000779c;
var&nbsp;offset_strncmp_xor64&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;0x000077ec;
&nbsp;
function&nbsp;do_native_hooks_libfoo(){
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;p_foo&nbsp;=&nbsp;Module.findBaseAddress(&quot;libfoo.so&quot;);
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!p_foo)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;send(&quot;p_foo&nbsp;is&nbsp;null&nbsp;(libfoo.so).&nbsp;Returning&nbsp;now...&quot;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;p_protect_secret&nbsp;=&nbsp;p_foo.add(offset_protect_secret64);
&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;p_strncmp_xor64&nbsp;&nbsp;=&nbsp;p_foo.add(offset_strncmp_xor64);
&nbsp;&nbsp;&nbsp;&nbsp;send(&quot;libfoo.so&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;&quot;&nbsp;+&nbsp;p_foo.toString());
&nbsp;&nbsp;&nbsp;&nbsp;send(&quot;ptr_protect_secret&nbsp;@&nbsp;&quot;&nbsp;+&nbsp;p_protect_secret.toString());
&nbsp;&nbsp;&nbsp;&nbsp;send(&quot;ptr_strncmp_xor64&nbsp;&nbsp;@&nbsp;&quot;&nbsp;+&nbsp;p_strncmp_xor64.toString());
&nbsp;
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;Interceptor.attach(&nbsp;p_protect_secret,&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;onEnter:&nbsp;function&nbsp;(args)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;send(&quot;onEnter()&nbsp;p_protect_secret&quot;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;send(&quot;args[0]:&nbsp;&quot;&nbsp;+&nbsp;args[0]);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;},
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;onLeave:&nbsp;function&nbsp;(retval)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;send(&quot;onLeave()&nbsp;p_protect_secret&quot;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;});
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;Interceptor.attach(&nbsp;p_strncmp_xor64,&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;onEnter:&nbsp;function&nbsp;(args)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;send(&quot;onEnter()&nbsp;p_strncmp_xor64&quot;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;send(&quot;args[0]:&nbsp;&quot;&nbsp;+&nbsp;args[0]);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;send(hexdump(args[0],&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;offset:&nbsp;0,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;length:&nbsp;24,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;header:&nbsp;false,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ansi:&nbsp;true
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}));
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;send(&quot;args[1]:&nbsp;&quot;&nbsp;+&nbsp;args[1]);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;var&nbsp;secret&nbsp;=&nbsp;hexdump(args[1],&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;offset:&nbsp;0,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;length:&nbsp;24,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;header:&nbsp;false,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ansi:&nbsp;true
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;})
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;send(secret);</pre><p style="white-space: normal; text-indent: 2em;"><span style="color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px;"><br/></span></strong></span></p><p style="white-space: normal; text-indent: 2em;"><span style="color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px;">传送门</span></strong></span></p><hr style="white-space: normal;"/><p style="white-space: normal; text-indent: 2em;"><a href="http://bobao.360.cn/learning/detail/3641.html" target="_self" style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px; color: rgb(0, 112, 192);"><strong>【技术分享】利用FRIDA攻击Android应用程序（一）</strong></a></p><p style="white-space: normal; text-indent: 2em;"><a href="http://bobao.360.cn/learning/detail/3634.html" target="_self" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px; color: rgb(0, 112, 192);"><strong>【技术分享】利用FRIDA攻击Android应用程序（二）</strong></a></p><p style="white-space: normal; text-indent: 2em;"><a href="http://bobao.360.cn/learning/detail/3794.html" target="_self" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px; color: rgb(0, 112, 192);"><strong>【技术分享】利用FRIDA攻击Android应用程序（三）</strong></a></p><p><br/></p></p>
                <hr/>
                <p style="text-align: center;">
                    <img src="http://bobao.360.cn/img/app.jpeg"/>
                    <img src="http://bobao.360.cn/img/weixin.jpeg"/>
                </p>
                                <p>本文由 安全客 翻译，转载请注明“转自安全客”，并附上链接。<br/><a class="text-more" href="https://enovella.github.io/android/reverse/2017/05/20/android-owasp-crackmes-level-3.html" target="_blank">原文链接：https://enovella.github.io/android/reverse/2017/05/20/android-owasp-crackmes-level-3.html</a></p>
                            </div>
            <div style="margin-top: 20px;background-color:#FFFFFF">
    <input type="hidden" id="detail_title" name="detail_title" value="【技术分享】利用FRIDA攻击Android应用程序（四） - 安全客 - 有思想的安全新媒体" />
    <input type="hidden" id="use_nickname" name="use_nickname" value="0" />
    <a name="mao"></a>
    <div class="reg-log mobile-hiden">
        <div class="" id="userTo">   
            <div id="to-list" class="input-text" style="">
                <textarea disabled="disabled" class="hide"  id="comment-content" to="to"></textarea>
                <ul id="preadded" style="display:none">       
                </ul>
                <div id="to-auto" style="width: 200px">
                    <ul id="feed">
                    </ul>
                </div>
            </div>
        </div>
        <input type="hidden" id="source-id" value="3930" />
        <input type="hidden" id="source-type" value="learning" />
        <input type="hidden" id="post-comment-url" value="/comment/add" />
        <input type="hidden" id="post-nickname-url-ajax" value="/comment/randnicknameajax" />
        <input type="hidden" id="post-check-login-url-ajax" value="/comment/checklogin" />
        <input type="hidden" id="stoken_comment_set" value="ea3898fb4df38673fdeb61c458234054">                 <span class="join">参与讨论，请先 <a href="javascript:;" class="comment-login">登录</a> | <a href="javascript:;" class="comment-reg">注册</a> |  <a href="javascript:;" class="anonymous-comment">匿名评论</a></span>
            </div>
    <div class="mobile-hide" style="width: 870px; margin: 0 auto;">
        <label style="vertical-align:middle;" for="use_nickname">匿名</label> 
        <input style="vertical-align:middle;" id="trigger-nickname" name="use_nickname" class="use_nickname" type="checkbox" value="0" />

        <a href="javascript:;" class="apply-use button" id="submit-comment" data-target="/comment/add">发布</a>
    </div>


    <div class="clearfix"></div>
    <div class="comments">
        <div class="comments-head">
            <span class="title">用户评论</span>
        </div>
                <div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src='http://p1.qhmsg.com/dm/48_48_100/t01049cac452ac00f3e.jpg'/>              
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="2802394681" class="response" data-bind-id="2802394681" data-target="14508" user-name="houjingyi233" href="javascript:;">
                houjingyi233            </a>
                        <span class="comment-time">2017-06-06 12:46:06</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="2802394681" data-target="14508">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_14508" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">不知道为什么后面有一些内容被吞了，文中的代码可以在https://github.com/enovella/androidtrainings/tree/master/owasp-crackmes上找到</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/9x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="14467" user-name="POIDELREY" href="javascript:;">
                POIDELREY            </a>
                        <span class="comment-time">2017-06-02 22:01:01</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="14467">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_14467" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">//@夏侯爺當家: 转发微博</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/2x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="14452" user-name="安全狗safedog" href="javascript:;">
                安全狗safedog            </a>
                        <span class="comment-time">2017-06-02 10:30:57</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="14452">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_14452" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">好文章</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>

        <a class="more-long comment-more" href="javascript:;" data-target="/comment/more" data-type="learning" data-source-id="3930" data-page="2">查看更多</a>
            </div>
</div>
<script>
    $(function () {
        $('.anonymous-comment').click(function () {
            $(".join").hide();
            $(".reg-log textarea").first().removeAttr("disabled").show();
            $('#use_nickname').val('1');
//            $('#trigger-nickname').attr('checked', true);
            $('#trigger-nickname').trigger('click');
        });
        //为所有复选框绑定事件
//        checkbox_on_click();
        //ajax随机获取昵称
//        randnicknameajax(0);
        //ajax检测登录状态
        comment_check_login();
    });



    function input_checkbox(flag) {
        $('input:checkbox').each(function () {
            var value = flag ? 1 : 0;
            $(this).prop('checked', flag);
            $(this).val(value);
        });
    }

//ajax随机获取昵称
    function randnicknameajax(flag) {
        $.ajax({
            type: 'POST',
            url: $('#post-nickname-url-ajax').val(),
            data: {limit: 1, flag: flag},
            dataType: "json",
            success: function (data) {
                $('#nick-name').val(data.data[0]);
                _nick_name=data.data[0];
            }
        });
    }
    $();
//ajax检测登录状态
    function comment_check_login() {
        $.ajax({
            type: 'POST',
            url: $('#post-check-login-url-ajax').val(),
            data: {},
            dataType: "json",
            success: function (data) {
                if (data.success) {
                    $('.join').hide();
                    $(".reg-log textarea").first().removeAttr("disabled").show();
                    $("#span_use_nickname").show();
                    $('#use_nickname').val('0');
                    $('#use_nickname').attr('checked', false);
                }
            }
        });
    }
</script>        </div>
    </div>
    <div class="side-bar">
        <div class="mod hot-news">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-hot"></i><span>热门知识</span></h2>
    </div>
    <ul class="links-list">
                                <li><a href="/learning/detail/4411.html" alt="【漏洞预警】一个换行符引发的奥斯卡0day漏洞(CVE-2017-8759)重现——最新的Office高级威胁攻击预警" target="_blank">【漏洞预警】一个换行符引发的奥斯卡...</a></li>
                                <li><a href="/learning/detail/4416.html" alt="【漏洞预警】Microsoft .NET Framework漏洞（CVE–2017–8759）预警" target="_blank">【漏洞预警】Microsoft .NE...</a></li>
                                <li><a href="/learning/detail/4414.html" alt="【技术分享】妙用JavaScript绕过XSS过滤" target="_blank">【技术分享】妙用JavaScrip...</a></li>
                                <li><a href="/learning/detail/4418.html" alt="【技术分享】利用威胁情报数据平台拓展APT攻击线索一例" target="_blank">【技术分享】利用威胁情报数据平台拓...</a></li>
                                <li><a href="/learning/detail/4417.html" alt="【知识】9月15日 - 每日安全知识热点" target="_blank">【知识】9月15日 - 每日安全知识热...</a></li>
                                <li><a href="/learning/detail/4425.html" alt="【安全报告】XShellGhost事件技术回顾报告" target="_blank">【安全报告】XShellGhost事件...</a></li>
            </ul>
</div>        <!-- 友情链接 -->
        <div class="mod blog-links mobile-hide">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-link"></i><span>友情链接</span></h2>
        <a href="/links/index.html" class="more">更多<i></i></a>
    </div>
        <ul class="links-list">
                <li><a href="http://bbs.360safe.com" alt="360安全社区" target="_blank">360安全社区</a></li>
                <li><a href="http://zhuji.360.cn" alt="360主机卫士" target="_blank">360主机卫士</a></li>
                <li><a href="http://blogs.360.cn/" alt="奇虎360技术博客" target="_blank">奇虎360技术博客</a></li>
                <li><a href="http://wangzhan.360.cn/" alt="360网站卫士" target="_blank">360网站卫士</a></li>
                <li><a href="http://webscan.360.cn/" alt="360网站安全检测" target="_blank">360网站安全检测</a></li>
                <li><a href="http://research.360.cn/report/" alt="360研究报告" target="_blank">360研究报告</a></li>
                <li><a href="http://unicorn.360.cn/" alt="360 Unicorn Team" target="_blank">360 Unicorn Team</a></li>
                <li><a href="http://appscan.360.cn/" alt="360捉虫猎手" target="_blank">360捉虫猎手</a></li>
                <li><a href="https://threathunter.org/" alt="ThreatHunter社区" target="_blank">ThreatHunter社区</a></li>
                <li><a href="http://security.360.cn/" alt="360安全应急响应中心" target="_blank">360安全应急响应中心</a></li>
            </ul>
    </div>
        <!-- 联系我们 -->
        <div class="mod contact mobile-hide" style="text-align:center">
    <div class="head-bar clearfix">
        <h2><i></i><span>关注我们</span></h2>
    </div>
    <!-- 微信关注 -->
    <ul class="contact-way">
        <li><a>微信关注</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/qrcode_adlab_weixin.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
    <!-- APP下载 -->
    <ul class="contact-way">
        <li><a>安全播报APP</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/scan_code_big.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
</div>

    </div>
</div>

<script type="text/javascript" src="/js/jquery-ui.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/jquery.noty.packaged.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/common.js?v=4.5"></script>
<script>$(function() {sync_count('comment');});</script>


<!-- 语法高亮 -->
<script type="text/javascript" src="/ue/SyntaxHighlighter/shCore.js"></script>
<script type="text/javascript">SyntaxHighlighter.all();sync_count('vul');sync_count('news');sync_count('learning');sync_count('activity');sync_count('course');sync_count('ctf');</script>
    </div>

        <div class="footer">
        <div class="friend-link">
            <a href="http://www.360.cn/" target="_blank">360首页</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">关于我们</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">联系我们</a>
            <span>|</span>
            <a href="/links/index.html" target="_blank">友情链接</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">招贤纳士</a>
        </div>
        <div class="copy">
            Copyright &copy; 360网络攻防实验室 All Rights Reserved <span class="copy_icp">京ICP证080047号[京ICP备08010314号-6]</span>
        </div>
    </div>
    
</div>

<!--奇舞团统计-->

<script src='https://s.ssl.qhimg.com/static/f5407c785655e6a1/monitor_analytic.js'></script>
<script>
    monitor.setProject('QH_171_1').getTrack().getClickAndKeydown().getClickHeatmap(10, 1);
</script>

<div class="hide">
    <script src="https://s95.cnzz.com/z_stat.php?id=1253147824&web_id=1253147824" language="JavaScript"></script>
</div>
<div class="backToTop_wrap off">
    <a id="back_to_top" class="backToTop" href="javascript:;" title="返回顶部"></a>
</div>
<script>
    var $backToTop_wrap = $(".backToTop_wrap"),
        $backToTop_btn = $("#back_to_top");

    if ($(window).scrollTop() > 100) {
        $backToTop_wrap.removeClass("off");
    }
    else {
        $backToTop_wrap.addClass("off");
    }

    $(window).on("scroll", function () {
        if ($(this).scrollTop() > 100) {
            $backToTop_wrap.removeClass("off");
        }
        else {
            $backToTop_wrap.addClass("off");
        }
    });

    $backToTop_btn.on("click", function () {
        $("html, body").animate({scrollTop: 0}, 120);
    });

    $(function () {
        var navlist = $('.nav-list > li');

        navlist.each(function () {
            $(this).on('mouseenter', function () {
                $(this).addClass('selected');
            });

            $(this).on('mouseleave', function () {
                $(this).removeClass('selected');
            });
        });
    })
</script>



</body>
</html>
