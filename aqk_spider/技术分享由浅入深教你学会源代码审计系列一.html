<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns:wb="http://open.weibo.com/wb" xml:lang="en" lang="en">
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"/>
    <link rel="shortcut icon" href="http://bobao.360.cn/favicon.ico?v=1.1"/>
    <link rel="alternate" title="安全资讯" href="/rss?type=news" type="application/rss+xml"/>
    <link rel="alternate" title="安全知识" href="/rss?type=learning" type="application/rss+xml"/>
    <link rel="alternate" title="安全圈活动" href="/rss?type=activity" type="application/rss+xml"/>
    <link rel="alternate" title="所有漏洞" href="/rss?type=vul" type="application/rss+xml"/>
    <link rel="alternate" title="通用型漏洞" href="/rss?type=commonvul" type="application/rss+xml"/>
    <link rel="alternate" title="事件型漏洞" href="/rss?type=eventvul" type="application/rss+xml"/>
    <link rel="alternate" title="热门漏洞" href="/rss?type=hotvul" type="application/rss+xml"/>

        <title>【技术分享】由浅入深教你学会源代码审计系列（一） - 安全客 - 有思想的安全新媒体</title>
    
        <meta name="keywords" content="零基础学习代码审计,0基础学习源码审计,学习漏洞挖掘,安全测试,代码审计,开发"/>
    
        <meta name="description" content="安全圈里有句老话：一切的用户输入都是有害的。的确，我们的所有安全测试都是基于这一点的。既然用户的一切输入都是有害的，那么怎样使这个危害显现出来呢？这就引入了安全的另一句话：有害的数据进入了危险的函数便产生了漏洞 ，因此我们可以总结出安全的两个基本点，数据和函数，我们所做的所有安全相关的工作都是基于这两点。代码审计自然也不例外。"/>
        <meta property="wb:webmaster" content="224437c7be31d633"/>

    <script type="text/javascript" src="http://s7.qhimg.com/!56caa871/xpc_sync_height.js"></script>
    <link rel="stylesheet" type="text/css" href="/css/reset.css" />
    <link rel="stylesheet" type="text/css" href="/css/common_new.css?v=4.4.2.1" />
    <link rel="stylesheet" type="text/css" href="/css/jquery.notyfy.css" />
    <link rel="stylesheet" type="text/css" href="/css/notyfy.theme.default.css" />
    <link rel="stylesheet" type="text/css" href="/css/s_common.css?v=2.2.7" media="only screen and
    (max-device-width:900px), only screen and (max-width:900px)" />
    <script type="text/javascript" src="/js/jquery.min.js?v=3.1"></script>
    <script type="text/javascript" src="/js/jquery.notyfy.js"></script>
    <script type="text/javascript" src="/js/iscroll.js"></script>
    <script src="http://js.passport.qihucdn.com/5.0.3.js"></script>
    <script type="text/javascript">
        var myScroll, myNavScroll;

        function iscrollLoaded() {
            myScroll = new IScroll('#wrapper',
                {
                    scrollX: true,
                    scrollY: false,
                    bounceEasing: 'circular',
                    eventPassthrough: true,
                    preventDefault: false,
                    bounceTime: 500
                }
            );
        }

        $(function () {

            //导航横向滚动


            function setNavWidth() {

                /* 计算导航宽度 */
                var allWidth = $(window).width();
                var scroller = $('#scroller');

                if (allWidth > 900) {
                    scroller.find('ul').add(scroller.find('.scroll')).removeAttr('style');
                    scroller.css('overflow', 'visible');
                    if (myNavScroll) myNavScroll.destroy();
                } else {

                    var width = 0;
                    scroller.find('.scroll').children('ul').children('li').each(function (index, el) {
                        if (!$(this).hasClass('mobile-hide')) {
                            width += $(this).outerWidth();
                        }
                    });
                    scroller.find('ul').add(scroller.find('.scroll')).width(width);

                    if (myNavScroll) myNavScroll.destroy();

                    myNavScroll = new IScroll('#scroller', {
                        scrollX: true,
                        scrollY: false,
                        momentum: false,
                        click: true
                    });

                }

            }

            setNavWidth();
            $(window).resize(function (event) {
                setNavWidth();
            });

        });

    </script>
</head>
<body onload="iscrollLoaded();">
<div style='margin:0 auto;width:0px;height:0px;overflow:hidden;'>
    <img src=""/>
</div>

<div id="is-mobile"></div>
<div class="container">
        <div class="mobile-header">
        <div class="header clearfix">
            <div class="header-wrapper clearfix">
                <a href="/index/index" class="logo"><img class="slogan" src="/img/logo.png?v=1.5"/></a>
                                <form id="search" class="search-box" action="/search/index" method="GET">
                    <input class="keys" name="keywords" type="text" placeholder="搜索漏洞" required="required">
                    <input class="icon" type="submit" value="">
                    <input type="hidden" name="type" value=""/>
                </form>
                <div class="bug">
                    <div class="name"><span class="seled">全部</span><i class="arrow"></i></div>
                    <ul class="typelist">
                        <li data-index="3"><a href="javascript:void(0);">全部</a></li>
                        <li data-index="0"><a href="javascript:void(0);">漏洞</a></li>
                        <li data-index="1"><a href="javascript:void(0);">资讯</a></li>
                        <li data-index="2"><a href="javascript:void(0);">知识</a></li>
                    </ul>
                </div>
                                <div class="logNreg mobile-hide">
                    <div class="unlog">
                        <i></i>
                        <a href="log.html" class="log">登录</a>
                        <span>|</span>
                        <a href="reg.html" class="reg">注册</a>
                    </div>
                    <div class="loged">
                        <a href="/member/profile" class="user-center"><i></i><span class="user-name-tag">个人中心</span></a>
                        <div class="user-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting"><a href="http://i.360.cn/profile/accountmanage"
                                                               target="_blank"><i></i><span>账号设置</span></a></li>
                                <li class="alert-setting"><a href="/keywords/index"
                                                             target="_blank"><i></i><span>告警设置</span></a></li>
                                <li class="bug-alert"><a href="/myalarm/index" target="_blank"><i></i><span>漏洞告警</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mylearn/index" target="_blank"><i></i><span>我的知识</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mycourse/index" target="_blank"><i></i><span>我的课堂</span></a>
                                </li>
                                <li class="my-exit"><a
                                            href="http://login.360.cn/?src=pcw_adlab&op=logout&destUrl=http://bobao.360.cn"><i></i><span>退出系统</span></a>
                                </li>
                            </ul>
                        </div>

                        <a href="/message" class="message-center" target="_blank"><i></i><span>我的消息</span></a>
                        <div class="message-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting" style="display:none;"><a href="/myres/index"
                                                                                     target="_blank"><i></i><span>回复我的</span></a>
                                </li>
                                <li class="my-bug"><a href="/myvul/index"
                                                      target="_blank"><i></i><span>我的漏洞</span></a></li>
                                <!--<li class="my-bug"><a href="/myres/index" target="_blank"><i></i><span>我的评论</span></a></li>-->
                                <!--<li class="alert-setting"><a href="###" target="_blank"><i></i><span>提到我的</span></a>
                                </li>-->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <style type="text/css">
            .nav {
                overflow: hidden;
            }

            .nav .scroll {
                width: auto;
            }
        </style>
        <div id="wrapper">
            <div id="scroller" class="nav">
                <div class="scroll">
                    <ul class="nav-list">
                        <li ><a class="link-nav"
                                                                                 href="/index/index">首页</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/vul/index">漏洞</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/introduce/list">招聘</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/news/index">资讯</a><!--<i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/introduce/list">招聘</a></li>
                        </ul>
			-->
                        </li>
                        <li class="cur">
                        <a class="link-nav" href="/learning/index">知识</a><i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/course/index">学院</a></li>
                        </ul>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/activity/index">活动</a></li>
                        <li class="mobile-hide "><a class="link-nav"
                                                                                                   href="/ctf/index">CTF训练营</a>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/interref/list">安全内参</a></li>
                        <li ><a class="link-nav" href="/app/index">APP</a></li>

                        <!--<li ><a href="/course/index">学院</a></li>-->
                        <!--<li ><a href="/introduce/list">招聘</a></li>-->
                        <!--<li  class="mobile-hide"><a href="/ctf/index">CTF训练营</a></li>-->
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="mobile-content">
        <link rel="stylesheet" type="text/css" href="/css/news.css?v=3.5" />
<link rel="stylesheet" type="text/css" href="/ue/SyntaxHighlighter/shCoreDefault.css?v=1.0" />
<style>
    p .syntaxhighlighter {
        width: 80%;
    }
</style>

<div class="cur-pos w1000">当前位置：<a href="http://bobao.360.cn/">安全客</a> &gt;&gt; 知识详情</div>

<div class="content clearfix">
    <div class="main">
        <div class="article">
            <div id="article_box">
                <h2>【技术分享】由浅入深教你学会源代码审计系列（一）</h2>
                <div class="article-msg">
                    <span class="time">2016-09-12 13:07:40</span>
                    
                                        <span class="read">阅读：20570次</span>
                    <span><a style="display: none;" class="good" href="javascript:;"
                             data-target="/learning/good" data-value="g_3023"
                             data-type="learning">点赞(0)</a></span>
                    <span><a class="fav" href="javascript:;" data-target="/mylearning/add"
                             data-pk="3023" data-type="learning">收藏</a></span>
                                        <span><a style="margin-left: 4px;" class="fav" href=""
                             target="_blank">来源： 安全客</a></span>
                    
                    
                    <div style="margin-top:10px; ">
                        <a href="/member/contribute?uid=2553709124" style="color:#848e99;">
                            <img src="http://p1.qhmsg.com/dm/150_150_100/t011d66e4d0ee6ef2b8.jpg" data-is-avatar="true"
                                 style="border: 1px solid #d5d5d5;padding: 2px; width: 80px;height: 80px;border-radius: 43px;"/>
                        </a>

                    </div>
                    <span class="orig">作者：<a href="/member/contribute?uid=2553709124" style="color:#848e99;">for_while</a></span>
                                    </div>
                <hr size="1">
                <div class="article-msg">
                    <p><!-- JiaThis Button BEGIN -->

<!--
<span class="jiathis_style"><span class="jiathis_txt">分享到：</span>
	<a class="jiathis_button_weixin"></a>
	<a class="jiathis_button_tsina"></a>
    <a class="jiathis_button_tqq"></a>
    <a class="jiathis_button_qzone"></a>
    <a class="jiathis_button_renren"></a>
    <a class="jiathis_button_xiaoyou"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
</span>

-->
</p>
                </div>
                <p><p style="text-indent: 2em; text-align: center;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><img src="http://p7.qhimg.com/t01317bcee10c5bcc6e.png" title="t01109dec011dcbe6b6.png" alt="http://p9.qhimg.com/t01109dec011dcbe6b6.png"/></span></strong></span></p><p style="text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></strong></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><strong><span style="color: rgb(0, 112, 192);">作者：</span></strong></span><a href="http://bobao.360.cn/member/contribute?uid=2553709124" target="_blank" style="color: rgb(0, 112, 192); font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-decoration: none;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; color: rgb(0, 112, 192);">hac425</span></strong><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; color: rgb(0, 112, 192);"></span></strong></span></a></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; color: rgb(0, 112, 192);">稿费：500RMB（不服你也来投稿啊！）</span></strong></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; color: rgb(0, 112, 192);">投稿方式：发送邮件至linwei#360.cn，或登陆网页版在线投稿</span></strong></span></p><p style="text-indent: 2em;"><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">代码审计总论</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">安全圈里有句老话：一切的用户输入都是有害的。的确，我们的所有安全测试都是基于这一点的。既然用户的一切输入都是有害的，那么怎样使这个危害显现出来呢？这就引入了安全的另一句话：有害的数据进入了危险的函数便产生了漏洞 ，因此我们可以总结出安全的两个基本点，数据和函数，我们所做的所有安全相关的工作都是基于这两点。代码审计自然也不例外。 根据这两点，代码审计中又出现了两大审计的基本方法，分别是</span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(255, 0, 0);"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">1. 跟踪用户的输入数据，判断数据进入的每一个代码逻辑是否有可利用的点，此处的代码逻辑可以是一个函数，或者是条小小的条件判断语句。</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(255, 0, 0);"><strong><span style="color: rgb(255, 0, 0); font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">2. 根据不同编程语言的特性，及其历史上经常产生漏洞的一些函数，功能，把这些点找出来，在分析函数调用时的参数，如果参数是用户可控，就很有可能引发安全漏洞</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">这两种方法各有所长，使用第一种方法我们能最大限度的找到程序的安全漏洞，但是跟踪数据的走向是一件工作量极大的事情，如果想跟一套程序死磕，此法 极好，因为在跟踪变量的时候，就是对程序的一个理解的过程，跟的越多，我们走过的 程序流程就越多，对程序的理解就会越深厚，对程序理解的越深，就越有可能挖掘出精彩的漏洞。 第二种方法的优点就是我们能够尽快的找到安全漏洞，但是由于我们没有跟踪完所有的用户参数，我们就必定会有所疏漏，不可能找到程序的所有漏洞，同时回溯参 数，寻找函数的调用点，在一些情况下也是一件非常头疼的事情，不过相比第一种方法我们工作量还是少了不少。总而言之，我们想要快速的找到漏洞，需要灵活的 使用两种方法，怎么灵活，这就要靠经验了，最后提一句，这东西入门后就是体力活了。。。。。</span></p><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">审计辅助工具：</span></strong></p><p style="text-indent: 2em;"><span style="color: rgb(255, 0, 0);"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">sublime 一款十分好用的编辑器 匹配规则 搜索函数 简单的跟踪变量&nbsp;</span></strong></span></p><p style="text-indent: 2em;"><span style="color: rgb(255, 0, 0);"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">各种对应编程语言的 IDE 用于调试程序，追踪变量</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">真正寻找漏洞之前</span></strong></span></p><hr/><p style="text-align: left; text-indent: 2em;"><span style="text-indent: 2em; font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><p style="white-space: normal; text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><p style="white-space: normal; text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp; &nbsp; 现在的<span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 32px;">cms</span><span style="font-family: &#39;Liberation Serif&#39;, &#39;Times New Roman&#39;, serif;"></span>大致可分为两种，单入口模式和多入口模式.所谓多入口模式<span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 32px;">cms</span><span style="font-family: &#39;Liberation Serif&#39;, &#39;Times New Roman&#39;, serif;"></span>在前几年是一种非常常见的程序设计模式，它的形式是我们使用程序的每一个功能都需要访问不同的文件，比如：我要使用注册功能就要访问regest.php文件，使用评论功能就要访问comment.php，这种模式的程序在现在来说，在asp的cms中居多，php中已经很罕见了。</span></p><p style="white-space: normal; text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">单入口模式的cms，是伴随着一种叫做MVC的开发模式出来的，这种模式我在这简单提一下 ，所谓<span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 32px;">MVC</span><span style="font-family: &#39;Liberation Serif&#39;, &#39;Times New Roman&#39;, serif;"></span>编程架构，即将 程序分为三个层次，分别实现三大功能</span></p><p style="text-indent: 2em;"><span style="color: rgb(255, 0, 0);"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">数据以何种形式展示给用户</span></strong></span></p><p style="text-indent: 2em;"><span style="color: rgb(255, 0, 0);"><strong><span style="color: rgb(255, 0, 0); font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">程序的具体实现逻辑</span></strong></span></p><p style="text-indent: 2em;"><span style="color: rgb(255, 0, 0);"><strong><span style="color: rgb(255, 0, 0); font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">数据的处理</span></strong></span></p><p style="white-space: normal; text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">而我们审计的重点应该在</span><code><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">数据的处理层</span></code><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">，因为我们之前我已经说过，</span><code><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">用户的有害输入加上合适的函数就形成了漏洞</span></code><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;，而</span><code><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">数据处理层</span></code><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">恰好就是处理我们输入数据的一个层次。由于这种编程模式拥有很多优点，现在大量的程序采用了这种编程模式，因此如果我们要审计这类程序，也必须要熟悉这种开发模式，至于怎么熟悉，请自行百度。</span></p><p style="white-space: normal; text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">单入口模式程序的特点是，我们要使用程序的每一个功能只需要访问一个，或者两个文件 普通用户一个入口文件 、管理员一个入口文件<span style="font-family: &#39;Liberation Serif&#39;, &#39;Times New Roman&#39;, serif;">&nbsp;,</span>要调用其他的文件中的具体的功能实现代码，我们只需向该入口文件提供特定的参数即可。这种 cms&nbsp;的案例有很多，比如&nbsp;wordpress,phpcms......</span><br/></p><p style="white-space: normal; text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">在审计代码时，审计</span><code><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">多入口</span></code><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">模式的程序会相对的比较简单，因为我们在找到漏洞后可以很快的找到进入漏洞的代码的方法，而</span><code><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">单入口</span></code><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">模式的程序，在正式审计之前，我们还需要理解程序各个文件之间的调用规则，当然这也是一件比较简单的事情，一般情况下，我们从入口文件跟一次程序的执行流程，就能基本理清程序的流程，其实在有了一定的经验之后，我们就能从参数的值猜出程序的执行流程。在理清程序的各个文件之间的调用关系之后，我们需要做的是，查看程序的一些配置文件，全局函数文件，这些文件里面很可能包含一定的过滤函数，能早一点发现 程序对参数的处理过程，我们就能及时地确定一些无法利用的漏洞点，这可以有助于减少我们的工作量。搞完这些工作之后，就开始进入具体漏洞搜寻工作。就像前 面说的那样，我们在进行漏洞搜寻时，我们有两种方式:</span></p><p style="white-space: normal; text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><p style="text-indent: 2em;"><span style="color: rgb(255, 0, 0);"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">第一种，我们通过搜索一些获取用户输入数据的函数，来找到用户输入数据的源头，之后我们从这里为起 点，跟踪数据的流向，分析在这整个过程中数据的处理情况，进而定位可能触发漏洞的点。</span></strong></span></p><p style="text-indent: 2em;"><span style="color: rgb(255, 0, 0);"><strong><span style="color: rgb(255, 0, 0); font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">第二种，我们通过搜索一些经常产生安全问题的函数，比如执行数 据库查询的函数，执行系统命令的函数，文件操作类函数等等，在通过回溯这些函数在被调用时参数，判断参数是否我们可控，进而定位漏洞点。</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">最后贴上我常用的正则：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:php;toolbar:false">PHP
\$_SERVER|\$_COOKIE|\$_REQUEST|\$_GET|\$_POST&nbsp;&nbsp;&nbsp;&nbsp;获取用户输入
eval\(|assert\(|system\(&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;命令执行
require\(|require_once\(|include\(|include_once\(&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;文件包含
file_get_contents\(|file\(|fopen\(|highlight_file\(|show_source\(|unlink&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;文件读取，写入，删除
simplexml_load_string&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;XXE
unserialize&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;反序列化漏洞</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">ASP 的话，因为程序的流程相对比较简单，代码量也比较少，所以我一般选择直接跟变量，我就搜索 Request 关键字就能找到所有的数据输入点</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">.NET &nbsp;搞的很少 ，而且这一类程序往往需要反编译才能继续审计，因此对于这种程序，我没有什么好方法，我是一个一个函数去看的，如果各位有一些好的方法，敬请告知，谢谢。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">jsp 没搞过。。。。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">一、代码审计之SQL注入篇</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;"></span></p><p style="white-space: normal; text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">在我们的日常日站中，相信SQL&nbsp;注入漏洞是我们遇到最多，也可能是最希望遇到的一种漏洞了，这种漏洞出现了很久，危害也是十分巨大，具体危害就不多说了，相信大家都懂。。。我们大多数时候发现<span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 32px;">SQL</span>注入漏洞是通过扫描器等黑盒测试手法来发现的，今天我来谈谈<span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 32px;">SQL</span>注入漏洞的白盒审计手法。</span></p><p style="white-space: normal; text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">首先我们从一个相对比较简单的&nbsp;<span style="font-family: &#39;Liberation Serif&#39;, &#39;Times New Roman&#39;, serif;"><code>asp</code>&nbsp;</span>程序开始讲，这次讲的是shop7z这套cms</span><span style="font-family:Liberation Serif, Times New Roman, serif">，</span><span style="font-family:微软雅黑, Microsoft YaHei">该</span><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 32px;">cms</span><span style="font-family: &#39;Liberation Serif&#39;, &#39;Times New Roman&#39;, serif;">&nbsp;</span><span style="font-family:微软雅黑, Microsoft YaHei">是一个&nbsp;</span><code><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">多入口</span></code><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;的程序，也就是说它的每一个大的功能基本对应一个URL，我个人认为这样的程序是比较简单的，因为当我们找了可能触发的漏洞点后，就可以很快的进行验证，不需要太多的前期准备工作。既然是asp程序，我的一般做法是 直接搜索 request来找到我们用户所有可控的输入点。当然在此之前，我们还需要看看各个文件的开头，确定一些被多次的包含的文件，这些文件一般就是一些全局配置文件，全局函数文件，安全过滤文件。</span></p><p style="white-space: normal; text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">总而言之就是一些相对来说比较重要的文件。通过查看<span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 32px;">shop7z</span><span style="font-family: &#39;Liberation Serif&#39;, &#39;Times New Roman&#39;, serif;"></span>这套程序的一些从名称上看比较重要的文件，我发现了一个比较有趣的文件：<span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 32px;">shop7z_safe.asp</span>从文件名我们就能够猜出来，这个文件就是拿来，对用户参数进行过滤的，那我们进入文件中看看：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:php;toolbar:false;">&lt;%
Dim&nbsp;Fy_Post,Fy_Get,Fy_In,Fy_Inf,Fy_Xh,Fy_db,Fy_dbstr
&#39;自定义需要过滤的字串,用&nbsp;&quot;曹&quot;&nbsp;分隔&nbsp;&#39;&nbsp;防止SQL注入以及XSS跨站攻击&nbsp;/2016/1/3
Fy_In&nbsp;=&nbsp;&quot;&#39;曹;曹and曹exec曹insert曹select曹delete曹count曹*曹%曹chr曹mid曹master曹truncate曹char曹declare曹&lt;曹&gt;曹script&quot;
&#39;----------------------------------
%&gt;
&lt;%
Fy_Inf&nbsp;=&nbsp;split(Fy_In,&quot;曹&quot;)
&#39;--------POST部份------------------
If&nbsp;Request.Form&lt;&gt;&quot;&quot;&nbsp;Then
For&nbsp;Each&nbsp;Fy_Post&nbsp;In&nbsp;Request.Form
For&nbsp;Fy_Xh=0&nbsp;To&nbsp;Ubound(Fy_Inf)
If&nbsp;Instr(LCase(Request.FormFy_Post)),Fy_Inf(Fy_Xh))&lt;&gt;0&nbsp;Then
(
Response.Write&nbsp;&quot;xxx&lt;Script&nbsp;Language=JavaScript&gt;(&#39;请不要对本站尝试进行非法操作谢谢合作^_^&nbsp;&#39;);history.go(-1);&lt;/Script&gt;&quot;
Response.End
End&nbsp;If
Next
Next
End&nbsp;If
&#39;----------------------------------
&#39;--------GET部份-------------------
If&nbsp;Request.QueryString&lt;&gt;&quot;&quot;&nbsp;Then
For&nbsp;Each&nbsp;Fy_Get&nbsp;In&nbsp;Request.QueryString
For&nbsp;Fy_Xh=0&nbsp;To&nbsp;Ubound(Fy_Inf)
If&nbsp;Instr(LCase(Request.QueryString(Fy_Get)),Fy_Inf(Fy_Xh))&lt;&gt;0&nbsp;Then
Response.Write&nbsp;&quot;xxx&lt;Script&nbsp;Language=JavaScript&gt;(&#39;请不要对本站尝试进行注入操作谢谢合作^_^&nbsp;&#39;);history.go(-1);&lt;/Script&gt;&quot;
Response.End
End&nbsp;If
Next
Next
End&nbsp;If
%&gt;</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">可以看到，的确如我所料，这个文件就是拿来对我们的参数进行过滤的，不过这个过滤策略是很有问题的，首先这个过滤文件只是针对 SQL 注入攻击进行了过滤，而对其他漏洞，如 xss ，还有一个更大的问题，就是它只对 GET ,POST 参数进行了过滤，而忽视从 cookie 中过来的参数，这就很有可能会造成 cookie 注入。理解了程序对用户参数的过滤操作，你是否感到目标更加的明确，通过上面的分析我们可以制定这样的审计策略。</span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">通过使用 sublime 的文件搜索功能，搜索 &nbsp;request 来获取用户的输入点，因为在 asp 程序中获取用户输入，使用的几个函数及其作用分别为：&nbsp;</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">request.QueryString（获取GET请求的参数)&nbsp;</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">request.form() (获取POST请求的参数)&nbsp;</span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">request.cookie() (获取通过cookie传来的参数 &nbsp;request ) &nbsp;</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">所以我们要找 SQL 注入漏洞的话，我们应该关注的输入点函数就是 能从 cookie中获取参数的函数，有了思路，就可以开始行动了，我们开始搜索，之后一个一个的跟进每一个搜索结果，我们就能发现 N 处注入了下面我选择一处来说明下吧：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">漏洞文件： news.asp：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">searchkey=request(&quot;searchkey&quot;)
searchkind=request(&quot;searchkind&quot;)
if&nbsp;searchkey&lt;&gt;&quot;&quot;&nbsp;then
&nbsp;&nbsp;&nbsp;&nbsp;sql3=&quot;select&nbsp;*&nbsp;from&nbsp;e_contect&nbsp;where&nbsp;c_parent2=&quot;&amp;request.QueryString(&quot;l_id&quot;)&amp;&quot;&nbsp;and&nbsp;(c_title&nbsp;like&nbsp;&#39;%&quot;&amp;searchkey&amp;&quot;%&#39;&nbsp;or&nbsp;c_contect&nbsp;like&nbsp;&#39;%&quot;&amp;searchkey&amp;&quot;%&#39;)&nbsp;order&nbsp;by&nbsp;c_num&nbsp;desc,c_addtime&nbsp;desc&quot;
else
&nbsp;&nbsp;&nbsp;&nbsp;sql3=&quot;select&nbsp;*&nbsp;from&nbsp;e_contect&nbsp;where&nbsp;c_parent2=&quot;&amp;request.QueryString(&quot;l_id&quot;)&amp;&quot;&nbsp;order&nbsp;by&nbsp;c_num&nbsp;desc,c_addtime&nbsp;desc&quot;
end&nbsp;if
set&nbsp;rs3=server.CreateObject(&quot;adodb.recordset&quot;)
rs3.open&nbsp;sql3,conn,1,1</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">虽然该文件也包含了，全局过滤文件，但是这里用了 request() 函数来获取参数，那么我们就能通过 cookie 来传输参数值，而 cookie 中的值是没有经过过滤的，所以出现了注入，当我提交：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">GET&nbsp;/news.asp?l_id=1&nbsp;HTTP/1.1
Host:&nbsp;127.0.0.1:99
Cache-Control:&nbsp;max-age=0
Accept:&nbsp;text/html,application/xhtml+xml,application/xml;q=0.9,image/webp,*/*;q=0.8
User-Agent:&nbsp;Mozilla/5.0&nbsp;(Windows&nbsp;NT&nbsp;6.1;&nbsp;WOW64)&nbsp;AppleWebKit/537.36&nbsp;(KHTML,&nbsp;like&nbsp;Gecko)&nbsp;Chrome/38.0.2125.122&nbsp;Safari/537.36&nbsp;SE&nbsp;2.X&nbsp;MetaSr&nbsp;1.0
Accept-Encoding:&nbsp;gzip,deflate,sdch
Accept-Language:&nbsp;zh-CN,zh;q=0.8
Cookie:&nbsp;_ga=GA1.1.1929133354.1465629589;&nbsp;COSPTLCBWXNQVBUKXIOJ=KSBKFPQVGIRJWBOELVYRTMRCNPDSIWYDIWYHQYNQ;&nbsp;searchkey=sss&#39;and#</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">执行的语句是：</span></p><pre class="brush:bash;toolbar:false">select&nbsp;*&nbsp;from&nbsp;e_contect&nbsp;where&nbsp;c_parent2=1&nbsp;and&nbsp;(c_title&nbsp;like&nbsp;&#39;%sss&#39;and#%&#39;&nbsp;or&nbsp;c_contect&nbsp;like&nbsp;&#39;%sss&#39;and#%&#39;)&nbsp;order&nbsp;by&nbsp;c_num&nbsp;desc,c_addtime&nbsp;desc</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">成功带入了查询，，，</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">下面我们来看一套 单入口 模式的 php 程序，这套 cms 的名称为 乐尚商城cms,这是一套典型的采用 MVC 编程模型编写的程序，而且它还将 URL 路由进行了重写，也就是说他的 URL 如果按照国际标准去解析他，是没有什么实际意义的，所以遇到这种程序，我们还需要理清它 URL 路由规则，找到参数名，与参数值的位置关系。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">我们先来看看他的 URL 到底是怎样的：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">前台：</span></p><p style="text-align: center; text-indent: 0em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><img src="http://p2.qhimg.com/t0165734594301f2584.png"/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">后台：</span></p><p style="text-align: center; text-indent: 0em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><img src="http://p7.qhimg.com/t0128dfd2da24c7fa17.png"/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">下面我们来看看他的目录结构，</span></p><p style="text-align: center; text-indent: 0em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><img src="http://p8.qhimg.com/t01d1ea4123591186c8.png"/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">单入口的程序一般都采用类似这样的目录结构来编写，接着查看 index.php 文件，分析一下程序的执行流程，既然是单入口程序，那么程序的各个文件之间的调用关系必定都会在再 index.php 文件内实现。我们要理清程序的执行流程，这一步是必不可少的。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:php;toolbar:false">&lt;?php
&nbsp;&nbsp;&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;单一入口文件
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;&nbsp;&nbsp;include(&quot;./temp.inc.php&quot;);
&nbsp;&nbsp;&nbsp;&nbsp;define(&quot;TPLSTYLE&quot;,&nbsp;$temp[&#39;template&#39;]);//默认模板存放的目录
&nbsp;&nbsp;&nbsp;&nbsp;define(&quot;BROPHP&quot;,&nbsp;&quot;./brophp&quot;);&nbsp;&nbsp;//框架源文件的位置
&nbsp;&nbsp;&nbsp;&nbsp;define(&quot;APP&quot;,&nbsp;&quot;./home&quot;);&nbsp;&nbsp;&nbsp;//设置当前应用的目录
&nbsp;&nbsp;&nbsp;&nbsp;define(&quot;PAGENUM&quot;,$temp[&#39;home_page_num&#39;]);&nbsp;//默认每页显示记录数
&nbsp;&nbsp;&nbsp;&nbsp;if(!file_exists(&quot;install/install_lock.txt&quot;)){
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;header(&quot;Location:install/index.php&quot;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit();
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;if(is_mobile_request()){
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;header(&quot;Location:mobile.php&quot;);
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;require(BROPHP.&#39;/brophp.php&#39;);&nbsp;//加载框架的入口文件
&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;is_mobile_request()&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;{&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.......................
&nbsp;&nbsp;&nbsp;&nbsp;}
?&gt;</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">该文件开始包含了一个 temp.inc.php ，经分析，该文件内就是定义了一些变量，对我们而言并没有什么用，接下来又定义了一些常量，之后 require(BROPHP.&#39;/brophp.php&#39;) 包含了一个文件，看注释可知这个文件应该就是一个比较关键的文件了，而且， index.php 文件后面已经没有什么内容了，所以调度整个程序的重担应该就在 brophp.php 文件内了，该文件内的一些关键代码：</span></p><pre class="brush:plain;toolbar:false">/包含框架中的函数库文件
&nbsp;&nbsp;&nbsp;&nbsp;include&nbsp;BROPHP_PATH.&#39;commons/functions.inc.php&#39;;
&nbsp;&nbsp;&nbsp;&nbsp;//包含全局的函数库文件，用户可以自己定义函数在这个文件中
&nbsp;&nbsp;&nbsp;&nbsp;$funfile=PROJECT_PATH.&quot;commons/functions.inc.php&quot;;
&nbsp;&nbsp;&nbsp;&nbsp;if(file_exists($funfile))
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;include&nbsp;$funfile;
&nbsp;&nbsp;&nbsp;&nbsp;//设置包含目录（类所在的全部目录）,&nbsp;&nbsp;PATH_SEPARATOR&nbsp;分隔符号&nbsp;Linux(:)&nbsp;Windows(;)
&nbsp;&nbsp;&nbsp;&nbsp;$include_path=get_include_path();&nbsp;//原基目录
&nbsp;&nbsp;&nbsp;&nbsp;$include_path.=PATH_SEPARATOR.BROPHP_PATH.&quot;bases/&quot;;&nbsp;&nbsp;&nbsp;//框架中基类所在的目录
&nbsp;&nbsp;&nbsp;&nbsp;$include_path.=PATH_SEPARATOR.BROPHP_PATH.&quot;classes/&quot;&nbsp;;//框架中扩展类的目录
&nbsp;&nbsp;&nbsp;&nbsp;$include_path.=PATH_SEPARATOR.BROPHP_PATH.&quot;libs/&quot;&nbsp;;&nbsp;&nbsp;&nbsp;//模板Smarty所在的目录
&nbsp;&nbsp;&nbsp;&nbsp;$include_path.=PATH_SEPARATOR.PROJECT_PATH.&quot;classes/&quot;;//项目中用的到的工具类
&nbsp;&nbsp;&nbsp;&nbsp;$controlerpath=PROJECT_PATH.&quot;runtime/controls/&quot;.TMPPATH;&nbsp;&nbsp;//生成控制器所在的路径
&nbsp;&nbsp;&nbsp;&nbsp;$include_path.=PATH_SEPARATOR.$controlerpath;&nbsp;//当前应用的控制类所在的目录&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;//设置include包含文件所在的所有目录&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;set_include_path($include_path);
&nbsp;&nbsp;&nbsp;&nbsp;//自动加载类&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;function&nbsp;__autoload($className){
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($className==&quot;memcache&quot;){//如果是系统的Memcache类则不包含
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}else&nbsp;if($className==&quot;Smarty&quot;){//如果类名是Smarty类，则直接包含
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;include&nbsp;&quot;Smarty.class.php&quot;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}else{&nbsp;//如果是其他类，将类名转为小写
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;include&nbsp;strtolower($className).&quot;.class.php&quot;;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Debug::addmsg(&quot;&lt;b&gt;&nbsp;$className&nbsp;&lt;/b&gt;类&quot;,&nbsp;1);&nbsp;&nbsp;//在debug中显示自动包含的类
&nbsp;&nbsp;&nbsp;&nbsp;}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">这里首先包含了 functions.inc.php 文件，该文件内部是一些全局函数，之后设置了许多的目录， 使用set_include_path($include_path) ，将这些目录下的文件全部包含进来，逐个点进去看看，发现了定义路由的文件是 brophp/bases/prourl.class.php 看看文件内容：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">&lt;?php
&nbsp;&nbsp;&nbsp;&nbsp;class&nbsp;Prourl&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*&nbsp;URL路由,转为PATHINFO的格式
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;static&nbsp;function&nbsp;parseUrl(){
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isset($_SERVER[&#39;PATH_INFO&#39;])){
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//获取&nbsp;pathinfo
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$pathinfo&nbsp;=&nbsp;explode(&#39;/&#39;,&nbsp;trim($_SERVER[&#39;PATH_INFO&#39;],&nbsp;&quot;/&quot;));
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;获取&nbsp;control
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_GET[&#39;m&#39;]&nbsp;=&nbsp;(!empty($pathinfo[0])&nbsp;?&nbsp;$pathinfo[0]&nbsp;:&nbsp;&#39;index&#39;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;array_shift($pathinfo);&nbsp;//将数组开头的单元移出数组&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;获取&nbsp;action
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_GET[&#39;a&#39;]&nbsp;=&nbsp;(!empty($pathinfo[0])&nbsp;?&nbsp;$pathinfo[0]&nbsp;:&nbsp;&#39;index&#39;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;array_shift($pathinfo);&nbsp;//再将将数组开头的单元移出数组&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for($i=0;&nbsp;$i&lt;count($pathinfo);&nbsp;$i+=2){
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_GET[$pathinfo[$i]]=$pathinfo[$i+1];
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}else{&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_GET[&quot;m&quot;]=&nbsp;(!empty($_GET[&#39;m&#39;])&nbsp;?&nbsp;$_GET[&#39;m&#39;]:&nbsp;&#39;index&#39;);//默认是index模块
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_GET[&quot;a&quot;]=&nbsp;(!empty($_GET[&#39;a&#39;])&nbsp;?&nbsp;$_GET[&#39;a&#39;]&nbsp;:&nbsp;&#39;index&#39;);&nbsp;&nbsp;&nbsp;//默认是index动作
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($_SERVER[&quot;QUERY_STRING&quot;]){
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$m=$_GET[&quot;m&quot;];
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unset($_GET[&quot;m&quot;]);&nbsp;&nbsp;//去除数组中的m
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$a=$_GET[&quot;a&quot;];
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unset($_GET[&quot;a&quot;]);&nbsp;&nbsp;//去除数组中的a
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$query=http_build_query($_GET);&nbsp;&nbsp;&nbsp;//形成0=foo&amp;1=bar&amp;2=baz&amp;3=boom&amp;cow=milk格式
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//组成新的URL
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$url=$_SERVER[&quot;SCRIPT_NAME&quot;].&quot;/{$m}/{$a}/&quot;.str_replace(array(&quot;&amp;&quot;,&quot;=&quot;),&nbsp;&quot;/&quot;,&nbsp;$query);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;header(&quot;Location:&quot;.$url);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">这段代码将我们的 URL 进行了处理，当我们请求这样的 URL时</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">http://localhost/leshang/index.php/product/index/id/32/pid/0/m_id/31</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">经过这样一段代码的处理后的效果是，</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">$_GET[&#39;m&#39;]=&nbsp;product&nbsp;&nbsp;&nbsp;
$_GET[&#39;a&#39;]&nbsp;=&nbsp;index&nbsp;&nbsp;&nbsp;&nbsp;
$_GET[&#39;id&#39;]&nbsp;=&nbsp;32&nbsp;&nbsp;&nbsp;
$_GET[&#39;pid&#39;]&nbsp;=&nbsp;0
$_GET[&#39;m_id&#39;]&nbsp;=&nbsp;3</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">通过分析，我们直接按照标准的形式提交参数上去也是可以的，下面的 URL 和上面的 URL是一样的</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">http://localhost/leshang/index.php?m=product&amp;a=index&amp;id=32&amp;pid=0&amp;m_id=31</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">所以遇到 URL 重写也无需慌张，仔细分析程序即可。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">之后继续分析 brophp.php 文件，我们还可以发现，程序没有对我们的参数进行过滤，接下了就上正则搜索了</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">\$_SERVER|\$_COOKIE|\$_REQUEST|\$_GET|\$_POST</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><img alt="http://p7.qhimg.com/t01695c5749ce2ebc3f.png" src="http://p0.qhimg.com/t018ce8a5d48e890837.png" title="t01695c5749ce2ebc3f.png"/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">逐个分析，就能找到漏洞点，我把我的分析就给贴一下吧,</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">其中一个漏洞文件： admin/controls/acate.class.php</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">漏洞代码：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">function&nbsp;del(){
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$acate=D(&quot;acate&quot;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($_POST[&#39;dels&#39;]){
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($acate-&gt;delete($_POST[&#39;id&#39;])){
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;clear_cache();
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;success(&quot;删除成功!&quot;,&nbsp;1,&nbsp;&quot;acate/index&quot;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;error(&quot;删除失败!&quot;,&nbsp;1,&nbsp;&quot;acate/index&quot;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($acate-&gt;delete($_GET[&#39;id&#39;])){
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;clear_cache();
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;success(&quot;删除成功!&quot;,&nbsp;1,&nbsp;&quot;acate/index&quot;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;error(&quot;删除失败!&quot;,&nbsp;1,&nbsp;&quot;acate/index&quot;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">这里直接将 $_POST[&#39;id&#39;] 传入了 delete 函数，我们来看看该函数的具体实现，</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">function&nbsp;delete(){
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$where=&quot;&quot;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$data=array();
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$args=func_get_args();&nbsp;//获取参数
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(count($args)&gt;0){
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$where&nbsp;=&nbsp;$this-&gt;comWhere($args);&nbsp;//传参&nbsp;构造&nbsp;where&nbsp;语句
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$data=$where[&quot;data&quot;];
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$where=&nbsp;$where[&quot;where&quot;];
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}else&nbsp;if($this-&gt;sql[&quot;where&quot;]&nbsp;!=&nbsp;&quot;&quot;){
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$where=$this-&gt;comWhere($this-&gt;sql[&quot;where&quot;]);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$data=$where[&quot;data&quot;];
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$where=$where[&quot;where&quot;];
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$order&nbsp;=&nbsp;$this-&gt;sql[&quot;order&quot;]&nbsp;!=&nbsp;&quot;&quot;&nbsp;?&nbsp;&nbsp;&quot;&nbsp;ORDER&nbsp;BY&nbsp;{$this-&gt;sql[&quot;order&quot;][0]}&quot;&nbsp;:&nbsp;&quot;&quot;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$limit&nbsp;=&nbsp;$this-&gt;sql[&quot;limit&quot;]&nbsp;!=&nbsp;&quot;&quot;&nbsp;?&nbsp;$this-&gt;comLimit($this-&gt;sql[&quot;limit&quot;])&nbsp;:&nbsp;&quot;&quot;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($where==&quot;&quot;&nbsp;&amp;&amp;&nbsp;$limit==&quot;&quot;){
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$where=&quot;&nbsp;where&nbsp;{$this-&gt;fieldList[&quot;pri&quot;]}=&#39;&#39;&quot;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql=&quot;DELETE&nbsp;FROM&nbsp;{$this-&gt;tabName}{$where}{$order}{$limit}&quot;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$this-&gt;query($sql,&nbsp;__METHOD__,$data);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">在进入 comWhere 函数，漏洞关键代码如下：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">private&nbsp;function&nbsp;comWhere($args){
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$where=&quot;&nbsp;WHERE&nbsp;&quot;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$data=array();
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(empty($args))
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;array(&quot;where&quot;=&gt;&quot;&quot;,&nbsp;&quot;data&quot;=&gt;$data);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach($args&nbsp;as&nbsp;$option)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(empty($option)){
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$where&nbsp;=&nbsp;&#39;&#39;;&nbsp;//条件为空，返回空字符串；如&#39;&#39;,0,false&nbsp;返回：&nbsp;&#39;&#39;&nbsp;//5
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;if(is_string($option))
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(is_numeric($option[0]))&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$option&nbsp;=&nbsp;explode(&#39;,&#39;,&nbsp;$option);&nbsp;//3
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$where&nbsp;.=&nbsp;&quot;{$this-&gt;fieldList[&quot;pri&quot;]}&nbsp;IN(&quot;&nbsp;.&nbsp;implode(&#39;,&#39;,&nbsp;array_fill(0,&nbsp;count($option),&nbsp;&#39;?&#39;))&nbsp;.&nbsp;&quot;)&quot;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$data=$option;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">当 `$args` 的一个元素的值 为字符串时，就会直接并入 where 子句</span><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp;</span></p><pre class="brush:plain;toolbar:false">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$where&nbsp;.=&nbsp;$option;&nbsp;//2
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;continue;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.........................
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;..............................
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$where=rtrim($where,&nbsp;&quot;OR&nbsp;&quot;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;array(&quot;where&quot;=&gt;$where,&nbsp;&quot;data&quot;=&gt;$data);</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">当 $args 的一个元素的值 为字符串时，就会直接并入 where 子句，之后返回。 这样，数据的来源没有过滤，处理过程也没过滤，造成了注入。 同时这里依旧存在 CSRF 漏洞。下面我的测试 POC</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">&lt;form&nbsp;action=http://localhost/lesh/admin.php/acate/del&nbsp;method=POST&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;input&nbsp;type=&quot;text&quot;&nbsp;name=&quot;id&quot;&nbsp;value=&quot;jinyu&#39;&quot;&nbsp;/&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&lt;input&nbsp;type=&quot;text&quot;&nbsp;name=&quot;dels&quot;&nbsp;value=&quot;1&quot;&nbsp;/&gt;
&lt;/form&gt;
&lt;script&gt;&nbsp;document.forms[0].submit();&nbsp;&lt;/script&gt;</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">访问后，执行的 SQL 语句为：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">DELETE FROM ls_acate WHERE jinyu&#39;</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">该漏洞发生在 del 函数中，而且有很多文件都是直接复制了该函数，所以使用了该函数的都。。。。。。 下面我搜到的一部分</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:php;toolbar:false">admin/controls/acate.class.php
admin/controls/admin.class.php
admin/controls/admingroup.class.php
admin/controls/appraise.class.php
admin/controls/brand.class.php
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;comment.class.php
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;consult.class.php
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;express.class.php
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;........</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">上面的注入需要管理员权限，下面就不需要任何权限了。。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">漏洞文件 ： home/controls/user.class.php</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">关键代码：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">function&nbsp;del_consult(){
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$consult=D(&quot;Consult&quot;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($_GET[&#39;id&#39;]){
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($consult-&gt;delete($_GET[&#39;id&#39;])){
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;success(&quot;删除成功!&quot;,&nbsp;1);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;error(&quot;删除失败!&quot;,&nbsp;1);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">这里和上面的也差不多， delete($_GET[&#39;id&#39;]) 将 id 参数带入了漏洞函数，造成注入。。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">提交 http://localhost/lesh/index.php/user/del_consult?id=jinyu&#39;</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">执行的语句：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">DELETE FROM ls_consult WHERE jinyu&#39;</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">同样的复制了该函数的都有漏洞。。。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">为了文章知识的完整性,下面来看一个 二次注入 的例子，来源 <a href="http://www.wooyun.org/bugs/wooyun-2010-0141461" _src="http://www.wooyun.org/bugs/wooyun-2010-0141461">http://www.wooyun.org/bugs/wooyun-2010-0141461</a></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">PHPSHE 二次注入一枚</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:php;toolbar:false">case&nbsp;&#39;register&#39;:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isset($_p_pesubmit))&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($db-&gt;pe_num(&#39;user&#39;,&nbsp;array(&#39;user_name&#39;=&gt;pe_dbhold($_g_user_name))))&nbsp;pe_error(&#39;用户名已存在...&#39;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if($db-&gt;pe_num(&#39;user&#39;,&nbsp;array(&#39;user_email&#39;=&gt;pe_dbhold($_g_user_email))))&nbsp;pe_error(&#39;邮箱已存在...&#39;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(strtolower($_s_authcode)&nbsp;!=&nbsp;strtolower($_p_authcode))&nbsp;pe_error(&#39;验证码错误&#39;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql_set[&#39;user_name&#39;]&nbsp;=&nbsp;$_p_user_name;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql_set[&#39;user_pw&#39;]&nbsp;=&nbsp;md5($_p_user_pw);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql_set[&#39;user_email&#39;]&nbsp;=&nbsp;$_p_user_email;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql_set[&#39;user_ip&#39;]&nbsp;=&nbsp;pe_ip();
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql_set[&#39;user_atime&#39;]&nbsp;=&nbsp;$sql_set[&#39;user_ltime&#39;]&nbsp;=&nbsp;time();
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($user_id&nbsp;=&nbsp;$db-&gt;pe_insert(&#39;user&#39;,&nbsp;pe_dbhold($sql_set)))&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add_pointlog($user_id,&nbsp;&#39;reg&#39;,&nbsp;$cache_setting[&#39;point_reg&#39;],&nbsp;&#39;注册帐号&#39;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$info&nbsp;=&nbsp;$db-&gt;pe_select(&#39;user&#39;,&nbsp;array(&#39;user_id&#39;=&gt;$user_id));
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_SESSION[&#39;user_idtoken&#39;]&nbsp;=&nbsp;md5($info[&#39;user_id&#39;].$pe[&#39;host_root&#39;]);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_SESSION[&#39;user_id&#39;]&nbsp;=&nbsp;$info[&#39;user_id&#39;];
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_SESSION[&#39;user_name&#39;]&nbsp;=&nbsp;$info[&#39;user_name&#39;];
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_SESSION[&#39;pe_token&#39;]&nbsp;=&nbsp;pe_token_set($_SESSION[&#39;user_idtoken&#39;]);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//未登录时的购物车列表入库
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(is_array($cart_list&nbsp;=&nbsp;unserialize($_c_cart_list)))&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach&nbsp;($cart_list&nbsp;as&nbsp;$k&nbsp;=&gt;&nbsp;$v)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$cart_info[&#39;cart_atime&#39;]&nbsp;=&nbsp;time();
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$cart_info[&#39;product_id&#39;]&nbsp;=&nbsp;$k;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$cart_info[&#39;product_num&#39;]&nbsp;=&nbsp;$v[&#39;product_num&#39;];
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$cart_info[&#39;user_id&#39;]&nbsp;=&nbsp;$info[&#39;user_id&#39;];
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$db-&gt;pe_insert(&#39;cart&#39;,&nbsp;pe_dbhold($cart_info));</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">用户注册时 ，进行了转义，</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">然后登入时将完整的值带入了session</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:php;toolbar:false">case&nbsp;&#39;login&#39;:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isset($_p_pesubmit))&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql_set[&#39;user_name&#39;]&nbsp;=&nbsp;$_p_user_name;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql_set[&#39;user_pw&#39;]&nbsp;=&nbsp;md5($_p_user_pw);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(strtolower($_s_authcode)&nbsp;!=&nbsp;strtolower($_p_authcode))&nbsp;pe_error(&#39;验证码错误&#39;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($info&nbsp;=&nbsp;$db-&gt;pe_select(&#39;user&#39;,&nbsp;pe_dbhold($sql_set)))&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$db-&gt;pe_update(&#39;user&#39;,&nbsp;array(&#39;user_id&#39;=&gt;$info[&#39;user_id&#39;]),&nbsp;array(&#39;user_ltime&#39;=&gt;time()));
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!$db-&gt;pe_num(&#39;pointlog&#39;,&nbsp;&quot;&nbsp;and&nbsp;`user_id`&nbsp;=&nbsp;&#39;{$info[&#39;user_id&#39;]}&#39;&nbsp;and&nbsp;`pointlog_type`&nbsp;=&nbsp;&#39;reg&#39;&nbsp;and&nbsp;`pointlog_text`&nbsp;=&nbsp;&#39;登录帐号&#39;&nbsp;and&nbsp;`pointlog_atime`&nbsp;&gt;=&nbsp;&#39;&quot;.strtotime(date(&#39;Y-m-d&#39;)).&quot;&#39;&quot;))&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add_pointlog($info[&#39;user_id&#39;],&nbsp;&#39;reg&#39;,&nbsp;$cache_setting[&#39;point_login&#39;],&nbsp;&#39;登录帐号&#39;);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_SESSION[&#39;user_idtoken&#39;]&nbsp;=&nbsp;md5($info[&#39;user_id&#39;].$pe[&#39;host_root&#39;]);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_SESSION[&#39;user_id&#39;]&nbsp;=&nbsp;$info[&#39;user_id&#39;];
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$_SESSION[&#39;user_name&#39;]&nbsp;=&nbsp;$info[&#39;user_name&#39;];
z&nbsp;&nbsp;module/index/order.php&nbsp;出库
case&nbsp;&#39;comment&#39;:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$order_id&nbsp;=&nbsp;pe_dbhold($_g_id);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$info&nbsp;=&nbsp;$db-&gt;pe_select(&#39;order&#39;,&nbsp;array(&#39;order_id&#39;=&gt;$order_id,&nbsp;&#39;user_id&#39;=&gt;$_s_user_id));
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!$info[&#39;order_id&#39;])&nbsp;pe_error(&#39;参数错误...&#39;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$info_list&nbsp;=&nbsp;$db-&gt;pe_selectall(&#39;orderdata&#39;,&nbsp;array(&#39;order_id&#39;=&gt;$order_id));
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isset($_p_pesubmit))&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pe_token_match();
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($info[&#39;order_comment&#39;])&nbsp;pe_error(&#39;请勿重复评价...&#39;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach&nbsp;($info_list&nbsp;as&nbsp;$k=&gt;$v)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql_set[$k][&#39;comment_star&#39;]&nbsp;=&nbsp;intval($_p_comment_star[$v[&#39;product_id&#39;]]);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql_set[$k][&#39;comment_text&#39;]&nbsp;=&nbsp;pe_dbhold($_p_comment_text[$v[&#39;product_id&#39;]]);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql_set[$k][&#39;comment_atime&#39;]=&nbsp;time();
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql_set[$k][&#39;product_id&#39;]&nbsp;=&nbsp;$v[&#39;product_id&#39;];
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql_set[$k][&#39;order_id&#39;]&nbsp;=&nbsp;$order_id;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql_set[$k][&#39;user_ip&#39;]&nbsp;=&nbsp;pe_dbhold(pe_ip());
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql_set[$k][&#39;user_id&#39;]&nbsp;=&nbsp;$_s_user_id;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql_set[$k][&#39;user_name&#39;]&nbsp;=&nbsp;$_s_user_name;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!$sql_set[$k][&#39;comment_text&#39;])&nbsp;pe_error(&#39;评价内容必须填写...&#39;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($db-&gt;pe_insert(&#39;comment&#39;,&nbsp;$sql_set))&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;order_callback(&#39;comment&#39;,&nbsp;$order_id);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pe_success(&#39;评价成功!&#39;);</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">zmodule/index/order.php&nbsp;出库</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;"></span></p><p>&nbsp;</p><pre class="brush:plain;toolbar:false">&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;case&nbsp;&#39;comment&#39;:
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$order_id&nbsp;=&nbsp;pe_dbhold($_g_id);
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$info&nbsp;=&nbsp;$db-&gt;pe_select(&#39;order&#39;,&nbsp;array(&#39;order_id&#39;=&gt;$order_id,&nbsp;&#39;user_id&#39;=&gt;$_s_user_id));
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!$info[&#39;order_id&#39;])&nbsp;pe_error(&#39;参数错误...&#39;);
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$info_list&nbsp;=&nbsp;$db-&gt;pe_selectall(&#39;orderdata&#39;,&nbsp;array(&#39;order_id&#39;=&gt;$order_id));
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(isset($_p_pesubmit))&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pe_token_match();
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($info[&#39;order_comment&#39;])&nbsp;pe_error(&#39;请勿重复评价...&#39;);
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;foreach&nbsp;($info_list&nbsp;as&nbsp;$k=&gt;$v)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql_set[$k][&#39;comment_star&#39;]&nbsp;=&nbsp;intval($_p_comment_star[$v[&#39;product_id&#39;]]);
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql_set[$k][&#39;comment_text&#39;]&nbsp;=&nbsp;pe_dbhold($_p_comment_text[$v[&#39;product_id&#39;]]);
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql_set[$k][&#39;comment_atime&#39;]=&nbsp;time();
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql_set[$k][&#39;product_id&#39;]&nbsp;=&nbsp;$v[&#39;product_id&#39;];
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql_set[$k][&#39;order_id&#39;]&nbsp;=&nbsp;$order_id;
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql_set[$k][&#39;user_ip&#39;]&nbsp;=&nbsp;pe_dbhold(pe_ip());
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql_set[$k][&#39;user_id&#39;]&nbsp;=&nbsp;$_s_user_id;
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$sql_set[$k][&#39;user_name&#39;]&nbsp;=&nbsp;$_s_user_name;
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!$sql_set[$k][&#39;comment_text&#39;])&nbsp;pe_error(&#39;评价内容必须填写...&#39;);
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($db-&gt;pe_insert(&#39;comment&#39;,&nbsp;$sql_set))&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;order_callback(&#39;comment&#39;,&nbsp;$order_id);
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pe_success(&#39;评价成功!&#39;);</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;"></span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">我们注册个用户 aaaaaaa&#39; ,购买商品后评价，可以看到 单引号带入了。</span></p><p style="text-align: center; text-indent: 0em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><img src="http://p8.qhimg.com/t012258ac959f11d5cf.png"/></span></p></p>
                <hr/>
                <p style="text-align: center;">
                    <img src="http://bobao.360.cn/img/app.jpeg"/>
                    <img src="http://bobao.360.cn/img/weixin.jpeg"/>
                </p>
                                <p>本文由 安全客 原创发布，如需转载请注明来源及本文地址。<br/>本文地址：http://bobao.360.cn/learning/detail/3023.html
                </p>
                            </div>
            <div style="margin-top: 20px;background-color:#FFFFFF">
    <input type="hidden" id="detail_title" name="detail_title" value="【技术分享】由浅入深教你学会源代码审计系列（一） - 安全客 - 有思想的安全新媒体" />
    <input type="hidden" id="use_nickname" name="use_nickname" value="0" />
    <a name="mao"></a>
    <div class="reg-log mobile-hiden">
        <div class="" id="userTo">   
            <div id="to-list" class="input-text" style="">
                <textarea disabled="disabled" class="hide"  id="comment-content" to="to"></textarea>
                <ul id="preadded" style="display:none">       
                </ul>
                <div id="to-auto" style="width: 200px">
                    <ul id="feed">
                    </ul>
                </div>
            </div>
        </div>
        <input type="hidden" id="source-id" value="3023" />
        <input type="hidden" id="source-type" value="learning" />
        <input type="hidden" id="post-comment-url" value="/comment/add" />
        <input type="hidden" id="post-nickname-url-ajax" value="/comment/randnicknameajax" />
        <input type="hidden" id="post-check-login-url-ajax" value="/comment/checklogin" />
        <input type="hidden" id="stoken_comment_set" value="ea3898fb4df38673fdeb61c458234054">                 <span class="join">参与讨论，请先 <a href="javascript:;" class="comment-login">登录</a> | <a href="javascript:;" class="comment-reg">注册</a> |  <a href="javascript:;" class="anonymous-comment">匿名评论</a></span>
            </div>
    <div class="mobile-hide" style="width: 870px; margin: 0 auto;">
        <label style="vertical-align:middle;" for="use_nickname">匿名</label> 
        <input style="vertical-align:middle;" id="trigger-nickname" name="use_nickname" class="use_nickname" type="checkbox" value="0" />

        <a href="javascript:;" class="apply-use button" id="submit-comment" data-target="/comment/add">发布</a>
    </div>


    <div class="clearfix"></div>
    <div class="comments">
        <div class="comments-head">
            <span class="title">用户评论</span>
        </div>
                <div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/10x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="167838976" class="response" data-bind-id="167838976" data-target="5467" user-name="大表哥" href="javascript:;">
                大表哥            </a>
                        <span class="comment-time">2016-10-23 11:53:34</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="167838976" data-target="5467">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_5467" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">学习了</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/6x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="1489787802" class="response" data-bind-id="1489787802" data-target="4224" user-name="r00tuser" href="javascript:;">
                r00tuser            </a>
                        <span class="comment-time">2016-09-18 08:16:25</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="1489787802" data-target="4224">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_4224" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">文章很好，菜鸟受教了。</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/3x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="4192" user-name="撸站十年" href="javascript:;">
                撸站十年            </a>
                        <span class="comment-time">2016-09-13 13:05:13</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="4192">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_4192" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">jsp其实还是servlet,如果没有使用框架一般还是多入口模式，一个jsp页面对应一个servlet，或者一个jsp自处理（jsp本身就是servlet）。
如果采用了框架，大部分都为MVC模式，只需要从页面模板跟踪到请求，然后逻辑层和数据层。
审计方法基本相同，直接搜索危险函数，SQL语句等等  然后看参数是否可控。
或者从功能追踪，前端页面&gt;请求处理&gt;业务逻辑&gt;数据调用</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/6x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="4187" user-name="我菜爆了" href="javascript:;">
                我菜爆了            </a>
                        <span class="comment-time">2016-09-13 08:18:17</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="4187">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_4187" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">很不错的文章，为啥每人回复呢？！</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>

        <a class="more-long comment-more" href="javascript:;" data-target="/comment/more" data-type="learning" data-source-id="3023" data-page="2">查看更多</a>
            </div>
</div>
<script>
    $(function () {
        $('.anonymous-comment').click(function () {
            $(".join").hide();
            $(".reg-log textarea").first().removeAttr("disabled").show();
            $('#use_nickname').val('1');
//            $('#trigger-nickname').attr('checked', true);
            $('#trigger-nickname').trigger('click');
        });
        //为所有复选框绑定事件
//        checkbox_on_click();
        //ajax随机获取昵称
//        randnicknameajax(0);
        //ajax检测登录状态
        comment_check_login();
    });



    function input_checkbox(flag) {
        $('input:checkbox').each(function () {
            var value = flag ? 1 : 0;
            $(this).prop('checked', flag);
            $(this).val(value);
        });
    }

//ajax随机获取昵称
    function randnicknameajax(flag) {
        $.ajax({
            type: 'POST',
            url: $('#post-nickname-url-ajax').val(),
            data: {limit: 1, flag: flag},
            dataType: "json",
            success: function (data) {
                $('#nick-name').val(data.data[0]);
                _nick_name=data.data[0];
            }
        });
    }
    $();
//ajax检测登录状态
    function comment_check_login() {
        $.ajax({
            type: 'POST',
            url: $('#post-check-login-url-ajax').val(),
            data: {},
            dataType: "json",
            success: function (data) {
                if (data.success) {
                    $('.join').hide();
                    $(".reg-log textarea").first().removeAttr("disabled").show();
                    $("#span_use_nickname").show();
                    $('#use_nickname').val('0');
                    $('#use_nickname').attr('checked', false);
                }
            }
        });
    }
</script>        </div>
    </div>
    <div class="side-bar">
        <div class="mod hot-news">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-hot"></i><span>热门知识</span></h2>
    </div>
    <ul class="links-list">
                                <li><a href="/learning/detail/4411.html" alt="【漏洞预警】一个换行符引发的奥斯卡0day漏洞(CVE-2017-8759)重现——最新的Office高级威胁攻击预警" target="_blank">【漏洞预警】一个换行符引发的奥斯卡...</a></li>
                                <li><a href="/learning/detail/4416.html" alt="【漏洞预警】Microsoft .NET Framework漏洞（CVE–2017–8759）预警" target="_blank">【漏洞预警】Microsoft .NE...</a></li>
                                <li><a href="/learning/detail/4414.html" alt="【技术分享】妙用JavaScript绕过XSS过滤" target="_blank">【技术分享】妙用JavaScrip...</a></li>
                                <li><a href="/learning/detail/4418.html" alt="【技术分享】利用威胁情报数据平台拓展APT攻击线索一例" target="_blank">【技术分享】利用威胁情报数据平台拓...</a></li>
                                <li><a href="/learning/detail/4417.html" alt="【知识】9月15日 - 每日安全知识热点" target="_blank">【知识】9月15日 - 每日安全知识热...</a></li>
                                <li><a href="/learning/detail/4425.html" alt="【安全报告】XShellGhost事件技术回顾报告" target="_blank">【安全报告】XShellGhost事件...</a></li>
            </ul>
</div>        <!-- 友情链接 -->
        <div class="mod blog-links mobile-hide">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-link"></i><span>友情链接</span></h2>
        <a href="/links/index.html" class="more">更多<i></i></a>
    </div>
        <ul class="links-list">
                <li><a href="http://bbs.360safe.com" alt="360安全社区" target="_blank">360安全社区</a></li>
                <li><a href="http://zhuji.360.cn" alt="360主机卫士" target="_blank">360主机卫士</a></li>
                <li><a href="http://blogs.360.cn/" alt="奇虎360技术博客" target="_blank">奇虎360技术博客</a></li>
                <li><a href="http://wangzhan.360.cn/" alt="360网站卫士" target="_blank">360网站卫士</a></li>
                <li><a href="http://webscan.360.cn/" alt="360网站安全检测" target="_blank">360网站安全检测</a></li>
                <li><a href="http://research.360.cn/report/" alt="360研究报告" target="_blank">360研究报告</a></li>
                <li><a href="http://unicorn.360.cn/" alt="360 Unicorn Team" target="_blank">360 Unicorn Team</a></li>
                <li><a href="http://appscan.360.cn/" alt="360捉虫猎手" target="_blank">360捉虫猎手</a></li>
                <li><a href="https://threathunter.org/" alt="ThreatHunter社区" target="_blank">ThreatHunter社区</a></li>
                <li><a href="http://security.360.cn/" alt="360安全应急响应中心" target="_blank">360安全应急响应中心</a></li>
            </ul>
    </div>
        <!-- 联系我们 -->
        <div class="mod contact mobile-hide" style="text-align:center">
    <div class="head-bar clearfix">
        <h2><i></i><span>关注我们</span></h2>
    </div>
    <!-- 微信关注 -->
    <ul class="contact-way">
        <li><a>微信关注</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/qrcode_adlab_weixin.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
    <!-- APP下载 -->
    <ul class="contact-way">
        <li><a>安全播报APP</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/scan_code_big.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
</div>

    </div>
</div>

<script type="text/javascript" src="/js/jquery-ui.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/jquery.noty.packaged.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/common.js?v=4.5"></script>
<script>$(function() {sync_count('comment');});</script>


<!-- 语法高亮 -->
<script type="text/javascript" src="/ue/SyntaxHighlighter/shCore.js"></script>
<script type="text/javascript">SyntaxHighlighter.all();sync_count('vul');sync_count('news');sync_count('learning');sync_count('activity');sync_count('course');sync_count('ctf');</script>
    </div>

        <div class="footer">
        <div class="friend-link">
            <a href="http://www.360.cn/" target="_blank">360首页</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">关于我们</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">联系我们</a>
            <span>|</span>
            <a href="/links/index.html" target="_blank">友情链接</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">招贤纳士</a>
        </div>
        <div class="copy">
            Copyright &copy; 360网络攻防实验室 All Rights Reserved <span class="copy_icp">京ICP证080047号[京ICP备08010314号-6]</span>
        </div>
    </div>
    
</div>

<!--奇舞团统计-->

<script src='https://s.ssl.qhimg.com/static/f5407c785655e6a1/monitor_analytic.js'></script>
<script>
    monitor.setProject('QH_171_1').getTrack().getClickAndKeydown().getClickHeatmap(10, 1);
</script>

<div class="hide">
    <script src="https://s95.cnzz.com/z_stat.php?id=1253147824&web_id=1253147824" language="JavaScript"></script>
</div>
<div class="backToTop_wrap off">
    <a id="back_to_top" class="backToTop" href="javascript:;" title="返回顶部"></a>
</div>
<script>
    var $backToTop_wrap = $(".backToTop_wrap"),
        $backToTop_btn = $("#back_to_top");

    if ($(window).scrollTop() > 100) {
        $backToTop_wrap.removeClass("off");
    }
    else {
        $backToTop_wrap.addClass("off");
    }

    $(window).on("scroll", function () {
        if ($(this).scrollTop() > 100) {
            $backToTop_wrap.removeClass("off");
        }
        else {
            $backToTop_wrap.addClass("off");
        }
    });

    $backToTop_btn.on("click", function () {
        $("html, body").animate({scrollTop: 0}, 120);
    });

    $(function () {
        var navlist = $('.nav-list > li');

        navlist.each(function () {
            $(this).on('mouseenter', function () {
                $(this).addClass('selected');
            });

            $(this).on('mouseleave', function () {
                $(this).removeClass('selected');
            });
        });
    })
</script>



</body>
</html>
