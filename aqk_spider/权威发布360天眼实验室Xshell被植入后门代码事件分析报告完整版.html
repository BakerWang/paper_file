<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns:wb="http://open.weibo.com/wb" xml:lang="en" lang="en">
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"/>
    <link rel="shortcut icon" href="http://bobao.360.cn/favicon.ico?v=1.1"/>
    <link rel="alternate" title="安全资讯" href="/rss?type=news" type="application/rss+xml"/>
    <link rel="alternate" title="安全知识" href="/rss?type=learning" type="application/rss+xml"/>
    <link rel="alternate" title="安全圈活动" href="/rss?type=activity" type="application/rss+xml"/>
    <link rel="alternate" title="所有漏洞" href="/rss?type=vul" type="application/rss+xml"/>
    <link rel="alternate" title="通用型漏洞" href="/rss?type=commonvul" type="application/rss+xml"/>
    <link rel="alternate" title="事件型漏洞" href="/rss?type=eventvul" type="application/rss+xml"/>
    <link rel="alternate" title="热门漏洞" href="/rss?type=hotvul" type="application/rss+xml"/>

        <title>【权威发布】360天眼实验室：Xshell被植入后门代码事件分析报告（完整版） - 安全客 - 有思想的安全新媒体</title>
    
        <meta name="keywords" content="Xshell后门,Xshell后门事件"/>
    
        <meta name="description" content="近日，非常流行的远程终端Xshell被发现被植入了后门代码，用户如果使用了特洛伊化的Xshell工具版本会导致本机相关的敏感信息被泄露到攻击者所控制的机器甚至被远程控制执行更多恶意操作。本篇文章为对该事件的分析报告。"/>
        <meta property="wb:webmaster" content="224437c7be31d633"/>

    <script type="text/javascript" src="http://s7.qhimg.com/!56caa871/xpc_sync_height.js"></script>
    <link rel="stylesheet" type="text/css" href="/css/reset.css" />
    <link rel="stylesheet" type="text/css" href="/css/common_new.css?v=4.4.2.1" />
    <link rel="stylesheet" type="text/css" href="/css/jquery.notyfy.css" />
    <link rel="stylesheet" type="text/css" href="/css/notyfy.theme.default.css" />
    <link rel="stylesheet" type="text/css" href="/css/s_common.css?v=2.2.7" media="only screen and
    (max-device-width:900px), only screen and (max-width:900px)" />
    <script type="text/javascript" src="/js/jquery.min.js?v=3.1"></script>
    <script type="text/javascript" src="/js/jquery.notyfy.js"></script>
    <script type="text/javascript" src="/js/iscroll.js"></script>
    <script src="http://js.passport.qihucdn.com/5.0.3.js"></script>
    <script type="text/javascript">
        var myScroll, myNavScroll;

        function iscrollLoaded() {
            myScroll = new IScroll('#wrapper',
                {
                    scrollX: true,
                    scrollY: false,
                    bounceEasing: 'circular',
                    eventPassthrough: true,
                    preventDefault: false,
                    bounceTime: 500
                }
            );
        }

        $(function () {

            //导航横向滚动


            function setNavWidth() {

                /* 计算导航宽度 */
                var allWidth = $(window).width();
                var scroller = $('#scroller');

                if (allWidth > 900) {
                    scroller.find('ul').add(scroller.find('.scroll')).removeAttr('style');
                    scroller.css('overflow', 'visible');
                    if (myNavScroll) myNavScroll.destroy();
                } else {

                    var width = 0;
                    scroller.find('.scroll').children('ul').children('li').each(function (index, el) {
                        if (!$(this).hasClass('mobile-hide')) {
                            width += $(this).outerWidth();
                        }
                    });
                    scroller.find('ul').add(scroller.find('.scroll')).width(width);

                    if (myNavScroll) myNavScroll.destroy();

                    myNavScroll = new IScroll('#scroller', {
                        scrollX: true,
                        scrollY: false,
                        momentum: false,
                        click: true
                    });

                }

            }

            setNavWidth();
            $(window).resize(function (event) {
                setNavWidth();
            });

        });

    </script>
</head>
<body onload="iscrollLoaded();">
<div style='margin:0 auto;width:0px;height:0px;overflow:hidden;'>
    <img src=""/>
</div>

<div id="is-mobile"></div>
<div class="container">
        <div class="mobile-header">
        <div class="header clearfix">
            <div class="header-wrapper clearfix">
                <a href="/index/index" class="logo"><img class="slogan" src="/img/logo.png?v=1.5"/></a>
                                <form id="search" class="search-box" action="/search/index" method="GET">
                    <input class="keys" name="keywords" type="text" placeholder="搜索漏洞" required="required">
                    <input class="icon" type="submit" value="">
                    <input type="hidden" name="type" value=""/>
                </form>
                <div class="bug">
                    <div class="name"><span class="seled">全部</span><i class="arrow"></i></div>
                    <ul class="typelist">
                        <li data-index="3"><a href="javascript:void(0);">全部</a></li>
                        <li data-index="0"><a href="javascript:void(0);">漏洞</a></li>
                        <li data-index="1"><a href="javascript:void(0);">资讯</a></li>
                        <li data-index="2"><a href="javascript:void(0);">知识</a></li>
                    </ul>
                </div>
                                <div class="logNreg mobile-hide">
                    <div class="unlog">
                        <i></i>
                        <a href="log.html" class="log">登录</a>
                        <span>|</span>
                        <a href="reg.html" class="reg">注册</a>
                    </div>
                    <div class="loged">
                        <a href="/member/profile" class="user-center"><i></i><span class="user-name-tag">个人中心</span></a>
                        <div class="user-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting"><a href="http://i.360.cn/profile/accountmanage"
                                                               target="_blank"><i></i><span>账号设置</span></a></li>
                                <li class="alert-setting"><a href="/keywords/index"
                                                             target="_blank"><i></i><span>告警设置</span></a></li>
                                <li class="bug-alert"><a href="/myalarm/index" target="_blank"><i></i><span>漏洞告警</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mylearn/index" target="_blank"><i></i><span>我的知识</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mycourse/index" target="_blank"><i></i><span>我的课堂</span></a>
                                </li>
                                <li class="my-exit"><a
                                            href="http://login.360.cn/?src=pcw_adlab&op=logout&destUrl=http://bobao.360.cn"><i></i><span>退出系统</span></a>
                                </li>
                            </ul>
                        </div>

                        <a href="/message" class="message-center" target="_blank"><i></i><span>我的消息</span></a>
                        <div class="message-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting" style="display:none;"><a href="/myres/index"
                                                                                     target="_blank"><i></i><span>回复我的</span></a>
                                </li>
                                <li class="my-bug"><a href="/myvul/index"
                                                      target="_blank"><i></i><span>我的漏洞</span></a></li>
                                <!--<li class="my-bug"><a href="/myres/index" target="_blank"><i></i><span>我的评论</span></a></li>-->
                                <!--<li class="alert-setting"><a href="###" target="_blank"><i></i><span>提到我的</span></a>
                                </li>-->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <style type="text/css">
            .nav {
                overflow: hidden;
            }

            .nav .scroll {
                width: auto;
            }
        </style>
        <div id="wrapper">
            <div id="scroller" class="nav">
                <div class="scroll">
                    <ul class="nav-list">
                        <li ><a class="link-nav"
                                                                                 href="/index/index">首页</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/vul/index">漏洞</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/introduce/list">招聘</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/news/index">资讯</a><!--<i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/introduce/list">招聘</a></li>
                        </ul>
			-->
                        </li>
                        <li class="cur">
                        <a class="link-nav" href="/learning/index">知识</a><i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/course/index">学院</a></li>
                        </ul>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/activity/index">活动</a></li>
                        <li class="mobile-hide "><a class="link-nav"
                                                                                                   href="/ctf/index">CTF训练营</a>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/interref/list">安全内参</a></li>
                        <li ><a class="link-nav" href="/app/index">APP</a></li>

                        <!--<li ><a href="/course/index">学院</a></li>-->
                        <!--<li ><a href="/introduce/list">招聘</a></li>-->
                        <!--<li  class="mobile-hide"><a href="/ctf/index">CTF训练营</a></li>-->
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="mobile-content">
        <link rel="stylesheet" type="text/css" href="/css/news.css?v=3.5" />
<link rel="stylesheet" type="text/css" href="/ue/SyntaxHighlighter/shCoreDefault.css?v=1.0" />
<style>
    p .syntaxhighlighter {
        width: 80%;
    }
</style>

<div class="cur-pos w1000">当前位置：<a href="http://bobao.360.cn/">安全客</a> &gt;&gt; 知识详情</div>

<div class="content clearfix">
    <div class="main">
        <div class="article">
            <div id="article_box">
                <h2>【权威发布】360天眼实验室：Xshell被植入后门代码事件分析报告（完整版）</h2>
                <div class="article-msg">
                    <span class="time">2017-08-18 18:29:34</span>
                    
                                        <span class="read">阅读：31893次</span>
                    <span><a style="display: none;" class="good" href="javascript:;"
                             data-target="/learning/good" data-value="g_4278"
                             data-type="learning">点赞(0)</a></span>
                    <span><a class="fav" href="javascript:;" data-target="/mylearning/add"
                             data-pk="4278" data-type="learning">收藏</a></span>
                                        <span><a style="margin-left: 4px;" class="fav" href=""
                             target="_blank">来源： 安全客</a></span>
                    
                    
                    <div style="margin-top:10px; ">
                        <a href="/member/contribute?uid=2794533901" style="color:#848e99;">
                            <img src="http://p1.qhmsg.com/dm/150_150_100/t00df551a583a87f4e9.jpg" data-is-avatar="true"
                                 style="border: 1px solid #d5d5d5;padding: 2px; width: 80px;height: 80px;border-radius: 43px;"/>
                        </a>

                    </div>
                    <span class="orig">作者：<a href="/member/contribute?uid=2794533901" style="color:#848e99;">360天眼实验室</a></span>
                                    </div>
                <hr size="1">
                <div class="article-msg">
                    <p><!-- JiaThis Button BEGIN -->

<!--
<span class="jiathis_style"><span class="jiathis_txt">分享到：</span>
	<a class="jiathis_button_weixin"></a>
	<a class="jiathis_button_tsina"></a>
    <a class="jiathis_button_tqq"></a>
    <a class="jiathis_button_qzone"></a>
    <a class="jiathis_button_renren"></a>
    <a class="jiathis_button_xiaoyou"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
</span>

-->
</p>
                </div>
                <p><p style="text-align: center; text-indent: 0em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><img src="http://p6.qhimg.com/t01a5028b038a158cff.png" alt="“Xshell”的图片搜索结果"/></span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">文档信息</span></strong></span></p><hr/><p style="text-align: center; text-indent: 0em;"><img src="http://p0.qhimg.com/t01e61f4c4491f5cccb.png" title="t017b70bffc6dce96a4.png" alt="http://p1.qhimg.com/t017b70bffc6dce96a4.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">事件概要</span></strong></span></p><hr/><p style="text-align: center; text-indent: 0em;"><img src="http://p7.qhimg.com/t011660d3116a477c97.png" title="t01ecbf3a5c8fb686f5.png" alt="http://p8.qhimg.com/t01ecbf3a5c8fb686f5.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></p><p style="text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">事件简述</span></strong></span></p><hr/><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">近日，非常流行的远程终端Xshell被发现被植入了后门代码，用户如果使用了特洛伊化的Xshell工具版本会导致本机相关的敏感信息被泄露到攻击者所控制的机器甚至被远程控制执行更多恶意操作。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Xshell特别是Build 1322在国内的使用面很大，敏感信息的泄露及可能的远程控制导致巨大的安全风险，我们强烈建议用户检查自己所使用的Xshell版本，如发现，建议采取必要的补救措施。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></p><p style="text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">事件时间线</span></strong></span></p><hr/><p style="text-indent: 2em;"><span style="color: rgb(0, 112, 192);"><strong><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">2017年8月7日</span></strong></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">流行远程管理工具Xshell系列软件的厂商NetSarang发布了一个更新通告，声称在卡巴斯基的配合下发现并解决了一个在7月18日的发布版本的安全问题，提醒用户升级软件，其中没有提及任何技术细节和问题的实质，而且声称没有发现漏洞被利用。</span></p><p style="text-indent: 2em;"><span style="color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">2017年8月14日</span></strong></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">360威胁情报中心分析了Xshell Build 1322版本（此版本在国内被大量分发使用），发现并确认其中的nssock2.dll组件存在后门代码，恶意代码会收集主机信息往DGA的域名发送并存在其他更多的恶意功能代码。360威胁情报中心发布了初始的分析报告，并对后续更复杂的恶意代码做进一步的挖掘分析，之后其他安全厂商也陆续确认了类似的发现。</span></p><p style="text-indent: 2em;"><span style="color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">2017年8月15日</span></strong></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">卡巴斯基发布了相关的事件说明及技术分析，与360威胁情报中心的分析完全一致，事件可以比较明确地认为是基于源码层次的恶意代码植入。非正常的网络行为导致相关的恶意代码被卡巴斯基发现并报告软件厂商，在8月7日NetSarang发布报告时事实上已经出现了恶意代码在用户处启动执行的情况。同日NetSarang更新了8月7日的公告，加入了卡巴斯基的事件分析链接，标记删除了没有发现问题被利用的说法。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></p><p style="text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">影响面和危害分析</span></strong></span></p><hr/><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">目前已经确认使用了特洛伊化的Xshell的用户机器一旦启动程序，主机相关基本信息（主机名、域名、用户名）会被发送出去。同时，如果外部的C&amp;C服务器处于活动状态，受影响系统则可能收到激活数据包启动下一阶段的恶意代码，这些恶意代码为插件式架构，可能执行攻击者指定任意恶意功能，包括但不仅限于远程持久化控制、窃取更多敏感信息。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">根据360网络研究院的C&amp;C域名相关的访问数量评估，国内受影响的用户或机器数量在十万级别，同时，数据显示一些知名的互联网公司有大量用户受到攻击，泄露主机相关的信息。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></p><p style="text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">解决方案</span></strong></span></p><hr/><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">检查目前所使用的Xshell版本是否为受影响版本，如果组织保存有网络访问日志或进行实时的DNS访问监控，检查所在网络是否存在对于附录节相关IOC域名的解析记录，如发现，则有内网机器在使用存在后门的Xshell版本。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">目前厂商NetSarang已经在Xshell Build 1326及以后的版本中处理了这个问题，请升级到最新版本，修改相关系统的用户名口令。厂商修复过的版本如下：</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Xmanager Enterprise Build 1236</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Xmanager Build 1049</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Xshell Build 1326</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Xftp Build 1222</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Xlpd Build 1224</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">软件下载地址：<a href="https://www.netsarang.com/download/software.html">https://www.netsarang.com/download/software.html</a>&nbsp;</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></p><p style="text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">技术分析</span></strong></span></p><hr/><p style="text-indent: 2em;"><span style="color: rgb(0, 112, 192); font-size: 18px;"><strong><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">基本执行流程</span></strong></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Xshell相关的用于网络通信的组件nssock2.dll被发现存在后门类型的代码，DLL本身有厂商合法的数字签名，但已经被多家安全厂商标记为恶意：</span></p><p style="text-align: center;"><img src="http://p0.qhimg.com/t0171b679b3b230bf88.png" title="t0193bdccedb7666dc3.png" alt="http://p2.qhimg.com/t0193bdccedb7666dc3.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">360威胁情报中心发现其存在加载执行Shellcode的功能：</span></p><p style="text-align: center;"><img src="http://p7.qhimg.com/t015c0e1fd993a4020c.png" title="t01657bbbbbf90f3fdb.png" alt="http://p1.qhimg.com/t01657bbbbbf90f3fdb.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">我们将这段代码命名为loader_code1, 其主要执行加载器的功能，会再解出一段新的代码（module_Activation），然后动态加载需要的Windows API和重定位，跳转过去。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">经过对进程执行的整体分析观察，对大致的执行流程还原如下图所示：</span></p><p style="text-align: center;"><img src="http://p3.qhimg.com/t01fde0bbce858ffa6c.png" title="t01e5060ba0ab25148c.png" alt="http://p6.qhimg.com/t01e5060ba0ab25148c.png"/></p><p style="text-indent: 2em;"><span style="color: rgb(0, 112, 192); font-size: 18px;"><strong><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">基本插件模块</span></strong></span></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Module_Activation</span></strong></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">module_Activation会开启一个线程，然后创建注册表项：HKEY_CURRENT_USER\SOFTWARE\-[0-9]+(后面的数字串通过磁盘信息xor 0xD592FC92生成)，然后通过RegQueryValueExA查询该注册表项下”Data”键值来执行不同的功能流程。</span></p><p style="text-align: center;"><img src="http://p0.qhimg.com/t013796425fe30d0e43.png" title="t011064c39484b4b3fa.png" alt="http://p7.qhimg.com/t011064c39484b4b3fa.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">当注册表项”Data”的值不存在时，进入上传信息流程，该流程主要为收集和上传主机信息到每月一个的DGA域名，并保存服务器返回的配置信息，步骤如下：</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">获取当前系统时间，根据年份和月份按照下面的算法生成一个长度为10-16的字符串，然后将其与”.com”拼接成域名。</span></p><p style="text-align: center;"><img src="http://p2.qhimg.com/t011549c2c63cfe7724.png" title="t01c9add0ed63c91a4d.png" alt="http://p8.qhimg.com/t01c9add0ed63c91a4d.png"/></p><p style="text-align: center;"><img src="http://p6.qhimg.com/t01ab408101b5d7ef73.png" title="t01db34e8ed41488118.png" alt="http://p2.qhimg.com/t01db34e8ed41488118.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">年份-月份 和 生成的域名对应关系如下：</span></p><p style="text-align: center;"><img src="http://p4.qhimg.com/t0195e74ad482a2f733.png" title="t01f7543082e9f56d92.png" alt="http://p2.qhimg.com/t01f7543082e9f56d92.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">接着，将前面收集的网络、计算机、用户信息按照特定算法编码成字符串，然后作为上面的域名前缀，构造成查询*. nylalobghyhirgh.com 的DNS TXT的数据包，分别向8.8.8.8 | 8.8.4.4 | 4.2.2.1 | 4.2.2.2 | [cur_dns_server] 发送，然后等待服务器返回。</span></p><p style="text-align: center;"><img src="http://p2.qhimg.com/t01d58275df1b8c8e23.png" title="t01d1f194e7d8f532db.png" alt="http://p0.qhimg.com/t01d1f194e7d8f532db.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">服务器返回之后（UDP）校验数据包，解析之后把数据拷贝到之前传入的参数中，下一步将这些数据写入前面设置的注册表项，也就是HKEY_CURRENT_USER\SOFTWARE\-[0-9]+的Data键中。这些数据应该是作为配置信息存放的，包括功能号，上次活跃时间，解密下一步Shellcode的Key等等。</span></p><p style="text-align: center;"><img src="http://p2.qhimg.com/t01273396aea1090f43.png" title="t01eefe606044f5c553.png" alt="http://p6.qhimg.com/t01eefe606044f5c553.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">当RegQueryValueExA查询到的Data键值存在数据时，则进入后门执行流程，该流程利用从之前写入注册表项的配置信息中的Key解密loader_code2后跳转执行。</span></p><p style="text-align: center;"><img src="http://p2.qhimg.com/t019caf3c6e27abd3c4.png" title="t0155afcfd6e750aac9.png" alt="http://p6.qhimg.com/t0155afcfd6e750aac9.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">解密loader_code2的算法如下：先取出module_Activation偏移0x3128处的original_key，接着取key的最后一个byte对偏移0x312C处长度为0xD410的加密数据逐字节进行异或解码，每次异或后original_key再与从配置信息中读取的key1、key2进行乘、加运算，如此循环。</span></p><p style="text-align: center;"><img src="http://p3.qhimg.com/t01f7b0f26f95dcec65.png" title="t010545cb167c8ed2df.png" alt="http://p4.qhimg.com/t010545cb167c8ed2df.png"/></p><p style="text-align: center;"><img src="http://p5.qhimg.com/t0148745f62f69c6e2f.png" title="t012c9fdc8d34a89e2b.png" alt="http://p9.qhimg.com/t012c9fdc8d34a89e2b.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">解密之后跳转到loader_code2中, loader_code2其实和loader_code1是一样的功能，也就是一个loader，其再次从内存中解密出下一步代码：module_ROOT, 然后进行IAT的加载和重定位，破坏PE头，跳转到ROOT模块的入口代码处。</span></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Module_ROOT</span></strong></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">ROOT模块即真正的后门核心模块，为其他插件提供了基本框架和互相调用的API，其会在内存中解密出5个插件模块Plugin、Online、Config、Install和DNS，分别加载到内存中进行初始化，如果插件在初始化期间返回没有错误，则被添加到插件列表中。</span></p><p style="text-align: center;"><img src="http://p5.qhimg.com/t0147005c3181341f25.png" title="t01f0b0d8a2b5235fa7.png" alt="http://p4.qhimg.com/t01f0b0d8a2b5235fa7.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">每个插件由DLL变形而成，加载后根据fwReason执行不同功能 (其中有一些自定义的值100,101,102,103,104).不同的插件模块fwReason对应的功能可能有细微的差异，整体上如下：</span></p><p style="text-align: center;"><img src="http://p5.qhimg.com/t01113f610eb4288545.png" title="t01429657676bb61b2a.png" alt="http://p2.qhimg.com/t01429657676bb61b2a.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">接着ROOT模块搜索ID为103（“Install”）的插件，并调用其函数表的第二个函数。进行安装操作。</span></p><p style="text-align: center;"><img src="http://p6.qhimg.com/t01a5b9ad82614442ca.png" title="t010b8ae31c476b30ec.png" alt="http://p5.qhimg.com/t010b8ae31c476b30ec.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">同时ROOT模块也通过把自身函数表地址提供给其他模块的方式为其他模块提供API，这些API主要涉及跨模块调用API、加解密等功能。</span></p><p style="text-align: center;"><img src="http://p7.qhimg.com/t0152cc1b0bf6b2c155.png" title="t01458a87f488a929b4.png" alt="http://p1.qhimg.com/t01458a87f488a929b4.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">另外其中解密的函数以及加载插件的函数也是由动态解出来的一段shellcode，可见作者背后的煞费苦心：</span></p><p style="text-align: center;"><img src="http://p4.qhimg.com/t01707491a97321b198.png" title="t01c11a614e425d89f1.png" alt="http://p8.qhimg.com/t01c11a614e425d89f1.png"/></p><p style="text-align: center;"><img src="http://p1.qhimg.com/t01e06ad0a742fc3875.png" title="t01984510ac157c25ee.png" alt="http://p3.qhimg.com/t01984510ac157c25ee.png"/></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Module_Plugin</span></strong></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Plugin模块为后门提供插件管理功能，包括插件的加载、卸载、添加、删除操作，管理功能完成后会通过调用Online的0x24项函数完成回调，向服务器返回操作结果。模块的辅助功能为其他插件提供注册表操作。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Plugin的函数列表如下：</span></p><p style="text-align: center;"><img src="http://p9.qhimg.com/t01d367cf72ce6dbcf3.png" title="t012d325bdb94d8a6f8.png" alt="http://p7.qhimg.com/t012d325bdb94d8a6f8.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">其中比较重要的是fuc_switch和CreateLoadRegThread。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">fuc_switch</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">此函数根据第二个参数结构体的0x4偏移指令码完成不同操作，指令码构造如下：</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">（ID&lt;&lt;0x10）| Code</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">0x650000功能</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">此功能获取当前加载的插件列表字符串，此功能遍历全局ModuleInfo结构体获取模块名称列表，完成后通过Online模块的0x24执行调用者参数的回调函数，该回调为网络通知函数。</span></p><p style="text-align: center;"><img src="http://p0.qhimg.com/t0137e11b736f3fecc8.png" title="t01bc5b100d83e88f14.png" alt="http://p8.qhimg.com/t01bc5b100d83e88f14.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">0x650001功能</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">此功能首先通过参数ID获取模块信息，如果该ID未被加载，则调用Root的加密函数加密模块数据，随后更新对应注册表值，完成模块更新，模块数据加密后保存，在Root模块初始化过程中会调用Plugin的注册表监听线程，该线程检测到注册表项变动后加载此模块：</span></p><p style="text-align: center;"><img src="http://p1.qhimg.com/t019d7b3819c1ebb649.png" title="t0131504e8d366a3137.png" alt="http://p8.qhimg.com/t0131504e8d366a3137.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">0x650002功能</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">此功能通过文件名称加载PE结构的插件，Root模块的0x30项调用LoadLibrary函数加载DLL，并将插件结构插入全局插件双链表：</span></p><p style="text-align: center;"><img src="http://p2.qhimg.com/t0198a574dd46a2da4a.png" title="t01343c14eecdede825.png" alt="http://p4.qhimg.com/t01343c14eecdede825.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">0x650003功能</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">该功能通过模块基址查找指定模块，内存卸载模块后删除对应注册表键值，彻底卸载模块：</span></p><p style="text-align: center;"><img src="http://p4.qhimg.com/t01cc9e768108895fba.png" title="t0166ccbfdee859bfa1.png" alt="http://p6.qhimg.com/t0166ccbfdee859bfa1.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">0x650004功能</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">此功能检测参数指定模块ID是否被加载，如果该ID已被加载，通过Online的网络回调发送一个长度为1，数据为0x00的负载网络包，如果ID未被加载则发送一个长度为0的负载网络包。</span></p><p style="text-align: center;"><img src="http://p1.qhimg.com/t01c332b2b8dce223ee.png" title="t01f5cc83125bea504a.png" alt="http://p5.qhimg.com/t01f5cc83125bea504a.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">CreateLoadRegThread</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">该函数创建线程，异步遍历注册表项“SOFTWARE\Microsoft\&lt;MachineID&gt;”，其中MachineID根据硬盘序列号生成。随后创建Event对象，使用RegNotifyChangeKeyValue函数监测插件注册表键值是否被更改，被更改后则遍历键值回调中解密并加载模块并插入全局插件ModuleInfo。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Plugin模块的维护数据结构为双链表，并为每个插件定义引用计数，当引用计数为0时才从内存卸载插件。结构大致如下：</span></p><p style="text-align: center;"><img src="http://p7.qhimg.com/t01ce66348a367bf82f.png" title="t017eae70c11ea236fb.png" alt="http://p0.qhimg.com/t017eae70c11ea236fb.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Module_Online</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">该模块主要功能是与服务器连接，获取服务器返回的控制指令，然后根据控制指令中的插件ID和附加数据来调用不同的插件完成相应的功能。同时Online也提供API接口给其他插件模块用于回传数据。</span></p><p><br/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Online模块的函数表如下，可以看到其提供了一系列收发数据的API&nbsp;</span></p><p style="text-align: center;"><img src="http://p2.qhimg.com/t010e74fd74bc6557d9.png" title="t01d5dbf51e228efdfd.png" alt="http://p1.qhimg.com/t01d5dbf51e228efdfd.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">网络连接开始时首先调用Config表中的第二个函数读取配置信息，通过InternetCrackUrlA将配置信息中的字符串(默认为dns://<a href="http://www.notepad.com">www.notepad.com</a>&nbsp;)取得C&amp;C地址，并根据字符串前面的协议类型采取不同的连接方式，每个协议对应一个ID，同时也是协议插件的ID，目前取得的样本中使用的DNS协议对应ID为203。（虽然有HTTP和HTTPS，但是ONLINE只会使用HTTP），协议与ID的对应关系如下：</span></p><p style="text-align: center;"><img src="http://p1.qhimg.com/t0175fede55baa52c54.png" title="t016e7384cf9c970421.png" alt="http://p2.qhimg.com/t016e7384cf9c970421.png"/></p><p style="text-align: center;"><img src="http://p3.qhimg.com/t0178aac4d4fddcb983.png" title="t01a95742cedd6adad5.png" alt="http://p0.qhimg.com/t01a95742cedd6adad5.png"/></p><p style="text-align: center;"><img src="http://p8.qhimg.com/t0149e1e4c14f3c83b2.png" title="t01307f7e83f8ca5610.png" alt="http://p3.qhimg.com/t01307f7e83f8ca5610.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">在建立起与C&amp;C服务器的连接之后，可以根据接收到的服务器指令调用指定的插件执行指定的操作，并返回执行结果。首先先接收0x14字节的头部数据，这些数据将用于解压和解密下一步接收的指令数据。</span></p><p style="text-align: center;"><img src="http://p1.qhimg.com/t0119963cb376bcc6b7.png" title="t01ef9b640346df62b7.png" alt="http://p5.qhimg.com/t01ef9b640346df62b7.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">接受的指令结构大致如下：&nbsp;</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:plain;toolbar:false">struct&nbsp;Command
{
DWORD&nbsp;HeaderSize;&nbsp;
WORD&nbsp;OpCode;
WORD&nbsp;PluginID;
DWORD&nbsp;DWORD0;
DWORD&nbsp;DataSize;
DWORD&nbsp;DWORD1;
DWORD&nbsp;DataBuff
...
};</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">Online模块会根据PluginID找到对应的模块，调用其函数列表的第一个函数func_switch()，根据OpCode执行switch中不同的操作，并返回信息给服务器。</span></p><p style="text-align: center;"><img src="http://p1.qhimg.com/t0112c8ccd25279f338.png" title="t01b64427d2c4533e43.png" alt="http://p2.qhimg.com/t01b64427d2c4533e43.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">另外当Online使用内置的URL方式时，会根据指定的参数使用HTTP-GET\HTTPS-GET\ FTP来下载文件：</span></p><p style="text-align: center;"><img src="http://p9.qhimg.com/t01f647ddc2cb90d4d6.png" title="t0189c800472b7fe344.png" alt="http://p5.qhimg.com/t0189c800472b7fe344.png"/></p><p style="text-align: center;"><img src="http://p9.qhimg.com/t0108c24afadfd0c19f.png" title="t016866dd6574837992.png" alt="http://p1.qhimg.com/t016866dd6574837992.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">在请求服务器的时候，也会将受害者的基本信息上传到服务器中，这些信息包括：当前日期和时间、内存状态、CPU信息、可用磁盘空间、系统区域设置、当前进程的PID、操作系统版本、host信息和用户名。</span></p><p style="text-align: center;"><img src="http://p4.qhimg.com/t015a8ed4c79b1cc7ab.png" title="t017d07d55856cc3dc7.png" alt="http://p9.qhimg.com/t017d07d55856cc3dc7.png"/><br/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Online模块还通过调用Plugin模块提供的API维护一个注册表项：</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">HKLM\SOFTWARE\[0-9A-Za-z]{7} 或者 HKCU\SOFTWARE\[0-9A-Za-z]{7}，内容是记录系统时间和尝试连接次数。</span></p><p style="text-align: center;"><img src="http://p9.qhimg.com/t01cd1a817320345bc6.png" title="t01a0d84b0738be9cf9.png" alt="http://p9.qhimg.com/t01a0d84b0738be9cf9.png"/><br/></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Module_Config</span></strong></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Config模块在初始化的过程中，先分别解出数据段保存的一些默认配置信息，然后把这些参数拼接起来，使用Root模块虚表中的DoEncipher函数进行加密，最后保存到一个用硬盘卷标号计算出来的路径里。同时Config模块提供了读取配置文件的接口。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Config模块的虚表共有3个函数</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">ModInit</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">该函数共有三个子功能</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">660000</span></p><p style="text-align: center;"><img src="http://p2.qhimg.com/t01d8adb62739b24b90.png" title="t0183cf546bd0733780.png" alt="http://p1.qhimg.com/t0183cf546bd0733780.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">该功能主要调用Config模块的GetDecodedConfigData函数，获取配置文件作为Payload，最终调用Online模块虚表的0x24功能（上传给CC服务器）</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">660001</span></p><p style="text-align: center;"><img src="http://p0.qhimg.com/t01e57c3ab280647ccf.png" title="t015401d1ea051713e2.png" alt="http://p7.qhimg.com/t015401d1ea051713e2.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">功能主要就是传递了自己的功能ID，没有Payload</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">660002</span></p><p style="text-align: center;"><img src="http://p3.qhimg.com/t017bf0a513adc98f82.png" title="t011d5e52bc87921d91.png" alt="http://p3.qhimg.com/t011d5e52bc87921d91.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">功能主要就是传递了下自己的功能ID，没有Payload</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">GetDecodedConfigData</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">该函数首先通过磁盘卷标号计算得到当前机器的配置文件路径。然后读取配置文件，并调用Root模块的DoDecipher解密后，返回结果给调用者。</span></p><p style="text-align: center;"><img src="http://p4.qhimg.com/t01d35bb359c0f48a82.png" title="t01f2cb3643a4dd3d09.png" alt="http://p1.qhimg.com/t01f2cb3643a4dd3d09.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">GetEncodedVolumeSN</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">该函数首先获取系统盘的磁盘卷标号，根据压入的szKey计算出一个结果，然后调用Root模块的Base64Encode1Byte来加密得到加密串。</span></p><p style="text-align: center;"><img src="http://p3.qhimg.com/t01830051425a6a3b5b.png" title="t01c1b7e943bedcbf79.png" alt="http://p4.qhimg.com/t01c1b7e943bedcbf79.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">默认配置信息主要为以下信息</span></p><p style="text-align: center;"><img src="http://p6.qhimg.com/t013b5cd6cbe7cbb769.png" title="t01a16f20dd98e3c53b.png" alt="http://p2.qhimg.com/t01a16f20dd98e3c53b.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">接着写入配置文件，分别通过磁盘卷标号，以及不同的key，得出四组不同的加密串</span></p><p style="text-align: center;"><img src="http://p8.qhimg.com/t0114e10452576421e8.png" title="t01efbd3120306fe026.png" alt="http://p1.qhimg.com/t01efbd3120306fe026.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">然后和依次系统路径”%ALLUSERSPROFILE%\\”拼接得到最终配置文件的路径（例如C:\ProgramData\YICIO\PMIEYKOS\IYM\XIEUWSOY），最后将加密后的配置文件直接写入到该路径下。</span></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Module_Install</span></strong></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Install模块主要用于检测进程环境、控制进程退出和进入后门流程。Install模块被ROOT模块调用其函数表的第二个函数开始执行，首先调整进程权限，然后调用Config模块函数表的第二个函数读取配置信息。</span></p><p style="text-align: center;"><img src="http://p8.qhimg.com/t01e68be9112fc513f9.png" title="t015bed07d6931f6bcd.png" alt="http://p2.qhimg.com/t015bed07d6931f6bcd.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">接着通过判断ROOT模块从上层获取的参数进行不同的流程：</span></p><p style="text-align: center;"><img src="http://p1.qhimg.com/t0194f846355a879a3b.png" title="t0179176e47bed653fd.png" alt="http://p6.qhimg.com/t0179176e47bed653fd.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">当参数为2\3\4时，创建互斥体 “Global\[16-48个随机字符]”，并直接调用Online模块函数表偏移为0x04的函数，即开始循环连接C&amp;C服务器。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">当参数为5\6时，尝试加载ID为106（这个模块不在默认内置的模块列表中，需要进一步下载）。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">如果都不是以上情况，则尝试以系统权限启动winlogon.exe或者启动scvhost.exe，然后注入自身代码，然后启动Online模块。</span></p><p style="text-align: center;"><img src="http://p4.qhimg.com/t01ef1bb53e46e78933.png" title="t011a4bdc7e001b883b.png" alt="http://p5.qhimg.com/t011a4bdc7e001b883b.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">同时Install模块还会提供检测当前运行环境的接口：是否在调试、是否被进程监控、流量监控等，下面是一些特征字符串和相关代码：</span></p><p style="text-align: center;"><img src="http://p4.qhimg.com/t0187869c4fec62384a.png" title="t018d7697050b9975e3.png" alt="http://p0.qhimg.com/t018d7697050b9975e3.png"/></p><p style="text-align: center;"><img src="http://p9.qhimg.com/t0191bfca83de817e9e.png" title="t015b4324f41f839a17.png" alt="http://p1.qhimg.com/t015b4324f41f839a17.png"/></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Module_DNS</span></strong></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">该模块的主要功能是使用DNS协议处理CC通信过程。模块的函数表如下，对</span></p><p style="text-align: center;"><img src="http://p8.qhimg.com/t01f7e4092b4b06239b.png" title="t01941a23c32286f432.png" alt="http://p8.qhimg.com/t01941a23c32286f432.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">应的函数功能分别为：</span></p><p style="text-align: center;"><img src="http://p5.qhimg.com/t015302b1d2eb441040.png" title="t018b1c64630176ee78.png" alt="http://p7.qhimg.com/t018b1c64630176ee78.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">模块的工作流程为：</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">在模块入口函数100编号对应的初始化过程中，模块会开启线程，等待其他插件数据到来，当收到数据时，调用dispatch将数据通过DNS发送到CC服务器。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">其他插件调用该插件的第二个函数(也就是ThreadRecv函数)时，模块开启线程从CC接收数据，并将解码后的数据写到共享内存。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">其他插件调用该插件的第三个函数(也就是RecvDataProc函数)可以取得该模块与CC服务器通信后的数据内容</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">其他插件调用该插件的第四个函数(也就是SendDataProc 函数)可以使用该模块向CC服务器发送数据内容。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">在初始化函数中，创建一个线程，在线程内部通过互斥量等待，当互斥量被触发后，调用该模块的dispatch函数。</span></p><p style="text-indent: 0em; text-align: center;"><img src="http://p8.qhimg.com/t0137124ba21faa5d4d.png" title="t011ac12a2e77861290.png" alt="http://p2.qhimg.com/t011ac12a2e77861290.png"/></p><p style="text-align: center;"><img src="http://p9.qhimg.com/t01e4bc52b833f76835.png" title="t01182d8454528e5190.png" alt="http://p8.qhimg.com/t01182d8454528e5190.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">从CC接收数据的代码过程</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">在通信过程中，开启线程接收数据</span></p><p style="text-align: center;"><img src="http://p7.qhimg.com/t01ebc32839ec34f528.png" title="t01a36adb0dae84fd02.png" alt="http://p4.qhimg.com/t01a36adb0dae84fd02.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">线程函数将接收到数据存储在结构体的0x60偏移处</span></p><p style="text-align: center;"><img src="http://p0.qhimg.com/t01f122fe269e85be8a.png" title="t0149d1e8ddf2774b1c.png" alt="http://p5.qhimg.com/t0149d1e8ddf2774b1c.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">接收到的数据首先判断接收到的数据长度是否符合要求，然后使用解码函数(DecodeCCData1)进行解码并判断解码后的内容格式是否符合。此后，使用同样的解码算法(DecodeCCData1)再对数据进行一次解码。</span></p><p style="text-align: center;"><img src="http://p3.qhimg.com/t01460b9c0ec5f3b9c0.png" title="t016ad91b5171527e8e.png" alt="http://p4.qhimg.com/t016ad91b5171527e8e.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">将上面解码后的内容使用另一个解码算法(DecodeCCData2)进行解码，解出来的内容的第一个DWORD为解密KEY，使用解密KEY将接收到的数据进行解密后，判断解密后的内容的第一个WORD为数据包类型id，数据包类型ID包括:0，1，3三种。每种不同的数据包使用不同的结构类型和不同的解密算法。</span></p><p style="text-align: center;"><img src="http://p8.qhimg.com/t010d5179ed6c3633c8.png" title="t01e89cabb1bb2018e8.png" alt="http://p3.qhimg.com/t01e89cabb1bb2018e8.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">在对不同的数据类型的处理过程中，都会将解码后的内容写入到结构体偏移+0x5C的地址中，该地址就是数据传输时使用的共享内存地址。</span></p><p style="text-align: center;"><img src="http://p7.qhimg.com/t01a03ee1598ab1144f.png" title="t010e6587959e23c9b7.png" alt="http://p7.qhimg.com/t010e6587959e23c9b7.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">数据包的解密算法代码片段为：</span></p><p style="text-align: center;"><img src="http://p5.qhimg.com/t01396175248b6fc6fe.png" title="t01c336440e890067c4.png" alt="http://p1.qhimg.com/t01c336440e890067c4.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">向CC发送数据的代码片段</span></p><p style="text-align: center;"><img src="http://p9.qhimg.com/t01aa58596c4aa5f2ff.png" title="t01fdd5db081ea613a4.png" alt="http://p1.qhimg.com/t01fdd5db081ea613a4.png"/></p><p><br/></p><p style="text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">代码分析对抗</span></strong></span></p><hr/><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">样本使用到的技术很多，例如动态加载、花指令、反调试、多层解密、代码注入等，使用的这些技巧大大增加了安全人员分析工作所需要花费的时间，也能有效躲避杀软检测，并使一些分析工具产生异常而无法正常执行恶意代码流程。下面举例说明一下使用到的技巧：</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">代码中加入了大量的JMP类型花指令，还有一些无效的计算，比如下图中红框中ECX。&nbsp;</span></p><p style="text-align: center;"><img src="http://p0.qhimg.com/t018c49a1e0db52ed31.png" title="t01a2a662e9c82f8c1b.png" alt="http://p7.qhimg.com/t01a2a662e9c82f8c1b.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">在每次获取API地址之后，都会检测API代码第一字节是否等于0xcc，如果等于则结束后续行为，否则继续。</span></p><p style="text-align: center;"><img src="http://p4.qhimg.com/t01ddb1cc71cd0c6739.png" title="t01b5d44a02e9d07479.png" alt="http://p2.qhimg.com/t01b5d44a02e9d07479.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Shellcode通过自身的配置信息，通过一个for循环，循环4次。每次根据EDI定位配置信息，通过下面的结构体来获取要拷贝的数据的大小，将所有需要的数据拷贝到申请的内存中。然后解密数据。</span></p><p style="text-align: center;"><img src="http://p1.qhimg.com/t011f19275bc14883bd.png" title="t01c7f3ab9688fa9e4f.png" alt="http://p7.qhimg.com/t01c7f3ab9688fa9e4f.png"/></p><p style="text-indent: 0em; text-align: center;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">循环拷贝数据</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></p><p style="text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">关联分析及溯源</span></strong></span></p><hr/><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">8月的域名为 nylalobghyhirgh.com，360威胁情报中心显示此域名为隐私保护状态：</span></p><p style="text-align: center;"><img src="http://p1.qhimg.com/t0138655f36b71ecfb5.png" title="t0175b5f04b6ea2f48a.png" alt="http://p4.qhimg.com/t0175b5f04b6ea2f48a.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">此域名目前在7月23日被注册，8月3日达到解析量的顶峰，360网络研究院的数据显示解析量巨大，达到800万。</span></p><p style="text-align: center;"><img src="http://p3.qhimg.com/t01cebd68bc2aa2e792.png" title="t0111a5f316411b7275.png" alt="http://p0.qhimg.com/t0111a5f316411b7275.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">所有的请求类型为NS记录，也就是说域名极有可能被用来析出数据而不是用于C&amp;C控制，这与前面的分析结论一致。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">而notped.com作为已知的相关恶意域名，我们发现其注册人为Yacboski Curtis，据此关联点找到了一些其他的关联域名，具体见附件的IOC节，由于这些域名并没有找到对应的连接样本，目前只是怀疑，不能确定就是其他的相关恶意域名。</span></p><p style="text-align: center;"><img src="http://p0.qhimg.com/t01a099a89533585243.png" title="t01065667d2bd27afa5.png" alt="http://p9.qhimg.com/t01065667d2bd27afa5.png"/></p><p><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></p><p style="text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">参考链接</span></strong></span></p><hr/><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;"><a href="https://www.netsarang.com/news/security_exploit_in_july_18_2017_build.html">https://www.netsarang.com/news/security_exploit_in_july_18_2017_build.html</a>&nbsp;</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><a href="https://securelist.com/shadowpad-in-corporate-networks/81432/">https://securelist.com/shadowpad-in-corporate-networks/81432/</a>&nbsp;</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><a href="https://cdn.securelist.com/files/2017/08/ShadowPad_technical_description_PDF.pdf">https://cdn.securelist.com/files/2017/08/ShadowPad_technical_description_PDF.pdf</a>&nbsp;</span></p><p><br/></p><p style="text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">附件</span></strong></span></p><hr/><p style="text-indent: 2em;"><span style="color: rgb(0, 112, 192); font-size: 18px;"><strong><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">IOC列表</span></strong></span></p><p style="text-align: center;"><img src="http://p6.qhimg.com/t01f40a2cc3c242e266.png" title="t01a439c264db9e1990.png" alt="http://p3.qhimg.com/t01a439c264db9e1990.png"/></p><p style="text-align: center;"><img src="http://p3.qhimg.com/t01aab34d1aa8a39646.png" title="t01e3ff6a63d1f6ca0a.png" alt="http://p6.qhimg.com/t01e3ff6a63d1f6ca0a.png"/></p><p style="text-indent: 2em;"><strong style="color: rgb(0, 112, 192); font-size: 18px; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">DNS 隧道编解码算法</span></strong><br/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">Xshell后门代码通过DNS子域名的方式向C&amp;C服务器输出收集到的主机信息，以下是分析得到的编码算法及实现的对应解码程序。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">编码算法是先经过下图的算法1加密成二进制的形式如图：</span></p><p style="text-align: center;"><img src="http://p3.qhimg.com/t01b7fb9734bf5c1f60.png" title="t01c2454eb72ec92f0f.png" alt="http://p5.qhimg.com/t01c2454eb72ec92f0f.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">算法1加密后的数据：</span></p><p style="text-align: center;"><img src="http://p6.qhimg.com/t01dbcf3a31fa00ab34.png" title="t0133c3e8ab8862fa8a.png" alt="http://p7.qhimg.com/t0133c3e8ab8862fa8a.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">然后把结果转换成可见的字符转换方法是通过每个字节的高位减‘j’低位减‘a’，把1个字节拆分成2个字节的可见字符，这样就浪费了一个字节：</span></p><p style="text-align: center;"><img src="http://p6.qhimg.com/t015bac90b11aa21e0b.png" title="t0192c199959b248f3d.png" alt="http://p1.qhimg.com/t0192c199959b248f3d.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">解密算法是加密算法的逆运算，解密算法流程入下图：</span></p><p style="text-align: center;"><img src="http://p7.qhimg.com/t01cff5d2ca6ee0ce5a.png" title="t010e904d067e764b1e.png" alt="http://p3.qhimg.com/t010e904d067e764b1e.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">根据网上的一些公开的流量数据，</span></p><p style="text-align: center;"><img src="http://p0.qhimg.com/t016cd8376d1cc75fa3.png" title="t016b9b9444a78613cc.png" alt="http://p8.qhimg.com/t016b9b9444a78613cc.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">解密出的一些上传的数据：</span></p><p style="text-align: center;"><img src="http://p3.qhimg.com/t010e56ef6454041845.png" title="t01ca41c497f1f8f328.png" alt="http://p5.qhimg.com/t01ca41c497f1f8f328.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">实现的解码代码如下：</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:plain;toolbar:false">int&nbsp;sub_1C3E(int&nbsp;a1,&nbsp;unsigned&nbsp;char*&nbsp;a2,&nbsp;int&nbsp;a3,&nbsp;int&nbsp;a4)
{
char&nbsp;v4;&nbsp;//&nbsp;cl@1
int&nbsp;v5;&nbsp;//&nbsp;esi@1
unsigned&nbsp;char*&nbsp;v6;&nbsp;//&nbsp;edi@2
byte&nbsp;v7[1024]=&nbsp;{0};&nbsp;//&nbsp;eax@11
char&nbsp;v8;&nbsp;//&nbsp;dl@11
int&nbsp;v10;&nbsp;//&nbsp;[sp+4h]&nbsp;[bp-10h]@1
int&nbsp;v11;&nbsp;//&nbsp;[sp+8h]&nbsp;[bp-Ch]@1
int&nbsp;v12;&nbsp;//&nbsp;[sp+Ch]&nbsp;[bp-8h]@1
int&nbsp;v13;&nbsp;//&nbsp;[sp+10h]&nbsp;[bp-4h]@1
v4&nbsp;=&nbsp;0;
v5&nbsp;=&nbsp;0;
v10&nbsp;=&nbsp;a1;
v11&nbsp;=&nbsp;a1;
v12&nbsp;=&nbsp;a1;
v13&nbsp;=&nbsp;a1;
int&nbsp;i&nbsp;=&nbsp;0;
if&nbsp;(&nbsp;a3&nbsp;&gt;&nbsp;0&nbsp;)
{
v6&nbsp;=&nbsp;a2&nbsp;-&nbsp;a4;
do
{
if&nbsp;(&nbsp;v5&nbsp;&amp;&nbsp;3&nbsp;)
{
switch&nbsp;(&nbsp;v5&nbsp;&amp;&nbsp;3&nbsp;)
{
case&nbsp;1:
v11&nbsp;=&nbsp;0xBFD7681A&nbsp;-&nbsp;0x7DB1F70F&nbsp;*&nbsp;v11;
v4&nbsp;=&nbsp;(*((byte&nbsp;*)&amp;v11&nbsp;&nbsp;+&nbsp;2)&nbsp;^&nbsp;(*((byte&nbsp;*)&amp;v11&nbsp;+&nbsp;1)
+&nbsp;(*((byte&nbsp;*)&amp;v11)&nbsp;^&nbsp;v4)))
-&nbsp;*((byte&nbsp;*)&amp;v11&nbsp;+&nbsp;3);
//v7&nbsp;=&nbsp;(byte&nbsp;*)(v5&nbsp;+&nbsp;a4);
v8&nbsp;=&nbsp;v4&nbsp;^&nbsp;*(byte&nbsp;*)(v6&nbsp;+&nbsp;v5++&nbsp;+&nbsp;a4);
v7[i]&nbsp;=&nbsp;v8;
i++;
break;
case&nbsp;2:
v12&nbsp;=&nbsp;0xE03A30FA&nbsp;-&nbsp;0x3035D0D6&nbsp;*&nbsp;v12;
v4&nbsp;=&nbsp;(*((byte&nbsp;*)&amp;v12&nbsp;&nbsp;+&nbsp;2)&nbsp;^&nbsp;(*((byte&nbsp;*)&amp;v12&nbsp;+&nbsp;1)
+&nbsp;(*((byte&nbsp;*)&amp;v12)&nbsp;^&nbsp;v4)))
-&nbsp;*((byte&nbsp;*)&amp;v12&nbsp;+&nbsp;3);
//v7&nbsp;=&nbsp;(byte&nbsp;*)(v5&nbsp;+&nbsp;a4);
v8&nbsp;=&nbsp;v4&nbsp;^&nbsp;*(byte&nbsp;*)(v6&nbsp;+&nbsp;v5++&nbsp;+&nbsp;a4);
v7[i]&nbsp;=&nbsp;v8;
i++;
break;
case&nbsp;3:
v13&nbsp;=&nbsp;0xB1BF5581&nbsp;-&nbsp;0x11C208F&nbsp;*&nbsp;v13;
v4&nbsp;=&nbsp;(*((byte&nbsp;*)&amp;v13&nbsp;&nbsp;+&nbsp;2)&nbsp;^&nbsp;(*((byte&nbsp;*)&amp;v13&nbsp;+&nbsp;1)
+&nbsp;(*((byte&nbsp;*)&amp;v13)&nbsp;^&nbsp;v4)))
-&nbsp;*((byte&nbsp;*)&amp;v13&nbsp;+&nbsp;3);
//v7&nbsp;=&nbsp;(byte&nbsp;*)(v5&nbsp;+&nbsp;a4);
v8&nbsp;=&nbsp;v4&nbsp;^&nbsp;*(byte&nbsp;*)(v6&nbsp;+&nbsp;v5++&nbsp;+&nbsp;a4);
v7[i]&nbsp;=&nbsp;v8;
i++;
break;
}
}
else
{
v10&nbsp;=&nbsp;0x9F248E8A&nbsp;-&nbsp;0x2F8FCE7E&nbsp;*&nbsp;v10;
v4&nbsp;=&nbsp;(*((byte&nbsp;*)&amp;v10&nbsp;+&nbsp;2)&nbsp;^&nbsp;(*((byte&nbsp;*)&amp;v10&nbsp;+&nbsp;1)
+&nbsp;(*((byte&nbsp;*)&amp;v10&nbsp;)&nbsp;^&nbsp;v4)))
-&nbsp;*((byte&nbsp;*)&amp;v10&nbsp;+&nbsp;3);
//v7&nbsp;=&nbsp;(byte&nbsp;*)(v5&nbsp;+&nbsp;a4);
v8&nbsp;=&nbsp;v4&nbsp;^&nbsp;*(byte&nbsp;*)(v6&nbsp;+&nbsp;v5++&nbsp;+&nbsp;a4);
v7[i]&nbsp;=&nbsp;v8;
i++;
}
}
while&nbsp;(&nbsp;v5&nbsp;&lt;&nbsp;a3&nbsp;);
printf(&quot;Last&nbsp;Step&nbsp;Decode：%s&quot;,&nbsp;(char*)v7);
}
return&nbsp;0;
}
int&nbsp;_tmain(int&nbsp;argc,&nbsp;_TCHAR*&nbsp;argv[])
{
unsigned&nbsp;char&nbsp;szText[117]&nbsp;=&nbsp;&quot;ajajlyoogrmkdmnndtgphpojmwlvajdkbtephtetcqopnkkthlplovbvardopqfleonrgqntmresctokkxcnfvexhjpnpwepgnjubrbrbsenhxbkmy&quot;;
unsigned&nbsp;char&nbsp;szXXX[58]&nbsp;=&nbsp;{0};
for&nbsp;(int&nbsp;i=0;&nbsp;i&lt;57;&nbsp;i++)
{
unsigned&nbsp;char&nbsp;One&nbsp;=&nbsp;szText[2*i]&nbsp;-&nbsp;&#39;a&#39;;
unsigned&nbsp;char&nbsp;Two&nbsp;=&nbsp;szText[2*i+1]&nbsp;-&#39;j&#39;;
printf(&quot;%d,&nbsp;%d\r\n&quot;,&nbsp;One,&nbsp;Two);
unsigned&nbsp;char&nbsp;Total&nbsp;=&nbsp;One+Two*16;
szXXX[i]&nbsp;=&nbsp;Total;
}
printf(&quot;First&nbsp;Step&nbsp;Decode：%s&quot;,&nbsp;(char*)szXXX);&nbsp;
sub_1C3E(0,&nbsp;szXXX,&nbsp;56,&nbsp;0);&nbsp;//算法1
return&nbsp;0;
}</pre><p style="text-indent: 2em;"><span style="color: rgb(0, 112, 192); font-size: 18px;"><strong><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">ShellCode的处理</span></strong></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">本次后门多次解出ShellCode的过程都是用的同一套模版代码。经过分析发现PE的一些基本信息还是保留了的，ShellCode解码用到的结构整理如下：</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:plain;toolbar:false">struct&nbsp;ShellContext
{
u32&nbsp;dwShellKey;//用于解密重定位表以及输入表的数据
u32&nbsp;HeadCheck;//和dwShellKey异或用来校验Key是否合法
u32&nbsp;SizeOfImage;//Image大小
u32&nbsp;ModBase;//默认基地址
u32&nbsp;RelocTable;//重定位表偏移
u32&nbsp;RelocSize;//重定位表大小
u32&nbsp;ImportTable;//输入表偏移
u32&nbsp;ImportSize;//输入表大小
u32&nbsp;OEP;//OEP地址
u16&nbsp;Magic;//010b为pe32
u8MajorVer;//链接器版本
u8&nbsp;&nbsp;MinorVer;//
u32&nbsp;NumberOfSections;//节表数
u32&nbsp;timeStamp;//时间戳
SectionDescsecArray[1];&nbsp;//节表描述数组
};</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">下面介绍下ShellCode的加载过程，在调用Loader之前先将ShellCode起始地址以及大小入栈。</span></p><p style="text-align: center;"><img src="http://p6.qhimg.com/t01b74ee38944780526.png" title="t01b9c3fa81e820e838.png" alt="http://p8.qhimg.com/t01b9c3fa81e820e838.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">然后进入Loader部分处理流程：</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">1）从PEB里找到Kernel模块，从中找到LoadLibrary，GetProcAddress，VirtualAlloc以及Sleep，以备后续过程使用。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">2）接着利用ShellCode中的SizeOfImage去分配内存。</span></p><p style="text-align: center;"><img src="http://p8.qhimg.com/t01a843466fbef70aef.png" title="t01800193bde9ed37c7.png" alt="http://p4.qhimg.com/t01800193bde9ed37c7.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">3）往分配的内存头部填充垃圾数据，一直填充到代码段开始。</span></p><p style="text-align: center;"><img src="http://p4.qhimg.com/t019a67f6aef5f9a455.png" title="t01bf59e4690d6a7a12.png" alt="http://p4.qhimg.com/t01bf59e4690d6a7a12.png"/><br/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">4）根据结构里保存的节表信息，依次填充到分配的内存。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">5）如果结构里重定位信息不为空，则使用dwShellKey去解密重定位数据并利用重定位数据去修正内存的数据。处理完之后把重定位数据清零。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">解密重定位数据的算法还原如下</span></p><p style="text-align: center;"><img src="http://p0.qhimg.com/t0114f6adde9b71e19e.png" title="t01eb8cbe9a599448a7.png" alt="http://p7.qhimg.com/t01eb8cbe9a599448a7.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">6）如果输入表信息不为空，接着使用重定位处理用的dwShellKey去解密输入表对应的字符串信息，如果是ordinal方式的则不做处理。使用解密了的DLL名以及API名获取到API地址后，并不直接填充，而是先把地址做求补操作后，生成一个小的stub再填进去。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">最后再把输入表用到的数据清零。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">解密输入表的流程还原如下：</span></p><p style="text-align: center;"><img src="http://p3.qhimg.com/t01ec8572d9bb8247bb.png" title="t0168ab19f18b1371e7.png" alt="http://p5.qhimg.com/t0168ab19f18b1371e7.png"/></p><p style="text-align: center;"><img src="http://p3.qhimg.com/t01f72c4212438bbfd1.png" title="t0102bebd241510cb39.png" alt="http://p6.qhimg.com/t0102bebd241510cb39.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">7）跳到入口处执行，并设置fdwReason为1。</span></p><p style="text-align: center; text-indent: 0em;"><img src="http://p9.qhimg.com/t017818b7d847c85f7d.png" title="t01dfbc49c36079a4d3.png" alt="http://p1.qhimg.com/t01dfbc49c36079a4d3.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">根据保留的结构可以大致还原出本来模块文件。</span></p><p style="text-align: center;"><img src="http://p9.qhimg.com/t01666f27913153203d.png" title="t011a4dc18cb1b4d028.png" alt="http://p9.qhimg.com/t011a4dc18cb1b4d028.png"/></p><p style="text-align: center;"><img src="http://p2.qhimg.com/t0180a7c63e9c6ab532.png" title="t016bbac770494f36dc.png" alt="http://p0.qhimg.com/t016bbac770494f36dc.png"/></p></p>
                <hr/>
                <p style="text-align: center;">
                    <img src="http://bobao.360.cn/img/app.jpeg"/>
                    <img src="http://bobao.360.cn/img/weixin.jpeg"/>
                </p>
                                <p>本文由 安全客 原创发布，如需转载请注明来源及本文地址。<br/>本文地址：http://bobao.360.cn/learning/detail/4278.html
                </p>
                            </div>
            <div style="margin-top: 20px;background-color:#FFFFFF">
    <input type="hidden" id="detail_title" name="detail_title" value="【权威发布】360天眼实验室：Xshell被植入后门代码事件分析报告（完整版） - 安全客 - 有思想的安全新媒体" />
    <input type="hidden" id="use_nickname" name="use_nickname" value="0" />
    <a name="mao"></a>
    <div class="reg-log mobile-hiden">
        <div class="" id="userTo">   
            <div id="to-list" class="input-text" style="">
                <textarea disabled="disabled" class="hide"  id="comment-content" to="to"></textarea>
                <ul id="preadded" style="display:none">       
                </ul>
                <div id="to-auto" style="width: 200px">
                    <ul id="feed">
                    </ul>
                </div>
            </div>
        </div>
        <input type="hidden" id="source-id" value="4278" />
        <input type="hidden" id="source-type" value="learning" />
        <input type="hidden" id="post-comment-url" value="/comment/add" />
        <input type="hidden" id="post-nickname-url-ajax" value="/comment/randnicknameajax" />
        <input type="hidden" id="post-check-login-url-ajax" value="/comment/checklogin" />
        <input type="hidden" id="stoken_comment_set" value="ea3898fb4df38673fdeb61c458234054">                 <span class="join">参与讨论，请先 <a href="javascript:;" class="comment-login">登录</a> | <a href="javascript:;" class="comment-reg">注册</a> |  <a href="javascript:;" class="anonymous-comment">匿名评论</a></span>
            </div>
    <div class="mobile-hide" style="width: 870px; margin: 0 auto;">
        <label style="vertical-align:middle;" for="use_nickname">匿名</label> 
        <input style="vertical-align:middle;" id="trigger-nickname" name="use_nickname" class="use_nickname" type="checkbox" value="0" />

        <a href="javascript:;" class="apply-use button" id="submit-comment" data-target="/comment/add">发布</a>
    </div>


    <div class="clearfix"></div>
    <div class="comments">
        <div class="comments-head">
            <span class="title">用户评论</span>
        </div>
                <div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src='http://p1.qhmsg.com/dm/48_48_100/t01832c8d63d8593049.jpg'/>              
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="345744683" class="response" data-bind-id="345744683" data-target="16186" user-name="360U345744683" href="javascript:;">
                360U345744683            </a>
                        <span class="comment-time">2017-08-19 10:12:06</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="345744683" data-target="16186">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_16186" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">nice ,还是360厉害</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/10x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="16183" user-name="杨教授" href="javascript:;">
                杨教授            </a>
                        <span class="comment-time">2017-08-19 09:01:38</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="16183">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_16183" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">高清.完整版</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
<div class="clearfix re-comment">
    <div class="comment-quote">  
        <div class="comment-user">
            <a href="javascript:;" class="response" data-bind-id="0" data-target="16181">Niannnnnnnnnnn</a> <span class="comment-time">2017-08-18 21:42:01</span>            <div class="comment-action">                        <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="16181">回复</a></span>&nbsp;|&nbsp;                        <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_16181" data-type="comment">点赞</a></span>            </div>
            <p>真.完整版</p>
        </div>
    </div>
        </div>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/11x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="16181" user-name="Niannnnnnnnnnn" href="javascript:;">
                Niannnnnnnnnnn            </a>
                        <span class="comment-time">2017-08-18 21:42:01</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="16181">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_16181" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">真.完整版</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/1x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="16180" user-name="77ca1k1k1" href="javascript:;">
                77ca1k1k1            </a>
                        <span class="comment-time">2017-08-18 21:42:01</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="16180">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_16180" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">来自天眼实验室的超长完整版</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/4x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="16179" user-name="劉海粟Transylvania" href="javascript:;">
                劉海粟Transylvania            </a>
                        <span class="comment-time">2017-08-18 21:42:01</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="16179">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_16179" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">//@Niannnnnnnnnnn:真.完整版</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/10x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="16178" user-name="houjingyi1996" href="javascript:;">
                houjingyi1996            </a>
                        <span class="comment-time">2017-08-18 21:42:01</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="16178">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_16178" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">失败的一周</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>

        <a class="more-long comment-more" href="javascript:;" data-target="/comment/more" data-type="learning" data-source-id="4278" data-page="2">查看更多</a>
            </div>
</div>
<script>
    $(function () {
        $('.anonymous-comment').click(function () {
            $(".join").hide();
            $(".reg-log textarea").first().removeAttr("disabled").show();
            $('#use_nickname').val('1');
//            $('#trigger-nickname').attr('checked', true);
            $('#trigger-nickname').trigger('click');
        });
        //为所有复选框绑定事件
//        checkbox_on_click();
        //ajax随机获取昵称
//        randnicknameajax(0);
        //ajax检测登录状态
        comment_check_login();
    });



    function input_checkbox(flag) {
        $('input:checkbox').each(function () {
            var value = flag ? 1 : 0;
            $(this).prop('checked', flag);
            $(this).val(value);
        });
    }

//ajax随机获取昵称
    function randnicknameajax(flag) {
        $.ajax({
            type: 'POST',
            url: $('#post-nickname-url-ajax').val(),
            data: {limit: 1, flag: flag},
            dataType: "json",
            success: function (data) {
                $('#nick-name').val(data.data[0]);
                _nick_name=data.data[0];
            }
        });
    }
    $();
//ajax检测登录状态
    function comment_check_login() {
        $.ajax({
            type: 'POST',
            url: $('#post-check-login-url-ajax').val(),
            data: {},
            dataType: "json",
            success: function (data) {
                if (data.success) {
                    $('.join').hide();
                    $(".reg-log textarea").first().removeAttr("disabled").show();
                    $("#span_use_nickname").show();
                    $('#use_nickname').val('0');
                    $('#use_nickname').attr('checked', false);
                }
            }
        });
    }
</script>        </div>
    </div>
    <div class="side-bar">
        <div class="mod hot-news">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-hot"></i><span>热门知识</span></h2>
    </div>
    <ul class="links-list">
                                <li><a href="/learning/detail/4411.html" alt="【漏洞预警】一个换行符引发的奥斯卡0day漏洞(CVE-2017-8759)重现——最新的Office高级威胁攻击预警" target="_blank">【漏洞预警】一个换行符引发的奥斯卡...</a></li>
                                <li><a href="/learning/detail/4416.html" alt="【漏洞预警】Microsoft .NET Framework漏洞（CVE–2017–8759）预警" target="_blank">【漏洞预警】Microsoft .NE...</a></li>
                                <li><a href="/learning/detail/4414.html" alt="【技术分享】妙用JavaScript绕过XSS过滤" target="_blank">【技术分享】妙用JavaScrip...</a></li>
                                <li><a href="/learning/detail/4418.html" alt="【技术分享】利用威胁情报数据平台拓展APT攻击线索一例" target="_blank">【技术分享】利用威胁情报数据平台拓...</a></li>
                                <li><a href="/learning/detail/4417.html" alt="【知识】9月15日 - 每日安全知识热点" target="_blank">【知识】9月15日 - 每日安全知识热...</a></li>
                                <li><a href="/learning/detail/4425.html" alt="【安全报告】XShellGhost事件技术回顾报告" target="_blank">【安全报告】XShellGhost事件...</a></li>
            </ul>
</div>        <!-- 友情链接 -->
        <div class="mod blog-links mobile-hide">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-link"></i><span>友情链接</span></h2>
        <a href="/links/index.html" class="more">更多<i></i></a>
    </div>
        <ul class="links-list">
                <li><a href="http://bbs.360safe.com" alt="360安全社区" target="_blank">360安全社区</a></li>
                <li><a href="http://zhuji.360.cn" alt="360主机卫士" target="_blank">360主机卫士</a></li>
                <li><a href="http://blogs.360.cn/" alt="奇虎360技术博客" target="_blank">奇虎360技术博客</a></li>
                <li><a href="http://wangzhan.360.cn/" alt="360网站卫士" target="_blank">360网站卫士</a></li>
                <li><a href="http://webscan.360.cn/" alt="360网站安全检测" target="_blank">360网站安全检测</a></li>
                <li><a href="http://research.360.cn/report/" alt="360研究报告" target="_blank">360研究报告</a></li>
                <li><a href="http://unicorn.360.cn/" alt="360 Unicorn Team" target="_blank">360 Unicorn Team</a></li>
                <li><a href="http://appscan.360.cn/" alt="360捉虫猎手" target="_blank">360捉虫猎手</a></li>
                <li><a href="https://threathunter.org/" alt="ThreatHunter社区" target="_blank">ThreatHunter社区</a></li>
                <li><a href="http://security.360.cn/" alt="360安全应急响应中心" target="_blank">360安全应急响应中心</a></li>
            </ul>
    </div>
        <!-- 联系我们 -->
        <div class="mod contact mobile-hide" style="text-align:center">
    <div class="head-bar clearfix">
        <h2><i></i><span>关注我们</span></h2>
    </div>
    <!-- 微信关注 -->
    <ul class="contact-way">
        <li><a>微信关注</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/qrcode_adlab_weixin.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
    <!-- APP下载 -->
    <ul class="contact-way">
        <li><a>安全播报APP</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/scan_code_big.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
</div>

    </div>
</div>

<script type="text/javascript" src="/js/jquery-ui.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/jquery.noty.packaged.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/common.js?v=4.5"></script>
<script>$(function() {sync_count('comment');});</script>


<!-- 语法高亮 -->
<script type="text/javascript" src="/ue/SyntaxHighlighter/shCore.js"></script>
<script type="text/javascript">SyntaxHighlighter.all();sync_count('vul');sync_count('news');sync_count('learning');sync_count('activity');sync_count('course');sync_count('ctf');</script>
    </div>

        <div class="footer">
        <div class="friend-link">
            <a href="http://www.360.cn/" target="_blank">360首页</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">关于我们</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">联系我们</a>
            <span>|</span>
            <a href="/links/index.html" target="_blank">友情链接</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">招贤纳士</a>
        </div>
        <div class="copy">
            Copyright &copy; 360网络攻防实验室 All Rights Reserved <span class="copy_icp">京ICP证080047号[京ICP备08010314号-6]</span>
        </div>
    </div>
    
</div>

<!--奇舞团统计-->

<script src='https://s.ssl.qhimg.com/static/f5407c785655e6a1/monitor_analytic.js'></script>
<script>
    monitor.setProject('QH_171_1').getTrack().getClickAndKeydown().getClickHeatmap(10, 1);
</script>

<div class="hide">
    <script src="https://s95.cnzz.com/z_stat.php?id=1253147824&web_id=1253147824" language="JavaScript"></script>
</div>
<div class="backToTop_wrap off">
    <a id="back_to_top" class="backToTop" href="javascript:;" title="返回顶部"></a>
</div>
<script>
    var $backToTop_wrap = $(".backToTop_wrap"),
        $backToTop_btn = $("#back_to_top");

    if ($(window).scrollTop() > 100) {
        $backToTop_wrap.removeClass("off");
    }
    else {
        $backToTop_wrap.addClass("off");
    }

    $(window).on("scroll", function () {
        if ($(this).scrollTop() > 100) {
            $backToTop_wrap.removeClass("off");
        }
        else {
            $backToTop_wrap.addClass("off");
        }
    });

    $backToTop_btn.on("click", function () {
        $("html, body").animate({scrollTop: 0}, 120);
    });

    $(function () {
        var navlist = $('.nav-list > li');

        navlist.each(function () {
            $(this).on('mouseenter', function () {
                $(this).addClass('selected');
            });

            $(this).on('mouseleave', function () {
                $(this).removeClass('selected');
            });
        });
    })
</script>



</body>
</html>
