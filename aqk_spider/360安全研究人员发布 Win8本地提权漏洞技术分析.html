<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns:wb="http://open.weibo.com/wb" xml:lang="en" lang="en">
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"/>
    <link rel="shortcut icon" href="http://bobao.360.cn/favicon.ico?v=1.1"/>
    <link rel="alternate" title="安全资讯" href="/rss?type=news" type="application/rss+xml"/>
    <link rel="alternate" title="安全知识" href="/rss?type=learning" type="application/rss+xml"/>
    <link rel="alternate" title="安全圈活动" href="/rss?type=activity" type="application/rss+xml"/>
    <link rel="alternate" title="所有漏洞" href="/rss?type=vul" type="application/rss+xml"/>
    <link rel="alternate" title="通用型漏洞" href="/rss?type=commonvul" type="application/rss+xml"/>
    <link rel="alternate" title="事件型漏洞" href="/rss?type=eventvul" type="application/rss+xml"/>
    <link rel="alternate" title="热门漏洞" href="/rss?type=hotvul" type="application/rss+xml"/>

        <title>360安全研究人员发布：Win8本地提权漏洞技术分析 - 安全客 - 有思想的安全新媒体</title>
    
        <meta name="keywords" content="win8本地提权,NtApphelpCacheControl,提权,漏洞,技术分析"/>
    
        <meta name="description" content="Google Project Zero团队的新晋成员James Forshaw在9月30日向微软提交了名为“Windows: Elevation of Privilege in ahcache.sys/NtApphelpCacheControl”的安全问题，并且在Google的漏洞公开期限（90天）后，也就是2014年12月29日（北京时间的12月30日）公开了此问题的细节。"/>
        <meta property="wb:webmaster" content="224437c7be31d633"/>

    <script type="text/javascript" src="http://s7.qhimg.com/!56caa871/xpc_sync_height.js"></script>
    <link rel="stylesheet" type="text/css" href="/css/reset.css" />
    <link rel="stylesheet" type="text/css" href="/css/common_new.css?v=4.4.2.1" />
    <link rel="stylesheet" type="text/css" href="/css/jquery.notyfy.css" />
    <link rel="stylesheet" type="text/css" href="/css/notyfy.theme.default.css" />
    <link rel="stylesheet" type="text/css" href="/css/s_common.css?v=2.2.7" media="only screen and
    (max-device-width:900px), only screen and (max-width:900px)" />
    <script type="text/javascript" src="/js/jquery.min.js?v=3.1"></script>
    <script type="text/javascript" src="/js/jquery.notyfy.js"></script>
    <script type="text/javascript" src="/js/iscroll.js"></script>
    <script src="http://js.passport.qihucdn.com/5.0.3.js"></script>
    <script type="text/javascript">
        var myScroll, myNavScroll;

        function iscrollLoaded() {
            myScroll = new IScroll('#wrapper',
                {
                    scrollX: true,
                    scrollY: false,
                    bounceEasing: 'circular',
                    eventPassthrough: true,
                    preventDefault: false,
                    bounceTime: 500
                }
            );
        }

        $(function () {

            //导航横向滚动


            function setNavWidth() {

                /* 计算导航宽度 */
                var allWidth = $(window).width();
                var scroller = $('#scroller');

                if (allWidth > 900) {
                    scroller.find('ul').add(scroller.find('.scroll')).removeAttr('style');
                    scroller.css('overflow', 'visible');
                    if (myNavScroll) myNavScroll.destroy();
                } else {

                    var width = 0;
                    scroller.find('.scroll').children('ul').children('li').each(function (index, el) {
                        if (!$(this).hasClass('mobile-hide')) {
                            width += $(this).outerWidth();
                        }
                    });
                    scroller.find('ul').add(scroller.find('.scroll')).width(width);

                    if (myNavScroll) myNavScroll.destroy();

                    myNavScroll = new IScroll('#scroller', {
                        scrollX: true,
                        scrollY: false,
                        momentum: false,
                        click: true
                    });

                }

            }

            setNavWidth();
            $(window).resize(function (event) {
                setNavWidth();
            });

        });

    </script>
</head>
<body onload="iscrollLoaded();">
<div style='margin:0 auto;width:0px;height:0px;overflow:hidden;'>
    <img src=""/>
</div>

<div id="is-mobile"></div>
<div class="container">
        <div class="mobile-header">
        <div class="header clearfix">
            <div class="header-wrapper clearfix">
                <a href="/index/index" class="logo"><img class="slogan" src="/img/logo.png?v=1.5"/></a>
                                <form id="search" class="search-box" action="/search/index" method="GET">
                    <input class="keys" name="keywords" type="text" placeholder="搜索漏洞" required="required">
                    <input class="icon" type="submit" value="">
                    <input type="hidden" name="type" value=""/>
                </form>
                <div class="bug">
                    <div class="name"><span class="seled">全部</span><i class="arrow"></i></div>
                    <ul class="typelist">
                        <li data-index="3"><a href="javascript:void(0);">全部</a></li>
                        <li data-index="0"><a href="javascript:void(0);">漏洞</a></li>
                        <li data-index="1"><a href="javascript:void(0);">资讯</a></li>
                        <li data-index="2"><a href="javascript:void(0);">知识</a></li>
                    </ul>
                </div>
                                <div class="logNreg mobile-hide">
                    <div class="unlog">
                        <i></i>
                        <a href="log.html" class="log">登录</a>
                        <span>|</span>
                        <a href="reg.html" class="reg">注册</a>
                    </div>
                    <div class="loged">
                        <a href="/member/profile" class="user-center"><i></i><span class="user-name-tag">个人中心</span></a>
                        <div class="user-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting"><a href="http://i.360.cn/profile/accountmanage"
                                                               target="_blank"><i></i><span>账号设置</span></a></li>
                                <li class="alert-setting"><a href="/keywords/index"
                                                             target="_blank"><i></i><span>告警设置</span></a></li>
                                <li class="bug-alert"><a href="/myalarm/index" target="_blank"><i></i><span>漏洞告警</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mylearn/index" target="_blank"><i></i><span>我的知识</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mycourse/index" target="_blank"><i></i><span>我的课堂</span></a>
                                </li>
                                <li class="my-exit"><a
                                            href="http://login.360.cn/?src=pcw_adlab&op=logout&destUrl=http://bobao.360.cn"><i></i><span>退出系统</span></a>
                                </li>
                            </ul>
                        </div>

                        <a href="/message" class="message-center" target="_blank"><i></i><span>我的消息</span></a>
                        <div class="message-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting" style="display:none;"><a href="/myres/index"
                                                                                     target="_blank"><i></i><span>回复我的</span></a>
                                </li>
                                <li class="my-bug"><a href="/myvul/index"
                                                      target="_blank"><i></i><span>我的漏洞</span></a></li>
                                <!--<li class="my-bug"><a href="/myres/index" target="_blank"><i></i><span>我的评论</span></a></li>-->
                                <!--<li class="alert-setting"><a href="###" target="_blank"><i></i><span>提到我的</span></a>
                                </li>-->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <style type="text/css">
            .nav {
                overflow: hidden;
            }

            .nav .scroll {
                width: auto;
            }
        </style>
        <div id="wrapper">
            <div id="scroller" class="nav">
                <div class="scroll">
                    <ul class="nav-list">
                        <li ><a class="link-nav"
                                                                                 href="/index/index">首页</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/vul/index">漏洞</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/introduce/list">招聘</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/news/index">资讯</a><!--<i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/introduce/list">招聘</a></li>
                        </ul>
			-->
                        </li>
                        <li class="cur">
                        <a class="link-nav" href="/learning/index">知识</a><i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/course/index">学院</a></li>
                        </ul>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/activity/index">活动</a></li>
                        <li class="mobile-hide "><a class="link-nav"
                                                                                                   href="/ctf/index">CTF训练营</a>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/interref/list">安全内参</a></li>
                        <li ><a class="link-nav" href="/app/index">APP</a></li>

                        <!--<li ><a href="/course/index">学院</a></li>-->
                        <!--<li ><a href="/introduce/list">招聘</a></li>-->
                        <!--<li  class="mobile-hide"><a href="/ctf/index">CTF训练营</a></li>-->
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="mobile-content">
        <link rel="stylesheet" type="text/css" href="/css/news.css?v=3.5" />
<link rel="stylesheet" type="text/css" href="/ue/SyntaxHighlighter/shCoreDefault.css?v=1.0" />
<style>
    p .syntaxhighlighter {
        width: 80%;
    }
</style>

<div class="cur-pos w1000">当前位置：<a href="http://bobao.360.cn/">安全客</a> &gt;&gt; 知识详情</div>

<div class="content clearfix">
    <div class="main">
        <div class="article">
            <div id="article_box">
                <h2>360安全研究人员发布：Win8本地提权漏洞技术分析</h2>
                <div class="article-msg">
                    <span class="time">2015-01-06 23:24:45</span>
                                        <span class="read">阅读：19954次</span>
                    <span><a style="display: none;" class="good" href="javascript:;"
                             data-target="/learning/good" data-value="g_183"
                             data-type="learning">点赞(0)</a></span>
                    <span><a class="fav" href="javascript:;" data-target="/mylearning/add"
                             data-pk="183" data-type="learning">收藏</a></span>
                                        <span><a style="margin-left: 4px;" class="fav" href="http://blogs.360.cn/blog/ntapphelpcachecontrol_vulnerability_anaysis/"
                             target="_blank">来源： 360攻防实验室@Mj0011</a></span>
                    
                                    </div>
                <hr size="1">
                <div class="article-msg">
                    <p><!-- JiaThis Button BEGIN -->

<!--
<span class="jiathis_style"><span class="jiathis_txt">分享到：</span>
	<a class="jiathis_button_weixin"></a>
	<a class="jiathis_button_tsina"></a>
    <a class="jiathis_button_tqq"></a>
    <a class="jiathis_button_qzone"></a>
    <a class="jiathis_button_renren"></a>
    <a class="jiathis_button_xiaoyou"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
</span>

-->
</p>
                </div>
                <p><h2 style="margin: 10px 0px; font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; line-height: 40px; color: rgb(51, 51, 51); text-rendering: optimizelegibility; font-size: 31.5px; clear: both; white-space: normal; text-align: center; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 18px; line-height: 20px; text-decoration: none;"><img src="http://p3.qhimg.com/t015e57a434490673c0.png" title="t015e57a434490673c0.png" alt="http://p8.qhimg.com/t015e57a434490673c0.png"/></span>
</h2>
<p style="text-align: left;">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 18px; line-height: 20px;">起因：</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 14px;"> &nbsp; &nbsp;<span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 14px; line-height: 20px;">&nbsp; &nbsp; Google Project Zero团队的新晋成员James Forshaw在9月30日向微软提交了名为“<span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 14px; line-height: 20px; color: rgb(84, 141, 212);"><strong>Windows: Elevation of Privilege in ahcache.sys/NtApphelpCacheControl</strong></span>”的安全问题，并且在Google的漏洞公开期限（90天）后，也就是2014年12月29日（北京时间的12月30日）公开了此问题的细节。</span><br/></span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;在这里可以看到他针对该问题的一个简单描述和攻击验证代码：</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <a title="https://code.google.com/p/google-security-research/issues/detail?id=118" href="https://code.google.com/p/google-security-research/issues/detail?id=118" target="_blank" style="color: rgb(0, 136, 204); text-decoration: underline; font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 14px;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;https://code.google.com/p/google-security-research/issues/detail?id=118</span></a>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-size: 14px; font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;针对这个漏洞的争论很多，很多观众在争论微软和Google对待安全漏洞的做法，90天公开策略是否合情合理等等，也有很多技术人员在争论这个安全问题是否是严格意义上的权限提升漏洞。后者的一个主要原因是James Forshaw在演示这个漏洞时，是通过此漏洞来劫持UAC默认级别下自动提权的ComputerDefaults程序，从而实现在默认UAC设置下静默从中完整性级别启动高完整性级别的程序。</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;通常来说，微软安全响应中心（MSRC）不认为UAC默认级别下中完整性级别到高完整性级别的提示绕过属于安全漏洞的（参考MSRC的”如何定义安全漏洞“&nbsp;</span><a title="http://technet.microsoft.com/library/cc751383.aspx" href="http://technet.microsoft.com/library/cc751383.aspx" target="_blank" style="color: rgb(0, 136, 204); text-decoration: underline; font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 14px;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 14px;">http://technet.microsoft.com/library/cc751383.aspx</span></a><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 14px;">）。</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;但是，最近MSRC也将一些可以穿透Internet Explorer保护模式（PM）或增强保护模式（EPM）沙箱的安全问题（实际上是从低完整性级别穿透至中完整性级别的问题）作为安全漏洞来修补（例如CVE-2014-6349)。，所以我们先搁置是否安全漏洞的这个争议，深入分析下这个漏洞涉及的原理和问题。</span>
</p>
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 18px;">漏洞分析、成因与利用</span>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;这个漏洞的基本原因，Google的这篇简单说明里已经讲得比较准确了，简单来说，就是NtApphelpCacheControl这个系统调用，在调用者模拟System权限时，没有正确识别调用者的Token，导致其本来仅提供给管理员和系统程序调用的接口，可以被低权限程序误用，并借助该调用的相关机制，劫持高权限程序，实现权限提升。</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;看完这个原因后，你可能会有疑问，这个系统调用是做什么的？什么是Apphelp？Token的判断具体哪里有问题？Apphelp的哪项机制如何能被利用、以及是如何劫持高权限进程的？接下来笔者就将深入地介绍这些内容，详细地解答这些问题。</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-size: 18px;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;</span><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; line-height: 40px;">1. Apphelp与NtApphelpCacheControl</span></span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;在Windows 8.1 系统上，NtApphelpCacheControl这个系统调用，顾名思义，可以控制系统中Apphelp规则的快速缓存数据。</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;Apphelp是微软从WindowsXP操作系统开始引入的一项兼容性解决方案，官方的名字是<strong>”</strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 14px; color: rgb(84, 141, 212);"><strong>Application Compatibility Database</strong></span><strong>”</strong>（应用程序兼容性数据库）。这套解决方案的目的是减少操作系统的向下兼容成本，不是在操作系统层面，而是通过这套兼容数据库引擎提供包括Shim(Hook)在内的大量控制功能，来做到实时地识别和修改特定存在兼容性问题的流行软件程序，使其能够兼容新的操作系统。</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;关于这套机制，微软官方从Windows7开始， 有一些功能性的介绍文档（</span><a title="http://technet.microsoft.com/en-us/library/ee461265(v=ws.10).aspx" href="http://technet.microsoft.com/en-us/library/ee461265(v=ws.10).aspx" target="_blank" style="color: rgb(0, 136, 204); text-decoration: underline; font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">http://technet.microsoft.com/en-us/library/ee461265(v=ws.10).aspx</span></a><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">)，也可以通过官方的”Microsoft Application Compatibility Toolkit”(ACT)，在Windows7以上的操作系统上方便里查看、修改和添加本地的兼容性数据库。在此之前，Alex ionescu和一些其他的国内外研究者也深入地研究过兼容性数据库和Shim机制（</span><a title="http://www.alex-ionescu.com/?p=39" href="http://www.alex-ionescu.com/?p=39" target="_blank" style="color: rgb(0, 136, 204); text-decoration: underline; font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">http://www.alex-ionescu.com/?p=39</span></a><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">） 。</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;微软操作系统的各个版本积累了针对应用程序的大量兼容性修改的方法和基础数据，使这些应用程序可以流畅地运行在新的操作系统中，这为微软的操作系统在世界范围内的复杂环境中广泛运行和推广起到了重要的作用。在Windows Vista发布后，它带来的海量革新的同时，也导致大量应用程序出现兼容性问题，成为该系统被人诟病的原因之一。为此，在其后的Windows7操作系统开发过程中，微软加大了对应用程序兼容性修复方面的重视和投入，不仅更广泛地收集和编制应用程序兼容性修复规则，也对这套兼容性机制做了升级换代。</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;本次出现问题的NtApphelpCacheControl也是支持这套机制的一个新的接口。这已经不是该函数第一次出现安全漏洞， 在j00ru Syscan2013上的关于Bochspwn的议题上，就公开了一个涉及NtApphelpCacheControl处理缓存代码中存在的竞争条件漏洞（CVE-2013-1278）。阅读下面的内容的同时，建议读者能看一看这个slides中NtApphelpCacheControl相关的内容（75~94页）（</span><a title="http://vexillium.org/dl.php?syscan_slides.pdf" href="http://vexillium.org/dl.php?syscan_slides.pdf" target="_blank" style="color: rgb(0, 136, 204); text-decoration: underline; font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">http://vexillium.org/dl.php?syscan_slides.pdf</span></a><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">） 以及James的POC源码。</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;为什么Apphelp需要这个接口呢？这还需要从XP系统说起，应用程序兼容性的主数据库实际存储是在Windows安装目录下的AppPatch\sysmain.sdb文件中的，但是每次进程启动、模块加载时都去检查这个数据文件显然开销太大。为了能快速处理针对这些可执行程序的兼容性规则，就需要在内存中缓存这个数据库的机制。在Windows XP时代， Apphelp使用一块名为ShimSharedMemory的全局共享Section来在不同进程之间共享识别、修改可执行程序的兼容性数据内存。</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;从Windows 2003开始，NtApphelpCacheControl函数被引入系统调用中，作为apphelp的内核入口，在内核中提供了整套新的应用程序兼容性数据库检索、缓存的功能，使得应用程序可以跨Session、跨隔离，并且快速查询、应用兼容性数据库中的规则和处理方案，其缓存功能也实现了在尽量减少性能消耗的同时，快速地针对系统内已知的存在兼容问题的程序进行更快速地修复。</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;在Windows2003，Windows Vista，Windows7和Windows8操作系统上，NtApphelpCacheControl是实现在系统内核ntoskrnl内部的，从Windows8.1操作系统开始，为了能够减少升级成本，内核将该系统调用的绝大部分最终实现在了一个新的内核模式驱动程序ahcache.sys内部，系统内核通过发送设备控制命令给该驱动来实现该接口的绝大部分功能，在Windows10技术预览版上，我们看到这个驱动又进行了一次比较大的更新。</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">NtApphelpCacheControl的原型为：</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><strong>NTSTATUS NtApphelpCacheControl(APPHELPCOMMAND Command , PVOID CommandData);</strong></span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;这个Command提供了针对应用程序兼容性数据库缓存的查看、添加、删除等等一系列功能。其中Command的枚举功能和CommandData的数据结构，J00ru的议题和James的源码中都提供了一些，但都不全面也有不少错误，通过IDA查看实现代码很容易就可以看清楚，这里我将这些功能的Command id、对应的控制码（适用于 Windows8.1）和对应实现的功能整理汇总后列出：</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span>
</p>
<pre class="brush:cpp;toolbar:false;">enum APPHELPCOMMAND
{
AppHelpCahceLookup,                //  IoControlCode: 0x220003*

AppHelpCahceRemove,                //  IoControlCode:  0x220007*

AppHelpCahceUpdate,                //  IoControlCode:  0x22000B*

AppHelpCacheFlush                  //  IoControlCode: 0x22000F* 

AppHelpCacheDump,                  //  IoControlCode: 0x220013 

AppHelpCacheNotifyStart ,          //  IoControlCode: 0x220017 

AppHelpCacheNotifyStop,            //  IoControlCode: 0x22001B

AppHelpCahceForward,               //  IoControlCode:  0x22001F

AppHelpCacheQuery,                 //  IoControlCode: 0x220023

AppHelpQueryModule,                //  IoControlCode: 0x220027

AppHelpRefresh,                    //  IoControlCode: 0x22002B

AppHelpCheckForChange,             //  IoControlCode: 0x22002F

AppHelpQueryHwId,                  
};</pre>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;*:James的POC源码中，对这四个控制码少了一个0</span><br/>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; color: rgb(84, 141, 212); font-size: 14px;"><strong>&nbsp;&nbsp;&nbsp;&nbsp;AppHelpCacheLookup</strong>： 在Apphelp cache中寻找匹配的、需要处理的记录。&nbsp;</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; color: rgb(84, 141, 212); font-size: 14px;"><strong>&nbsp;&nbsp;&nbsp;&nbsp;AppHelpCacheRemove</strong>: &nbsp; 删除匹配的Apphelp Cache记录&nbsp;</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; color: rgb(84, 141, 212); font-size: 14px;"><strong>&nbsp;&nbsp;&nbsp;&nbsp;AppHelpCahceUpdate</strong>： 插入记录到Apphelp Cache&nbsp;</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; color: rgb(84, 141, 212); font-size: 14px;"><strong>&nbsp;&nbsp;&nbsp;&nbsp;AppHelpCacheFlush</strong>：Flush AppHelp cache，将AppHelpCache的缓存数据清空（根据Flush的标志不同，不一定真的删除内存中的数据，只是去掉某些标记），并刷新到磁盘（注册表）上。</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 14px;">&nbsp;&nbsp;&nbsp;&nbsp;James源码中认为这个命令是没用处的AppHelpEnum。这是错误的 ，apphelp!ShimFlushAppcompatCache-&gt;kernelbase!BaseFlushAppcompatCache-&gt;kernel32!BaseFlushAppcompatCacheWorker &nbsp;还在使用这个来清空shim的兼容数据数据。他应该是将AppHelCacheFlush看漏了，源码里对于NotifyStart\Enum等后面的几个都差了一个数。</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 14px;"><strong>&nbsp;&nbsp;&nbsp;&nbsp;AppHelpCacheDump：</strong>这才是一个“没用”的功能， AppHelp会枚举缓存中的数据，针对枚举的项目并不做操作。笔者猜测这个命令之所以叫“Dump”，可能是一个调试功能。于是笔者从WDK中找了个checked build的内核来看了下。果然在checked build内核中，会枚举缓存中的元素，并逐个打印出记录要去匹配的文件名记录。在Free build中，对应的代码被去掉了，所以成了一个看似无用的命令，实际在checked build，微软的开发人员可能是有对应的工具去通过这个接口方便地观察缓存中都有那些记录。</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><strong>&nbsp;&nbsp;&nbsp;&nbsp;AppHelpCacheNotifyStart/AppHelpCacheNotifyStop</strong>:这两个命令主要用于同AppHelp的服务通讯，AppHelp内核会通过\AhcPort这个ALPC Port同Application Experience服务通讯。这两个命令用于重连/停止 同服务的LPC通讯。</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><strong>&nbsp;&nbsp;&nbsp;&nbsp;AppHelpCacheForward</strong>: 用于将缓存可执行程序的信息排队，然后转发给Application Experience服务处理</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><strong>&nbsp;&nbsp;&nbsp;&nbsp;AppHelpCacheQuery</strong>: &nbsp;用于获取Shim Cache中的数据内容、ShimCache的相关统计和队列。</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><strong>&nbsp;&nbsp;&nbsp;&nbsp;AppHelpQueryModule/AppHelpCacheRefresh/AppHelpCheckForChange/AppHelpQueryHwId</strong>：这些是Windows8.1新增的命令，和这里就不详细介绍了。</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;下面介绍这个调用中重要的数据CommandBuffer的结构，<strong>这个结构的数据驱动了Lookup/Remove/Update/Forward等大部分基本命令。</strong></span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;James在源码中定义了相关结构，不过看上去对这个结构的了解也不是很深入。</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;这个CommandBuffer的结构（我这里称为APPHELP_COMMANDDATA），是由三个结构体组成的：</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;其中第一个结构体用于存储整个shim缓存和统计内容，被AppHelpCacheQuery命令使用；</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;第二个结构体用于在AppHelpCacheLookup/AppHelpCacheRemove/AppHelpCacheUpdate这三个命令时来告诉接口检索、删除和添加的项目内容；</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;第三部分则用于AppHelpCacheForward命令，提供forward，用于提供转发给服务的相关数据。</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;无论是哪个命令，CommandBuffer都同时包含着三个结构体，这也是为什么J00ru的议题和James的源码里都提到提交的缓存结构前面有大量无用的0数据的原因。</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">下面给出这个结构的定义：</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span>
</p>
<pre class="brush:cpp;toolbar:false;">typedef struct APPHELP_COMMANDDATA{

APPHELP_CACHE_QUERY QueryData;                  //Query full data

APPHELP_CACHE_ENTRY EntryData ;                 //Lookup/Remove/Update entry

APPHELP_CACHE_FORWARD ForwardData;             //Data for forward

} APPHELP_COMMANDDATA, *PAPPHELP_COMMANDDATA;</pre>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;其中APPHELP_CACHE_QUERY/APPHELP_CACHE_FORWARD的结构和本次漏洞无关，就留给感兴趣的读者去研究了。</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;需要注意的是，QueryData的数据长度会影响后面的EntryData（这个长度在Win7\Win8上不相同），Win7上是0x90，Win8.1上James已经提供了是0x98（这也是为什么Win7上这个POC无法工作的原因之一）。这点看一看ApphelpCacheControlValidateParameters或AhcValidateAndGetParameters就可以了解了。</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;这里提供一下APPHELP_CACHE_ENTRY的数据结构：</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span>
</p>
<pre class="brush:cpp;toolbar:false;">typedef struct APPHELP_CACHE_ENTRY{

DWORD Flags ;

ULONG CacheReturnFlags ;

HANDLE FileHandle;

HANDLE ProcessHandle ; //Only in Win8/Win8.1


UNICODE_STRING FileName;

UNICODE_STRING PackageFullName;    //only in Win8/Win8.1

DWORD  DataBufferSize;

PVOID DataBuffer;

} APPHELP_CACHE_ENTRY, *PAPPHELP_CACHE_ENTRY;</pre>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;其中 Flags/CacheReturnFlags分别指明了这条Cache的功能和作用，尤其是对于DataBufferSize/DataBuffer是否有效的控制，是否在关机时保存到注册表中等。</span><br/>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;FileHandle/FileName是对应要进行处理的可执行程序（包括模块）的对应句柄和文件名，之所以要提供文件句柄，是因为内核使用一个AVL Table来存储Entry数据，使用文件句柄的FileTime来做其中平衡树的索引。</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;DataBufferSize和DataBuffer描述了Entry相关的规则数据的内容。</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;ProcessHandle和PackageFullName仅在Windows8及以后的操作系统上使用。</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;DataBuffer可以保存由RING3存储的数据结构，一般来说由APPHELP_CACHEUPDATE更新到内核缓存中，APPHELP_CACHELOOKUP获取后使用，Shim引擎使用的数据结构，我称为APPHELP_LOOKUP_RESULT（即James源码中的APPHELP_QUERY结构），如下：</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span>
</p>
<pre class="brush:cpp;toolbar:false">#define MAX_EXE_TAGS 16
#define MAX_LAYER_TAGS 8
typedef struct APPHELP_LOOKUP_RESULT
{
DWORD ExeTags[MAX_EXE_TAGS];
DWORD ExeFlags[MAX_EXE_TAGS];
DWORD LayerTags[MAX_LAYER_TAGS];
DWORD LayerFlags;
DWORD AppHelpTag;
DWORD ExeTagsCount ;
DWORD LayerTagsCount;
GUID ExeGuid;
DWORD Flags2;
DWORD Unknown;
DWORD Unknown2;
GUID Guid2[16];
};</pre>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;如James源码中所使用的， &nbsp;其中ExeTags指明了在sdb数据中的修复方案的tag id，ExeTagsCount是tag的数量，最多16个， LayerTags是Layer规则的数据。</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;通过这些命令和数据结构，我们大概了解了NtAppHelpCacheControl提供的能力，那么RING3是如何使用它的呢？</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;简单地说，Ring3的Module Loader等模块在模块加载、进程启动等事件触发时，会调用apphelp.dll中的相关接口， apphelp.dll再调用kernel32/kernelbase内BasepShim*相关的API，通过NtAppHelpCacheControl中的CacheLookup功能查询模块的可执行文件是否在缓存的数据中，如果存在就按照规则数据库中对应的规则处理，相关的数据通过CacheForward发送到服务进程后，会调用CacheUpdate功能缓存被使用的数据，加快二次查询的速度。&nbsp;</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 18px; line-height: 40px;">Token相关的问题</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;了解了AppHelpCache的接口和基本工作原理后，我们很容易可以明白，如果可以低权限的程序可以调用AppHelpCacheUpdate命令添加缓存，那么可以劫持任意高权限程序，利用shim规则对其进行修改，实现权限提升。</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;那么我们回来看看这个漏洞的成因，如James在说明里提到的，这个漏洞的原因是因为用于验证AppHelpCacheUpdate是否运行被调用的AhcVerifyAdminContext函数，验证Token存在问题，这个函数很简单，我们使用Hex-rays decomplier得到伪代码：</span><span style="font-family: sans-serif; font-size: 16px; background-color: rgb(248, 248, 248);">NTSTATUS AhcVerifyAdminContext()</span>
</p>
<pre class="brush:cpp;toolbar:false;">{
  retstatus = STATUS_ACCESS_DENIED;
  CurrentThread = KeGetCurrentThread();
  CurrentProcess = PsGetCurrentProcess();
  TokenType = 0;
  TokenObj = PsReferenceImpersonationToken(CurrentThread, &amp;CopyOnOpen, &amp;EffectiveOnly, &amp;ImpersonationLevel);
  if ( TokenObj || (TokenObj = PsReferencePrimaryToken(CurrentProcess), TokenType = 1, TokenObj) )
  {
    if ( SeQueryInformationToken(TokenObj, 1, &amp;TokenUserInformation) &gt;= 0 )
    {
      if ( RtlEqualSid(_SeExports-&gt;SeLocalSystemSid, TokenUserInformation-&gt;User.Sid) || SeTokenIsAdmin(TokenObj) )
      {
        retstatus = STATUS_SUCCESS;
      }
      ExFreePoolWithTag(TokenUserInformation, 0);
    }
    else
    {
      AhcTracePrintf(0, &quot;AhcVerifyAdminContext&quot;, 937, &quot;Failed to query token information.\n&quot;, v5);

    }
    if ( TokenObj )
    {
      if ( TokenType == 1 )
      {
        PsDereferencePrimaryToken(TokenObj);
      
      }
      else
      {
        PsDereferenceImpersonationToken(TokenObj);
      }
    }
  }
  else
  {
    AhcTracePrintf(0, &quot;AhcVerifyAdminContext&quot;, 929, &quot;Failed to get effective token&quot;, v5);

  }
  return retstatus;
}</pre>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;函数的功能很简单，首先试图获取线程模拟的token，如果线程的模拟token不存在，就获取当前进程的主token对象，获取token对象后， 通过SeQueryInformationToken(TokenUser）获得Token的用户信息。</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;接着，对比如果下面token对象符合下面两种情况的任一种，就返回STATUS_SUCCESS允许AppHelpCacheUpdate操作，否则就返回STATUS_ACCESS_DEIND拒绝操作：</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 14px; color: rgb(84, 141, 212);"><strong>&nbsp;&nbsp;&nbsp;&nbsp;1. Token的用户SID匹配LocalSystem的SID</strong></span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 14px; color: rgb(84, 141, 212);"><strong>&nbsp;&nbsp;&nbsp;&nbsp;2.Token通过SeTokenIsAdmin的验证</strong><strong>，也就是token用户组内有启用的Adminsitrator组。</strong></span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;那么这个对比就是James所说的验证Token有问题的部分，有问题的原因就如James所说， 是因为没有去判断ImpersonationLevel。</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;这是因为被模拟的Token的SID并不能决定Token就真的拥有对应SID的权利，可以参考微软关于SECURITY_IMPERSONATION_LEVEL的MSDN解释（</span><a title="http://msdn.microsoft.com/en-us/library/windows/hardware/ff556631(v=vs.85).aspx" href="http://msdn.microsoft.com/en-us/library/windows/hardware/ff556631(v=vs.85).aspx" target="_blank" style="color: rgb(0, 136, 204); text-decoration: underline; font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">http://msdn.microsoft.com/en-us/library/windows/hardware/ff556631(v=vs.85).aspx</span></a><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;）。</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;低于SecurityImpersonation的模拟token其实并不是以被模拟的Client的安全上下文运行的，所以仅仅通过SID来判断调用者是否具备LocalSystem的权限是不够，类似的问题其实是Windows的内核、内核模式驱动程序中还有不少地方存在，感兴趣的读者可以再进行一些挖掘。</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;以James源码的方法为例，通过Bits服务的BackgroundCopyManager接口创建一个下载任务后，代码将自己的Notify对象设置为任务的通知接口。</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;此时服务在下载通知时会调用对应的对象，接着combase通过LPC回调试图调用对象的接口函数，而在调用前，就会使用RpcImpersonateClient-&gt;NtAlpcImpersonateClientOfPort，由AlpcpImpersonateMessage来为执行回调接口准备Alpc port指定的安全上下文。</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;由于Bits的OLE Port指定的允许的SecurityQos-&gt;ImpersonationLevel级别的模拟，模拟完成后调用到James的处理代码，他的代码打开并保存了线程的token句柄，由此获得了一个SecurityIdentification级别的Token句柄 ，Token是来自Bits服务的安全上下文，因此Token的SID自然也就是NT AUTHORITY\SYSTEM（LocalSystem）</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp; &nbsp; 这里Bits服务本身是没有安全问题的，因为ALPC获得和模拟的token只是SecurityIdentification级别，即使模拟这个token（就如James的代码后面所做的），也无法以System权限上下文工作，在访问对象ACL时，会被拒绝访问（可以参考SeAccessCheck中的实现和判断），也不会被识别为admin/system（可以参考SeTokenIsAdmin在Windows7以上操作系统的实现），</span><strong style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">但是NtAppHelpCacheControl这里只判断Token SID的方式，就导致了安全检查被绕过，也是这个漏洞的根本原因。</strong>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-size: 18px; font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;</span><span style="font-size: 18px; font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; line-height: 40px;">漏洞的利用</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;James提供的POC针对这个漏洞利用的方法是劫持一个UAC默认级别下会不区分命令行，无提示自动提权的程序ComputerDefaults.exe，找到regsv32修复的的sdb tag（通过替换模块镜像为regsvr32来进行兼容修复），并将其设置到apphelp缓存中，这样，在启动ComputerDefaults.exe的时候，实际启动的可执行程序的镜像就被Apphelp替换成了regsvr32.exe ，而启动的时候命令行上加上想要注入高权限进程的dll文件，就会使得regsvr32.exe在高完整性级别上加载我们想要加载的DLL，James的DLL代码里实现的是启动一个计算器程序。</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp; &nbsp; 这个利用方法引来了一些争议，很多人认为这样只证明可以绕过UAC默认级别下中完整性级别到高完整性级别的弹框，通常来说不能说是安全漏洞，而且实际之前也有很多公开的技巧可以绕过UAC提示。</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp; &nbsp; 但就如James自己说的，UAC的绕过仅仅只是个方便的演示方式，想一想测一测就能发现，这个漏洞还有更多的利用方式。</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;以IE11 的沙箱（PM）为例，这个漏洞需要的相关功能（包括BITS Token的获取、NtAppHelpCacheControl的调用、sdb Tag的获取等等）都是可以在IE11沙箱的低完整性级别下执行的，那么恶意代码一旦进入沙箱，就可以利用这个漏洞劫持一个常用的中完整性级别程序（甚至系统中经常被启动的高完整性、系统完整性级别程序），就可能通过这个漏洞穿透沙箱，在沙箱外执行恶意代码。使用icacls.exe&nbsp;/setintegritylevel 给测试程序设置Low完整性级别后，可以很容易证实这点。</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;即使是在通过Users用户组的账户登录的情况下，如果同时或之后有管理员账户登录，由于这个AppHelp Cache是全局跨Session的，因此管理员运行的程序也会可能受到劫持的影响，发生权限提升。</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;这些都是通过James的测试程序就能完成的攻击，但是这个攻击的一个缺点是必须要有高权限的程序去启动， 那么还有更好的利用方式么？</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;肯定是有的，大家看到刚才我们介绍的AppHelpCacheFlush功能了吧，这个接口的调用者验证也存在和 AppHelpCacheUpdate同样的问题，那么通过这个接口就可以直接将内存中已经添加的AppHelpCache刷入注册表中（HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Control\Session Manager\AppCompatCache下AppCompatCache)，这样下次开机时就会加载并应用添加的规则，这样重新启动后就可以更方便的劫持想要劫持的程序。</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;同时，通过调用低完整性级别/低权限账户或AppContainer完整性级别下允许调用的某些服务LPC/COM接口，也可以使其启动特定的高权限程序，并可能进行劫持。</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;这些技术含量不高，已经提供了这么多Tips，再具体的方式就需要大家发挥想象力了，最后再提点细节：AppHelp规则不仅能应用于EXE进程创建，也可以应用在指定的任意模块加载时。</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-size: 18px;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;</span><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; line-height: 40px;">Windows7的问题</span></span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;ames在说明里提到了Windows7的问题，在Windows7上， AppHelpCacheUpdate这条指令专门被一个特别的ApphelpCacheVerifyContext检查所保护（对于其他被保护接口使用的是ApphelpCacheVerifyAdminContext，和Windows8/8.1一样存在这个安全漏洞），这个检查更严格，仅在主TOKEN具备TCB特权时才可以通过，代码如下：</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span>
</p>
<pre class="brush:cpp;toolbar:false;">NTSTATUS ApphelpCacheVerifyContext()
{

  status = STATUS_SUCCESS;
  if ( PsGetCurrentThreadPreviousMode() &amp;&amp; SeSinglePrivilegeCheck(SeTcbPrivilege, UserMode)  == FALSE)
    status = STATUS_ACCESS_DENIED;
  return status;
}</pre>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;看上去这个检查函数是无法绕过了，James同时提到，这个检查是在CommandBuffer中的某些Flags匹配时，才会进行，也许可以绕过，那么实际如何呢？</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;我们逆向NtAppHelpCacheControl在Win7上的相关实现可以得知，在CommandBuffer-&gt;Flags的Bit 2，3为1时，是不进行这个检查的，这样的Entry是可以通过AppHelpCacheUpdate的检查，加入缓存中的。</span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;但是，我们再来看AppHelpCacheLookup的相关实现就不难发现，&nbsp;<span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 14px;"><strong>仅当entry-&gt;Flags的bit 0为1时，Lookup才为调用者返回CommandBuffer-&gt;DataBuffer和DataBufferSize</strong></span>，而就像在第一节里提到的，这两个域描述了APPHELP_LOOKUP_RESULT数据结构，<strong>没有这个数据我们无法指定要应用的规则。</strong></span>
</p>
<p style="margin-top: 0px; margin-bottom: 10px; color: rgb(51, 51, 51); font-family: &#39;Helvetica Neue&#39;, Helvetica, Arial, sans-serif; font-size: 14px; line-height: 20px; white-space: normal; background-color: rgb(255, 255, 255);">
    <span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp;&nbsp;所以至少通过目前的分析来看，通过修改Flags的方法，是无法将达成我们的劫持数据加入缓存并生效的目的的，暂时可以认为这个漏洞难以在Windows7上实现利用。</span>
</p>
<p>
    <br/>
</p></p>
                <hr/>
                <p style="text-align: center;">
                    <img src="http://bobao.360.cn/img/app.jpeg"/>
                    <img src="http://bobao.360.cn/img/weixin.jpeg"/>
                </p>
                                <p>本文转载自 360攻防实验室@Mj0011<br/><a class="text-more" href="http://blogs.360.cn/blog/ntapphelpcachecontrol_vulnerability_anaysis/" target="_blank">原文链接：http://blogs.360.cn/blog/ntapphelpcachecontrol_vulnerability_anaysis/</a></p>
                            </div>
            <div style="margin-top: 20px;background-color:#FFFFFF">
    <input type="hidden" id="detail_title" name="detail_title" value="360安全研究人员发布：Win8本地提权漏洞技术分析 - 安全客 - 有思想的安全新媒体" />
    <input type="hidden" id="use_nickname" name="use_nickname" value="0" />
    <a name="mao"></a>
    <div class="reg-log mobile-hiden">
        <div class="" id="userTo">   
            <div id="to-list" class="input-text" style="">
                <textarea disabled="disabled" class="hide"  id="comment-content" to="to"></textarea>
                <ul id="preadded" style="display:none">       
                </ul>
                <div id="to-auto" style="width: 200px">
                    <ul id="feed">
                    </ul>
                </div>
            </div>
        </div>
        <input type="hidden" id="source-id" value="183" />
        <input type="hidden" id="source-type" value="learning" />
        <input type="hidden" id="post-comment-url" value="/comment/add" />
        <input type="hidden" id="post-nickname-url-ajax" value="/comment/randnicknameajax" />
        <input type="hidden" id="post-check-login-url-ajax" value="/comment/checklogin" />
        <input type="hidden" id="stoken_comment_set" value="64d932c9bb50dc5a83db601d9b02e735">                 <span class="join">参与讨论，请先 <a href="javascript:;" class="comment-login">登录</a> | <a href="javascript:;" class="comment-reg">注册</a> |  <a href="javascript:;" class="anonymous-comment">匿名评论</a></span>
            </div>
    <div class="mobile-hide" style="width: 870px; margin: 0 auto;">
        <label style="vertical-align:middle;" for="use_nickname">匿名</label> 
        <input style="vertical-align:middle;" id="trigger-nickname" name="use_nickname" class="use_nickname" type="checkbox" value="0" />

        <a href="javascript:;" class="apply-use button" id="submit-comment" data-target="/comment/add">发布</a>
    </div>


    <div class="clearfix"></div>
    <div class="comments">
        <div class="comments-head">
            <span class="title">用户评论</span>
        </div>
                <div class="comment-none alarm-info bg-primary">无任何评论</div>
            </div>
</div>
<script>
    $(function () {
        $('.anonymous-comment').click(function () {
            $(".join").hide();
            $(".reg-log textarea").first().removeAttr("disabled").show();
            $('#use_nickname').val('1');
//            $('#trigger-nickname').attr('checked', true);
            $('#trigger-nickname').trigger('click');
        });
        //为所有复选框绑定事件
//        checkbox_on_click();
        //ajax随机获取昵称
//        randnicknameajax(0);
        //ajax检测登录状态
        comment_check_login();
    });



    function input_checkbox(flag) {
        $('input:checkbox').each(function () {
            var value = flag ? 1 : 0;
            $(this).prop('checked', flag);
            $(this).val(value);
        });
    }

//ajax随机获取昵称
    function randnicknameajax(flag) {
        $.ajax({
            type: 'POST',
            url: $('#post-nickname-url-ajax').val(),
            data: {limit: 1, flag: flag},
            dataType: "json",
            success: function (data) {
                $('#nick-name').val(data.data[0]);
                _nick_name=data.data[0];
            }
        });
    }
    $();
//ajax检测登录状态
    function comment_check_login() {
        $.ajax({
            type: 'POST',
            url: $('#post-check-login-url-ajax').val(),
            data: {},
            dataType: "json",
            success: function (data) {
                if (data.success) {
                    $('.join').hide();
                    $(".reg-log textarea").first().removeAttr("disabled").show();
                    $("#span_use_nickname").show();
                    $('#use_nickname').val('0');
                    $('#use_nickname').attr('checked', false);
                }
            }
        });
    }
</script>        </div>
    </div>
    <div class="side-bar">
        <div class="mod hot-news">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-hot"></i><span>热门知识</span></h2>
    </div>
    <ul class="links-list">
                                <li><a href="/learning/detail/4411.html" alt="【漏洞预警】一个换行符引发的奥斯卡0day漏洞(CVE-2017-8759)重现——最新的Office高级威胁攻击预警" target="_blank">【漏洞预警】一个换行符引发的奥斯卡...</a></li>
                                <li><a href="/learning/detail/4416.html" alt="【漏洞预警】Microsoft .NET Framework漏洞（CVE–2017–8759）预警" target="_blank">【漏洞预警】Microsoft .NE...</a></li>
                                <li><a href="/learning/detail/4414.html" alt="【技术分享】妙用JavaScript绕过XSS过滤" target="_blank">【技术分享】妙用JavaScrip...</a></li>
                                <li><a href="/learning/detail/4425.html" alt="【安全报告】XShellGhost事件技术回顾报告" target="_blank">【安全报告】XShellGhost事件...</a></li>
                                <li><a href="/learning/detail/4424.html" alt="【知识】9月16日 - 每日安全知识热点" target="_blank">【知识】9月16日 - 每日安全知识热...</a></li>
                                <li><a href="/learning/detail/4418.html" alt="【技术分享】利用威胁情报数据平台拓展APT攻击线索一例" target="_blank">【技术分享】利用威胁情报数据平台拓...</a></li>
            </ul>
</div>        <!-- 友情链接 -->
        <div class="mod blog-links mobile-hide">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-link"></i><span>友情链接</span></h2>
        <a href="/links/index.html" class="more">更多<i></i></a>
    </div>
        <ul class="links-list">
                <li><a href="http://bbs.360safe.com" alt="360安全社区" target="_blank">360安全社区</a></li>
                <li><a href="http://zhuji.360.cn" alt="360主机卫士" target="_blank">360主机卫士</a></li>
                <li><a href="http://blogs.360.cn/" alt="奇虎360技术博客" target="_blank">奇虎360技术博客</a></li>
                <li><a href="http://wangzhan.360.cn/" alt="360网站卫士" target="_blank">360网站卫士</a></li>
                <li><a href="http://webscan.360.cn/" alt="360网站安全检测" target="_blank">360网站安全检测</a></li>
                <li><a href="http://research.360.cn/report/" alt="360研究报告" target="_blank">360研究报告</a></li>
                <li><a href="http://unicorn.360.cn/" alt="360 Unicorn Team" target="_blank">360 Unicorn Team</a></li>
                <li><a href="http://appscan.360.cn/" alt="360捉虫猎手" target="_blank">360捉虫猎手</a></li>
                <li><a href="https://threathunter.org/" alt="ThreatHunter社区" target="_blank">ThreatHunter社区</a></li>
                <li><a href="http://security.360.cn/" alt="360安全应急响应中心" target="_blank">360安全应急响应中心</a></li>
            </ul>
    </div>
        <!-- 联系我们 -->
        <div class="mod contact mobile-hide" style="text-align:center">
    <div class="head-bar clearfix">
        <h2><i></i><span>关注我们</span></h2>
    </div>
    <!-- 微信关注 -->
    <ul class="contact-way">
        <li><a>微信关注</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/qrcode_adlab_weixin.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
    <!-- APP下载 -->
    <ul class="contact-way">
        <li><a>安全播报APP</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/scan_code_big.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
</div>

    </div>
</div>

<script type="text/javascript" src="/js/jquery-ui.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/jquery.noty.packaged.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/common.js?v=4.5"></script>
<script>$(function() {sync_count('comment');});</script>


<!-- 语法高亮 -->
<script type="text/javascript" src="/ue/SyntaxHighlighter/shCore.js"></script>
<script type="text/javascript">SyntaxHighlighter.all();sync_count('vul');sync_count('news');sync_count('learning');sync_count('activity');sync_count('course');sync_count('ctf');</script>
    </div>

        <div class="footer">
        <div class="friend-link">
            <a href="http://www.360.cn/" target="_blank">360首页</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">关于我们</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">联系我们</a>
            <span>|</span>
            <a href="/links/index.html" target="_blank">友情链接</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">招贤纳士</a>
        </div>
        <div class="copy">
            Copyright &copy; 360网络攻防实验室 All Rights Reserved <span class="copy_icp">京ICP证080047号[京ICP备08010314号-6]</span>
        </div>
    </div>
    
</div>

<!--奇舞团统计-->

<script src='https://s.ssl.qhimg.com/static/f5407c785655e6a1/monitor_analytic.js'></script>
<script>
    monitor.setProject('QH_171_1').getTrack().getClickAndKeydown().getClickHeatmap(10, 1);
</script>

<div class="hide">
    <script src="https://s95.cnzz.com/z_stat.php?id=1253147824&web_id=1253147824" language="JavaScript"></script>
</div>
<div class="backToTop_wrap off">
    <a id="back_to_top" class="backToTop" href="javascript:;" title="返回顶部"></a>
</div>
<script>
    var $backToTop_wrap = $(".backToTop_wrap"),
        $backToTop_btn = $("#back_to_top");

    if ($(window).scrollTop() > 100) {
        $backToTop_wrap.removeClass("off");
    }
    else {
        $backToTop_wrap.addClass("off");
    }

    $(window).on("scroll", function () {
        if ($(this).scrollTop() > 100) {
            $backToTop_wrap.removeClass("off");
        }
        else {
            $backToTop_wrap.addClass("off");
        }
    });

    $backToTop_btn.on("click", function () {
        $("html, body").animate({scrollTop: 0}, 120);
    });

    $(function () {
        var navlist = $('.nav-list > li');

        navlist.each(function () {
            $(this).on('mouseenter', function () {
                $(this).addClass('selected');
            });

            $(this).on('mouseleave', function () {
                $(this).removeClass('selected');
            });
        });
    })
</script>



</body>
</html>
