<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns:wb="http://open.weibo.com/wb" xml:lang="en" lang="en">
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"/>
    <link rel="shortcut icon" href="http://bobao.360.cn/favicon.ico?v=1.1"/>
    <link rel="alternate" title="安全资讯" href="/rss?type=news" type="application/rss+xml"/>
    <link rel="alternate" title="安全知识" href="/rss?type=learning" type="application/rss+xml"/>
    <link rel="alternate" title="安全圈活动" href="/rss?type=activity" type="application/rss+xml"/>
    <link rel="alternate" title="所有漏洞" href="/rss?type=vul" type="application/rss+xml"/>
    <link rel="alternate" title="通用型漏洞" href="/rss?type=commonvul" type="application/rss+xml"/>
    <link rel="alternate" title="事件型漏洞" href="/rss?type=eventvul" type="application/rss+xml"/>
    <link rel="alternate" title="热门漏洞" href="/rss?type=hotvul" type="application/rss+xml"/>

        <title>【技术分享】反逆向工程——使恶意软件难以逆向的技术 - 安全客 - 有思想的安全新媒体</title>
    
        <meta name="keywords" content="逆向工程,反逆向工程"/>
    
        <meta name="description" content="在攻防对抗的博弈中，恶意软件的作者总是想方设法阻止反病毒公司、安全研究人员对其编写的恶意软件进行检测、分析。在对抗中，技术的进步螺旋式上升，那么编写恶意软件的人都采用了哪些技术来对抗分析？这些技术又是如何发展的？反病毒公司如何应对这种挑战？作者 Bartosz Wójcik 给出了自己的观察。"/>
        <meta property="wb:webmaster" content="224437c7be31d633"/>

    <script type="text/javascript" src="http://s7.qhimg.com/!56caa871/xpc_sync_height.js"></script>
    <link rel="stylesheet" type="text/css" href="/css/reset.css" />
    <link rel="stylesheet" type="text/css" href="/css/common_new.css?v=4.4.2.1" />
    <link rel="stylesheet" type="text/css" href="/css/jquery.notyfy.css" />
    <link rel="stylesheet" type="text/css" href="/css/notyfy.theme.default.css" />
    <link rel="stylesheet" type="text/css" href="/css/s_common.css?v=2.2.7" media="only screen and
    (max-device-width:900px), only screen and (max-width:900px)" />
    <script type="text/javascript" src="/js/jquery.min.js?v=3.1"></script>
    <script type="text/javascript" src="/js/jquery.notyfy.js"></script>
    <script type="text/javascript" src="/js/iscroll.js"></script>
    <script src="http://js.passport.qihucdn.com/5.0.3.js"></script>
    <script type="text/javascript">
        var myScroll, myNavScroll;

        function iscrollLoaded() {
            myScroll = new IScroll('#wrapper',
                {
                    scrollX: true,
                    scrollY: false,
                    bounceEasing: 'circular',
                    eventPassthrough: true,
                    preventDefault: false,
                    bounceTime: 500
                }
            );
        }

        $(function () {

            //导航横向滚动


            function setNavWidth() {

                /* 计算导航宽度 */
                var allWidth = $(window).width();
                var scroller = $('#scroller');

                if (allWidth > 900) {
                    scroller.find('ul').add(scroller.find('.scroll')).removeAttr('style');
                    scroller.css('overflow', 'visible');
                    if (myNavScroll) myNavScroll.destroy();
                } else {

                    var width = 0;
                    scroller.find('.scroll').children('ul').children('li').each(function (index, el) {
                        if (!$(this).hasClass('mobile-hide')) {
                            width += $(this).outerWidth();
                        }
                    });
                    scroller.find('ul').add(scroller.find('.scroll')).width(width);

                    if (myNavScroll) myNavScroll.destroy();

                    myNavScroll = new IScroll('#scroller', {
                        scrollX: true,
                        scrollY: false,
                        momentum: false,
                        click: true
                    });

                }

            }

            setNavWidth();
            $(window).resize(function (event) {
                setNavWidth();
            });

        });

    </script>
</head>
<body onload="iscrollLoaded();">
<div style='margin:0 auto;width:0px;height:0px;overflow:hidden;'>
    <img src=""/>
</div>

<div id="is-mobile"></div>
<div class="container">
        <div class="mobile-header">
        <div class="header clearfix">
            <div class="header-wrapper clearfix">
                <a href="/index/index" class="logo"><img class="slogan" src="/img/logo.png?v=1.5"/></a>
                                <form id="search" class="search-box" action="/search/index" method="GET">
                    <input class="keys" name="keywords" type="text" placeholder="搜索漏洞" required="required">
                    <input class="icon" type="submit" value="">
                    <input type="hidden" name="type" value=""/>
                </form>
                <div class="bug">
                    <div class="name"><span class="seled">全部</span><i class="arrow"></i></div>
                    <ul class="typelist">
                        <li data-index="3"><a href="javascript:void(0);">全部</a></li>
                        <li data-index="0"><a href="javascript:void(0);">漏洞</a></li>
                        <li data-index="1"><a href="javascript:void(0);">资讯</a></li>
                        <li data-index="2"><a href="javascript:void(0);">知识</a></li>
                    </ul>
                </div>
                                <div class="logNreg mobile-hide">
                    <div class="unlog">
                        <i></i>
                        <a href="log.html" class="log">登录</a>
                        <span>|</span>
                        <a href="reg.html" class="reg">注册</a>
                    </div>
                    <div class="loged">
                        <a href="/member/profile" class="user-center"><i></i><span class="user-name-tag">个人中心</span></a>
                        <div class="user-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting"><a href="http://i.360.cn/profile/accountmanage"
                                                               target="_blank"><i></i><span>账号设置</span></a></li>
                                <li class="alert-setting"><a href="/keywords/index"
                                                             target="_blank"><i></i><span>告警设置</span></a></li>
                                <li class="bug-alert"><a href="/myalarm/index" target="_blank"><i></i><span>漏洞告警</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mylearn/index" target="_blank"><i></i><span>我的知识</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mycourse/index" target="_blank"><i></i><span>我的课堂</span></a>
                                </li>
                                <li class="my-exit"><a
                                            href="http://login.360.cn/?src=pcw_adlab&op=logout&destUrl=http://bobao.360.cn"><i></i><span>退出系统</span></a>
                                </li>
                            </ul>
                        </div>

                        <a href="/message" class="message-center" target="_blank"><i></i><span>我的消息</span></a>
                        <div class="message-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting" style="display:none;"><a href="/myres/index"
                                                                                     target="_blank"><i></i><span>回复我的</span></a>
                                </li>
                                <li class="my-bug"><a href="/myvul/index"
                                                      target="_blank"><i></i><span>我的漏洞</span></a></li>
                                <!--<li class="my-bug"><a href="/myres/index" target="_blank"><i></i><span>我的评论</span></a></li>-->
                                <!--<li class="alert-setting"><a href="###" target="_blank"><i></i><span>提到我的</span></a>
                                </li>-->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <style type="text/css">
            .nav {
                overflow: hidden;
            }

            .nav .scroll {
                width: auto;
            }
        </style>
        <div id="wrapper">
            <div id="scroller" class="nav">
                <div class="scroll">
                    <ul class="nav-list">
                        <li ><a class="link-nav"
                                                                                 href="/index/index">首页</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/vul/index">漏洞</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/introduce/list">招聘</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/news/index">资讯</a><!--<i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/introduce/list">招聘</a></li>
                        </ul>
			-->
                        </li>
                        <li class="cur">
                        <a class="link-nav" href="/learning/index">知识</a><i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/course/index">学院</a></li>
                        </ul>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/activity/index">活动</a></li>
                        <li class="mobile-hide "><a class="link-nav"
                                                                                                   href="/ctf/index">CTF训练营</a>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/interref/list">安全内参</a></li>
                        <li ><a class="link-nav" href="/app/index">APP</a></li>

                        <!--<li ><a href="/course/index">学院</a></li>-->
                        <!--<li ><a href="/introduce/list">招聘</a></li>-->
                        <!--<li  class="mobile-hide"><a href="/ctf/index">CTF训练营</a></li>-->
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="mobile-content">
        <link rel="stylesheet" type="text/css" href="/css/news.css?v=3.5" />
<link rel="stylesheet" type="text/css" href="/ue/SyntaxHighlighter/shCoreDefault.css?v=1.0" />
<style>
    p .syntaxhighlighter {
        width: 80%;
    }
</style>

<div class="cur-pos w1000">当前位置：<a href="http://bobao.360.cn/">安全客</a> &gt;&gt; 知识详情</div>

<div class="content clearfix">
    <div class="main">
        <div class="article">
            <div id="article_box">
                <h2>【技术分享】反逆向工程——使恶意软件难以逆向的技术</h2>
                <div class="article-msg">
                    <span class="time">2016-11-23 16:37:53</span>
                    
                                        <span class="read">阅读：31762次</span>
                    <span><a style="display: none;" class="good" href="javascript:;"
                             data-target="/learning/good" data-value="g_3217"
                             data-type="learning">点赞(0)</a></span>
                    <span><a class="fav" href="javascript:;" data-target="/mylearning/add"
                             data-pk="3217" data-type="learning">收藏</a></span>
                                        <span><a style="margin-left: 4px;" class="fav" href="https://www.pelock.com/articles/anti-reverse-engineering-malware-vs-antivirus-software"
                             target="_blank">来源： pelock</a></span>
                    
                    
                    <div style="margin-top:10px; ">
                        <a href="/member/contribute?uid=2795682273" style="color:#848e99;">
                            <img src="http://p1.qhmsg.com/dm/150_150_100/t00df551a583a87f4e9.jpg" data-is-avatar="true"
                                 style="border: 1px solid #d5d5d5;padding: 2px; width: 80px;height: 80px;border-radius: 43px;"/>
                        </a>

                    </div>
                    <span class="orig">作者：<a href="/member/contribute?uid=2795682273" style="color:#848e99;">Titan_Avenger</a></span>
                                    </div>
                <hr size="1">
                <div class="article-msg">
                    <p><!-- JiaThis Button BEGIN -->

<!--
<span class="jiathis_style"><span class="jiathis_txt">分享到：</span>
	<a class="jiathis_button_weixin"></a>
	<a class="jiathis_button_tsina"></a>
    <a class="jiathis_button_tqq"></a>
    <a class="jiathis_button_qzone"></a>
    <a class="jiathis_button_renren"></a>
    <a class="jiathis_button_xiaoyou"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
</span>

-->
</p>
                </div>
                <p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></strong></span></p><p style="white-space: normal; text-indent: 0em; text-align: center;"><span style="font-size: 18px; color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><img src="http://p2.qhimg.com/t010baaacab27aa2db8.jpg" title="t01f989e9ec18296e03.jpg" alt="http://p6.qhimg.com/t01f989e9ec18296e03.jpg"/></span></strong></span></p><p style="white-space: normal; text-indent: 2em;"><span style="font-size: 18px; color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">稿费：290RMB（不服你也来投稿啊！）</span></strong></span></p><p style="white-space: normal; text-indent: 2em;"><span style="font-size: 18px; color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></strong><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">投稿方式：发送邮件至</span></strong></span><a href="mailto:linwei@360.cn" target="_self" textvalue="linwei#360.cn" style="text-decoration: none;"><span style="font-size: 18px; color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">linwei#360.cn</span></strong><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></strong></span></a><span style="font-size: 18px; color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">，或登陆</span></strong></span><a href="http://bobao.360.cn/contribute/index" target="_blank" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px; color: rgb(0, 112, 192); text-decoration: none;"><strong>网页版</strong></a><span style="font-size: 18px; color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">在线投稿</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">前言</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">在攻防对抗的博弈中，恶意软件的作者总是想方设法阻止反病毒公司、安全研究人员对其编写的恶意软件进行检测、分析.在对抗中，技术的进步螺旋式上升，那么编写恶意软件的人都采用了哪些技术来对抗分析？这些技术又是如何发展的？反病毒公司如何应对这种挑战？作者 Bartosz Wójcik 给出了自己的观察。</span></p><p style="text-indent: 2em; text-align: left;"><a href="https://www.pelock.com/services" target="_blank" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(255, 0, 0); text-decoration: none;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(255, 0, 0);">逆向工程</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">是指不访问其源代码来分析已编译好的程序的方法。 在这篇文章中，我想说明这是使用恶意软件的编写者阻碍病毒和其他恶意软件分析的方法，我也会解释反病毒公司和反病毒软件是怎么处理的。&nbsp;<br style="color: rgb(44, 62, 80); white-space: normal; background-color: rgb(249, 249, 245);"/>为了使反病毒公司的分析变得困难，首先你需要知道反病毒公司是如何在实验室中分析恶意软件的。最常用的方法如下：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">在虚拟环境中测试恶意软件</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">在沙盒和模拟其中测试恶意软件</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">监控恶意软件对系统所做的更改</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">静态分析</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">动态分析</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">生成恶意软件的签名</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">同时，在用户计算机上运行的反病毒软件可以执行以下检查来帮助判断这个恶意程序的实际意图：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">文件和片段的校验和（例如 </span><a href="https://en.wikipedia.org/wiki/MD5" target="_blank" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80); text-decoration: none;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">MD5</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">、</span><a href="https://en.wikipedia.org/wiki/SHA-1" target="_blank" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80); text-decoration: none;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">SHA1</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">、</span><a href="https://en.wikipedia.org/wiki/SHA-2" target="_blank" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80); text-decoration: none;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">SHA2</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">、</span><a href="https://en.wikipedia.org/wiki/Cyclic_redundancy_check" target="_blank" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80); text-decoration: none;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">CRC32</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">）</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">不寻常的文件结构</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">文件中不寻常的值</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">文件片段的签名（启发式扫描）</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">字符串常量</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">应用程序的行为，被称为行为分析（监控访问系统文件、注册表等）</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">函数调用（调用哪些函数、提供了什么参数，调用顺序）</span></p><p data-anchor-id="ow0q" style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">实验室和反病毒软件都是这么做的，这中间的每一步，都可能遇到专门设计好来阻止或减慢分析的障碍。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">检测虚拟机</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">99％的情况下，恶意软件会被放在虚拟机中进行测试，例如VMware， VirtualBox，Virtual PC，Parallels 等。这是为了保护分析师自己的机器免受感染，这也是时有发生的！ 在2011年，由于反病毒公司 ESET 一个雇员的错误，众所周知的（昂贵的）分析软件 IDA 被盗。&nbsp;</span></p><p data-anchor-id="43t9" style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">通常在反病毒实验室中，恶意软件存储在没有执行权限的文件夹中，特别要防止感染文件或恶意文件的意外执行。虚拟机的使用也允许了额外工具的使用，例如比较感染后的系统映像和感染前的系统映像的区别，哪怕是对系统文件、注册表、其他系统组件极其微小的改变，都可以轻易发现。&nbsp;</span></p><p style="text-align:center"><img src="http://p9.qhimg.com/t01d66cf1730cc4c56c.png" title="t01982f28528b7e46fd.png" alt="http://p0.qhimg.com/t01982f28528b7e46fd.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">运行在虚拟机中的恶意软件的网络流量可以被准确地跟踪（通过网络嗅探器，比如&nbsp;</span><a href="https://www.wireshark.org/" target="_blank" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(255, 0, 0); text-decoration: none;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(255, 0, 0);">Wireshark</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">），这可以证明恶意软件将会和该恶意程序所属的僵尸网络的控制服务进行通信。&nbsp;</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">由于这些原因，恶意软件的作者通常希望阻止恶意软件在虚拟机中运行，但是为了做到这一点，恶意软件必须检测到它在虚拟环境中运行了。虚拟机永远不能和真实计算机一样，因此它们具有那些“给予它们”的特性，例如：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">具有仅在虚拟机中会存在的特定名称的虚拟硬件设备</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">对真实机器不完全、有限的仿真（</span><a href="https://en.wikipedia.org/wiki/Interrupt_descriptor_table" target="_blank" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80); text-decoration: none;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">IDT</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);"> 和 </span><a href="https://en.wikipedia.org/wiki/Global_Descriptor_Table" target="_blank" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80); text-decoration: none;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">GDT</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">&nbsp;表）</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">含糊不清、没有文档记录的 API 在与主机层通信（Virtual PC 使用汇编指令 cmpxchg8b eax 这种魔法一般处理寄存器的方式，就可以确定它的存在）</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">附加的实用工具，比如 VMware Tools，他们的存在可以通过特定系统对象的名字得知（</span><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms686927%28v=vs.85%29.aspx" target="_blank" style="text-decoration: underline; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">互斥体</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">、</span><a href="https://msdn.microsoft.com/en-us/library/windows/desktop/ms682655%28v=vs.85%29.aspx" target="_blank" style="text-decoration: underline; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">事件</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">、类名、窗口名称等）</span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">清单1-使用 API 接口确定 VWware 环境</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:plain;toolbar:false">BOOL&nbsp;IsVMware()
{
&nbsp;&nbsp;&nbsp;&nbsp;BOOL&nbsp;bDetected&nbsp;=&nbsp;FALSE;
&nbsp;&nbsp;&nbsp;&nbsp;__try
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;check&nbsp;for&nbsp;the&nbsp;presence&nbsp;of&nbsp;VMware
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;__asm
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;ecx,0Ah
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;eax,&#39;VMXh&#39;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;dx,&#39;VX&#39;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;in&nbsp;&nbsp;&nbsp;&nbsp;eax,dx
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;cmp&nbsp;&nbsp;&nbsp;&nbsp;ebx,&#39;VMXh&#39;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sete&nbsp;&nbsp;&nbsp;&nbsp;al
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;movzx&nbsp;&nbsp;&nbsp;eax,al
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;bDetected,eax
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;__except(EXCEPTION_EXECUTE_HANDLER)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;if&nbsp;an&nbsp;exception&nbsp;occurs
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;return&nbsp;FALSE
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;FALSE;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;bDetected;
}</pre><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">清单2-通过 Windows 注册表判断虚拟环境</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:plain;toolbar:false">BOOL&nbsp;IsVM()
{
&nbsp;&nbsp;&nbsp;&nbsp;HKEY&nbsp;hKey;
&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;i;
&nbsp;&nbsp;&nbsp;&nbsp;char&nbsp;szBuffer[64];
&nbsp;&nbsp;&nbsp;&nbsp;char&nbsp;*szProducts[]&nbsp;=&nbsp;{&nbsp;&quot;*VMWARE*&quot;,&nbsp;&quot;*VBOX*&quot;,&nbsp;&quot;*VIRTUAL*&quot;&nbsp;};
&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;dwSize&nbsp;=&nbsp;sizeof(szBuffer)&nbsp;-&nbsp;1;
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(RegOpenKeyEx(HKEY_LOCAL_MACHINE,&nbsp;&quot;SYSTEM\\ControlSet001\\Services\\Disk\\Enum&quot;,&nbsp;0,&nbsp;KEY_READ,&nbsp;&amp;hKey)&nbsp;==&nbsp;ERROR_SUCCESS)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(RegQueryValueEx(hKey,&nbsp;&quot;0&quot;,&nbsp;NULL,&nbsp;NULL,&nbsp;(unsigned&nbsp;char&nbsp;*)szBuffer,&nbsp;&amp;dwSize&nbsp;)&nbsp;==&nbsp;ERROR_SUCCESS)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;_countof(szProducts);&nbsp;i++)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(strstr(szBuffer,&nbsp;szProduct[i]))
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;RegCloseKey(hKey);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;TRUE;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;RegCloseKey(hKey);
}
&nbsp;&nbsp;return&nbsp;FALSE;
}</pre><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">清单3-检测 Virutal PC</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:plain;toolbar:false">&nbsp;&nbsp;&nbsp;&nbsp;sub&nbsp;eax,eax&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;prepare&nbsp;magic&nbsp;values
&nbsp;&nbsp;&nbsp;&nbsp;sub&nbsp;edx,edx&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;;&nbsp;in&nbsp;registers
&nbsp;&nbsp;&nbsp;&nbsp;sub&nbsp;ebx,ebx
&nbsp;&nbsp;&nbsp;&nbsp;sub&nbsp;ecx,ecx
&nbsp;&nbsp;&nbsp;&nbsp;db&nbsp;&nbsp;0Fh,&nbsp;0C7h,&nbsp;0C8h&nbsp;;&nbsp;&#39;cmpxchg8b&nbsp;eax&#39;&nbsp;instruction
;&nbsp;if&nbsp;Virtual&nbsp;PC&nbsp;is&nbsp;present,&nbsp;after&nbsp;performing&nbsp;cmpxchg8b&nbsp;eax
;&nbsp;register&nbsp;EAX&nbsp;=&nbsp;1&nbsp;and&nbsp;there&nbsp;will&nbsp;be&nbsp;no&nbsp;exception
;&nbsp;otherwise&nbsp;an&nbsp;exception&nbsp;will&nbsp;occur</pre><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">清单4-检测 VirutalBox</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:plain;toolbar:false">BOOL&nbsp;IsVirtualBox()
{
&nbsp;&nbsp;&nbsp;&nbsp;BOOL&nbsp;bDetected&nbsp;=&nbsp;FALSE;
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;is&nbsp;the&nbsp;VirtualBox&nbsp;helper&nbsp;library
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;installed&nbsp;in&nbsp;the&nbsp;system?
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(LoadLibrary(&quot;VBoxHook.dll&quot;)&nbsp;!=&nbsp;NULL)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bDetected&nbsp;=&nbsp;TRUE;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;is&nbsp;the&nbsp;VirtualBox&nbsp;support&nbsp;device
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;installed&nbsp;in&nbsp;the&nbsp;system?
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(CreateFile(&quot;\\\\.\\VBoxMiniRdrDN&quot;,&nbsp;GENERIC_READ,&nbsp;\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILE_SHARE_READ,&nbsp;NULL,&nbsp;OPEN_EXISTING,&nbsp;\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FILE_ATTRIBUTE_NORMAL,&nbsp;NULL)&nbsp;\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;!=&nbsp;INVALID_HANDLE_VALUE)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bDetected&nbsp;=&nbsp;TRUE;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;bDetected;
}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">讽刺的是，如果有检测虚拟环境存在的功能会提醒分析师这很可能就是一个恶意程序，他正在试图避免在一个安全的环境内被分析。不过，这种函数通常也被版权保护和内容保护软件使用。例如，现在常见的多媒体平台 Ipla.tv 在检测到正在虚拟环境中执行时拒绝播放节目。出于兴趣，我查看了一下这个播放器使用的库文件，不过在调试器的帮助下，禁用这个负责检测虚拟环境的功能是很容易的。&nbsp;</span></p><p data-anchor-id="e9oh" style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">一些软件发布商也阻止他们的应用程序在虚拟机中运行，这是一个非常实际的原因——盗版。他们将软件的运行限定在某台机器上（例如通过机器硬件配置文件生成许可证密钥）。当软件安装在虚拟机中时，可以很容易的将虚拟机映像复制到所需要的多个物理计算机上，并且这些计算机都会拥有相同的硬件配置文件，从而允许软件在多台计算机中运行了。</span></p><p data-anchor-id="e9oh" style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">沙盒</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">沙盒就是一个和外部世界独立的安全环境，你可以在其中运行恶意程序并监视它们的活动。沙盒可以作为和主机系统相互独立地存在。最知名的是：</span></p><p style="text-indent: 2em; text-align: left;"><a href="http://www.cuckoosandbox.org/" target="_blank" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(255, 0, 0); text-decoration: none;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(255, 0, 0);">Cuckoo Sandbox</span></a></p><p style="text-indent: 2em; text-align: left;"><a href="http://anubis.iseclab.org/" target="_blank" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(255, 0, 0); text-decoration: none;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(255, 0, 0);">Anubis Sandbox</span></a></p><p style="text-indent: 2em; text-align: left;"><a href="http://www.norman.com/" target="_blank" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(255, 0, 0); text-decoration: none;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(255, 0, 0);">Norman Sandbox</span></a></p><p style="text-indent: 2em; text-align: left;"><a href="http://www.joesecurity.org/" target="_blank" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(255, 0, 0); text-decoration: none;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(255, 0, 0);">Joe Sandbox</span></a></p><p style="text-indent: 2em; text-align: left;"><a href="http://www.threattracksecurity.com/resources/sandbox-malware-analysis.aspx" target="_blank" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(255, 0, 0); text-decoration: none;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(255, 0, 0);">VIPRE ThreatAnalyzer</span></a></p><p style="text-indent: 2em; text-align: left;"><a href="http://bsa.isoftware.nl/" target="_blank" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(255, 0, 0); text-decoration: none;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(255, 0, 0);">Buster Sandbox Analyzer</span></a></p><p data-anchor-id="mjen" style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">这些都是可以运行任何软件的虚拟环境，由于内置了监视工具，它们可以提供软件在启动后对系统所做更改的详细日志。通常他们基于仿真的 Windows 环境中，而且你可以很容易地检测到它们这些特性。在地下论坛上，你可以很容易的看到这种例子：</span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">清单5-检测 Norman 沙盒</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:plain;toolbar:false">;&nbsp;load&nbsp;the&nbsp;address&nbsp;of&nbsp;the&nbsp;function&nbsp;DecodePointer(),&nbsp;which
;&nbsp;in&nbsp;a&nbsp;Norman&nbsp;Sandbox&nbsp;environment&nbsp;contains
;&nbsp;a&nbsp;different&nbsp;list&nbsp;of&nbsp;instructions
;&nbsp;to&nbsp;a&nbsp;real&nbsp;Windows&nbsp;system
;&nbsp;DecodePointer:
;.7C80644E|&nbsp;C8&nbsp;00&nbsp;00&nbsp;00&nbsp;enter&nbsp;&nbsp;&nbsp;0,0
;.7C806452:&nbsp;8B&nbsp;45&nbsp;08&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;eax,[ebp][18]
;.7C806455:&nbsp;0F&nbsp;C8&nbsp;&nbsp;&nbsp;bswap&nbsp;&nbsp;&nbsp;eax
;.7C806457:&nbsp;C9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;leave
;.7C806458:&nbsp;C2&nbsp;04&nbsp;00&nbsp;&nbsp;&nbsp;&nbsp;retn&nbsp;&nbsp;&nbsp;&nbsp;4
;&nbsp;load&nbsp;the&nbsp;address&nbsp;of&nbsp;DecodePointer
&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;eax,DecodePointer
&nbsp;&nbsp;&nbsp;&nbsp;test&nbsp;&nbsp;&nbsp;&nbsp;eax,eax
&nbsp;&nbsp;&nbsp;&nbsp;je&nbsp;&nbsp;_not_detected
;&nbsp;verify&nbsp;the&nbsp;byte&nbsp;signature
&nbsp;&nbsp;&nbsp;&nbsp;cmp&nbsp;dword&nbsp;ptr[eax],000000C8h
&nbsp;&nbsp;&nbsp;&nbsp;jne&nbsp;_not_detected
&nbsp;&nbsp;&nbsp;&nbsp;cmp&nbsp;dword&nbsp;ptr[eax+4],0F08458Bh
&nbsp;&nbsp;&nbsp;&nbsp;jne&nbsp;_not_detected
&nbsp;&nbsp;&nbsp;&nbsp;cmp&nbsp;dword&nbsp;ptr[eax+8],04C2C9C8h
&nbsp;&nbsp;&nbsp;&nbsp;jne&nbsp;_not_detected
;&nbsp;the&nbsp;presence&nbsp;of&nbsp;the&nbsp;Norman&nbsp;Sandbox&nbsp;environment&nbsp;has&nbsp;been&nbsp;detected
;&nbsp;terminate&nbsp;the&nbsp;application
&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;&nbsp;0
&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;&nbsp;ExitProcess
;&nbsp;continue&nbsp;the&nbsp;application
_not_detected:</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">清单中的沙盒原来大多数都是免费的，随着几个商业化后，只有少数几个继续免费，如 Anubis 沙盒。&nbsp;</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">沙盒不需要模拟完整的系统，将沙盒集成到反病毒软件中，或者像&nbsp;</span><a href="http://www.sandboxie.com/" target="_blank" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(255, 0, 0); text-decoration: none;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(255, 0, 0);">Sandboxie</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;这种特定应用程序的沙盒正在变得越来越受欢迎。它们允许在安全的操作环境中执行任何应用程序，以保护敏感的系统组件受到修改。&nbsp;</span></p><p style="text-align:center"><img src="http://p9.qhimg.com/t011f65646d0757e67a.png" title="t01f825f41d5aa1757a.png" alt="http://p0.qhimg.com/t01f825f41d5aa1757a.png"/></p><p data-anchor-id="lcug" style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Sandboxie 不会将修改写入磁盘，也不会修改任何系统文件，只会产生<span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 32px;">分析</span>时<span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 32px;">便于</span>使用的外部文件。这种系统的运行依赖于系统底层的钩子（重写底层操作系统函数）以及使用额外的驱动程序、控制应用程序的行为。你可能已经猜到了，这些机制可以被恶意软件作者用来检测沙盒工具。</span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">清单6-检测 Sandboxie 环境</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:plain;toolbar:false">BOOL&nbsp;IsSandboxie()
{
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;check&nbsp;if&nbsp;the&nbsp;Sandboxie&nbsp;helper&nbsp;library
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;is&nbsp;loaded&nbsp;in&nbsp;our&nbsp;process
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(GetModuleHandle(&quot;SbieDll.dll&quot;)&nbsp;!=&nbsp;NULL)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;TRUE;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;FALSE;
}</pre><p style="text-indent: 2em; text-align: left;"><strong style="font-size: 18px; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></strong></p><p style="text-indent: 2em; text-align: left;"><strong style="font-size: 18px; text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">阻止代码分析</span></strong><br/></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">使用像 IDA 反汇编器和 HexRays 反编译器来分析可疑文件是业界通用的惯例。这些工具允许对编译好的程序进行汇编级别的分析，如果可能还可以还原成更高级别的语言。&nbsp;</span></p><p style="text-align:center"><img src="http://p6.qhimg.com/t01987652fa077c44d6.png" title="t0102fa3718e3269116.png" alt="http://p3.qhimg.com/t0102fa3718e3269116.png"/></p><p data-anchor-id="ftry" style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">为了让这些程序执行静态分析，就必须访问未加密的可执行文件，恶意软件的作者可以基于此来让分析变得困难，甚至不可能，致使分析师必须在分析前做额外的工作。</span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">加密</span></strong></span><br/></p><p data-anchor-id="nvnc" style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">加密是最基本的手段，用来加密整个可执行文件。这些加密工具都有同一个目的，防止恶意软件被反病毒程序检测。这些加密工具在地下论坛中卖数十美元，并且每个客户会使用唯一的副本以避免被先用的反病毒程序的签名数据库检测到。&nbsp;<br/>加密工具的基础是：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">加密整个可执行程序</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">将其附加到一个装载程序中，作为一个嵌入的资源，或者放在在文件的结尾（也就是所谓的叠加）</span></p><p data-anchor-id="edce" style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">运行一个以这种方式准备好的程序后，可能发生两种情况，取决于恶意软件作者怎么做：简单情况下，文件被解密，解包到临时目录，并且从此处运行。更高级的做法是加载程序的代码段和数据段被取消内存映射，用解密后的可执行文件替换，之后开始运行。</span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">加壳</span></strong></span></p><p data-anchor-id="zv4h" style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">UPX, FSG, MEW, ASpack, and&nbsp;</span><a href="https://www.pelock.com/products/netshrink" target="_blank" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(255, 0, 0); text-decoration: none;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(255, 0, 0);">.netshrink</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;这些壳都可以被用于减少可执行文件的大小。它们通常在可执行文件中插入一段结构，将一种压缩算法放在里面，制作一个装载程序。装载程序通常很小，常常用汇编语言编写。当这样一个打包好的程序运行时，由装载程序控制解压缩代码和数据、恢复可执行程序的文件结构，例如从导入表加载函数。然后从没打包时的原始程序入口点开始执行代码。&nbsp;</span></p><p style="text-align:center"><img src="http://p8.qhimg.com/t0168453db2fd1ca7c0.png" title="t01c1823f192edc5056.png" alt="http://p8.qhimg.com/t01c1823f192edc5056.png"/></p><p data-anchor-id="zv4h" style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">这种压缩不会对真正的代码分析造成任何困难，它唯一能实现的事情就是在反病毒程序的潜在签名被改变了。现在可以自动脱壳大多数流行的加壳程序，无论是专用的脱壳模块还是通过仿真使用，并可以分析原始文件中的签名。</span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">压缩</span></strong></span></p><p data-anchor-id="7ai9" style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">虽然加壳只能有助于减少可执行文件的大小，但是其受欢迎程度已经导致那些想使用加壳程序的人，还想让程序具有更难得到原始可执行代码的优势。因此混淆出现了，它们可以“争先恐后”地操作已经压缩好的程序，比如它们可能会更改节的名称、添加新的代码，然后启动解压缩程序。例如UPX-SCRAMBLER 和 UPolyX 以及非常流行的 UPX 压缩壳。</span></p><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 112, 192);">综合保护</span></strong></p><p data-anchor-id="dhjd" style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">演变的下一个阶段就是像&nbsp;</span><a href="https://www.pelock.com/products/pelock" target="_blank" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(255, 0, 0); text-decoration: none;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(255, 0, 0);">PELock</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">, ASProtect, ExeCryptor 和 Armadillo 这种保护器。它们不仅能压缩可执行程序，还能添加代码来检测调试工具的存在，并且破坏或隐藏可执行程序的真实结构，使得恢复原始可执行程序的内容更加困难。保护器的一个重要部分是它们内置的强大加密算法，像 ECC（椭圆曲线加密）或&nbsp;</span><a href="https://en.wikipedia.org/wiki/RSA_%28cryptosystem%29" target="_blank" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(255, 0, 0); text-decoration: none;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(255, 0, 0);">RSA</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(255, 0, 0); text-decoration: none;">&nbsp;</span><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">加密。&nbsp;<br/>通常对特定区域进行加密，这段区域以特殊标记指明。当程序运行，指定标记间区域的代码在没有正确的许可密钥时无法被解密，甚至直到其需要运行前仍然是加密的。运行时被暂时解密，一旦运行完毕就会返回加密状态。</span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">清单7-在 PELock 中使用加密标志的例子</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:plain;toolbar:false">#include&nbsp;&lt;windows.h&gt;
#include&nbsp;&lt;stdio.h&gt;
#include&nbsp;&lt;conio.h&gt;
#include&nbsp;&quot;pelock.h&quot;
int&nbsp;main(int&nbsp;argc,&nbsp;char&nbsp;*argv[])
{
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;code&nbsp;between&nbsp;the&nbsp;markers&nbsp;DEMO_START&nbsp;and&nbsp;DEMO_END
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;will&nbsp;be&nbsp;encrypted&nbsp;in&nbsp;the&nbsp;protected&nbsp;file
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;and&nbsp;will&nbsp;not&nbsp;be&nbsp;accessible&nbsp;(or&nbsp;executed)&nbsp;without
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;the&nbsp;correct&nbsp;licence&nbsp;key
&nbsp;&nbsp;&nbsp;&nbsp;DEMO_START
&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;Welcome&nbsp;to&nbsp;the&nbsp;full&nbsp;version&nbsp;of&nbsp;my&nbsp;application!&quot;);
&nbsp;&nbsp;&nbsp;&nbsp;DEMO_END
&nbsp;&nbsp;&nbsp;&nbsp;printf(&quot;\n\nPress&nbsp;any&nbsp;key&nbsp;to&nbsp;continue...&quot;);
&nbsp;&nbsp;&nbsp;&nbsp;getch();
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0;
}</pre><p style="text-indent: 2em; text-align: left;"><span style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">这种程度的复杂保护对于破解者是一个现实的问题。虽然这对于软件作者来说一般是好的，但是这使得病毒分析师难以生存，因为这允许了恶意软件作者使用高级加密技术，这使恶意程序的行为分析特别困难。在这种系统中，你经常会发现</span><a href="https://www.pelock.com/pl/artykuly/polimorficzne-algorytmy-szyfrowania" target="_blank" style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(255, 0, 0); text-decoration: none;"><span style="color: rgb(255, 0, 0);">多态的加密算法</span></a><span style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">（受保护的程序每次都重新生成唯一的加密算法）、代码突变（一系列的程序集替换，这些替换更加复杂但是等效）、代码虚拟化（原生代码被字节码替换），随着将反调试招数都整合在一起，我们已经很难对其代码进行分析、了解它们是如何工作的了。&nbsp;</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">保护的措施有：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">重定向导入表-混淆使用的函数的真实地址-更难从受保护的程序中重建导入表</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">将文件的映像重定位到内存中的随机区域-阻止其从内存中直接将解密后的程序 dump 下来</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">检测调试和系统监控工具</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">以发现代码更改为目的主动监控引用程序代码</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">检测虚拟环境和沙盒</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">检测仿真器</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">通过模拟某些用来访问功能的函数来隐藏资源等结构</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">结合许多应用程序文件和库到一个可执行程序中，并且使用函数访问钩子来模拟存在</span></p><p style="text-indent: 2em; text-align: left;"><strong style="color: rgb(0, 112, 192); text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">虚拟化</span></strong><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">CodeVirtualizer 和 VMProtect 都是以上技术的接班人，这些工具可以让应用程序的原生代码与字节码进行替换，以这种方式保护的应用程序必须配备有执行字节码的虚拟机。&nbsp;</span></p><p data-anchor-id="k8th" style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">分析那些已经替换过的字节码是非常困难的，因为他们不能直接被 IDA 和 OllyDbg 这种标准工具进行分析，这些工具不能得到中间代码的格式。更高级的虚拟机能够在每次保护可执行文件时生成唯一的字节码，从而进一步使分析受保护的应用程序变得更加复杂。&nbsp;<br/>在这些情况下，必须编写特殊的模块来将中间代码转换成 x86 代码。这是一个艰苦而又耗时的任务，而且上面提到的全部保护措施都可以与虚拟化结合起来，让分析变得更加不可能。</span></p><p style="text-indent: 2em; text-align: left;"><strong style="color: rgb(0, 112, 192); text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">混淆</span></strong><br/></p><p style="text-indent: 2em; text-align: left;"><a href="https://www.pelock.com/products/autoit-obfuscator" target="_blank" textvalue="混淆" style="color: rgb(255, 0, 0); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: none;"><span style="color: rgb(255, 0, 0); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">混淆</span></a><span style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">的目的是让编译好的应用程序或者源代码都尽量变得不可能分析。&nbsp;</span></p><p data-anchor-id="z4uk" style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">混淆大多数用在那些被编译成字节码的应用程序中，比如 Java 和 .NET 应用程序，也有像 Pythia 这种为 Delphi 应用程序开发的混淆器。但是这些工具大多数都用于 .NET 应用程序。用 Visual Basic 编写的程序可以多达六个版本，从原生的指令到需要额外库和虚拟运行时的字节码。而 Visual Basic 的规格是不公开的，分析其应用程序是有挑战性的。然而，通过试错，创建了一些非官方工具来对这样的应用程序进行反编译。&nbsp;<br/>随着 C# 和 VB.NET 的出现，微软发布了虚拟机的规范。原来反编译这样程序的字节码是如此简单！知名的工具像&nbsp;.NET Reflector&nbsp;的出现，可以实现应用程序到源码的一键转换。这让软件作者很是头疼，没过多久，市场就出现了几十个工具，这些工具都能对 .NET 应用程序中的字节码（中间语言）进行混淆。这些混淆器一般都采用了如下技术：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">修改指令序列执行顺序（从线性到无条件跳转的非线性）</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">.NET 代码的动态加密</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">加密 .NET 应用程序的资源</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">加密字符串值</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">编译好代码的额外虚拟化层</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">.NET 应用程序文件结构的蓄意破坏</span></p><p data-anchor-id="hbeh" style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">现在存在的大量保护程序，大多采用类似的保护机制。混淆工具的泛滥导致许多去混淆工具的产生，以 2011 年 de4dot 的产生为终点，这是一个通用的 .NET 应用程序通用去混淆工具。它可以去除超过二十种最流行的混淆方案，像 SmartAssembly、.NET Reactor、Dotfuscator、Eazfuscator 和许多其他的方案，这是给软件安全行业一记响亮的耳光， de4dot 不断开发和维护以支持最新的软件保护方案。&nbsp;<br/>有趣的是，混淆器的价格要远比那些保护原生应用程序的软件要贵，在 .NET 平台上，复杂的 EXE 保护方案和代码虚拟化可以取得比混淆器更好的效果，最好的例子就是前面提到的 de4dot，仅此一点就可以扭转应用在 .NET 应用程序上的诸多保护措施。但是对于原生应用程序就没有如此通用的工具存在。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">利益冲突</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">计算机程序保护的问题在保护系统提供商和反病毒公司之间已经成为了一种巨大的问题：合法的版权保护措施会被反病毒软件报告为病毒。保护系统的作者会因此失去他们的潜在客户，而看似反病毒公司和保护系统的斗争其实是与恶意程序的斗争。</span><a href="http://standards.ieee.org/" target="_blank" style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">IEEE</a><span style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;协会试图规范保护系统制造者和反病毒公司之间的信息交流。该系统被称为 TAGGANT，将需要进行商业保护系统保护的每一个文件进行标记，并带有购买人或者公司的签名。有这样标记的文件将不再被反病毒程序标记为病毒，如果合法的保护方案被以某种方式应用在保护恶意程序中（例如恶意软件作者使用被盗的信用卡详细信息来购买保护方案），客户的签名就会被公开放在黑名单中，并且和该用户签名相关的所有文件都会被标记为潜在的恶意程序。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">调试器检测</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">如果恶意程序较为复杂，像 IDA（反汇编）或 HexRays（反编译）此类的代码静态分析工具不能提供分析师判断恶意程序做了什么的信息，下一个分析师可以用的工具是调试器 - 允许逐步跟踪程序执行的工具。&nbsp;</span></p><p data-anchor-id="yh9j" style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">其中最流行的调试工具：内置于商业 IDA 反汇编器（32位和64位支持）的调试器，免费的 WinDbg，以及免费的（据我所知最流行的调试器）OllyDbg ，它允许在用户态下跟踪应用程序（OllyDbg 的的一个缺点是，它被限制为32位应用程序）。&nbsp;</span></p><p style="text-align:center"><img src="http://p0.qhimg.com/t014f6b22194f83bcc7.png" title="t01d1f564db2df831da.png" alt="http://p2.qhimg.com/t01d1f564db2df831da.png"/></p><p data-anchor-id="yh9j" style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">OllyDbg 的流行产生了一系列应对反调试器功能的改进和扩展，这些让各种应用程序的分析都变得容易。比如引入一种脚本语言，它可以自动完成调试器能做的工作，这让自动化脱所有已知种类的壳变得非常轻松。&nbsp;<br/>另一方面，又有很多种方法可以检测这个调试器，并且恶意软件的作者都很愿意使用它们，因为这样会使得他们的代码更加难以分析。</span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">清单8-检测 OllyDby（作者&nbsp;</span></strong></span><a href="http://waleedassar.blogspot.com/" target="_blank" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline; color: rgb(0, 112, 192);"><span style="color: rgb(0, 112, 192);"><strong><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Walied Assar</span></strong></span></a><span style="color: rgb(0, 112, 192);"><strong><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">）</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:plain;toolbar:false">int&nbsp;__cdecl&nbsp;Hhandler(EXCEPTION_RECORD*&nbsp;pRec,void*,unsigned&nbsp;char*&nbsp;pContext,void*)
{
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(pRec-&gt;ExceptionCode==EXCEPTION_BREAKPOINT)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(*(unsigned&nbsp;long*)(pContext+0xB8))++;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MessageBox(0,&quot;Expected&quot;,&quot;waliedassar&quot;,0);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ExitProcess(0);
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;ExceptionContinueSearch;
}
void&nbsp;main()
{
&nbsp;&nbsp;&nbsp;&nbsp;__asm
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;offset&nbsp;Hhandler
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;dword&nbsp;ptr&nbsp;fs:[0]
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;dword&nbsp;ptr&nbsp;fs:[0],esp
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;RaiseException(EXCEPTION_BREAKPOINT,0,1,0);
&nbsp;&nbsp;&nbsp;&nbsp;__asm
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pop&nbsp;dword&nbsp;ptr&nbsp;fs:[0]
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pop&nbsp;eax
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;MessageBox(0,&quot;OllyDbg&nbsp;Detected&quot;,&quot;waliedassar&quot;,0);
}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">几年前，有一个著名的调试器叫做 SoftICE，它是一个系统调试器（它可以跟踪用户模式的应用程序和系统驱动程序）。现在它已经被 WinDbg 取代了，虽然已经坚持了很多年的开发和升级。系统调试器（或者说内核模式调试器）可以在应用程序使用系统驱动时调用。比如一个 Rootkit，它主要的目的就是把负载埋进操作系统中（通常以用户模式开始），以此来隐蔽恶意软件的进程、对文件系统结构的破坏、隐藏网络通信。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px;">迭代更新</span></strong></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">你可以使用非常多的方法来检测恶意软件，无论是校验和、文件片段、特征字符串、函数调用顺序、使用非常用函数、行为分析、高级签名等。这些特性会引导反病毒软件将其分为恶意还是正常。&nbsp;</span></p><p data-anchor-id="ymlp" style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">这样是建立在假设恶意软件每次都表现出相同的特征的基础上的，修改这些特征中的某一部分就可以逃避检测，在不修改恶意软件源代码的情况下，怎么可以达到这种效果呢？</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">更换编译器</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">对编译选项的更改（比如打开或者关闭优化或者更改默认调用约定）会立即更改输出文件的结构</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">频繁更新和编译选项的更改相结合，将会导致在二进制级别上完全不同的生成文件，但他们可以表现出相同的功能</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">函数替换</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">俗话说：“条条大路通罗马”。在编写恶意软件时，有很多方法可以达到相同的效果。例如，为了获取对文件的访问，可以有很多 Windows 系统函数和附加库函数使用。</span></p><p style="text-align:center"><img src="http://p4.qhimg.com/t0139eef5746cd63224.jpg" title="t01540e2c924391e0f1.jpg" alt="http://p6.qhimg.com/t01540e2c924391e0f1.jpg"/></p><p data-anchor-id="69qn" style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">还有其他几十个库也提供类似的功能，可以用作替代品。</span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">清单9-几种读文件的方式</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:plain;toolbar:false">#include&nbsp;&lt;windows.h&gt;
#include&nbsp;&lt;stdio.h&gt;
//&nbsp;mode&nbsp;used&nbsp;to&nbsp;open&nbsp;a&nbsp;file
#define&nbsp;FILE_MODE&nbsp;3
int&nbsp;main()
{
&nbsp;&nbsp;&nbsp;&nbsp;#if&nbsp;FILE_MODE&nbsp;==&nbsp;1
&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;hFile&nbsp;=&nbsp;CreateFileA(&quot;notepad.exe&quot;,&nbsp;GENERIC_READ&nbsp;|&nbsp;GENERIC_WRITE,&nbsp;0,&nbsp;NULL,&nbsp;OPEN_EXISTING,&nbsp;0,&nbsp;NULL);
&nbsp;&nbsp;&nbsp;&nbsp;#elif&nbsp;FILE_MODE&nbsp;==&nbsp;2
&nbsp;&nbsp;&nbsp;&nbsp;HANDLE&nbsp;hFile&nbsp;=&nbsp;CreateFileW(L&quot;notepad.exe&quot;,&nbsp;GENERIC_READ&nbsp;|&nbsp;GENERIC_WRITE,&nbsp;0,&nbsp;NULL,&nbsp;OPEN_EXISTING,&nbsp;0,&nbsp;NULL);
&nbsp;&nbsp;&nbsp;&nbsp;#elif&nbsp;FILE_MODE&nbsp;==&nbsp;3
&nbsp;&nbsp;&nbsp;&nbsp;FILE&nbsp;*hFile&nbsp;=&nbsp;fopen(&quot;notepad.exe&quot;,&nbsp;&quot;rb+&quot;);
&nbsp;&nbsp;&nbsp;&nbsp;#else
&nbsp;&nbsp;&nbsp;&nbsp;//...
&nbsp;&nbsp;&nbsp;&nbsp;#endif
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;close&nbsp;file&nbsp;handle
&nbsp;&nbsp;&nbsp;&nbsp;#if&nbsp;FILE_MODE&nbsp;&lt;&nbsp;3
&nbsp;&nbsp;&nbsp;&nbsp;CloseHandle(hFile);
&nbsp;&nbsp;&nbsp;&nbsp;#else
&nbsp;&nbsp;&nbsp;&nbsp;fclose(hFile);
&nbsp;&nbsp;&nbsp;&nbsp;#endif
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0;
}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">在特定函数被使用的时候，也许会被标记为“危险”，但是这种方式仍然创造了全新的代码结构，可以帮助恶意软件逃避检测。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">脚本代替程序</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">某些任务可以由脚本语言，像 VBScript 或者 JScript，来执行，避开调用系统函数。恶意软件有时候也会包含脚本语言的解释器，比如 Flame 中的 Lua、</span><a href="http://ironpython.net/" target="_blank" style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">IronPython</a><span style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;中的 Python、甚至是 PHP。一旦源代码被隔离，分析脚本总好过分析编译好的程序，但是恶意软件作者可选择的大量不同的语言为病毒分析师和反病毒公司造成了巨大困扰。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">模块化设计</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">恶意软件并不总是立即安装在感染主机上，通常来说感染模块的规模相当小，感染后会连接到控制服务器来下载附加模块。此设计还帮助恶意软件作者可以轻松地添加新功能或修复 Bug。对于分析师来说，当恶意软件都在一个程序中时，事情反而变得容易了。当恶意软件分裂成不同的模块时，分析会变慢，特别是用不用的语言编写的不同模块，并且每个模块都是用不同的措施来进行保护。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">小众语言</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">恶意软件往往会使用流行的语言来编写，在我看来这是因为：一、这种软件可以在许多版本的 Windows 上不需要其他系统组件就运行；二、有大量的教程和与其语言相关的源码实例，即使是新手也可以很容易的创建恶意程序。&nbsp;</span></p><p data-anchor-id="2x6n" style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">某些恶意软件作者更加高明，意识到使用流行的语言将会使他们开发的程序易于分析，这些语言都有现成的工具可以使用。病毒分析师每天都要处理这些流行的语言，他们配备并熟练使用相关工具，把这些程序分解成基本模块易如反掌。&nbsp;<br/>另一方面，用小众语言编写的程序例如函数式语言或者面向业务型语言，对分析师来说是个巨大的挑战。比如：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">Haskell</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">Lisp</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">VisualFox Pro</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">Fortran</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">COBOL</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">非标准的 Visual Basic 编译器(像 </span><a href="http://www.thegamecreators.com/?m=view_product&id=2030" target="_blank" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80); text-decoration: none;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">DarkBasic</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">、</span><a href="http://www.purebasic.com/" target="_blank" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80); text-decoration: none;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">PureBasic</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">)</span></p><p data-anchor-id="ud0w" style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">这样的程序通常有着相当复杂的结构，在许多情况下，他们的整个代码以一种字节码的形式存在，或者是需要分析许多额外的库、都不用提有多耗时。也有一些为这些小众的语言编写的反编译工具，比如 VisualFox Pro 应用程序反编译可以使用 ReFox，但是这样的工具在这个领域内是极其罕见的，因为需求太少了。&nbsp;<br/>著名的 Stuxnet 病毒是利用 C 语言和一个不起眼的面向对象框架写成的，分析师花了很长时间才搞清楚，它是用什么写成的，为什么有如此不寻常的结构。&nbsp;</span></p><p data-anchor-id="ud0w" style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">在这篇文章的末尾，你可以找到一个 Crackme，是用 Haskell 语言写成的，尽管这只是一个简单用来检查许可证密钥有效性的算法，但是分析起来仍然特别困难。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">自动化软件</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">市场上有一些软件包允许使用者只需要少量的技术能力就可以创建一个能够完全访问系统文件、从网络上加载组件、访问 Windows 注册表的程序。例如：</span></p><p style="text-indent: 2em; text-align: left;"><a href="https://www.autoitscript.com/site/autoit/" target="_blank" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80); text-decoration: none;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">AutoIt</span></a></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">Winbatch</span></p><p style="text-indent: 2em; text-align: left;"><a href="http://www.macros.com/" target="_blank" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80); text-decoration: none;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">Macro Express</span></a></p><p data-anchor-id="zg4v" style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">使用这些工具创建的应用程序不太可能被检测到，因为他们的代码通常采用中间语言的形式，而且需要特定的反编译器来分析它的行为。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">源码修改</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">源码修改是创建输出文件最高级的方法之一，那么怎样修改源码才能产生不同的输出文件呢？</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">使得源码突变，比如通过使用模版</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">在源文件中重新排序函数</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">改变各个功能的优化选项</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">将伪参数引入函数并伪造他们的用法（编译器可以优化删除未使用的参数）</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">在代码行之间引入垃圾（比如执行不必要的任务的垃圾指令、彼此跳转的指令、函数参数的不必要检验、对本地变量不必要的引用）</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">非线性执行代码（比如 switch）</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 176, 80);">结构定义的改变，即数据结构成员的随机排列或引入虚拟字段</span></p><p data-anchor-id="nd13" style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">所有这些更改都能在出书文件中引发重大变化。</span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">清单10-在 Delphi 代码中增加垃圾指令</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:plain;toolbar:false">procedure&nbsp;TForm1.FormCreate(Sender:&nbsp;TObject);
begin
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;junk&nbsp;instructions&nbsp;(these&nbsp;instructions
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;do&nbsp;not&nbsp;have&nbsp;any&nbsp;impact&nbsp;on&nbsp;the&nbsp;behaviour
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;of&nbsp;the&nbsp;application)
&nbsp;&nbsp;&nbsp;&nbsp;asm
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;db&nbsp;0EBh,02h,0Fh,078h
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;db&nbsp;0EBh,02h,0CDh,20h
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;db&nbsp;0EBh,02h,0Bh,059h
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;db&nbsp;0EBh,02h,038h,045h
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;db&nbsp;0E8h,01h,00h,00h,00h,0BAh,8Dh,64h,24h,004h
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;db&nbsp;07Eh,03h,07Fh,01h,0EEh
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;db&nbsp;0E8h,01h,00h,00h,00h,03Ah,8Dh,64h,24h,004h
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;db&nbsp;0EBh,02h,03Eh,0B8h
&nbsp;&nbsp;&nbsp;&nbsp;end;
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;This&nbsp;line&nbsp;will&nbsp;be&nbsp;unreadable&nbsp;by
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;a&nbsp;disassembler,&nbsp;thanks&nbsp;to
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;the&nbsp;junk&nbsp;instructions
&nbsp;&nbsp;&nbsp;&nbsp;Form1.Caption&nbsp;:=&nbsp;&#39;Hello&nbsp;world&#39;;
&nbsp;&nbsp;&nbsp;&nbsp;asm
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;db&nbsp;070h,03h,071h,01h,0Ch
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;db&nbsp;0EBh,02h,0Fh,037h
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;db&nbsp;072h,03h,073h,01h,080h
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;db&nbsp;0EBh,02h,0CDh,20h
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;db&nbsp;0EBh,02h,0Fh,0BBh
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;db&nbsp;078h,03h,079h,01h,0B7h
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;db&nbsp;0EBh,02h,094h,05Ch
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;db&nbsp;0C1h,0F0h,00h
&nbsp;&nbsp;&nbsp;&nbsp;end;
end;</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">我见过修改源码最先进的工具是由 Syncrosoft 开发的 MCFACT 系统，用于保护知名音响制造公司 Steinberg 的 Cubase 套件。该系统会首先分析源码，然后将其转换为受保护的形式。</span></p><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 112, 192);">清单11-经过 MCFACT 系统后的 C++ 代码</span></strong></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:plain;toolbar:false">//MCFACT_PROTECTED
unsigned&nbsp;int&nbsp;findInverse(unsigned&nbsp;int&nbsp;n)
{
&nbsp;&nbsp;&nbsp;&nbsp;unsigned&nbsp;int&nbsp;test&nbsp;=&nbsp;1;
&nbsp;&nbsp;&nbsp;&nbsp;unsigned&nbsp;int&nbsp;result&nbsp;=&nbsp;0;
&nbsp;&nbsp;&nbsp;&nbsp;unsigned&nbsp;int&nbsp;mask&nbsp;=&nbsp;1;
&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;(test&nbsp;!=&nbsp;0)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(mask&nbsp;&amp;&nbsp;test)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;result&nbsp;|=&nbsp;mask;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;//MCFACT_AUTHORIZED
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;test&nbsp;-=&nbsp;n;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mask&nbsp;&lt;&lt;=&nbsp;1;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;n&nbsp;&lt;&lt;=&nbsp;1;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;result;
}
//&nbsp;code&nbsp;after&nbsp;protection
unsigned&nbsp;int&nbsp;findInverse(unsigned&nbsp;int&nbsp;n)
{
&nbsp;&nbsp;&nbsp;&nbsp;...
&nbsp;&nbsp;&nbsp;&nbsp;class&nbsp;_calculations_cpp_test_0&nbsp;test=((_init0_0::_init0)());
&nbsp;&nbsp;&nbsp;&nbsp;class&nbsp;_calculations_cpp_result_0&nbsp;result=((_init1_0::_init1)());
&nbsp;&nbsp;&nbsp;&nbsp;class&nbsp;_calculations_cpp_mask_0&nbsp;mask=((_init2_0::_init2)());
&nbsp;&nbsp;&nbsp;&nbsp;_cycle1:{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;signed&nbsp;char&nbsp;tmp8;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((tmp8)=((IsNotEqual)((test),&nbsp;(_calculations_cpp_c_0_0))));
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;((tmp8))&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;unsigned&nbsp;int&nbsp;tmp7;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((And)((mask),&nbsp;(test),&nbsp;(tmp7)));
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;((tmp7))&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((Or)((result),&nbsp;(mask),&nbsp;(result)));
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((Sub)((test),&nbsp;(n),&nbsp;(test)));
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((ShiftLeftOne)((mask),&nbsp;(mask)));
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;((n)&lt;&lt;=(1U));
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto&nbsp;_cycle1;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;}
&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;unsigned&nbsp;int&nbsp;tmp9;
&nbsp;&nbsp;&nbsp;&nbsp;((Copy)((result),&nbsp;(tmp9)));
&nbsp;&nbsp;&nbsp;&nbsp;return(tmp9);
&nbsp;&nbsp;}
}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">分析这样的代码是相当困难的，这个保护最终被&nbsp;Team-AiR&nbsp;攻破，根据其 NFO 文件显示，他们花了近 4000 小时，将近一年工作的一半。在此期间，软件发行商可以继续销售软件而不用考虑盗版的问题。Cloakware 现在是 Lrdeto 公司也在开发类似的保护系统，但是该项目被放弃了。我相信如果这种保护系统与先进的虚拟化技术相结合，对于用户和反病毒软件都是灾难性的。幸运的是，构建这种系统非常困难而且不常见。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">数据和字符串加密</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">这是隐藏敏感信息时最常用的办法，加密通常用于包含那些感染文件的名字、控制服务器地址、甚至是 FTP 或者邮箱的密码。恶意软件与其控制服务之间的通信也常常是加密的，以保证其内容是秘密的。&nbsp;</span></p><p data-anchor-id="wbdi" style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Rootkit 样本 Rustock 使用了&nbsp;</span><a href="https://en.wikipedia.org/wiki/RC4" target="_blank" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">RC4</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;加密算法（这是恶意软件中最常见的一个），以保护自己的模块可供分析，在感染时，从计算机取得的硬件 ID 将作为其病毒的加密密钥，同时这个程序将不会在其他计算机上工作（由于硬件 ID 不匹配），同一时间在另一台计算机上进行分析也是不可能的（例如病毒被发送到了反病毒公司进行分析），必须得到被感染计算机的硬件 ID 才能将病毒代码解密。&nbsp;<br/>公认的加密算法&nbsp;</span><a href="https://en.wikipedia.org/wiki/Advanced_Encryption_Standard" target="_blank" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">AES</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;利用固定的数据表，软件（就像&nbsp;</span><a href="https://www.aldeid.com/wiki/PEiD" target="_blank" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">PEiD</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;这种扫描器）分析可以立即检测到这种算法存在于可执行程序中，这会给分析师提醒，有什么东西加密了躲在代码中，值得调查。出于这个原因，恶意软件作者常常使用动态生成的加密算法，这样不会引起怀疑，例如：</span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">清单12-动态生成的获得使用&nbsp;</span></strong></span><a href="https://www.stringencrypt.com/" target="_blank" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 112, 192); text-decoration: none;"><span style="color: rgb(0, 112, 192);"><strong><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">StringEncrypt</span></strong><strong><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></strong></span></a><span style="color: rgb(0, 112, 192); text-decoration: none;"><strong><span style="text-decoration: none; color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;</span></strong></span><span style="color: rgb(0, 112, 192);"><strong><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">服务的解密代码</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:plain;toolbar:false">//&nbsp;encrypted&nbsp;with&nbsp;https://www.stringencrypt.com&nbsp;(v1.1.0)&nbsp;[C/C++]
//&nbsp;wszLabel&nbsp;=&nbsp;&quot;C/C++&nbsp;String&nbsp;Encryption&quot;
wchar_t&nbsp;wszLabel[24]&nbsp;=&nbsp;{&nbsp;0x2976,&nbsp;0x2AF9,&nbsp;0x289C,&nbsp;0x2B9F,&nbsp;0x2BA2,&nbsp;0x2D05,&nbsp;0x2688,&nbsp;0x316B,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x336E,&nbsp;0x33D1,&nbsp;0x3214,&nbsp;0x3337,&nbsp;0x2CDA,&nbsp;0x277D,&nbsp;0x3200,&nbsp;0x34A3,
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x32C6,&nbsp;0x3269,&nbsp;0x32AC,&nbsp;0x312F,&nbsp;0x3392,&nbsp;0x3255,&nbsp;0x3258,&nbsp;0x609B&nbsp;};
for&nbsp;(unsigned&nbsp;int&nbsp;Qqhvj&nbsp;=&nbsp;0,&nbsp;JWqBw&nbsp;=&nbsp;0;&nbsp;Qqhvj&nbsp;&lt;&nbsp;24;&nbsp;Qqhvj++)
{
&nbsp;&nbsp;&nbsp;&nbsp;JWqBw&nbsp;=&nbsp;wszLabel[Qqhvj];
&nbsp;&nbsp;&nbsp;&nbsp;JWqBw&nbsp;-=&nbsp;0xA50D;
&nbsp;&nbsp;&nbsp;&nbsp;JWqBw&nbsp;+=&nbsp;Qqhvj;
&nbsp;&nbsp;&nbsp;&nbsp;JWqBw&nbsp;=&nbsp;(((JWqBw&nbsp;&amp;&nbsp;0xFFFF)&nbsp;&gt;&gt;&nbsp;15)&nbsp;|&nbsp;(JWqBw&nbsp;&lt;&lt;&nbsp;1))&nbsp;&amp;&nbsp;0xFFFF;
&nbsp;&nbsp;&nbsp;&nbsp;JWqBw&nbsp;^=&nbsp;0xB0D1;
&nbsp;&nbsp;&nbsp;&nbsp;JWqBw&nbsp;++;
&nbsp;&nbsp;&nbsp;&nbsp;JWqBw&nbsp;=&nbsp;(((JWqBw&nbsp;&amp;&nbsp;0xFFFF)&nbsp;&gt;&gt;&nbsp;3)&nbsp;|&nbsp;(JWqBw&nbsp;&lt;&lt;&nbsp;13))&nbsp;&amp;&nbsp;0xFFFF;
&nbsp;&nbsp;&nbsp;&nbsp;JWqBw&nbsp;=&nbsp;~JWqBw;
&nbsp;&nbsp;&nbsp;&nbsp;JWqBw&nbsp;+=&nbsp;0xAF02;
&nbsp;&nbsp;&nbsp;&nbsp;JWqBw&nbsp;^=&nbsp;Qqhvj;
&nbsp;&nbsp;&nbsp;&nbsp;JWqBw&nbsp;^=&nbsp;0x9FC1;
&nbsp;&nbsp;&nbsp;&nbsp;JWqBw&nbsp;-=&nbsp;0xA9E0;
&nbsp;&nbsp;&nbsp;&nbsp;JWqBw&nbsp;=&nbsp;~JWqBw;
&nbsp;&nbsp;&nbsp;&nbsp;JWqBw&nbsp;++;
&nbsp;&nbsp;&nbsp;&nbsp;JWqBw&nbsp;=&nbsp;(((JWqBw&nbsp;&amp;&nbsp;0xFFFF)&nbsp;&gt;&gt;&nbsp;3)&nbsp;|&nbsp;(JWqBw&nbsp;&lt;&lt;&nbsp;13))&nbsp;&amp;&nbsp;0xFFFF;
&nbsp;&nbsp;&nbsp;&nbsp;JWqBw&nbsp;--;
&nbsp;&nbsp;&nbsp;&nbsp;wszLabel[Qqhvj]&nbsp;=&nbsp;JWqBw;
}
wprintf(wszLabel);</pre><p style="text-indent: 2em; text-align: left;"><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">定时炸弹</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">有时候恶意软件被设计在一定时间段后激活，例如它可以检查本地时间然后在一个精确的日期后操作，这样的恶意软件有可能会避开反病毒软件（因为没有观察到系统更改）。因此，如果初步分析表明这个程序不是完全安全的，进一步观察是明确的做法。</span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">清单13-一个特定的日期后激活程序</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:plain;toolbar:false">#include&nbsp;&lt;windows.h&gt;
void&nbsp;MrMalware(void)
{
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;malicious&nbsp;code
&nbsp;&nbsp;&nbsp;&nbsp;MessageBox(NULL,&nbsp;&quot;I&#39;m&nbsp;a&nbsp;virus!&quot;,&nbsp;&quot;Boo!&quot;,&nbsp;MB_ICONWARNING);
&nbsp;&nbsp;&nbsp;&nbsp;return;
}
int&nbsp;main()
{
&nbsp;&nbsp;&nbsp;&nbsp;SYSTEMTIME&nbsp;stLocalTime&nbsp;=&nbsp;{&nbsp;0&nbsp;};
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;obtain&nbsp;the&nbsp;current&nbsp;time
&nbsp;&nbsp;&nbsp;&nbsp;GetLocalTime(&amp;stLocalTime);
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;activate&nbsp;the&nbsp;malicious&nbsp;code
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;only&nbsp;after&nbsp;this&nbsp;date
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(stLocalTime.wYear&nbsp;&gt;=&nbsp;2013&nbsp;&amp;&amp;&nbsp;\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stLocalTime.wMonth&nbsp;&gt;=&nbsp;5&nbsp;&amp;&amp;&nbsp;\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;stLocalTime.wDay&nbsp;&gt;=&nbsp;2)
&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;MrMalware();
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0;
}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">当我们怀疑一个程序中包含定时炸弹时怎么办？最直接的解决方案是向前或者向后调整系统时间，并使用监控工具监控系统的变化。尽管很简单，但是对发现定时炸弹很有效。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">延迟执行</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">除了定时炸弹，有些恶意程序会采用延迟执行，就像定时器一样。基本思路是，程序启动后不会发生恶意行为，在设定的时间后就会发生。这是双重效果，首先可以误导分析师，在启动过程中没有任何反应，程序应该是安全的，阻止了其进一步进行分析。其二，延时执行可以欺骗反病毒软件的仿真器，仿真器都受到时间的限制，因为用户启动程序并等待了一个半小时后触发了加密代码的执行，对仿真器来说这已经毫无意义了。一个良好的仿真器会检测时间延迟（比如 sleep 函数、延迟循环等），但不可能将所有的时间延迟都考虑在内，Windows 中多种度量时间的办法意味着使用时间延迟对动态代码分析是一种好的防御措施。</span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192); font-size: 16px;"><strong><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">清单14-在一定时间周期后激活的恶意代码</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:plain;toolbar:false">#include&nbsp;&lt;windows.h&gt;
DWORD&nbsp;dwTimerId&nbsp;=&nbsp;0;
const&nbsp;DWORD&nbsp;dwTimerEventId&nbsp;=&nbsp;666;
//&nbsp;callback&nbsp;function&nbsp;activated&nbsp;after&nbsp;a&nbsp;designated&nbsp;time
VOID&nbsp;CALLBACK&nbsp;MrMalware(HWND&nbsp;hwnd,&nbsp;UINT&nbsp;uMsg,&nbsp;UINT&nbsp;idEvent,&nbsp;DWORD&nbsp;dwTime)
{
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;malicious&nbsp;code
&nbsp;&nbsp;&nbsp;&nbsp;MessageBox(NULL,&nbsp;&quot;I&#39;m&nbsp;a&nbsp;virus!&quot;,&nbsp;&quot;Boo!&quot;,&nbsp;MB_ICONWARNING);
&nbsp;&nbsp;&nbsp;&nbsp;return;
}
int&nbsp;main()
{
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;activate&nbsp;malicious&nbsp;code&nbsp;5&nbsp;seconds
&nbsp;&nbsp;&nbsp;&nbsp;//&nbsp;after&nbsp;the&nbsp;program&nbsp;is&nbsp;launched
&nbsp;&nbsp;&nbsp;&nbsp;dwTimerId&nbsp;=&nbsp;SetTimer(NULL,&nbsp;dwTimerEventId,&nbsp;5&nbsp;*&nbsp;1000,&nbsp;MrMalware);
&nbsp;&nbsp;&nbsp;&nbsp;MessageBox(NULL,&nbsp;&quot;I&#39;m&nbsp;a&nbsp;friendly&nbsp;program&quot;,&nbsp;&quot;Hi!&quot;,&nbsp;MB_ICONINFORMATION);
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0;
}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;"><br/></span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">加密签名</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><a href="https://en.wikipedia.org/wiki/Digital_signature" target="_blank" textvalue="加密签名" style="color: rgb(255, 0, 0); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: none;"><span style="color: rgb(255, 0, 0); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">加密签名</span></a><span style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">通常用来签名应用程序，以此保证拥有数字签名的应用程序来自受信任的来源。某些防病毒软件会放行那些有数字签名的应用程序。为了获得数字证书，个人和企业的信息都必须在证书中，必须被验证过。如果没有可以证明的文件（比如银行对账单、身份证的扫描件）是不可能获得合法机构的证书的。然而，数字证书确实会被黑客盗取，然后用于签署恶意软件。这样的例子并不多见，但这样会让那些为所有具有数字证书放行的反病毒软件造成问题。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px;">在线扫描</span></strong></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">恶意软件的作者一定非常想知道他的恶意软件被反病毒软件检测的情况，安装所有的反病毒软件不仅费事费时，它们之间还并不兼容。所以恶意软件的作者往往会使用在线服务来检测。如果你第一个想到的是&nbsp;</span><a href="https://www.virustotal.com/" target="_blank" style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(255, 0, 0); text-decoration: none;"><span style="color: rgb(255, 0, 0);">VirusToal</span></a><span style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">（</span><a href="http://blog.virustotal.com/2012/09/an-update-from-virustotal.html" target="_blank" style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(255, 0, 0); text-decoration: none;"><span style="color: rgb(255, 0, 0);">最近被 Google 收购</span></a><span style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">），你只了解了一点点。恶意软件的作者是不会使用这些网站（又例如&nbsp;</span><a href="https://virusscan.jotti.org/" target="_blank" style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(255, 0, 0); text-decoration: none;"><span style="color: rgb(255, 0, 0);">Jotti</span></a><span style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">）的，提交给他们的所有文件都与反病毒公司共享，用来提高其反病毒产品的检测精度。恶意软件作者会使用像&nbsp;</span><a href="http://vscan.novirusthanks.org/" target="_blank" style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(255, 0, 0); text-decoration: none;"><span style="color: rgb(255, 0, 0);">NoVirusThanks</span></a><span style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">&nbsp;或&nbsp;</span><a href="https://nodistribute.com/" target="_blank" style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(255, 0, 0); text-decoration: none;"><span style="color: rgb(255, 0, 0);">NoDistribute</span></a><span style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">，它们都以不和反病毒公司合作而著称。</span></p><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px;"><br/></span></strong></p><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px;">结论</span></strong></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">从我的经验观察，恶意软件作者和分析师的战斗永远不会停止。有趣的是战争两边，一边是好的，像反病毒公司、为了合法版权保护的公司，另一边都是坏的，那些试图突破软件保护的人、那些写出可以被恶意软件利用的软件的人。从文章开始到结束，我们纵观工具随着时间的演变，我们可以推测出接下来会发生什么吗？我的看法是一切都会向代码虚拟化的方向前进，但是会比当前的方案更先进。这从当前市场上对原生应用程序保护工具以及 .NET 应用程序虚拟化工具的出现就可以看出。反病毒公司会如何处理呢？一如既往地，要依赖卓越的员工的杰出工作。</span></p></p>
                <hr/>
                <p style="text-align: center;">
                    <img src="http://bobao.360.cn/img/app.jpeg"/>
                    <img src="http://bobao.360.cn/img/weixin.jpeg"/>
                </p>
                                <p>本文由 安全客 翻译，转载请注明“转自安全客”，并附上链接。<br/><a class="text-more" href="https://www.pelock.com/articles/anti-reverse-engineering-malware-vs-antivirus-software" target="_blank">原文链接：https://www.pelock.com/articles/anti-reverse-engineering-malware-vs-antivirus-software</a></p>
                            </div>
            <div style="margin-top: 20px;background-color:#FFFFFF">
    <input type="hidden" id="detail_title" name="detail_title" value="【技术分享】反逆向工程——使恶意软件难以逆向的技术 - 安全客 - 有思想的安全新媒体" />
    <input type="hidden" id="use_nickname" name="use_nickname" value="0" />
    <a name="mao"></a>
    <div class="reg-log mobile-hiden">
        <div class="" id="userTo">   
            <div id="to-list" class="input-text" style="">
                <textarea disabled="disabled" class="hide"  id="comment-content" to="to"></textarea>
                <ul id="preadded" style="display:none">       
                </ul>
                <div id="to-auto" style="width: 200px">
                    <ul id="feed">
                    </ul>
                </div>
            </div>
        </div>
        <input type="hidden" id="source-id" value="3217" />
        <input type="hidden" id="source-type" value="learning" />
        <input type="hidden" id="post-comment-url" value="/comment/add" />
        <input type="hidden" id="post-nickname-url-ajax" value="/comment/randnicknameajax" />
        <input type="hidden" id="post-check-login-url-ajax" value="/comment/checklogin" />
        <input type="hidden" id="stoken_comment_set" value="ea3898fb4df38673fdeb61c458234054">                 <span class="join">参与讨论，请先 <a href="javascript:;" class="comment-login">登录</a> | <a href="javascript:;" class="comment-reg">注册</a> |  <a href="javascript:;" class="anonymous-comment">匿名评论</a></span>
            </div>
    <div class="mobile-hide" style="width: 870px; margin: 0 auto;">
        <label style="vertical-align:middle;" for="use_nickname">匿名</label> 
        <input style="vertical-align:middle;" id="trigger-nickname" name="use_nickname" class="use_nickname" type="checkbox" value="0" />

        <a href="javascript:;" class="apply-use button" id="submit-comment" data-target="/comment/add">发布</a>
    </div>


    <div class="clearfix"></div>
    <div class="comments">
        <div class="comments-head">
            <span class="title">用户评论</span>
        </div>
                <div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/11x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="2782911444" class="response" data-bind-id="2782911444" data-target="6205" user-name="妇科圣手" href="javascript:;">
                妇科圣手            </a>
                        <span class="comment-time">2016-11-23 17:08:53</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="2782911444" data-target="6205">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_6205" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">谁说不是呢？</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
<div class="clearfix re-comment">
    <div class="comment-quote">  
        <div class="comment-user">
            <a href="javascript:;" class="response" data-bind-id="0" data-target="6171">户村美知留</a> <span class="comment-time">2016-11-23 10:50:27</span>            <div class="comment-action">                        <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="6171">回复</a></span>&nbsp;|&nbsp;                        <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_6171" data-type="comment">点赞</a></span>            </div>
            <p>我想起我中学时候有空就到看雪上学习各种反汇编、脱壳技巧结果还是没怎么弄明白</p>
        </div>
    </div>
        </div>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/9x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="6178" user-name="安全客官方微博" href="javascript:;">
                安全客官方微博            </a>
                        <span class="comment-time">2016-11-23 10:50:39</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="6178">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_6178" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">小伙子慢慢来~</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/12x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="6171" user-name="户村美知留" href="javascript:;">
                户村美知留            </a>
                        <span class="comment-time">2016-11-23 10:50:27</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="6171">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_6171" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">我想起我中学时候有空就到看雪上学习各种反汇编、脱壳技巧结果还是没怎么弄明白</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>

        <a class="more-long comment-more" href="javascript:;" data-target="/comment/more" data-type="learning" data-source-id="3217" data-page="2">查看更多</a>
            </div>
</div>
<script>
    $(function () {
        $('.anonymous-comment').click(function () {
            $(".join").hide();
            $(".reg-log textarea").first().removeAttr("disabled").show();
            $('#use_nickname').val('1');
//            $('#trigger-nickname').attr('checked', true);
            $('#trigger-nickname').trigger('click');
        });
        //为所有复选框绑定事件
//        checkbox_on_click();
        //ajax随机获取昵称
//        randnicknameajax(0);
        //ajax检测登录状态
        comment_check_login();
    });



    function input_checkbox(flag) {
        $('input:checkbox').each(function () {
            var value = flag ? 1 : 0;
            $(this).prop('checked', flag);
            $(this).val(value);
        });
    }

//ajax随机获取昵称
    function randnicknameajax(flag) {
        $.ajax({
            type: 'POST',
            url: $('#post-nickname-url-ajax').val(),
            data: {limit: 1, flag: flag},
            dataType: "json",
            success: function (data) {
                $('#nick-name').val(data.data[0]);
                _nick_name=data.data[0];
            }
        });
    }
    $();
//ajax检测登录状态
    function comment_check_login() {
        $.ajax({
            type: 'POST',
            url: $('#post-check-login-url-ajax').val(),
            data: {},
            dataType: "json",
            success: function (data) {
                if (data.success) {
                    $('.join').hide();
                    $(".reg-log textarea").first().removeAttr("disabled").show();
                    $("#span_use_nickname").show();
                    $('#use_nickname').val('0');
                    $('#use_nickname').attr('checked', false);
                }
            }
        });
    }
</script>        </div>
    </div>
    <div class="side-bar">
        <div class="mod hot-news">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-hot"></i><span>热门知识</span></h2>
    </div>
    <ul class="links-list">
                                <li><a href="/learning/detail/4411.html" alt="【漏洞预警】一个换行符引发的奥斯卡0day漏洞(CVE-2017-8759)重现——最新的Office高级威胁攻击预警" target="_blank">【漏洞预警】一个换行符引发的奥斯卡...</a></li>
                                <li><a href="/learning/detail/4416.html" alt="【漏洞预警】Microsoft .NET Framework漏洞（CVE–2017–8759）预警" target="_blank">【漏洞预警】Microsoft .NE...</a></li>
                                <li><a href="/learning/detail/4414.html" alt="【技术分享】妙用JavaScript绕过XSS过滤" target="_blank">【技术分享】妙用JavaScrip...</a></li>
                                <li><a href="/learning/detail/4418.html" alt="【技术分享】利用威胁情报数据平台拓展APT攻击线索一例" target="_blank">【技术分享】利用威胁情报数据平台拓...</a></li>
                                <li><a href="/learning/detail/4417.html" alt="【知识】9月15日 - 每日安全知识热点" target="_blank">【知识】9月15日 - 每日安全知识热...</a></li>
                                <li><a href="/learning/detail/4425.html" alt="【安全报告】XShellGhost事件技术回顾报告" target="_blank">【安全报告】XShellGhost事件...</a></li>
            </ul>
</div>        <!-- 友情链接 -->
        <div class="mod blog-links mobile-hide">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-link"></i><span>友情链接</span></h2>
        <a href="/links/index.html" class="more">更多<i></i></a>
    </div>
        <ul class="links-list">
                <li><a href="http://bbs.360safe.com" alt="360安全社区" target="_blank">360安全社区</a></li>
                <li><a href="http://zhuji.360.cn" alt="360主机卫士" target="_blank">360主机卫士</a></li>
                <li><a href="http://blogs.360.cn/" alt="奇虎360技术博客" target="_blank">奇虎360技术博客</a></li>
                <li><a href="http://wangzhan.360.cn/" alt="360网站卫士" target="_blank">360网站卫士</a></li>
                <li><a href="http://webscan.360.cn/" alt="360网站安全检测" target="_blank">360网站安全检测</a></li>
                <li><a href="http://research.360.cn/report/" alt="360研究报告" target="_blank">360研究报告</a></li>
                <li><a href="http://unicorn.360.cn/" alt="360 Unicorn Team" target="_blank">360 Unicorn Team</a></li>
                <li><a href="http://appscan.360.cn/" alt="360捉虫猎手" target="_blank">360捉虫猎手</a></li>
                <li><a href="https://threathunter.org/" alt="ThreatHunter社区" target="_blank">ThreatHunter社区</a></li>
                <li><a href="http://security.360.cn/" alt="360安全应急响应中心" target="_blank">360安全应急响应中心</a></li>
            </ul>
    </div>
        <!-- 联系我们 -->
        <div class="mod contact mobile-hide" style="text-align:center">
    <div class="head-bar clearfix">
        <h2><i></i><span>关注我们</span></h2>
    </div>
    <!-- 微信关注 -->
    <ul class="contact-way">
        <li><a>微信关注</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/qrcode_adlab_weixin.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
    <!-- APP下载 -->
    <ul class="contact-way">
        <li><a>安全播报APP</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/scan_code_big.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
</div>

    </div>
</div>

<script type="text/javascript" src="/js/jquery-ui.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/jquery.noty.packaged.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/common.js?v=4.5"></script>
<script>$(function() {sync_count('comment');});</script>


<!-- 语法高亮 -->
<script type="text/javascript" src="/ue/SyntaxHighlighter/shCore.js"></script>
<script type="text/javascript">SyntaxHighlighter.all();sync_count('vul');sync_count('news');sync_count('learning');sync_count('activity');sync_count('course');sync_count('ctf');</script>
    </div>

        <div class="footer">
        <div class="friend-link">
            <a href="http://www.360.cn/" target="_blank">360首页</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">关于我们</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">联系我们</a>
            <span>|</span>
            <a href="/links/index.html" target="_blank">友情链接</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">招贤纳士</a>
        </div>
        <div class="copy">
            Copyright &copy; 360网络攻防实验室 All Rights Reserved <span class="copy_icp">京ICP证080047号[京ICP备08010314号-6]</span>
        </div>
    </div>
    
</div>

<!--奇舞团统计-->

<script src='https://s.ssl.qhimg.com/static/f5407c785655e6a1/monitor_analytic.js'></script>
<script>
    monitor.setProject('QH_171_1').getTrack().getClickAndKeydown().getClickHeatmap(10, 1);
</script>

<div class="hide">
    <script src="https://s95.cnzz.com/z_stat.php?id=1253147824&web_id=1253147824" language="JavaScript"></script>
</div>
<div class="backToTop_wrap off">
    <a id="back_to_top" class="backToTop" href="javascript:;" title="返回顶部"></a>
</div>
<script>
    var $backToTop_wrap = $(".backToTop_wrap"),
        $backToTop_btn = $("#back_to_top");

    if ($(window).scrollTop() > 100) {
        $backToTop_wrap.removeClass("off");
    }
    else {
        $backToTop_wrap.addClass("off");
    }

    $(window).on("scroll", function () {
        if ($(this).scrollTop() > 100) {
            $backToTop_wrap.removeClass("off");
        }
        else {
            $backToTop_wrap.addClass("off");
        }
    });

    $backToTop_btn.on("click", function () {
        $("html, body").animate({scrollTop: 0}, 120);
    });

    $(function () {
        var navlist = $('.nav-list > li');

        navlist.each(function () {
            $(this).on('mouseenter', function () {
                $(this).addClass('selected');
            });

            $(this).on('mouseleave', function () {
                $(this).removeClass('selected');
            });
        });
    })
</script>



</body>
</html>
