<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns:wb="http://open.weibo.com/wb" xml:lang="en" lang="en">
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"/>
    <link rel="shortcut icon" href="http://bobao.360.cn/favicon.ico?v=1.1"/>
    <link rel="alternate" title="安全资讯" href="/rss?type=news" type="application/rss+xml"/>
    <link rel="alternate" title="安全知识" href="/rss?type=learning" type="application/rss+xml"/>
    <link rel="alternate" title="安全圈活动" href="/rss?type=activity" type="application/rss+xml"/>
    <link rel="alternate" title="所有漏洞" href="/rss?type=vul" type="application/rss+xml"/>
    <link rel="alternate" title="通用型漏洞" href="/rss?type=commonvul" type="application/rss+xml"/>
    <link rel="alternate" title="事件型漏洞" href="/rss?type=eventvul" type="application/rss+xml"/>
    <link rel="alternate" title="热门漏洞" href="/rss?type=hotvul" type="application/rss+xml"/>

        <title>使用Kerberoast破解Kerberos TGS票据：利用Kerberos突破活动目录域 - 安全客 - 有思想的安全新媒体</title>
    
        <meta name="keywords" content="Kerberoast,内网渗透,Kerberos"/>
    
        <meta name="description" content="本篇文章介绍了服务主体名称（Service Principal Name，SPN）的工作原理，也介绍了如何使用Kerberoast来离线破解密码。"/>
        <meta property="wb:webmaster" content="224437c7be31d633"/>

    <script type="text/javascript" src="http://s7.qhimg.com/!56caa871/xpc_sync_height.js"></script>
    <link rel="stylesheet" type="text/css" href="/css/reset.css" />
    <link rel="stylesheet" type="text/css" href="/css/common_new.css?v=4.4.2.1" />
    <link rel="stylesheet" type="text/css" href="/css/jquery.notyfy.css" />
    <link rel="stylesheet" type="text/css" href="/css/notyfy.theme.default.css" />
    <link rel="stylesheet" type="text/css" href="/css/s_common.css?v=2.2.7" media="only screen and
    (max-device-width:900px), only screen and (max-width:900px)" />
    <script type="text/javascript" src="/js/jquery.min.js?v=3.1"></script>
    <script type="text/javascript" src="/js/jquery.notyfy.js"></script>
    <script type="text/javascript" src="/js/iscroll.js"></script>
    <script src="http://js.passport.qihucdn.com/5.0.3.js"></script>
    <script type="text/javascript">
        var myScroll, myNavScroll;

        function iscrollLoaded() {
            myScroll = new IScroll('#wrapper',
                {
                    scrollX: true,
                    scrollY: false,
                    bounceEasing: 'circular',
                    eventPassthrough: true,
                    preventDefault: false,
                    bounceTime: 500
                }
            );
        }

        $(function () {

            //导航横向滚动


            function setNavWidth() {

                /* 计算导航宽度 */
                var allWidth = $(window).width();
                var scroller = $('#scroller');

                if (allWidth > 900) {
                    scroller.find('ul').add(scroller.find('.scroll')).removeAttr('style');
                    scroller.css('overflow', 'visible');
                    if (myNavScroll) myNavScroll.destroy();
                } else {

                    var width = 0;
                    scroller.find('.scroll').children('ul').children('li').each(function (index, el) {
                        if (!$(this).hasClass('mobile-hide')) {
                            width += $(this).outerWidth();
                        }
                    });
                    scroller.find('ul').add(scroller.find('.scroll')).width(width);

                    if (myNavScroll) myNavScroll.destroy();

                    myNavScroll = new IScroll('#scroller', {
                        scrollX: true,
                        scrollY: false,
                        momentum: false,
                        click: true
                    });

                }

            }

            setNavWidth();
            $(window).resize(function (event) {
                setNavWidth();
            });

        });

    </script>
</head>
<body onload="iscrollLoaded();">
<div style='margin:0 auto;width:0px;height:0px;overflow:hidden;'>
    <img src=""/>
</div>

<div id="is-mobile"></div>
<div class="container">
        <div class="mobile-header">
        <div class="header clearfix">
            <div class="header-wrapper clearfix">
                <a href="/index/index" class="logo"><img class="slogan" src="/img/logo.png?v=1.5"/></a>
                                <form id="search" class="search-box" action="/search/index" method="GET">
                    <input class="keys" name="keywords" type="text" placeholder="搜索漏洞" required="required">
                    <input class="icon" type="submit" value="">
                    <input type="hidden" name="type" value=""/>
                </form>
                <div class="bug">
                    <div class="name"><span class="seled">全部</span><i class="arrow"></i></div>
                    <ul class="typelist">
                        <li data-index="3"><a href="javascript:void(0);">全部</a></li>
                        <li data-index="0"><a href="javascript:void(0);">漏洞</a></li>
                        <li data-index="1"><a href="javascript:void(0);">资讯</a></li>
                        <li data-index="2"><a href="javascript:void(0);">知识</a></li>
                    </ul>
                </div>
                                <div class="logNreg mobile-hide">
                    <div class="unlog">
                        <i></i>
                        <a href="log.html" class="log">登录</a>
                        <span>|</span>
                        <a href="reg.html" class="reg">注册</a>
                    </div>
                    <div class="loged">
                        <a href="/member/profile" class="user-center"><i></i><span class="user-name-tag">个人中心</span></a>
                        <div class="user-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting"><a href="http://i.360.cn/profile/accountmanage"
                                                               target="_blank"><i></i><span>账号设置</span></a></li>
                                <li class="alert-setting"><a href="/keywords/index"
                                                             target="_blank"><i></i><span>告警设置</span></a></li>
                                <li class="bug-alert"><a href="/myalarm/index" target="_blank"><i></i><span>漏洞告警</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mylearn/index" target="_blank"><i></i><span>我的知识</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mycourse/index" target="_blank"><i></i><span>我的课堂</span></a>
                                </li>
                                <li class="my-exit"><a
                                            href="http://login.360.cn/?src=pcw_adlab&op=logout&destUrl=http://bobao.360.cn"><i></i><span>退出系统</span></a>
                                </li>
                            </ul>
                        </div>

                        <a href="/message" class="message-center" target="_blank"><i></i><span>我的消息</span></a>
                        <div class="message-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting" style="display:none;"><a href="/myres/index"
                                                                                     target="_blank"><i></i><span>回复我的</span></a>
                                </li>
                                <li class="my-bug"><a href="/myvul/index"
                                                      target="_blank"><i></i><span>我的漏洞</span></a></li>
                                <!--<li class="my-bug"><a href="/myres/index" target="_blank"><i></i><span>我的评论</span></a></li>-->
                                <!--<li class="alert-setting"><a href="###" target="_blank"><i></i><span>提到我的</span></a>
                                </li>-->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <style type="text/css">
            .nav {
                overflow: hidden;
            }

            .nav .scroll {
                width: auto;
            }
        </style>
        <div id="wrapper">
            <div id="scroller" class="nav">
                <div class="scroll">
                    <ul class="nav-list">
                        <li ><a class="link-nav"
                                                                                 href="/index/index">首页</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/vul/index">漏洞</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/introduce/list">招聘</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/news/index">资讯</a><!--<i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/introduce/list">招聘</a></li>
                        </ul>
			-->
                        </li>
                        <li class="cur">
                        <a class="link-nav" href="/learning/index">知识</a><i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/course/index">学院</a></li>
                        </ul>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/activity/index">活动</a></li>
                        <li class="mobile-hide "><a class="link-nav"
                                                                                                   href="/ctf/index">CTF训练营</a>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/interref/list">安全内参</a></li>
                        <li ><a class="link-nav" href="/app/index">APP</a></li>

                        <!--<li ><a href="/course/index">学院</a></li>-->
                        <!--<li ><a href="/introduce/list">招聘</a></li>-->
                        <!--<li  class="mobile-hide"><a href="/ctf/index">CTF训练营</a></li>-->
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="mobile-content">
        <link rel="stylesheet" type="text/css" href="/css/news.css?v=3.5" />
<link rel="stylesheet" type="text/css" href="/ue/SyntaxHighlighter/shCoreDefault.css?v=1.0" />
<style>
    p .syntaxhighlighter {
        width: 80%;
    }
</style>

<div class="cur-pos w1000">当前位置：<a href="http://bobao.360.cn/">安全客</a> &gt;&gt; 知识详情</div>

<div class="content clearfix">
    <div class="main">
        <div class="article">
            <div id="article_box">
                <h2>使用Kerberoast破解Kerberos TGS票据：利用Kerberos突破活动目录域</h2>
                <div class="article-msg">
                    <span class="time">2017-08-16 11:30:27</span>
                    
                                        <span class="read">阅读：9601次</span>
                    <span><a style="display: none;" class="good" href="javascript:;"
                             data-target="/learning/good" data-value="g_4256"
                             data-type="learning">点赞(0)</a></span>
                    <span><a class="fav" href="javascript:;" data-target="/mylearning/add"
                             data-pk="4256" data-type="learning">收藏</a></span>
                                        <span><a style="margin-left: 4px;" class="fav" href=""
                             target="_blank">来源： 安全客</a></span>
                    
                    
                    <div style="margin-top:10px; ">
                        <a href="/member/contribute?uid=2819002922" style="color:#848e99;">
                            <img src="http://p1.qhmsg.com/dm/150_150_100/t0104d1b8b4ca36e961.jpg" data-is-avatar="true"
                                 style="border: 1px solid #d5d5d5;padding: 2px; width: 80px;height: 80px;border-radius: 43px;"/>
                        </a>

                    </div>
                    <span class="orig">作者：<a href="/member/contribute?uid=2819002922" style="color:#848e99;">興趣使然的小胃</a></span>
                                    </div>
                <hr size="1">
                <div class="article-msg">
                    <p><!-- JiaThis Button BEGIN -->

<!--
<span class="jiathis_style"><span class="jiathis_txt">分享到：</span>
	<a class="jiathis_button_weixin"></a>
	<a class="jiathis_button_tsina"></a>
    <a class="jiathis_button_tqq"></a>
    <a class="jiathis_button_qzone"></a>
    <a class="jiathis_button_renren"></a>
    <a class="jiathis_button_xiaoyou"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
</span>

-->
</p>
                </div>
                <p><p style="text-align: center; text-indent: 0em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><img src="http://p8.qhimg.com/t01acbc29cfef3d5d31.jpg" title="t01876a66e1bfd82b39.jpg" alt="http://p1.qhimg.com/t01876a66e1bfd82b39.jpg"/></span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span></strong></span></p><p style="margin: 0px 25px 8px; white-space: normal; padding: 0px; line-height: 25px; color: rgb(70, 79, 85); word-break: break-all; font-family: Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft Yahei&quot;, 微软雅黑, serif; text-indent: 32px; background: white;"><span style="font-weight: 900; font-size: 18px; font-family: 微软雅黑, sans-serif; color: rgb(0, 112, 192);">译者：</span><a href="http://bobao.360.cn/member/contribute?uid=2819002922" target="_blank"><span style="font-weight: 900; font-size: 18px; font-family: 微软雅黑, sans-serif; color: rgb(0, 112, 192);">興趣使然的小胃</span></a></p><p style="margin: 0px 25px 8px; white-space: normal; padding: 0px; line-height: 25px; color: rgb(70, 79, 85); word-break: break-all; font-family: Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft Yahei&quot;, 微软雅黑, serif; text-indent: 32px; background: white;"><span style="font-weight: 900; font-size: 18px; font-family: 微软雅黑, sans-serif; color: rgb(0, 112, 192);">预估稿费：200RMB</span></p><p style="margin: 0px 25px 8px; white-space: normal; padding: 0px; line-height: 25px; color: rgb(70, 79, 85); word-break: break-all; font-family: Helvetica, &quot;Hiragino Sans GB&quot;, &quot;Microsoft Yahei&quot;, 微软雅黑, serif; text-indent: 32px; background: white;"><span style="font-weight: 900; font-size: 18px; font-family: 微软雅黑, sans-serif; color: rgb(0, 112, 192);">投稿方式：发送邮件至linwei#360.cn，或登陆网页版在线投稿</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">一、前言</span></strong></span><br/></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">微软在活动目录（Active Directory）中使用了Kerberos机制，在过去几年里，安全研究人员以及攻击者针对Kerberos的具体实现做了许多工作。所发现的问题主要与Kerberos的传统支持（legacy support）特性有关，早在2000年，微软就发布了Windows Server 2000，一起发布的还包括活动目录。当使用Kerberos RC4加密（RC4_HMAC_MD5）方式时，传统支持特性就会启用，因为NTLM密码散列广泛使用了这种加密类型。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">有多个Kerberos攻击方法利用了微软在活动目录中使用的传统支持特性。当微软发布Windows 2000以及活动目录时，他们需要支持Windows NT以及Windows 95，在带来了许多安全特性的情况下，同时也带来了一些较不安全的配置问题。这意味着微软需要支持多个不同的客户端，并且让这些客户端能够使用Kerberos特性。一种较为简单的实现方法就是将NTLM密码散列作为Kerberos RC4加密私钥，来加密及签名Kerberos票据。一旦NTLM密码散列暴露，攻击者就将散列值用于各种攻击场景，其中就包括突破活动目录域（大家是否还记得Golden Tickets以及Silver Ticket？）</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">在15年之后，微软现在依然支持RC4 Kerberos加密。事实上，在</span><a href="http://blogs.technet.com/b/ad/archive/2007/11/02/server-2008-and-windows-vista-encryption-better-together.aspx" target="_self" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline; color: rgb(227, 108, 9);"><span style="color: rgb(227, 108, 9);"><strong><span style="color: rgb(227, 108, 9); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Windows Vista以及Windows Server 2008</span></strong></span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">之前，Windows并不支持AES加密。虽然较新的操作系统默认情况下会使用AES Kerberos加密，然而，网络中可能依然在广泛使用RC4 Kerberos加密，甚至许多网络设备在默认情况下会</span><a href="https://library.netapp.com/ecmdocs/ECMP1610207/html/GUID-5A2660CD-0F92-4A33-ABB7-A73430F03406.html" target="_self" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline; color: rgb(227, 108, 9);"><span style="color: rgb(227, 108, 9);"><strong><span style="color: rgb(227, 108, 9); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">禁用AES Kerberos加密</span></strong></span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">当在Kerberos加密选项中引入AES后，Windows将</span><a href="https://www.microsoft.com/security/sir/strategy/default.aspx#!password_hashes" target="_self" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline; color: rgb(227, 108, 9);"><span style="color: rgb(227, 108, 9);"><strong><span style="color: rgb(227, 108, 9); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">AES</span></strong></span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">用于散列中，这是传统Windows密码散列方法的一个突破。这意味着当</span><a href="https://msdn.microsoft.com/en-us/library/cc236715.aspx" target="_self" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline; color: rgb(227, 108, 9);"><span style="color: rgb(227, 108, 9);"><strong><span style="color: rgb(227, 108, 9); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Kerberos RC4加密</span></strong></span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">使用NTLM密码散列作为加密密钥时，Kerberos AES加密会使用</span><a href="https://technet.microsoft.com/en-us/library/cc749438(WS.10" target="_self" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline; color: rgb(227, 108, 9);"><span style="color: rgb(227, 108, 9);"><strong><span style="color: rgb(227, 108, 9); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">AES哈希</span></strong></span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">.aspx)来加密Kerberos票据。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">在2016年9月份，我和</span><a href="https://twitter.com/harmj0y" target="_self" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline; color: rgb(227, 108, 9);"><span style="color: rgb(227, 108, 9);"><strong><span style="color: rgb(227, 108, 9); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Will Schroeder</span></strong></span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">（</span><a href="http://blog.harmj0y.net/" target="_self" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline; color: rgb(227, 108, 9);"><span style="color: rgb(227, 108, 9);"><strong><span style="color: rgb(227, 108, 9); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">blog.harmj0y.net</span></strong></span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">）在DerbyCon 6上做了次</span><a href="https://adsecurity.org/wp-content/uploads/2016/09/DerbyCon6-2016-AttackingEvilCorp-Anatomy-of-a-Corporate-Hack-Demo-4-kerberoast.mp4" target="_self" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline; color: rgb(227, 108, 9);"><span style="color: rgb(227, 108, 9);"><strong><span style="color: rgb(227, 108, 9); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">演讲</span></strong></span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">，展示了Kerberoast的工作机制。现在大家可以查看我们演讲的</span><a href="https://adsecurity.org/wp-content/uploads/2016/09/DerbyCon6-2016-AttackingEvilCorp-Anatomy-of-a-Corporate-Hack-Presented.pdf" target="_self" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline; color: rgb(227, 108, 9);"><span style="color: rgb(227, 108, 9);"><strong><span style="color: rgb(227, 108, 9); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">幻灯片</span></strong></span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">和</span><a href="https://youtu.be/nJSMJyRNvlM?t=16" target="_self" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline; color: rgb(227, 108, 9);"><span style="color: rgb(227, 108, 9);"><strong><span style="color: rgb(227, 108, 9); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">视频</span></strong></span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">。大家可以在</span><a href="https://adsecurity.org/?page_id=1352" target="_self" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline; color: rgb(227, 108, 9);"><span style="color: rgb(227, 108, 9);"><strong><span style="color: rgb(227, 108, 9); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">这里</span></strong></span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">找到Will在演讲中做的demo。我在</span><a href="https://adsecurity.org/?page_id=1352" target="_self" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline; color: rgb(227, 108, 9);"><span style="color: rgb(227, 108, 9);"><strong><span style="color: rgb(227, 108, 9); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">此处</span></strong></span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">汇总了我在演讲中用到的所有幻灯片以及大多数视频资料。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">这篇文章介绍了服务主体名称（Service Principal Name，SPN）的工作原理，也介绍了如何使用Kerberoast来离线破解密码。Will也发表了一篇文章，介绍了如何</span><a href="https://www.harmj0y.net/blog/powershell/kerberoasting-without-mimikatz/" target="_self" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline; color: rgb(227, 108, 9);"><span style="color: rgb(227, 108, 9);"><strong><span style="color: rgb(227, 108, 9); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">在不使用Mimikatz的情况下使用Kerberoast</span></strong></span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">二、活动目录Kerberos攻击</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">现在有各种类型的Kerberos攻击，从信息侦察（SPN扫描），到离线服务账户密码破解（Kerberoast）攻击，再到目标持久化驻留（Silver Ticket和Golden Ticket）等，应有尽有。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">常用的活动目录Kerberos攻击方法如下：</span></p><p style="text-indent: 2em; text-align: left;"><a href="https://adsecurity.org/?p=1508" target="_self" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">SPN扫描</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">：通过请求特定SPN类型的服务主体名称来查找服务。</span></p><p style="text-indent: 2em; text-align: left;"><a href="https://adsecurity.org/?p=2011" target="_self" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Silver Ticket</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">：伪造Kerberos TGS服务票据。</span></p><p style="text-indent: 2em; text-align: left;"><a href="https://adsecurity.org/?p=1640" target="_self" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Golden Ticket</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">：伪造Kerberos TGT认证票据。</span></p><p style="text-indent: 2em; text-align: left;"><a href="https://adsecurity.org/?p=676" target="_self" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">MS14-068伪造PAC（Privilege Attribute Certificate，特权属性证书）</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">：利用域控上的Kerberos漏洞。</span></p><p style="text-indent: 2em; text-align: left;"><a href="https://www.blackhat.com/docs/eu-15/materials/eu-15-Beery-Watching-The-Watchdog-Protecting-Kerberos-Authentication-With-Network-Monitoring-wp.pdf" target="_self" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Diamond PAC</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">：一种混合攻击，用到了Golden Ticket以及MS14-068伪造PAC。</span></p><p style="text-indent: 2em; text-align: left;"><a href="https://adsecurity.org/?p=1255" target="_self" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">内存中的万能钥匙（Skeleton Key）恶意软件</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">：恶意软件会修改域控内存中LSASS认证进程，启用另一个有效的“万能钥匙（skeleton key）”密码，攻击者可以使用这个密码通过任意域账户的身份认证。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">本文介绍了另一类Kerberos攻击，这种攻击使用了Kerberoast来破解Kerberos TGS服务票据。2015年时，我在多个安全会议上发表了多次</span><a href="https://adsecurity.org/?page_id=1352" target="_self" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">演讲</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">（BSides、Shakacon、Black Hat、DEF CON以及DerbyCon），2014年，Tim Medin在DerbyCon上也发表了关于“攻击微软Kerberos机制”的相关演讲（大家可以去查看相关的</span><a href="https://files.sans.org/summit/hackfest2014/PDFs/Kicking%20the%20Guard%20Dog%20of%20Hades%20-%20Attacking%20Microsoft%20Kerberos%20%20-%20Tim%20Medin(1" target="_self" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">PPT</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">.pdf)以及</span><a href="https://www.youtube.com/watch?v=PUyhlN-E5MU&feature=youtu.be" target="_self" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">视频</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">），在那次会议上，他公布了</span><a href="https://github.com/nidem/kerberoast" target="_self" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline; color: rgb(227, 108, 9);"><span style="color: rgb(227, 108, 9);"><strong><span style="color: rgb(227, 108, 9); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Kerberoast Python TGS cracker</span></strong></span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">这个工具，这些参考资料都是本文研究成果的基础。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">三、SPN扫描</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">传统意义上讲，攻击者会使用网络端口扫描来开展侦察，虽然在活动目录以及Kerberos环境中，这个环节已经不是那么必要了。之前我写过一篇</span><a href="https://adsecurity.org/?p=230" target="_self" style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">文章</a><span style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">，介绍了如何通过</span><a href="https://adsecurity.org/?p=1508" target="_self" style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">SPN扫描</a><span style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">来开展侦察，这个过程需要请求域控上的特定服务主体名称（SPN）类型（需具备用户或计算机账户）。对于攻击者来说，需要扫描的最为有用的一种SPN类型就是“SQL”，扫描这种类型可以发现活动目录中所有注册过的SQL服务器。所有使用Kerberos认证机制的服务类型都会在活动目录中注册SPN，因为Kerberos需要SPN才能正常工作。首先，让我们回顾一下Kerberos的工作原理。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">我创建了一个服务主体名称（SPN）</span><a href="http://adsecurity.org/?page_id=183" target="_self" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">页面</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">，汇总了最常见的SPN以及这些SPN的具体用途。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">利用SPN扫描获取服务信息</span></p><p style="text-align:center"><img src="http://p8.qhimg.com/t01d8cc90f597289ab9.png" title="t01dfb3dc63ea8c83f4.png" alt="http://p2.qhimg.com/t01dfb3dc63ea8c83f4.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">利用SPN扫描来获取服务账户信息</span></p><p style="text-align: center;"><img src="http://p1.qhimg.com/t011779187b760f1697.png" title="t01cc676b6d9e514d1d.png" alt="http://p0.qhimg.com/t01cc676b6d9e514d1d.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">一旦攻击者掌握了与服务账户对应的一系列服务主体名称（SPN），就可以使用这些SPN请求Kerberos TGS服务票据，以便在离线条件下破解TGS密码。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">请注意：以上两张截图均取自我用PowerShell编写的SPN扫描工具的输出结果，大家可以在我的GitHub页面中找到这个工具。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">如果你已经安装了活动目录PowerShell模块，你可以使用Get-ADObject找出具备某个类型的所有SPN。命令如下：</span></p><pre class="brush:plain;toolbar:false">get-adobject&nbsp;-filter&nbsp;{serviceprincipalname&nbsp;-like&nbsp;“*sql*”}&nbsp;-prop&nbsp;serviceprincipalname</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">我们可以在Windows Server 2008R2以及更高版本的Windows中，使用如下命令安装AD PowerShell模块：</span></p><pre class="brush:plain;toolbar:false">import-module&nbsp;servermanager&nbsp;;&nbsp;add-windowsfeature&nbsp;RSAT-AD-PowerShell</pre><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;"></span><br/></p><p style="text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">四、Kerberos背景知识及通信过程</span></strong></span></p><hr/><p style="text-indent: 0em; text-align: center;"><img src="http://p1.qhimg.com/t0188f44fe9ae68ae71.png" title="t01399ce82dff468b49.png" alt="http://p3.qhimg.com/t01399ce82dff468b49.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">用户使用用户名及密码登录的过程如下。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">1a、 密码会被转换为NTLM散列，时间戳使用散列进行加密，然后作为认证票据（TGT）请求（AS-REQ）中的认证因子发送给KDC。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">1b、 域控（KDC）检查用户的信息（登录限制、组成员身份等）并创建票据授予票据（Ticket-Granting Ticket，TGT）。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">2、TGT经过加密、签名后传送给用户（AS-REP）。只有域内的Kerberos服务（KRBTGT）能够打开并读取TGT数据。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">3、当用户请求票据授予服务（Ticket Granting Service，TGS）票据时（TGS-REQ），用户需要向域控（DC）展示TGT数据。DC会打开票据，进行校验和检查。如果DC能够打开票据，并能通过校验和检查，那么会认为TGT为有效票据。此时TGT中的数据会被复制，以创建TGS票据。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">4、DC使用目标服务账户的NTLM密码散列对TGS进行加密，然后将结果发送给用户（TGS-REP）。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">5、用户访问目标服务，并发送TGS数据（AP-REQ）。目标服务会使用自己的NTLM密码散列打开TGS票据。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">6、如果客户端需要双向验证（大家可以回想一下MS15-011：微软在2月份的组策略补丁中添加了UNC强化特性），除非需要PAC验证（这种情况非常少见），目标服务会接受TGS票据中的所有数据，而无需与DC进行通信。</span></p><p><br/></p><p style="text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">五、使用Kerberoast破解服务账户密码</span></strong></span></p><hr/><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">Kerberoast是一种非常有效的方法，无需向目标系统发送任何报文，就能以普通用户身份从活动目录中提取服务账户凭证。因为人们往往会使用安全性较低的密码，所以这种攻击较为有效。大多数服务账户的密码长度与域密码长度所需的最小值相同（通常情况下为10或12个字符），这意味着即使使用暴力破解方法，所需的时间也不会比密码失效的时间长（即过期时间）。大多数服务密码没有设置过期时效，因此同一个密码可能适用于好几个月甚至好几年。此外，大多数服务账户权限过高，通常属于域管（Domain Admins）组成员，因此就具备活动目录的管理员权限（有时候服务账户只需要修改特定对象类型的属性，或者拥有特定服务器的管理员权限）。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">抵御这种攻击的最为有效的一种方法，就是确保服务账户的密码长度大于25个字符。我们可以依托托管服务账户以及组管理服务账户来确保服务账户的密码足够长、足够复杂以及定期修改。提供密码托管服务的第三方产品也是管理服务账户密码的有效方法。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">请注意：这种攻击方法不会影响Windows系统中托管的服务，因为这些服务映射到活动目录中的计算机账户，使用了128个字符长度的密码，无法在短时间内被破解。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">这种攻击需要为目标服务账户的服务主体名称（SPN）请求Kerberos服务票据（TGS）。为了发起请求，攻击者需要使用一个有效的域用户认证票据（TGT），为目标服务器上的目标服务请求一个或多个服务票据。域控不会去跟踪用户是否真正连接到这些资源（也不会去判断用户是否有访问权限）。域控在活动目录中查找SPN，使用对应的服务账户来加密票据，以便目标服务能够验证用户的访问权限。所请求的Kerberos服务票据的加密类型是RC4_HMAC_MD5，这意味着服务票据使用了服务账户的NTLM密码散列进行加密。因此，Kerberoast可以尝试不同的NTLM散列来打开Kerberos票据，一旦打开成功，就能获取正确的服务账户密码。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">获得服务票据的这一过程不需要提升权限，也没有任何流量会发往目标系统。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Tim Medin发布了</span><a href="https://github.com/nidem/kerberoast" target="_self" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Kerberoast Python TGS cracker</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">这个工具，并在</span><a href="https://files.sans.org/summit/hackfest2014/PDFs/Kicking%20the%20Guard%20Dog%20of%20Hades%20-%20Attacking%20Microsoft%20Kerberos%20%20-%20Tim%20Medin(1" target="_self" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">DerbyCon 2014</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">.pdf)上讨论了相关方法。</span></p><p style="text-align: center;"><img src="http://p0.qhimg.com/t019a45aef14941a149.png" title="t01499c5fddebb239c2.png" alt="http://p4.qhimg.com/t01499c5fddebb239c2.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">攻击者无需掌握目标服务器或目标网络的管理员权限就能破解服务账户密码。突破某台主机后，攻击者就可以使用服务账户请求多个服务的TGS票据，从内存中提取TGS票据，将票据保存到文件，然后上传至网站或者网络服务（如Google Drive）中。攻击者可以通过互联网获取这些文件，然后使用Kerberoast处理这些文件，直到识别出正确的NTLM密码散列为止。成功打开TGS就意味着攻击者已经拿到了服务账户密码。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">请注意，攻击者也可以通过嗅探网络流量来实施这种攻击，捕获使用RC4_HMAC_MD5加密的Kerberos TGS票据。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">我编写了一个PowerShell脚本，名为</span><a href="https://github.com/PyroTek3/PowerShell-AD-Recon/" target="_self" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Discover-PSMSSQLServers.ps1</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">，用来展示这种攻击过程。这个脚本可以发现域或森林中的所有的SQL服务器，识别对应的服务账户。如果发现域用户账户的存在，所关联的账户密码很有可能不会太强，因此该账户可以作为目标网络的突破口。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">1、利用SPN扫描发现具备服务账户的SQL服务器。</span></p><p style="text-align: center;"><img src="http://p6.qhimg.com/t01c35ef6352afd3673.png" title="t01dc28cbd20be12641.png" alt="http://p1.qhimg.com/t01dc28cbd20be12641.png"/></p><p style="text-align: center;"><img src="http://p4.qhimg.com/t01b7e58ffd338d5ca1.png" title="t013662425e0d75eed6.png" alt="http://p8.qhimg.com/t013662425e0d75eed6.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">2、识别目标后，我们使用PowerShell请求特定服务主体名称（SPN）的服务票据</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">请注意：这里我们所请求的服务票据使用了RC4加密类型。</span></p><p style="text-align: center;"><img src="http://p7.qhimg.com/t018b329c5919a5561d.png" title="t011ac06c29936bd0fe.png" alt="http://p1.qhimg.com/t011ac06c29936bd0fe.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">观察捕获的数据包，我们可以发现Kerberos通信报文，注意其票据类型为RC4-HMAC-MD5。</span></p><p style="text-align: center;"><img src="http://p6.qhimg.com/t014e0b5b9c974431e0.png" title="t01da7642c5271cab29.png" alt="http://p8.qhimg.com/t01da7642c5271cab29.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">3、客户端收到票据后，无需提升权限，我们就可以使用</span><a href="https://adsecurity.org/?p=2207" target="_self" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Mimikatz</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">（或其他工具）从用户的内存空间中提取所有的Kerberos票据。</span></p><p style="text-align: center;"><img src="http://p4.qhimg.com/t01418242b406642eb1.png" title="t015ae7cbbdf0d302a5.png" alt="http://p3.qhimg.com/t015ae7cbbdf0d302a5.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">4、将服务票据导出为文件后，我们可以将该文件发送给攻击主机，我们的攻击主机使用的是Kali Linux系统，包含Kerberoast工具。结合合适的字典文件（wordlist.txt），我们有可能能破解票据文件所关联的服务账户的密码。</span></p><p style="text-align: center;"><img src="http://p8.qhimg.com/t01b91f0deee39f9769.png" title="t010538a62ae3106736.png" alt="http://p3.qhimg.com/t010538a62ae3106736.png"/></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">现在，攻击者已经掌握了目标服务器上有效的服务账户的用户名及密码，因此很有可能掌握了目标服务器的管理员权限。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">许多企业内部通常会给服务账户赋予过高的权限，并且这些账户经常会使用弱口令，因此攻击者可以利用这些脆弱性实现从普通域用户到域管用户的提升。</span></p><p><br/></p><p style="text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">六、缓解策略</span></strong></span></p><hr/><p style="text-indent: 2em;"><span style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">请确保所有的服务账户（即带有服务主体名称的用户账户）使用较长的、复杂的密码，密码长度要大于25个字符，最好是30或30以上个字符。这样就能使密码的破解更为困难。具备较高活动目录权限的服务账户应该是重点防护对象，要确保这些账户使用较长且复杂的密码。同时，我们要确保服务账户的密码定期更换（每年至少应当更换一次）。如果有可能的话，我们可以使用</span><a href="https://technet.microsoft.com/en-us/library/hh831782%28v=ws.11%29.aspx?f=255&MSPPError=-2147217396" target="_self" style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; color: rgb(227, 108, 9); text-decoration: underline;"><span style="color: rgb(227, 108, 9);"><strong>组管理服务账户</strong></span></a><span style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">来管理密码，这样活动目录就能自动管理密码，确保账户使用随机且复杂的密码（密码长度大于100个字符）。</span></p><p><br/></p><p style="text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">七、检测方法</span></strong></span></p><hr/><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-indent: 2em;">检测这类攻击非常困难，因为每当用户需要访问资源时，都需要请求服务票据（Kerberos TGS票据）。寻找具有RC4加密类型的TGS-REQ报文可能是最为有效的方法，虽然这种检测方法可能会得到假阳性结果。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">我们可以启用Kerberos服务票据请求监控功能（“审计Kerberos服务票据操作”），在日志中搜索与</span><a href="https://www.ultimatewindowssecurity.com/securitylog/encyclopedia/event.aspx?eventid=4769" target="_self" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline; color: rgb(227, 108, 9);"><span style="color: rgb(227, 108, 9);"><strong><span style="color: rgb(227, 108, 9); font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">4769事件</span></strong></span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">有关的用户，来监控活动目录中大量的Kerberos服务票据请求（4769事件表示的是“请求Kerberos服务票据（A Kerberos service ticket was requested）”）。</span></p><p><br/></p><p style="text-indent: 2em;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">八、参考资料</span></strong></span></p><hr/><p style="text-indent: 2em;"><span style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">[1] Sean Metcalf关于活动目录安全的</span><a href="https://adsecurity.org/?page_id=1352" target="_self" style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">演讲</a><span style="text-indent: 2em; font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">[2] </span><a href="https://github.com/nidem/kerberoast" target="_self" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">Kerberoast</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">[3] Tim Medin在DerbyCon 2014上发表的“攻击微软Kerberos机制”的演讲（</span><a href="https://files.sans.org/summit/hackfest2014/PDFs/Kicking%20the%20Guard%20Dog%20of%20Hades%20-%20Attacking%20Microsoft%20Kerberos%20%20-%20Tim%20Medin(1" target="_self" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">幻灯片</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">.pdf)及</span><a href="https://www.youtube.com/watch?v=PUyhlN-E5MU&feature=youtu.be" target="_self" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">视频</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">材料）。</span></p><p style="text-indent: 2em;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">[4] 我个人的</span><a href="https://github.com/PyroTek3/PowerShell-AD-Recon" target="_self" style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;; text-decoration: underline;"><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">GitHub仓库</span></a><span style="font-family: 微软雅黑, &quot;Microsoft YaHei&quot;;">。</span></p></p>
                <hr/>
                <p style="text-align: center;">
                    <img src="http://bobao.360.cn/img/app.jpeg"/>
                    <img src="http://bobao.360.cn/img/weixin.jpeg"/>
                </p>
                                <p>本文由 安全客 原创发布，如需转载请注明来源及本文地址。<br/>本文地址：http://bobao.360.cn/learning/detail/4256.html
                </p>
                            </div>
            <div style="margin-top: 20px;background-color:#FFFFFF">
    <input type="hidden" id="detail_title" name="detail_title" value="使用Kerberoast破解Kerberos TGS票据：利用Kerberos突破活动目录域 - 安全客 - 有思想的安全新媒体" />
    <input type="hidden" id="use_nickname" name="use_nickname" value="0" />
    <a name="mao"></a>
    <div class="reg-log mobile-hiden">
        <div class="" id="userTo">   
            <div id="to-list" class="input-text" style="">
                <textarea disabled="disabled" class="hide"  id="comment-content" to="to"></textarea>
                <ul id="preadded" style="display:none">       
                </ul>
                <div id="to-auto" style="width: 200px">
                    <ul id="feed">
                    </ul>
                </div>
            </div>
        </div>
        <input type="hidden" id="source-id" value="4256" />
        <input type="hidden" id="source-type" value="learning" />
        <input type="hidden" id="post-comment-url" value="/comment/add" />
        <input type="hidden" id="post-nickname-url-ajax" value="/comment/randnicknameajax" />
        <input type="hidden" id="post-check-login-url-ajax" value="/comment/checklogin" />
        <input type="hidden" id="stoken_comment_set" value="ea3898fb4df38673fdeb61c458234054">                 <span class="join">参与讨论，请先 <a href="javascript:;" class="comment-login">登录</a> | <a href="javascript:;" class="comment-reg">注册</a> |  <a href="javascript:;" class="anonymous-comment">匿名评论</a></span>
            </div>
    <div class="mobile-hide" style="width: 870px; margin: 0 auto;">
        <label style="vertical-align:middle;" for="use_nickname">匿名</label> 
        <input style="vertical-align:middle;" id="trigger-nickname" name="use_nickname" class="use_nickname" type="checkbox" value="0" />

        <a href="javascript:;" class="apply-use button" id="submit-comment" data-target="/comment/add">发布</a>
    </div>


    <div class="clearfix"></div>
    <div class="comments">
        <div class="comments-head">
            <span class="title">用户评论</span>
        </div>
                <div class="comment-none alarm-info bg-primary">无任何评论</div>
            </div>
</div>
<script>
    $(function () {
        $('.anonymous-comment').click(function () {
            $(".join").hide();
            $(".reg-log textarea").first().removeAttr("disabled").show();
            $('#use_nickname').val('1');
//            $('#trigger-nickname').attr('checked', true);
            $('#trigger-nickname').trigger('click');
        });
        //为所有复选框绑定事件
//        checkbox_on_click();
        //ajax随机获取昵称
//        randnicknameajax(0);
        //ajax检测登录状态
        comment_check_login();
    });



    function input_checkbox(flag) {
        $('input:checkbox').each(function () {
            var value = flag ? 1 : 0;
            $(this).prop('checked', flag);
            $(this).val(value);
        });
    }

//ajax随机获取昵称
    function randnicknameajax(flag) {
        $.ajax({
            type: 'POST',
            url: $('#post-nickname-url-ajax').val(),
            data: {limit: 1, flag: flag},
            dataType: "json",
            success: function (data) {
                $('#nick-name').val(data.data[0]);
                _nick_name=data.data[0];
            }
        });
    }
    $();
//ajax检测登录状态
    function comment_check_login() {
        $.ajax({
            type: 'POST',
            url: $('#post-check-login-url-ajax').val(),
            data: {},
            dataType: "json",
            success: function (data) {
                if (data.success) {
                    $('.join').hide();
                    $(".reg-log textarea").first().removeAttr("disabled").show();
                    $("#span_use_nickname").show();
                    $('#use_nickname').val('0');
                    $('#use_nickname').attr('checked', false);
                }
            }
        });
    }
</script>        </div>
    </div>
    <div class="side-bar">
        <div class="mod hot-news">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-hot"></i><span>热门知识</span></h2>
    </div>
    <ul class="links-list">
                                <li><a href="/learning/detail/4411.html" alt="【漏洞预警】一个换行符引发的奥斯卡0day漏洞(CVE-2017-8759)重现——最新的Office高级威胁攻击预警" target="_blank">【漏洞预警】一个换行符引发的奥斯卡...</a></li>
                                <li><a href="/learning/detail/4416.html" alt="【漏洞预警】Microsoft .NET Framework漏洞（CVE–2017–8759）预警" target="_blank">【漏洞预警】Microsoft .NE...</a></li>
                                <li><a href="/learning/detail/4414.html" alt="【技术分享】妙用JavaScript绕过XSS过滤" target="_blank">【技术分享】妙用JavaScrip...</a></li>
                                <li><a href="/learning/detail/4418.html" alt="【技术分享】利用威胁情报数据平台拓展APT攻击线索一例" target="_blank">【技术分享】利用威胁情报数据平台拓...</a></li>
                                <li><a href="/learning/detail/4417.html" alt="【知识】9月15日 - 每日安全知识热点" target="_blank">【知识】9月15日 - 每日安全知识热...</a></li>
                                <li><a href="/learning/detail/4425.html" alt="【安全报告】XShellGhost事件技术回顾报告" target="_blank">【安全报告】XShellGhost事件...</a></li>
            </ul>
</div>        <!-- 友情链接 -->
        <div class="mod blog-links mobile-hide">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-link"></i><span>友情链接</span></h2>
        <a href="/links/index.html" class="more">更多<i></i></a>
    </div>
        <ul class="links-list">
                <li><a href="http://bbs.360safe.com" alt="360安全社区" target="_blank">360安全社区</a></li>
                <li><a href="http://zhuji.360.cn" alt="360主机卫士" target="_blank">360主机卫士</a></li>
                <li><a href="http://blogs.360.cn/" alt="奇虎360技术博客" target="_blank">奇虎360技术博客</a></li>
                <li><a href="http://wangzhan.360.cn/" alt="360网站卫士" target="_blank">360网站卫士</a></li>
                <li><a href="http://webscan.360.cn/" alt="360网站安全检测" target="_blank">360网站安全检测</a></li>
                <li><a href="http://research.360.cn/report/" alt="360研究报告" target="_blank">360研究报告</a></li>
                <li><a href="http://unicorn.360.cn/" alt="360 Unicorn Team" target="_blank">360 Unicorn Team</a></li>
                <li><a href="http://appscan.360.cn/" alt="360捉虫猎手" target="_blank">360捉虫猎手</a></li>
                <li><a href="https://threathunter.org/" alt="ThreatHunter社区" target="_blank">ThreatHunter社区</a></li>
                <li><a href="http://security.360.cn/" alt="360安全应急响应中心" target="_blank">360安全应急响应中心</a></li>
            </ul>
    </div>
        <!-- 联系我们 -->
        <div class="mod contact mobile-hide" style="text-align:center">
    <div class="head-bar clearfix">
        <h2><i></i><span>关注我们</span></h2>
    </div>
    <!-- 微信关注 -->
    <ul class="contact-way">
        <li><a>微信关注</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/qrcode_adlab_weixin.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
    <!-- APP下载 -->
    <ul class="contact-way">
        <li><a>安全播报APP</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/scan_code_big.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
</div>

    </div>
</div>

<script type="text/javascript" src="/js/jquery-ui.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/jquery.noty.packaged.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/common.js?v=4.5"></script>
<script>$(function() {sync_count('comment');});</script>


<!-- 语法高亮 -->
<script type="text/javascript" src="/ue/SyntaxHighlighter/shCore.js"></script>
<script type="text/javascript">SyntaxHighlighter.all();sync_count('vul');sync_count('news');sync_count('learning');sync_count('activity');sync_count('course');sync_count('ctf');</script>
    </div>

        <div class="footer">
        <div class="friend-link">
            <a href="http://www.360.cn/" target="_blank">360首页</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">关于我们</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">联系我们</a>
            <span>|</span>
            <a href="/links/index.html" target="_blank">友情链接</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">招贤纳士</a>
        </div>
        <div class="copy">
            Copyright &copy; 360网络攻防实验室 All Rights Reserved <span class="copy_icp">京ICP证080047号[京ICP备08010314号-6]</span>
        </div>
    </div>
    
</div>

<!--奇舞团统计-->

<script src='https://s.ssl.qhimg.com/static/f5407c785655e6a1/monitor_analytic.js'></script>
<script>
    monitor.setProject('QH_171_1').getTrack().getClickAndKeydown().getClickHeatmap(10, 1);
</script>

<div class="hide">
    <script src="https://s95.cnzz.com/z_stat.php?id=1253147824&web_id=1253147824" language="JavaScript"></script>
</div>
<div class="backToTop_wrap off">
    <a id="back_to_top" class="backToTop" href="javascript:;" title="返回顶部"></a>
</div>
<script>
    var $backToTop_wrap = $(".backToTop_wrap"),
        $backToTop_btn = $("#back_to_top");

    if ($(window).scrollTop() > 100) {
        $backToTop_wrap.removeClass("off");
    }
    else {
        $backToTop_wrap.addClass("off");
    }

    $(window).on("scroll", function () {
        if ($(this).scrollTop() > 100) {
            $backToTop_wrap.removeClass("off");
        }
        else {
            $backToTop_wrap.addClass("off");
        }
    });

    $backToTop_btn.on("click", function () {
        $("html, body").animate({scrollTop: 0}, 120);
    });

    $(function () {
        var navlist = $('.nav-list > li');

        navlist.each(function () {
            $(this).on('mouseenter', function () {
                $(this).addClass('selected');
            });

            $(this).on('mouseleave', function () {
                $(this).removeClass('selected');
            });
        });
    })
</script>



</body>
</html>
