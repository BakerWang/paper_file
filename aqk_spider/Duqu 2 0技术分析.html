<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns:wb="http://open.weibo.com/wb" xml:lang="en" lang="en">
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"/>
    <link rel="shortcut icon" href="http://bobao.360.cn/favicon.ico?v=1.1"/>
    <link rel="alternate" title="安全资讯" href="/rss?type=news" type="application/rss+xml"/>
    <link rel="alternate" title="安全知识" href="/rss?type=learning" type="application/rss+xml"/>
    <link rel="alternate" title="安全圈活动" href="/rss?type=activity" type="application/rss+xml"/>
    <link rel="alternate" title="所有漏洞" href="/rss?type=vul" type="application/rss+xml"/>
    <link rel="alternate" title="通用型漏洞" href="/rss?type=commonvul" type="application/rss+xml"/>
    <link rel="alternate" title="事件型漏洞" href="/rss?type=eventvul" type="application/rss+xml"/>
    <link rel="alternate" title="热门漏洞" href="/rss?type=hotvul" type="application/rss+xml"/>

        <title>Duqu 2.0技术分析 - 安全客 - 有思想的安全新媒体</title>
    
        <meta name="keywords" content="Duqu 2.0,技术分析,CVE-2015-2360,Duqu 2.0技术分析"/>
    
        <meta name="description" content="本译文译者为安天实验室工程师，本文系出自个人兴趣在业余时间所译，本文原文来自互联网的公共方式，译者力图忠于所获得之电子版本进行翻译，但受翻译水平 和技术水平所限，不能完全保证译文完全与原文含义一致，同时对所获得原文是否存在臆造、或者是否与其原始版本一致未进行可靠性验证和评价。"/>
        <meta property="wb:webmaster" content="224437c7be31d633"/>

    <script type="text/javascript" src="http://s7.qhimg.com/!56caa871/xpc_sync_height.js"></script>
    <link rel="stylesheet" type="text/css" href="/css/reset.css" />
    <link rel="stylesheet" type="text/css" href="/css/common_new.css?v=4.4.2.1" />
    <link rel="stylesheet" type="text/css" href="/css/jquery.notyfy.css" />
    <link rel="stylesheet" type="text/css" href="/css/notyfy.theme.default.css" />
    <link rel="stylesheet" type="text/css" href="/css/s_common.css?v=2.2.7" media="only screen and
    (max-device-width:900px), only screen and (max-width:900px)" />
    <script type="text/javascript" src="/js/jquery.min.js?v=3.1"></script>
    <script type="text/javascript" src="/js/jquery.notyfy.js"></script>
    <script type="text/javascript" src="/js/iscroll.js"></script>
    <script src="http://js.passport.qihucdn.com/5.0.3.js"></script>
    <script type="text/javascript">
        var myScroll, myNavScroll;

        function iscrollLoaded() {
            myScroll = new IScroll('#wrapper',
                {
                    scrollX: true,
                    scrollY: false,
                    bounceEasing: 'circular',
                    eventPassthrough: true,
                    preventDefault: false,
                    bounceTime: 500
                }
            );
        }

        $(function () {

            //导航横向滚动


            function setNavWidth() {

                /* 计算导航宽度 */
                var allWidth = $(window).width();
                var scroller = $('#scroller');

                if (allWidth > 900) {
                    scroller.find('ul').add(scroller.find('.scroll')).removeAttr('style');
                    scroller.css('overflow', 'visible');
                    if (myNavScroll) myNavScroll.destroy();
                } else {

                    var width = 0;
                    scroller.find('.scroll').children('ul').children('li').each(function (index, el) {
                        if (!$(this).hasClass('mobile-hide')) {
                            width += $(this).outerWidth();
                        }
                    });
                    scroller.find('ul').add(scroller.find('.scroll')).width(width);

                    if (myNavScroll) myNavScroll.destroy();

                    myNavScroll = new IScroll('#scroller', {
                        scrollX: true,
                        scrollY: false,
                        momentum: false,
                        click: true
                    });

                }

            }

            setNavWidth();
            $(window).resize(function (event) {
                setNavWidth();
            });

        });

    </script>
</head>
<body onload="iscrollLoaded();">
<div style='margin:0 auto;width:0px;height:0px;overflow:hidden;'>
    <img src=""/>
</div>

<div id="is-mobile"></div>
<div class="container">
        <div class="mobile-header">
        <div class="header clearfix">
            <div class="header-wrapper clearfix">
                <a href="/index/index" class="logo"><img class="slogan" src="/img/logo.png?v=1.5"/></a>
                                <form id="search" class="search-box" action="/search/index" method="GET">
                    <input class="keys" name="keywords" type="text" placeholder="搜索漏洞" required="required">
                    <input class="icon" type="submit" value="">
                    <input type="hidden" name="type" value=""/>
                </form>
                <div class="bug">
                    <div class="name"><span class="seled">全部</span><i class="arrow"></i></div>
                    <ul class="typelist">
                        <li data-index="3"><a href="javascript:void(0);">全部</a></li>
                        <li data-index="0"><a href="javascript:void(0);">漏洞</a></li>
                        <li data-index="1"><a href="javascript:void(0);">资讯</a></li>
                        <li data-index="2"><a href="javascript:void(0);">知识</a></li>
                    </ul>
                </div>
                                <div class="logNreg mobile-hide">
                    <div class="unlog">
                        <i></i>
                        <a href="log.html" class="log">登录</a>
                        <span>|</span>
                        <a href="reg.html" class="reg">注册</a>
                    </div>
                    <div class="loged">
                        <a href="/member/profile" class="user-center"><i></i><span class="user-name-tag">个人中心</span></a>
                        <div class="user-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting"><a href="http://i.360.cn/profile/accountmanage"
                                                               target="_blank"><i></i><span>账号设置</span></a></li>
                                <li class="alert-setting"><a href="/keywords/index"
                                                             target="_blank"><i></i><span>告警设置</span></a></li>
                                <li class="bug-alert"><a href="/myalarm/index" target="_blank"><i></i><span>漏洞告警</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mylearn/index" target="_blank"><i></i><span>我的知识</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mycourse/index" target="_blank"><i></i><span>我的课堂</span></a>
                                </li>
                                <li class="my-exit"><a
                                            href="http://login.360.cn/?src=pcw_adlab&op=logout&destUrl=http://bobao.360.cn"><i></i><span>退出系统</span></a>
                                </li>
                            </ul>
                        </div>

                        <a href="/message" class="message-center" target="_blank"><i></i><span>我的消息</span></a>
                        <div class="message-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting" style="display:none;"><a href="/myres/index"
                                                                                     target="_blank"><i></i><span>回复我的</span></a>
                                </li>
                                <li class="my-bug"><a href="/myvul/index"
                                                      target="_blank"><i></i><span>我的漏洞</span></a></li>
                                <!--<li class="my-bug"><a href="/myres/index" target="_blank"><i></i><span>我的评论</span></a></li>-->
                                <!--<li class="alert-setting"><a href="###" target="_blank"><i></i><span>提到我的</span></a>
                                </li>-->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <style type="text/css">
            .nav {
                overflow: hidden;
            }

            .nav .scroll {
                width: auto;
            }
        </style>
        <div id="wrapper">
            <div id="scroller" class="nav">
                <div class="scroll">
                    <ul class="nav-list">
                        <li ><a class="link-nav"
                                                                                 href="/index/index">首页</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/vul/index">漏洞</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/introduce/list">招聘</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/news/index">资讯</a><!--<i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/introduce/list">招聘</a></li>
                        </ul>
			-->
                        </li>
                        <li class="cur">
                        <a class="link-nav" href="/learning/index">知识</a><i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/course/index">学院</a></li>
                        </ul>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/activity/index">活动</a></li>
                        <li class="mobile-hide "><a class="link-nav"
                                                                                                   href="/ctf/index">CTF训练营</a>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/interref/list">安全内参</a></li>
                        <li ><a class="link-nav" href="/app/index">APP</a></li>

                        <!--<li ><a href="/course/index">学院</a></li>-->
                        <!--<li ><a href="/introduce/list">招聘</a></li>-->
                        <!--<li  class="mobile-hide"><a href="/ctf/index">CTF训练营</a></li>-->
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="mobile-content">
        <link rel="stylesheet" type="text/css" href="/css/news.css?v=3.5" />
<link rel="stylesheet" type="text/css" href="/ue/SyntaxHighlighter/shCoreDefault.css?v=1.0" />
<style>
    p .syntaxhighlighter {
        width: 80%;
    }
</style>

<div class="cur-pos w1000">当前位置：<a href="http://bobao.360.cn/">安全客</a> &gt;&gt; 知识详情</div>

<div class="content clearfix">
    <div class="main">
        <div class="article">
            <div id="article_box">
                <h2>Duqu 2.0技术分析</h2>
                <div class="article-msg">
                    <span class="time">2015-06-18 10:48:08</span>
                                        <span class="read">阅读：22023次</span>
                    <span><a style="display: none;" class="good" href="javascript:;"
                             data-target="/learning/good" data-value="g_458"
                             data-type="learning">点赞(0)</a></span>
                    <span><a class="fav" href="javascript:;" data-target="/mylearning/add"
                             data-pk="458" data-type="learning">收藏</a></span>
                                        <span><a style="margin-left: 4px;" class="fav" href="http://bbs.antiy.cn/forum.php?mod=viewthread&amp;tid=62877#rd"
                             target="_blank">来源： 安天实验室</a></span>
                    
                                    </div>
                <hr size="1">
                <div class="article-msg">
                    <p><!-- JiaThis Button BEGIN -->

<!--
<span class="jiathis_style"><span class="jiathis_txt">分享到：</span>
	<a class="jiathis_button_weixin"></a>
	<a class="jiathis_button_tsina"></a>
    <a class="jiathis_button_tqq"></a>
    <a class="jiathis_button_qzone"></a>
    <a class="jiathis_button_renren"></a>
    <a class="jiathis_button_xiaoyou"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
</span>

-->
</p>
                </div>
                <p><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;"><strong>免责声明：<br style="text-align: left;"/><br style="text-align: left;"/>-&nbsp; &nbsp; &nbsp; &nbsp; 
本译文译者为安天实验室工程师，本文系出自个人兴趣在业余时间所译，本文原文来自互联网的公共方式，译者力图忠于所获得之电子版本进行翻译，但受翻译水平
和技术水平所限，不能完全保证译文完全与原文含义一致，同时对所获得原文是否存在臆造、或者是否与其原始版本一致未进行可靠性验证和评价。<br style="text-align: left;"/><br style="text-align: left;"/>-&nbsp; &nbsp; &nbsp; &nbsp; 
本译文对应原文所有观点亦不受本译文中任何打字、排版、印刷或翻译错误的影响。译者与安天实验室不对译文及原文中包含或引用的信息的真实性、准确性、可靠
性、或完整性提供任何明示或暗示的保证。译者与安天实验室亦对原文和译文的任何内容不承担任何责任。翻译本文的行为不代表译者和安天实验室对原文立场持有
任何立场和态度。<br style="text-align: left;"/>-&nbsp; &nbsp; &nbsp; &nbsp; 译者与安天实验室均与原作者与原始发布者没有联系，亦未获得相关的版权授权，鉴于译者及安天实验室出于学习参考之目的翻译本文，而无出版、发售译文等任何商业利益意图，因此亦不对任何可能因此导致的版权问题承担责任。</strong><br style="text-align: left;"/><br style="text-align: left;"/><strong>原文名称</strong>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;The Duqu 2.0 Technical Details<br style="text-align: left;"/><strong>原文作者</strong>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;全球研究和分析团队&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;<br style="text-align: left;"/><strong>原文发布日期</strong>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;2015年6月9日<br style="text-align: left;"/><strong>作者简介</strong>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;卡巴斯基实验室的全球研究和分析团队（GReAT）是公司最重要的资产之一，由最顶尖的安全研究专家们分析最新及最先进的网络威胁。创建于2008年，GReAT保证了公司在反恶意软件研究及创新领域的领导地位。</span><a style="text-decoration: underline; font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;" href="http://zh.wikipedia.org/zh-tw/%E5%8D%A1%E5%B7%B4%E6%96%AF%E5%9F%BA%E5%AF%A6%E9%A9%97%E5%AE%A4" target="_blank"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">http://zh.wikipedia.org/zh-tw/%E5%8D%A1%E5%B7%B4%E6%96%AF%E5%9F%BA%E5%AF%A6%E9%A9%97%E5%AE%A4</span></a> <br style="text-align: left;"/><br style="text-align: left;"/><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;"><strong>原文发布单位</strong>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;卡巴斯基实验室<br style="text-align: left;"/><strong>原文出处</strong>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;</span><a style="text-decoration: underline; font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;" href="https://securelist.com/files/2015/06/The_Mystery_of_Duqu_2_0_a_sophisticated_cyberespionage_actor_returns.pdf" target="_blank"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">https://securelist.com/files/2015/06/The_Mystery_of_Duqu_2_0_a_sophisticated_cyberespionage_actor_returns.pdf</span></a> <br style="text-align: left;"/><br style="text-align: left;"/><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;"><strong>译者 </strong>&nbsp; &nbsp;&nbsp; &nbsp; 安天技术公益翻译组&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;<strong>校对者</strong>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;安天技术公益分析组<br style="text-align: left;"/><br style="text-align: left;"/> <br style="text-align: left;"/><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 32px;">执行摘要</span><br style="text-align: left;"/>今年早些时候，卡巴斯基实验室在一次安全扫描中检测到了影响几个内部系统的网络入侵活动。<br style="text-align: left;"/>根据这一发现，我们进行了大规模的调查，发现了来自最熟练、神秘而强大的APT组织之一的恶意软件平台Duqu。Duqu攻击者在2012年归于沉寂，被
认为已经停止了攻击活动，但是现在又活跃起来。我们的技术分析表明，新一轮的攻击包括臭名昭著的2011 年Duqu恶意软件 
的更新版本，有时也被称为Stuxnet蠕虫的半个兄弟 。我们将这一新的恶意软件及其相关平台命名为“Duqu 2.0”。<br style="text-align: left;"/>Duqu 2.0的受害者遍布世界各地，包括西方国家、中东和亚洲地区。攻击者似乎攻击功利性目标和其他目标，这促使他们提高网络能力。<br style="text-align: left;"/>最值得注意的是，2014 - 2015年的一些新感染涉及P5 + 1活动和伊朗核谈判场所。Duqu背后的攻击者似乎喜欢对此类高级会谈的场所发动攻击。除了P5 + 1活动，Duqu 2.0组织还对奥斯维辛-比克瑙解放70周年 纪念活动发动了类似攻击。<br style="text-align: left;"/>在卡巴斯基实验室的攻击案例中，攻击者利用了一个Windows Kernel零日漏洞（CVE-2315-2360），微软于2015年6月9日修复了该漏洞；攻击可能还利用了其他两个目前已被修复的漏洞，它们当时也属于零日漏洞。<br style="text-align: left;"/> <br style="text-align: left;"/><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 32px;">初始攻击</span><br style="text-align: left;"/>针对卡巴斯基实验室的初始攻击以我们亚太区的一个小办公室的员工为目标。Duqu 
2.0的初始感染向量目前未知，但是我们怀疑鱼叉式网络钓鱼电子邮件发挥了重要作用。这是因为其中一个受害者Zero的邮箱和网络浏览器的记录被清除了，
目的是隐藏攻击痕迹。鉴于各个机器是完全修复的，我们认为攻击者利用了一个零日漏洞。<br style="text-align: left;"/>2011年，我们发现了利用Word文档的Duqu攻击，该文档包含的零日漏洞（CVE-2011-3402）依赖于一个恶意的嵌入式TTF（True 
Type字体文件）。该漏洞允许攻击者从Word文档直接跳转到内核模式，这是一种非常强大的、极为罕见的技术。类似的技术和零日漏洞（CVE-
2014-4148 
）于2014年6月又出现在了针对一个知名国际组织的攻击中。2014年攻击使用的C&amp;C服务器和其他因素与Duqu有一定的相似性，但是该恶意
软件与Duqu和Duqu 
2.0都有所不同。可能的情况是：这是与Duqu组织平行的攻击项目，同样的零日漏洞（CVE-2014-4148）可能用于安装Duqu 2.0。<br style="text-align: left;"/>一旦攻击者成功感染一台机器，他们就会进入下一个阶段。<br style="text-align: left;"/><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 32px;">横向运动</span><br style="text-align: left;"/>在一般情况下，一旦攻击者进入网络，就会执行以下两个阶段：<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;侦察和识别网络拓扑<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;横向运动<br style="text-align: left;"/>在Duqu 2.0的情况下，横向运动技术似乎利用了另一个零日漏洞（CVE-2014-6324），该漏洞于2014年11月由微软MS14-068 
公告修复。该漏洞允许非特权用户提权至管理员帐户。虽然我们无法检索该漏洞的副本，但是记录的事件与微软给出的检测指导相一致。我们还发现，恶意模块在本
地网络中执行“哈希传递”攻击，有效地给予攻击者多种不同的横向运动方式。<br style="text-align: left;"/>一旦攻击者获得了域名管理员权限，他们就能够利用这些权限感染该域中的其他计算机。<br style="text-align: left;"/>为了感染该域中的其他计算机，攻击者使用几个不同的策略。在我们发现的大多数攻击中，攻击者准备微软Windows安装程序包（MSI），然后将其远程部署到其他机器。为了启动它们，攻击者通过下述命令行在目标机器中创建一个服务：<br style="text-align: left;"/>msiexec.exe /i “C:\\[…]\tmp8585e3d6.tmp” /q PROP=9c3c7076-d79f-4c <br style="text-align: left;"/><br style="text-align: left;"/>PROP值被设定为随机56位加密密钥，解密安装包中的主要有效载荷需要该密钥。该参数的其他已知名称为“HASHVA”和“CKEY”。在各个案例中，安装包所在的文件夹各不相同，这取决于攻击者能够在远程计算机上访问什么。<br style="text-align: left;"/>除了创建服务来感染局域网中的其他计算机，攻击者还可以使用Task Scheduler（任务计划程序）来远程启动“msiexec.exe”。在2011年的Duqu感染中，Task Scheduler也用于横向运动中，赛门铁克在技术分析报告中做了介绍。 <br style="text-align: left;"/></span></p><p style="text-align:center"><img _load="1" id="aimg_460681" src="http://bbs.antiy.cn/data/attachment/forum/201506/16/112049zap10s00xltpzaco.png" width="672"/></p><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">“msiexec.exe”：日志中的Task Schedule痕迹<br style="text-align: left;"/>攻击中使用的MSI文件包含一个恶意的存根，它作为加载程序。该存根从MSI文件中加载其他恶意软件资源并将其解密，然后再内存中执行解密的代码。<br style="text-align: left;"/></span></p><p style="text-align:center"><img _load="1" id="aimg_460682" src="http://bbs.antiy.cn/data/attachment/forum/201506/16/112115h2zzx6xxrgxsetxx.png" width="800"/></p><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">从MSI文件（红色标注）加载其他资源的恶意存根<br style="text-align: left;"/>在各个案例中，安装包所用的加密算法都有所不同。需要指出的是，攻击者非常谨慎，在每次攻击中使用独特的方法、加密算法和名称（如文件名）。当其中某一个被发现后，这样能够规避安全产品的检测，同时能够限制杀毒软件公司的检测能力。<br style="text-align: left;"/>到目前为止，我们发现攻击者使用了以下加密算法：<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;Camellia<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;AES<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;XTEA<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;RC4<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;不同的多字节XOR加密技术<br style="text-align: left;"/>对于压缩算法，我们发现了如下几种：<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;LZJB<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;LZF<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;FastLZ<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;LZO<br style="text-align: left;"/>&nbsp; &nbsp; 在本质上，每个攻击平台使用独特的算法组合，使其非常难以检测。<br style="text-align: left;"/>攻击者可以在受害者机器中部署两种类型的安装包：<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;“基本的”、内存远程后门（约500K）。<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;功能齐全的、具备C＆C功能的、内存间谍活动平台（18MB）。<br style="text-align: left;"/>它们具有相似的结构，如下所示：<br style="text-align: left;"/></span></p><p style="text-align:center"><img _load="1" id="aimg_460683" src="http://bbs.antiy.cn/data/attachment/forum/201506/16/112531n1nrrp9zyr5hl95z.png" width="800"/></p><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">恶意Duqu 2.0 MSI安装包<br style="text-align: left;"/>在上面的截图中，我们可以看到加载器（ActionDll：17,920字节）和主要有效载荷（ActionData0：476,736字节）。在执行时，ActionDll被加载，将控制权传递给唯一输出函数StartAction。<br style="text-align: left;"/>“基本的”内存远程后门通过域控制器定期进入该域中的其他计算机--几乎像是蠕虫感染。这使得攻击者能够进入该域中的大多数机器；如果进一步的访问权限，他们可以上传能够部署数十个不同插件的更复杂的MSI文件，用来收集信息。<br style="text-align: left;"/>接下来，我们详细介绍“基本的”内存远程后门的加载机制。<br style="text-align: left;"/>Duqu 2.0 MSI安装包的分析<br style="text-align: left;"/>文件名：随机/随案例不同<br style="text-align: left;"/>MD5（例如，可以改变）：14712103ddf9f6e77fa5c9a3288bd5ee<br style="text-align: left;"/>大小：503296字节<br style="text-align: left;"/>文件属性<br style="text-align: left;"/>MSI文件具有以下一般属性：<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;复合V2文档<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;低字节序<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;操作系统：Windows， 6.1版本<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;代码页：1252<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;标题：{7080A304-67F9-4363-BBEB-4CD7DB43E19D}（随机生成的GUID）<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;主题：{7080A304-67F9-4363-BBEB-4CD7DB43E19D}<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;作者：{7080A304-67F9-4363-BBEB-4CD7DB43E19D}<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;关键词：{7080A304-67F9-4363-BBEB-4CD7DB43E19D}<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;注释：{7080A304-67F9-4363-BBEB-4CD7DB43E19D}<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;模板：英特尔，1033<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;上次保存者：{7080A304-67F9-4363-BBEB-4CD7DB43E19D}<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;修订编号：{4ADA4205-2E5B-45B8-AAC2-D11CFD1B7266}<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;页数：100<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;字数：8<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;创建应用程序名称：Windows安装程序XML（3.0.5419.0）<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;安全性：4<br style="text-align: left;"/>应当指出的是，用于其他攻击的MSI文件可以具有不同的其它属性。例如，我们发现了以下字段。<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;厂商：Microsoft或InstallShield<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;版本：1.0.0.0或 1.1.2.0或2.0.0.0<br style="text-align: left;"/>其中一些可以通过Windows资源管理器文件属性对话框查看：<br style="text-align: left;"/></span></p><p style="text-align:center"><img _load="1" id="aimg_460684" src="http://bbs.antiy.cn/data/attachment/forum/201506/16/112612sxx4hf6sh88bh4hr.png" width="504"/></p><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">MSI安装包中有两个二进制块：<br style="text-align: left;"/></span></p><p style="text-align:center"><img _load="1" id="aimg_460685" src="http://bbs.antiy.cn/data/attachment/forum/201506/16/112613mgunag36iy03bjau.png" width="512"/></p><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;"> <br style="text-align: left;"/>第一个二进制块称为ActionDll，它实际上是一个Windows PE 
DLL文件；另一个是Camellia加密和LZJB压缩的有效载荷（加密和压缩算法视情况而异）。事实上，一个可执行代码嵌入另一个，如此重复若干次，
形成了压缩或加密的二进制块。下面我们来看看Duqu 2.0 MSI安装包及其所有内部有效载荷。<br style="text-align: left;"/></span></p><p style="text-align:center"><img _load="1" id="aimg_460686" src="http://bbs.antiy.cn/data/attachment/forum/201506/16/112643mhh5oo658wau838z.png" width="800"/></p><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">&nbsp; &nbsp; 下面，我们更详细地介绍这些组件。<br style="text-align: left;"/><strong>第一层：ActionDLL（msi.dll）</strong><br style="text-align: left;"/>
 <br style="text-align: left;"/>该DLL只有一个称为StartAction的输出函数，这是在msiexec.exe进程的情况下的名称。当这个函数被调用时，它检索称为PROP的MSI属性，并将其作为绑定的ActionData0安装包的解密密钥。<br style="text-align: left;"/>接下来，代码遍历需要解密和启动的12个可能的有效载荷。有效载荷是MSI的一部分，可能有以下名称：ActionData0，ActionData1，ActionData2等。<br style="text-align: left;"/>我们所说的安装包只包含一个名为“ActionData0”的有效载荷。<br style="text-align: left;"/></span></p><p style="text-align:center"><img _load="1" id="aimg_460687" src="http://bbs.antiy.cn/data/attachment/forum/201506/16/113143gb44dcic1bbmbbci.png" width="531"/></p><p style="text-align: left;"><br style="text-align: left;"/><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;"><strong>第二层：ActionData0</strong><br style="text-align: left;"/>这个二进制块包含主要代码，是压缩和加密的格式。它由可执行的、与位置无关的代码块和嵌入的数据对象混合组成。代码似乎基于一个框架，并大量使用包含指针
的帮助结构，这些指针指向系统API（应用程序编程接口）和内部数据块的偏移。这样的结构肯定是开发者的标记。当它们被初始化时，一个包含魔数的字段（通
常是前4个字节）识别该结构的状态和类型。<br style="text-align: left;"/>开发者的另一个标记是导入系统API的方式：即按照模块和输出名哈希值导入系统API。在该层和可执行代码的其他各层中都发现了该哈希算法。可以通过两个DWORD常数轻松识别：0x8A20C27和0x67F84FC6。<br style="text-align: left;"/>基本上，ActionData0中的代码将执行传递给嵌入式可执行文件，该文件的内部名称为“klif.dll”。执行被传递给此DLL文件的输出表中的
第二个输出函数。这与输出名称无关，只取决于输出表中的函数顺序。当此输出函数被调用时，下一阶段的帮助结构指针就会传递给它，以便它可以使用上一层设置
的一些值。 <br style="text-align: left;"/></span></p><p style="text-align:center"><img _load="1" id="aimg_460688" src="http://bbs.antiy.cn/data/attachment/forum/201506/16/113146r6c82eiicvh8i80d.png" width="452"/></p><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">然而，在将执行传递给klif.dll之前，代码尝试其他路线。首先，它试图找到“api-ms-win-shell-XXXX.dll”格式的名称，其
中“X”可以是任何十进制数。如果当前进程中不存在具有该文件名的模块，则该名称就是有效的。该代码迭代性地搜索这样的名称，包括api-ms-win-
shell-0000.dll，api-ms-win-shell-0001.dll和api-ms-winshell-0002.dll等。这可能是
Duqu平台组件的依赖性，不过尚未确认。<br style="text-align: left;"/>紧接着，如果发现该名词，代码试图通过名称映射一个用基于PRNG算法生成的段内核对象。该段的名称具有以下格式“\BaseNamedObjects
\{XXXXXXXX-XXXX-XXXX-XXXXXXXXXXXX}”，其中“X”是根据当前系统启动时间生成的任何十六进制数。到目前为止，段的名
称取决于“机器/启动时间”，这使得它独一无二。但是，如果其他进程使用同样的名称生成算法，它们也可能找到这样的段。该段可以在其他不同的代码和模块部
分进行访问。以下，我们将该段称为OSBoot。一旦段名生成，代码就试图打开这样的段；如果找到这样的段，代码就使用它的一些值，试图打开一个特定设备
并向驱动设备提供大量的IOCTL代码。驱动设备的名称和IOCTL代码位于内核模式驱动器KMART.dll的一个段中，我们将在下面介绍。<br style="text-align: left;"/>代码开发者偏好使用段来访问数据。段的另一个用途似乎是映射代码/数据（klif.dll被嵌入）的一部分，然后找到使用硬编码QWORD魔数
0xA1B5F8FC0C2E1064的段。一旦在当前进程的地址空间中找到该段，代码试图将执行传递给它。这种替代执行路线并不适用于当前的MSI文件
包，只是存在于代码中，这可能是由创建目前MSI软件包常见的代码模板导致的。这也可能是另一个我们未发现的Duqu平台组件的信标。<br style="text-align: left;"/><strong>第三层：klif.dll</strong><br style="text-align: left;"/></span></p><p style="text-align:center"><img _load="1" id="aimg_460690" src="http://bbs.antiy.cn/data/attachment/forum/201506/16/113306jef3gejtnj39vvjr.png" width="656"/></p><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">&nbsp; &nbsp; <br style="text-align: left;"/>显然，这个文件试图模仿一些卡巴斯基实验室的产品组件“klif.sys”的合法名称。虽然代码或文件信息都没有相似性，但是该模块在输出名称KLInit和KLDone中使用卡巴斯基实验室的首字母缩写。<br style="text-align: left;"/> <br style="text-align: left;"/>当该DLL被加载到一个新的进程时，它简单地初始化内部结构，如那些向系统API提供所需指针的内部结构。该模块的实际有效载荷位于KLDone输出函数中，即输出表中的第二项。该输出函数从之前的代码层调用。<br style="text-align: left;"/>首先，它确保全局应用程序结构通过重要函数初始化，包括ntdll.dll，kernel32.dll和user32.dll。系统API函数使用输出名称的哈希值导入。散列算法与上层所介绍的相同，而且使用相同的魔数常量：0x8A20C27和0x67F84FC6。<br style="text-align: left;"/>接下来，代码通过正在运行的进程列表进行迭代，并对每个进程的小写名称计算哈希值。该哈希值与0x3E3021CB的硬编码值（即“avp.exe”字符串的哈希值）进行比较。<br style="text-align: left;"/>攻击AVP.EXE<br style="text-align: left;"/>如果“avp.exe”进程正在运行，该模块试图打开OSBoot段并试图攻击avp.exe进程。攻击者首先迭代下列产品硬编码的注册表项和值的数列，从而确定安装的卡巴斯基实验室产品的准确路径。<br style="text-align: left;"/></span></p><p style="text-align:center"><img _load="1" id="aimg_460689" src="http://bbs.antiy.cn/data/attachment/forum/201506/16/113146nvuizbavueubiawj.png" width="800"/></p><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">该模块查询的注册表值包含到根目录的文件系统路径，相应的产品通过该路径安装。例如：“C:\Program Files\KasperskyLab\Kaspersky Internet Security 15.0.0\”。<br style="text-align: left;"/>一旦注册表项和值被发现，该模块确认avp.exe文件位于该目录中。它也执行一些基本的文件可用性检查：确保解析环境变量并在读取时打开文件，检查从0x5A4D（Windows可执行文件的魔数“MZ”）开始。<br style="text-align: left;"/>在此之后，该模块创建一个新的段，将avp.exe映射到该段中。为了允许执行代码，这个内存区域的属性也相应改变。这允许该模块在内存中改变被映射的
avp.exe的字节。该模块以相当不寻常的方式对被映射的avp.exe使用两个补丁，这两个补丁具有SSE2 
CPU扩展名。事实上，它只修复旧的DOS PE标头（小于120字节）。这些补丁是简单的回调机制，能够调用作为参数传递的任意函数。<br style="text-align: left;"/>紧接着，该模块试图启动一个新的线程，该线程以修复的位置之一开头。到目前为止，新线程貌似以从avp.exe模块的调用开头，该模块还执行一些其他的调
用，即跳转回klif.dll。显然，该攻击旨在欺骗avp.exe进程，使其相信进一步的调用是安全的，调用堆栈来自合法的avp.exe模块。之后，
新线程立即从avp.exe跳转回klif.dll，并尝试与卡巴斯基实验室的产品minifilter driver（即klif.sys）通信。<br style="text-align: left;"/>事实上，在与klif.sys通信前，它会打开OSBoot段，并得到IOCTL代码以及该代码被发送到的驱动设备的名称。该段和相应的驱动程序
（KMART.dll）给当前模块提供一定的支持。该代码对当前进程名计算哈希值并验证它是否与以下3个哈希值匹
配：0x3E3021CB（avp.exe），0xDE6D4DA0（msiexec.exe），0xB915B2D8（RUNDLL32.EXE）。<br style="text-align: left;"/>如果当前进程名的哈希值能够被识别，则该模块打开\KlifComm 
minifilter通信端口并发送一系列驱动通信消息，从而与klif.sys通信。通过分析这些消息，我们发现该技术使得进程或线程操作对klif拦
截程序“不可见”。这种注册的实体被认为是值得信任的，其行为不需要反病毒扫描、进程监控、防火墙等防御措施。此外，该模块请求支持卡巴斯基产品的自防御
功能，这通常是用于防御侵略性的恶意软件，这些恶意软件能够利用操作系统的各种可能技术终止安全软件进程。当然，这保证了即使是具有管理权限的用户也无法
终止这样的进程。<br style="text-align: left;"/>鉴于这一攻击看似是针对卡巴斯基实验室产品的，我们对产品进行了附加测试，并发现当前的产品都会通过核查定制数字签名来验证调用进程。截至目前，若没有附
加的驱动器支持，这一技术是无法实施的。所有2010年之后的卡巴斯基实验室产品都会对开启\KlifComm minifilter 
通讯端口的数字签名进程进行验证。截至目前，它只能影响卡巴斯基实验室在2009年发布的以前的产品，例如KIS2010。<br style="text-align: left;"/>攻击者从2009年或更早就开始针对卡巴斯基实验室产品进行戏弄攻击，这看起来并不现实。所以我们搜寻着另外合理的解释，并且好像找到了。<br style="text-align: left;"/>通常这种攻击对我们的产品是无效的，因为我们的产品会通过核查定制数字签名来验证调用进程的合法性。为了避开上述检测，名为“KMART.dl”的
Duqu 
2.0组件在内存中对“klif.sys”进行补丁。攻击之所以有效，是因为攻击者的“KMART.dll”已经在内核模式中开始运行（由于
Windows内核漏洞导致）。<br style="text-align: left;"/>发送代码之后，模块移到下一个阶段，即向后文将描述的进程迁移。<br style="text-align: left;"/> </span></p><p style="text-align:center"><img _load="1" id="aimg_460691" src="http://bbs.antiy.cn/data/attachment/forum/201506/16/113443nz85gffgf4d1iaf1.png" width="450"/></p><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;"><strong>CTwoPENC.dll零日漏洞和KMART.dll</strong><br style="text-align: left;"/>第三层klif.dll发挥着多重功能，以便确保恶意代码在内存中的存货并避开反病毒检测。<br style="text-align: left;"/>其中重要的一步就是获取内核级别访问。在64位系统中，如果没有签名的驱动器，我们就会难以加载并运行内核模式代码。尽管其他攻击者选择在第三方签名驱动器上进行搭载，例如Equation或Turla，但是Duqu 2.0平台依赖于更加狡猾的把戏。<br style="text-align: left;"/>与“klif.dll”捆绑在一起的一个有效载荷是“CTwoPENC.dll”。它是一种Windows内核模式漏洞（CVE-2015-2360），
能使自身在系统中获取最高权限以运行代码。我们恢复了带有以下汇编时间戳的“CTwoPENC.dll”的多个版本，都是32位和64位的Windows
版本：<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;2014.08.25 01:20:04 (GMT)<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;2014.08.25 01:19:03 (GMT)<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;2014.07.06 09:17:03 (GMT)<br style="text-align: left;"/>与其他的Duqu 2.0不同，这些时间戳看似是合法的。这一现象的原因还不可知——有可能Duqu平台的开发者是从别处获取的这个模块，并且忘了修补它的汇编时间戳。<br style="text-align: left;"/>“CTwoPENC.DLL”在“win32k.sys”中利用零日漏洞来获取内核特权，与此同时，充当非特权用户正常运行着。它创建了多个带有“CPer”、“Zero”、“CTwo”名称类别的窗口，并且控制着回调指针。<br style="text-align: left;"/></span></p><p style="text-align:center"><img _load="1" id="aimg_460692" src="http://bbs.antiy.cn/data/attachment/forum/201506/16/113518wlr44id277frfrrk.png" width="800"/></p><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">注册窗口类别并创建新窗口的漏洞代码的一部分<br style="text-align: left;"/>这一漏洞的主要目的是加载一个名为“KMART.dll”的驱动器。如果漏洞成功，它将在内核模式中运行的同时，从模块主题中解压缩
“KMART.dll”并对此加以控制。“KMART.dll”拥有32位和64位两种版本。这一驱动器针对卡巴斯基实验室的产品“klif.sys”实
行内核模式攻击。它能修补系统API函数的导入表格地址——PsGetCurrentProcessId和
PsLookupProcessByProcessId——以及卡巴斯基实验室的反病毒驱动器klflt.sys的导出地址
KlGetStringRef。恶意代码先于拦截的函数模仿其他来自进程/文件“avp.exe”的恶意模块（利用反病毒组件的真实位置），因此避免被反
病毒软件监控。<br style="text-align: left;"/>在测试过程中，零日漏洞在所有当前的Windows版本中都可运行。这一漏洞已经被微软于2015年6月9日进行了补丁。<br style="text-align: left;"/><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 32px;">有效载荷容器和迁移</span><br style="text-align: left;"/>模块支持一系列不同的有效载荷，这些有效载荷在内存中以箱的形式被提供于klif.dll之后。<br style="text-align: left;"/>有效载荷箱包括一条简短文头，描述了目标CPU架构、有效载荷类型和目标进程名称或HASH。当该模块利用一些嵌入代码或文件时，代码捆绑中通常会有至少
两种变种：32位和64位。每种有效载荷运行类型都被单一的字符识别。当前的模块支持以下5种有效载荷运行类型：g、i、k、l和q。看来开发者利用了排
序的字母字符，也就是说有可能还有其他有效载荷运行类型在运行过程中被移除了。当前位于可执行对象叠加中的箱包含了一个“l”字符，所以我们先来讨论它：<br style="text-align: left;"/><strong>有效载荷类型“L”</strong><br style="text-align: left;"/>首先，代码从其他进程中寻找特权。进程句柄能被硬编码或通过寻找当前运行进程获取，将它们的名字哈希并同已知的哈希值进行对比。该模块包括以下硬编码进程哈希值：<br style="text-align: left;"/>0x31283314 (services.exe)，0x1026D1BA (lsass.exe)，0x3BD2498C (svchost.exe)<br style="text-align: left;"/>如果找到任何已识别的进程，该模块就会开启进程口令并验证以下特权的可用性：<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;SeDebugPrivilege<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;SeTcbPrivilege<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;SeAssignPrimaryTokenPrivilege<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;SeIncreaseQuotaPrivilege<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;SeImpersonatePrivilege<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;SeRestorePrivilege<br style="text-align: left;"/>如果特权可用，该模块就会复制进程口令并保存在内部结构中以备后续使用。<br style="text-align: left;"/> <br style="text-align: left;"/>该模块会寻找一个当前系统安装的可用安全套装，如果什么也找不到，就会寻找一些类型进程。它试图寻找以下软件的可执行文件：<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;20多种卡巴斯基实验室的产品<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;McAfee VSCore、SystemCore、HIP<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;Symantec Internet Security<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;Bitdefender<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;ESET<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;H+BEDV<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;TrendMicro Network Security Component<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;Rising AV<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;Avast<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;AVG 2012/2013/2014/2015<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;F-Secure<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;奇虎360<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;Windows类进程：<br style="text-align: left;"/>o&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;%programfiles(x86)%\windows Defender\msmpEng.exe<br style="text-align: left;"/>o&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;%systemroot%\syswow64\svchost.exe<br style="text-align: left;"/>o&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;%systemroot%\system32\lsass.exe<br style="text-align: left;"/>o&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;%systemroot%\system32\svchost.exe<br style="text-align: left;"/>当这一可执行文件被找到时，它将从被发现的位置运行一个新的进程并用自身的可嵌入当前可执行加密压缩格式的文件替换其可执行代码。<br style="text-align: left;"/>如果代码能够从带有特定安全特权的进程中找到安全口令，它将在利用CreateProcessAsUser API创建新的进程的过程中利用这一口令。否则，它只是批量生成新的进程实例。<br style="text-align: left;"/>新的进程暂停或调试状态被开启。就在新的进程开启之前，它将为子进程开启DEP以便简化代码注入和数据控制。至此，从外表看来，它像是被开启的安全软件；然而其内在已经和合法模块完全不同了。<br style="text-align: left;"/><strong>有效载荷运行类型“G”&nbsp; &nbsp;&nbsp;&nbsp;</strong>&nbsp; &nbsp;<br style="text-align: left;"/>这一有效载荷几乎和上述的L类型相同，但是它的加载器更加简单——它能越过特权口令的拦截。代码注入目标是根据已知进程的可用性而选择的。<br style="text-align: left;"/><strong>有效载荷运行类型“I”</strong><br style="text-align: left;"/>这一有效载荷同G类型类似，但是它的加载器解析有效载荷头有所不同：它只用了4个字符替代进程命名字符串，还被用来当做进程哈希。这看似是一种隐藏目标进程名称并只利用哈希的方法，但是在我们分析的模块中它并没有得到完成地执行。<br style="text-align: left;"/><strong>有效载荷运行类型“K”</strong><br style="text-align: left;"/>这一有效载荷是转为当前进程环境下的运行而设计的。代码只是复制待执行至独立内存中的代码，并在专门的线程中加以运行。它不断地进行拦截，直至线程完成执行。<br style="text-align: left;"/><strong>有效载荷运行类型“Q”</strong><br style="text-align: left;"/>这一有效载荷同上述的K类型相同，但是在新的线程启动时，它不拦截执行。目前，新的代码进行着异步运行。<br style="text-align: left;"/>在有效载荷容器开启并且代码迁移至另一个进程后，真正的恶意代码就被激活了。在多数情况下，它是基于后门的简单命名管道，听取进程通讯。在少数案例中，在选定机器中，它是同命令与控制服务器进行通讯的重模块，充当着双导向代理，并且同一大批二级插件一起进入。<br style="text-align: left;"/><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 32px;">平台可插件模块</span><br style="text-align: left;"/>除了基础的远程后门外，攻击者将更为复杂的包配置给郁闷控制器以及LAN内部的受害者。这些MSI包能够包含上百种不同的针对多样的网络监听函数的模块。<br style="text-align: left;"/>全功能安装包比基础远程后门要大很多——18MB：500KB。他们遵循相同的结构，利用ActionDll以及加载器机制，不同之处在于它们包含更多的加载和运行插件。<br style="text-align: left;"/>在分析过程中，我们识别了该插件的100多个变种。下面是对这些插件的描述。为了区分它们，根据它们MD5总和的前两个字符，我们利用了一张虚拟识别器。<br style="text-align: left;"/><strong>03B7：Duqu 2.0的主要模块, 调配器</strong><br style="text-align: left;"/>为C&amp;C通讯执行多重协议处理，能够启动带有自我签名HTTPS证书的立即C&amp;C代理服务器。开启插件框架，加载并管理所有额外的插件。<br style="text-align: left;"/>它通过HTTP、HTTPS和SMB网络管道或利用定制加密协议的直接TCP连接进行运转。与HTTP的互动被隐藏在JPEG或GIF文件中，这与2011年版本的Duqu相同。不同的攻击中的请求名称、URL以及用户代理字符串可能会有所不同。<br style="text-align: left;"/>其他已知变种：3026、4F11。<br style="text-align: left;"/><strong>0682：收集基本系统信息</strong><br style="text-align: left;"/><br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;运行进程列表<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;激活桌面并终止会话<br style="text-align: left;"/>收集的信息之后被传输到一个由调用者提供的命名管道。<br style="text-align: left;"/>其他已知变种：C0B7。<br style="text-align: left;"/>073C：客户端和服务器都执行完整的Windows基于插口的运输。为封装不同网络函数的类别提供一个类别库。<br style="text-align: left;"/>0872：当Windows安装器启动恶意安装包时，MSI定制行为库就被激活了。加载加密的包括真正有效载荷的二进制对象 ，解密并在内存中执行。<br style="text-align: left;"/>版本信息名称不同：svcmsi_32.dll、msi3_32.dll、MSI.dll、msi4_32.dll。<br style="text-align: left;"/>加密算法也不相同： Camellia 256、AES、XXTEA。<br style="text-align: left;"/>解密密钥是从MSI参数中提取的，可能的名称是：PROP、HASHVA、CKEY。<br style="text-align: left;"/>通过以下前缀搜索加密的二进制对象：ActionData、CryptHashs、CAData。<br style="text-align: left;"/>32位和64位版本都是已知的。其他已知变种：8D7C、16EF、E6E5、434C、44BD、F708。<br style="text-align: left;"/>09A0：64位，过滤文件内容，特别搜索匹配以下规则的文件：<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;*.inuse, *.hml<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;文件名包括“data.hmi”或“val.dat”<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;来自/Int/HMI/ or /LG/HM/文件夹的问价<br style="text-align: left;"/></span></p><p style="text-align:center"><img style="height: 1px; width: 1px;" id="aimg_460693" src="http://bbs.antiy.cn/data/attachment/forum/201506/16/113806zewz6edpryv6d5qm.png" width="795"/></p><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">09A0插件的文件和目录名称<br style="text-align: left;"/>其他已知变种：8858。<br style="text-align: left;"/>0AB8：为控制文件和目录提供25个函数：<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;列出目录中的文件<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;上传并下载随机文件<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;读取/写入文件内容<br style="text-align: left;"/>在一些案例中，该模块会特别搜寻名为“\int”、“\lg”、“\ of\md”、“\tl”、“\ak”的目录以及带有“.part”、“.manual”、“.inuse”扩展的文件。<br style="text-align: left;"/></span></p><p style="text-align:center"><img _load="1" id="aimg_460694" src="http://bbs.antiy.cn/data/attachment/forum/201506/16/113836q47z1mz6o4cso8cu.png" width="699"/></p><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">0AB8 插件的文件和目录名称<br style="text-align: left;"/>其他已知变种：A69E<br style="text-align: left;"/>0B97：网络传输。为连接插口和调用者提供的管道执行API。<br style="text-align: left;"/>附加的变种：56A2<br style="text-align: left;"/>152B：网络和域名发现<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;在域名中枚举所有的服务器<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;尝试连接远程注册表并在“HKEY_USERS”中枚举所有的用户。用户名则被转换为SID。<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;枚举所有的可视网络共享<br style="text-align: left;"/>其他已知变种：A987。<br style="text-align: left;"/>1C71：内存存储。接收并在文件映射中存储字符串数据。<br style="text-align: left;"/>2125：网络感染模块。尝试从运行程序中获取管理凭证，然后利用Windows共享连接目标机器。机器已被恶意DLL后门感染，目标目录有所不同，并且
可能存在于UPDROOT$、ADMIN$或C$。利用定制SMB包来识别目标操作系统版本。然后利用新创建的名为“svcmsi_32@”的服务开启目
标恶意DLL。该模块通过Windows管道与目标后门进行通讯。<br style="text-align: left;"/>附加的变种：DB65。不同于恶意DLL，它上传一个新的MSI包并依赖MSIEXEC.EXE来开启MSI，通过新创建的服务“msisvc_32@” 。目标MSI名称是利用模版“tmp%x.&nbsp;&nbsp;tmp”随机生成的。<br style="text-align: left;"/></span></p><p style="text-align:center"><img _load="1" id="aimg_460695" src="http://bbs.antiy.cn/data/attachment/forum/201506/16/113837flfrtrmrtum0strp.png" width="720"/></p><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">感染瞬间创建的Windows登陆入口事件的例子<br style="text-align: left;"/>管理凭证是通过从运行进程中窃取口令而获取的，运行进程是通过具有管理员权限的用户登录开启的。为此，首先，它要在域名控制器的域名中查询前100个管理员用户名。<br style="text-align: left;"/></span></p><p style="text-align:center"><img _load="1" id="aimg_460696" src="http://bbs.antiy.cn/data/attachment/forum/201506/16/113842rb9ic3erzzsintz4.png" width="800"/></p><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">网络感染模块使用的远程地址<br style="text-align: left;"/>24B7：远程桌面管理。获取说面截图，还能发送输入至桌面、移动鼠标光标。拥有32位和64位两个版本。<br style="text-align: left;"/>其他已知变种：65BE、7795、BDC8、DEE2。<br style="text-align: left;"/>26D6：检测与西宁的网络嗅探器（wireshark、tcpview、netstat、dumpcap、perfmon）；执行TCP服务器并通过网络管道通信。内部名称：“P.dll”。<br style="text-align: left;"/>2829：收集系统信息<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;监控USB设备附件<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;收集USB驱动历史<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;枚举网络共享、windows标题、系统路由表格<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;读取/写入加密文件<br style="text-align: left;"/>2913：WMI数据收集<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;枚举带有SID的主页<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;对于每一个主页，从主页目录Ink文件中提取信息<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;通过WMI（CIMV2）枚举进程，包括终止的进程<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;从可用的远程注册表中提取用户信息<br style="text-align: left;"/>其他已知变种：C776<br style="text-align: left;"/>29D4： 服务msisvc_32@；模块2125用于网络感染的DLL后门。通过命名管道“Global\{B54E3268-DE1E-4c1e-A667- 2596751403AD}”接受命令。32位和64位版本均存在。<br style="text-align: left;"/><br style="text-align: left;"/>其他已知变种：6F92、A505、D242。<br style="text-align: left;"/>2B46：对系统和用户信息的扩展收集<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;域名控制器的名称<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;域名中用户的列表<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;域名的管理员<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;枚举可信任域<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;TCP表格<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;UDP表格<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;SNMP发现（操作系统，解析所有回复）<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;USB驱动历史，安装完的设备<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;安装的程序<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;时间区域<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;操作系统安装日期<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;ODBC.ini、SQL Server实例信息、Oracle ALL_HOMES、SyBase、DB2、MS SQL、MySQL最后连接<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;DHCP/路由<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;网络资料<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;零配置参数<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;连接的打印机<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;WinRAR、WinZip、Office的MRU列表，IE 类型的URL，映射的网络驱动，Visual Studio MRU<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;终端服务用户默认用户名提示<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;用户辅助历史<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;PuTTY主机密钥和会话 <br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;登录用户<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;网络适配器配置<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;VNC用户密码<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;扫描网络并利用SMB包识别操作系统<br style="text-align: left;"/><br style="text-align: left;"/></span></p><p style="text-align:center"><img _load="1" id="aimg_460699" src="http://bbs.antiy.cn/data/attachment/forum/201506/16/114109ifr279d0h8ufhnzd.png" width="800"/></p><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">该模块获取的一些注册地址<br style="text-align: left;"/>其他已知变种：A7F8<br style="text-align: left;"/>2BF7：功用DLL。为创建新的MSI包提供基础API，加载并注入随机PE模块。也负责加载恶意MSI文件内部的VFS的第一级别。拥有32位和64位两个版本。<br style="text-align: left;"/>已知的名称：“ntdll.dll”、“klif.dll”、“apiset.dll”<br style="text-align: left;"/>其他已知变种：6DA1、32DB、8304、9931、9E60、A2D4、ABA9、B3BB、DC5F、DD32、F7BB。<br style="text-align: left;"/>3395：MS SQL发现模块。模块能够将ARP包发送至网络并发现MS SQL服务器端口。附加功能是负责连接并读取远程注册内容。<br style="text-align: left;"/>35E9：文件系统发现。<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;枚举网络共享<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;枚举本地磁盘<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;遍历文件系统登记并枚举文件；识别重解析点<br style="text-align: left;"/>3F45： 管道后门。开启一个新的全程可视的Windows管道，接收并执行加密指令。识别加密协议的“magic”字符串是“tttttttt”。<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;Enumerates running processes枚举运行的进程<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;加载并执行随机PE文件<br style="text-align: left;"/>32位和64位两个版本都存在。<br style="text-align: left;"/>已知的管道名称：<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;\\.\pipe\{AAFFC4F0-E04B-4C7C-B40A-B45DE971E81E}\\.\pipe\{AB6172ED-8105-4996-9D2A-597B5F827501}<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;\\.\pipe\{0710880F-3A55-4A2D-AA67-1123384FD859}\\.\pipe\{6C51A4DB-E3DE-4FEB-86A4-32F7F8E73B99}<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;\\.\pipe\{7F9BCFC0-B36B-45EC-B377-D88597BE5D78},\\.\pipe\{57D2DE92-CE17-4A57-BFD7-CD3C6E965C6A}<br style="text-align: left;"/>其他已知变种：6364, 3F8B, 5926, A90A, DDF0, A717, A36F, 8816, E85E, E927。<br style="text-align: left;"/><br style="text-align: left;"/> <br style="text-align: left;"/>4160：密码窃取器<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;提取谷歌和火狐浏览器的登陆数据<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;LSA凭证<br style="text-align: left;"/></span></p><p style="text-align:center"><img _load="1" id="aimg_460700" src="http://bbs.antiy.cn/data/attachment/forum/201506/16/114110pmrjnuuthfympel5.png" width="800"/></p><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">定位谷歌保存的登陆信息所使用的数据<br style="text-align: left;"/>其他已知变种：B656。<br style="text-align: left;"/>41E2：密码窃取器，64位模块，提取：<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;IE IntelliForms历史<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;POP3/HTTP/IMAP密码<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;TightVNC、RealVNC、WinVNC3/4密码<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;Outlook设置<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;SAM、LSASS缓冲贮存区<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;Windows Live、.Net 护照密码<br style="text-align: left;"/></span></p><p style="text-align:center"><img _load="1" id="aimg_460697" src="http://bbs.antiy.cn/data/attachment/forum/201506/16/113933cdvbdlza8dbndnn5.png" width="725"/></p><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">该模块收集的信息参考<br style="text-align: left;"/>其他已知变种：992E, AF68, D49F。<br style="text-align: left;"/>482F：收集系统信息<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;枚举磁盘驱动<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;获取运行进程的列表<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;包括正常运行时间的扩展进程信息<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;内存信息<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;SID信息<br style="text-align: left;"/>其他已知变种：F3F4。<br style="text-align: left;"/>559B：活动目录的调查<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;利用ADSI连接Active Directory Global Catalog<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;枚举AD中的所有对象<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;以可读形式呈现每一个入口<br style="text-align: left;"/></span></p><p style="text-align:center"><img _load="1" id="aimg_460698" src="http://bbs.antiy.cn/data/attachment/forum/201506/16/113936ff80cj8wedzdf857.png" width="673"/></p><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">活动目录的枚举例程<br style="text-align: left;"/>580C：收集系统和网络信息<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;检索域名控制名称<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;枚举域名中的所有用户和集团<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;收集任务计划日志<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;收集磁盘信息、可移动驱动历史<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;检索防火墙政策<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;枚举所有命名的系统对象<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;枚举所有的系统服务<br style="text-align: left;"/> <br style="text-align: left;"/>5B78：收集系统信息和功能。两个导出函数的其中一个名字是“GetReport”。<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;枚举运行进程，提取口令和SID，收集限时信息<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;利用泄露凭证登陆用户帐号<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;模拟用户的运行进程<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;利用硬编码模版建立新的32位和64位壳代码<br style="text-align: left;"/>32位和64位版本都存在。<br style="text-align: left;"/>其他已知变种：E8C7、EE6E。<br style="text-align: left;"/>5C66：加密的文件 I/O，实用程序。<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;文件I/O运行：开启/寻找/读取/写入<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;管理压缩和加密的临时文件<br style="text-align: left;"/> <br style="text-align: left;"/>622B：利用独特模式生成关于系统的XML报告<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;计算机名称<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;目录<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;枚举所有的逻辑驱动<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;列举所有文件<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;序列号<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;域名<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;网络适配器配置：IP地址、MAC、MTU、适配器列表<br style="text-align: left;"/></span></p><p style="text-align:center"><img _load="1" id="aimg_460701" src="http://bbs.antiy.cn/data/attachment/forum/201506/16/114221skkiz6elg4474kiw.png" width="800"/></p><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">生成系统报告的XML标签<br style="text-align: left;"/>6302：实用程序，具有内部名称“d3dx9_27.dll”。执行基于计时器的活动。<br style="text-align: left;"/>其他已知变种：FA84。<br style="text-align: left;"/>669D：实用程序，鉴于文件名和目录的列表，核对是否存在。<br style="text-align: left;"/>其他已知变种：880B。<br style="text-align: left;"/> <br style="text-align: left;"/>6914：基于嗅探器的网络攻击。利用合法的 WinPcap驱动器“npf.sys”。检测NBNS （NetBIOS协议）互联网请求并发送响应。<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;响应WPAD请求（NBNS 包里的“FHFAEBE”）<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;发送对HTTP GET 请求的响应<br style="text-align: left;"/>网络过滤器是基于BPF库的。HTTP和WPAD响应的有效载荷是由外部提供的。<br style="text-align: left;"/>
 <br style="text-align: left;"/></span></p><p style="text-align:center"><img _load="1" id="aimg_460702" src="http://bbs.antiy.cn/data/attachment/forum/201506/16/114225fz7rk38btbot7hrd.png" width="758"/></p><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">虚假的HTTP 响应和相关的状态信息<br style="text-align: left;"/>6FAC：文件API<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;获取文件大小、属性<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;安全删除文件<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;开启/关闭/读取/写入文件内容额外的其他已知变种：A7EE<br style="text-align: left;"/>7BDA：收集系统信息 <br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;利用wscapi.dll API查看当前的AV状态和防火墙防护<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;Detect if “sqlservr.exe” is running检测 “sqlservr.exe” 是否正在运行<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;计算机名称<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;工作组信息<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;Domain controller name域名控制器名称<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;网络适配器配置<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;时间和时间区域信息<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;CPU频率<br style="text-align: left;"/>其他已知变种：EF2E。<br style="text-align: left;"/>7C23：从文档中提取元数据并收集系统信息<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;计算机名称<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;系统卷标序列号<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;6FAC中完整的文件API<br style="text-align: left;"/>从中搜索文档和文件夹，并执行例程来提取所有有价值的信息：<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;电子邮件信息：eml、msg<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;图片文件：jpg、jpe、jpeg、tif、tiff、bmp、png<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;多媒体文件： 
wmv、avi、mpeg、mpg、m4a、mp4、mkv、wav、aac、ac3、dv、flac、flv、h264、mov、3gp、3g2、
mj2、mp3、mpegts、ogg、asf。 都是利用libffmpeg 进行了再编码。<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;PDF文档中的内容<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;Microsoft 
Office：doc、docx、xlsx、pptx。专门的例程分别被称为：“OfficeRipDoc”、“OfficeRipDocx”、
“OfficeRipXlsx”、“OfficeRipPptx”。 PPT幻灯片被提取并转换成HTML展示摘要。 <br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;文件夹：gz、gzip、gzX3、zip、rar<br style="text-align: left;"/>创建临时扩展文件：“.fg4”。<br style="text-align: left;"/>其他已知变种：EB18、C091。<br style="text-align: left;"/></span></p><p style="text-align:center"><img _load="1" id="aimg_460703" src="http://bbs.antiy.cn/data/attachment/forum/201506/16/114230u44io4jh40r80zii.png" width="612"/></p><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">部分文件扩展列表以及相应的状态信息<br style="text-align: left;"/><br style="text-align: left;"/>8172：基于嗅探器的网络攻击。 执行NBNS 名字解析以骗取：<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;WPAD请求<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;以“SHR”开头的名字<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;以“3142”开头的名字（只限登陆）<br style="text-align: left;"/></span></p><p style="text-align:center"><img _load="1" id="aimg_460704" src="http://bbs.antiy.cn/data/attachment/forum/201506/16/114317yev9chh4zy9c72o7.png" width="684"/></p><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">与攻击相关的状态信息<br style="text-align: left;"/>附加功能：该模块能从硬编码模版中建立新的壳代码。<br style="text-align: left;"/>81B7： 驱动器管理Driver management<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;将驱动器写入磁盘<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;开启/停止驱动器<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;从磁盘中安全移除驱动器的文件<br style="text-align: left;"/>其他已知变种：C1B9。 <br style="text-align: left;"/>8446：Oracle数据库和ADOdb客户端<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;利用“oci.dll” API获取Oracle数据库<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;从数据库中提取所有可用信息<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;同时连接ADOdb提供者<br style="text-align: left;"/></span></p><p style="text-align:center"><img _load="1" id="aimg_460705" src="http://bbs.antiy.cn/data/attachment/forum/201506/16/114340revenvq6keeoezie.png" width="800"/></p><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">SQL查询和相关数据<br style="text-align: left;"/>8912：加密文件控制并收集系统信息<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;共享文件映射通讯<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;将加密数据写入文件中<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;枚举windows<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;枚举网络共享和本地磁盘<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;检索USB设备历史<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;收集网络路由表格<br style="text-align: left;"/>已知的互斥和映射名称：<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;Global\{DD0FF599-FA1B-4DED-AC70-C0451F4B98F0} Global\{B12F87CA-1EBA-4365-B90C-E2A1D8911CA9},<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;Global\{B03A79AD-BA3A-4BF1-9A59-A9A1C57A3034} Global\{6D2104E6-7310- 4A65-9EDD-F06E91747790},<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;Global\{DD0FF599-FA1B-4DED-AC70-C0451F4B98F0} Global\{B12F87CA-1EBA- 4365-B90C-E2A1D8911CA9}<br style="text-align: left;"/> <br style="text-align: left;"/>其他已知变种：D19F, D2EE。<br style="text-align: left;"/>9224：运行控制台应用程序。利用桌面“默认”创建进程，附加到它的控制台并将I/O重定向至命名管道。 <br style="text-align: left;"/>92DB：修订cmd.exe shell。<br style="text-align: left;"/></span></p><p style="text-align:center"><img _load="1" id="aimg_460706" src="http://bbs.antiy.cn/data/attachment/forum/201506/16/114405k85y5zd5j0i6fffc.png" width="751"/></p><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">壳处理的一些CMD 命令<br style="text-align: left;"/>9F0D (64位)，D1A3(32位)：与插件一起被分配至VFS中的合法签名驱动器NPF.SYS （WinPcap）。它被用于以嗅探器为基础的网络攻击中。<br style="text-align: left;"/>A4B0： 网络调查<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;使用DHCP服务器管理API（DHCPSAPI.DLL）以枚举所有的DHCP服务器的客户端<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;查询所有已知的DHCP子网络<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;所搜包含端口UDP1434或137开启的机器<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;枚举所有网络服务器<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;枚举网络共享<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;尝试连接远程注册表以枚举HKEY_USERS的所有用户，将他们转换成SID<br style="text-align: left;"/>B6C1：WNet API<br style="text-align: left;"/>为 WnetAddConnection2和WNetOpenEnum 函数提供封装器。<br style="text-align: left;"/>其他已知变种：BC4A。<br style="text-align: left;"/>C25B：基于网络攻击的嗅探器<br style="text-align: left;"/>执行一个伪造的SMB服务器来欺骗其他机器以使用NTLM进行身份验证。<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;执行基础SMB v1命令<br style="text-align: left;"/></span></p><p style="text-align:center"><img _load="1" id="aimg_460707" src="http://bbs.antiy.cn/data/attachment/forum/201506/16/114424df4r9ls4ns8u070v.png" width="633"/></p><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">该模块处理的SMB命令<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;假装拥有IPC$ 和A：共享 <br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;接受用户身份认证请求<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;还处理HTTP “GET /”请求<br style="text-align: left;"/></span></p><p style="text-align:center"><img _load="1" id="aimg_460708" src="http://bbs.antiy.cn/data/attachment/forum/201506/16/114446r9ck3k3cjknk9jjq.png" width="762"/></p><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">NTLM挑战和SMB服务器数据<br style="text-align: left;"/><br style="text-align: left;"/>ED92：文件系统调查<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;枚举所有本地驱动器并连接网络共享<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;列举文件<br style="text-align: left;"/>EF97：文件系统公用程序<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;枚举文件<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;创建并移除目录<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;复制/移动/删除文件和目录<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;从文件中提取版本信息<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;计算文件哈希<br style="text-align: left;"/>其他已知变种：F71E。<br style="text-align: left;"/>持续性机制<br style="text-align: left;"/>该Duqu2.0恶意软件平台是为了专门为被感染的系统服务而设计的，不需要具有持久性。为了实现这一点，攻击者感染具有正常运行时间的服务器，然后通过
重新启动重新感染该域被消除感染的机器。仅生存在内存中，然而通过漏洞运行内核级代码正是该组织技术实力的证明。在本质上，攻击者有足够的信心他们可以幸
存于被攻击的计算机的整个网络，而不依赖于任何持续机制。<br style="text-align: left;"/>Duqu 
2.0之所以不具备持续性可能是因为攻击者想尽可能不被检测到。多数现代反APT技术可以精确定位磁盘上的异常，如罕见的驱动程序、未签名程序或恶意程
序。另外，该恶意软件生还重启的系统可以被成像，然后在稍后的时间对其进行彻底分析。若遭受Duqu2.0攻击，则对受感染系统进行取证分析是非常困难
的，研究人员需要撰取被感染机器的内存快照，然后确定内存中的感染。<br style="text-align: left;"/>然而，该机制具有一个弱点；万一发生大规模停电，所有的计算机将被重新启动，那么该恶意软件将被根除。为了规避这个问题，攻击者有另一种解决方案 
，他们通过直接互联网连接对少数计算机部署驱动器。这些驱动器可以从外部挖取流量进入该网络，从而允许攻击者访问远程桌面会话或者通过使用之前获得的用户
凭证连接该区域内的服务器。通过使用这些用户凭证，他们便可以重新部署该整个平台。<br style="text-align: left;"/>命令和控制机制<br style="text-align: left;"/>Duqu2.0使用2011年变种中最复杂并且高度灵活的命令和控制机制，具备由其他顶级恶意软件（如Regin）所激发新特征。包括使用网络管道和邮筒，原始过滤网络流量并在图像文件内掩蔽C＆C流量。<br style="text-align: left;"/> <br style="text-align: left;"/>在Windows 
LAN内，新感染的客户端可能没有将C＆C硬编码于其MSI安装包内。如果没有C＆C，他们便处于“休眠”状态，并且可以通过攻击者使用包含字符串
“tttttttttttttttt”的特殊的TCP/ 
IP数据包越过SMB网络管道而被激活。如果C＆C包含于该MSI文件的配置部分，这要么是一个充当弹跳点的本地IP地址，要么是外部IP地址。作为感染
的总体战略，攻击者鉴定具备正常运行的服务器并将它们设置为中介C＆C点。因此，被感染的计算机可以在接触互联网之前在LAN多个内部服务器之间跳跃。<br style="text-align: left;"/>要连接C＆C服务器， 2011年和2014/2015版本的Duqu可以将流量作为附加到一个无恶意的图像文件的加密数据而隐藏。2011版使用的JPEG文件来实现这一点；新版本可以使用GIF文件或JPEG文件。下图所示为这些图像文件：<br style="text-align: left;"/></span></p><p style="text-align:center"><img _load="1" id="aimg_460709" src="http://bbs.antiy.cn/data/attachment/forum/201506/16/114506wr11vr6yr06l66rc.png" width="676"/></p><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">对2014/2015变种的另一次修改是增加了用于HTTP通信的多用户代理字符串。 2011版使用以下用户代理字符串：<br style="text-align: left;"/>&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;Mozilla/5.0 (Windows; U; Windows NT 6.0; en-US; rv:1.9.2.9) Gecko/20100824 Firefox/3.6.9 (.NET CLR 3.5.30729)<br style="text-align: left;"/>新变种将从有53种不同的字符串列表中随机选择一个用户代理字符串。<br style="text-align: left;"/> <br style="text-align: left;"/>另一个不寻常的C＆C机制依赖于用来窃取C＆C通信和攻击者的RDP/SMB活动至网络的驱动程序文件。攻击者通过直接互联网联通将该转换驱动程序部署于
服务器。通过敲击机制，攻击者可以为它们的IP激活该转换机制，并挖取它们的流量至LAN。LAN之外，该流量可以越过端口443而被掩盖；LAN内，它
可以用来指向SMB/ RDP或可以越过伪造的TCP / IP包进一步被编译至IP8.8.8.8。<br style="text-align: left;"/>在我们做调查期间，我们发现几个这样的驱动器。参见下图：<br style="text-align: left;"/><strong> “portserv.sys”驱动器分析 </strong><br style="text-align: left;"/>MD5：2751e4b50a08eb11a84d03f8eb580a4e<br style="text-align: left;"/></span></p><p style="text-align:center"><img _load="1" id="aimg_460710" src="http://bbs.antiy.cn/data/attachment/forum/201506/16/114558nzxuu4lahhl06hp4.jpg" width="800"/></p><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">大小：14336<br style="text-align: left;"/>编译时间：2006年2月11日 （虚构的时间戳）<br style="text-align: left;"/>内部名称：termport.sys<br style="text-align: left;"/>类型：Win32 device driver （一个64位的版本）<br style="text-align: left;"/> <br style="text-align: left;"/>这是一个旨在执行操作TCP/ IP数据包以允许攻击者在受害者的基础设施访问内部服务的器恶意NDIS过滤驱动程序。<br style="text-align: left;"/>在启动时，该过滤器驱动程序挂接到NDIS堆栈并开始处理TCP / IP数据包。<br style="text-align: left;"/>为了利用该驱动器，攻击者首先向被感染的服务器的硬编码IP发送一个包含字符串“romanian.antihacker”的特殊的TCP/IP包。一般
情况下，这样的服务器是具备直接联网的计算机，例如网络服务器或代理服务器。该驱动器看到这个数据包，识别字符串“romanian. 
antihacker ”并保存攻击者的IP以备后用。<br style="text-align: left;"/></span></p><p style="text-align:center"><img _load="1" id="aimg_460711" src="http://bbs.antiy.cn/data/attachment/forum/201506/16/114602wfbmsfffad6qu1h7.png" width="800"/></p><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">该驱动器内用于敲击的字符串&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;<br style="text-align: left;"/>当有来自攻击者的IP（之前保存的）的数据包，以下逻辑也适用：<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;数据包至端口443服务器1的IP被重定向至端口445（Samba/Windows文件系统）<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;来自端口445服务器1的IP的数据包会被重定向至攻击者的IP端口443<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;数据包至端口443服务器2的IP 被重定向至端口3389（远程桌面）<br style="text-align: left;"/>•&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;来自端口3389服务器2的IP的数据包会被重定向指攻击者的IP端口443<br style="text-align: left;"/>这有效地使攻击者窃取SMB（远程文件系统访问）和远程桌面到这两个服务器，却能使其看起来像SSL流量（端口443）。<br style="text-align: left;"/>这些驱动器允许Duqu攻击者可以轻易地远程访问LAN内的服务器，包括通过端口443（通常是SSL）窃取RDP会话。这也给了他们一个持久性机制，允
许他们在所有被感染的机器的内存中的该恶意软件被重新启动后返回。攻击者可以使用现有的用户凭证回到该服务器服务的任何一个驱动器，并初始化该后门。<br style="text-align: left;"/> <br style="text-align: left;"/>Duqu和Duqu 2.0之间的相似性<br style="text-align: left;"/>2014/2015版Duqu2.0是CrySyS实验室发现的2011版Duqu恶意软件的升级版 。它包括许多现代恶意软件（如Regin,）具备的新特点，也具备横向移动战略，并具备超越其他APT攻击中常见的恶意软件的能力。<br style="text-align: left;"/>并驾齐驱：<br style="text-align: left;"/></span></p><table cellspacing="0"><tbody><tr class="firstRow"><td width="216"><br style="text-align: left;"/></td><td width="216"><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">2011&nbsp;&nbsp;Duqu</span></p></td><td width="217"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">&nbsp;&nbsp;</span><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">2014/2015&nbsp;&nbsp;Duqu 2.0</span></p><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">&nbsp;&nbsp;</span></td></tr><tr><td width="216"><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">受害者数量</span></p></td><td width="216"><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">&lt;50（估算）</span></p></td><td width="217"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">&nbsp;&nbsp;</span><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">&lt;100（估算）</span></p><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">&nbsp;&nbsp;</span></td></tr><tr><td width="216"><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">持续性机制</span></p></td><td width="216"><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">是</span></p></td><td width="217"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">&nbsp;&nbsp;</span><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">否</span></p><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">&nbsp;&nbsp;</span></td></tr><tr><td width="216"><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">加载器</span></p></td><td width="216"><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">sys驱动器</span></p></td><td width="217"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">&nbsp;&nbsp;</span><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">msi文件</span></p><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">&nbsp;&nbsp;</span></td></tr><tr><td width="216"><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">使用的零日漏洞</span></p></td><td width="216"><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">是</span></p></td><td width="217"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">&nbsp;&nbsp;</span><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">否</span></p><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">&nbsp;&nbsp;</span></td></tr><tr><td width="216"><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">主存储器</span></p></td><td width="216"><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">pnf（自定义）文件</span></p></td><td width="217"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">&nbsp;&nbsp;</span><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">msi文件</span></p><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">&nbsp;&nbsp;</span></td></tr><tr><td width="216"><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">C&amp;C机制</span></p></td><td width="216"><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">http/https，网络通道</span></p></td><td width="217"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">&nbsp;&nbsp;</span><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">http/https，网络通道</span></p><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">&nbsp;&nbsp;</span></td></tr><tr><td width="216"><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">已知插件</span></p></td><td width="216"><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">6</span></p></td><td width="217"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">&nbsp;&nbsp;</span><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">&gt;100</span></p><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">&nbsp;&nbsp;</span></td></tr></tbody></table><p style="text-align: left;"><br style="text-align: left;"/><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">两者的代码有许多相似性，因此我们认为Duqu2.0是在Duqu的原始的源代码的基础上创建的。对此感兴趣的读者可以阅读下文对这些相似性的技术说明。<br style="text-align: left;"/> <br style="text-align: left;"/>原始Duqu最独特的“商标”特征之一是对提供记录工具的函数的设置。与许多其他的APT不同，Duqu记录其活动的每一个重要步骤，不过是以一种特殊的
方式：日志中没有写入可读的字符串。反而是一系列独特的数字来识别每一种状态、错误或日志中的消息。比较产生Duqu和Duqu 
2.0每个日志项的函数，我们发现他们几乎是相同的：<br style="text-align: left;"/></span></p><p style="text-align:center"><img _load="1" id="aimg_460712" src="http://bbs.antiy.cn/data/attachment/forum/201506/16/114650l3pmjj0xv9jpdu30.jpg" width="800"/></p><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">第一代Duqu也是用一种非常罕见和独特的方式编写。它通过Visual Studio编译，而它的某些部分用C ++编写，其大部分类不是由C 
++编译器生成。分析过所有变种后，我们认为这些类别是用OO-C（C语言的变种）编写，然后以某种方式转化成可编译的C / C 
++源代码。所有这些类别有一个非常特殊的功能：每个实例的虚拟函数表在其构造器中都是“手动”填充。有趣的是，这不再是Duqu2.0案例所具备的。开
发者从Visual Studio2008（2011年使用）到Visual Studio2013升级了他们的编译器，并且目前使用看起来更像原始C 
++的编译器：<br style="text-align: left;"/></span></p><p style="text-align:center"><img _load="1" id="aimg_460713" src="http://bbs.antiy.cn/data/attachment/forum/201506/16/114709ke2jwpn828tezwmm.jpg" width="800"/></p><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">左侧：Duqu中“手动”或“编译器协助”分类；<br style="text-align: left;"/>右侧：Duqu 2.0同样的类别类似于原始C++虚拟表，然而指针偏移不是零。<br style="text-align: left;"/> <br style="text-align: left;"/>如果寻找那些真正使用记录工具的函数，我们可以发现有关相似更具体的证据。开发者仍然使用相同的唯一的编号进行识别内部状态、错误和函数结果。可以通过网络功能进行比较：<br style="text-align: left;"/></span></p><p style="text-align:center"><img _load="1" id="aimg_460714" src="http://bbs.antiy.cn/data/attachment/forum/201506/16/114759lxxek22505tatmjm.jpg" width="800"/></p><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">Duqu和Duqu 2.0执行相同的网络函数。注意：同样的唯一编码（红色方框）PUSHed是函数的参数。<br style="text-align: left;"/> <br style="text-align: left;"/></span></p><p style="text-align:center"><img _load="1" id="aimg_460715" src="http://bbs.antiy.cn/data/attachment/forum/201506/16/114801u2a2wtqoo2wkk6e6.jpg" width="800"/></p><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">另一种网络例程：调用recv()从网络接收数据，Duqu记录结果和可能存在的网络错误（通过WSAGetLastError（）获得）。红色方框中的唯一编码用来识别网络例程的当前状态。<br style="text-align: left;"/>自2011年以来，管理平台的代码在许多方面已发生演变。其中最显著的差异之一即目前使用大量HTTP用户代理字符串列表而不是单一的硬编码字符串：<br style="text-align: left;"/></span></p><p style="text-align:center"><img _load="1" id="aimg_460716" src="http://bbs.antiy.cn/data/attachment/forum/201506/16/114805fn9b08uub8x4nkwf.jpg" width="800"/></p><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;"> <br style="text-align: left;"/>该开发者还修改了鉴定加密网络流量的双字节值：“SH”被更中立的并且更难追踪的“WW”替换：<br style="text-align: left;"/></span></p><p style="text-align:center"><img _load="1" id="aimg_460717" src="http://bbs.antiy.cn/data/attachment/forum/201506/16/114806s2dxxsj4k4f4sesz.jpg" width="800"/></p><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">验证网络流量中“魔数”的代码。<br style="text-align: left;"/>如果x86/64架构中的数据采用低字节序，则字符被交换。<br style="text-align: left;"/>Duqu和Duqu 
2.0都使用特殊结构以确定插件的接口。该管理平台具有一个用于其“核心”插件的用自有代码编译的接口。较新的版本有一个更大的表，因此用更多的函数，以
及不同的符号来描述该插件的功能。特殊字符串（如“A888A8&gt;@”）描述每个函数的签名。较早的Duqu包含类似的二进制形式的字符串（不可
读）。<br style="text-align: left;"/></span></p><p style="text-align:center"><img _load="1" id="aimg_460718" src="http://bbs.antiy.cn/data/attachment/forum/201506/16/114904bk0m8ymj3m30s0x3.jpg" width="800"/></p><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">Duqu和Duqu 2.0的两个不同版本的“核心”插件的数据结构和两，请注意相同的常量和类似函数。<br style="text-align: left;"/> <br style="text-align: left;"/>该Duqu 
C＆C代码使用小型图像文件越过被解密的通道来隐藏其通信，如HTTP。原始Duqu使用JPEG文件，已知的Duqu2.0版本使用类似的JPEG文
件，一个更大的GIF文件。此外，数据段的布局并没有太大变化：图像数据以简短的AES加密密钥为先导（Duqu中的字符串“sh123456”， 
Duqu2.0中两个二进制DWORD），LZO版本字符串“2.03”紧随其后。<br style="text-align: left;"/></span></p><p style="text-align:center"><img _load="1" id="aimg_460719" src="http://bbs.antiy.cn/data/attachment/forum/201506/16/114909h24m00tjwjm2g2gm.jpg" width="800"/></p><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">用于隐藏C&amp;C 通信的图像数据：Duqu（JPEG），Duqu Bet（类似的JPEG），Duqu不同版本（GIF）。注意LZO版本的字符串“2.03”和加密密钥。<br style="text-align: left;"/>Duqu 2011的代码和Duqu2.0样本代码之间的相似性表明，新代码表示恶意软件平台的新的迭代。不访问2011 Duqu源代码就无法创建新版本。因此，我们认为两者的开发者相同或是一起合作开发<br style="text-align: left;"/>Duqu 2.0的受害者<br style="text-align: left;"/>我们在几个区域发现了 Duqu 2.0的受害者，包括西方国家、中东和亚洲。攻击者不仅攻击金融企业还攻击功利性目标，这使得他们提高网络能力。<br style="text-align: left;"/>其大多数最终目标似乎与其2011版的目标相似，都窥探伊朗的核计划。一些新型2014-2015版感染与P5+1事件相链接，并涉及与伊朗谈判有关的核
交易场所。Duqu背后的攻击者似乎针对一些类似于此场地进行高级会谈的场馆发动了攻击。除了P5+1事件，Duqu 
2.0组织发动了涉及奥斯威辛解放七十周年纪念活动的攻击 。<br style="text-align: left;"/> <br style="text-align: left;"/>其他新版本的攻击目标我们称之为“功利性”目标。即被攻击者攻击以提高他们的网络能力的企业。例如，2011年，攻击者攻击了匈牙利一家证书颁发机构；显
然，这将使他们生成数字证书，可以用来进一步签署恶意软件样本。Duqu2.0也发动了相同模式的攻击。一些工业控制系统和工业计算机系统的企业被
Duqu2.0感染。<br style="text-align: left;"/><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 32px;">归属</span><br style="text-align: left;"/>像往常一样，追踪针对互联网的网络攻击是一项艰巨的任务。在Duqu木马发动的攻击的案例中，攻击者使用多个代理和跳跃点以掩盖它们的连接。这使得对其的追踪变得极其复杂。<br style="text-align: left;"/>此外，攻击者试图采用几个旨在发送给研究人员以误导他们的研究方向的假标志贯穿于代码之中。例如，其中一个驱动器包含字符串
“ugly.gorilla”，这显然指的是汪东 （一名中国黑客，据说与APT1有关）。之前在与APT1有关的恶意软件样本中看到在MSI 
VFSes中使用的Camellia密码，是攻击者植入的另一种假标志，旨在让研究人员认为他们在处理与APT1有关的恶意软件。
“portserv.sys”驱动器中使用的“romanian.antihacker”字符串可能旨在模仿常常出现在服务器日志的
“w00tw00t.at.blackhats.romanian. 
anti-sec”请求，或只是请求指向所谓的攻击起源地罗马尼亚。使用罕见的压缩算法同样具有欺骗性。例如，在一些样本中使用的LZJB算法在恶意软件
样本中很少见；它曾被我们在2013年初报道的MiniDuke使用过。<br style="text-align: left;"/>然而，这种假标志都比较容易被发现，尤其是当攻击者非常小心以避免犯其他错误的时候。<br style="text-align: left;"/>2011年，我们做分析期间，我们从一些代理收集到的日志表明，星期五攻击者不怎么工作，星期六不工作，他们的正常工作周开始从周日开始。1月1日，他们
还编制了二进制文件，表明对他们来说这可能是一个正常的工作日。该二进制文件的编译时间戳似乎暗示GMT+2或GMT+3时区。最后，他们通常在星期三发
动攻击，这就是为什么我们原来称他们“周三帮”。而2014年针对卡巴斯基实验室的攻击也发生在星期三，比起他们在2011年时的运作，该组织取得了巨大
的OPSEC改进，包括将所有PE文件的时间戳进行伪装，删除所有调试路径和内部模块的名称。<br style="text-align: left;"/>2014版Duqu2.0二进制文件包含若干用几乎完美的英语编译的字符串，但其中一个字符串的编译却犯了小儿科错误，这表明该组织中有母语不是英语的人员。我们发现的Duqu 2.0唯一的语言错误即在文件收集模块用“Excceeded”代替“Exceeded”。<br style="text-align: left;"/> <br style="text-align: left;"/></span></p><p style="text-align:center"><img _load="1" id="aimg_460720" src="http://bbs.antiy.cn/data/attachment/forum/201506/16/114957rlzqqjdo8x6p0d9s.png" width="800"/></p><p style="text-align: left;"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">Duqu 2.0中单词“Exceeded”的拼写错误<br style="text-align: left;"/>最有趣的，其中一个受害者似乎同时被方程式组织和Duqu组织所感染；这表明这两个实体是不同的并且相互竞争以从该受害者获取信息。<br style="text-align: left;"/><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 32px;">结论</span><br style="text-align: left;"/>2011年Duqu木马发动攻击期间，我们认为其主要目的应是刺探伊朗的核计划。一些受害者似乎是“功利性的”，如匈牙利的一家被Duqu木马攻击并最终
导致它的发现的凭证管理中心。Duqu木马背后的组织攻击这些“功利性的”的受害者以获得一定的技术能力，如用可信任的证书签署其恶意软件或充当平台已进
行进一步攻击。<br style="text-align: left;"/>虽然主要的管理平台和C&amp;C核心基本维持不变，但是2014/2015版Duqu2.0超越了较早的“Tilded”平台取得了极大的提高。早在
2011年，我们指出了使用Object Oriented C是一种不寻常的编程技术 。 
虽然添加了C++中的一些新对象，但是2014版仍保持着相同的核心。2014年使用的编译器更新，并导致了不同的代码优化。尽管如此，该核心的函数依然
如故，并且我们认为，任何人如果不访问原始的Duqu源代码都无法创建2014/2015 Duqu 
2.0。鉴于这些源代码从未被公开，以及考虑到它们的主要兴趣目标似乎是相同的，我们认为Duqu和Duqu2.0的幕后黑手相同。<br style="text-align: left;"/>将卡巴斯基实验室定为目标展现了攻击者取得了大踏步的“进步”，同样也是网络军备竞赛升级如此之快的信标。早在2011年和2013年，RSA 
和Bit9 
分别被讲汉语的APT组织攻击，然而，此类事件被认为是罕见的。一般情况下，攻击者将安全企业定为目标要冒很大的风险，因为他们会被逮住并被曝光。虽然攻
击者似乎是想要获取有关卡巴斯基的未来技术、安全操作系统、反APT解决方案、KSN和APT研究的信息，但是卡巴斯基实验室为什么会被定为目标的具体原
因尚不明确。<br style="text-align: left;"/> <br style="text-align: left;"/>从攻击者的角度来看，决定将世界级的安全企业定为目标一定很艰难。一方面，它肯定意味着该攻击将被暴露，忽视该攻击时不可能的。因此，将安全企业定为目标
表明，要么是攻击者非常有信心他们不会被抓，要么是他们不关心将要被发现并暴露。决定将卡巴斯基实验室定为目标时，该Duqu攻击者可能下了一个巨大的赌
注希望他们不被发现；继续潜伏。<br style="text-align: left;"/>对于一家安全企业来说，最困难的事情之一就是承认自己沦为恶意软件攻击的受害者。卡巴斯基实验室坚信透明度，这就是为什么我们在此发布该信息。对于我们来说，我们的用户的安全仍然是重中之重， 我们将继续努力以维护您的信任和信心。<br style="text-align: left;"/><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 32px;">参考文献</span><br style="text-align: left;"/>1.&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;Duqu: A Stuxnet-like malware found in the wild <br style="text-align: left;"/></span><a style="text-decoration: underline; font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;" href="https://www.crysys.hu/publications/files/bencsathPBF11duqu.pdf" target="_blank"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">https://www.crysys.hu/publications/files/bencsathPBF11duqu.pdf</span></a><br style="text-align: left;"/><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">2.&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;Duqu: The Precursor to the next Stuxnet <br style="text-align: left;"/></span><a style="text-decoration: underline; font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;" href="http://www.symantec.com/content/en/us/enterprise/media/security_response/whitepapers/w32_duqu_the_precursor_to_the_next_stuxnet.pdf" target="_blank"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">http://www.symantec.com/content/en/us/enterprise/media/security_response/whitepapers/w32_duqu_the_precursor_to_the_next_stuxnet.pdf</span></a><br style="text-align: left;"/><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">3.&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;The Mystery of Duqu: Part One <br style="text-align: left;"/></span><a style="text-decoration: underline; font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;" href="https://securelist.com/blog/incidents/31177/the-mystery-of-duqu-part-one-5/" target="_blank"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">https://securelist.com/blog/incidents/31177/the-mystery-of-duqu-part-one-5/</span></a><br style="text-align: left;"/><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">4.&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;The Mystery of Duqu: Part Two <br style="text-align: left;"/></span><a style="text-decoration: underline; font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;" href="https://securelist.com/blog/incidents/31445/the-mystery-of-duqu-part-two-23/" target="_blank"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">https://securelist.com/blog/incidents/31445/the-mystery-of-duqu-part-two-23/</span></a><br style="text-align: left;"/><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">5.&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;The Mystery of Duqu: Part Three <br style="text-align: left;"/></span><a style="text-decoration: underline; font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;" href="https://securelist.com/blog/incidents/31486/the-mystery-of-duqu-part-three-9/" target="_blank"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">https://securelist.com/blog/incidents/31486/the-mystery-of-duqu-part-three-9/</span></a><br style="text-align: left;"/><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">6.&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;The Mystery of Duqu: Part Five <br style="text-align: left;"/></span><a style="text-decoration: underline; font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;" href="https://securelist.com/blog/incidents/31208/the-mystery-of-duqu-part-five-6/" target="_blank"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">https://securelist.com/blog/incidents/31208/the-mystery-of-duqu-part-five-6/</span></a><br style="text-align: left;"/><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">7.&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;The Mystery of Duqu: Part Six (The Command and Control Servers) <br style="text-align: left;"/></span><a style="text-decoration: underline; font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;" href="https://securelist.com/blog/incidents/31863/the-mystery-of-duqu-part-six-the-command-and-" target="_blank"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">https://securelist.com/blog/incidents/31863/the-mystery-of-duqu-part-six-the-command-and-control-servers-36/</span></a><br style="text-align: left;"/><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">8.&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;The Mystery of Duqu: Part Ten <br style="text-align: left;"/></span><a style="text-decoration: underline; font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;" href="https://securelist.com/blog/incidents/32668/the-mystery-of-duqu-part-ten-18/" target="_blank"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">https://securelist.com/blog/incidents/32668/the-mystery-of-duqu-part-ten-18/</span></a><br style="text-align: left;"/><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">9.&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;The Mystery of Duqu Framework Solved <br style="text-align: left;"/></span><a style="text-decoration: underline; font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;" href="https://securelist.com/blog/research/32354/the-mystery-of-duqu-framework-solved-7/" target="_blank"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">https://securelist.com/blog/research/32354/the-mystery-of-duqu-framework-solved-7/</span></a><br style="text-align: left;"/><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">10.&nbsp; &nbsp;&nbsp; &nbsp;&nbsp;&nbsp;The Duqu Saga Continues <br style="text-align: left;"/></span><a style="text-decoration: underline; font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;" href="https://securelist.com/blog/incidents/31442/the-duqu-saga-continues-enter-mr-b-jason-and-tvs-dexter-22/" target="_blank"><span style="font-family: 微软雅黑,Microsoft YaHei; font-size: 14px;">https://securelist.com/blog/incidents/31442/the-duqu-saga-continues-enter-mr-b-jason-and-tvs-dexter-22/</span></a><br/></p><p><br style="text-align: left;"/></p></p>
                <hr/>
                <p style="text-align: center;">
                    <img src="http://bobao.360.cn/img/app.jpeg"/>
                    <img src="http://bobao.360.cn/img/weixin.jpeg"/>
                </p>
                                <p>本文转载自 安天实验室<br/><a class="text-more" href="http://bbs.antiy.cn/forum.php?mod=viewthread&amp;tid=62877#rd" target="_blank">原文链接：http://bbs.antiy.cn/forum.php?mod=viewthread&amp;tid=62877#rd</a></p>
                            </div>
            <div style="margin-top: 20px;background-color:#FFFFFF">
    <input type="hidden" id="detail_title" name="detail_title" value="Duqu 2.0技术分析 - 安全客 - 有思想的安全新媒体" />
    <input type="hidden" id="use_nickname" name="use_nickname" value="0" />
    <a name="mao"></a>
    <div class="reg-log mobile-hiden">
        <div class="" id="userTo">   
            <div id="to-list" class="input-text" style="">
                <textarea disabled="disabled" class="hide"  id="comment-content" to="to"></textarea>
                <ul id="preadded" style="display:none">       
                </ul>
                <div id="to-auto" style="width: 200px">
                    <ul id="feed">
                    </ul>
                </div>
            </div>
        </div>
        <input type="hidden" id="source-id" value="458" />
        <input type="hidden" id="source-type" value="learning" />
        <input type="hidden" id="post-comment-url" value="/comment/add" />
        <input type="hidden" id="post-nickname-url-ajax" value="/comment/randnicknameajax" />
        <input type="hidden" id="post-check-login-url-ajax" value="/comment/checklogin" />
        <input type="hidden" id="stoken_comment_set" value="64d932c9bb50dc5a83db601d9b02e735">                 <span class="join">参与讨论，请先 <a href="javascript:;" class="comment-login">登录</a> | <a href="javascript:;" class="comment-reg">注册</a> |  <a href="javascript:;" class="anonymous-comment">匿名评论</a></span>
            </div>
    <div class="mobile-hide" style="width: 870px; margin: 0 auto;">
        <label style="vertical-align:middle;" for="use_nickname">匿名</label> 
        <input style="vertical-align:middle;" id="trigger-nickname" name="use_nickname" class="use_nickname" type="checkbox" value="0" />

        <a href="javascript:;" class="apply-use button" id="submit-comment" data-target="/comment/add">发布</a>
    </div>


    <div class="clearfix"></div>
    <div class="comments">
        <div class="comments-head">
            <span class="title">用户评论</span>
        </div>
                <div class="comment-none alarm-info bg-primary">无任何评论</div>
            </div>
</div>
<script>
    $(function () {
        $('.anonymous-comment').click(function () {
            $(".join").hide();
            $(".reg-log textarea").first().removeAttr("disabled").show();
            $('#use_nickname').val('1');
//            $('#trigger-nickname').attr('checked', true);
            $('#trigger-nickname').trigger('click');
        });
        //为所有复选框绑定事件
//        checkbox_on_click();
        //ajax随机获取昵称
//        randnicknameajax(0);
        //ajax检测登录状态
        comment_check_login();
    });



    function input_checkbox(flag) {
        $('input:checkbox').each(function () {
            var value = flag ? 1 : 0;
            $(this).prop('checked', flag);
            $(this).val(value);
        });
    }

//ajax随机获取昵称
    function randnicknameajax(flag) {
        $.ajax({
            type: 'POST',
            url: $('#post-nickname-url-ajax').val(),
            data: {limit: 1, flag: flag},
            dataType: "json",
            success: function (data) {
                $('#nick-name').val(data.data[0]);
                _nick_name=data.data[0];
            }
        });
    }
    $();
//ajax检测登录状态
    function comment_check_login() {
        $.ajax({
            type: 'POST',
            url: $('#post-check-login-url-ajax').val(),
            data: {},
            dataType: "json",
            success: function (data) {
                if (data.success) {
                    $('.join').hide();
                    $(".reg-log textarea").first().removeAttr("disabled").show();
                    $("#span_use_nickname").show();
                    $('#use_nickname').val('0');
                    $('#use_nickname').attr('checked', false);
                }
            }
        });
    }
</script>        </div>
    </div>
    <div class="side-bar">
        <div class="mod hot-news">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-hot"></i><span>热门知识</span></h2>
    </div>
    <ul class="links-list">
                                <li><a href="/learning/detail/4411.html" alt="【漏洞预警】一个换行符引发的奥斯卡0day漏洞(CVE-2017-8759)重现——最新的Office高级威胁攻击预警" target="_blank">【漏洞预警】一个换行符引发的奥斯卡...</a></li>
                                <li><a href="/learning/detail/4416.html" alt="【漏洞预警】Microsoft .NET Framework漏洞（CVE–2017–8759）预警" target="_blank">【漏洞预警】Microsoft .NE...</a></li>
                                <li><a href="/learning/detail/4414.html" alt="【技术分享】妙用JavaScript绕过XSS过滤" target="_blank">【技术分享】妙用JavaScrip...</a></li>
                                <li><a href="/learning/detail/4425.html" alt="【安全报告】XShellGhost事件技术回顾报告" target="_blank">【安全报告】XShellGhost事件...</a></li>
                                <li><a href="/learning/detail/4424.html" alt="【知识】9月16日 - 每日安全知识热点" target="_blank">【知识】9月16日 - 每日安全知识热...</a></li>
                                <li><a href="/learning/detail/4418.html" alt="【技术分享】利用威胁情报数据平台拓展APT攻击线索一例" target="_blank">【技术分享】利用威胁情报数据平台拓...</a></li>
            </ul>
</div>        <!-- 友情链接 -->
        <div class="mod blog-links mobile-hide">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-link"></i><span>友情链接</span></h2>
        <a href="/links/index.html" class="more">更多<i></i></a>
    </div>
        <ul class="links-list">
                <li><a href="http://bbs.360safe.com" alt="360安全社区" target="_blank">360安全社区</a></li>
                <li><a href="http://zhuji.360.cn" alt="360主机卫士" target="_blank">360主机卫士</a></li>
                <li><a href="http://blogs.360.cn/" alt="奇虎360技术博客" target="_blank">奇虎360技术博客</a></li>
                <li><a href="http://wangzhan.360.cn/" alt="360网站卫士" target="_blank">360网站卫士</a></li>
                <li><a href="http://webscan.360.cn/" alt="360网站安全检测" target="_blank">360网站安全检测</a></li>
                <li><a href="http://research.360.cn/report/" alt="360研究报告" target="_blank">360研究报告</a></li>
                <li><a href="http://unicorn.360.cn/" alt="360 Unicorn Team" target="_blank">360 Unicorn Team</a></li>
                <li><a href="http://appscan.360.cn/" alt="360捉虫猎手" target="_blank">360捉虫猎手</a></li>
                <li><a href="https://threathunter.org/" alt="ThreatHunter社区" target="_blank">ThreatHunter社区</a></li>
                <li><a href="http://security.360.cn/" alt="360安全应急响应中心" target="_blank">360安全应急响应中心</a></li>
            </ul>
    </div>
        <!-- 联系我们 -->
        <div class="mod contact mobile-hide" style="text-align:center">
    <div class="head-bar clearfix">
        <h2><i></i><span>关注我们</span></h2>
    </div>
    <!-- 微信关注 -->
    <ul class="contact-way">
        <li><a>微信关注</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/qrcode_adlab_weixin.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
    <!-- APP下载 -->
    <ul class="contact-way">
        <li><a>安全播报APP</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/scan_code_big.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
</div>

    </div>
</div>

<script type="text/javascript" src="/js/jquery-ui.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/jquery.noty.packaged.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/common.js?v=4.5"></script>
<script>$(function() {sync_count('comment');});</script>


<!-- 语法高亮 -->
<script type="text/javascript" src="/ue/SyntaxHighlighter/shCore.js"></script>
<script type="text/javascript">SyntaxHighlighter.all();sync_count('vul');sync_count('news');sync_count('learning');sync_count('activity');sync_count('course');sync_count('ctf');</script>
    </div>

        <div class="footer">
        <div class="friend-link">
            <a href="http://www.360.cn/" target="_blank">360首页</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">关于我们</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">联系我们</a>
            <span>|</span>
            <a href="/links/index.html" target="_blank">友情链接</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">招贤纳士</a>
        </div>
        <div class="copy">
            Copyright &copy; 360网络攻防实验室 All Rights Reserved <span class="copy_icp">京ICP证080047号[京ICP备08010314号-6]</span>
        </div>
    </div>
    
</div>

<!--奇舞团统计-->

<script src='https://s.ssl.qhimg.com/static/f5407c785655e6a1/monitor_analytic.js'></script>
<script>
    monitor.setProject('QH_171_1').getTrack().getClickAndKeydown().getClickHeatmap(10, 1);
</script>

<div class="hide">
    <script src="https://s95.cnzz.com/z_stat.php?id=1253147824&web_id=1253147824" language="JavaScript"></script>
</div>
<div class="backToTop_wrap off">
    <a id="back_to_top" class="backToTop" href="javascript:;" title="返回顶部"></a>
</div>
<script>
    var $backToTop_wrap = $(".backToTop_wrap"),
        $backToTop_btn = $("#back_to_top");

    if ($(window).scrollTop() > 100) {
        $backToTop_wrap.removeClass("off");
    }
    else {
        $backToTop_wrap.addClass("off");
    }

    $(window).on("scroll", function () {
        if ($(this).scrollTop() > 100) {
            $backToTop_wrap.removeClass("off");
        }
        else {
            $backToTop_wrap.addClass("off");
        }
    });

    $backToTop_btn.on("click", function () {
        $("html, body").animate({scrollTop: 0}, 120);
    });

    $(function () {
        var navlist = $('.nav-list > li');

        navlist.each(function () {
            $(this).on('mouseenter', function () {
                $(this).addClass('selected');
            });

            $(this).on('mouseleave', function () {
                $(this).removeClass('selected');
            });
        });
    })
</script>



</body>
</html>
