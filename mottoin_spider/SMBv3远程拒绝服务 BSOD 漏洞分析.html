<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
    <title>SMBv3远程拒绝服务(BSOD)漏洞分析 | MottoIN</title>
    <link rel='dns-prefetch' href='//www.mottoin.com' />
<link rel='dns-prefetch' href='//s.w.org' />
<link rel="alternate" type="application/rss+xml" title="MottoIN &raquo; SMBv3远程拒绝服务(BSOD)漏洞分析评论Feed" href="http://www.mottoin.com/95981.html/feed" />
<link rel='stylesheet' id='stylesheet-css'  href='http://www.mottoin.com/wp-content/themes/JustNews/css/style.css?ver=2.3.2' type='text/css' media='all' />
<link rel='stylesheet' id='wpcom-qa-css'  href='http://www.mottoin.com/wp-content/plugins/wpcom-qa/css/style.css?ver=1.0' type='text/css' media='all' />
<style id='wpcom-qa-inline-css' type='text/css'>

        .q-content .topic-tab,.q-content .q-answer .as-user,.q-content .q-answer .as-comment-name{color: #1471CA;}
        .q-content .q-topic-wrap a:hover,.q-content .q-answer .as-action a:hover,.q-content .topic-tab:hover{color:#0D62B3;}
        .q-content .put-top,.q-content .topic-tab.current-tab,.q-content .q-answer .as-submit .btn-submit,.q-content .q-answer .as-comments-submit,.q-content .q-add-header .btn-post,.q-content .q-pagination .current{background-color:#1471CA;}
        .q-content .q-answer .as-submit .btn-submit:hover,.q-content .q-answer .as-comments-submit:hover,.q-content .q-add-header .btn-post:hover,.q-content .topic-tab.current-tab:hover,.q-content .q-pagination a:hover{background-color:#0D62B3;}
        .q-content .q-answer .as-comments-input:focus{border-color: #1471CA;}
        
</style>
<link rel='stylesheet' id='um_minified-css'  href='http://www.mottoin.com/wp-content/plugins/ultimate-member/assets/css/um.min.css?ver=10.3.88' type='text/css' media='all' />
<script type='text/javascript' src='http://www.mottoin.com/wp-content/themes/JustNews/js/jquery.min.js?ver=1.12.4'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://www.mottoin.com/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://www.mottoin.com/wp-includes/wlwmanifest.xml" /> 
<link rel='prev' title='十个最佳TOR替代品' href='http://www.mottoin.com/95977.html' />
<link rel='next' title='英国在过去的三个月内188个主要网络被攻击' href='http://www.mottoin.com/96066.html' />
<link rel='shortlink' href='http://www.mottoin.com/?p=95981' />
<!--  WPCOM主题相关信息开始 -->
<meta name="applicable-device" content="pc,mobile">
<meta http-equiv="Cache-Control" content="no-transform">
<meta name="keywords" content="漏洞">
<meta name="description" content="前言我是菜鸟，大牛轻喷……这个SMBv3漏洞是由lgandx爆出的一个未被微软修复的漏洞（暂未发布补丁），漏洞出来后我进行了一定的分析，花了很多时间，这个漏洞有一些意思，但是对于SMB的整个协议通信过程非常庞大，所以没有进行非常细致的跟踪，包括一些不透明的结构体让我感到晕头转向，但到最后还是有了一些结果。这个SMB漏洞可以看作是被动的，需要用户主动去访问445端口才可以触发，而不像ms08067一">
<!--  WPCOM主题相关信息结束 -->
 
		<script type="text/javascript">

		var ultimatemember_image_upload_url = 'http://www.mottoin.com/wp-content/plugins/ultimate-member/core/lib/upload/um-image-upload.php';
		var ultimatemember_file_upload_url = 'http://www.mottoin.com/wp-content/plugins/ultimate-member/core/lib/upload/um-file-upload.php';
		var ultimatemember_ajax_url = 'http://www.mottoin.com/wp-admin/admin-ajax.php';

		</script>

	
		<style type="text/css">.request_name { display: none !important; }</style>

	<link rel="icon" href="http://www.mottoin.com/wp-content/uploads/2016/12/cropped-Avatar-32x32.jpg" sizes="32x32" />
<link rel="icon" href="http://www.mottoin.com/wp-content/uploads/2016/12/cropped-Avatar-192x192.jpg" sizes="192x192" />
<link rel="apple-touch-icon-precomposed" href="http://www.mottoin.com/wp-content/uploads/2016/12/cropped-Avatar-180x180.jpg" />
<meta name="msapplication-TileImage" content="http://www.mottoin.com/wp-content/uploads/2016/12/cropped-Avatar-270x270.jpg" />
    <style>
                a,.sec-panel-head span,.list.tabs .tab.active a,.header .nav>li.active>a,.header .dropdown-menu>.active>a,.entry .entry-info .nickname,.entry-bar-inner .author-title,.entry-action .btn-zan,.entry-action .btn-dashang,.comment-body .nickname,.form-submit-text span,.widget_profile .author-title,.um .um-profile-body .um-item-meta a,.login-modal-body .btn-register{color: #08c;}
        .header .dropdown-menu>li>a:hover,.header .dropdown-menu>.active>a:hover,.header .dropdown-menu>.active>a:focus,.navbar-action .publish,.pagination .current,.flex-control-paging li a.flex-active,.form-submit .submit,.sidebar .widget_nav_menu ul li.current-menu-item a,.sidebar .widget_nav_menu ul li.current-post-parent a,.search-form input.submit,.action .contact-title,.pf-submit,.tagHandler ul.tagHandlerContainer li.tagItem,.login-modal-body .btn-login,.woocommerce a.button,.woocommerce button.button,.woocommerce input.button,.woocommerce a.button.alt,.woocommerce button.button.alt,.woocommerce input.button.alt,.woocommerce a.button.alt.disabled,.woocommerce a.button.alt.disabled:hover,.woocommerce a.button.alt:disabled,.woocommerce a.button.alt:disabled:hover,.woocommerce a.button.alt:disabled[disabled],.woocommerce a.button.alt:disabled[disabled]:hover,.woocommerce button.button.alt.disabled,.woocommerce button.button.alt.disabled:hover,.woocommerce button.button.alt:disabled,.woocommerce button.button.alt:disabled:hover,.woocommerce button.button.alt:disabled[disabled],.woocommerce button.button.alt:disabled[disabled]:hover,.woocommerce input.button.alt.disabled,.woocommerce input.button.alt.disabled:hover,.woocommerce input.button.alt:disabled,.woocommerce input.button.alt:disabled:hover,.woocommerce input.button.alt:disabled[disabled],.woocommerce input.button.alt:disabled[disabled]:hover,.woocommerce .widget_price_filter .ui-slider .ui-slider-handle,.woocommerce .widget_price_filter .ui-slider .ui-slider-range,.shopping-count,.social-login-form .sl-input-submit{background-color: #08c;}
        .entry .entry-content h3,.entry .entry-content .h3,.widget-title{border-left-color: #08c;}
        .entry-bar-inner .author-title,.entry-action .btn-zan,.entry-action .btn-dashang,.search-form input.keyword:focus,.widget_profile .author-title,.login-modal-body .btn-login,.login-modal-body .btn-register{border-color: #08c;}
        .entry-bar-inner .author-title:before,.widget_profile .author-title:before{border-right-color: #08c;}
        .list.tabs .tab.active a{border-bottom-color: #08c;}

        a:hover,.header .nav>li>a:hover,.header .nav>li.active>a,.navbar-action .login:hover,.navbar-action .login:focus,.navbar-action .profile a:hover,.navbar-search-icon:hover,.navbar-search-icon:focus,.entry .entry-info a:hover,.entry .entry-info a:focus,.entry-bar .info-item a:hover,.p-item-wrap:hover .title a,.special-item-title a:hover,.special-item-bottom a:hover,.widget ul a:hover,.widget ol a:hover,.sec-panel-head .more:hover,.topic-list .topic-wrap:hover span,.tabs .tab a:hover,
        .article-list .item-title a:hover,.article-list .item-meta a:hover,.article-list .item-meta a:focus,.list-links a:hover,.list-links a:focus,.um .um-profile-body .um-item-meta a:hover,.um .um-profile-body .um-item-link a:hover,.load-more:hover,.login-modal-body .btn-register:hover{color: #07c;}
        .navbar-action .publish:hover,.navbar-action .publish:focus,.entry-tag a:hover,.entry-tag a:focus,.entry-action .btn-zan:hover,.entry-action .btn-dashang:hover,.entry-action .btn-zan.liked,.pagination a:hover,.flex-control-paging li a:hover,.form-submit .submit:hover,.widget .tagcloud a:hover,.sidebar .widget_nav_menu ul li.current-menu-item .sub-menu a:hover,.sidebar .widget_nav_menu ul li.current-post-parent .sub-menu a:hover,.sidebar .widget_nav_menu ul li a:hover,.search-form input.submit:hover,.action .a-box:hover,.footer-sns .fa:after,.article-list .item-category:hover,.pf-submit:hover,.tagHandler ul.tagHandlerContainer li.tagItem:hover,.login-modal-body .btn-login:hover,.woocommerce a.button:hover,.woocommerce button.button:hover,.woocommerce input.button:hover,.woocommerce a.button.alt:hover,.woocommerce button.button.alt:hover,.woocommerce input.button.alt:hover,.woocommerce .widget_price_filter .price_slider_wrapper .ui-widget-content,.social-login-form .sl-input-submit:hover{background-color: #07c;}
        .entry-tag a:hover,.entry-tag a:focus,.entry-action .btn-zan:hover,.entry-action .btn-dashang:hover,.entry-action .btn-zan.liked,.widget .tagcloud a:hover,.load-more:hover,.login-modal-body .btn-login:hover,.login-modal-body .btn-register:hover{border-color: #07c;}
        .special-item-bottom a:hover:before{border-left-color: #07c;}
        .list.tabs .tab.active a:hover{border-bottom-color: #07c;}
        @media (max-width: 991px){
            .header .navbar-nav>li.active>a,.header .navbar-nav .dropdown-menu .active a,.header .navbar-nav .dropdown-menu .active .dropdown-menu .active a{color: #08c;}
            .navbar-collapse{background-color: #08c;}
            .dropdown-menu>li a{border-color: #07c;}
            .header .navbar-nav>li.active>a:hover,.header .navbar-nav>li a:hover,.header .navbar-nav .dropdown-menu .active a:hover,.header .navbar-nav .dropdown-menu .active .dropdown-menu a:hover,.header .navbar-nav .dropdown-menu li a:hover{color: #07c;}
        }
        .j-share{position: fixed!important;top: 50%!important;}
                .header .logo img{max-height: 32px;}
                @media (max-width: 767px){
            .header .logo img{max-height: 26px;}
        }
                        .btn-post{
    display: block;
    margin: 0 auto;
    padding: 15px 20px;
    font-size: 16px;
    text-align: center;
    color: #fff !important;
    line-height: 1;
    background: #1471CA;
    -webkit-border-radius: 3px;
    border-radius: 3px;
    text-decoration: none;
    border: 0;
    outline: 0;
}    </style>
    <script> (function() {if (!/*@cc_on!@*/0) return;var e = "abbr, article, aside, audio, canvas, datalist, details, dialog, eventsource, figure, footer, header, hgroup, mark, menu, meter, nav, output, progress, section, time, video".split(', ');var i= e.length; while (i--){ document.createElement(e[i]) } })()</script>
    <!--[if lte IE 8]><script src="http://www.mottoin.com/wp-content/themes/JustNews/js/respond.min.js"></script><![endif]-->
</head>
<body class="post-template-default single single-post postid-95981 single-format-standard">
<header class="header">
    <div class="container clearfix">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar icon-bar-1"></span>
                <span class="icon-bar icon-bar-2"></span>
                <span class="icon-bar icon-bar-3"></span>
            </button>
            <a class="logo" href="http://www.mottoin.com"><img src="http://www.mottoin.com/img/mottoin/logo.png" alt="MottoIN"></a>
        </div>
        <div class="collapse navbar-collapse">
            <nav class="navbar-left primary-menu"><ul id="menu-%e5%af%bc%e8%88%aa" class="nav navbar-nav"><li class="menu-item menu-item-home"><a href="http://www.mottoin.com/">首页</a></li>
<li class="menu-item"><a href="http://www.mottoin.com/category/news">资讯</a></li>
<li class="menu-item current-post-ancestor dropdown"><a href="http://www.mottoin.com/category/article" class="dropdown-toggle">文章</a>
<ul role="menu" class=" dropdown-menu">
	<li class="menu-item"><a href="http://www.mottoin.com/category/article/web">Web安全</a></li>
	<li class="menu-item"><a href="http://www.mottoin.com/category/article/system">系统安全</a></li>
	<li class="menu-item"><a href="http://www.mottoin.com/category/article/network">网络安全</a></li>
	<li class="menu-item"><a href="http://www.mottoin.com/category/article/terminal">终端安全</a></li>
	<li class="menu-item"><a href="http://www.mottoin.com/category/article/database">数据安全</a></li>
	<li class="menu-item"><a href="http://www.mottoin.com/category/article/wireless">无线安全</a></li>
	<li class="menu-item"><a href="http://www.mottoin.com/category/article/social">社会工程</a></li>
	<li class="menu-item"><a href="http://www.mottoin.com/category/article/intranet">内网渗透</a></li>
	<li class="menu-item"><a href="http://www.mottoin.com/category/article/code">代码审计</a></li>
	<li class="menu-item current-post-ancestor current-menu-parent current-post-parent"><a href="http://www.mottoin.com/category/article/reverse">逆向破解</a></li>
</ul>
</li>
<li class="menu-item"><a href="http://www.mottoin.com/category/tools">工具</a></li>
<li class="menu-item"><a href="http://www.mottoin.com/category/geek">极客</a></li>
<li class="menu-item dropdown"><a href="http://www.mottoin.com/category/sole" class="dropdown-toggle">独家</a>
<ul role="menu" class=" dropdown-menu">
	<li class="menu-item"><a href="http://www.mottoin.com/category/sole/topic">专题</a></li>
	<li class="menu-item"><a href="http://www.mottoin.com/category/sole/people">人物</a></li>
	<li class="menu-item"><a href="http://www.mottoin.com/category/sole/view">观点</a></li>
	<li class="menu-item"><a href="http://www.mottoin.com/category/sole/events">活动</a></li>
	<li class="menu-item"><a href="http://www.mottoin.com/category/sole/video">视频</a></li>
</ul>
</li>
<li class="menu-item"><a href="http://www.mottoin.com/category/hr">招聘</a></li>
<li class="menu-item"><a href="http://www.mottoin.com/forum">社区</a></li>
</ul></nav>            <div class="navbar-action pull-right">

                                    <form class="navbar-search" action="http://www.mottoin.com" method="get" role="search">
                        <input type="text" name="s" class="navbar-search-input" autocomplete="off" placeholder="输入关键词搜索..." value="">
                        <a class="navbar-search-icon j-navbar-search" href="javascript:;"></a>
                    </form>

                    
                    <div id="j-user-wrap">
                        <a class="login" href="http://www.mottoin.com/login">登录</a>
                        <a class="login" href="http://www.mottoin.com/register">注册</a>
                    </div>
                    <a class="publish" href="http://www.mottoin.com/post">
                        投稿</a>
                                                </div>
        </div><!-- /.navbar-collapse -->
    </div><!-- /.container -->
</header>
<div id="wrap">    <div class="main container">
        <div class="content">
                            <article id="post-95981" class="post-95981 post type-post status-publish format-standard has-post-thumbnail hentry category-1948 category-reverse tag-41">
                    <div class="entry">
                        <div class="entry-head">
                            <h1 class="entry-title">SMBv3远程拒绝服务(BSOD)漏洞分析</h1>
                            <div class="entry-info">
                                                                <a class="nickname" href="http://www.mottoin.com/user/k0shl/">K0shl</a>
                                <span class="dot">•</span>
                                <span>2017年2月14日</span>
                                <span class="dot">•</span>
                                <a href="http://www.mottoin.com/category/%e6%bc%8f%e6%b4%9e%e5%88%86%e6%9e%90" rel="category tag">漏洞分析</a>, <a href="http://www.mottoin.com/category/article/reverse" rel="category tag">逆向破解</a>                                                                    <span class="dot">•</span>
                                    <span>阅读 506</span>
                                                            </div>
                        </div>
                                                                        <div class="entry-content clearfix">
                            <h2>前言</h2>
<p>我是菜鸟，大牛轻喷……</p>
<p>这个SMBv3漏洞是由lgandx爆出的一个未被微软修复的漏洞（暂未发布补丁），漏洞出来后我进行了一定的分析，花了很多时间，这个漏洞有一些意思，但是对于SMB的整个协议通信过程非常庞大，所以没有进行非常细致的跟踪，包括一些不透明的结构体让我感到晕头转向，但到最后还是有了一些结果。</p>
<p>这个SMB漏洞可以看作是被动的，需要用户主动去访问445端口才可以触发，而不像ms08067一样主动攻击别人，所以需要运行漏洞脚本在操作系统上。</p>
<p>终于赶在元宵节这天完成了这个任务，也在这里，祝大家元宵节快乐（不知道文章发布的时候过没过元宵节23333）！</p>
<p>这个漏洞在twitter爆出来之后，很多老外也在微博下面问是否可以RCE，包括国内的预警中也有人问到。</p>
<p><a href="http://bobao.360.cn/learning/detail/3451.html">http://bobao.360.cn/learning/detail/3451.html</a></p>
<p><a href="http://www.freebuf.com/vuls/126100.html">http://www.freebuf.com/vuls/126100.html</a></p>
<p>那么很多人看到PoC中的关键部分，就会想：有填充数据，会不会是缓冲区溢出！</p>
<pre class=" language-c"> ## Tree Connect
<span class="token keyword">if</span> data<span class="token punctuation">[</span><span class="token number">16</span><span class="token punctuation">:</span><span class="token number">18</span><span class="token punctuation">]</span> <span class="token operator">==</span> <span class="token string">"\x03\x00"</span><span class="token punctuation">:</span>  
head <span class="token operator">=</span> <span class="token function">SMBv2Header<span class="token punctuation">(</span></span>Cmd<span class="token operator">=</span><span class="token string">"\x03\x00"</span><span class="token punctuation">,</span> MessageId<span class="token operator">=</span><span class="token function">GrabMessageID<span class="token punctuation">(</span></span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> PID<span class="token operator">=</span><span class="token string">"\xff\xfe\x00\x00"</span><span class="token punctuation">,</span> TID<span class="token operator">=</span><span class="token string">"\x01\x00\x00\x00"</span><span class="token punctuation">,</span> CreditCharge<span class="token operator">=</span><span class="token function">GrabCreditCharged<span class="token punctuation">(</span></span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> Credits<span class="token operator">=</span><span class="token function">GrabCreditRequested<span class="token punctuation">(</span></span>data<span class="token punctuation">)</span><span class="token punctuation">,</span> NTStatus<span class="token operator">=</span><span class="token string">"\x00\x00\x00\x00"</span><span class="token punctuation">,</span> SessionID<span class="token operator">=</span><span class="token function">GrabSessionID<span class="token punctuation">(</span></span>data<span class="token punctuation">)</span><span class="token punctuation">)</span>  
t <span class="token operator">=</span> <span class="token function">SMB2TreeData<span class="token punctuation">(</span></span>Data<span class="token operator">=</span><span class="token string">"C"</span><span class="token operator">*</span><span class="token number">1500</span><span class="token punctuation">)</span><span class="token comment" spellcheck="true">#//BUG  
</span>packet1 <span class="token operator">=</span> <span class="token function">str<span class="token punctuation">(</span></span>head<span class="token punctuation">)</span><span class="token operator">+</span><span class="token function">str<span class="token punctuation">(</span></span>t<span class="token punctuation">)</span>  
buffer1 <span class="token operator">=</span> <span class="token function">longueur<span class="token punctuation">(</span></span>packet1<span class="token punctuation">)</span><span class="token operator">+</span>packet1  
print <span class="token string">"[*]Triggering Bug; Tree Connect SMBv2 packet sent."</span>  
self<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">send<span class="token punctuation">(</span></span>buffer1<span class="token punctuation">)</span>  
data <span class="token operator">=</span> self<span class="token punctuation">.</span>request<span class="token punctuation">.</span><span class="token function">recv<span class="token punctuation">(</span></span><span class="token number">1024</span><span class="token punctuation">)</span></pre>
<p>答案是否定的，至少在我看来，大量的数据目的并非是为了填充缓冲区，而是为了绕过tcpip.sys的某处判断，从而进入漏洞出发的函数调用逻辑。</p>
<p>问题出现在smbv2后的一个特性Tree Connect，用来处理共享服务的特性，opcode：0x03，而整个问题，确是多个地方导致的。下面我们就一起来进入今天的旅程吧！</p>
<p>Github地址：<a href="https://github.com/lgandx/PoC/tree/master/SMBv3%20Tree%20Connect">https://github.com/lgandx/PoC/tree/master/SMBv3%20Tree%20Connect</a></p>
<h2>漏洞复现</h2>
<p>首先，网上关于这个漏洞的触发方法有很多，比较通用的是twitter中某老外提到的Powershell的方法，最为简单，首先我们调试的环境是：Windows 10 x64 build 1607</p>
<p><img class="alignnone size-full wp-image-95985 j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/02/1-2.png" alt="1-2" width="1018" height="777" data-srcset="http://www.mottoin.com/wp-content/uploads/2017/02/1-2.png 1018w, http://www.mottoin.com/wp-content/uploads/2017/02/1-2-300x229.png 300w, http://www.mottoin.com/wp-content/uploads/2017/02/1-2-768x586.png 768w" sizes="(max-width: 1018px) 100vw, 1018px" /></p>
<p>接下来我们在kali2.0里运行漏洞脚本。</p>
<p><img class="alignnone size-full wp-image-95986 j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/02/2-3.png" alt="2-3" width="612" height="228" data-srcset="http://www.mottoin.com/wp-content/uploads/2017/02/2-3.png 612w, http://www.mottoin.com/wp-content/uploads/2017/02/2-3-300x112.png 300w" sizes="(max-width: 612px) 100vw, 612px" /></p>
<p>随后执行&#8221;dir \ip\PATH&#8221;，漏洞触发，通过windbg双机联调，此时捕捉到了BSOD。</p>
<p><img class="alignnone size-full wp-image-95987 j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/02/3-1.png" alt="3-1" width="817" height="569" data-srcset="http://www.mottoin.com/wp-content/uploads/2017/02/3-1.png 817w, http://www.mottoin.com/wp-content/uploads/2017/02/3-1-300x209.png 300w, http://www.mottoin.com/wp-content/uploads/2017/02/3-1-768x535.png 768w" sizes="(max-width: 817px) 100vw, 817px" /></p>
<p>可以看到提示此时问题出现在mrxsmb20.sys中，问题函数是Smb2ValidateNegotiateInfo，来看一下触发位置的代码</p>
<pre> kd&gt; p

mrxsmb20!Smb2ValidateNegotiateInfo+0x17:

fffff803`1869c7d7 66394114        cmp     word ptr [rcx+14h],ax  
kd&gt; r rcx  
rcx=0x00000000`00000000</pre>
<p>此时rcx的值为0x0，是一处无效地址，因此这是由于空指针引用导致的BSOD，接下来继续执行可以看到Windows 10引发蓝屏。</p>
<p><img class="alignnone size-full wp-image-95988 j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/02/4-1.png" alt="4-1" width="1005" height="761" data-srcset="http://www.mottoin.com/wp-content/uploads/2017/02/4-1.png 1005w, http://www.mottoin.com/wp-content/uploads/2017/02/4-1-300x227.png 300w, http://www.mottoin.com/wp-content/uploads/2017/02/4-1-768x582.png 768w" sizes="(max-width: 1005px) 100vw, 1005px" /></p>
<h2 id="important">回溯及数据包分析(important!)</h2>
<p>我们来看一下mrxsmb20.sys关于Tree Connect特性的一些内容，代码逻辑相对简单。</p>
<p><img class="alignnone size-full wp-image-95989 j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/02/5-1.png" alt="5-1" width="1252" height="771" data-srcset="http://www.mottoin.com/wp-content/uploads/2017/02/5-1.png 1252w, http://www.mottoin.com/wp-content/uploads/2017/02/5-1-300x185.png 300w, http://www.mottoin.com/wp-content/uploads/2017/02/5-1-768x473.png 768w, http://www.mottoin.com/wp-content/uploads/2017/02/5-1-1024x631.png 1024w" sizes="(max-width: 1252px) 100vw, 1252px" /></p>
<p>可以看到执行到Smb2ValidateNegotiateInfo函数有两条逻辑调用，一个是Smb2TreeConnect_CopyData，一个是Smb2TreeConnect_Receive，这里我就把我回溯的结果和大家分享一下，首先，通过Smb2TreeConnect_Receive来接收smb的Tree Connect数据，这个是通过opcode来决定的。</p>
<p>正常情况下不会进入Smb2TreeConnect_CopyData，但一旦由不正常（后面会提到）数据包执行，则会在Receive之后进入CopyData函数的处理逻辑，从而引发漏洞。</p>
<p>这里数据包分析很关键，因为在漏洞触发过程中，就是由于数据包的问题导致的。</p>
<p>来看一下Smb最关键的这个数据包。</p>
<p><img class="alignnone size-full wp-image-95990 j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/02/7-1.png" alt="7-1" width="940" height="944" data-srcset="http://www.mottoin.com/wp-content/uploads/2017/02/7-1.png 940w, http://www.mottoin.com/wp-content/uploads/2017/02/7-1-150x150.png 150w, http://www.mottoin.com/wp-content/uploads/2017/02/7-1-300x300.png 300w, http://www.mottoin.com/wp-content/uploads/2017/02/7-1-768x771.png 768w" sizes="(max-width: 940px) 100vw, 940px" /></p>
<p>来看一下Smb头部的协议格式。</p>
<p><img class="alignnone size-full wp-image-95991 j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/02/8-2.png" alt="8-2" width="646" height="658" data-srcset="http://www.mottoin.com/wp-content/uploads/2017/02/8-2.png 646w, http://www.mottoin.com/wp-content/uploads/2017/02/8-2-295x300.png 295w" sizes="(max-width: 646px) 100vw, 646px" /></p>
<p>在协议格式中Opcode指示smb类型</p>
<p><img class="alignnone size-full wp-image-95992 j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/02/9-1.png" alt="9-1" width="707" height="521" data-srcset="http://www.mottoin.com/wp-content/uploads/2017/02/9-1.png 707w, http://www.mottoin.com/wp-content/uploads/2017/02/9-1-300x221.png 300w" sizes="(max-width: 707px) 100vw, 707px" /></p>
<p>注意数据包中对应位置，opcode值是0x03，就是tree connect的处理。同时这里在后面分析中我们要用到，注意Data数据之前的长度。其中包含了NetBIOS Session Service 4字节，和 SMB2 Header ＋ Tree Connect Body 80字节，以及 Data n字节。这个非常重要，后续分析我们会用到。</p>
<h2>漏洞分析</h2>
<p>刚开始，我天真的以为是CopyData引发的某些异常，后来发现我错了，其实这个漏洞可以看成利用tcpip.sys中的某些逻辑特性，以及mrxsmb20.sys中对于相关结构的检查不够严格导致的空指针引用BSOD，而整个漏洞形成，我是利用正常和不正常的对比才终于发现。在分析的过程中，大量不透明的结构体引用让我有点尴尬，期待更熟悉SMB的大牛能够继续丰富分析。</p>
<p>正常的SMB2 Tree Connect包是不会触发异常的。</p>
<p><img class="alignnone size-full wp-image-95993 j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/02/10-1.png" alt="10-1" width="845" height="177" data-srcset="http://www.mottoin.com/wp-content/uploads/2017/02/10-1.png 845w, http://www.mottoin.com/wp-content/uploads/2017/02/10-1-300x63.png 300w, http://www.mottoin.com/wp-content/uploads/2017/02/10-1-768x161.png 768w" sizes="(max-width: 845px) 100vw, 845px" /></p>
<p>首先我们来看一下正常的逻辑调用，关键函数在tcpip.sys中的TcpDeliverDataToClient，这个函数负责处理接收到的数据包，在一个while(1)循环中。</p>
<pre class=" language-c"> <span class="token keyword">char</span> __fastcall <span class="token function">TcpDeliverDataToClient<span class="token punctuation">(</span></span>PKSPIN_LOCK SpinLock<span class="token punctuation">,</span> KSPIN_LOCK <span class="token operator">*</span>a2<span class="token punctuation">,</span> _QWORD <span class="token operator">*</span>a3<span class="token punctuation">,</span> _QWORD <span class="token operator">*</span><span class="token operator">*</span>a4<span class="token punctuation">)</span>

<span class="token punctuation">{</span>

 <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>

  <span class="token punctuation">{</span>

    ……

    v22 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span>vars30<span class="token punctuation">;</span>
    v23 <span class="token operator">=</span> <span class="token function">TcpIndicateData<span class="token punctuation">(</span></span>v7<span class="token punctuation">,</span> v6<span class="token punctuation">,</span> v5<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v72<span class="token punctuation">)</span><span class="token punctuation">;</span>
    v24 <span class="token operator">=</span> v71<span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token punctuation">(</span>v6<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">+</span> v6<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>

      <span class="token keyword">break</span><span class="token punctuation">;</span>
    ……</pre>
<p>在这个循环中，刚进入循环位置有一个if语句，后面我们会提到，在接收到TreeConnect包之后，不会进入if语句，而是执行下面的函数调用，在TcpIndicateData函数内部会调用到之前提到的Smb2TreeConnect_Receive，注意这一切现在都是在我们发送一个正常数据包时完成的。（接下来我们会分析到为什么是正常的）</p>
<p>在这个函数入口下条件断点。</p>
<pre> kd&gt; bp tcpip!TcpDeliverDataToClient ".if(poi(rbx+20)==0x1E4){;}.else{g;}"

kd&gt; g

tcpip!TcpDeliverDataToClient:

fffff801`f18017a0 4055            push    rbp

kd&gt; dd rbx+20 L1

ffffb304`06865c58  000001e4
</pre>
<p>命中时，rbx会存放一个结构体，这个结构体按照IDA的反馈来看是一个KSPIN_LOCK自旋锁，windows内核同步处理的一种机制，这个暂且不管，注意一下rbx结构体＋20位置的值，是1e4，这个值转换成10进制就是484，正好是我们发送的400个C的Data数据加刚才我们提到的头部84字节的长度。</p>
<p>接下来进入TcpIndicateData函数后会命中Smb2TreeConnect_Receive函数开始进行接收处理。</p>
<pre> kd&gt; p

tcpip!TcpDeliverDataToClient+0x209:

fffff801`f18019a9 e8e2810100      call    tcpip!TcpIndicateData (fffff801`f1819b90)

kd&gt; dd rbx

ffffb304`06865c38  aa9ce398 fffff801 00000000 00000000

ffffb304`06865c48  00000000 00000000 00000000 00000000

ffffb304`06865c58  000001e4 00000000 00000000 00000000

ffffb304`06865c68  00000000 00000000 00000000 00000000

ffffb304`06865c78  06865c60 ffffb304 00000000 00000000

ffffb304`06865c88  00000000 00000000 00000000 00000000

ffffb304`06865c98  00000000 00000000 00000000 00000000

ffffb304`06865ca8  00000000 00000000 00000000 00000001

kd&gt; p

Breakpoint 1 hit

mrxsmb20!Smb2TreeConnect_Receive:

fffff801`f3fbc4b0 48895c2420      mov     qword ptr [rsp+20h],rbx
</pre>
<p>处理过程很长，这里我直接略过，在处理结束后会多层ret后返回到TcpDeliverDataToClient函数中，仍然处于while循环中。</p>
<pre> kd&gt; bp tcpip!TcpIndicateData+0x268

kd&gt; g

Breakpoint 3 hit

tcpip!TcpIndicateData+0x268:

fffff80a`72c39df8 c3              ret

kd&gt; p

tcpip!TcpDeliverDataToClient+0x20e:

fffff80a`72c219ae 833defa51a0001  cmp     dword ptr [tcpip!MICROSOFT_TCPIP_PROVIDER_Context+0x24 (fffff80a`72dcbfa4)],1

kd&gt; p

tcpip!TcpDeliverDataToClient+0x215:

fffff80a`72c219b5 448bf0          mov     r14d,eax
</pre>
<p>这里我列举一下返回过程的逐层调用逻辑，因为kb回溯不到。Smb2TreeConnect_Receive -&gt; SmbReceiveInd -&gt; VctIndRecv -&gt; SmbWskReceiveEvent -&gt; afd!WskProTLEventReceive -&gt; tcpip!TcpIndicateData -&gt; tcpip!TcpDeliverDataToClient。</p>
<p>接下来就是关键了，首先会执行一处sub汇编指令。</p>
<pre> kd&gt; p

tcpip!TcpDeliverDataToClient+0x2b9:

fffff80a`72c21a59 48297b20        sub     qword ptr [rbx+20h],rdi

kd&gt; r rdi

rdi=00000000000001e4

kd&gt; dd rbx+20 L1

ffffc10c`9fe79e78  000001e4
</pre>
<p>这个相减之后，会将rbx结构体对应的长度变成0，随后，会到达一处cmp操作，这处cmp操作会将这个值作为一个判断条件。</p>
<pre> kd&gt; p

tcpip!TcpDeliverDataToClient+0x2de:

fffff80a`72c21a7e 4c896b48        mov     qword ptr [rbx+48h],r13

kd&gt; p

tcpip!TcpDeliverDataToClient+0x2e2:

fffff80a`72c21a82 488b4320        mov     rax,qword ptr [rbx+20h]

kd&gt; dd rbx+18 L1

ffffc10c`9fe79e70  00000000

kd&gt; dd rbx+20 L1

ffffc10c`9fe79e78  00000000

kd&gt; p

tcpip!TcpDeliverDataToClient+0x2e6:

fffff80a`72c21a86 48034318        add     rax,qword ptr [rbx+18h]

kd&gt; p

tcpip!TcpDeliverDataToClient+0x2ea:

fffff80a`72c21a8a 0f858dfeffff    jne     tcpip!TcpDeliverDataToClient+0x17d (fffff80a`72c2191d)

kd&gt; p

tcpip!TcpDeliverDataToClient+0x2f0:

fffff80a`72c21a90 48837e2000      cmp     qword ptr [rsi+20h],0
</pre>
<p>来看一下这一段伪代码。</p>
<pre class=" language-c"> <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>

  <span class="token punctuation">{</span>

      v70 <span class="token operator">=</span> v10<span class="token punctuation">;</span>

      v69 <span class="token operator">=</span> <span class="token function">TcpSatisfyReceiveRequests<span class="token punctuation">(</span></span>v7<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span> v24 &gt;<span class="token operator">=</span> v23 <span class="token punctuation">)</span>

    <span class="token punctuation">{</span>

    <span class="token punctuation">}</span>

        <span class="token keyword">else</span>

    <span class="token punctuation">{</span>

      v25 <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token keyword">char</span> <span class="token operator">*</span><span class="token punctuation">)</span>ReceiveDpcTable <span class="token operator">+</span> <span class="token number">24</span> <span class="token operator">*</span> v21<span class="token punctuation">;</span>

      v26 <span class="token operator">=</span> v23 <span class="token operator">-</span> v24<span class="token punctuation">;</span>

      v27 <span class="token operator">=</span> v7<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

      v70 <span class="token operator">=</span> v26<span class="token punctuation">;</span>

      <span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span><span class="token operator">*</span><span class="token punctuation">(</span>_QWORD <span class="token operator">*</span><span class="token punctuation">)</span><span class="token punctuation">(</span>v27 <span class="token operator">+</span> <span class="token number">128</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token punctuation">(</span>v21 <span class="token operator">&lt;</span><span class="token operator">&lt;</span> <span class="token number">7</span><span class="token punctuation">)</span> <span class="token operator">+</span> <span class="token number">56</span><span class="token punctuation">)</span> <span class="token operator">-</span><span class="token operator">=</span> v24<span class="token punctuation">;</span>

      v28 <span class="token operator">=</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span>v25 <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span> v28 <span class="token operator">&amp;</span> <span class="token number">1</span> <span class="token punctuation">)</span>

        <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span>v25 <span class="token operator">+</span> <span class="token number">5</span><span class="token punctuation">)</span> <span class="token operator">=</span> v28 <span class="token operator">|</span> <span class="token number">4</span><span class="token punctuation">;</span>

      <span class="token keyword">else</span>

        <span class="token function">TcpStartRcvWndTuningTimer<span class="token punctuation">(</span></span>vars38<span class="token punctuation">)</span><span class="token punctuation">;</span>

      v6<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span> <span class="token operator">-</span><span class="token operator">=</span> v26<span class="token punctuation">;</span>

      v29 <span class="token operator">=</span> v6<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

      v6<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">=</span> 0i64<span class="token punctuation">;</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span> v26 <span class="token operator">+</span> v29 <span class="token punctuation">)</span>

      <span class="token punctuation">{</span>

        <span class="token function">TcpAdvanceTcbRcvWnd<span class="token punctuation">(</span></span>v7<span class="token punctuation">,</span> <span class="token punctuation">(</span><span class="token keyword">unsigned</span> <span class="token keyword">int</span><span class="token punctuation">)</span><span class="token punctuation">(</span>v26 <span class="token operator">+</span> <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_DWORD <span class="token operator">*</span><span class="token punctuation">)</span>v6 <span class="token operator">+</span> <span class="token number">18</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

        v6<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">=</span> 0i64<span class="token punctuation">;</span>

      <span class="token punctuation">}</span>

      <span class="token keyword">else</span>

      <span class="token punctuation">{</span>

        v6<span class="token punctuation">[</span><span class="token number">9</span><span class="token punctuation">]</span> <span class="token operator">=</span> 0i64<span class="token punctuation">;</span>

      <span class="token punctuation">}</span>

    <span class="token punctuation">}</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token punctuation">(</span>v6<span class="token punctuation">[</span><span class="token number">3</span><span class="token punctuation">]</span> <span class="token operator">+</span> v6<span class="token punctuation">[</span><span class="token number">4</span><span class="token punctuation">]</span><span class="token punctuation">)</span> <span class="token punctuation">)</span>

      <span class="token keyword">break</span><span class="token punctuation">;</span>
</pre>
<p>在伪代码最后的位置，会对两个值进行判断，如果两个值之和为0，则条件成立，程序会跳出循环，刚才的跟踪我们可以发现，v6就是结构体，v6[4]的值来源于它自身减v26，而v26就是它自身，最后它的值为0，而刚才跟踪v6[3]的值也为0（如果知道结构体就好清楚v6到底是什么了T.T）。</p>
<p>经过对比调试，发现在正常的处理SMB Tree Connect包和触发BSOD的不正常情况下有一处关键的跳转逻辑，这里是一处if语句判断，成立则break跳出while循环，不成立，会继续执行。</p>
<p><img class="alignnone size-full wp-image-95994 j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/02/11-1.png" alt="11-1" width="975" height="347" data-srcset="http://www.mottoin.com/wp-content/uploads/2017/02/11-1.png 975w, http://www.mottoin.com/wp-content/uploads/2017/02/11-1-300x107.png 300w, http://www.mottoin.com/wp-content/uploads/2017/02/11-1-768x273.png 768w" sizes="(max-width: 975px) 100vw, 975px" /></p>
<p>那么不正常的情况呢？之前的处理和之前的分析一样，我们加大Data的值到1200，但是在返回后。</p>
<pre> kd&gt; p

tcpip!TcpDeliverDataToClient+0x2b9:

fffff80a`72c21a59 48297b20        sub     qword ptr [rbx+20h],rdi

kd&gt; r rdi

rdi=0000000000000404

kd&gt; dd rbx+20

ffffc10c`a0643e78  00000504
</pre>
<p>显而易见，在我们加大Data长度的时候，到相减位置结构体对应位置的值是504，也就是1284，正好是Data的长度1200字节 ＋ 刚才分析到的84字节，而此时rdi的值只有0x404，也就是944长度，这是一个Max值，如果Data长度超过0x404，这里会认为还有数据，因此相减后v6[4]的值不为0。</p>
<pre> kd&gt; p

tcpip!TcpDeliverDataToClient+0x2bd:

fffff80a`72c21a5d 4533ed          xor     r13d,r13d

kd&gt; dd rbx+20

ffffc10c`a0643e78  00000100
</pre>
<p>这造成了一个问题，就是刚才到的break位置由于v6[4]不为0，所以不执行break，而是进入后续的处理。</p>
<pre> kd&gt; p

tcpip!TcpDeliverDataToClient+0x2e2:

fffff80a`72c21a82 488b4320        mov     rax,qword ptr [rbx+20h]

kd&gt; p

tcpip!TcpDeliverDataToClient+0x2e6:

fffff80a`72c21a86 48034318        add     rax,qword ptr [rbx+18h]

kd&gt; p

tcpip!TcpDeliverDataToClient+0x2ea:

fffff80a`72c21a8a 0f858dfeffff    jne     tcpip!TcpDeliverDataToClient+0x17d (fffff80a`72c2191d)

kd&gt; p

tcpip!TcpDeliverDataToClient+0x17d:

fffff80a`72c2191d 49833f00        cmp     qword ptr [r15],0

kd&gt; p

tcpip!TcpDeliverDataToClient+0x181:

fffff80a`72c21921 0f85e9010000    jne     tcpip!TcpDeliverDataToClient+0x370 (fffff80a`72c21b10)
</pre>
<p>接下来，程序会回到while入口位置，接下来会进入之前提到没有进入的if语句处理，这是由于刚才没有break结束循环的原因，此时会进入if语句的处理，函数中所调用的函数都是Complete，猜测都是和结束数据包相关处理有关。</p>
<pre> kd&gt; p

tcpip!TcpDeliverDataToClient+0x1c1:

fffff80a`72c21961 e99bfeffff      jmp     tcpip!TcpDeliverDataToClient+0x61 (fffff80a`72c21801)

kd&gt; p

tcpip!TcpDeliverDataToClient+0x61:

fffff80a`72c21801 48837b0800      cmp     qword ptr [rbx+8],0

kd&gt; dd rbx+8

ffffc10c`a0643e60  9d8c2fa0 ffffc10c 9d8c2fa0 ffffc10c
</pre>
<p>来看一下这个if语句。</p>
<pre class=" language-c">   <span class="token keyword">while</span> <span class="token punctuation">(</span> <span class="token number">1</span> <span class="token punctuation">)</span>

  <span class="token punctuation">{</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span> v6<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token punctuation">)</span>

    <span class="token punctuation">{</span>

      <span class="token keyword">if</span> <span class="token punctuation">(</span> <span class="token operator">!</span><span class="token operator">*</span>v5 <span class="token punctuation">)</span>

        <span class="token keyword">break</span><span class="token punctuation">;</span>

      v9 <span class="token operator">=</span> v6<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

      v10 <span class="token operator">=</span> v6<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span><span class="token punctuation">;</span>

      <span class="token operator">*</span><span class="token punctuation">(</span><span class="token punctuation">(</span>_BYTE <span class="token operator">*</span><span class="token punctuation">)</span>v6 <span class="token operator">+</span> <span class="token number">98</span><span class="token punctuation">)</span> <span class="token operator">&amp;</span><span class="token operator">=</span> 0xFEu<span class="token punctuation">;</span>

      v69 <span class="token operator">=</span> v9<span class="token punctuation">;</span>

      v6<span class="token punctuation">[</span><span class="token number">1</span><span class="token punctuation">]</span> <span class="token operator">=</span> 0i64<span class="token punctuation">;</span>

      v6<span class="token punctuation">[</span><span class="token number">2</span><span class="token punctuation">]</span> <span class="token operator">=</span> 0i64<span class="token punctuation">;</span>

      v11 <span class="token operator">=</span> vars30<span class="token punctuation">;</span>

      v71 <span class="token operator">=</span> v10<span class="token punctuation">;</span>

      <span class="token function">LODWORD<span class="token punctuation">(</span></span>v12<span class="token punctuation">)</span> <span class="token operator">=</span> <span class="token function">TcpSatisfyReceiveRequests<span class="token punctuation">(</span></span>v7<span class="token punctuation">,</span> <span class="token number">0</span><span class="token punctuation">,</span> <span class="token punctuation">(</span>__int64<span class="token punctuation">)</span>v6<span class="token punctuation">,</span> vars30<span class="token punctuation">,</span> v5<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v69<span class="token punctuation">,</span> <span class="token operator">&amp;</span>v66<span class="token punctuation">)</span><span class="token punctuation">;</span>

     <span class="token punctuation">}</span>

   <span class="token punctuation">}</span>
</pre>
<p>在这个if语句中，会调用TcpSatisfyReceiveRequests函数，这个函数中第六个参数，也就是v69是很关键的，这个值决定了后面的空指针引用，接下来进入这个函数。</p>
<pre> int __fastcall TcpSatisfyReceiveRequests(PKSPIN_LOCK SpinLock, char a2, __int64 a3, signed int a4, __int64 *a5, __int64 *a6, _DWORD *a7)

{

      v8 = *a5;

  v95 = SpinLock;

  v9 = *a6;                                     // RBP+148

      v38 = *(_QWORD *)(v9 + 48);

      v39 = *(_QWORD *)(v9 + 56);

      v40 = *(_QWORD *)(v9 + 8);

      v41 = *(_QWORD *)(v9 + 72);

      v93 += v38;

      v99 += *(_QWORD *)(v9 + 40);

      v42 = *(_QWORD *)v9;

      _guard_dispatch_icall_fptr(v40, 0i64, v38, v39);// call WskProTLReceiveComplete
</pre>
<p>这个函数中的<em>guard</em>dispatch<em>icall</em>fptr调用了WskProTLreceiveComplete函数，而v40参数和v9结构体有关，v9是由传入第六个参数，也就是刚才提到的v69有关，v69又来自于v6[1]，而这个结构体是和Complete有关，但是在TreeConnect数据包中却没有对这个结构体进行赋值。</p>
<p>随后在WskProTLReceiveComplete中，会将rcx，也就是第一个参数v40，进行传递（64位Windows系统中，参数传递通过寄存器，第一个参数是rcx，第二个是rdx，第三个是r8，第四个是r9）。在后面的分析中，省略了无关的汇编过程，只留关键的给大家分享。</p>
<pre> kd&gt; p

afd!WskProTLReceiveComplete+0x34:

fffff80a`7365aa84 488bd9          mov     rbx,rcx  
…………
kd&gt; p

afd!WskProTLReceiveComplete+0x8e:

fffff80a`7365aade 488bcb          mov     rcx,rbx

kd&gt; r rbx

rbx=ffffc10ca01ba010  
kd&gt; p

afd!WskProTLReceiveComplete+0x91:

fffff80a`7365aae1 ff15512d0200    call    qword ptr [afd!_imp_IofCompleteRequest (fffff80a`7367d838)]
</pre>
<p>经过一系列传递后，这个第一个参数会直接传给IofCompleteRequest函数，这个函数是irp完成函数，其实是一个中间过程，同步irp完成，后面就是善后工作。</p>
<p>在函数中，参数继续传递。</p>
<pre> kd&gt; p

nt!IopfCompleteRequest+0xb:

fffff800`9464b81b 4881ec00010000  sub     rsp,100h

kd&gt; p

nt!IopfCompleteRequest+0x12:

fffff800`9464b822 488bd9          mov     rbx,rcx  
…………
kd&gt; p

nt!IopfCompleteRequest+0x109:

fffff800`9464b919 488bd3          mov     rdx,rbx

kd&gt; p

nt!IopfCompleteRequest+0x10c:

fffff800`9464b91c 488bce          mov     rcx,rsi

kd&gt; p

nt!IopfCompleteRequest+0x10f:

fffff800`9464b91f ff5735          call    qword ptr [rdi+35h]  
kd&gt; t

Breakpoint 0 hit

mrxsmb!SmbWskReceiveComplete:

fffff80a`731d6950 48895c2408      mov     qword ptr [rsp+8],rbx
</pre>
<p>在IofCompleteRequest函数中，会有一处调用回到SmWskReceivComplete函数，而结构体会交给rdx，也就是第二个参数进入这个函数。随后这个参数会连续传递。先来看一下之前的堆栈回溯。</p>
<pre> kd&gt; kb

RetAddr           : Args to Child                                                           : Call Site

fffff800`9464b922 : 00000000`00000000 00000000`00000000 00000000`00000000 00000000`00000000 : mrxsmb!SmbWskReceiveComplete

fffff80a`7365aae7 : 00000000`00000000 00000000`00000000 00000000`00000000 00000000`00000000 : nt!IopfCompleteRequest+0x112

fffff80a`72c60d9d : fffff800`963d54a8 ffffc10c`9ed02780 fffff800`963d54b0 fffff800`963d547c : afd!WskProTLReceiveComplete+0x97

fffff80a`72c21860 : 00000000`00000002 ffffc10c`a0643d00 00000000`00000007 00000000`00000000 : tcpip!TcpSatisfyReceiveRequests+0x3cd

00000000`00000000 : 00000000`00000000 00000000`00000000 00000000`00000000 00000000`00000000 : tcpip!TcpDeliverDataToClient+0xc0
</pre>
<p>之后参数会连续进行传递，首先会把当前rdx＋b8存放的值交给r14，之后把r14+40位置的值交给r8，最后引用的就是r8+98位置的值。</p>
<pre> kd&gt; p

mrxsmb!SmbWskReceiveComplete+0x1d:

fffff80a`731d696d 488bda          mov     rbx,rdx

kd&gt; p

mrxsmb!SmbWskReceiveComplete+0x20:

fffff80a`731d6970 4c8bb2b8000000  mov     r14,qword ptr [rdx+0B8h]  
…………
kd&gt; p

mrxsmb!SmbWskReceiveComplete+0x7f:

fffff80a`731d69cf 4d8b4640        mov     r8,qword ptr [r14+40h]//1

kd&gt; dd r14+40

ffffc10c`a01ba168  9fdf3c58 ffffc10c
</pre>
<p>可以看到，这个过程并没有对这个值进行检查，由于结构体不透明，不能确定到底对应存放的是什么，但其实这个结构体的连续调用我们可以理解为<em>KPCR -&gt;</em> KTHREAD -&gt; _EPROCESS -&gt; Token这种关系，在Windows内核有很多这样的域以及相关的结构体，而相互又是嵌套的。</p>
<p>这个结构体的值为0x0的原因可能就是由于这个complete部分的数据包是由于SMB Tree Connect过长引起的，而mrxsmb20.sys中却没有对相关结构体进行检查。</p>
<pre> kd&gt; p

mrxsmb!VctIndDataReady+0x36:

fffff80a`731d6a56 498bf8          mov     rdi,r8  
…………
kd&gt; p

mrxsmb!VctIndDataReady+0x146:

fffff80a`731d6b66 488bd7          mov     rdx,rdi

kd&gt; p

mrxsmb!VctIndDataReady+0x149:

fffff80a`731d6b69 488bcb          mov     rcx,rbx

kd&gt; p

mrxsmb!VctIndDataReady+0x14c:

fffff80a`731d6b6c ff15eeed0200    call    qword ptr [mrxsmb!_guard_dispatch_icall_fptr (fffff80a`73205960)]

kd&gt; r rdx

rdx=ffffc10c9fdf3c58

kd&gt; t

mrxsmb!guard_dispatch_icall_nop:

fffff80a`731d8a30 ffe0            jmp     rax

kd&gt; p

mrxsmb20!Smb2TreeConnect_CopyData:

fffff80a`7546b6c0 48895c2410      mov     qword ptr [rsp+10h],rbx
</pre>
<p>最后进入CopyData后，会引用这个结构体＋98偏移位置的值，进入漏洞触发的函数，而没有对这个值进行检查。</p>
<pre> kd&gt; p

mrxsmb20!Smb2TreeConnect_CopyData+0x32:

fffff80a`7546b6f2 488b8b98000000  mov     rcx,qword ptr [rbx+98h]

kd&gt; p

mrxsmb20!Smb2TreeConnect_CopyData+0x39:

fffff80a`7546b6f9 e8c210ffff      call    mrxsmb20!Smb2ValidateNegotiateInfo (fffff80a`7545c7c0)

kd&gt; dd rbx+98

ffffc10c`9fdf3cf0  00000000 00000000
</pre>
<p>最后在函数中引用空指针，引发了BSOD。</p>
<p>关于这个结构体的问题我还是比较在意的，希望未来能够更深入的分析SMB的各种机制，元宵快乐！新的一年，大家一起加油！谢谢大家！</p>
<p>&nbsp;</p>
<p style="text-align: center;"><span style="color: #ff0000;"><strong>*文章作者：<span style="color: #ff0000;"><a style="color: #ff0000;" href="http://whereisk0shl.top">k0shl</a></span>，MottoIN整理发布</strong></span></p>
                                                        <div class="entry-copyright"><p>原创文章，作者：k0shl，如若转载，请注明出处：http://www.mottoin.com/95981.html</p></div>                        </div>
                        <div class="entry-footer">
                            <div class="entry-tag"><a href="http://www.mottoin.com/tag/%e6%bc%8f%e6%b4%9e" rel="tag">漏洞</a></div>
                            <div class="entry-action">
                                <div class="btn-zan" data-id="95981"><i class="fa fa-thumbs-up"></i> 赞 <span class="entry-action-num">(0)</span></div>

                                
                            </div>
                            <div class="entry-bar">
                                <div class="entry-bar-inner clearfix">
                                                                            <div class="author pull-left">
                                            <a data-user="419" target="_blank" href="http://www.mottoin.com/user/k0shl/" class="avatar">
                                                <img src="http://gravatar.com/avatar/?s=400&d=mm" class="func-um_user gravatar avatar avatar-60 um-avatar um-avatar-gravatar" width="60" height="60" alt="K0shl" />                                                K0shl                                            </a>
                                            <span class="author-title">普通用户</span>                                         </div>
                                                                        <div class="info pull-right">
                                        <div class="info-item meta">
                                            <a class="meta-item j-heart" href="javascript:;" data-id="95981"><i class="fa fa-heart"></i> <span class="data">0</span></a>
                                            <a class="meta-item" href="#comments"><i class="fa fa-comment"></i> <span class="data">0</span></a>
                                                                                    </div>
                                        <div class="info-item share">
                                            <a class="meta-item" href="javascript:;">
                                                <i class="fa fa-wechat"></i>
                                                <span class="wx-wrap">
                                                    <img src="//pan.baidu.com/share/qrcode?w=320&h=320&url=http://www.mottoin.com/95981.html">
                                                    <span>扫码分享到微信</span>
                                                </span>
                                            </a>
                                            <a class="meta-item" href="http://share.baidu.com/s?type=text&searchPic=1&sign=on&to=tsina&key=&url=http%3A%2F%2Fwww.mottoin.com%2F95981.html&title=SMBv3%E8%BF%9C%E7%A8%8B%E6%8B%92%E7%BB%9D%E6%9C%8D%E5%8A%A1%28BSOD%29%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90" target="_blank"><i class="fa fa-weibo"></i></a>
                                            <a class="meta-item" href="http://share.baidu.com/s?type=text&searchPic=1&sign=on&to=qzone&key=&url=http%3A%2F%2Fwww.mottoin.com%2F95981.html&title=SMBv3%E8%BF%9C%E7%A8%8B%E6%8B%92%E7%BB%9D%E6%9C%8D%E5%8A%A1%28BSOD%29%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90" target="_blank"><i class="fa fa-qq"></i></a>
                                        </div>
                                        <div class="info-item act">
                                            <a href="javascript:;" id="j-reading"><i class="fa fa-file-text"></i></a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                                                        <h3 class="entry-related-title">相关推荐</h3><ul class="entry-related clearfix"><li><a href="http://www.mottoin.com/99237.html" title="漏洞分析：CVE-2017-0475 via ele7enxxh">漏洞分析：CVE-2017-0475 via ele7enxxh</a></li><li><a href="http://www.mottoin.com/84388.html" title="CVE-2016-4203分析：Adobe Acrobat和Reader 的CoolType处理导致的堆溢出漏洞">CVE-2016-4203分析：Adobe Acrobat和Reader 的CoolType处理导致的堆溢出漏洞</a></li><li><a href="http://www.mottoin.com/88578.html" title="逆向分享 – Reversing.Kr (2)">逆向分享 – Reversing.Kr (2)</a></li><li><a href="http://www.mottoin.com/87792.html" title="pwnable.kr ascii writeup">pwnable.kr ascii writeup</a></li><li><a href="http://www.mottoin.com/90073.html" title="2016 CFF reverse write-up">2016 CFF reverse write-up</a></li><li><a href="http://www.mottoin.com/100633.html" title="VIDEO CHARGE STUDIO缓冲区溢出漏洞">VIDEO CHARGE STUDIO缓冲区溢出漏洞</a></li><li><a href="http://www.mottoin.com/104594.html" title="“灵隐”木马黑吃灰：绑架数十款游戏外挂实现恶意推广">“灵隐”木马黑吃灰：绑架数十款游戏外挂实现恶意推广</a></li><li><a href="http://www.mottoin.com/91636.html" title="DRAKVUF：黑盒二进制分析平台">DRAKVUF：黑盒二进制分析平台</a></li><li><a href="http://www.mottoin.com/92530.html" title="iOS逆向：App脱壳/ipa破解">iOS逆向：App脱壳/ipa破解</a></li><li><a href="http://www.mottoin.com/87252.html" title="缓冲区溢出保护及绕过等等">缓冲区溢出保护及绕过等等</a></li></ul>                        </div>
                        
<div id="comments" class="entry-comments">
    	<div id="respond" class="comment-respond">
		<h3 id="reply-title" class="comment-reply-title">发表评论 <small><a rel="nofollow" id="cancel-comment-reply-link" href="/95981.html#respond" style="display:none;">取消回复</a></small></h3><div class="comment-form"><div class="comment-must-login">请登录后评论...</div><div class="form-submit"><div class="form-submit-text pull-left"><a href="http://www.mottoin.com/login">登录</a>后才能评论</div> <input name="submit" type="submit" id="must-submit" class="submit" value="发表"></div></div>	</div><!-- #respond -->
		</div><!-- .comments-area -->                    </div>
                </article>
                    </div>
        <aside class="sidebar">
            <div id="profile-3" class="widget widget_profile">                <div class="cover_photo"></div>
                        <div class="avatar-wrap">
                <a target="_blank" href="http://www.mottoin.com/user/k0shl/" class="avatar-link"><img src="http://gravatar.com/avatar/?s=400&d=mm" class="func-um_user gravatar avatar avatar-120 um-avatar um-avatar-gravatar" width="120" height="120" alt="K0shl" /></a></div>
            <div class="profile-info">
                <p><span class="author-name">K0shl</span><span class="author-title">普通用户</span></p>
                <p class="author-description"></p>
            </div>
            <div class="profile-posts">
                <h3 class="widget-title"><span>最近文章</span></h3>
                <ul>                    <li><a href="http://www.mottoin.com/101673.html" title="DESTINY MEDIA PLAYER 1.61 &#8216;M3U&#8217;文件格式缓冲区溢出漏洞">DESTINY MEDIA PLAYER 1.61 &#8216;M3U&#8217;文件格式缓冲区溢出漏洞</a></li>
                                    <li><a href="http://www.mottoin.com/101137.html" title="[CVE-2015-7547]GLIBC GETADDRINFO栈溢出漏洞">[CVE-2015-7547]GLIBC GETADDRINFO栈溢出漏洞</a></li>
                                    <li><a href="http://www.mottoin.com/100633.html" title="VIDEO CHARGE STUDIO缓冲区溢出漏洞">VIDEO CHARGE STUDIO缓冲区溢出漏洞</a></li>
                                    <li><a href="http://www.mottoin.com/99527.html" title="CVE-2017-7269 IIS6.0远程代码执行漏洞分析及Exploit">CVE-2017-7269 IIS6.0远程代码执行漏洞分析及Exploit</a></li>
                                    <li><a href="http://www.mottoin.com/98420.html" title="[CVE-2011-5165]FREE MP3 CD RIPPER本地代码执行漏洞">[CVE-2011-5165]FREE MP3 CD RIPPER本地代码执行漏洞</a></li>
                </ul>            </div>
            </div><div id="custom_html-3" class="widget_text widget widget_custom_html"><div class="textwidget custom-html-widget"><a class="btn-post" href="/question"><i class="fa fa-edit"></i> 我要提问</a></div></div><div id="post-thumb-3" class="widget widget_post_thumb">            <ul>
                                    <li class="item">
                                                    <div class="item-img">
                                <a href="http://www.mottoin.com/105921.html" title="“黑客反击”的合法化之争">
                                    <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/170918-Cox-The-Hackers-Hitting-Back-At-Cybercriminals-hero_vkcor5-480x300.gif" width="480" height="300" alt="“黑客反击”的合法化之争">                                </a>
                            </div>
                                                <div class="item-content">
                            <p class="item-title"><a href="http://www.mottoin.com/105921.html" title="“黑客反击”的合法化之争">“黑客反击”的合法化之争</a></p>
                            <p class="item-date">2017年9月20日</p>
                        </div>
                    </li>
                                    <li class="item">
                                                    <div class="item-img">
                                <a href="http://www.mottoin.com/105917.html" title="美参议员要求电信巨头们回应SS7信令系统的安全问题">
                                    <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG929-480x300.jpeg" width="480" height="300" alt="美参议员要求电信巨头们回应SS7信令系统的安全问题">                                </a>
                            </div>
                                                <div class="item-content">
                            <p class="item-title"><a href="http://www.mottoin.com/105917.html" title="美参议员要求电信巨头们回应SS7信令系统的安全问题">美参议员要求电信巨头们回应SS7信令系统的安全问题</a></p>
                            <p class="item-date">2017年9月19日</p>
                        </div>
                    </li>
                                    <li class="item">
                                                    <div class="item-img">
                                <a href="http://www.mottoin.com/105914.html" title="美国国土安全部发布禁止使用卡巴斯基产品的明细">
                                    <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG928-480x300.jpeg" width="480" height="300" alt="美国国土安全部发布禁止使用卡巴斯基产品的明细">                                </a>
                            </div>
                                                <div class="item-content">
                            <p class="item-title"><a href="http://www.mottoin.com/105914.html" title="美国国土安全部发布禁止使用卡巴斯基产品的明细">美国国土安全部发布禁止使用卡巴斯基产品的明细</a></p>
                            <p class="item-date">2017年9月19日</p>
                        </div>
                    </li>
                                    <li class="item">
                                                    <div class="item-img">
                                <a href="http://www.mottoin.com/105885.html" title="【威胁预警】供应链攻击：CCleaner 5.33官方下载被植入恶意代码（附技术详解）">
                                    <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG906-480x300.jpeg" width="480" height="300" alt="【威胁预警】供应链攻击：CCleaner 5.33官方下载被植入恶意代码（附技术详解）">                                </a>
                            </div>
                                                <div class="item-content">
                            <p class="item-title"><a href="http://www.mottoin.com/105885.html" title="【威胁预警】供应链攻击：CCleaner 5.33官方下载被植入恶意代码（附技术详解）">【威胁预警】供应链攻击：CCleaner 5.33官方下载被植入恶意代码（附技术详解）</a></p>
                            <p class="item-date">2017年9月19日</p>
                        </div>
                    </li>
                                    <li class="item">
                                                    <div class="item-img">
                                <a href="http://www.mottoin.com/105879.html" title="全球首款网络安全概念车驶入上海滩">
                                    <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/15057198871-480x300.png" width="480" height="300" alt="全球首款网络安全概念车驶入上海滩">                                </a>
                            </div>
                                                <div class="item-content">
                            <p class="item-title"><a href="http://www.mottoin.com/105879.html" title="全球首款网络安全概念车驶入上海滩">全球首款网络安全概念车驶入上海滩</a></p>
                            <p class="item-date">2017年9月18日</p>
                        </div>
                    </li>
                                    <li class="item">
                                                    <div class="item-img">
                                <a href="http://www.mottoin.com/105872.html" title="暗网市场上开始兜售Equifax的数据，数据泄漏后常见的诈骗招数1、2、3">
                                    <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG897-480x300.jpeg" width="480" height="300" alt="暗网市场上开始兜售Equifax的数据，数据泄漏后常见的诈骗招数1、2、3">                                </a>
                            </div>
                                                <div class="item-content">
                            <p class="item-title"><a href="http://www.mottoin.com/105872.html" title="暗网市场上开始兜售Equifax的数据，数据泄漏后常见的诈骗招数1、2、3">暗网市场上开始兜售Equifax的数据，数据泄漏后常见的诈骗招数1、2、3</a></p>
                            <p class="item-date">2017年9月18日</p>
                        </div>
                    </li>
                                    <li class="item">
                                                    <div class="item-img">
                                <a href="http://www.mottoin.com/105865.html" title="美国财政部确认伊朗11个实体的恶意网络活动，宣布对它们实施制裁">
                                    <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG896-480x300.jpeg" width="480" height="300" alt="美国财政部确认伊朗11个实体的恶意网络活动，宣布对它们实施制裁">                                </a>
                            </div>
                                                <div class="item-content">
                            <p class="item-title"><a href="http://www.mottoin.com/105865.html" title="美国财政部确认伊朗11个实体的恶意网络活动，宣布对它们实施制裁">美国财政部确认伊朗11个实体的恶意网络活动，宣布对它们实施制裁</a></p>
                            <p class="item-date">2017年9月18日</p>
                        </div>
                    </li>
                                    <li class="item">
                                                    <div class="item-img">
                                <a href="http://www.mottoin.com/105858.html" title="DHS称美国政府不能正确评估 WannaCry 和NotPetya的影响，对企业缺乏适当的保护">
                                    <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG150-480x300.jpeg" width="480" height="300" alt="DHS称美国政府不能正确评估 WannaCry 和NotPetya的影响，对企业缺乏适当的保护">                                </a>
                            </div>
                                                <div class="item-content">
                            <p class="item-title"><a href="http://www.mottoin.com/105858.html" title="DHS称美国政府不能正确评估 WannaCry 和NotPetya的影响，对企业缺乏适当的保护">DHS称美国政府不能正确评估 WannaCry 和NotPetya的影响，对企业缺乏适当的保护</a></p>
                            <p class="item-date">2017年9月17日</p>
                        </div>
                    </li>
                                    <li class="item">
                                                    <div class="item-img">
                                <a href="http://www.mottoin.com/105847.html" title="国家网络安全周开幕 大安全时代360前沿“黑科技”震撼登场">
                                    <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG141-480x300.jpeg" width="480" height="300" alt="国家网络安全周开幕 大安全时代360前沿“黑科技”震撼登场">                                </a>
                            </div>
                                                <div class="item-content">
                            <p class="item-title"><a href="http://www.mottoin.com/105847.html" title="国家网络安全周开幕 大安全时代360前沿“黑科技”震撼登场">国家网络安全周开幕 大安全时代360前沿“黑科技”震撼登场</a></p>
                            <p class="item-date">2017年9月16日</p>
                        </div>
                    </li>
                                    <li class="item">
                                                    <div class="item-img">
                                <a href="http://www.mottoin.com/105837.html" title="黑客组织OurMine窃取Vevo约3.12TB数据，疑似后者已妥协">
                                    <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG132-480x300.jpeg" width="480" height="300" alt="黑客组织OurMine窃取Vevo约3.12TB数据，疑似后者已妥协">                                </a>
                            </div>
                                                <div class="item-content">
                            <p class="item-title"><a href="http://www.mottoin.com/105837.html" title="黑客组织OurMine窃取Vevo约3.12TB数据，疑似后者已妥协">黑客组织OurMine窃取Vevo约3.12TB数据，疑似后者已妥协</a></p>
                            <p class="item-date">2017年9月16日</p>
                        </div>
                    </li>
                            </ul>
        </div><div id="lastest-products-4" class="widget widget_lastest_products">            <ul class="p-list clearfix">
                                    <li class="col-xs-12 col-md-6 p-item">
                        <div class="p-item-wrap">
                            <a class="thumb" href="http://www.mottoin.com/105921.html">
                                <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/170918-Cox-The-Hackers-Hitting-Back-At-Cybercriminals-hero_vkcor5-480x300.gif" width="480" height="300" alt="“黑客反击”的合法化之争">                            </a>
                            <h4 class="title">
                                <a href="http://www.mottoin.com/105921.html" title="“黑客反击”的合法化之争">
                                    “黑客反击”的合法化之争                                </a>
                            </h4>
                        </div>
                    </li>
                                    <li class="col-xs-12 col-md-6 p-item">
                        <div class="p-item-wrap">
                            <a class="thumb" href="http://www.mottoin.com/105858.html">
                                <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG150-480x300.jpeg" width="480" height="300" alt="DHS称美国政府不能正确评估 WannaCry 和NotPetya的影响，对企业缺乏适当的保护">                            </a>
                            <h4 class="title">
                                <a href="http://www.mottoin.com/105858.html" title="DHS称美国政府不能正确评估 WannaCry 和NotPetya的影响，对企业缺乏适当的保护">
                                    DHS称美国政府不能正确评估 WannaCry 和NotPetya的影响，对企业缺乏适当的保护                                </a>
                            </h4>
                        </div>
                    </li>
                                    <li class="col-xs-12 col-md-6 p-item">
                        <div class="p-item-wrap">
                            <a class="thumb" href="http://www.mottoin.com/105847.html">
                                <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG141-480x300.jpeg" width="480" height="300" alt="国家网络安全周开幕 大安全时代360前沿“黑科技”震撼登场">                            </a>
                            <h4 class="title">
                                <a href="http://www.mottoin.com/105847.html" title="国家网络安全周开幕 大安全时代360前沿“黑科技”震撼登场">
                                    国家网络安全周开幕 大安全时代360前沿“黑科技”震撼登场                                </a>
                            </h4>
                        </div>
                    </li>
                                    <li class="col-xs-12 col-md-6 p-item">
                        <div class="p-item-wrap">
                            <a class="thumb" href="http://www.mottoin.com/105799.html">
                                <img width="480" height="300" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" class="attachment-post-thumbnail size-post-thumbnail j-lazy wp-post-image" alt="暗网系列之：“入店行窃者”的工具、战术和克星" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/15054708381-150x150-480x300.png" />                            </a>
                            <h4 class="title">
                                <a href="http://www.mottoin.com/105799.html" title="暗网系列之：“入店行窃者”的工具、战术和克星">
                                    暗网系列之：“入店行窃者”的工具、战术和克星                                </a>
                            </h4>
                        </div>
                    </li>
                                    <li class="col-xs-12 col-md-6 p-item">
                        <div class="p-item-wrap">
                            <a class="thumb" href="http://www.mottoin.com/105703.html">
                                <img width="480" height="300" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" class="attachment-post-thumbnail size-post-thumbnail j-lazy wp-post-image" alt="【现场还原】补天漏洞情报发布会记事" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG82-150x150-480x300.jpeg" />                            </a>
                            <h4 class="title">
                                <a href="http://www.mottoin.com/105703.html" title="【现场还原】补天漏洞情报发布会记事">
                                    【现场还原】补天漏洞情报发布会记事                                </a>
                            </h4>
                        </div>
                    </li>
                                    <li class="col-xs-12 col-md-6 p-item">
                        <div class="p-item-wrap">
                            <a class="thumb" href="http://www.mottoin.com/105692.html">
                                <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG75-480x300.jpeg" width="480" height="300" alt="SyScan360看点回顾：中美德俄等七国黑客专家神技大比拼">                            </a>
                            <h4 class="title">
                                <a href="http://www.mottoin.com/105692.html" title="SyScan360看点回顾：中美德俄等七国黑客专家神技大比拼">
                                    SyScan360看点回顾：中美德俄等七国黑客专家神技大比拼                                </a>
                            </h4>
                        </div>
                    </li>
                                    <li class="col-xs-12 col-md-6 p-item">
                        <div class="p-item-wrap">
                            <a class="thumb" href="http://www.mottoin.com/105642.html">
                                <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG58-480x300.jpeg" width="480" height="300" alt="大安全时代序幕开启！ 中国互联网安全大会重新定义网络安全">                            </a>
                            <h4 class="title">
                                <a href="http://www.mottoin.com/105642.html" title="大安全时代序幕开启！ 中国互联网安全大会重新定义网络安全">
                                    大安全时代序幕开启！ 中国互联网安全大会重新定义网络安全                                </a>
                            </h4>
                        </div>
                    </li>
                                    <li class="col-xs-12 col-md-6 p-item">
                        <div class="p-item-wrap">
                            <a class="thumb" href="http://www.mottoin.com/105621.html">
                                <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG512-480x300.jpeg" width="480" height="300" alt="【重磅推出】ISC大会补天漏洞情报服务发布会：英雄，你准备好了吗？">                            </a>
                            <h4 class="title">
                                <a href="http://www.mottoin.com/105621.html" title="【重磅推出】ISC大会补天漏洞情报服务发布会：英雄，你准备好了吗？">
                                    【重磅推出】ISC大会补天漏洞情报服务发布会：英雄，你准备好了吗？                                </a>
                            </h4>
                        </div>
                    </li>
                                    <li class="col-xs-12 col-md-6 p-item">
                        <div class="p-item-wrap">
                            <a class="thumb" href="http://www.mottoin.com/105629.html">
                                <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG49-480x300.jpeg" width="480" height="300" alt="ISC直击：360守护者计划登陆ISC 最强白帽挑战黑客马拉松大奖赛">                            </a>
                            <h4 class="title">
                                <a href="http://www.mottoin.com/105629.html" title="ISC直击：360守护者计划登陆ISC 最强白帽挑战黑客马拉松大奖赛">
                                    ISC直击：360守护者计划登陆ISC 最强白帽挑战黑客马拉松大奖赛                                </a>
                            </h4>
                        </div>
                    </li>
                                    <li class="col-xs-12 col-md-6 p-item">
                        <div class="p-item-wrap">
                            <a class="thumb" href="http://www.mottoin.com/105603.html">
                                <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG42-480x300.jpeg" width="480" height="300" alt="【ISC2017精彩剪辑】周鸿祎：大安全时代 网络空间防御刻不容缓">                            </a>
                            <h4 class="title">
                                <a href="http://www.mottoin.com/105603.html" title="【ISC2017精彩剪辑】周鸿祎：大安全时代 网络空间防御刻不容缓">
                                    【ISC2017精彩剪辑】周鸿祎：大安全时代 网络空间防御刻不容缓                                </a>
                            </h4>
                        </div>
                    </li>
                            </ul>
        </div>        </aside>
    </div>
<div class="modal" id="login-modal">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
                <h4 class="modal-title">请登录</h4>
            </div>
            <div class="modal-body login-modal-body">
                <p>您还未登录，请登录后再进行相关操作！</p>
                <div class="login-btn">
                    <a class="btn btn-login" href="http://www.mottoin.com/login">登 录</a>
                    <a class="btn btn-register" href="http://www.mottoin.com/register">注 册</a>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
<footer class="footer">
    <div class="container">
        <div class="clearfix">
                        <div class="footer-col footer-col-logo">
                <img src="http://www.mottoin.com/img/mottoin/tmxk.png" alt="MottoIN">
            </div>
                        <div class="footer-col footer-col-copy">
                <ul class="footer-nav hidden-xs"><li id="menu-item-104182" class="menu-item menu-item-104182"><a href="http://www.mottoin.com/about">关于我们</a></li>
<li id="menu-item-104181" class="menu-item menu-item-104181"><a href="http://www.mottoin.com/dis">免责声明</a></li>
<li id="menu-item-104183" class="menu-item menu-item-104183"><a href="http://www.mottoin.com/joinus">加入我们</a></li>
<li id="menu-item-105509" class="menu-item menu-item-105509"><a href="http://www.mottoin.com/contact">联系我们</a></li>
<li id="menu-item-104184" class="menu-item menu-item-104184"><a href="http://www.mottoin.com/report">寻求报道</a></li>
<li id="menu-item-104185" class="menu-item menu-item-104185"><a href="http://www.mottoin.com/contribute">我要投稿</a></li>
</ul>                <div class="copyright">
                    Copyright © 2017 MottoIN 版权所有 <a href="http://www.miibeian.gov.cn/">沪ICP备16010654号-5</a>  <img class="alignnone " src="http://www.mottoin.com/img/mottoin/ga.png" width="16" height="16" /> <a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=31010402001331">沪公网安备31010402001331号</a>                 </div>
            </div>
            <div class="footer-col footer-col-sns">
                <div class="footer-sns">
                                                                                    <a class="sns-wx" href="javascript:;">
                            <i class="fa fa-weixin"></i>
                            <span style="background-image:url(http://www.mottoin.com/img/mottoin/weixin.jpg);"></span>
                        </a>
                                                                <a target="_blank" href="http://weibo.com/mottoin" rel="nofollow"><i class="fa fa-weibo"></i></a>
                                                                <a target="_blank" href="http://weibo.com/mottoin" rel="nofollow"><i class="fa fa-tencent-weibo"></i></a>
                                                                                                                                                                                </div>
            </div>
        </div>
    </div>
</footer>
<div class="action" style="top:50%;">
            <div class="a-box contact">
            <div class="contact-wrap">
                <h3 class="contact-title">联系我们</h3>
                <h4 style="text-align: center;"><span style="color: #2d6ded;"><strong>021-62666911</strong></span></h4>
<p>在线咨询：<a href="http://wpa.qq.com/msgrd?uin=19539638" target="_blank" rel="noopener"><img class="alignnone" title="点击这里给我发消息" src="http://wpa.qq.com/pa?p=2:1666839010:51" alt="点击这里给我发消息" border="0" /></a></p>
<p>邮件：root@mottoin.com</p>
<p>工作时间：周一至周五，9:30-18:30，节假日休息</p>
            </div>
        </div>
                <div class="a-box wechat">
            <div class="wechat-wrap">
                <img src="http://www.mottoin.com/img/mottoin/weixin.jpg" alt="QR code">
            </div>
        </div>
            <div class="a-box gotop" id="j-top" style="display: none;"></div>
</div>
<style>.footer{padding-bottom: 35px;}</style><div id="um_upload_single" style="display:none">
	
</div><div id="um_view_photo" style="display:none">

	<a href="#" data-action="um_remove_modal" class="um-modal-close"><i class="um-faicon-times"></i></a>
	
	<div class="um-modal-body photo">
	
		<div class="um-modal-photo">

		</div>

	</div>
	
</div><script type='text/javascript'>
/* <![CDATA[ */
var _wpcom_js = {"ajaxurl":"http:\/\/www.mottoin.com\/wp-admin\/admin-ajax.php"};
/* ]]> */
</script>
<script type='text/javascript' src='http://www.mottoin.com/wp-content/themes/JustNews/js/main.js?ver=2.3.2'></script>
<script type='text/javascript' src='http://www.mottoin.com/wp-includes/js/comment-reply.min.js?ver=4.8.1'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var wpcom_qa_js = {"ajaxurl":"http:\/\/www.mottoin.com\/wp-admin\/admin-ajax.php","ajaxloading":"http:\/\/www.mottoin.com\/wp-content\/plugins\/wpcom-qa\/images\/loading.gif"};
/* ]]> */
</script>
<script type='text/javascript' src='http://www.mottoin.com/wp-content/plugins/wpcom-qa/js/scripts.min.js?ver=1.0'></script>
<script type='text/javascript' src='http://www.mottoin.com/wp-includes/js/imagesloaded.min.js?ver=3.2.0'></script>
<script type='text/javascript' src='http://www.mottoin.com/wp-includes/js/masonry.min.js?ver=3.3.2'></script>
<script type='text/javascript' src='http://www.mottoin.com/wp-includes/js/jquery/jquery.masonry.min.js?ver=3.1.2b'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var um_scripts = {"ajaxurl":"http:\/\/www.mottoin.com\/wp-admin\/admin-ajax.php","fileupload":"http:\/\/www.mottoin.com\/wp-content\/plugins\/ultimate-member\/core\/lib\/upload\/um-file-upload.php","imageupload":"http:\/\/www.mottoin.com\/wp-content\/plugins\/ultimate-member\/core\/lib\/upload\/um-image-upload.php"};
/* ]]> */
</script>
<script type='text/javascript' src='http://www.mottoin.com/wp-content/plugins/ultimate-member/assets/js/um.min.js?ver=10.3.88'></script>
<script type='text/javascript' src='http://www.mottoin.com/wp-content/plugins/ultimate-member/assets/js/pickadate/translations/zh_CN.js?ver=10.3.88'></script>
<script type='text/javascript' src='http://www.mottoin.com/wp-includes/js/wp-embed.min.js?ver=4.8.1'></script>

		<script type="text/javascript">jQuery( '#request' ).val( '' );</script>

	    <script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":["mshare","tsina","weixin","qzone","sqq","douban","fbook","twi","bdhome","tqq","tieba","mail","youdao","print"],"bdPic":"","bdStyle":"1","bdSize":"16"},"share":[{"tag" : "single", "bdSize" : 16}, {"tag" : "global","bdSize" : 16,bdPopupOffsetLeft:-227}],url:'http://www.mottoin.com/wp-content/themes/JustNews'};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://www.mottoin.com/wp-content/themes/JustNews/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>
</body>
</html>