<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1">
    <meta name="renderer" content="webkit">
    <meta name="viewport" content="initial-scale=1.0,user-scalable=no,maximum-scale=1,width=device-width">
    <title>360Vulcan：NSA黑客武器库之Eternalromance (永恒浪漫) 漏洞分析 | MottoIN</title>
    <link rel='dns-prefetch' href='//www.mottoin.com' />
<link rel='dns-prefetch' href='//s.w.org' />
<link rel="alternate" type="application/rss+xml" title="MottoIN &raquo; 360Vulcan：NSA黑客武器库之Eternalromance (永恒浪漫) 漏洞分析评论Feed" href="http://www.mottoin.com/101096.html/feed" />
<link rel='stylesheet' id='stylesheet-css'  href='http://www.mottoin.com/wp-content/themes/JustNews/css/style.css?ver=2.3.2' type='text/css' media='all' />
<link rel='stylesheet' id='wpcom-qa-css'  href='http://www.mottoin.com/wp-content/plugins/wpcom-qa/css/style.css?ver=1.0' type='text/css' media='all' />
<style id='wpcom-qa-inline-css' type='text/css'>

        .q-content .topic-tab,.q-content .q-answer .as-user,.q-content .q-answer .as-comment-name{color: #1471CA;}
        .q-content .q-topic-wrap a:hover,.q-content .q-answer .as-action a:hover,.q-content .topic-tab:hover{color:#0D62B3;}
        .q-content .put-top,.q-content .topic-tab.current-tab,.q-content .q-answer .as-submit .btn-submit,.q-content .q-answer .as-comments-submit,.q-content .q-add-header .btn-post,.q-content .q-pagination .current{background-color:#1471CA;}
        .q-content .q-answer .as-submit .btn-submit:hover,.q-content .q-answer .as-comments-submit:hover,.q-content .q-add-header .btn-post:hover,.q-content .topic-tab.current-tab:hover,.q-content .q-pagination a:hover{background-color:#0D62B3;}
        .q-content .q-answer .as-comments-input:focus{border-color: #1471CA;}
        
</style>
<link rel='stylesheet' id='um_minified-css'  href='http://www.mottoin.com/wp-content/plugins/ultimate-member/assets/css/um.min.css?ver=10.3.88' type='text/css' media='all' />
<script type='text/javascript' src='http://www.mottoin.com/wp-content/themes/JustNews/js/jquery.min.js?ver=1.12.4'></script>
<link rel="EditURI" type="application/rsd+xml" title="RSD" href="http://www.mottoin.com/xmlrpc.php?rsd" />
<link rel="wlwmanifest" type="application/wlwmanifest+xml" href="http://www.mottoin.com/wp-includes/wlwmanifest.xml" /> 
<link rel='prev' title='Drupal某模块漏洞影响数十万流行CMS网站' href='http://www.mottoin.com/101092.html' />
<link rel='next' title='安全相关的免费电子书集合' href='http://www.mottoin.com/101105.html' />
<link rel='shortlink' href='http://www.mottoin.com/?p=101096' />
<!--  WPCOM主题相关信息开始 -->
<meta name="applicable-device" content="pc,mobile">
<meta http-equiv="Cache-Control" content="no-transform">
<meta name="keywords" content="360,Eternalromance,NSA,pgboy,zhong sf,抓包,永恒浪漫">
<meta name="description" content="在ShadowBrokers公开的NSA黑客武器库中，Eternalromance(永恒浪漫)是影响Windows全平台的SMBv1漏洞攻击工具，现已被微软补丁MS17-010修复，WindowsXP和2003等不在微软支持期的系统版本没有补丁，相关用户可以下载使用360“NSA武器库免疫工具”对漏洞进行免疫，能够预防Eternalromance的攻击。360VulcanTeam的@pgboy19">
<!--  WPCOM主题相关信息结束 -->
 
		<script type="text/javascript">

		var ultimatemember_image_upload_url = 'http://www.mottoin.com/wp-content/plugins/ultimate-member/core/lib/upload/um-image-upload.php';
		var ultimatemember_file_upload_url = 'http://www.mottoin.com/wp-content/plugins/ultimate-member/core/lib/upload/um-file-upload.php';
		var ultimatemember_ajax_url = 'http://www.mottoin.com/wp-admin/admin-ajax.php';

		</script>

	
		<style type="text/css">.request_name { display: none !important; }</style>

	<link rel="icon" href="http://www.mottoin.com/wp-content/uploads/2016/12/cropped-Avatar-32x32.jpg" sizes="32x32" />
<link rel="icon" href="http://www.mottoin.com/wp-content/uploads/2016/12/cropped-Avatar-192x192.jpg" sizes="192x192" />
<link rel="apple-touch-icon-precomposed" href="http://www.mottoin.com/wp-content/uploads/2016/12/cropped-Avatar-180x180.jpg" />
<meta name="msapplication-TileImage" content="http://www.mottoin.com/wp-content/uploads/2016/12/cropped-Avatar-270x270.jpg" />
    <style>
                a,.sec-panel-head span,.list.tabs .tab.active a,.header .nav>li.active>a,.header .dropdown-menu>.active>a,.entry .entry-info .nickname,.entry-bar-inner .author-title,.entry-action .btn-zan,.entry-action .btn-dashang,.comment-body .nickname,.form-submit-text span,.widget_profile .author-title,.um .um-profile-body .um-item-meta a,.login-modal-body .btn-register{color: #08c;}
        .header .dropdown-menu>li>a:hover,.header .dropdown-menu>.active>a:hover,.header .dropdown-menu>.active>a:focus,.navbar-action .publish,.pagination .current,.flex-control-paging li a.flex-active,.form-submit .submit,.sidebar .widget_nav_menu ul li.current-menu-item a,.sidebar .widget_nav_menu ul li.current-post-parent a,.search-form input.submit,.action .contact-title,.pf-submit,.tagHandler ul.tagHandlerContainer li.tagItem,.login-modal-body .btn-login,.woocommerce a.button,.woocommerce button.button,.woocommerce input.button,.woocommerce a.button.alt,.woocommerce button.button.alt,.woocommerce input.button.alt,.woocommerce a.button.alt.disabled,.woocommerce a.button.alt.disabled:hover,.woocommerce a.button.alt:disabled,.woocommerce a.button.alt:disabled:hover,.woocommerce a.button.alt:disabled[disabled],.woocommerce a.button.alt:disabled[disabled]:hover,.woocommerce button.button.alt.disabled,.woocommerce button.button.alt.disabled:hover,.woocommerce button.button.alt:disabled,.woocommerce button.button.alt:disabled:hover,.woocommerce button.button.alt:disabled[disabled],.woocommerce button.button.alt:disabled[disabled]:hover,.woocommerce input.button.alt.disabled,.woocommerce input.button.alt.disabled:hover,.woocommerce input.button.alt:disabled,.woocommerce input.button.alt:disabled:hover,.woocommerce input.button.alt:disabled[disabled],.woocommerce input.button.alt:disabled[disabled]:hover,.woocommerce .widget_price_filter .ui-slider .ui-slider-handle,.woocommerce .widget_price_filter .ui-slider .ui-slider-range,.shopping-count,.social-login-form .sl-input-submit{background-color: #08c;}
        .entry .entry-content h3,.entry .entry-content .h3,.widget-title{border-left-color: #08c;}
        .entry-bar-inner .author-title,.entry-action .btn-zan,.entry-action .btn-dashang,.search-form input.keyword:focus,.widget_profile .author-title,.login-modal-body .btn-login,.login-modal-body .btn-register{border-color: #08c;}
        .entry-bar-inner .author-title:before,.widget_profile .author-title:before{border-right-color: #08c;}
        .list.tabs .tab.active a{border-bottom-color: #08c;}

        a:hover,.header .nav>li>a:hover,.header .nav>li.active>a,.navbar-action .login:hover,.navbar-action .login:focus,.navbar-action .profile a:hover,.navbar-search-icon:hover,.navbar-search-icon:focus,.entry .entry-info a:hover,.entry .entry-info a:focus,.entry-bar .info-item a:hover,.p-item-wrap:hover .title a,.special-item-title a:hover,.special-item-bottom a:hover,.widget ul a:hover,.widget ol a:hover,.sec-panel-head .more:hover,.topic-list .topic-wrap:hover span,.tabs .tab a:hover,
        .article-list .item-title a:hover,.article-list .item-meta a:hover,.article-list .item-meta a:focus,.list-links a:hover,.list-links a:focus,.um .um-profile-body .um-item-meta a:hover,.um .um-profile-body .um-item-link a:hover,.load-more:hover,.login-modal-body .btn-register:hover{color: #07c;}
        .navbar-action .publish:hover,.navbar-action .publish:focus,.entry-tag a:hover,.entry-tag a:focus,.entry-action .btn-zan:hover,.entry-action .btn-dashang:hover,.entry-action .btn-zan.liked,.pagination a:hover,.flex-control-paging li a:hover,.form-submit .submit:hover,.widget .tagcloud a:hover,.sidebar .widget_nav_menu ul li.current-menu-item .sub-menu a:hover,.sidebar .widget_nav_menu ul li.current-post-parent .sub-menu a:hover,.sidebar .widget_nav_menu ul li a:hover,.search-form input.submit:hover,.action .a-box:hover,.footer-sns .fa:after,.article-list .item-category:hover,.pf-submit:hover,.tagHandler ul.tagHandlerContainer li.tagItem:hover,.login-modal-body .btn-login:hover,.woocommerce a.button:hover,.woocommerce button.button:hover,.woocommerce input.button:hover,.woocommerce a.button.alt:hover,.woocommerce button.button.alt:hover,.woocommerce input.button.alt:hover,.woocommerce .widget_price_filter .price_slider_wrapper .ui-widget-content,.social-login-form .sl-input-submit:hover{background-color: #07c;}
        .entry-tag a:hover,.entry-tag a:focus,.entry-action .btn-zan:hover,.entry-action .btn-dashang:hover,.entry-action .btn-zan.liked,.widget .tagcloud a:hover,.load-more:hover,.login-modal-body .btn-login:hover,.login-modal-body .btn-register:hover{border-color: #07c;}
        .special-item-bottom a:hover:before{border-left-color: #07c;}
        .list.tabs .tab.active a:hover{border-bottom-color: #07c;}
        @media (max-width: 991px){
            .header .navbar-nav>li.active>a,.header .navbar-nav .dropdown-menu .active a,.header .navbar-nav .dropdown-menu .active .dropdown-menu .active a{color: #08c;}
            .navbar-collapse{background-color: #08c;}
            .dropdown-menu>li a{border-color: #07c;}
            .header .navbar-nav>li.active>a:hover,.header .navbar-nav>li a:hover,.header .navbar-nav .dropdown-menu .active a:hover,.header .navbar-nav .dropdown-menu .active .dropdown-menu a:hover,.header .navbar-nav .dropdown-menu li a:hover{color: #07c;}
        }
        .j-share{position: fixed!important;top: 50%!important;}
                .header .logo img{max-height: 32px;}
                @media (max-width: 767px){
            .header .logo img{max-height: 26px;}
        }
                        .btn-post{
    display: block;
    margin: 0 auto;
    padding: 15px 20px;
    font-size: 16px;
    text-align: center;
    color: #fff !important;
    line-height: 1;
    background: #1471CA;
    -webkit-border-radius: 3px;
    border-radius: 3px;
    text-decoration: none;
    border: 0;
    outline: 0;
}    </style>
    <script> (function() {if (!/*@cc_on!@*/0) return;var e = "abbr, article, aside, audio, canvas, datalist, details, dialog, eventsource, figure, footer, header, hgroup, mark, menu, meter, nav, output, progress, section, time, video".split(', ');var i= e.length; while (i--){ document.createElement(e[i]) } })()</script>
    <!--[if lte IE 8]><script src="http://www.mottoin.com/wp-content/themes/JustNews/js/respond.min.js"></script><![endif]-->
</head>
<body class="post-template-default single single-post postid-101096 single-format-standard">
<header class="header">
    <div class="container clearfix">
        <div class="navbar-header">
            <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target=".navbar-collapse">
                <span class="icon-bar icon-bar-1"></span>
                <span class="icon-bar icon-bar-2"></span>
                <span class="icon-bar icon-bar-3"></span>
            </button>
            <a class="logo" href="http://www.mottoin.com"><img src="http://www.mottoin.com/img/mottoin/logo.png" alt="MottoIN"></a>
        </div>
        <div class="collapse navbar-collapse">
            <nav class="navbar-left primary-menu"><ul id="menu-%e5%af%bc%e8%88%aa" class="nav navbar-nav"><li class="menu-item menu-item-home"><a href="http://www.mottoin.com/">首页</a></li>
<li class="menu-item"><a href="http://www.mottoin.com/category/news">资讯</a></li>
<li class="menu-item current-post-ancestor dropdown"><a href="http://www.mottoin.com/category/article" class="dropdown-toggle">文章</a>
<ul role="menu" class=" dropdown-menu">
	<li class="menu-item"><a href="http://www.mottoin.com/category/article/web">Web安全</a></li>
	<li class="menu-item current-post-ancestor current-menu-parent current-post-parent"><a href="http://www.mottoin.com/category/article/system">系统安全</a></li>
	<li class="menu-item"><a href="http://www.mottoin.com/category/article/network">网络安全</a></li>
	<li class="menu-item"><a href="http://www.mottoin.com/category/article/terminal">终端安全</a></li>
	<li class="menu-item"><a href="http://www.mottoin.com/category/article/database">数据安全</a></li>
	<li class="menu-item"><a href="http://www.mottoin.com/category/article/wireless">无线安全</a></li>
	<li class="menu-item"><a href="http://www.mottoin.com/category/article/social">社会工程</a></li>
	<li class="menu-item"><a href="http://www.mottoin.com/category/article/intranet">内网渗透</a></li>
	<li class="menu-item"><a href="http://www.mottoin.com/category/article/code">代码审计</a></li>
	<li class="menu-item"><a href="http://www.mottoin.com/category/article/reverse">逆向破解</a></li>
</ul>
</li>
<li class="menu-item"><a href="http://www.mottoin.com/category/tools">工具</a></li>
<li class="menu-item"><a href="http://www.mottoin.com/category/geek">极客</a></li>
<li class="menu-item dropdown"><a href="http://www.mottoin.com/category/sole" class="dropdown-toggle">独家</a>
<ul role="menu" class=" dropdown-menu">
	<li class="menu-item"><a href="http://www.mottoin.com/category/sole/topic">专题</a></li>
	<li class="menu-item"><a href="http://www.mottoin.com/category/sole/people">人物</a></li>
	<li class="menu-item"><a href="http://www.mottoin.com/category/sole/view">观点</a></li>
	<li class="menu-item"><a href="http://www.mottoin.com/category/sole/events">活动</a></li>
	<li class="menu-item"><a href="http://www.mottoin.com/category/sole/video">视频</a></li>
</ul>
</li>
<li class="menu-item"><a href="http://www.mottoin.com/category/hr">招聘</a></li>
<li class="menu-item"><a href="http://www.mottoin.com/forum">社区</a></li>
</ul></nav>            <div class="navbar-action pull-right">

                                    <form class="navbar-search" action="http://www.mottoin.com" method="get" role="search">
                        <input type="text" name="s" class="navbar-search-input" autocomplete="off" placeholder="输入关键词搜索..." value="">
                        <a class="navbar-search-icon j-navbar-search" href="javascript:;"></a>
                    </form>

                    
                    <div id="j-user-wrap">
                        <a class="login" href="http://www.mottoin.com/login">登录</a>
                        <a class="login" href="http://www.mottoin.com/register">注册</a>
                    </div>
                    <a class="publish" href="http://www.mottoin.com/post">
                        投稿</a>
                                                </div>
        </div><!-- /.navbar-collapse -->
    </div><!-- /.container -->
</header>
<div id="wrap">    <div class="main container">
        <div class="content">
                            <article id="post-101096" class="post-101096 post type-post status-publish format-standard has-post-thumbnail hentry category-system tag-1437 tag-eternalromance tag-nsa tag-pgboy tag-zhong-sf tag-3380 tag-3379">
                    <div class="entry">
                        <div class="entry-head">
                            <h1 class="entry-title">360Vulcan：NSA黑客武器库之Eternalromance (永恒浪漫) 漏洞分析</h1>
                            <div class="entry-info">
                                                                <a class="nickname" href="http://www.mottoin.com/user/360/">360安全</a>
                                <span class="dot">•</span>
                                <span>2017年4月20日</span>
                                <span class="dot">•</span>
                                <a href="http://www.mottoin.com/category/article/system" rel="category tag">系统安全</a>                                                                    <span class="dot">•</span>
                                    <span>阅读 525</span>
                                                            </div>
                        </div>
                                                                        <div class="entry-content clearfix">
                            <p>在Shadow Brokers公开的NSA黑客武器库中，Eternalromance (永恒浪漫) 是影响Windows全平台的SMBv1漏洞攻击工具，现已被微软补丁MS17-010修复，Windows XP和2003等不在微软支持期的系统版本没有补丁，相关用户可以下载使用360“NSA武器库免疫工具”对漏洞进行免疫，能够预防Eternalromance的攻击。</p>
<p>360Vulcan Team的@pgboy1988和@zhong_sf对Eternalromance使用的漏洞进行了技术分析。zhong_sf对此漏洞进行了技术分析</p>
<h2 class="md-end-block md-heading md-focus">0x01 环境</h2>
<p><span class="md-line md-end-block"><span class=""><strong>EXPLOIT:</strong></span></span><span class="md-line md-end-block">Eternalromance-1.3.0</span></p>
<p><span class="md-line md-end-block"><span class=""><strong>TARGET:</strong></span></span><span class="md-line md-end-block">windows xp sp3</span></p>
<p><span class="md-line md-end-block"><span class=""><strong>FILE:</strong></span></span><span class="md-line md-end-block">srv.sys 5.1.2600.5512</span></p>
<h2 class="md-end-block md-heading">0x02 Exploit使用</h2>
<p>我们可以发现工具包中有两个Eternalromance, 一个1.4.0, 另外一个是1.3.0。经过我一翻折腾也没有把1.4.0跑起来。无奈试了下1.3.0发现竟然能成功运行。因此便有了这篇分析。大家可能都会用fuzzbunch这个命令行了。但是我们调试的时候总不能调一次都要重新输入TargetIp等那些配置吧。告诉大家一个省劲的方法。首先fuzzbunch按正常流程走一遍。在最后跑起exp的时候，在Log目录下会生成一个xml的配置文件。然后大家就可以用Eternalromance.1.3.0 –inconfig “xml路径” 来调用了。还有就是你也可以改exploit下的那个配置文件不过你得填非常多的参数。</p>
<h2 class="md-end-block md-heading">0x03 基础知识</h2>
<h3 class="md-end-block md-heading">3.1 SMB Message structure</h3>
<p><span class="md-line md-end-block">SMB Messages are divisible into three parts:</span></p>
<ul class="ul-list" data-mark="*">
<li><span class="md-line md-end-block">fixed-length header</span></li>
<li><span class="md-line md-end-block">variable length parameter block</span></li>
<li><span class="md-line md-end-block">variable length data block</span></li>
</ul>
<p><span class="md-line md-end-block">header的结构如下：</span></p>
<pre class="md-fences md-end-block" lang="cpp" contenteditable="false"> <span class="cm-variable">SMB_Header</span>
   {
   <span class="cm-variable">UCHAR</span>  <span class="cm-variable">Protocol</span>[<span class="cm-number">4</span>];
   <span class="cm-variable">UCHAR</span>  <span class="cm-variable">Command</span>;
   <span class="cm-variable">SMB_ERROR</span> <span class="cm-variable">Status</span>;
   <span class="cm-variable">UCHAR</span>  <span class="cm-variable">Flags</span>;
   <span class="cm-variable">USHORT</span> <span class="cm-variable">Flags2</span>;
   <span class="cm-variable">USHORT</span> <span class="cm-variable">PIDHigh</span>;
   <span class="cm-variable">UCHAR</span>  <span class="cm-variable">SecurityFeatures</span>[<span class="cm-number">8</span>];
   <span class="cm-variable">USHORT</span> <span class="cm-variable">Reserved</span>;
   <span class="cm-variable">USHORT</span> <span class="cm-variable">TID</span>;
   <span class="cm-variable">USHORT</span> <span class="cm-variable">PIDLow</span>;
   <span class="cm-variable">USHORT</span> <span class="cm-variable">UID</span>;
   <span class="cm-variable">USHORT</span> <span class="cm-variable">MID</span>;
   }</pre>
<p><span class="md-line md-end-block">更详细见 (<span spellcheck="false"><a href="https://msdn.microsoft.com/en-us/library/ee441702.aspx">https://msdn.microsoft.com/en-us/library/ee441702.aspx</a></span>)</span></p>
<h3 class="md-end-block md-heading">3.2 SMB_COM_TRANSACTION (0x25)</h3>
<p>为事务处理协议的传输子协议服务。这些命令可以用于CIFS文件系统内部通信的邮箱和命名管道。如果出书的数据超过了会话建立时规定的MaxBufferSize，必须使用SMB_COM_TRANSACTION_SECONDARY命令来传输超出的部分：SMB_Data.Trans_Data和SMB_Data.Trans_Parameter。这两部分在初始化消息中没有固定。<br />
如果客户端没有发送完所有的SMB_Data.Trans_Data，会将DataCount设置为小于TotalDataCount的一个值。同样的，如果SMB_Data.Trans_Parameters没有发送完，会设置ParameterCount为一个小于TotalParameterCount的值。参数部分优先级高于数据部分，客户端在每个消息中应该尽量多的发送数据。服务器应该可以接收无序到达的SMB_Data.Trans_Parameters 和 SMB_Data.Trans_Data，不论是大量还是少量的数据。<br />
在请求和响应消息中，SMB_Data.Trans_Parameters和SMB_Data.Trans_Data的位置和长度都是由SMB_Parameters.ParameterOffset、SMB_Parameters.ParameterCount,SMB_Parameters.DataOffset和SMB_Parameters.DataCount决定。另外需要说明的是，SMB_Parameters.ParameterDisplacement和SMB_Parameters.DataDisplacement可以用来改变发送数据段的序号。服务器应该优先发送SMB_Data.Trans_Parameters。客户端应该准备好组装收到的SMB_Data.Trans_Parameters和SMB_Data.Trans_Data，即使它们是乱序到达的。<br />
The PID, MID, TID, and UID MUST be the same for all requests and responses that are part of the same transaction.</p>
<p>更详细看 (<a href="https://msdn.microsoft.com/en-us/library/ee441489.aspx">https://msdn.microsoft.com/en-us/library/ee441489.aspx</a>)</p>
<h3 class="md-end-block md-heading">3.3 SMB_COM_TRANSACTION_SECONDARY(0x26)</h3>
<p>此命令用来完成SMB_COM_TRANSACTION中未传输完毕数据的传输。在请求和响应消息中，SMB_Data.Trans_Parameters和SMB_Data.Trans_Data的位置和长度都是由SMB_Parameters.ParameterOffset、SMB_Parameters.ParameterCount,SMB_Parameters.DataOffset和SMB_Parameters.DataCount决定。另外需要说明的是，SMB_Parameters.ParameterDisplacement和SMB_Parameters.DataDisplacement可以用来改变发送数据段的序号。服务器应该优先发送SMB_Data.Trans_Parameters。客户端应该准备好组装收到的SMB_Data.Trans_Parameters和SMB_Data.Trans_Data，即使它们是乱序到达的。</p>
<p><span class="md-line md-end-block">更详细看 (<span spellcheck="false"><a href="https://msdn.microsoft.com/en-us/library/ee441949.aspx">https://msdn.microsoft.com/en-us/library/ee441949.aspx</a></span>)</span></p>
<h3 class="md-end-block md-heading">3.4 SMB_COM_WRITE_ANDX (0x2F)</h3>
<p><span class="md-line md-end-block">结构如图：</span><span class="md-line md-end-block"><img class="alignnone size-full wp-image-101097 j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/04/andx.jpg" alt="andx" width="788" height="375" data-srcset="http://www.mottoin.com/wp-content/uploads/2017/04/andx.jpg 788w, http://www.mottoin.com/wp-content/uploads/2017/04/andx-300x143.jpg 300w, http://www.mottoin.com/wp-content/uploads/2017/04/andx-768x365.jpg 768w" sizes="(max-width: 788px) 100vw, 788px" /></span></p>
<p><span class="md-line md-end-block">更详细看 (<span spellcheck="false"><a href="https://msdn.microsoft.com/en-us/library/ee441848.aspx">https://msdn.microsoft.com/en-us/library/ee441848.aspx</a></span>)</span></p>
<h3 class="md-end-block md-heading">3.5 总结下漏洞相关的重点</h3>
<ol class="ol-list" start="">
<li><span class="md-line md-end-block">客户端处理SMB_COM_TRANSACTION命令的时候如果数据大小超过MaxBufferSize，则需要使用SMB_COM_TRANSACTION_SECONDARY传输剩下的数据。</span></li>
<li><span class="md-line md-end-block">对于作为同一Transcation部分的所有请求和响应，PID，MID，TID和UID必须相同。</span></li>
</ol>
<h2 class="md-end-block md-heading">0x04 漏洞分析</h2>
<h3 class="md-end-block md-heading">4.1 SrvSmbTransactionSecondary</h3>
<p><span class="md-line md-end-block">结合上一节的重点中提到的。</span><span class="md-line md-end-block">如果我们先发送了一个数据大小大于MaxBufferSize的SMB_COM_TRANSACTION数据包。那么接下来肯定是要发送SMB_COM_TRANSACTION_SECONDARY来传输剩余的数据，那么服务器在收到处理SMB_COM_TRANSACTION_SECONDARY这个命令的时候肯定会找他对应的那个Transcation。同时服务器也可能同时收到很多个包含SMB_COM_TRANSACTION_SECONDARY命令的数据包。怎么定位某个MB_COM_TRANSACTION_SECONDARY数据包对应的SMB_COM_TRANSACTION数据包呢？重点里也提到了。如果MB_COM_TRANSACTION_SECONDARY数据包中的PID,MID,TID和UID和SMB_COM_TRANSACTION数据包中的相同，那么就认为是同一部分的请求。</span><span class="md-line md-end-block">代码是这么实现的。</span></p>
<pre class="md-fences md-end-block" lang="cpp" contenteditable="false"><span class="cm-variable-3">int</span> <span class="cm-variable">__thiscall</span> <span class="cm-def">SrvSmbTransactionSecondary</span>(<span class="cm-variable-3">int</span> <span class="cm-keyword">this</span>)
{
  <span class="cm-variable-3">int</span> <span class="cm-variable">v1</span>; <span class="cm-comment">// ebx@1</span>
  <span class="cm-variable-3">int</span> <span class="cm-variable">pSmbParamter</span>; <span class="cm-comment">// edi@1</span>
  <span class="cm-variable">TRANSCATION</span> <span class="cm-operator">*</span><span class="cm-variable">pTransation</span>; <span class="cm-comment">// eax@1 MAPDST</span>
  <span class="cm-variable-3">unsigned</span> <span class="cm-variable-3">int</span> <span class="cm-variable">ParameterDisplayment</span>; <span class="cm-comment">// ecx@10 MAPDST</span>
  <span class="cm-variable-3">size_t</span> <span class="cm-variable">ParameterSize</span>; <span class="cm-comment">// eax@10 MAPDST</span>
  <span class="cm-variable-3">size_t</span> <span class="cm-variable">DataSize</span>; <span class="cm-comment">// edx@10 MAPDST</span>
  <span class="cm-variable-3">int</span> <span class="cm-variable">pTransList</span>; <span class="cm-comment">// [sp+Ch] [bp-24h]@1</span>
  <span class="cm-variable">PERESOURCE</span> <span class="cm-variable">Resource</span>; <span class="cm-comment">// [sp+18h] [bp-18h]@26</span>
  <span class="cm-keyword">struct</span> <span class="cm-def">_ERESOURCE</span> <span class="cm-operator">*</span><span class="cm-variable">Resourcea</span>; <span class="cm-comment">// [sp+18h] [bp-18h]@30</span>
  <span class="cm-variable-3">int</span> <span class="cm-variable">pSmbHeader</span>; <span class="cm-comment">// [sp+1Ch] [bp-14h]@1</span>
  <span class="cm-variable-3">int</span> <span class="cm-variable">ParameterOffset</span>; <span class="cm-comment">// [sp+20h] [bp-10h]@10</span>
  <span class="cm-variable-3">int</span> <span class="cm-variable">DataOffset</span>; <span class="cm-comment">// [sp+28h] [bp-8h]@10</span>

  <span class="cm-variable">v1</span> <span class="cm-operator">=</span> <span class="cm-keyword">this</span>;
  <span class="cm-variable">pSmbParamter</span> <span class="cm-operator">=</span> <span class="cm-operator">*</span>(<span class="cm-variable">_DWORD</span> <span class="cm-operator">*</span>)(<span class="cm-keyword">this</span> <span class="cm-operator">+</span> <span class="cm-number">0x6C</span>);
  <span class="cm-variable">pSmbHeader</span> <span class="cm-operator">=</span> <span class="cm-operator">*</span>(<span class="cm-variable">_DWORD</span> <span class="cm-operator">*</span>)(<span class="cm-keyword">this</span> <span class="cm-operator">+</span> <span class="cm-number">0x68</span>);
  <span class="cm-variable">pTransList</span> <span class="cm-operator">=</span> <span class="cm-operator">*</span>(<span class="cm-variable">_DWORD</span> <span class="cm-operator">*</span>)(<span class="cm-keyword">this</span> <span class="cm-operator">+</span> <span class="cm-number">0x4C</span>);
  
  <span class="cm-comment">//</span>
  <span class="cm-comment">// 首先查找SMB_COM_TRANSACTION_SECONDARY对应的SMB_COM_TRANSACTION</span>
  <span class="cm-comment">//</span>
  
  <span class="cm-variable">pTransation</span> <span class="cm-operator">=</span> (<span class="cm-variable">TRANSCATION</span> <span class="cm-operator">*</span>)<span class="cm-variable">SrvFindTransaction</span>(<span class="cm-variable">pTransList</span>, <span class="cm-variable">pSmbHeader</span>, <span class="cm-number">0</span>);
  <span class="cm-keyword">if</span> ( <span class="cm-operator">!</span><span class="cm-variable">pTransation</span> )
  {
    <span class="cm-keyword">return</span> <span class="cm-number">2</span>;
  }
  <span class="cm-keyword">if</span> ( <span class="cm-operator">!*</span>(<span class="cm-variable">_BYTE</span> <span class="cm-operator">*</span>)(<span class="cm-variable">pTransation</span><span class="cm-operator">-&gt;</span><span class="cm-variable">field_10</span> <span class="cm-operator">+</span> <span class="cm-number">0x98</span>) )
  {
    <span class="cm-variable">ParameterDisplayment</span> <span class="cm-operator">=</span> <span class="cm-operator">*</span>(<span class="cm-variable">_WORD</span> <span class="cm-operator">*</span>)(<span class="cm-variable">pSmbParamter</span> <span class="cm-operator">+</span> <span class="cm-number">9</span>);
    <span class="cm-variable">ParameterOffset</span> <span class="cm-operator">=</span> <span class="cm-operator">*</span>(<span class="cm-variable">_WORD</span> <span class="cm-operator">*</span>)(<span class="cm-variable">pSmbParamter</span> <span class="cm-operator">+</span> <span class="cm-number">7</span>);
    <span class="cm-variable">ParameterSize</span> <span class="cm-operator">=</span> <span class="cm-operator">*</span>(<span class="cm-variable">_WORD</span> <span class="cm-operator">*</span>)(<span class="cm-variable">pSmbParamter</span> <span class="cm-operator">+</span> <span class="cm-number">5</span>);
    <span class="cm-variable">DataOffset</span> <span class="cm-operator">=</span> <span class="cm-operator">*</span>(<span class="cm-variable">_WORD</span> <span class="cm-operator">*</span>)(<span class="cm-variable">pSmbParamter</span> <span class="cm-operator">+</span> <span class="cm-number">0xD</span>);
    <span class="cm-variable">DataSize</span> <span class="cm-operator">=</span> <span class="cm-operator">*</span>(<span class="cm-variable">_WORD</span> <span class="cm-operator">*</span>)(<span class="cm-variable">pSmbParamter</span> <span class="cm-operator">+</span> <span class="cm-number">0xB</span>);
    <span class="cm-variable">DataDisplayment</span> <span class="cm-operator">=</span> <span class="cm-operator">*</span>(<span class="cm-variable">_WORD</span> <span class="cm-operator">*</span>)(<span class="cm-variable">pSmbParamter</span> <span class="cm-operator">+</span> <span class="cm-number">0xF</span>);
    <span class="cm-keyword">if</span> ( <span class="cm-variable">pTransation</span><span class="cm-operator">-&gt;</span><span class="cm-variable">field_93</span> )
    {
        <span class="cm-comment">//...</span>
    }
    <span class="cm-keyword">else</span>
    {
      <span class="cm-comment">//Check</span>
      <span class="cm-variable">Resource</span> <span class="cm-operator">=</span> <span class="cm-operator">*</span>(<span class="cm-variable">PERESOURCE</span> <span class="cm-operator">*</span>)(<span class="cm-operator">*</span>(<span class="cm-variable">_DWORD</span> <span class="cm-operator">*</span>)(<span class="cm-variable">v1</span> <span class="cm-operator">+</span> <span class="cm-number">0x60</span>) <span class="cm-operator">+</span> <span class="cm-number">0x10</span>);
      <span class="cm-keyword">if</span> ( <span class="cm-variable">ParameterSize</span> <span class="cm-operator">+</span> <span class="cm-variable">ParameterOffset</span> <span class="cm-operator">&gt;</span> <span class="cm-operator">*</span>(<span class="cm-variable">_DWORD</span> <span class="cm-operator">*</span>)(<span class="cm-operator">*</span>(<span class="cm-variable">_DWORD</span> <span class="cm-operator">*</span>)(<span class="cm-variable">v1</span> <span class="cm-operator">+</span> <span class="cm-number">0x60</span>) <span class="cm-operator">+</span> <span class="cm-number">0x10</span>)
        <span class="cm-operator">||</span> <span class="cm-variable">DataOffset</span> <span class="cm-operator">+</span> <span class="cm-variable">DataSize</span> <span class="cm-operator">&gt;</span> (<span class="cm-variable-3">unsigned</span> <span class="cm-variable-3">int</span>)<span class="cm-variable">Resource</span>
        <span class="cm-operator">||</span> <span class="cm-variable">ParameterSize</span> <span class="cm-operator">+</span> <span class="cm-variable">ParameterDisplayment</span> <span class="cm-operator">&gt;</span> <span class="cm-variable">pTransation</span><span class="cm-operator">-&gt;</span><span class="cm-variable">TotalParameterCount</span>
        <span class="cm-operator">||</span> <span class="cm-variable">DataSize</span> <span class="cm-operator">+</span> <span class="cm-variable">DataDisplayment</span> <span class="cm-operator">&gt;</span> <span class="cm-variable">pTransation</span><span class="cm-operator">-&gt;</span><span class="cm-variable">TotalDataCount</span> )
      {
         <span class="cm-comment">//CheckFaild</span>
      }
      <span class="cm-keyword">else</span>
      {
        <span class="cm-keyword">if</span> ( <span class="cm-variable">pTransation</span><span class="cm-operator">-&gt;</span><span class="cm-variable">field_94</span> <span class="cm-operator">!=</span> <span class="cm-number">1</span> )
        {
          <span class="cm-comment">//</span>
          <span class="cm-comment">// 这里将SMB_COM_TRANSACTION_SECONDARY传过来的Parameter和Data都保存</span>
          <span class="cm-comment">// 到Transaction中</span>
          <span class="cm-comment">//</span>
          
          <span class="cm-comment">//拷贝Parameter Buffer</span>
          <span class="cm-keyword">if</span> ( <span class="cm-variable">ParameterSize</span> )
            <span class="cm-variable">_memmove</span>(
              (<span class="cm-variable-3">void</span> <span class="cm-variable-3">*</span>)(<span class="cm-variable">ParameterDisplayment</span> <span class="cm-operator">+</span> <span class="cm-variable">pTransation</span><span class="cm-operator">-&gt;</span><span class="cm-variable">ParameterBuffer</span>),
              (<span class="cm-keyword">const</span> <span class="cm-variable-3">void</span> <span class="cm-variable-3">*</span>)(<span class="cm-variable">pSmbHeader</span> <span class="cm-operator">+</span> <span class="cm-variable">ParameterOffset</span>),
              <span class="cm-variable">ParameterSize</span>);                   <span class="cm-comment">// parameter</span>
              
          <span class="cm-comment">//复制Data Buffer,这里注意下，下面会提到！！</span>
          <span class="cm-keyword">if</span> ( <span class="cm-variable">DataSize</span> )
            <span class="cm-variable">_memmove</span>(
              (<span class="cm-variable-3">void</span> <span class="cm-variable-3">*</span>)(<span class="cm-variable">DataDisplayment</span> <span class="cm-operator">+</span> <span class="cm-variable">pTransation</span><span class="cm-operator">-&gt;</span><span class="cm-variable">DataBuffer</span>),
              (<span class="cm-keyword">const</span> <span class="cm-variable-3">void</span> <span class="cm-variable-3">*</span>)(<span class="cm-variable">pSmbHeader</span> <span class="cm-operator">+</span> <span class="cm-variable">DataOffset</span>),
              <span class="cm-variable">DataSize</span>);                        <span class="cm-comment">// data</span>

          <span class="cm-keyword">return</span> <span class="cm-number">2</span>;
        }
      }
    }
  }
  <span class="cm-keyword">return</span> <span class="cm-number">1</span>;
}</pre>
<p><span class="md-line md-end-block">这个SMB_COM_TRANSACTION_SECONDARY命令的处理函数的大体流程就是首先查找SMB_COM_TRANSACTION_SECONDARY对应的SMB_COM_TRANSACTION如果找到就将SMB_COM_TRANSACTION_SECONDARY中的Parameter和Data都复制到SMB_COM_TRANSACTION中去。</span></p>
<h3 class="md-end-block md-heading">4.2 SrvFindTransaction</h3>
<p><span class="md-line md-end-block">下面来看下查找的逻辑<span spellcheck="false"><code>SrvFindTransaction</code></span>:</span></p>
<pre>int __stdcall SrvFindTransaction(int a1, int pSmbHeaderOrMid, int a3)
{
 SMB_HEADER *pSmbHeader_; // edi@1
 struct _ERESOURCE *v4; // ebx@4
 _DWORD **pTransList; // edx@4
 _DWORD *i; // ecx@4
 TRANSCATION *v7; // eax@5
 int v9; // esi@14

pSmbHeader_ = (SMB_HEADER *)pSmbHeaderOrMid;
 
 //
 // command 0x2f is SMB_CMD_WRITE_ANDX
 // a3 = SMB_CMD_WRITE_ANDX-&gt;Fid
 //
 
 if ( *(_BYTE *)(pSmbHeaderOrMid + 4) == 0x2F )
 pSmbHeaderOrMid = a3;
 else
 LOWORD(pSmbHeaderOrMid) = *(_WORD *)(pSmbHeaderOrMid + 0x1E);
 v4 = (struct _ERESOURCE *)(a1 + 0x130);
 ExAcquireResourceExclusiveLite((PERESOURCE)(a1 + 0x130), 1u);
 pTransList = (_DWORD **)(*(_DWORD *)(a1 + 0xF4) + 8);
 for ( i = *pTransList; ; i = (_DWORD *)*i )
 {
 if ( i == pTransList )
 {
 //
 // 查到最后了退出
 //
 
 ExReleaseResourceLite(v4);
 return 0;
 }
 
 //
 // 这里是对比TID，PID，UID,MID
 // 这里注意这个MID,如果命令是SMB_CMD_WRITE_ANDX MID就是SMB_CMD_WRITE_ANDX MID数据包中的Fid
 //
 
 v7 = (TRANSCATION *)(i - 6);
 if ( *((_WORD *)i + 47) == pSmbHeader_-&gt;TID
 &amp;&amp; v7-&gt;ProcessId == pSmbHeader_-&gt;PIDLow
 &amp;&amp; v7-&gt;UserId == pSmbHeader_-&gt;UID
 &amp;&amp; v7-&gt;MutiplexId == (_WORD)pSmbHeaderOrMid )// MutilplexId如果名令时SMB_CMD_WRITE_ANDX那么这里是Fid
 {
 break;
 }
 }
 if ( BYTE1(v7-&gt;field_0) == 2 )
 {
 _InterlockedExchangeAdd((volatile signed __int32 *)(v7-&gt;field_8 + 4), 1u);
 v9 = (int)(i - 6);
 }
 else
 {
 v9 = 0;
 }
 ExReleaseResourceLite(v4);
 return v9;
}</pre>
<p>大家可以看下逻辑。重点在这里如果命令是SMB_CMD_WRITE_ANDX(0x2f)话那么MID的对比就不一样了，这里是用Transaction-&gt;MID和SMB_CMD_WRITE_ANDX-&gt;Fid比较。如果一样返回pTransaction。那么问题来了。如果服务器端正好有一个其他的Transaction-&gt;MID恰好和SMB_CMD_WRITE_ANDX-&gt;Fid的相等那么将会返回一个错误的pTransaction。很经典的类型混淆。</p>
<p>处理SUM_CMD_WRITE_ANDX的函数SrvSmbWriteAndX代码如下:</p>
<pre>signed int __thiscall SrvSmbWriteAndX(int this)
{
 ...略
 pTrans = (TRANSCATION *)SrvFindTransaction(pTransList, pSmbTranscationBuffer, Fid);
 pTrans_ = pTrans;
 if ( !pTrans )
 {
 if ( (unsigned int)SrvWmiEnableLevel &gt;= 2 &amp;&amp; SrvWmiEnableFlags &amp; 1 &amp;&amp; KeGetCurrentIrql() &lt; 2u )
 WPP_SF_(64, &amp;unk_1E1CC);
 v40 = "d:\\xpsp\\base\\fs\\srv\\smbrdwrt.c";
 v37 = 3216;
 goto LABEL_69;
 }
 if ( pTrans-&gt;TotalDataCount - pTrans-&gt;nTransDataCounts &lt; v11 )
 {
 SrvCloseTransaction(pTrans);
 SrvDereferenceTransaction(pTrans_);
 _SrvSetSmbError2(v1, 0x80000005, 0, 3238, (int)"d:\\xpsp\\base\\fs\\srv\\smbrdwrt.c");
 StatusCode = 0x80000005;
 goto LABEL_100;
 }
 v31 = Size;
 qmemcpy((void *)pTrans-&gt;DataBuffer, VirtualAddress, Size);
 
 //
 // ！！！！这里将DataBuffer指针给增加了！！！！
 //
 
 pTrans_-&gt;DataBuffer += Size;
 pTrans_-&gt;nTransDataCounts += v31;
 ...略
}</pre>
<p>看到<code>pTrans_-&amp;gt;DataBuffer += Size</code>这句相信大家就能明白了。这里将DataBuffer的指针增大了。再处理此Transcation的SMB_COM_TRANSACTION_SECONDARY命令的时候也就是<strong>SrvSmbTransactionSecondary中复制Data的<code>memcpy</code>可就越界了！！！！！</strong><br />
所以此漏洞可以总结成类型混淆造成的越界写。</p>
<h3 class="md-end-block md-heading"><strong><b>4.3 Exploit数据包</b></strong></h3>
<p><span class="md-line md-end-block">通过对Exploit抓包我们可以看到其漏洞触发过程。</span></p>
<p><span class="md-line md-end-block">首先发送SMB_COM_TRANSACTION命令创建一个TID=2049 PID=0 UID=2049 MID=16385(0x4001)的Transcation：</span></p>
<p><span class="md-line md-end-block"><img class="alignnone size-full wp-image-101098 j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/04/wireshark.jpg" alt="wireshark" width="1150" height="789" data-srcset="http://www.mottoin.com/wp-content/uploads/2017/04/wireshark.jpg 1150w, http://www.mottoin.com/wp-content/uploads/2017/04/wireshark-300x206.jpg 300w, http://www.mottoin.com/wp-content/uploads/2017/04/wireshark-768x527.jpg 768w, http://www.mottoin.com/wp-content/uploads/2017/04/wireshark-1024x703.jpg 1024w, http://www.mottoin.com/wp-content/uploads/2017/04/wireshark-220x150.jpg 220w" sizes="(max-width: 1150px) 100vw, 1150px" /></span></p>
<p><span class="md-line md-end-block">然后发送SMB_CMD_WRITE_ANDX命令还增加<span spellcheck="false"><code>pTrans_-&gt;DataBuffer</code></span>这个指针：</span></p>
<p><span class="md-line md-end-block"><img class="alignnone size-full wp-image-101099 j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/04/wirshark1.png" alt="wirshark1" width="1393" height="521" data-srcset="http://www.mottoin.com/wp-content/uploads/2017/04/wirshark1.png 1393w, http://www.mottoin.com/wp-content/uploads/2017/04/wirshark1-300x112.png 300w, http://www.mottoin.com/wp-content/uploads/2017/04/wirshark1-768x287.png 768w, http://www.mottoin.com/wp-content/uploads/2017/04/wirshark1-1024x383.png 1024w" sizes="(max-width: 1393px) 100vw, 1393px" /></span></p>
<h2 class="md-end-block md-heading">0x05 漏洞利用</h2>
<p><span class="md-line md-end-block">从上面描述可以看出，该漏洞为类型混淆导致的越界写漏洞。前期通过spray 使多个TRANSACTION相邻，然后让其中一个TRANSACTION触发该漏洞，再通过该TRANSACTION越界写其相邻的TRANSACTION</span></p>
<p><span class="md-line md-end-block">spary 最终 memory view:</span><span class="md-line md-end-block"><img class="alignnone size-full wp-image-101100 j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/04/3.1-1.png" alt="3.1" width="939" height="183" data-srcset="http://www.mottoin.com/wp-content/uploads/2017/04/3.1-1.png 939w, http://www.mottoin.com/wp-content/uploads/2017/04/3.1-1-300x58.png 300w, http://www.mottoin.com/wp-content/uploads/2017/04/3.1-1-768x150.png 768w" sizes="(max-width: 939px) 100vw, 939px" /></span></p>
<p><span class="md-line md-end-block">spray的目的是构造出下出三个相邻的transaction, 其中<span spellcheck="false"><code>write_transaction</code></span> 主要用于写操作，leak_transaction 主要用于信息泄露，而<span spellcheck="false"><code>control_transaction</code></span>为触发漏洞的transaction,触发之后其他<span spellcheck="false"><code>InData</code></span>字段会增加0x200, 以致于可写的范围可以向后延伸0x200.利用于这点可以写与其相依的<span spellcheck="false"><code>write_transaction</code></span>的<span spellcheck="false"><code>InData</code></span>字段。从面达到任意地址写的效果。</span></p>
<p><span class="md-line md-end-block">注: 本次调试中 control_transaction地址为：0x58b90, write_transaction地址为: 0x59c38, leak_transaction地址为:0x5ace0</span></p>
<p><span class="md-line md-end-block">其中TRANSACTION 结构部份如下：</span></p>
<pre class="md-fences md-end-block" lang="c" contenteditable="false"><span class="cm-keyword">typedef</span> <span class="cm-keyword">struct</span> <span class="cm-def">_TRANSACTION</span> {
    <span class="cm-comment">//...</span>
    <span class="cm-comment">/*+0xc*/</span>     <span class="cm-variable">LPVOID</span> <span class="cm-variable">Connection</span>;
    <span class="cm-comment">//...</span>
    <span class="cm-comment">/*+0x34*/</span>    <span class="cm-variable">LPWORD</span> <span class="cm-variable">InSetup</span>;
    <span class="cm-comment">//...</span>
    <span class="cm-comment">/*+0x40*/</span>    <span class="cm-variable">LPBYTE</span> <span class="cm-variable">OutParameters</span>;
    <span class="cm-comment">/*+0x44*/</span>    <span class="cm-variable">LPBYTE</span> <span class="cm-variable">InData</span>; <span class="cm-comment">/*写的目的地址*/</span>
    <span class="cm-comment">/*+0x48*/</span>   <span class="cm-variable">LPBYTE</span> <span class="cm-variable">OutData</span>; <span class="cm-comment">/*读的目的地址*/</span>
    <span class="cm-comment">//...</span>
    <span class="cm-comment">/*+0x60*/</span>   <span class="cm-variable">DWORD</span> <span class="cm-variable">DataCount</span>; <span class="cm-comment">/*控制可读的长度*/</span>
    <span class="cm-comment">/*+0x64*/</span>   <span class="cm-variable">DWORD</span> <span class="cm-variable">TotalDataCount</span>
    }<span class="cm-variable">TRANSACTION</span></pre>
<p><span class="md-line md-end-block">写操作：</span></p>
<pre class="md-fences md-end-block" lang="c" contenteditable="false"><span class="cm-variable">SMB_PROCESSOR_RETURN_TYPE</span> <span class="cm-def">SrvSmbTransactionSecondary</span> (
    <span class="cm-variable">SMB_PROCESSOR_PARAMETERS</span>
    )
{
    <span class="cm-comment">//...</span>
    <span class="cm-variable">request</span> <span class="cm-operator">=</span> (<span class="cm-variable">PREQ_TRANSACTION_SECONDARY</span>)<span class="cm-variable">WorkContext</span><span class="cm-operator">-&gt;</span><span class="cm-variable">RequestParameters</span>;
    <span class="cm-variable">header</span> <span class="cm-operator">=</span> <span class="cm-variable">WorkContext</span><span class="cm-operator">-&gt;</span><span class="cm-variable">RequestHeader</span>;
    <span class="cm-variable">transaction</span> <span class="cm-operator">=</span> <span class="cm-variable">SrvFindTransaction</span>( <span class="cm-variable">connection</span>, <span class="cm-variable">header</span>, <span class="cm-number">0</span> );
    <span class="cm-comment">//...</span>
    <span class="cm-variable">dataOffset</span> <span class="cm-operator">=</span> <span class="cm-variable">SmbGetUshort</span>( <span class="cm-operator">&amp;</span><span class="cm-variable">request</span><span class="cm-operator">-&gt;</span><span class="cm-variable">DataOffset</span> );
    <span class="cm-variable">dataCount</span> <span class="cm-operator">=</span> <span class="cm-variable">SmbGetUshort</span>( <span class="cm-operator">&amp;</span><span class="cm-variable">request</span><span class="cm-operator">-&gt;</span><span class="cm-variable">DataCount</span> );
    <span class="cm-variable">dataDisplacement</span> <span class="cm-operator">=</span> <span class="cm-variable">SmbGetUshort</span>( <span class="cm-operator">&amp;</span><span class="cm-variable">request</span><span class="cm-operator">-&gt;</span><span class="cm-variable">DataDisplacement</span> );
    <span class="cm-comment">//...</span>

    <span class="cm-comment">// Copy the parameter and data bytes that arrived in this SMB.</span>
    <span class="cm-comment">//...</span>
    <span class="cm-keyword">if</span> ( <span class="cm-variable">dataCount</span> <span class="cm-operator">!=</span> <span class="cm-number">0</span> ) {
        <span class="cm-variable">RtlMoveMemory</span>(
            <span class="cm-variable">transaction</span><span class="cm-operator">-&gt;</span><span class="cm-variable">InData</span> <span class="cm-operator">+</span> <span class="cm-variable">dataDisplacement</span>,
            (<span class="cm-variable">PCHAR</span>)<span class="cm-variable">header</span> <span class="cm-operator">+</span> <span class="cm-variable">dataOffset</span>,
            <span class="cm-variable">dataCount</span>);
    }
    <span class="cm-comment">//...</span>
}</pre>
<p><span class="md-line md-end-block">读操作：</span></p>
<pre class="md-fences md-end-block" lang="" contenteditable="false">VOID SrvCompleteExecuteTransaction (
    IN OUT PWORK_CONTEXT WorkContext,
    IN SMB_TRANS_STATUS ResultStatus)
{
    //...
    transaction = WorkContext-&gt;Parameters.Transaction;
    header = WorkContext-&gt;ResponseHeader;
    transactionCommand = (UCHAR)SmbGetUshort( &amp;transaction-&gt;InSetup[0] );
    //...
    
        // Copy the appropriate parameter and data bytes into the message.
        if ( paramLength != 0 ) {
            RtlMoveMemory( paramPtr, transaction-&gt;OutParameters, paramLength );
        }

        if ( dataLength != 0 ) {
            RtlMoveMemory( dataPtr, transaction-&gt;OutData, dataLength );
        }
    //...
}</pre>
<p><span class="md-line md-end-block">从exp运行的log可以看出该漏洞利用分为两部份：信息泄露与代码执行</span></p>
<p><span class="md-line md-end-block"><img class="alignnone size-full wp-image-101101 j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/04/6-15.png" alt="6" width="572" height="308" data-srcset="http://www.mottoin.com/wp-content/uploads/2017/04/6-15.png 572w, http://www.mottoin.com/wp-content/uploads/2017/04/6-15-300x162.png 300w" sizes="(max-width: 572px) 100vw, 572px" /></span></p>
<h3 class="md-end-block md-heading">5.1 信息泄露</h3>
<p><span class="md-line md-end-block">需要泄露的信息包括 <span spellcheck="false"><code>Transaction2Dispatch</code></span> Table基址 与 一块NonePagedPool Buffer地址. 通过修改<span spellcheck="false"><code>Transaction2Dispatch</code></span> Table中的函数指针来执行 shellcode， 其中NonePagedPool Buffer就是用于存放shellcode.</span></p>
<h3 class="md-end-block md-heading">5.1.1 泄露Transaction2Dispatch Table基址</h3>
<p><span class="md-line md-end-block">从exp运行的log可以看出首先泄露CONNECTION结构基址：CONNECTION地址存放于<span spellcheck="false"><code>TRANSACTION-&gt;Connection</code></span>字段。看到这，你可能已经想到该怎么做了：直接利用<span spellcheck="false"><code>constrol transaction</code></span>的0x200字节的越界能力修改<span spellcheck="false"><code>write_transaction</code></span>的<span spellcheck="false"><code>DataCount</code></span>字段让其可以越界读<span spellcheck="false"><code>leak_transaction</code></span>上的内容，从而读出<span spellcheck="false"><code>TRANSACTION-&gt;Connection</code></span>。 但exp作者却并没有这么做，这里并不打算深究其原因，或许是有其他限制，或许不是。</span><span class="md-line md-end-block">作者这里利用了另一种复杂不少方法，通过另一种方法修改 <span spellcheck="false"><code>write_transaction</code></span>的<span spellcheck="false"><code>DataCount</code></span>字段。</span></p>
<h3 class="md-end-block md-heading">5.1.1.1 write_transaction初始状态如下:</h3>
<p><span class="md-line md-end-block"><img class="alignnone size-full wp-image-101102 j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/04/5-14.png" alt="5" width="452" height="180" data-srcset="http://www.mottoin.com/wp-content/uploads/2017/04/5-14.png 452w, http://www.mottoin.com/wp-content/uploads/2017/04/5-14-300x119.png 300w" sizes="(max-width: 452px) 100vw, 452px" /></span></p>
<p><span class="md-line md-end-block">可以看出CONNECTION地址为：<span spellcheck="false"><code>89a29c18</code></span>，<span spellcheck="false"><code>OutData为0x5acd4 (== 59c38+0x109c)</code></span>已经是<span spellcheck="false"><code>write_transaction</code></span>的末尾，所以其<span spellcheck="false"><code>DataCount</code></span>为0,表示不可读。</span></p>
<h3 class="md-end-block md-heading">5.1.1.2 修改write_transaction-&gt;DataCount</h3>
<p><span class="md-line md-end-block">首先 修改<span spellcheck="false"><code>write_transaction</code></span>的InSetup为0x23，这点通过<span spellcheck="false"><code>control_transaction</code></span>很容易完成。之后发包触发写<span spellcheck="false"><code>write_transaction</code></span>操作，会走到：</span></p>
<pre class="md-fences md-end-block" lang="c" contenteditable="false"><span class="cm-variable">SMB_STATUS</span> <span class="cm-variable">SRVFASTCALL</span> <span class="cm-def">ExecuteTransaction</span> (
    <span class="cm-variable">IN</span> <span class="cm-variable">OUT</span> <span class="cm-variable">PWORK_CONTEXT</span> <span class="cm-variable">WorkContext</span>)
{
    <span class="cm-comment">//...</span>
    <span class="cm-variable">transaction</span> <span class="cm-operator">=</span> <span class="cm-variable">WorkContext</span><span class="cm-operator">-&gt;</span><span class="cm-variable">Parameters</span>.<span class="cm-variable">Transaction</span>;
    <span class="cm-comment">//...</span>
            <span class="cm-variable">command</span> <span class="cm-operator">=</span> <span class="cm-variable">SmbGetUshort</span>(<span class="cm-operator">&amp;</span><span class="cm-variable">transaction</span><span class="cm-operator">-&gt;</span><span class="cm-variable">InSetup</span>[<span class="cm-number">0</span>]);
            <span class="cm-comment">//...</span>
            <span class="cm-keyword">switch</span>( <span class="cm-variable">command</span> ) {

            <span class="cm-keyword">case</span> <span class="cm-variable">TRANS_TRANSACT_NMPIPE</span>:
                <span class="cm-variable">resultStatus</span> <span class="cm-operator">=</span> <span class="cm-variable">SrvTransactNamedPipe</span>( <span class="cm-variable">WorkContext</span> );
                <span class="cm-keyword">break</span>;

            <span class="cm-keyword">case</span> <span class="cm-variable">TRANS_PEEK_NMPIPE</span>: <span class="cm-comment">//0x23</span>
                <span class="cm-variable">resultStatus</span> <span class="cm-operator">=</span> <span class="cm-variable">SrvPeekNamedPipe</span>( <span class="cm-variable">WorkContext</span> );
                <span class="cm-keyword">break</span>;

            <span class="cm-keyword">case</span> <span class="cm-variable">TRANS_CALL_NMPIPE</span>:
                <span class="cm-variable">resultStatus</span> <span class="cm-operator">=</span> <span class="cm-variable">SrvCallNamedPipe</span>( <span class="cm-variable">WorkContext</span> );
                <span class="cm-keyword">break</span>;
            <span class="cm-comment">//...</span>
        }
        <span class="cm-comment">//...</span>
}</pre>
<p><span class="md-line md-end-block">由于之前已经将<span spellcheck="false"><code>write_transaction</code></span>的<span spellcheck="false"><code>InSetup</code></span>修改为0x23, 所以会<span spellcheck="false"><code>call SrvPeekNamedPipe</code></span>。</span></p>
<pre class="md-fences md-end-block" lang="c" contenteditable="false"><span class="cm-meta"># ChildEBP RetAddr               </span>
<span class="cm-number">00</span> <span class="cm-variable">b21f8d44</span> <span class="cm-variable">b24cdcce</span> <span class="cm-variable">srv</span><span class="cm-operator">!</span><span class="cm-variable">ExecuteTransaction</span><span class="cm-operator">+</span><span class="cm-number">0x23b</span> (<span class="cm-variable">FPO</span>: [<span class="cm-number">0</span>,<span class="cm-number">0</span>,<span class="cm-number">0</span>])
<span class="cm-number">01</span> <span class="cm-variable">b21f8d7c</span> <span class="cm-variable">b248a836</span> <span class="cm-variable">srv</span><span class="cm-operator">!</span><span class="cm-variable">SrvSmbTransactionSecondary</span><span class="cm-operator">+</span><span class="cm-number">0x2f1</span> (<span class="cm-variable">FPO</span>: [<span class="cm-variable">Non</span><span class="cm-operator">-</span><span class="cm-variable">Fpo</span>])
<span class="cm-number">02</span> <span class="cm-variable">b21f8d88</span> <span class="cm-variable">b249ad98</span> <span class="cm-variable">srv</span><span class="cm-operator">!</span><span class="cm-variable">SrvProcessSmb</span><span class="cm-operator">+</span><span class="cm-number">0xb7</span> (<span class="cm-variable">FPO</span>: [<span class="cm-number">0</span>,<span class="cm-number">0</span>,<span class="cm-number">0</span>])
<span class="cm-number">03</span> <span class="cm-variable">b21f8dac</span> <span class="cm-number">805</span><span class="cm-variable">c7160</span> <span class="cm-variable">srv</span><span class="cm-operator">!</span><span class="cm-variable">WorkerThread</span><span class="cm-operator">+</span><span class="cm-number">0x11e</span> (<span class="cm-variable">FPO</span>: [<span class="cm-variable">Non</span><span class="cm-operator">-</span><span class="cm-variable">Fpo</span>])
<span class="cm-number">04</span> <span class="cm-variable">b21f8ddc</span> <span class="cm-number">80542</span><span class="cm-variable">dd2</span> <span class="cm-variable">nt</span><span class="cm-operator">!</span><span class="cm-variable">PspSystemThreadStartup</span><span class="cm-operator">+</span><span class="cm-number">0x34</span> (<span class="cm-variable">FPO</span>: [<span class="cm-variable">Non</span><span class="cm-operator">-</span><span class="cm-variable">Fpo</span>])
<span class="cm-number">05</span> <span class="cm-number">00000000</span> <span class="cm-number">00000000</span> <span class="cm-variable">nt</span><span class="cm-operator">!</span><span class="cm-variable">KiThreadStartup</span><span class="cm-operator">+</span><span class="cm-number">0x16</span></pre>
<p><span class="md-line md-end-block"><span spellcheck="false"><code>SrvPeekNamedPipe()</code></span> 调用<span spellcheck="false"><code>IoCallDriver</code></span>最终调到 <span spellcheck="false"><code>RestartPeekNamedPipe()</code></span>函数 </span></p>
<pre class="md-fences md-end-block" lang="c" contenteditable="false"><span class="cm-variable">VOID</span> <span class="cm-variable">SRVFASTCALL</span> <span class="cm-def">RestartPeekNamedPipe</span> (
    <span class="cm-variable">IN</span> <span class="cm-variable">OUT</span> <span class="cm-variable">PWORK_CONTEXT</span> <span class="cm-variable">WorkContext</span>)
{
    <span class="cm-comment">//...</span>

    <span class="cm-comment">//</span>
    <span class="cm-comment">// Success.  Generate and send the response.</span>
    <span class="cm-comment">//</span>
    <span class="cm-variable">transaction</span> <span class="cm-operator">=</span> <span class="cm-variable">WorkContext</span><span class="cm-operator">-&gt;</span><span class="cm-variable">Parameters</span>.<span class="cm-variable">Transaction</span>;
    <span class="cm-variable">pipePeekBuffer</span> <span class="cm-operator">=</span> (<span class="cm-variable">PFILE_PIPE_PEEK_BUFFER</span>)<span class="cm-variable">transaction</span><span class="cm-operator">-&gt;</span><span class="cm-variable">OutParameters</span>;

    <span class="cm-variable">readDataAvailable</span> <span class="cm-operator">=</span> (<span class="cm-variable">USHORT</span>)<span class="cm-variable">pipePeekBuffer</span><span class="cm-operator">-&gt;</span><span class="cm-variable">ReadDataAvailable</span>;
    <span class="cm-variable">messageLength</span> <span class="cm-operator">=</span> (<span class="cm-variable">USHORT</span>)<span class="cm-variable">pipePeekBuffer</span><span class="cm-operator">-&gt;</span><span class="cm-variable">MessageLength</span>;
    <span class="cm-variable">namedPipeState</span> <span class="cm-operator">=</span> (<span class="cm-variable">USHORT</span>)<span class="cm-variable">pipePeekBuffer</span><span class="cm-operator">-&gt;</span><span class="cm-variable">NamedPipeState</span>;

    <span class="cm-comment">//</span>
    <span class="cm-comment">// ... then copy them back in the new format.</span>
    <span class="cm-comment">//</span>
    <span class="cm-variable">respPeekNmPipe</span> <span class="cm-operator">=</span> (<span class="cm-variable">PRESP_PEEK_NMPIPE</span>)<span class="cm-variable">pipePeekBuffer</span>;
    <span class="cm-variable">SmbPutAlignedUshort</span>(
        <span class="cm-operator">&amp;</span><span class="cm-variable">respPeekNmPipe</span><span class="cm-operator">-&gt;</span><span class="cm-variable">ReadDataAvailable</span>,
        <span class="cm-variable">readDataAvailable</span>
        );
    <span class="cm-variable">SmbPutAlignedUshort</span>(
        <span class="cm-operator">&amp;</span><span class="cm-variable">respPeekNmPipe</span><span class="cm-operator">-&gt;</span><span class="cm-variable">MessageLength</span>,
        <span class="cm-variable">messageLength</span>
        );
    <span class="cm-variable">SmbPutAlignedUshort</span>(
        <span class="cm-operator">&amp;</span><span class="cm-variable">respPeekNmPipe</span><span class="cm-operator">-&gt;</span><span class="cm-variable">NamedPipeState</span>,
        <span class="cm-variable">namedPipeState</span>
        );

    <span class="cm-comment">//</span>
    <span class="cm-comment">// Send the response.  Set the output counts.</span>
    <span class="cm-comment">//</span>
    <span class="cm-comment">// NT return to us 4 ULONGS of parameter bytes, followed by data.</span>
    <span class="cm-comment">// We return to the client 6 parameter bytes.</span>
    <span class="cm-comment">//</span>
    <span class="cm-variable">transaction</span><span class="cm-operator">-&gt;</span><span class="cm-variable">SetupCount</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>;
    <span class="cm-variable">transaction</span><span class="cm-operator">-&gt;</span><span class="cm-variable">ParameterCount</span> <span class="cm-operator">=</span> <span class="cm-number">6</span>;
    <span class="cm-variable">transaction</span><span class="cm-operator">-&gt;</span><span class="cm-variable">DataCount</span> <span class="cm-operator">=</span> <span class="cm-variable">WorkContext</span><span class="cm-operator">-&gt;</span><span class="cm-variable">Irp</span><span class="cm-operator">-&gt;</span><span class="cm-variable">IoStatus</span>.<span class="cm-variable">Information</span> <span class="cm-operator">-</span> (<span class="cm-number">4</span> <span class="cm-operator">*</span> <span class="cm-keyword">sizeof</span>(<span class="cm-variable">ULONG</span>));
    <span class="cm-comment">//...</span>
}</pre>
<p><span class="md-line md-end-block">该函数最终会修改<span spellcheck="false"><code>Transaction-&gt;DataCount</code></span> 为 0x23c。</span></p>
<pre class="md-fences md-end-block" lang="c" contenteditable="false"><span class="cm-variable">kd</span><span class="cm-operator">&gt;</span> <span class="cm-variable">ub</span>
<span class="cm-variable">srv</span><span class="cm-operator">!</span><span class="cm-variable">RestartPeekNamedPipe</span><span class="cm-operator">+</span><span class="cm-number">0x42</span>:
<span class="cm-variable">b7700137</span> <span class="cm-number">66895004</span>        <span class="cm-variable">mov</span>     <span class="cm-variable">word</span> <span class="cm-variable">ptr</span> [<span class="cm-variable">eax</span><span class="cm-operator">+</span><span class="cm-number">4</span>],<span class="cm-variable">dx</span>
<span class="cm-variable">b770013b</span> <span class="cm-number">83614</span><span class="cm-variable">c00</span>        <span class="cm-variable">and</span>     <span class="cm-variable">dword</span> <span class="cm-variable">ptr</span> [<span class="cm-variable">ecx</span><span class="cm-operator">+</span><span class="cm-number">4</span><span class="cm-variable">Ch</span>],<span class="cm-number">0</span>
<span class="cm-variable">b770013f</span> <span class="cm-variable">c7415406000000</span>  <span class="cm-variable">mov</span>     <span class="cm-variable">dword</span> <span class="cm-variable">ptr</span> [<span class="cm-variable">ecx</span><span class="cm-operator">+</span><span class="cm-number">54</span><span class="cm-variable">h</span>],<span class="cm-number">6</span>
<span class="cm-variable">b7700146</span> <span class="cm-number">8</span><span class="cm-variable">b4678</span>          <span class="cm-variable">mov</span>     <span class="cm-variable">eax</span>,<span class="cm-variable">dword</span> <span class="cm-variable">ptr</span> [<span class="cm-variable">esi</span><span class="cm-operator">+</span><span class="cm-number">78</span><span class="cm-variable">h</span>]
<span class="cm-variable">b7700149</span> <span class="cm-number">8</span><span class="cm-variable">b401c</span>          <span class="cm-variable">mov</span>     <span class="cm-variable">eax</span>,<span class="cm-variable">dword</span> <span class="cm-variable">ptr</span> [<span class="cm-variable">eax</span><span class="cm-operator">+</span><span class="cm-number">1</span><span class="cm-variable">Ch</span>]
<span class="cm-variable">b770014c</span> <span class="cm-number">83e810</span>          <span class="cm-variable">sub</span>     <span class="cm-variable">eax</span>,<span class="cm-number">10</span><span class="cm-variable">h</span>
<span class="cm-variable">b770014f</span> <span class="cm-number">85f</span><span class="cm-variable">f</span>            <span class="cm-variable">test</span>    <span class="cm-variable">edi</span>,<span class="cm-variable">edi</span>
<span class="cm-variable">b7700151</span> <span class="cm-number">894160</span>          <span class="cm-variable">mov</span>     <span class="cm-variable">dword</span> <span class="cm-variable">ptr</span> [<span class="cm-variable">ecx</span><span class="cm-operator">+</span><span class="cm-number">60</span><span class="cm-variable">h</span>],<span class="cm-variable">eax</span>

<span class="cm-variable">kd</span><span class="cm-operator">&gt;</span> <span class="cm-operator">?</span><span class="cm-variable">ecx</span><span class="cm-operator">+</span><span class="cm-number">0x60</span>
<span class="cm-variable">Evaluate</span> <span class="cm-variable">expression</span>: <span class="cm-number">367768</span> <span class="cm-operator">=</span> <span class="cm-number">00059</span><span class="cm-variable">c98</span>

<span class="cm-variable">kd</span><span class="cm-operator">&gt;</span> <span class="cm-variable">r</span> <span class="cm-variable">eax</span>
<span class="cm-variable">eax</span><span class="cm-operator">=</span><span class="cm-number">0000023</span><span class="cm-variable">c</span>
<span class="cm-variable">kd</span><span class="cm-operator">&gt;</span> <span class="cm-variable">dd</span> <span class="cm-number">00059</span><span class="cm-variable">c38</span>
<span class="cm-number">00059</span><span class="cm-variable">c38</span>  <span class="cm-number">109</span><span class="cm-variable">c020c</span> <span class="cm-number">00000000</span> <span class="cm-variable">ffdff500</span> <span class="cm-number">89</span><span class="cm-variable">a29c18</span>
<span class="cm-number">00059</span><span class="cm-variable">c48</span>  <span class="cm-variable">e1ed9900</span> <span class="cm-variable">e15e2960</span> <span class="cm-number">0005</span><span class="cm-variable">acf8</span> <span class="cm-number">00058</span><span class="cm-variable">ba8</span>
<span class="cm-number">00059</span><span class="cm-variable">c58</span>  <span class="cm-number">00020000</span> <span class="cm-number">00059</span><span class="cm-variable">cd0</span> <span class="cm-number">00002307</span> <span class="cm-number">00000001</span>
<span class="cm-number">00059</span><span class="cm-variable">c68</span>  <span class="cm-number">00000000</span> <span class="cm-number">00059</span><span class="cm-variable">cd4</span> <span class="cm-number">8993</span><span class="cm-variable">b3e5</span> <span class="cm-number">00059</span><span class="cm-variable">cd4</span>
<span class="cm-number">00059</span><span class="cm-variable">c78</span>  <span class="cm-number">00059</span><span class="cm-variable">d14</span> <span class="cm-variable">ffdff500</span> <span class="cm-number">0005</span><span class="cm-variable">acd4</span> <span class="cm-number">00000000</span>
<span class="cm-number">00059</span><span class="cm-variable">c88</span>  <span class="cm-number">00000000</span> <span class="cm-number">00000006</span> <span class="cm-number">00000000</span> <span class="cm-number">00000f</span><span class="cm-variable">f0</span>
<span class="cm-number">00059</span><span class="cm-variable">c98</span>  <span class="cm-number">0000023</span><span class="cm-variable">c</span> <span class="cm-number">00000000</span> <span class="cm-number">00000001</span> <span class="cm-number">00000000</span>
<span class="cm-number">00059</span><span class="cm-variable">ca8</span>  <span class="cm-number">00000101</span> <span class="cm-number">08000000</span> <span class="cm-number">0800</span><span class="cm-variable">cee6</span> <span class="cm-number">00000000</span>

<span class="cm-variable">kd</span><span class="cm-operator">&gt;</span> <span class="cm-variable">k</span>
 <span class="cm-meta"># ChildEBP RetAddr  </span>
<span class="cm-number">00</span> <span class="cm-variable">b7c0ed88</span> <span class="cm-variable">b76dad98</span> <span class="cm-variable">srv</span><span class="cm-operator">!</span><span class="cm-variable">RestartPeekNamedPipe</span><span class="cm-operator">+</span><span class="cm-number">0x5f</span>
<span class="cm-number">01</span> <span class="cm-variable">b7c0edac</span> <span class="cm-number">805</span><span class="cm-variable">c6160</span> <span class="cm-variable">srv</span><span class="cm-operator">!</span><span class="cm-variable">WorkerThread</span><span class="cm-operator">+</span><span class="cm-number">0x11e</span>
<span class="cm-number">02</span> <span class="cm-variable">b7c0eddc</span> <span class="cm-number">80541</span><span class="cm-variable">dd2</span> <span class="cm-variable">nt</span><span class="cm-operator">!</span><span class="cm-variable">PspSystemThreadStartup</span><span class="cm-operator">+</span><span class="cm-number">0x34</span>
<span class="cm-number">03</span> <span class="cm-number">00000000</span> <span class="cm-number">00000000</span> <span class="cm-variable">nt</span><span class="cm-operator">!</span><span class="cm-variable">KiThreadStartup</span><span class="cm-operator">+</span><span class="cm-number">0x16</span></pre>
<p><span class="md-line md-end-block">至此，已经成功修改了<span spellcheck="false"><code>write_transaction</code></span>的<span spellcheck="false"><code>DataCount</code></span>值，之后便可以越界读出 <span spellcheck="false"><code>leak_transacion-&gt;Connection</code></span>值: 89a29c18。</span></p>
<h3 class="md-end-block md-heading">5.1.1.3 SRV global data pointer</h3>
<pre class="md-fences md-end-block" lang="c" contenteditable="false"><span class="cm-variable">kd</span><span class="cm-operator">&gt;</span> <span class="cm-variable">dds</span> <span class="cm-number">89</span><span class="cm-variable">a29c18</span>
<span class="cm-number">89</span><span class="cm-variable">a29c18</span>  <span class="cm-number">02580202</span>
<span class="cm-number">89</span><span class="cm-variable">a29c1c</span>  <span class="cm-number">0000001</span><span class="cm-variable">d</span>
<span class="cm-number">89</span><span class="cm-variable">a29c20</span>  <span class="cm-number">00000000</span>
<span class="cm-number">89</span><span class="cm-variable">a29c24</span>  <span class="cm-number">00000000</span>
<span class="cm-number">89</span><span class="cm-variable">a29c28</span>  <span class="cm-number">00000000</span>
<span class="cm-number">89</span><span class="cm-variable">a29c2c</span>  <span class="cm-number">00000000</span>
<span class="cm-number">89</span><span class="cm-variable">a29c30</span>  <span class="cm-number">00000000</span>
<span class="cm-number">89</span><span class="cm-variable">a29c34</span>  <span class="cm-number">00000000</span>
<span class="cm-number">89</span><span class="cm-variable">a29c38</span>  <span class="cm-number">00000000</span>
<span class="cm-number">89</span><span class="cm-variable">a29c3c</span>  <span class="cm-variable">b76d8bec</span> <span class="cm-variable">srv</span><span class="cm-operator">!</span><span class="cm-variable">SrvGlobalSpinLocks</span><span class="cm-operator">+</span><span class="cm-number">0x3c</span>
<span class="cm-number">89</span><span class="cm-variable">a29c40</span>  <span class="cm-number">899</span><span class="cm-variable">d0020</span>
<span class="cm-number">89</span><span class="cm-variable">a29c44</span>  <span class="cm-number">000005</span><span class="cm-variable">b3</span>
<span class="cm-number">89</span><span class="cm-variable">a29c48</span>  <span class="cm-number">8976</span><span class="cm-variable">c200</span>
<span class="cm-number">89</span><span class="cm-variable">a29c4c</span>  <span class="cm-number">00004000</span>
<span class="cm-number">89</span><span class="cm-variable">a29c50</span>  <span class="cm-number">10000100</span>
<span class="cm-number">89</span><span class="cm-variable">a29c54</span>  <span class="cm-number">00000000</span>
<span class="cm-number">89</span><span class="cm-variable">a29c58</span>  <span class="cm-number">8988e010</span>
<span class="cm-number">89</span><span class="cm-variable">a29c5c</span>  <span class="cm-number">89</span><span class="cm-variable">aedc30</span>
<span class="cm-number">89</span><span class="cm-variable">a29c60</span>  <span class="cm-number">89</span><span class="cm-variable">a7d898</span>
<span class="cm-number">89</span><span class="cm-variable">a29c64</span>  <span class="cm-number">0001f</span><span class="cm-variable">fff</span></pre>
<p><span class="md-line md-end-block">其中<span spellcheck="false"><code>srv!SrvGlobalSpinLocks+0x3c</code></span> 就是所谓的 SRV global data pointer ：b76d8bec</span></p>
<h3 class="md-end-block md-heading">5.1.1.4 Locating function tables</h3>
<pre class="md-fences md-end-block" lang="c" contenteditable="false"><span class="cm-variable">kd</span><span class="cm-operator">&gt;</span> <span class="cm-variable">dds</span> <span class="cm-variable">b76d8bec</span><span class="cm-operator">-</span><span class="cm-number">0x654</span>
<span class="cm-variable">b76d8598</span>  <span class="cm-variable">b7709683</span> <span class="cm-variable">srv</span><span class="cm-operator">!</span><span class="cm-variable">SrvSmbOpen2</span>
<span class="cm-variable">b76d859c</span>  <span class="cm-variable">b76f62a8</span> <span class="cm-variable">srv</span><span class="cm-operator">!</span><span class="cm-variable">SrvSmbFindFirst2</span>
<span class="cm-variable">b76d85a0</span>  <span class="cm-variable">b76f74e5</span> <span class="cm-variable">srv</span><span class="cm-operator">!</span><span class="cm-variable">SrvSmbFindNext2</span>
<span class="cm-variable">b76d85a4</span>  <span class="cm-variable">b76f6309</span> <span class="cm-variable">srv</span><span class="cm-operator">!</span><span class="cm-variable">SrvSmbQueryFsInformation</span>
<span class="cm-variable">b76d85a8</span>  <span class="cm-variable">b7707293</span> <span class="cm-variable">srv</span><span class="cm-operator">!</span><span class="cm-variable">SrvSmbSetFsInformation</span>
<span class="cm-variable">b76d85ac</span>  <span class="cm-variable">b77041ad</span> <span class="cm-variable">srv</span><span class="cm-operator">!</span><span class="cm-variable">SrvSmbQueryPathInformation</span>
<span class="cm-variable">b76d85b0</span>  <span class="cm-variable">b7703ce7</span> <span class="cm-variable">srv</span><span class="cm-operator">!</span><span class="cm-variable">SrvSmbSetPathInformation</span>
<span class="cm-variable">b76d85b4</span>  <span class="cm-variable">b77025ad</span> <span class="cm-variable">srv</span><span class="cm-operator">!</span><span class="cm-variable">SrvSmbQueryFileInformation</span>
<span class="cm-variable">b76d85b8</span>  <span class="cm-variable">b770367f</span> <span class="cm-variable">srv</span><span class="cm-operator">!</span><span class="cm-variable">SrvSmbSetFileInformation</span>
<span class="cm-variable">b76d85bc</span>  <span class="cm-variable">b7705c85</span> <span class="cm-variable">srv</span><span class="cm-operator">!</span><span class="cm-variable">SrvSmbFsctl</span>
<span class="cm-variable">b76d85c0</span>  <span class="cm-variable">b7706419</span> <span class="cm-variable">srv</span><span class="cm-operator">!</span><span class="cm-variable">SrvSmbIoctl2</span>
<span class="cm-variable">b76d85c4</span>  <span class="cm-variable">b7705c85</span> <span class="cm-variable">srv</span><span class="cm-operator">!</span><span class="cm-variable">SrvSmbFsctl</span>
<span class="cm-variable">b76d85c8</span>  <span class="cm-variable">b7705c85</span> <span class="cm-variable">srv</span><span class="cm-operator">!</span><span class="cm-variable">SrvSmbFsctl</span>
<span class="cm-variable">b76d85cc</span>  <span class="cm-variable">b77047bb</span> <span class="cm-variable">srv</span><span class="cm-operator">!</span><span class="cm-variable">SrvSmbCreateDirectory2</span>
<span class="cm-variable">b76d85d0</span>  <span class="cm-variable">b7709a51</span> <span class="cm-variable">srv</span><span class="cm-operator">!</span><span class="cm-variable">SrvTransactionNotImplemented</span>
<span class="cm-variable">b76d85d4</span>  <span class="cm-variable">b7709a51</span> <span class="cm-variable">srv</span><span class="cm-operator">!</span><span class="cm-variable">SrvTransactionNotImplemented</span>
<span class="cm-variable">b76d85d8</span>  <span class="cm-variable">b76fb144</span> <span class="cm-variable">srv</span><span class="cm-operator">!</span><span class="cm-variable">SrvSmbGetDfsReferral</span>
<span class="cm-variable">b76d85dc</span>  <span class="cm-variable">b76faf7e</span> <span class="cm-variable">srv</span><span class="cm-operator">!</span><span class="cm-variable">SrvSmbReportDfsInconsistency</span>
<span class="cm-variable">b76d85e0</span>  <span class="cm-number">00000000</span></pre>
<h3 class="md-end-block md-heading">5.1.2 泄露Npp Buffer (shellcode buffer)</h3>
<p><span class="md-line md-end-block">这里又得回到<span spellcheck="false"><code>ExecuteTransaction</code></span>函数：</span></p>
<pre class="md-fences md-end-block" lang="c" contenteditable="false"><span class="cm-variable">SMB_STATUS</span> <span class="cm-variable">SRVFASTCALL</span> <span class="cm-def">ExecuteTransaction</span> (
    <span class="cm-variable">IN</span> <span class="cm-variable">OUT</span> <span class="cm-variable">PWORK_CONTEXT</span> <span class="cm-variable">WorkContext</span>)
{
    <span class="cm-comment">//...</span>
    <span class="cm-variable">header</span> <span class="cm-operator">=</span> <span class="cm-variable">WorkContext</span><span class="cm-operator">-&gt;</span><span class="cm-variable">ResponseHeader</span>;
    <span class="cm-variable">response</span> <span class="cm-operator">=</span> (<span class="cm-variable">PRESP_TRANSACTION</span>)<span class="cm-variable">WorkContext</span><span class="cm-operator">-&gt;</span><span class="cm-variable">ResponseParameters</span>;
    <span class="cm-variable">ntResponse</span> <span class="cm-operator">=</span> (<span class="cm-variable">PRESP_NT_TRANSACTION</span>)<span class="cm-variable">WorkContext</span><span class="cm-operator">-&gt;</span><span class="cm-variable">ResponseParameters</span>;

    <span class="cm-comment">//</span>
    <span class="cm-comment">// Setup output pointers</span>
    <span class="cm-comment">//</span>

    <span class="cm-keyword">if</span> ( <span class="cm-variable">transaction</span><span class="cm-operator">-&gt;</span><span class="cm-variable">OutParameters</span> <span class="cm-operator">==</span> <span class="cm-variable">NULL</span> ) {

        <span class="cm-comment">//</span>
        <span class="cm-comment">// Parameters will go into the SMB buffer.  Calculate the pointer</span>
        <span class="cm-comment">// then round it up to the next DWORD address.</span>
        <span class="cm-comment">//</span>

        <span class="cm-variable">transaction</span><span class="cm-operator">-&gt;</span><span class="cm-variable">OutParameters</span> <span class="cm-operator">=</span> (<span class="cm-variable">PCHAR</span>)(<span class="cm-variable">transaction</span><span class="cm-operator">-&gt;</span><span class="cm-variable">OutSetup</span> <span class="cm-operator">+</span>
            <span class="cm-variable">transaction</span><span class="cm-operator">-&gt;</span><span class="cm-variable">MaxSetupCount</span>);
        <span class="cm-variable">offset</span> <span class="cm-operator">=</span> (<span class="cm-variable">transaction</span><span class="cm-operator">-&gt;</span><span class="cm-variable">OutParameters</span> <span class="cm-operator">-</span> (<span class="cm-variable">PCHAR</span>)<span class="cm-variable">header</span> <span class="cm-operator">+</span> <span class="cm-number">3</span>) <span class="cm-operator">&amp;</span> <span class="cm-variable">~3</span>;
        <span class="cm-variable">transaction</span><span class="cm-operator">-&gt;</span><span class="cm-variable">OutParameters</span> <span class="cm-operator">=</span> (<span class="cm-variable">PCHAR</span>)<span class="cm-variable">header</span> <span class="cm-operator">+</span> <span class="cm-variable">offset</span>;
    }

    <span class="cm-keyword">if</span> ( <span class="cm-variable">transaction</span><span class="cm-operator">-&gt;</span><span class="cm-variable">OutData</span> <span class="cm-operator">==</span> <span class="cm-variable">NULL</span> ) {

        <span class="cm-comment">//</span>
        <span class="cm-comment">// Data will go into the SMB buffer.  Calculate the pointer</span>
        <span class="cm-comment">// then round it up to the next DWORD address.</span>
        <span class="cm-comment">//</span>

        <span class="cm-variable">transaction</span><span class="cm-operator">-&gt;</span><span class="cm-variable">OutData</span> <span class="cm-operator">=</span> <span class="cm-variable">transaction</span><span class="cm-operator">-&gt;</span><span class="cm-variable">OutParameters</span> <span class="cm-operator">+</span>
            <span class="cm-variable">transaction</span><span class="cm-operator">-&gt;</span><span class="cm-variable">MaxParameterCount</span>;
        <span class="cm-variable">offset</span> <span class="cm-operator">=</span> (<span class="cm-variable">transaction</span><span class="cm-operator">-&gt;</span><span class="cm-variable">OutData</span> <span class="cm-operator">-</span> (<span class="cm-variable">PCHAR</span>)<span class="cm-variable">header</span> <span class="cm-operator">+</span> <span class="cm-number">3</span>) <span class="cm-operator">&amp;</span> <span class="cm-variable">~3</span>;
        <span class="cm-variable">transaction</span><span class="cm-operator">-&gt;</span><span class="cm-variable">OutData</span> <span class="cm-operator">=</span> (<span class="cm-variable">PCHAR</span>)<span class="cm-variable">header</span> <span class="cm-operator">+</span> <span class="cm-variable">offset</span>;
    }
            <span class="cm-comment">//...</span>
            <span class="cm-variable">command</span> <span class="cm-operator">=</span> <span class="cm-variable">SmbGetUshort</span>(<span class="cm-operator">&amp;</span><span class="cm-variable">transaction</span><span class="cm-operator">-&gt;</span><span class="cm-variable">InSetup</span>[<span class="cm-number">0</span>]);
            <span class="cm-comment">//...</span>

            <span class="cm-keyword">switch</span>( <span class="cm-variable">command</span> ) {

            <span class="cm-keyword">case</span> <span class="cm-variable">TRANS_TRANSACT_NMPIPE</span>:
                <span class="cm-variable">resultStatus</span> <span class="cm-operator">=</span> <span class="cm-variable">SrvTransactNamedPipe</span>( <span class="cm-variable">WorkContext</span> );
                <span class="cm-keyword">break</span>;

            <span class="cm-keyword">case</span> <span class="cm-variable">TRANS_PEEK_NMPIPE</span>:
                <span class="cm-variable">resultStatus</span> <span class="cm-operator">=</span> <span class="cm-variable">SrvPeekNamedPipe</span>( <span class="cm-variable">WorkContext</span> );
                <span class="cm-keyword">break</span>;
            <span class="cm-comment">//...</span>
}</pre>
<p><span class="md-line md-end-block">这在这个函数里有这么一个逻辑，当<span spellcheck="false"><code>transaction-&gt;OutParameters==NULL</code></span>里，会将<span spellcheck="false"><code>PWORK_CONTEXT-&gt;ResponseHeader</code></span>加上一定的offset赋于它，<span spellcheck="false"><code>PWORK_CONTEXT-&gt;ResponseHeader</code></span>就是个NonePagedPool.</span></p>
<pre class="md-fences md-end-block" lang="c" contenteditable="false"><span class="cm-variable">kd</span><span class="cm-operator">&gt;</span> <span class="cm-variable">ub</span> <span class="cm-variable">eip</span>
<span class="cm-variable">srv</span><span class="cm-operator">!</span><span class="cm-variable">ExecuteTransaction</span><span class="cm-operator">+</span><span class="cm-number">0x60</span>:
<span class="cm-variable">b76e8d05</span> <span class="cm-number">46</span>              <span class="cm-variable">inc</span>     <span class="cm-variable">esi</span>
<span class="cm-variable">b76e8d06</span> <span class="cm-number">50</span>              <span class="cm-variable">push</span>    <span class="cm-variable">eax</span>
<span class="cm-variable">b76e8d07</span> <span class="cm-variable">d1e0</span>            <span class="cm-variable">shl</span>     <span class="cm-variable">eax</span>,<span class="cm-number">1</span>
<span class="cm-variable">b76e8d09</span> <span class="cm-number">2</span><span class="cm-variable">bc2</span>            <span class="cm-variable">sub</span>     <span class="cm-variable">eax</span>,<span class="cm-variable">edx</span>
<span class="cm-variable">b76e8d0b</span> <span class="cm-number">8</span><span class="cm-variable">d440803</span>        <span class="cm-variable">lea</span>     <span class="cm-variable">eax</span>,[<span class="cm-variable">eax</span><span class="cm-operator">+</span><span class="cm-variable">ecx</span><span class="cm-operator">+</span><span class="cm-number">3</span>]
<span class="cm-variable">b76e8d0f</span> <span class="cm-number">83e0f</span><span class="cm-variable">c</span>          <span class="cm-variable">and</span>     <span class="cm-variable">eax</span>,<span class="cm-number">0F</span><span class="cm-variable">FFFFFFCh</span>
<span class="cm-variable">b76e8d12</span> <span class="cm-number">03</span><span class="cm-variable">c2</span>            <span class="cm-variable">add</span>     <span class="cm-variable">eax</span>,<span class="cm-variable">edx</span>
<span class="cm-variable">b76e8d14</span> <span class="cm-number">894640</span>          <span class="cm-variable">mov</span>     <span class="cm-variable">dword</span> <span class="cm-variable">ptr</span> [<span class="cm-variable">esi</span><span class="cm-operator">+</span><span class="cm-number">40</span><span class="cm-variable">h</span>],<span class="cm-variable">eax</span>

<span class="cm-variable">kd</span><span class="cm-operator">&gt;</span> <span class="cm-variable">dd</span> <span class="cm-number">5</span><span class="cm-variable">ace0</span>
<span class="cm-number">0005</span><span class="cm-variable">ace0</span>  <span class="cm-number">109</span><span class="cm-variable">c020c</span> <span class="cm-number">00000000</span> <span class="cm-number">89</span><span class="cm-variable">b2c948</span> <span class="cm-number">89</span><span class="cm-variable">a29c18</span>
<span class="cm-number">0005</span><span class="cm-variable">acf0</span>  <span class="cm-variable">e1ed9900</span> <span class="cm-variable">e15e2960</span> <span class="cm-number">0005</span><span class="cm-variable">bda0</span> <span class="cm-number">00059</span><span class="cm-variable">c50</span>
<span class="cm-number">0005</span><span class="cm-variable">ad00</span>  <span class="cm-number">00020000</span> <span class="cm-number">0005</span><span class="cm-variable">ad78</span> <span class="cm-number">00002361</span> <span class="cm-number">40010036</span>
<span class="cm-number">0005</span><span class="cm-variable">ad10</span>  <span class="cm-number">00000000</span> <span class="cm-number">0005</span><span class="cm-variable">ad0c</span> <span class="cm-number">8993f</span><span class="cm-variable">a25</span> <span class="cm-number">0005</span><span class="cm-variable">ad7c</span>
<span class="cm-number">0005</span><span class="cm-variable">ad20</span>  <span class="cm-number">8993f</span><span class="cm-variable">a28</span> <span class="cm-number">0005</span><span class="cm-variable">ad7c</span> <span class="cm-variable">b76d84ec</span> <span class="cm-number">00000004</span>
<span class="cm-number">0005</span><span class="cm-variable">ad30</span>  <span class="cm-number">00000000</span> <span class="cm-number">00000000</span> <span class="cm-number">00000000</span> <span class="cm-number">00000010</span>
<span class="cm-number">0005</span><span class="cm-variable">ad40</span>  <span class="cm-number">00000000</span> <span class="cm-number">00000000</span> <span class="cm-number">00000100</span> <span class="cm-number">00000000</span>
<span class="cm-number">0005</span><span class="cm-variable">ad50</span>  <span class="cm-number">00000101</span> <span class="cm-number">08000000</span> <span class="cm-number">0800</span><span class="cm-variable">cee6</span> <span class="cm-number">0000004</span><span class="cm-variable">b</span>

<span class="cm-variable">kd</span><span class="cm-operator">&gt;</span> <span class="cm-operator">?</span> <span class="cm-variable">esi</span><span class="cm-operator">+</span><span class="cm-number">0x40</span>
<span class="cm-variable">Evaluate</span> <span class="cm-variable">expression</span>: <span class="cm-number">372000</span> <span class="cm-operator">=</span> <span class="cm-number">0005</span><span class="cm-variable">ad20</span>

<span class="cm-variable">kd</span><span class="cm-operator">&gt;</span> <span class="cm-variable">r</span> <span class="cm-variable">eax</span>
<span class="cm-variable">eax</span><span class="cm-operator">=</span><span class="cm-number">8993f</span><span class="cm-variable">a28</span></pre>
<h3 class="md-end-block md-heading">5.1.2.1 transaction-&gt;OutParameters=NULL</h3>
<p><span class="md-line md-end-block">Transaction 初始状态下<span spellcheck="false"><code>OutParameters</code></span>并不为NULL：</span></p>
<pre class="md-fences md-end-block" lang="c" contenteditable="false"><span class="cm-variable">kd</span><span class="cm-operator">&gt;</span> <span class="cm-variable">dd</span> <span class="cm-number">5</span><span class="cm-variable">ace0</span>
<span class="cm-number">0005</span><span class="cm-variable">ace0</span>  <span class="cm-number">109</span><span class="cm-variable">c020c</span> <span class="cm-number">00000000</span> <span class="cm-number">89</span><span class="cm-variable">b2c948</span> <span class="cm-number">89</span><span class="cm-variable">a29c18</span>
<span class="cm-number">0005</span><span class="cm-variable">acf0</span>  <span class="cm-variable">e1ed9900</span> <span class="cm-variable">e15e2960</span> <span class="cm-number">0005</span><span class="cm-variable">bda0</span> <span class="cm-number">00059</span><span class="cm-variable">c50</span>
<span class="cm-number">0005</span><span class="cm-variable">ad00</span>  <span class="cm-number">00020000</span> <span class="cm-number">0005</span><span class="cm-variable">ad78</span> <span class="cm-number">00002361</span> <span class="cm-number">00000001</span>
<span class="cm-number">0005</span><span class="cm-variable">ad10</span>  <span class="cm-number">00000000</span> <span class="cm-number">0005</span><span class="cm-variable">ad7c</span> <span class="cm-number">00000000</span> <span class="cm-number">0005</span><span class="cm-variable">ad7c</span>
<span class="cm-number">0005</span><span class="cm-variable">ad20</span>  <span class="cm-number">0005</span><span class="cm-variable">adbc</span> <span class="cm-number">0005</span><span class="cm-variable">ad7c</span> <span class="cm-number">0005</span><span class="cm-variable">bd7c</span> <span class="cm-number">00000000</span>
<span class="cm-number">0005</span><span class="cm-variable">ad30</span>  <span class="cm-number">00000000</span> <span class="cm-number">00000000</span> <span class="cm-number">00000000</span> <span class="cm-number">00000f</span><span class="cm-variable">c0</span>
<span class="cm-number">0005</span><span class="cm-variable">ad40</span>  <span class="cm-number">00000000</span> <span class="cm-number">00000040</span> <span class="cm-number">00000000</span> <span class="cm-number">00000000</span>
<span class="cm-number">0005</span><span class="cm-variable">ad50</span>  <span class="cm-number">00000101</span> <span class="cm-number">08000000</span> <span class="cm-number">0800</span><span class="cm-variable">cee6</span> <span class="cm-number">0000004</span><span class="cm-variable">b</span></pre>
<p><span class="md-line md-end-block">这里通过<span spellcheck="false"><code>write_transaction</code></span>越界 写 <span spellcheck="false"><code>leak_transaction-&gt;OutParameters</code></span>为NULL, 然后发包触发写<span spellcheck="false"><code>leak_transaction</code></span>操作，之后<span spellcheck="false"><code>leak_transaction-&gt;OutParameters</code></span>便为一 Npp Buffer值了。</span></p>
<h3 class="md-end-block md-heading">5.1.2.2 leak_transaction-&gt;OutData = &amp;leak_transaction-&gt;OutParameters</h3>
<p><span class="md-line md-end-block">这里要事先泄露leak_transaction的基址，其实也不难，通过读leak_transaction的OutData 或 OutParameters 或 InData 字段的值再减去一定的偏移便得到了基址，使<span spellcheck="false"><code>leak_transaction-&gt;OutData = &amp;leak_transaction-&gt;OutParameters</code></span>之后，发包触发leak_transaction读操作便将该Npp buffer地址泄露出来了。</span></p>
<h3 class="md-end-block md-heading">5.1.2.3 写shellcode到Npp Buffer</h3>
<p><span class="md-line md-end-block">将<span spellcheck="false"><code>control_transaction-&gt;OutData</code></span>设为<span spellcheck="false"><code>Npp Buffer+0x100</code></span>地址，然后发包发送shellcode，便将shellcode写到了<span spellcheck="false"><code>Npp Buffer+0x100</code></span>内。</span></p>
<h3 class="md-end-block md-heading">5.2 代码执行</h3>
<p><span class="md-line md-end-block">至此，直接将Npp buffer+0x100写到之前泄露出来的函数表里</span></p>
<pre class="md-fences md-end-block" lang="c" contenteditable="false"><span class="cm-variable">kd</span><span class="cm-operator">&gt;</span> <span class="cm-variable">dds</span> <span class="cm-variable">b76d8598</span>
<span class="cm-variable">b76d8598</span>  <span class="cm-variable">b7709683</span> <span class="cm-variable">srv</span><span class="cm-operator">!</span><span class="cm-variable">SrvSmbOpen2</span>
<span class="cm-variable">b76d859c</span>  <span class="cm-variable">b76f62a8</span> <span class="cm-variable">srv</span><span class="cm-operator">!</span><span class="cm-variable">SrvSmbFindFirst2</span>
<span class="cm-variable">b76d85a0</span>  <span class="cm-variable">b76f74e5</span> <span class="cm-variable">srv</span><span class="cm-operator">!</span><span class="cm-variable">SrvSmbFindNext2</span>
<span class="cm-variable">b76d85a4</span>  <span class="cm-variable">b76f6309</span> <span class="cm-variable">srv</span><span class="cm-operator">!</span><span class="cm-variable">SrvSmbQueryFsInformation</span>
<span class="cm-variable">b76d85a8</span>  <span class="cm-variable">b7707293</span> <span class="cm-variable">srv</span><span class="cm-operator">!</span><span class="cm-variable">SrvSmbSetFsInformation</span>
<span class="cm-variable">b76d85ac</span>  <span class="cm-variable">b77041ad</span> <span class="cm-variable">srv</span><span class="cm-operator">!</span><span class="cm-variable">SrvSmbQueryPathInformation</span>
<span class="cm-variable">b76d85b0</span>  <span class="cm-variable">b7703ce7</span> <span class="cm-variable">srv</span><span class="cm-operator">!</span><span class="cm-variable">SrvSmbSetPathInformation</span>
<span class="cm-variable">b76d85b4</span>  <span class="cm-variable">b77025ad</span> <span class="cm-variable">srv</span><span class="cm-operator">!</span><span class="cm-variable">SrvSmbQueryFileInformation</span>
<span class="cm-variable">b76d85b8</span>  <span class="cm-variable">b770367f</span> <span class="cm-variable">srv</span><span class="cm-operator">!</span><span class="cm-variable">SrvSmbSetFileInformation</span>
<span class="cm-variable">b76d85bc</span>  <span class="cm-variable">b7705c85</span> <span class="cm-variable">srv</span><span class="cm-operator">!</span><span class="cm-variable">SrvSmbFsctl</span>
<span class="cm-variable">b76d85c0</span>  <span class="cm-variable">b7706419</span> <span class="cm-variable">srv</span><span class="cm-operator">!</span><span class="cm-variable">SrvSmbIoctl2</span>
<span class="cm-variable">b76d85c4</span>  <span class="cm-variable">b7705c85</span> <span class="cm-variable">srv</span><span class="cm-operator">!</span><span class="cm-variable">SrvSmbFsctl</span>
<span class="cm-variable">b76d85c8</span>  <span class="cm-variable">b7705c85</span> <span class="cm-variable">srv</span><span class="cm-operator">!</span><span class="cm-variable">SrvSmbFsctl</span>
<span class="cm-variable">b76d85cc</span>  <span class="cm-variable">b77047bb</span> <span class="cm-variable">srv</span><span class="cm-operator">!</span><span class="cm-variable">SrvSmbCreateDirectory2</span>
<span class="cm-variable">b76d85d0</span>  <span class="cm-number">8993f</span><span class="cm-variable">b28</span>
<span class="cm-variable">b76d85d4</span>  <span class="cm-variable">b7709a51</span> <span class="cm-variable">srv</span><span class="cm-operator">!</span><span class="cm-variable">SrvTransactionNotImplemented</span>
<span class="cm-variable">b76d85d8</span>  <span class="cm-variable">b76fb144</span> <span class="cm-variable">srv</span><span class="cm-operator">!</span><span class="cm-variable">SrvSmbGetDfsReferral</span>
<span class="cm-variable">b76d85dc</span>  <span class="cm-variable">b76faf7e</span> <span class="cm-variable">srv</span><span class="cm-operator">!</span><span class="cm-variable">SrvSmbReportDfsInconsistency</span>
<span class="cm-variable">b76d85e0</span>  <span class="cm-number">00000000</span></pre>
<p><span class="md-line md-end-block">之后发包就能触发该函数调用：</span></p>
<pre class="md-fences md-end-block" lang="c" contenteditable="false"><span class="cm-variable">kd</span><span class="cm-operator">&gt;</span> <span class="cm-variable">k</span>
 <span class="cm-meta"># ChildEBP RetAddr  </span>
<span class="cm-variable">WARNING</span>: <span class="cm-variable">Frame</span> <span class="cm-variable">IP</span> <span class="cm-variable">not</span> <span class="cm-variable">in</span> <span class="cm-variable">any</span> <span class="cm-variable">known</span> <span class="cm-variable">module</span>. <span class="cm-variable">Following</span> <span class="cm-variable">frames</span> <span class="cm-variable">may</span> <span class="cm-variable">be</span> <span class="cm-variable">wrong</span>.
<span class="cm-number">00</span> <span class="cm-variable">b72b4cf0</span> <span class="cm-variable">b76e8d76</span> <span class="cm-number">0x8993fb28</span>
<span class="cm-number">01</span> <span class="cm-variable">b72b4d04</span> <span class="cm-variable">b76e341f</span> <span class="cm-variable">srv</span><span class="cm-operator">!</span><span class="cm-variable">ExecuteTransaction</span><span class="cm-operator">+</span><span class="cm-number">0xdb</span>
<span class="cm-number">02</span> <span class="cm-variable">b72b4d7c</span> <span class="cm-variable">b76ca836</span> <span class="cm-variable">srv</span><span class="cm-operator">!</span><span class="cm-variable">SrvSmbTransaction</span><span class="cm-operator">+</span><span class="cm-number">0x7ac</span>
<span class="cm-number">03</span> <span class="cm-variable">b72b4d88</span> <span class="cm-variable">b76dad98</span> <span class="cm-variable">srv</span><span class="cm-operator">!</span><span class="cm-variable">SrvProcessSmb</span><span class="cm-operator">+</span><span class="cm-number">0xb7</span>
<span class="cm-number">04</span> <span class="cm-variable">b72b4dac</span> <span class="cm-number">805</span><span class="cm-variable">c6160</span> <span class="cm-variable">srv</span><span class="cm-operator">!</span><span class="cm-variable">WorkerThread</span><span class="cm-operator">+</span><span class="cm-number">0x11e</span>
<span class="cm-number">05</span> <span class="cm-variable">b72b4ddc</span> <span class="cm-number">80541</span><span class="cm-variable">dd2</span> <span class="cm-variable">nt</span><span class="cm-operator">!</span><span class="cm-variable">PspSystemThreadStartup</span><span class="cm-operator">+</span><span class="cm-number">0x34</span>
<span class="cm-number">06</span> <span class="cm-number">00000000</span> <span class="cm-number">00000000</span> <span class="cm-variable">nt</span><span class="cm-operator">!</span><span class="cm-variable">KiThreadStartup</span><span class="cm-operator">+</span><span class="cm-number">0x16</span></pre>
<h2 class="md-end-block md-heading">0x06 关于补丁</h2>
<p><span class="md-line md-end-block">了解了漏洞原理之后修补都很简单了。只要在<span spellcheck="false"><code>srv!SrvFindTransaction</code></span>里面判断一下SMB COMMAND的类型是否一致就好了。</span><span class="md-line md-end-block">修补后</span></p>
<pre>TRANSCATION *__fastcall SrvFindTransaction(int pConnect, SMB_HEADER *Fid, __int16 a3)
{
 _DWORD **pTransList; // eax@4
 _DWORD *v6; // ebx@4
 PDEVICE_OBJECT v7; // ecx@5
 TRANSCATION *pTransaction; // esi@6
 char Command_Trans; // al@10
 char Command_header; // dl@10
 __int16 MIDorFID; // [sp+Ch] [bp-Ch]@2
 struct _ERESOURCE *Resource; // [sp+14h] [bp-4h]@4

if ( Fid-&gt;Command == 0x2F )
 MIDorFID = a3;
 else
 MIDorFID = Fid-&gt;MID;
 Resource = (struct _ERESOURCE *)(pConnect + 0x19C);
 ExAcquireResourceExclusiveLite((PERESOURCE)(pConnect + 0x19C), 1u);
 pTransList = (_DWORD **)(*(_DWORD *)(pConnect + 0x160) + 8);
 v6 = *pTransList;
 if ( *pTransList == pTransList )
 goto LABEL_14;
 v7 = WPP_GLOBAL_Control;
 while ( 1 )
 {
 pTransaction = (TRANSCATION *)(v6 - 6);
 if ( *((_WORD *)v6 + 49) == Fid-&gt;TID
 &amp;&amp; pTransaction-&gt;PID == Fid-&gt;PID
 &amp;&amp; pTransaction-&gt;UID == Fid-&gt;UID
 &amp;&amp; pTransaction-&gt;MID == MIDorFID )
 {
 break;
 }
LABEL_13:
 v6 = (_DWORD *)*v6;
 if ( v6 == (_DWORD *)(*(_DWORD *)(pConnect + 0x160) + 8) )
 goto LABEL_14;
 }
 
 //
 // 这里添加了对COMMAND的比较。比较pTransaction和请求中SMB_HEADER中的COMMAND进行对比
 //
 
 Command_Trans = pTransaction-&gt;Command;
 Command_header = Fid-&gt;Command;
 if ( Command_Trans != Command_header )
 {
 if ( (PDEVICE_OBJECT *)v7 != &amp;WPP_GLOBAL_Control )
 {
 WPP_SF_qDD(v7-&gt;AttachedDevice, v7-&gt;CurrentIrp, (_BYTE)v6 - 24, Command_header, Command_Trans);
 v7 = WPP_GLOBAL_Control;
 }
 goto LABEL_13;
 }
 if ( BYTE1(pTransaction-&gt;field_0) == 2 )
 {
 _InterlockedIncrement((volatile signed __int32 *)(pTransaction-&gt;field_8 + 4));
 goto LABEL_15;
 }
LABEL_14:
 pTransaction = 0;
LABEL_15:
 ExReleaseResourceLite(Resource);
 return pTransaction;
}</pre>
<p><span class="md-line md-end-block">补丁点就是<span spellcheck="false"><code>if ( Command_Trans != Command_header )</code></span>看注释的地方。</span></p>
<h2 class="md-end-block md-heading">0x07 总结</h2>
<p><span class="md-line md-end-block">总之，这个漏洞还是非常好的，远程任意地址写，还可以信息泄露。威力很大。</span></p>
<h2 class="md-end-block md-heading">0x08 联系作者</h2>
<p><span class="md-line md-end-block"><span class=""><a spellcheck="false" href="http://weibo.com/pgboy1988">pgboy 微博</a></span></span></p>
<p><span class="md-line md-end-block"><span class=""><a spellcheck="false" href="http://weibo.com/2641521260">zhong_sf 微博</a></span></span></p>
<p>&nbsp;</p>
<p style="text-align: center;"><span style="color: #ff0000;"><strong>*本文作者：360安全，转载请注明来自MottoIN</strong></span></p>
                                                        <div class="entry-copyright"><p>原创文章，作者：360安全，如若转载，请注明出处：http://www.mottoin.com/101096.html</p></div>                        </div>
                        <div class="entry-footer">
                            <div class="entry-tag"><a href="http://www.mottoin.com/tag/360" rel="tag">360</a><a href="http://www.mottoin.com/tag/eternalromance" rel="tag">Eternalromance</a><a href="http://www.mottoin.com/tag/nsa" rel="tag">NSA</a><a href="http://www.mottoin.com/tag/pgboy" rel="tag">pgboy</a><a href="http://www.mottoin.com/tag/zhong-sf" rel="tag">zhong sf</a><a href="http://www.mottoin.com/tag/%e6%8a%93%e5%8c%85" rel="tag">抓包</a><a href="http://www.mottoin.com/tag/%e6%b0%b8%e6%81%92%e6%b5%aa%e6%bc%ab" rel="tag">永恒浪漫</a></div>
                            <div class="entry-action">
                                <div class="btn-zan" data-id="101096"><i class="fa fa-thumbs-up"></i> 赞 <span class="entry-action-num">(0)</span></div>

                                
                            </div>
                            <div class="entry-bar">
                                <div class="entry-bar-inner clearfix">
                                                                            <div class="author pull-left">
                                            <a data-user="529" target="_blank" href="http://www.mottoin.com/user/360/" class="avatar">
                                                <img src="http://www.mottoin.com/wp-content/uploads/ultimatemember/529/profile_photo-80.png?1505901264" class="func-um_user gravatar avatar avatar-60 um-avatar um-avatar-uploaded" width="60" height="60" alt="360安全" />                                                360安全                                            </a>
                                            <span class="author-title">企业用户</span>                                         </div>
                                                                        <div class="info pull-right">
                                        <div class="info-item meta">
                                            <a class="meta-item j-heart" href="javascript:;" data-id="101096"><i class="fa fa-heart"></i> <span class="data">0</span></a>
                                            <a class="meta-item" href="#comments"><i class="fa fa-comment"></i> <span class="data">0</span></a>
                                                                                    </div>
                                        <div class="info-item share">
                                            <a class="meta-item" href="javascript:;">
                                                <i class="fa fa-wechat"></i>
                                                <span class="wx-wrap">
                                                    <img src="//pan.baidu.com/share/qrcode?w=320&h=320&url=http://www.mottoin.com/101096.html">
                                                    <span>扫码分享到微信</span>
                                                </span>
                                            </a>
                                            <a class="meta-item" href="http://share.baidu.com/s?type=text&searchPic=1&sign=on&to=tsina&key=&url=http%3A%2F%2Fwww.mottoin.com%2F101096.html&title=360Vulcan%EF%BC%9ANSA%E9%BB%91%E5%AE%A2%E6%AD%A6%E5%99%A8%E5%BA%93%E4%B9%8BEternalromance+%28%E6%B0%B8%E6%81%92%E6%B5%AA%E6%BC%AB%29+%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90" target="_blank"><i class="fa fa-weibo"></i></a>
                                            <a class="meta-item" href="http://share.baidu.com/s?type=text&searchPic=1&sign=on&to=qzone&key=&url=http%3A%2F%2Fwww.mottoin.com%2F101096.html&title=360Vulcan%EF%BC%9ANSA%E9%BB%91%E5%AE%A2%E6%AD%A6%E5%99%A8%E5%BA%93%E4%B9%8BEternalromance+%28%E6%B0%B8%E6%81%92%E6%B5%AA%E6%BC%AB%29+%E6%BC%8F%E6%B4%9E%E5%88%86%E6%9E%90" target="_blank"><i class="fa fa-qq"></i></a>
                                        </div>
                                        <div class="info-item act">
                                            <a href="javascript:;" id="j-reading"><i class="fa fa-file-text"></i></a>
                                        </div>
                                    </div>
                                </div>
                            </div>
                                                        <h3 class="entry-related-title">相关推荐</h3><ul class="entry-related clearfix"><li><a href="http://www.mottoin.com/85575.html" title="隧道技术(二)-SSL隧道">隧道技术(二)-SSL隧道</a></li><li><a href="http://www.mottoin.com/84091.html" title="Linux下Mac地址绑定防范arp病毒攻击">Linux下Mac地址绑定防范arp病毒攻击</a></li><li><a href="http://www.mottoin.com/101185.html" title="Windows中使用SDDL（安全标识符定义语言）给指定的服务设置权限">Windows中使用SDDL（安全标识符定义语言）给指定的服务设置权限</a></li><li><a href="http://www.mottoin.com/98075.html" title="Windows内核本地拒绝服务＃2(Windows 8-10)">Windows内核本地拒绝服务＃2(Windows 8-10)</a></li><li><a href="http://www.mottoin.com/101119.html" title="VirtualBox：Windows进程COM注入EoP">VirtualBox：Windows进程COM注入EoP</a></li><li><a href="http://www.mottoin.com/101137.html" title="[CVE-2015-7547]GLIBC GETADDRINFO栈溢出漏洞">[CVE-2015-7547]GLIBC GETADDRINFO栈溢出漏洞</a></li><li><a href="http://www.mottoin.com/88841.html" title="Powershell禁用绕过白名单防护">Powershell禁用绕过白名单防护</a></li><li><a href="http://www.mottoin.com/100972.html" title="方程式黑客工具再次流出，国内企业将受威胁！">方程式黑客工具再次流出，国内企业将受威胁！</a></li><li><a href="http://www.mottoin.com/87078.html" title="Fileless Browser Hijacker劫持浏览器首页">Fileless Browser Hijacker劫持浏览器首页</a></li><li><a href="http://www.mottoin.com/99173.html" title="如何在Windows上启用防火墙日志">如何在Windows上启用防火墙日志</a></li></ul>                        </div>
                        
<div id="comments" class="entry-comments">
    	<div id="respond" class="comment-respond">
		<h3 id="reply-title" class="comment-reply-title">发表评论 <small><a rel="nofollow" id="cancel-comment-reply-link" href="/101096.html#respond" style="display:none;">取消回复</a></small></h3><div class="comment-form"><div class="comment-must-login">请登录后评论...</div><div class="form-submit"><div class="form-submit-text pull-left"><a href="http://www.mottoin.com/login">登录</a>后才能评论</div> <input name="submit" type="submit" id="must-submit" class="submit" value="发表"></div></div>	</div><!-- #respond -->
		</div><!-- .comments-area -->                    </div>
                </article>
                    </div>
        <aside class="sidebar">
            <div id="profile-3" class="widget widget_profile">                <div class="cover_photo"></div>
                        <div class="avatar-wrap">
                <a target="_blank" href="http://www.mottoin.com/user/360/" class="avatar-link"><img src="http://www.mottoin.com/wp-content/uploads/ultimatemember/529/profile_photo-190.png?1505901264" class="func-um_user gravatar avatar avatar-120 um-avatar um-avatar-uploaded" width="120" height="120" alt="360安全" /></a></div>
            <div class="profile-info">
                <p><span class="author-name">360安全</span><span class="author-title">企业用户</span></p>
                <p class="author-description"></p>
            </div>
            <div class="profile-posts">
                <h3 class="widget-title"><span>最近文章</span></h3>
                <ul>                    <li><a href="http://www.mottoin.com/105879.html" title="全球首款网络安全概念车驶入上海滩">全球首款网络安全概念车驶入上海滩</a></li>
                                    <li><a href="http://www.mottoin.com/105847.html" title="国家网络安全周开幕 大安全时代360前沿“黑科技”震撼登场">国家网络安全周开幕 大安全时代360前沿“黑科技”震撼登场</a></li>
                                    <li><a href="http://www.mottoin.com/105773.html" title="网页上的污染源：“PM2.5报告”插件实为恶意广告注射器">网页上的污染源：“PM2.5报告”插件实为恶意广告注射器</a></li>
                                    <li><a href="http://www.mottoin.com/105746.html" title="游戏辅助背后的黑产流水线：年劫持攻击千万次牟利数百万">游戏辅助背后的黑产流水线：年劫持攻击千万次牟利数百万</a></li>
                                    <li><a href="http://www.mottoin.com/105703.html" title="【现场还原】补天漏洞情报发布会记事">【现场还原】补天漏洞情报发布会记事</a></li>
                </ul>            </div>
            </div><div id="custom_html-3" class="widget_text widget widget_custom_html"><div class="textwidget custom-html-widget"><a class="btn-post" href="/question"><i class="fa fa-edit"></i> 我要提问</a></div></div><div id="post-thumb-3" class="widget widget_post_thumb">            <ul>
                                    <li class="item">
                                                    <div class="item-img">
                                <a href="http://www.mottoin.com/105921.html" title="“黑客反击”的合法化之争">
                                    <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/170918-Cox-The-Hackers-Hitting-Back-At-Cybercriminals-hero_vkcor5-480x300.gif" width="480" height="300" alt="“黑客反击”的合法化之争">                                </a>
                            </div>
                                                <div class="item-content">
                            <p class="item-title"><a href="http://www.mottoin.com/105921.html" title="“黑客反击”的合法化之争">“黑客反击”的合法化之争</a></p>
                            <p class="item-date">2017年9月20日</p>
                        </div>
                    </li>
                                    <li class="item">
                                                    <div class="item-img">
                                <a href="http://www.mottoin.com/105917.html" title="美参议员要求电信巨头们回应SS7信令系统的安全问题">
                                    <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG929-480x300.jpeg" width="480" height="300" alt="美参议员要求电信巨头们回应SS7信令系统的安全问题">                                </a>
                            </div>
                                                <div class="item-content">
                            <p class="item-title"><a href="http://www.mottoin.com/105917.html" title="美参议员要求电信巨头们回应SS7信令系统的安全问题">美参议员要求电信巨头们回应SS7信令系统的安全问题</a></p>
                            <p class="item-date">2017年9月19日</p>
                        </div>
                    </li>
                                    <li class="item">
                                                    <div class="item-img">
                                <a href="http://www.mottoin.com/105914.html" title="美国国土安全部发布禁止使用卡巴斯基产品的明细">
                                    <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG928-480x300.jpeg" width="480" height="300" alt="美国国土安全部发布禁止使用卡巴斯基产品的明细">                                </a>
                            </div>
                                                <div class="item-content">
                            <p class="item-title"><a href="http://www.mottoin.com/105914.html" title="美国国土安全部发布禁止使用卡巴斯基产品的明细">美国国土安全部发布禁止使用卡巴斯基产品的明细</a></p>
                            <p class="item-date">2017年9月19日</p>
                        </div>
                    </li>
                                    <li class="item">
                                                    <div class="item-img">
                                <a href="http://www.mottoin.com/105885.html" title="【威胁预警】供应链攻击：CCleaner 5.33官方下载被植入恶意代码（附技术详解）">
                                    <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG906-480x300.jpeg" width="480" height="300" alt="【威胁预警】供应链攻击：CCleaner 5.33官方下载被植入恶意代码（附技术详解）">                                </a>
                            </div>
                                                <div class="item-content">
                            <p class="item-title"><a href="http://www.mottoin.com/105885.html" title="【威胁预警】供应链攻击：CCleaner 5.33官方下载被植入恶意代码（附技术详解）">【威胁预警】供应链攻击：CCleaner 5.33官方下载被植入恶意代码（附技术详解）</a></p>
                            <p class="item-date">2017年9月19日</p>
                        </div>
                    </li>
                                    <li class="item">
                                                    <div class="item-img">
                                <a href="http://www.mottoin.com/105879.html" title="全球首款网络安全概念车驶入上海滩">
                                    <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/15057198871-480x300.png" width="480" height="300" alt="全球首款网络安全概念车驶入上海滩">                                </a>
                            </div>
                                                <div class="item-content">
                            <p class="item-title"><a href="http://www.mottoin.com/105879.html" title="全球首款网络安全概念车驶入上海滩">全球首款网络安全概念车驶入上海滩</a></p>
                            <p class="item-date">2017年9月18日</p>
                        </div>
                    </li>
                                    <li class="item">
                                                    <div class="item-img">
                                <a href="http://www.mottoin.com/105872.html" title="暗网市场上开始兜售Equifax的数据，数据泄漏后常见的诈骗招数1、2、3">
                                    <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG897-480x300.jpeg" width="480" height="300" alt="暗网市场上开始兜售Equifax的数据，数据泄漏后常见的诈骗招数1、2、3">                                </a>
                            </div>
                                                <div class="item-content">
                            <p class="item-title"><a href="http://www.mottoin.com/105872.html" title="暗网市场上开始兜售Equifax的数据，数据泄漏后常见的诈骗招数1、2、3">暗网市场上开始兜售Equifax的数据，数据泄漏后常见的诈骗招数1、2、3</a></p>
                            <p class="item-date">2017年9月18日</p>
                        </div>
                    </li>
                                    <li class="item">
                                                    <div class="item-img">
                                <a href="http://www.mottoin.com/105865.html" title="美国财政部确认伊朗11个实体的恶意网络活动，宣布对它们实施制裁">
                                    <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG896-480x300.jpeg" width="480" height="300" alt="美国财政部确认伊朗11个实体的恶意网络活动，宣布对它们实施制裁">                                </a>
                            </div>
                                                <div class="item-content">
                            <p class="item-title"><a href="http://www.mottoin.com/105865.html" title="美国财政部确认伊朗11个实体的恶意网络活动，宣布对它们实施制裁">美国财政部确认伊朗11个实体的恶意网络活动，宣布对它们实施制裁</a></p>
                            <p class="item-date">2017年9月18日</p>
                        </div>
                    </li>
                                    <li class="item">
                                                    <div class="item-img">
                                <a href="http://www.mottoin.com/105858.html" title="DHS称美国政府不能正确评估 WannaCry 和NotPetya的影响，对企业缺乏适当的保护">
                                    <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG150-480x300.jpeg" width="480" height="300" alt="DHS称美国政府不能正确评估 WannaCry 和NotPetya的影响，对企业缺乏适当的保护">                                </a>
                            </div>
                                                <div class="item-content">
                            <p class="item-title"><a href="http://www.mottoin.com/105858.html" title="DHS称美国政府不能正确评估 WannaCry 和NotPetya的影响，对企业缺乏适当的保护">DHS称美国政府不能正确评估 WannaCry 和NotPetya的影响，对企业缺乏适当的保护</a></p>
                            <p class="item-date">2017年9月17日</p>
                        </div>
                    </li>
                                    <li class="item">
                                                    <div class="item-img">
                                <a href="http://www.mottoin.com/105847.html" title="国家网络安全周开幕 大安全时代360前沿“黑科技”震撼登场">
                                    <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG141-480x300.jpeg" width="480" height="300" alt="国家网络安全周开幕 大安全时代360前沿“黑科技”震撼登场">                                </a>
                            </div>
                                                <div class="item-content">
                            <p class="item-title"><a href="http://www.mottoin.com/105847.html" title="国家网络安全周开幕 大安全时代360前沿“黑科技”震撼登场">国家网络安全周开幕 大安全时代360前沿“黑科技”震撼登场</a></p>
                            <p class="item-date">2017年9月16日</p>
                        </div>
                    </li>
                                    <li class="item">
                                                    <div class="item-img">
                                <a href="http://www.mottoin.com/105837.html" title="黑客组织OurMine窃取Vevo约3.12TB数据，疑似后者已妥协">
                                    <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG132-480x300.jpeg" width="480" height="300" alt="黑客组织OurMine窃取Vevo约3.12TB数据，疑似后者已妥协">                                </a>
                            </div>
                                                <div class="item-content">
                            <p class="item-title"><a href="http://www.mottoin.com/105837.html" title="黑客组织OurMine窃取Vevo约3.12TB数据，疑似后者已妥协">黑客组织OurMine窃取Vevo约3.12TB数据，疑似后者已妥协</a></p>
                            <p class="item-date">2017年9月16日</p>
                        </div>
                    </li>
                            </ul>
        </div><div id="lastest-products-4" class="widget widget_lastest_products">            <ul class="p-list clearfix">
                                    <li class="col-xs-12 col-md-6 p-item">
                        <div class="p-item-wrap">
                            <a class="thumb" href="http://www.mottoin.com/105921.html">
                                <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/170918-Cox-The-Hackers-Hitting-Back-At-Cybercriminals-hero_vkcor5-480x300.gif" width="480" height="300" alt="“黑客反击”的合法化之争">                            </a>
                            <h4 class="title">
                                <a href="http://www.mottoin.com/105921.html" title="“黑客反击”的合法化之争">
                                    “黑客反击”的合法化之争                                </a>
                            </h4>
                        </div>
                    </li>
                                    <li class="col-xs-12 col-md-6 p-item">
                        <div class="p-item-wrap">
                            <a class="thumb" href="http://www.mottoin.com/105858.html">
                                <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG150-480x300.jpeg" width="480" height="300" alt="DHS称美国政府不能正确评估 WannaCry 和NotPetya的影响，对企业缺乏适当的保护">                            </a>
                            <h4 class="title">
                                <a href="http://www.mottoin.com/105858.html" title="DHS称美国政府不能正确评估 WannaCry 和NotPetya的影响，对企业缺乏适当的保护">
                                    DHS称美国政府不能正确评估 WannaCry 和NotPetya的影响，对企业缺乏适当的保护                                </a>
                            </h4>
                        </div>
                    </li>
                                    <li class="col-xs-12 col-md-6 p-item">
                        <div class="p-item-wrap">
                            <a class="thumb" href="http://www.mottoin.com/105847.html">
                                <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG141-480x300.jpeg" width="480" height="300" alt="国家网络安全周开幕 大安全时代360前沿“黑科技”震撼登场">                            </a>
                            <h4 class="title">
                                <a href="http://www.mottoin.com/105847.html" title="国家网络安全周开幕 大安全时代360前沿“黑科技”震撼登场">
                                    国家网络安全周开幕 大安全时代360前沿“黑科技”震撼登场                                </a>
                            </h4>
                        </div>
                    </li>
                                    <li class="col-xs-12 col-md-6 p-item">
                        <div class="p-item-wrap">
                            <a class="thumb" href="http://www.mottoin.com/105799.html">
                                <img width="480" height="300" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" class="attachment-post-thumbnail size-post-thumbnail j-lazy wp-post-image" alt="暗网系列之：“入店行窃者”的工具、战术和克星" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/15054708381-150x150-480x300.png" />                            </a>
                            <h4 class="title">
                                <a href="http://www.mottoin.com/105799.html" title="暗网系列之：“入店行窃者”的工具、战术和克星">
                                    暗网系列之：“入店行窃者”的工具、战术和克星                                </a>
                            </h4>
                        </div>
                    </li>
                                    <li class="col-xs-12 col-md-6 p-item">
                        <div class="p-item-wrap">
                            <a class="thumb" href="http://www.mottoin.com/105703.html">
                                <img width="480" height="300" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" class="attachment-post-thumbnail size-post-thumbnail j-lazy wp-post-image" alt="【现场还原】补天漏洞情报发布会记事" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG82-150x150-480x300.jpeg" />                            </a>
                            <h4 class="title">
                                <a href="http://www.mottoin.com/105703.html" title="【现场还原】补天漏洞情报发布会记事">
                                    【现场还原】补天漏洞情报发布会记事                                </a>
                            </h4>
                        </div>
                    </li>
                                    <li class="col-xs-12 col-md-6 p-item">
                        <div class="p-item-wrap">
                            <a class="thumb" href="http://www.mottoin.com/105692.html">
                                <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG75-480x300.jpeg" width="480" height="300" alt="SyScan360看点回顾：中美德俄等七国黑客专家神技大比拼">                            </a>
                            <h4 class="title">
                                <a href="http://www.mottoin.com/105692.html" title="SyScan360看点回顾：中美德俄等七国黑客专家神技大比拼">
                                    SyScan360看点回顾：中美德俄等七国黑客专家神技大比拼                                </a>
                            </h4>
                        </div>
                    </li>
                                    <li class="col-xs-12 col-md-6 p-item">
                        <div class="p-item-wrap">
                            <a class="thumb" href="http://www.mottoin.com/105642.html">
                                <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG58-480x300.jpeg" width="480" height="300" alt="大安全时代序幕开启！ 中国互联网安全大会重新定义网络安全">                            </a>
                            <h4 class="title">
                                <a href="http://www.mottoin.com/105642.html" title="大安全时代序幕开启！ 中国互联网安全大会重新定义网络安全">
                                    大安全时代序幕开启！ 中国互联网安全大会重新定义网络安全                                </a>
                            </h4>
                        </div>
                    </li>
                                    <li class="col-xs-12 col-md-6 p-item">
                        <div class="p-item-wrap">
                            <a class="thumb" href="http://www.mottoin.com/105621.html">
                                <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG512-480x300.jpeg" width="480" height="300" alt="【重磅推出】ISC大会补天漏洞情报服务发布会：英雄，你准备好了吗？">                            </a>
                            <h4 class="title">
                                <a href="http://www.mottoin.com/105621.html" title="【重磅推出】ISC大会补天漏洞情报服务发布会：英雄，你准备好了吗？">
                                    【重磅推出】ISC大会补天漏洞情报服务发布会：英雄，你准备好了吗？                                </a>
                            </h4>
                        </div>
                    </li>
                                    <li class="col-xs-12 col-md-6 p-item">
                        <div class="p-item-wrap">
                            <a class="thumb" href="http://www.mottoin.com/105629.html">
                                <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG49-480x300.jpeg" width="480" height="300" alt="ISC直击：360守护者计划登陆ISC 最强白帽挑战黑客马拉松大奖赛">                            </a>
                            <h4 class="title">
                                <a href="http://www.mottoin.com/105629.html" title="ISC直击：360守护者计划登陆ISC 最强白帽挑战黑客马拉松大奖赛">
                                    ISC直击：360守护者计划登陆ISC 最强白帽挑战黑客马拉松大奖赛                                </a>
                            </h4>
                        </div>
                    </li>
                                    <li class="col-xs-12 col-md-6 p-item">
                        <div class="p-item-wrap">
                            <a class="thumb" href="http://www.mottoin.com/105603.html">
                                <img class="j-lazy" src="http://www.mottoin.com/wp-content/themes/JustNews/themer/assets/images/lazy.png" data-original="http://www.mottoin.com/wp-content/uploads/2017/09/WechatIMG42-480x300.jpeg" width="480" height="300" alt="【ISC2017精彩剪辑】周鸿祎：大安全时代 网络空间防御刻不容缓">                            </a>
                            <h4 class="title">
                                <a href="http://www.mottoin.com/105603.html" title="【ISC2017精彩剪辑】周鸿祎：大安全时代 网络空间防御刻不容缓">
                                    【ISC2017精彩剪辑】周鸿祎：大安全时代 网络空间防御刻不容缓                                </a>
                            </h4>
                        </div>
                    </li>
                            </ul>
        </div>        </aside>
    </div>
<div class="modal" id="login-modal">
    <div class="modal-dialog modal-sm">
        <div class="modal-content">
            <div class="modal-header">
                <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">×</span></button>
                <h4 class="modal-title">请登录</h4>
            </div>
            <div class="modal-body login-modal-body">
                <p>您还未登录，请登录后再进行相关操作！</p>
                <div class="login-btn">
                    <a class="btn btn-login" href="http://www.mottoin.com/login">登 录</a>
                    <a class="btn btn-register" href="http://www.mottoin.com/register">注 册</a>
                </div>
            </div>
        </div>
    </div>
</div>
</div>
<footer class="footer">
    <div class="container">
        <div class="clearfix">
                        <div class="footer-col footer-col-logo">
                <img src="http://www.mottoin.com/img/mottoin/tmxk.png" alt="MottoIN">
            </div>
                        <div class="footer-col footer-col-copy">
                <ul class="footer-nav hidden-xs"><li id="menu-item-104182" class="menu-item menu-item-104182"><a href="http://www.mottoin.com/about">关于我们</a></li>
<li id="menu-item-104181" class="menu-item menu-item-104181"><a href="http://www.mottoin.com/dis">免责声明</a></li>
<li id="menu-item-104183" class="menu-item menu-item-104183"><a href="http://www.mottoin.com/joinus">加入我们</a></li>
<li id="menu-item-105509" class="menu-item menu-item-105509"><a href="http://www.mottoin.com/contact">联系我们</a></li>
<li id="menu-item-104184" class="menu-item menu-item-104184"><a href="http://www.mottoin.com/report">寻求报道</a></li>
<li id="menu-item-104185" class="menu-item menu-item-104185"><a href="http://www.mottoin.com/contribute">我要投稿</a></li>
</ul>                <div class="copyright">
                    Copyright © 2017 MottoIN 版权所有 <a href="http://www.miibeian.gov.cn/">沪ICP备16010654号-5</a>  <img class="alignnone " src="http://www.mottoin.com/img/mottoin/ga.png" width="16" height="16" /> <a href="http://www.beian.gov.cn/portal/registerSystemInfo?recordcode=31010402001331">沪公网安备31010402001331号</a>                 </div>
            </div>
            <div class="footer-col footer-col-sns">
                <div class="footer-sns">
                                                                                    <a class="sns-wx" href="javascript:;">
                            <i class="fa fa-weixin"></i>
                            <span style="background-image:url(http://www.mottoin.com/img/mottoin/weixin.jpg);"></span>
                        </a>
                                                                <a target="_blank" href="http://weibo.com/mottoin" rel="nofollow"><i class="fa fa-weibo"></i></a>
                                                                <a target="_blank" href="http://weibo.com/mottoin" rel="nofollow"><i class="fa fa-tencent-weibo"></i></a>
                                                                                                                                                                                </div>
            </div>
        </div>
    </div>
</footer>
<div class="action" style="top:50%;">
            <div class="a-box contact">
            <div class="contact-wrap">
                <h3 class="contact-title">联系我们</h3>
                <h4 style="text-align: center;"><span style="color: #2d6ded;"><strong>021-62666911</strong></span></h4>
<p>在线咨询：<a href="http://wpa.qq.com/msgrd?uin=19539638" target="_blank" rel="noopener"><img class="alignnone" title="点击这里给我发消息" src="http://wpa.qq.com/pa?p=2:1666839010:51" alt="点击这里给我发消息" border="0" /></a></p>
<p>邮件：root@mottoin.com</p>
<p>工作时间：周一至周五，9:30-18:30，节假日休息</p>
            </div>
        </div>
                <div class="a-box wechat">
            <div class="wechat-wrap">
                <img src="http://www.mottoin.com/img/mottoin/weixin.jpg" alt="QR code">
            </div>
        </div>
            <div class="a-box gotop" id="j-top" style="display: none;"></div>
</div>
<style>.footer{padding-bottom: 35px;}</style><div id="um_upload_single" style="display:none">
	
</div><div id="um_view_photo" style="display:none">

	<a href="#" data-action="um_remove_modal" class="um-modal-close"><i class="um-faicon-times"></i></a>
	
	<div class="um-modal-body photo">
	
		<div class="um-modal-photo">

		</div>

	</div>
	
</div><script type='text/javascript'>
/* <![CDATA[ */
var _wpcom_js = {"ajaxurl":"http:\/\/www.mottoin.com\/wp-admin\/admin-ajax.php"};
/* ]]> */
</script>
<script type='text/javascript' src='http://www.mottoin.com/wp-content/themes/JustNews/js/main.js?ver=2.3.2'></script>
<script type='text/javascript' src='http://www.mottoin.com/wp-includes/js/comment-reply.min.js?ver=4.8.1'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var wpcom_qa_js = {"ajaxurl":"http:\/\/www.mottoin.com\/wp-admin\/admin-ajax.php","ajaxloading":"http:\/\/www.mottoin.com\/wp-content\/plugins\/wpcom-qa\/images\/loading.gif"};
/* ]]> */
</script>
<script type='text/javascript' src='http://www.mottoin.com/wp-content/plugins/wpcom-qa/js/scripts.min.js?ver=1.0'></script>
<script type='text/javascript' src='http://www.mottoin.com/wp-includes/js/imagesloaded.min.js?ver=3.2.0'></script>
<script type='text/javascript' src='http://www.mottoin.com/wp-includes/js/masonry.min.js?ver=3.3.2'></script>
<script type='text/javascript' src='http://www.mottoin.com/wp-includes/js/jquery/jquery.masonry.min.js?ver=3.1.2b'></script>
<script type='text/javascript'>
/* <![CDATA[ */
var um_scripts = {"ajaxurl":"http:\/\/www.mottoin.com\/wp-admin\/admin-ajax.php","fileupload":"http:\/\/www.mottoin.com\/wp-content\/plugins\/ultimate-member\/core\/lib\/upload\/um-file-upload.php","imageupload":"http:\/\/www.mottoin.com\/wp-content\/plugins\/ultimate-member\/core\/lib\/upload\/um-image-upload.php"};
/* ]]> */
</script>
<script type='text/javascript' src='http://www.mottoin.com/wp-content/plugins/ultimate-member/assets/js/um.min.js?ver=10.3.88'></script>
<script type='text/javascript' src='http://www.mottoin.com/wp-content/plugins/ultimate-member/assets/js/pickadate/translations/zh_CN.js?ver=10.3.88'></script>
<script type='text/javascript' src='http://www.mottoin.com/wp-includes/js/wp-embed.min.js?ver=4.8.1'></script>

		<script type="text/javascript">jQuery( '#request' ).val( '' );</script>

	    <script>window._bd_share_config={"common":{"bdSnsKey":{},"bdText":"","bdMini":"2","bdMiniList":["mshare","tsina","weixin","qzone","sqq","douban","fbook","twi","bdhome","tqq","tieba","mail","youdao","print"],"bdPic":"","bdStyle":"1","bdSize":"16"},"share":[{"tag" : "single", "bdSize" : 16}, {"tag" : "global","bdSize" : 16,bdPopupOffsetLeft:-227}],url:'http://www.mottoin.com/wp-content/themes/JustNews'};with(document)0[(getElementsByTagName('head')[0]||body).appendChild(createElement('script')).src='http://www.mottoin.com/wp-content/themes/JustNews/js/share.js?v=89860593.js?cdnversion='+~(-new Date()/36e5)];</script>
</body>
</html>